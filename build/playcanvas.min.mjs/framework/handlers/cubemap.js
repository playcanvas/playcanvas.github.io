import{ADDRESS_CLAMP_TO_EDGE as e,PIXELFORMAT_RGB8 as t,PIXELFORMAT_RGBA8 as l,TEXTURETYPE_RGBM as n,TEXTURETYPE_DEFAULT as s}from"../../platform/graphics/constants.js";import{Texture as r}from"../../platform/graphics/texture.js";import{Asset as a}from"../asset/asset.js";class i{constructor(e){this.handlerType="cubemap",this._device=e.graphicsDevice,this._registry=e.assets,this._loader=e.loader}load(e,t,l){this.loadAssets(l,t)}open(e,t,l){return l?l.resource:null}patch(e,t){this.loadAssets(e,(function(l,n){l&&(t.fire("error",e),t.fire("error:"+e.id,l,e),e.fire("error",e))}))}getAssetIds(e){const t=[];if(t[0]=e.file,(e.loadFaces||!e.file)&&e.data&&e.data.textures)for(let l=0;l<6;++l)t[l+1]=e.data.textures[l];else t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=null;return t}compareAssetIds(e,t){return e&&t?parseInt(e,10)===e||"string"==typeof e?e===t:e.url===t.url:null!==e==(null!==t)}update(a,i,o){const u=a.data||{},d=a._handlerState.assets,c=a._resources;let p,f,h;const m=[null,null,null,null,null,null,null],g=function(){return u.hasOwnProperty("type")?u.type:u.hasOwnProperty("rgbm")?u.rgbm?n:s:null};if(a.loaded&&o[0]===d[0])m[1]=c[1]||null,m[2]=c[2]||null,m[3]=c[3]||null,m[4]=c[4]||null,m[5]=c[5]||null,m[6]=c[6]||null;else if(o[0])for(p=o[0].resource,h=0;h<6;++h)m[h+1]=new r(this._device,{name:a.name+"_prelitCubemap"+(p.width>>h),cubemap:!0,type:g()||p.type,width:p.width>>h,height:p.height>>h,format:p.format,levels:[p._levels[h]],fixCubemapSeams:!0,addressU:e,addressV:e,mipmaps:0===h});const y=o.slice(1);if(a.loaded&&this.cmpArrays(y,d.slice(1)))m[0]=c[0]||null;else if(-1===y.indexOf(null)){const n=y.map((function(e){return e.resource})),s=[];for(f=0;f<n[0]._levels.length;++f)s.push(n.map((function(e){return e._levels[f]})));const i=n[0].format,d=new r(this._device,{name:a.name+"_faces",cubemap:!0,type:g()||n[0].type,width:n[0].width,height:n[0].height,format:i===t?l:i,levels:s,minFilter:u.hasOwnProperty("minFilter")?u.minFilter:n[0].minFilter,magFilter:u.hasOwnProperty("magFilter")?u.magFilter:n[0].magFilter,anisotropy:u.hasOwnProperty("anisotropy")?u.anisotropy:1,addressU:e,addressV:e,fixCubemapSeams:!!o[0]});m[0]=d}if(!this.cmpArrays(m,c))for(a.resources=m,a._handlerState.assetIds=i,a._handlerState.assets=o,h=0;h<c.length;++h)null!==c[h]&&-1===m.indexOf(c[h])&&c[h].destroy();for(h=0;h<d.length;++h)null!==d[h]&&-1===o.indexOf(d[h])&&d[h].unload()}cmpArrays(e,t){if(e.length!==t.length)return!1;for(let l=0;l<e.length;++l)if(e[l]!==t[l])return!1;return!0}resolveId(e){const t=parseInt(e,10);return t===e||t.toString()===e?t:e}loadAssets(e,t){e.hasOwnProperty("_handlerState")||(e._handlerState={assetIds:[null,null,null,null,null,null,null],assets:[null,null,null,null,null,null,null]});const l=this,n=l.getAssetIds(e),s=[null,null,null,null,null,null,null],r=e._handlerState.assetIds,i=e._handlerState.assets,o=l._registry;let u=7;const d=function(r,a){s[r]=a,u--,0===u&&(l.update(e,n,s),t(null,e.resources))},c=function(e,l,n){t(l)},p=function(e,t){t.loaded?d(e,t):(o.once("load:"+t.id,d.bind(l,e)),o.once("error:"+t.id,c.bind(l,e)),t.loading||o.load(t))};let f;for(let t=0;t<7;++t){const s=this.resolveId(n[t]);if(s)if(l.compareAssetIds(s,r[t]))d(t,i[t]);else if(parseInt(s,10)===s)f=o.get(s),f?p(t,f):setTimeout(function(e,t){const l=o.get(t);l?p(e,l):c(0,"failed to find dependent cubemap asset="+t)}.bind(null,t,s));else{const n="string"==typeof s?{url:s,filename:s}:s;f=new a(e.name+"_part_"+t,"texture",n),o.add(f),o.once("load:"+f.id,d.bind(l,t)),o.once("error:"+f.id,c.bind(l,t)),o.load(f)}else d(t,null)}}}export{i as CubemapHandler};
