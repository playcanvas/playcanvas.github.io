import{ADDRESS_CLAMP_TO_EDGE as e,PIXELFORMAT_R8_G8_B8 as t,PIXELFORMAT_R8_G8_B8_A8 as l,TEXTURETYPE_RGBM as n,TEXTURETYPE_DEFAULT as s}from"../graphics/constants.js";import{Asset as r}from"../asset/asset.js";import{Texture as a}from"../graphics/texture.js";class i{constructor(e){this.handlerType="cubemap",this._device=e.graphicsDevice,this._registry=e.assets,this._loader=e.loader}load(e,t,l){this.loadAssets(l,t)}open(e,t,l){return l?l.resource:null}patch(e,t){this.loadAssets(e,(function(l,n){l&&(t.fire("error",e),t.fire("error:"+e.id,l,e),e.fire("error",e))}))}getAssetIds(e){const t=[];if(t[0]=e.file,(e.loadFaces||!e.file)&&e.data&&e.data.textures)for(let l=0;l<6;++l)t[l+1]=e.data.textures[l];else t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=null;return t}compareAssetIds(e,t){return e&&t?parseInt(e,10)===e||"string"==typeof e?e===t:e.url===t.url:null!==e==(null!==t)}update(r,i,o){const u=r.data||{},d=r._handlerState.assets,c=r._resources;let p,h,f;const m=[null,null,null,null,null,null,null],g=function(){return u.hasOwnProperty("type")?u.type:u.hasOwnProperty("rgbm")?u.rgbm?n:s:null};if(r.loaded&&o[0]===d[0])m[1]=c[1]||null,m[2]=c[2]||null,m[3]=c[3]||null,m[4]=c[4]||null,m[5]=c[5]||null,m[6]=c[6]||null;else if(o[0])for(p=o[0].resource,f=0;f<6;++f)m[f+1]=new a(this._device,{name:r.name+"_prelitCubemap"+(p.width>>f),cubemap:!0,type:g()||p.type,width:p.width>>f,height:p.height>>f,format:p.format,levels:[p._levels[f]],fixCubemapSeams:!0,addressU:e,addressV:e,mipmaps:0===f});const y=o.slice(1);if(r.loaded&&this.cmpArrays(y,d.slice(1)))m[0]=c[0]||null;else if(-1===y.indexOf(null)){const n=y.map((function(e){return e.resource})),s=[];for(h=0;h<n[0]._levels.length;++h)s.push(n.map((function(e){return e._levels[h]})));const i=n[0].format,d=new a(this._device,{name:r.name+"_faces",cubemap:!0,type:g()||n[0].type,width:n[0].width,height:n[0].height,format:i===t?l:i,levels:s,minFilter:u.hasOwnProperty("minFilter")?u.minFilter:n[0].minFilter,magFilter:u.hasOwnProperty("magFilter")?u.magFilter:n[0].magFilter,anisotropy:u.hasOwnProperty("anisotropy")?u.anisotropy:1,addressU:e,addressV:e,fixCubemapSeams:!!o[0]});m[0]=d}if(!this.cmpArrays(m,c))for(r.resources=m,r._handlerState.assetIds=i,r._handlerState.assets=o,f=0;f<c.length;++f)null!==c[f]&&-1===m.indexOf(c[f])&&c[f].destroy();for(f=0;f<d.length;++f)null!==d[f]&&-1===o.indexOf(d[f])&&d[f].unload()}cmpArrays(e,t){if(e.length!==t.length)return!1;for(let l=0;l<e.length;++l)if(e[l]!==t[l])return!1;return!0}resolveId(e){const t=parseInt(e,10);return t===e||t.toString()===e?t:e}loadAssets(e,t){e.hasOwnProperty("_handlerState")||(e._handlerState={assetIds:[null,null,null,null,null,null,null],assets:[null,null,null,null,null,null,null]});const l=this,n=l.getAssetIds(e),s=[null,null,null,null,null,null,null],a=e._handlerState.assetIds,i=e._handlerState.assets,o=l._registry;let u=7;const d=function(r,a){s[r]=a,u--,0===u&&(l.update(e,n,s),t(null,e.resources))},c=function(e,l,n){t(l)},p=function(e,t){t.loaded?d(e,t):(o.once("load:"+t.id,d.bind(l,e)),o.once("error:"+t.id,c.bind(l,e)),t.loading||o.load(t))};let h;for(let t=0;t<7;++t){const s=this.resolveId(n[t]);if(s)if(l.compareAssetIds(s,a[t]))d(t,i[t]);else if(parseInt(s,10)===s)h=o.get(s),h?p(t,h):setTimeout(function(e,t){const l=o.get(t);l?p(e,l):c(0,"failed to find dependent cubemap asset="+t)}.bind(null,t,s));else{const n="string"==typeof s?{url:s,filename:s}:s;h=new r(e.name+"_part_"+t,"texture",n),o.add(h),o.once("load:"+h.id,d.bind(l,t)),o.once("error:"+h.id,c.bind(l,t)),o.load(h)}else d(t,null)}}}export{i as CubemapHandler};
