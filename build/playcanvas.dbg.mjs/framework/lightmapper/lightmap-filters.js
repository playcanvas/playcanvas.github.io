/**
 * @license
 * PlayCanvas Engine v1.62.0-dev revision 7d088032c (DEBUG PROFILER)
 * Copyright 2011-2023 PlayCanvas Ltd. All rights reserved.
 */
import { createShaderFromCode } from '../../scene/shader-lib/utils.js';
import { shaderChunks } from '../../scene/shader-lib/chunks/chunks.js';
import { shaderChunksLightmapper } from '../../scene/shader-lib/chunks/chunks-lightmapper.js';

// size of the kernel - needs to match the constant in the shader
const DENOISE_FILTER_SIZE = 15;

// helper class used by lightmapper, wrapping functionality of dilate and denoise shaders
class LightmapFilters {
  constructor(device) {
    this.device = device;
    this.shaderDilate = createShaderFromCode(device, shaderChunks.fullscreenQuadVS, shaderChunksLightmapper.dilatePS, 'lmDilate');
    this.constantTexSource = device.scope.resolve('source');
    this.constantPixelOffset = device.scope.resolve('pixelOffset');
    this.pixelOffset = new Float32Array(2);

    // denoise is optional and gets created only when needed
    this.shaderDenoise = null;
    this.sigmas = null;
    this.constantSigmas = null;
    this.kernel = null;
  }
  setSourceTexture(texture) {
    this.constantTexSource.setValue(texture);
  }
  prepare(textureWidth, textureHeight) {
    // inverse texture size
    this.pixelOffset[0] = 1 / textureWidth;
    this.pixelOffset[1] = 1 / textureHeight;
    this.constantPixelOffset.setValue(this.pixelOffset);
  }
  prepareDenoise(filterRange, filterSmoothness) {
    if (!this.shaderDenoise) {
      this.shaderDenoise = createShaderFromCode(this.device, shaderChunks.fullscreenQuadVS, shaderChunksLightmapper.bilateralDeNoisePS, 'lmBilateralDeNoise');
      this.sigmas = new Float32Array(2);
      this.constantSigmas = this.device.scope.resolve('sigmas');
      this.constantKernel = this.device.scope.resolve('kernel[0]');
      this.bZnorm = this.device.scope.resolve('bZnorm');
    }
    this.sigmas[0] = filterRange;
    this.sigmas[1] = filterSmoothness;
    this.constantSigmas.setValue(this.sigmas);
    this.evaluateDenoiseUniforms(filterRange, filterSmoothness);
  }
  evaluateDenoiseUniforms(filterRange, filterSmoothness) {
    function normpdf(x, sigma) {
      return 0.39894 * Math.exp(-0.5 * x * x / (sigma * sigma)) / sigma;
    }

    // kernel
    this.kernel = this.kernel || new Float32Array(DENOISE_FILTER_SIZE);
    const kernel = this.kernel;
    const kSize = Math.floor((DENOISE_FILTER_SIZE - 1) / 2);
    for (let j = 0; j <= kSize; ++j) {
      const value = normpdf(j, filterRange);
      kernel[kSize + j] = value;
      kernel[kSize - j] = value;
    }
    this.constantKernel.setValue(this.kernel);
    const bZnorm = 1 / normpdf(0.0, filterSmoothness);
    this.bZnorm.setValue(bZnorm);
  }
}

export { LightmapFilters };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlnaHRtYXAtZmlsdGVycy5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2ZyYW1ld29yay9saWdodG1hcHBlci9saWdodG1hcC1maWx0ZXJzLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNyZWF0ZVNoYWRlckZyb21Db2RlIH0gZnJvbSAnLi4vLi4vc2NlbmUvc2hhZGVyLWxpYi91dGlscy5qcyc7XG5pbXBvcnQgeyBzaGFkZXJDaHVua3MgfSBmcm9tICcuLi8uLi9zY2VuZS9zaGFkZXItbGliL2NodW5rcy9jaHVua3MuanMnO1xuaW1wb3J0IHsgc2hhZGVyQ2h1bmtzTGlnaHRtYXBwZXIgfSBmcm9tICcuLi8uLi9zY2VuZS9zaGFkZXItbGliL2NodW5rcy9jaHVua3MtbGlnaHRtYXBwZXIuanMnO1xuXG4vLyBzaXplIG9mIHRoZSBrZXJuZWwgLSBuZWVkcyB0byBtYXRjaCB0aGUgY29uc3RhbnQgaW4gdGhlIHNoYWRlclxuY29uc3QgREVOT0lTRV9GSUxURVJfU0laRSA9IDE1O1xuXG4vLyBoZWxwZXIgY2xhc3MgdXNlZCBieSBsaWdodG1hcHBlciwgd3JhcHBpbmcgZnVuY3Rpb25hbGl0eSBvZiBkaWxhdGUgYW5kIGRlbm9pc2Ugc2hhZGVyc1xuY2xhc3MgTGlnaHRtYXBGaWx0ZXJzIHtcbiAgICBjb25zdHJ1Y3RvcihkZXZpY2UpIHtcbiAgICAgICAgdGhpcy5kZXZpY2UgPSBkZXZpY2U7XG4gICAgICAgIHRoaXMuc2hhZGVyRGlsYXRlID0gY3JlYXRlU2hhZGVyRnJvbUNvZGUoZGV2aWNlLCBzaGFkZXJDaHVua3MuZnVsbHNjcmVlblF1YWRWUywgc2hhZGVyQ2h1bmtzTGlnaHRtYXBwZXIuZGlsYXRlUFMsICdsbURpbGF0ZScpO1xuXG4gICAgICAgIHRoaXMuY29uc3RhbnRUZXhTb3VyY2UgPSBkZXZpY2Uuc2NvcGUucmVzb2x2ZSgnc291cmNlJyk7XG5cbiAgICAgICAgdGhpcy5jb25zdGFudFBpeGVsT2Zmc2V0ID0gZGV2aWNlLnNjb3BlLnJlc29sdmUoJ3BpeGVsT2Zmc2V0Jyk7XG4gICAgICAgIHRoaXMucGl4ZWxPZmZzZXQgPSBuZXcgRmxvYXQzMkFycmF5KDIpO1xuXG4gICAgICAgIC8vIGRlbm9pc2UgaXMgb3B0aW9uYWwgYW5kIGdldHMgY3JlYXRlZCBvbmx5IHdoZW4gbmVlZGVkXG4gICAgICAgIHRoaXMuc2hhZGVyRGVub2lzZSA9IG51bGw7XG4gICAgICAgIHRoaXMuc2lnbWFzID0gbnVsbDtcbiAgICAgICAgdGhpcy5jb25zdGFudFNpZ21hcyA9IG51bGw7XG4gICAgICAgIHRoaXMua2VybmVsID0gbnVsbDtcbiAgICB9XG5cbiAgICBzZXRTb3VyY2VUZXh0dXJlKHRleHR1cmUpIHtcbiAgICAgICAgdGhpcy5jb25zdGFudFRleFNvdXJjZS5zZXRWYWx1ZSh0ZXh0dXJlKTtcbiAgICB9XG5cbiAgICBwcmVwYXJlKHRleHR1cmVXaWR0aCwgdGV4dHVyZUhlaWdodCkge1xuXG4gICAgICAgIC8vIGludmVyc2UgdGV4dHVyZSBzaXplXG4gICAgICAgIHRoaXMucGl4ZWxPZmZzZXRbMF0gPSAxIC8gdGV4dHVyZVdpZHRoO1xuICAgICAgICB0aGlzLnBpeGVsT2Zmc2V0WzFdID0gMSAvIHRleHR1cmVIZWlnaHQ7XG4gICAgICAgIHRoaXMuY29uc3RhbnRQaXhlbE9mZnNldC5zZXRWYWx1ZSh0aGlzLnBpeGVsT2Zmc2V0KTtcbiAgICB9XG5cbiAgICBwcmVwYXJlRGVub2lzZShmaWx0ZXJSYW5nZSwgZmlsdGVyU21vb3RobmVzcykge1xuXG4gICAgICAgIGlmICghdGhpcy5zaGFkZXJEZW5vaXNlKSB7XG4gICAgICAgICAgICB0aGlzLnNoYWRlckRlbm9pc2UgPSBjcmVhdGVTaGFkZXJGcm9tQ29kZSh0aGlzLmRldmljZSwgc2hhZGVyQ2h1bmtzLmZ1bGxzY3JlZW5RdWFkVlMsIHNoYWRlckNodW5rc0xpZ2h0bWFwcGVyLmJpbGF0ZXJhbERlTm9pc2VQUywgJ2xtQmlsYXRlcmFsRGVOb2lzZScpO1xuICAgICAgICAgICAgdGhpcy5zaWdtYXMgPSBuZXcgRmxvYXQzMkFycmF5KDIpO1xuICAgICAgICAgICAgdGhpcy5jb25zdGFudFNpZ21hcyA9IHRoaXMuZGV2aWNlLnNjb3BlLnJlc29sdmUoJ3NpZ21hcycpO1xuICAgICAgICAgICAgdGhpcy5jb25zdGFudEtlcm5lbCA9IHRoaXMuZGV2aWNlLnNjb3BlLnJlc29sdmUoJ2tlcm5lbFswXScpO1xuICAgICAgICAgICAgdGhpcy5iWm5vcm0gPSB0aGlzLmRldmljZS5zY29wZS5yZXNvbHZlKCdiWm5vcm0nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuc2lnbWFzWzBdID0gZmlsdGVyUmFuZ2U7XG4gICAgICAgIHRoaXMuc2lnbWFzWzFdID0gZmlsdGVyU21vb3RobmVzcztcbiAgICAgICAgdGhpcy5jb25zdGFudFNpZ21hcy5zZXRWYWx1ZSh0aGlzLnNpZ21hcyk7XG5cbiAgICAgICAgdGhpcy5ldmFsdWF0ZURlbm9pc2VVbmlmb3JtcyhmaWx0ZXJSYW5nZSwgZmlsdGVyU21vb3RobmVzcyk7XG4gICAgfVxuXG4gICAgZXZhbHVhdGVEZW5vaXNlVW5pZm9ybXMoZmlsdGVyUmFuZ2UsIGZpbHRlclNtb290aG5lc3MpIHtcblxuICAgICAgICBmdW5jdGlvbiBub3JtcGRmKHgsIHNpZ21hKSB7XG4gICAgICAgICAgICByZXR1cm4gMC4zOTg5NCAqIE1hdGguZXhwKC0wLjUgKiB4ICogeCAvIChzaWdtYSAqIHNpZ21hKSkgLyBzaWdtYTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGtlcm5lbFxuICAgICAgICB0aGlzLmtlcm5lbCA9IHRoaXMua2VybmVsIHx8IG5ldyBGbG9hdDMyQXJyYXkoREVOT0lTRV9GSUxURVJfU0laRSk7XG4gICAgICAgIGNvbnN0IGtlcm5lbCA9IHRoaXMua2VybmVsO1xuICAgICAgICBjb25zdCBrU2l6ZSA9IE1hdGguZmxvb3IoKERFTk9JU0VfRklMVEVSX1NJWkUgLSAxKSAvIDIpO1xuICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8PSBrU2l6ZTsgKytqKSB7XG4gICAgICAgICAgICBjb25zdCB2YWx1ZSA9IG5vcm1wZGYoaiwgZmlsdGVyUmFuZ2UpO1xuICAgICAgICAgICAga2VybmVsW2tTaXplICsgal0gPSB2YWx1ZTtcbiAgICAgICAgICAgIGtlcm5lbFtrU2l6ZSAtIGpdID0gdmFsdWU7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jb25zdGFudEtlcm5lbC5zZXRWYWx1ZSh0aGlzLmtlcm5lbCk7XG5cbiAgICAgICAgY29uc3QgYlpub3JtID0gMSAvIG5vcm1wZGYoMC4wLCBmaWx0ZXJTbW9vdGhuZXNzKTtcbiAgICAgICAgdGhpcy5iWm5vcm0uc2V0VmFsdWUoYlpub3JtKTtcbiAgICB9XG59XG5cbmV4cG9ydCB7IExpZ2h0bWFwRmlsdGVycyB9O1xuIl0sIm5hbWVzIjpbIkRFTk9JU0VfRklMVEVSX1NJWkUiLCJMaWdodG1hcEZpbHRlcnMiLCJjb25zdHJ1Y3RvciIsImRldmljZSIsInNoYWRlckRpbGF0ZSIsImNyZWF0ZVNoYWRlckZyb21Db2RlIiwic2hhZGVyQ2h1bmtzIiwiZnVsbHNjcmVlblF1YWRWUyIsInNoYWRlckNodW5rc0xpZ2h0bWFwcGVyIiwiZGlsYXRlUFMiLCJjb25zdGFudFRleFNvdXJjZSIsInNjb3BlIiwicmVzb2x2ZSIsImNvbnN0YW50UGl4ZWxPZmZzZXQiLCJwaXhlbE9mZnNldCIsIkZsb2F0MzJBcnJheSIsInNoYWRlckRlbm9pc2UiLCJzaWdtYXMiLCJjb25zdGFudFNpZ21hcyIsImtlcm5lbCIsInNldFNvdXJjZVRleHR1cmUiLCJ0ZXh0dXJlIiwic2V0VmFsdWUiLCJwcmVwYXJlIiwidGV4dHVyZVdpZHRoIiwidGV4dHVyZUhlaWdodCIsInByZXBhcmVEZW5vaXNlIiwiZmlsdGVyUmFuZ2UiLCJmaWx0ZXJTbW9vdGhuZXNzIiwiYmlsYXRlcmFsRGVOb2lzZVBTIiwiY29uc3RhbnRLZXJuZWwiLCJiWm5vcm0iLCJldmFsdWF0ZURlbm9pc2VVbmlmb3JtcyIsIm5vcm1wZGYiLCJ4Iiwic2lnbWEi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
