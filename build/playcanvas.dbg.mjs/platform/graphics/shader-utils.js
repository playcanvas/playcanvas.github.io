/**
 * @license
 * PlayCanvas Engine v1.58.0-preview revision 1fec26519 (DEBUG PROFILER)
 * Copyright 2011-2022 PlayCanvas Ltd. All rights reserved.
 */
import { Debug } from '../../core/debug.js';
import { DEVICETYPE_WEBGPU, DEVICETYPE_WEBGL, SEMANTIC_POSITION, SEMANTIC_NORMAL, SEMANTIC_TANGENT, SEMANTIC_TEXCOORD0, SEMANTIC_TEXCOORD1, SEMANTIC_TEXCOORD2, SEMANTIC_TEXCOORD3, SEMANTIC_TEXCOORD4, SEMANTIC_TEXCOORD5, SEMANTIC_TEXCOORD6, SEMANTIC_TEXCOORD7, SEMANTIC_COLOR, SEMANTIC_BLENDINDICES, SEMANTIC_BLENDWEIGHT } from './constants.js';
import gles2PS from './shader-chunks/frag/gles2.js';
import gles3PS from './shader-chunks/frag/gles3.js';
import gles3VS from './shader-chunks/vert/gles3.js';
import webgpuPS from './shader-chunks/frag/webgpu.js';
import webgpuVS from './shader-chunks/vert/webgpu.js';

const _attrib2Semantic = {
  vertex_position: SEMANTIC_POSITION,
  vertex_normal: SEMANTIC_NORMAL,
  vertex_tangent: SEMANTIC_TANGENT,
  vertex_texCoord0: SEMANTIC_TEXCOORD0,
  vertex_texCoord1: SEMANTIC_TEXCOORD1,
  vertex_texCoord2: SEMANTIC_TEXCOORD2,
  vertex_texCoord3: SEMANTIC_TEXCOORD3,
  vertex_texCoord4: SEMANTIC_TEXCOORD4,
  vertex_texCoord5: SEMANTIC_TEXCOORD5,
  vertex_texCoord6: SEMANTIC_TEXCOORD6,
  vertex_texCoord7: SEMANTIC_TEXCOORD7,
  vertex_color: SEMANTIC_COLOR,
  vertex_boneIndices: SEMANTIC_BLENDINDICES,
  vertex_boneWeights: SEMANTIC_BLENDWEIGHT
};

class ShaderUtils {
  static createDefinition(device, options) {
    var _options$name, _options$attributes;
    Debug.assert(options);
    const getDefines = (gpu, gl2, gl1, isVertex) => {
      return device.deviceType === DEVICETYPE_WEBGPU ? gpu : device.webgl2 ? gl2 : ShaderUtils.gl1Extensions(device, options) + gl1;
    };
    const name = (_options$name = options.name) != null ? _options$name : 'Untitled';

    const vertDefines = options.vertexDefines || getDefines(webgpuVS, gles3VS, '');
    const vertCode = ShaderUtils.versionCode(device) + vertDefines + ShaderUtils.getShaderNameCode(name) + options.vertexCode;

    const fragDefines = options.fragmentDefines || getDefines(webgpuPS, gles3PS, gles2PS);
    const fragCode = (options.fragmentPreamble || '') + ShaderUtils.versionCode(device) + ShaderUtils.precisionCode(device) + '\n' + fragDefines + ShaderUtils.getShaderNameCode(name) + (options.fragmentCode || ShaderUtils.dummyFragmentCode());

    const attribs = (_options$attributes = options.attributes) != null ? _options$attributes : ShaderUtils.collectAttributes(options.vertexCode);
    return {
      name: name,
      attributes: attribs,
      vshader: vertCode,
      fshader: fragCode,
      useTransformFeedback: options.useTransformFeedback
    };
  }

  static getShaderNameCode(name) {
    return `#define SHADER_NAME ${name}\n`;
  }
  static gl1Extensions(device, options, isVertex) {
    let code;
    if (isVertex) {
      code = options.vertexExtensions ? `${options.vertexExtensions}\n` : '';
    } else {
      code = options.fragmentExtensions ? `${options.fragmentExtensions}\n` : '';

      if (device.extStandardDerivatives) {
        code += "#extension GL_OES_standard_derivatives : enable\n";
      }
      if (device.extTextureLod) {
        code += "#extension GL_EXT_shader_texture_lod : enable\n";
        code += "#define SUPPORTS_TEXLOD\n";
      }
    }
    return code;
  }
  static dummyFragmentCode() {
    return "void main(void) {gl_FragColor = vec4(0.0);}";
  }
  static versionCode(device) {
    if (device.deviceType === DEVICETYPE_WEBGPU) {
      return '#version 450\n';
    }
    return device.webgl2 ? "#version 300 es\n" : "";
  }
  static precisionCode(device, forcePrecision) {
    let code = '';
    if (device.deviceType === DEVICETYPE_WEBGL) {
      if (forcePrecision && forcePrecision !== 'highp' && forcePrecision !== 'mediump' && forcePrecision !== 'lowp') {
        forcePrecision = null;
      }
      if (forcePrecision) {
        if (forcePrecision === 'highp' && device.maxPrecision !== 'highp') {
          forcePrecision = 'mediump';
        }
        if (forcePrecision === 'mediump' && device.maxPrecision === 'lowp') {
          forcePrecision = 'lowp';
        }
      }
      const precision = forcePrecision ? forcePrecision : device.precision;
      code = `precision ${precision} float;\n`;
      if (device.webgl2) {
        code += `precision ${precision} sampler2DShadow;\n`;
      }
    }
    return code;
  }

  static collectAttributes(vsCode) {
    const attribs = {};
    let attrs = 0;
    let found = vsCode.indexOf("attribute");
    while (found >= 0) {
      if (found > 0 && vsCode[found - 1] === "/") break;
      const endOfLine = vsCode.indexOf(';', found);
      const startOfAttribName = vsCode.lastIndexOf(' ', endOfLine);
      const attribName = vsCode.substring(startOfAttribName + 1, endOfLine);
      const semantic = _attrib2Semantic[attribName];
      if (semantic !== undefined) {
        attribs[attribName] = semantic;
      } else {
        attribs[attribName] = "ATTR" + attrs;
        attrs++;
      }
      found = vsCode.indexOf("attribute", found + 1);
    }
    return attribs;
  }
}

export { ShaderUtils };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hhZGVyLXV0aWxzLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvcGxhdGZvcm0vZ3JhcGhpY3Mvc2hhZGVyLXV0aWxzLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERlYnVnIH0gZnJvbSBcIi4uLy4uL2NvcmUvZGVidWcuanNcIjtcbmltcG9ydCB7XG4gICAgREVWSUNFVFlQRV9XRUJHUFUsIERFVklDRVRZUEVfV0VCR0wsXG4gICAgU0VNQU5USUNfUE9TSVRJT04sIFNFTUFOVElDX05PUk1BTCwgU0VNQU5USUNfVEFOR0VOVCwgU0VNQU5USUNfVEVYQ09PUkQwLCBTRU1BTlRJQ19URVhDT09SRDEsIFNFTUFOVElDX1RFWENPT1JEMixcbiAgICBTRU1BTlRJQ19URVhDT09SRDMsIFNFTUFOVElDX1RFWENPT1JENCwgU0VNQU5USUNfVEVYQ09PUkQ1LCBTRU1BTlRJQ19URVhDT09SRDYsIFNFTUFOVElDX1RFWENPT1JENyxcbiAgICBTRU1BTlRJQ19DT0xPUiwgU0VNQU5USUNfQkxFTkRJTkRJQ0VTLCBTRU1BTlRJQ19CTEVORFdFSUdIVFxufSBmcm9tICcuL2NvbnN0YW50cy5qcyc7XG5cbmltcG9ydCBnbGVzMkZTIGZyb20gJy4vc2hhZGVyLWNodW5rcy9mcmFnL2dsZXMyLmpzJztcbmltcG9ydCBnbGVzM0ZTIGZyb20gJy4vc2hhZGVyLWNodW5rcy9mcmFnL2dsZXMzLmpzJztcbmltcG9ydCBnbGVzM1ZTIGZyb20gJy4vc2hhZGVyLWNodW5rcy92ZXJ0L2dsZXMzLmpzJztcbmltcG9ydCB3ZWJncHVGUyBmcm9tICcuL3NoYWRlci1jaHVua3MvZnJhZy93ZWJncHUuanMnO1xuaW1wb3J0IHdlYmdwdVZTIGZyb20gJy4vc2hhZGVyLWNodW5rcy92ZXJ0L3dlYmdwdS5qcyc7XG5cbi8qKiBAdHlwZWRlZiB7aW1wb3J0KCcuL2dyYXBoaWNzLWRldmljZS5qcycpLkdyYXBoaWNzRGV2aWNlfSBHcmFwaGljc0RldmljZSAqL1xuXG5jb25zdCBfYXR0cmliMlNlbWFudGljID0ge1xuICAgIHZlcnRleF9wb3NpdGlvbjogU0VNQU5USUNfUE9TSVRJT04sXG4gICAgdmVydGV4X25vcm1hbDogU0VNQU5USUNfTk9STUFMLFxuICAgIHZlcnRleF90YW5nZW50OiBTRU1BTlRJQ19UQU5HRU5ULFxuICAgIHZlcnRleF90ZXhDb29yZDA6IFNFTUFOVElDX1RFWENPT1JEMCxcbiAgICB2ZXJ0ZXhfdGV4Q29vcmQxOiBTRU1BTlRJQ19URVhDT09SRDEsXG4gICAgdmVydGV4X3RleENvb3JkMjogU0VNQU5USUNfVEVYQ09PUkQyLFxuICAgIHZlcnRleF90ZXhDb29yZDM6IFNFTUFOVElDX1RFWENPT1JEMyxcbiAgICB2ZXJ0ZXhfdGV4Q29vcmQ0OiBTRU1BTlRJQ19URVhDT09SRDQsXG4gICAgdmVydGV4X3RleENvb3JkNTogU0VNQU5USUNfVEVYQ09PUkQ1LFxuICAgIHZlcnRleF90ZXhDb29yZDY6IFNFTUFOVElDX1RFWENPT1JENixcbiAgICB2ZXJ0ZXhfdGV4Q29vcmQ3OiBTRU1BTlRJQ19URVhDT09SRDcsXG4gICAgdmVydGV4X2NvbG9yOiBTRU1BTlRJQ19DT0xPUixcbiAgICB2ZXJ0ZXhfYm9uZUluZGljZXM6IFNFTUFOVElDX0JMRU5ESU5ESUNFUyxcbiAgICB2ZXJ0ZXhfYm9uZVdlaWdodHM6IFNFTUFOVElDX0JMRU5EV0VJR0hUXG59O1xuXG4vKipcbiAqIEEgY2xhc3MgcHJvdmlkaW5nIHV0aWxpdHkgZnVuY3Rpb25zIGZvciBzaGFkZXIgY3JlYXRpb24uXG4gKlxuICogQGlnbm9yZVxuICovXG5jbGFzcyBTaGFkZXJVdGlscyB7XG4gICAgLyoqXG4gICAgICogQ3JlYXRlcyBhIHNoYWRlciBkZWZpbml0aW9uLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtHcmFwaGljc0RldmljZX0gZGV2aWNlIC0gVGhlIGdyYXBoaWNzIGRldmljZS5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucyAtIE9iamVjdCBmb3IgcGFzc2luZyBvcHRpb25hbCBhcmd1bWVudHMuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IFtvcHRpb25zLm5hbWVdIC0gQSBuYW1lIG9mIHRoZSBzaGFkZXIuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zLmF0dHJpYnV0ZXNdIC0gQXR0cmlidXRlcy4gV2lsbCBiZSBleHRyYWN0ZWQgZnJvbSB0aGUgdmVydGV4Q29kZSBpZlxuICAgICAqIG5vdCBwcm92aWRlZC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gb3B0aW9ucy52ZXJ0ZXhDb2RlIC0gVGhlIHZlcnRleCBzaGFkZXIgY29kZS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW29wdGlvbnMudmVydGV4RGVmaW5lc10gLSBUaGUgdmVydGV4IHNoYWRlciBkZWZpbmVzLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbb3B0aW9ucy52ZXJ0ZXhFeHRlbnNpb25zXSAtIFRoZSB2ZXJ0ZXggc2hhZGVyIGV4dGVuc2lvbnMgY29kZS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW29wdGlvbnMuZnJhZ21lbnRDb2RlXSAtIFRoZSBmcmFnbWVudCBzaGFkZXIgY29kZS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW29wdGlvbnMuZnJhZ21lbnREZWZpbmVzXSAtIFRoZSBmcmFnbWVudCBzaGFkZXIgZGVmaW5lcy5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW29wdGlvbnMuZnJhZ21lbnRFeHRlbnNpb25zXSAtIFRoZSBmcmFnbWVudCBzaGFkZXIgZXh0ZW5zaW9ucyBjb2RlLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbb3B0aW9ucy5mcmFnbWVudFByZWFtYmxlXSAtIFRoZSBwcmVhbWJsZSBzdHJpbmcgZm9yIHRoZSBmcmFnbWVudCBzaGFkZXIuXG4gICAgICogQHBhcmFtIHtib29sZWFufSBbb3B0aW9ucy51c2VUcmFuc2Zvcm1GZWVkYmFja10gLSBXaGV0aGVyIHRvIHVzZSB0cmFuc2Zvcm0gZmVlZGJhY2suIERlZmF1bHRzXG4gICAgICogdG8gZmFsc2UuXG4gICAgICogQHJldHVybnMge29iamVjdH0gUmV0dXJucyB0aGUgY3JlYXRlZCBzaGFkZXIgZGVmaW5pdGlvbi5cbiAgICAgKi9cbiAgICBzdGF0aWMgY3JlYXRlRGVmaW5pdGlvbihkZXZpY2UsIG9wdGlvbnMpIHtcbiAgICAgICAgRGVidWcuYXNzZXJ0KG9wdGlvbnMpO1xuXG4gICAgICAgIGNvbnN0IGdldERlZmluZXMgPSAoZ3B1LCBnbDIsIGdsMSwgaXNWZXJ0ZXgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBkZXZpY2UuZGV2aWNlVHlwZSA9PT0gREVWSUNFVFlQRV9XRUJHUFUgPyBncHUgOlxuICAgICAgICAgICAgICAgIChkZXZpY2Uud2ViZ2wyID8gZ2wyIDogU2hhZGVyVXRpbHMuZ2wxRXh0ZW5zaW9ucyhkZXZpY2UsIG9wdGlvbnMpICsgZ2wxKTtcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBuYW1lID0gb3B0aW9ucy5uYW1lID8/ICdVbnRpdGxlZCc7XG5cbiAgICAgICAgLy8gdmVydGV4IGNvZGVcbiAgICAgICAgY29uc3QgdmVydERlZmluZXMgPSBvcHRpb25zLnZlcnRleERlZmluZXMgfHwgZ2V0RGVmaW5lcyh3ZWJncHVWUywgZ2xlczNWUywgJycsIHRydWUpO1xuICAgICAgICBjb25zdCB2ZXJ0Q29kZSA9IFNoYWRlclV0aWxzLnZlcnNpb25Db2RlKGRldmljZSkgK1xuICAgICAgICAgICAgdmVydERlZmluZXMgK1xuICAgICAgICAgICAgU2hhZGVyVXRpbHMuZ2V0U2hhZGVyTmFtZUNvZGUobmFtZSkgK1xuICAgICAgICAgICAgb3B0aW9ucy52ZXJ0ZXhDb2RlO1xuXG4gICAgICAgIC8vIGZyYWdtZW50IGNvZGVcbiAgICAgICAgY29uc3QgZnJhZ0RlZmluZXMgPSBvcHRpb25zLmZyYWdtZW50RGVmaW5lcyB8fCBnZXREZWZpbmVzKHdlYmdwdUZTLCBnbGVzM0ZTLCBnbGVzMkZTLCBmYWxzZSk7XG4gICAgICAgIGNvbnN0IGZyYWdDb2RlID0gKG9wdGlvbnMuZnJhZ21lbnRQcmVhbWJsZSB8fCAnJykgK1xuICAgICAgICBTaGFkZXJVdGlscy52ZXJzaW9uQ29kZShkZXZpY2UpICtcbiAgICAgICAgICAgIFNoYWRlclV0aWxzLnByZWNpc2lvbkNvZGUoZGV2aWNlKSArICdcXG4nICtcbiAgICAgICAgICAgIGZyYWdEZWZpbmVzICtcbiAgICAgICAgICAgIFNoYWRlclV0aWxzLmdldFNoYWRlck5hbWVDb2RlKG5hbWUpICtcbiAgICAgICAgICAgIChvcHRpb25zLmZyYWdtZW50Q29kZSB8fCBTaGFkZXJVdGlscy5kdW1teUZyYWdtZW50Q29kZSgpKTtcblxuICAgICAgICAvLyBhdHRyaWJ1dGVzXG4gICAgICAgIGNvbnN0IGF0dHJpYnMgPSBvcHRpb25zLmF0dHJpYnV0ZXMgPz8gU2hhZGVyVXRpbHMuY29sbGVjdEF0dHJpYnV0ZXMob3B0aW9ucy52ZXJ0ZXhDb2RlKTtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgbmFtZTogbmFtZSxcbiAgICAgICAgICAgIGF0dHJpYnV0ZXM6IGF0dHJpYnMsXG4gICAgICAgICAgICB2c2hhZGVyOiB2ZXJ0Q29kZSxcbiAgICAgICAgICAgIGZzaGFkZXI6IGZyYWdDb2RlLFxuICAgICAgICAgICAgdXNlVHJhbnNmb3JtRmVlZGJhY2s6IG9wdGlvbnMudXNlVHJhbnNmb3JtRmVlZGJhY2tcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAvLyBTcGVjdG9ySlMgaW50ZWdyYXRpb25cbiAgICBzdGF0aWMgZ2V0U2hhZGVyTmFtZUNvZGUobmFtZSkge1xuICAgICAgICByZXR1cm4gYCNkZWZpbmUgU0hBREVSX05BTUUgJHtuYW1lfVxcbmA7XG4gICAgfVxuXG4gICAgc3RhdGljIGdsMUV4dGVuc2lvbnMoZGV2aWNlLCBvcHRpb25zLCBpc1ZlcnRleCkge1xuICAgICAgICBsZXQgY29kZTtcbiAgICAgICAgaWYgKGlzVmVydGV4KSB7XG4gICAgICAgICAgICBjb2RlID0gb3B0aW9ucy52ZXJ0ZXhFeHRlbnNpb25zID8gYCR7b3B0aW9ucy52ZXJ0ZXhFeHRlbnNpb25zfVxcbmAgOiAnJztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvZGUgPSBvcHRpb25zLmZyYWdtZW50RXh0ZW5zaW9ucyA/IGAke29wdGlvbnMuZnJhZ21lbnRFeHRlbnNpb25zfVxcbmAgOiAnJztcblxuICAgICAgICAgICAgLy8gZXh0ZW5zaW9ucyB1c2VkIGJ5IGRlZmF1bHRcbiAgICAgICAgICAgIGlmIChkZXZpY2UuZXh0U3RhbmRhcmREZXJpdmF0aXZlcykge1xuICAgICAgICAgICAgICAgIGNvZGUgKz0gXCIjZXh0ZW5zaW9uIEdMX09FU19zdGFuZGFyZF9kZXJpdmF0aXZlcyA6IGVuYWJsZVxcblwiO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGRldmljZS5leHRUZXh0dXJlTG9kKSB7XG4gICAgICAgICAgICAgICAgY29kZSArPSBcIiNleHRlbnNpb24gR0xfRVhUX3NoYWRlcl90ZXh0dXJlX2xvZCA6IGVuYWJsZVxcblwiO1xuICAgICAgICAgICAgICAgIGNvZGUgKz0gXCIjZGVmaW5lIFNVUFBPUlRTX1RFWExPRFxcblwiO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGNvZGU7XG4gICAgfVxuXG4gICAgc3RhdGljIGR1bW15RnJhZ21lbnRDb2RlKCkge1xuICAgICAgICByZXR1cm4gXCJ2b2lkIG1haW4odm9pZCkge2dsX0ZyYWdDb2xvciA9IHZlYzQoMC4wKTt9XCI7XG4gICAgfVxuXG4gICAgc3RhdGljIHZlcnNpb25Db2RlKGRldmljZSkge1xuICAgICAgICBpZiAoZGV2aWNlLmRldmljZVR5cGUgPT09IERFVklDRVRZUEVfV0VCR1BVKSB7XG4gICAgICAgICAgICByZXR1cm4gJyN2ZXJzaW9uIDQ1MFxcbic7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGRldmljZS53ZWJnbDIgPyBcIiN2ZXJzaW9uIDMwMCBlc1xcblwiIDogXCJcIjtcbiAgICB9XG5cbiAgICBzdGF0aWMgcHJlY2lzaW9uQ29kZShkZXZpY2UsIGZvcmNlUHJlY2lzaW9uKSB7XG5cbiAgICAgICAgbGV0IGNvZGUgPSAnJztcblxuICAgICAgICBpZiAoZGV2aWNlLmRldmljZVR5cGUgPT09IERFVklDRVRZUEVfV0VCR0wpIHtcblxuICAgICAgICAgICAgaWYgKGZvcmNlUHJlY2lzaW9uICYmIGZvcmNlUHJlY2lzaW9uICE9PSAnaGlnaHAnICYmIGZvcmNlUHJlY2lzaW9uICE9PSAnbWVkaXVtcCcgJiYgZm9yY2VQcmVjaXNpb24gIT09ICdsb3dwJykge1xuICAgICAgICAgICAgICAgIGZvcmNlUHJlY2lzaW9uID0gbnVsbDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGZvcmNlUHJlY2lzaW9uKSB7XG4gICAgICAgICAgICAgICAgaWYgKGZvcmNlUHJlY2lzaW9uID09PSAnaGlnaHAnICYmIGRldmljZS5tYXhQcmVjaXNpb24gIT09ICdoaWdocCcpIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yY2VQcmVjaXNpb24gPSAnbWVkaXVtcCc7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChmb3JjZVByZWNpc2lvbiA9PT0gJ21lZGl1bXAnICYmIGRldmljZS5tYXhQcmVjaXNpb24gPT09ICdsb3dwJykge1xuICAgICAgICAgICAgICAgICAgICBmb3JjZVByZWNpc2lvbiA9ICdsb3dwJztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IHByZWNpc2lvbiA9IGZvcmNlUHJlY2lzaW9uID8gZm9yY2VQcmVjaXNpb24gOiBkZXZpY2UucHJlY2lzaW9uO1xuICAgICAgICAgICAgY29kZSA9IGBwcmVjaXNpb24gJHtwcmVjaXNpb259IGZsb2F0O1xcbmA7XG5cbiAgICAgICAgICAgIGlmIChkZXZpY2Uud2ViZ2wyKSB7XG4gICAgICAgICAgICAgICAgY29kZSArPSBgcHJlY2lzaW9uICR7cHJlY2lzaW9ufSBzYW1wbGVyMkRTaGFkb3c7XFxuYDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBjb2RlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEV4dHJhY3QgdGhlIGF0dHJpYnV0ZXMgc3BlY2lmaWVkIGluIGEgdmVydGV4IHNoYWRlci5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSB2c0NvZGUgLSBUaGUgdmVydGV4IHNoYWRlciBjb2RlLlxuICAgICAqIEByZXR1cm5zIHtPYmplY3Q8c3RyaW5nLCBzdHJpbmc+fSBUaGUgYXR0cmlidXRlIG5hbWUgdG8gc2VtYW50aWMgbWFwLlxuICAgICAqIEBpZ25vcmVcbiAgICAgKi9cbiAgICBzdGF0aWMgY29sbGVjdEF0dHJpYnV0ZXModnNDb2RlKSB7XG4gICAgICAgIGNvbnN0IGF0dHJpYnMgPSB7fTtcbiAgICAgICAgbGV0IGF0dHJzID0gMDtcblxuICAgICAgICBsZXQgZm91bmQgPSB2c0NvZGUuaW5kZXhPZihcImF0dHJpYnV0ZVwiKTtcbiAgICAgICAgd2hpbGUgKGZvdW5kID49IDApIHtcbiAgICAgICAgICAgIGlmIChmb3VuZCA+IDAgJiYgdnNDb2RlW2ZvdW5kIC0gMV0gPT09IFwiL1wiKSBicmVhaztcbiAgICAgICAgICAgIGNvbnN0IGVuZE9mTGluZSA9IHZzQ29kZS5pbmRleE9mKCc7JywgZm91bmQpO1xuICAgICAgICAgICAgY29uc3Qgc3RhcnRPZkF0dHJpYk5hbWUgPSB2c0NvZGUubGFzdEluZGV4T2YoJyAnLCBlbmRPZkxpbmUpO1xuICAgICAgICAgICAgY29uc3QgYXR0cmliTmFtZSA9IHZzQ29kZS5zdWJzdHJpbmcoc3RhcnRPZkF0dHJpYk5hbWUgKyAxLCBlbmRPZkxpbmUpO1xuXG4gICAgICAgICAgICBjb25zdCBzZW1hbnRpYyA9IF9hdHRyaWIyU2VtYW50aWNbYXR0cmliTmFtZV07XG4gICAgICAgICAgICBpZiAoc2VtYW50aWMgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIGF0dHJpYnNbYXR0cmliTmFtZV0gPSBzZW1hbnRpYztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYXR0cmlic1thdHRyaWJOYW1lXSA9IFwiQVRUUlwiICsgYXR0cnM7XG4gICAgICAgICAgICAgICAgYXR0cnMrKztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZm91bmQgPSB2c0NvZGUuaW5kZXhPZihcImF0dHJpYnV0ZVwiLCBmb3VuZCArIDEpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGF0dHJpYnM7XG4gICAgfVxufVxuXG5leHBvcnQgeyBTaGFkZXJVdGlscyB9O1xuIl0sIm5hbWVzIjpbIl9hdHRyaWIyU2VtYW50aWMiLCJ2ZXJ0ZXhfcG9zaXRpb24iLCJTRU1BTlRJQ19QT1NJVElPTiIsInZlcnRleF9ub3JtYWwiLCJTRU1BTlRJQ19OT1JNQUwiLCJ2ZXJ0ZXhfdGFuZ2VudCIsIlNFTUFOVElDX1RBTkdFTlQiLCJ2ZXJ0ZXhfdGV4Q29vcmQwIiwiU0VNQU5USUNfVEVYQ09PUkQwIiwidmVydGV4X3RleENvb3JkMSIsIlNFTUFOVElDX1RFWENPT1JEMSIsInZlcnRleF90ZXhDb29yZDIiLCJTRU1BTlRJQ19URVhDT09SRDIiLCJ2ZXJ0ZXhfdGV4Q29vcmQzIiwiU0VNQU5USUNfVEVYQ09PUkQzIiwidmVydGV4X3RleENvb3JkNCIsIlNFTUFOVElDX1RFWENPT1JENCIsInZlcnRleF90ZXhDb29yZDUiLCJTRU1BTlRJQ19URVhDT09SRDUiLCJ2ZXJ0ZXhfdGV4Q29vcmQ2IiwiU0VNQU5USUNfVEVYQ09PUkQ2IiwidmVydGV4X3RleENvb3JkNyIsIlNFTUFOVElDX1RFWENPT1JENyIsInZlcnRleF9jb2xvciIsIlNFTUFOVElDX0NPTE9SIiwidmVydGV4X2JvbmVJbmRpY2VzIiwiU0VNQU5USUNfQkxFTkRJTkRJQ0VTIiwidmVydGV4X2JvbmVXZWlnaHRzIiwiU0VNQU5USUNfQkxFTkRXRUlHSFQiLCJTaGFkZXJVdGlscyIsImNyZWF0ZURlZmluaXRpb24iLCJkZXZpY2UiLCJvcHRpb25zIiwiRGVidWciLCJhc3NlcnQiLCJnZXREZWZpbmVzIiwiZ3B1IiwiZ2wyIiwiZ2wxIiwiaXNWZXJ0ZXgiLCJkZXZpY2VUeXBlIiwiREVWSUNFVFlQRV9XRUJHUFUiLCJ3ZWJnbDIiLCJnbDFFeHRlbnNpb25zIiwibmFtZSIsInZlcnREZWZpbmVzIiwidmVydGV4RGVmaW5lcyIsIndlYmdwdVZTIiwiZ2xlczNWUyIsInZlcnRDb2RlIiwidmVyc2lvbkNvZGUiLCJnZXRTaGFkZXJOYW1lQ29kZSIsInZlcnRleENvZGUiLCJmcmFnRGVmaW5lcyIsImZyYWdtZW50RGVmaW5lcyIsIndlYmdwdUZTIiwiZ2xlczNGUyIsImdsZXMyRlMiLCJmcmFnQ29kZSIsImZyYWdtZW50UHJlYW1ibGUiLCJwcmVjaXNpb25Db2RlIiwiZnJhZ21lbnRDb2RlIiwiZHVtbXlGcmFnbWVudENvZGUiLCJhdHRyaWJzIiwiYXR0cmlidXRlcyIsImNvbGxlY3RBdHRyaWJ1dGVzIiwidnNoYWRlciIsImZzaGFkZXIiLCJ1c2VUcmFuc2Zvcm1GZWVkYmFjayIsImNvZGUiLCJ2ZXJ0ZXhFeHRlbnNpb25zIiwiZnJhZ21lbnRFeHRlbnNpb25zIiwiZXh0U3RhbmRhcmREZXJpdmF0aXZlcyIsImV4dFRleHR1cmVMb2QiLCJmb3JjZVByZWNpc2lvbiIsIkRFVklDRVRZUEVfV0VCR0wiLCJtYXhQcmVjaXNpb24iLCJwcmVjaXNpb24iLCJ2c0NvZGUiLCJhdHRycyIsImZvdW5kIiwiaW5kZXhPZiIsImVuZE9mTGluZSIsInN0YXJ0T2ZBdHRyaWJOYW1lIiwibGFzdEluZGV4T2YiLCJhdHRyaWJOYW1lIiwic3Vic3RyaW5nIiwic2VtYW50aWMiLCJ1bmRlZmluZWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFnQkEsTUFBTUEsZ0JBQWdCLEdBQUc7QUFDckJDLEVBQUFBLGVBQWUsRUFBRUMsaUJBQWlCO0FBQ2xDQyxFQUFBQSxhQUFhLEVBQUVDLGVBQWU7QUFDOUJDLEVBQUFBLGNBQWMsRUFBRUMsZ0JB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
