import{path as t}from"../../../core/path.js";import{http as e}from"../../../net/http.js";import{PIXELFORMAT_R8_G8_B8 as o,PIXELFORMAT_R8_G8_B8_A8 as i}from"../../../graphics/constants.js";import{Texture as r}from"../../../graphics/texture.js";import{ABSOLUTE_URL as n}from"../../../asset/constants.js";class s{constructor(t,e){this.crossOrigin=t.prefix?"anonymous":null,this.maxRetries=0,this.device=e}load(t,e,o){var i;const r=!(null==o||null==(i=o.file)||!i.contents);if(r){if(this.device.supportsImageBitmap)return void this._loadImageBitmapFromData(o.file.contents,e);t={load:URL.createObjectURL(new Blob([o.file.contents])),original:t.original}}const s=(o,i)=>{r&&URL.revokeObjectURL(t.load),e(o,i)};let a;o&&o.options&&o.options.hasOwnProperty("crossOrigin")?a=o.options.crossOrigin:n.test(t.load)&&(a=this.crossOrigin),this.device.supportsImageBitmap?this._loadImageBitmap(t.load,t.original,a,s):this._loadImage(t.load,t.original,a,s)}open(e,n,s){const a=t.getExtension(e).toLowerCase(),l=".jpg"===a||".jpeg"===a?o:i,c=new r(s,{name:e,width:n.width,height:n.height,format:l});return c.setSource(n),c}_loadImage(t,e,o,i){const r=new Image;o&&(r.crossOrigin=o);let n=0;const s=this.maxRetries;let a;r.onload=function(){i(null,r)},r.onerror=function(){if(!a)if(s>0&&++n<=s){const o=100*Math.pow(2,n);console.log(`Error loading Texture from: '${e}' - Retrying in ${o}ms...`);const i=t.indexOf("?")>=0?"&":"?";a=setTimeout((function(){r.src=t+i+"retry="+Date.now(),a=null}),o)}else i(`Error loading Texture from: '${e}'`)},r.src=t}_loadImageBitmap(t,o,i,r){const n={cache:!0,responseType:"blob",retry:this.maxRetries>0,maxRetries:this.maxRetries};e.get(t,n,(function(t,e){t?r(t):createImageBitmap(e,{premultiplyAlpha:"none"}).then((t=>r(null,t))).catch((t=>r(t)))}))}_loadImageBitmapFromData(t,e){createImageBitmap(new Blob([t]),{premultiplyAlpha:"none"}).then((t=>e(null,t))).catch((t=>e(t)))}}export{s as ImgParser};
