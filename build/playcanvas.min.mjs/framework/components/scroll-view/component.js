import"../../../core/debug.js";import{math as t}from"../../../core/math/math.js";import{Vec2 as e}from"../../../core/math/vec2.js";import{Vec3 as n}from"../../../core/math/vec3.js";import{ORIENTATION_HORIZONTAL as s,ORIENTATION_VERTICAL as i}from"../../../scene/constants.js";import{EntityReference as o}from"../../utils/entity-reference.js";import{ElementDragHelper as l}from"../element/element-drag-helper.js";import{SCROLL_MODE_INFINITE as r,SCROLL_MODE_BOUNCE as a,SCROLL_MODE_CLAMP as h,SCROLLBAR_VISIBILITY_SHOW_WHEN_REQUIRED as c,SCROLLBAR_VISIBILITY_SHOW_ALWAYS as _}from"./constants.js";import{Component as g}from"../component.js";import{EVENT_MOUSEWHEEL as b}from"../../../platform/input/constants.js";const d=new e;class S extends g{constructor(t,l){super(t,l),this._viewportReference=new o(this,"viewportEntity",{"element#gain":this._onViewportElementGain,"element#resize":this._onSetContentOrViewportSize}),this._contentReference=new o(this,"contentEntity",{"element#gain":this._onContentElementGain,"element#lose":this._onContentElementLose,"element#resize":this._onSetContentOrViewportSize}),this._scrollbarUpdateFlags={},this._scrollbarReferences={},this._scrollbarReferences[s]=new o(this,"horizontalScrollbarEntity",{"scrollbar#set:value":this._onSetHorizontalScrollbarValue,"scrollbar#gain":this._onHorizontalScrollbarGain}),this._scrollbarReferences[i]=new o(this,"verticalScrollbarEntity",{"scrollbar#set:value":this._onSetVerticalScrollbarValue,"scrollbar#gain":this._onVerticalScrollbarGain}),this._prevContentSizes={},this._prevContentSizes[s]=null,this._prevContentSizes[i]=null,this._scroll=new e,this._velocity=new n,this._dragStartPosition=new n,this._disabledContentInput=!1,this._disabledContentInputEntities=[],this._toggleLifecycleListeners("on",t),this._toggleElementListeners("on")}_toggleLifecycleListeners(t,e){this[t]("set_horizontal",this._onSetHorizontalScrollingEnabled,this),this[t]("set_vertical",this._onSetVerticalScrollingEnabled,this),e.app.systems.element[t]("add",this._onElementComponentAdd,this),e.app.systems.element[t]("beforeremove",this._onElementComponentRemove,this)}_toggleElementListeners(t){if(this.entity.element){if("on"===t&&this._hasElementListeners)return;this.entity.element[t]("resize",this._onSetContentOrViewportSize,this),this.entity.element[t](b,this._onMouseWheel,this),this._hasElementListeners="on"===t}}_onElementComponentAdd(t){this.entity===t&&this._toggleElementListeners("on")}_onElementComponentRemove(t){this.entity===t&&this._toggleElementListeners("off")}_onViewportElementGain(){this._syncAll()}_onContentElementGain(){this._destroyDragHelper(),this._contentDragHelper=new l(this._contentReference.entity.element),this._contentDragHelper.on("drag:start",this._onContentDragStart,this),this._contentDragHelper.on("drag:end",this._onContentDragEnd,this),this._contentDragHelper.on("drag:move",this._onContentDragMove,this),this._prevContentSizes[s]=null,this._prevContentSizes[i]=null,this._syncAll()}_onContentElementLose(){this._destroyDragHelper()}_onContentDragStart(){this._contentReference.entity&&this.enabled&&this.entity.enabled&&this._dragStartPosition.copy(this._contentReference.entity.getLocalPosition())}_onContentDragEnd(){this._prevContentDragPosition=null,this._enableContentInput()}_onContentDragMove(t){if(this._contentReference.entity&&this.enabled&&this.entity.enabled&&(this._wasDragged=!0,this._setScrollFromContentPosition(t),this._setVelocityFromContentPositionDelta(t),!this._disabledContentInput)){const e=t.x-this._dragStartPosition.x,n=t.y-this._dragStartPosition.y;(Math.abs(e)>this.dragThreshold||Math.abs(n)>this.dragThreshold)&&this._disableContentInput()}}_onSetContentOrViewportSize(){this._syncAll()}_onSetHorizontalScrollbarValue(t){!this._scrollbarUpdateFlags[s]&&this.enabled&&this.entity.enabled&&this._onSetScroll(t,null)}_onSetVerticalScrollbarValue(t){!this._scrollbarUpdateFlags[i]&&this.enabled&&this.entity.enabled&&this._onSetScroll(null,t)}_onSetHorizontalScrollingEnabled(){this._syncScrollbarEnabledState(s)}_onSetVerticalScrollingEnabled(){this._syncScrollbarEnabledState(i)}_onHorizontalScrollbarGain(){this._syncScrollbarEnabledState(s),this._syncScrollbarPosition(s)}_onVerticalScrollbarGain(){this._syncScrollbarEnabledState(i),this._syncScrollbarPosition(i)}_onSetScroll(t,e,n){!1!==n&&this._velocity.set(0,0,0);const o=this._updateAxis(t,"x",s),l=this._updateAxis(e,"y",i);(o||l)&&this.fire("set:scroll",this._scroll)}_updateAxis(t,e,n){const s=null!==t&&Math.abs(t-this._scroll[e])>1e-5;return(s||this._isDragging()||0===t)&&(this._scroll[e]=this._determineNewScrollValue(t,e,n),this._syncContentPosition(n),this._syncScrollbarPosition(n)),s}_determineNewScrollValue(e,n,s){if(!this._getScrollingEnabled(s))return this._scroll[n];switch(this.scrollMode){case h:return t.clamp(e,0,this._getMaxScrollValue(s));case a:return this._setVelocityFromOvershoot(e,n,s),e;case r:return e;default:return console.warn("Unhandled scroll mode:"+this.scrollMode),e}}_syncAll(){this._syncContentPosition(s),this._syncContentPosition(i),this._syncScrollbarPosition(s),this._syncScrollbarPosition(i),this._syncScrollbarEnabledState(s),this._syncScrollbarEnabledState(i)}_syncContentPosition(e){const n=this._getAxis(e),s=this._getSign(e),i=this._contentReference.entity;if(i){const o=this._prevContentSizes[e],l=this._getContentSize(e);if(null!==o&&Math.abs(o-l)>1e-4){const s=this._getMaxOffset(e,o),i=this._getMaxOffset(e,l);this._scroll[n]=0===i?1:t.clamp(this._scroll[n]*s/i,0,1)}const r=this._scroll[n]*this._getMaxOffset(e),a=i.getLocalPosition();a[n]=r*s,i.setLocalPosition(a),this._prevContentSizes[e]=l}}_syncScrollbarPosition(t){const e=this._getAxis(t),n=this._scrollbarReferences[t].entity;n&&n.scrollbar&&(this._scrollbarUpdateFlags[t]=!0,n.scrollbar.value=this._scroll[e],n.scrollbar.handleSize=this._getScrollbarHandleSize(e,t),this._scrollbarUpdateFlags[t]=!1)}_syncScrollbarEnabledState(t){const e=this._scrollbarReferences[t].entity;if(e){const n=this._getScrollingEnabled(t),s=this._getScrollbarVisibility(t);switch(s){case _:return void(e.enabled=n);case c:return void(e.enabled=n&&this._contentIsLargerThanViewport(t));default:console.warn("Unhandled scrollbar visibility:"+s),e.enabled=n}}}_contentIsLargerThanViewport(t){return this._getContentSize(t)>this._getViewportSize(t)}_contentPositionToScrollValue(t){const e=this._getMaxOffset(s),n=this._getMaxOffset(i);return d.x=0===e?0:t.x/e,d.y=0===n?0:t.y/-n,d}_getMaxOffset(t,e){e=void 0===e?this._getContentSize(t):e;const n=this._getViewportSize(t);return e<n?-this._getViewportSize(t):n-e}_getMaxScrollValue(t){return this._contentIsLargerThanViewport(t)?1:0}_getScrollbarHandleSize(t,e){const n=this._getViewportSize(e),s=this._getContentSize(e);if(Math.abs(s)<.001)return 1;const i=Math.min(n/s,1),o=this._toOvershoot(this._scroll[t],e);return 0===o?i:i/(1+Math.abs(o))}_getViewportSize(t){return this._getSize(t,this._viewportReference)}_getContentSize(t){return this._getSize(t,this._contentReference)}_getSize(t,e){return e.entity&&e.entity.element?e.entity.element[this._getCalculatedDimension(t)]:0}_getScrollingEnabled(t){return t===s?this.horizontal:t===i?this.vertical:void 0}_getScrollbarVisibility(t){return t===s?this.horizontalScrollbarVisibility:t===i?this.verticalScrollbarVisibility:void 0}_getSign(t){return t===s?1:-1}_getAxis(t){return t===s?"x":"y"}_getCalculatedDimension(t){return t===s?"calculatedWidth":"calculatedHeight"}_destroyDragHelper(){this._contentDragHelper&&this._contentDragHelper.destroy()}onUpdate(){this._contentReference.entity&&(this._updateVelocity(),this._syncScrollbarEnabledState(s),this._syncScrollbarEnabledState(i))}_updateVelocity(){if(!this._isDragging()){if(this.scrollMode===a&&(this._hasOvershoot("x",s)&&this._setVelocityFromOvershoot(this.scroll.x,"x",s),this._hasOvershoot("y",i)&&this._setVelocityFromOvershoot(this.scroll.y,"y",i)),Math.abs(this._velocity.x)>1e-4||Math.abs(this._velocity.y)>1e-4){const t=this._contentReference.entity.getLocalPosition();t.x+=this._velocity.x,t.y+=this._velocity.y,this._contentReference.entity.setLocalPosition(t),this._setScrollFromContentPosition(t)}this._velocity.x*=1-this.friction,this._velocity.y*=1-this.friction}}_hasOvershoot(t,e){return Math.abs(this._toOvershoot(this.scroll[t],e))>.001}_toOvershoot(t,e){const n=this._getMaxScrollValue(e);return t<0?t:t>n?t-n:0}_setVelocityFromOvershoot(t,e,n){const s=this._toOvershoot(t,n)*this._getMaxOffset(n)*this._getSign(n);Math.abs(s)>0&&(this._velocity[e]=-s/(50*this.bounceAmount+1))}_setVelocityFromContentPositionDelta(t){this._prevContentDragPosition?(this._velocity.sub2(t,this._prevContentDragPosition),this._prevContentDragPosition.copy(t)):(this._velocity.set(0,0,0),this._prevContentDragPosition=t.clone())}_setScrollFromContentPosition(t){let e=this._contentPositionToScrollValue(t);this._isDragging()&&(e=this._applyScrollValueTension(e)),this._onSetScroll(e.x,e.y,!1)}_applyScrollValueTension(t){let e=this._getMaxScrollValue(s),n=this._toOvershoot(t.x,s);return n>0?t.x=e+1*Math.log10(1+n):n<0&&(t.x=-1*Math.log10(1-n)),e=this._getMaxScrollValue(i),n=this._toOvershoot(t.y,i),n>0?t.y=e+1*Math.log10(1+n):n<0&&(t.y=-1*Math.log10(1-n)),t}_isDragging(){return this._contentDragHelper&&this._contentDragHelper.isDragging}_setScrollbarComponentsEnabled(t){this._scrollbarReferences[s].hasComponent("scrollbar")&&(this._scrollbarReferences[s].entity.scrollbar.enabled=t),this._scrollbarReferences[i].hasComponent("scrollbar")&&(this._scrollbarReferences[i].entity.scrollbar.enabled=t)}_setContentDraggingEnabled(t){this._contentDragHelper&&(this._contentDragHelper.enabled=t)}_onMouseWheel(n){if(this.useMouseWheel){const o=n.event,l=o.deltaX/this._contentReference.entity.element.calculatedWidth*this.mouseWheelSensitivity.x,r=o.deltaY/this._contentReference.entity.element.calculatedHeight*this.mouseWheelSensitivity.y,a=t.clamp(this._scroll.x+l,0,this._getMaxScrollValue(s)),h=t.clamp(this._scroll.y+r,0,this._getMaxScrollValue(i));this.scroll=new e(a,h)}}_enableContentInput(){for(;this._disabledContentInputEntities.length;){const t=this._disabledContentInputEntities.pop();t.element&&(t.element.useInput=!0)}this._disabledContentInput=!1}_disableContentInput(){const t=e=>{e.element&&e.element.useInput&&(this._disabledContentInputEntities.push(e),e.element.useInput=!1);const n=e.children;for(let e=0,s=n.length;e<s;e++)t(n[e])},e=this._contentReference.entity;if(e){const n=e.children;for(let e=0,s=n.length;e<s;e++)t(n[e])}this._disabledContentInput=!0}onEnable(){this._viewportReference.onParentComponentEnable(),this._contentReference.onParentComponentEnable(),this._scrollbarReferences[s].onParentComponentEnable(),this._scrollbarReferences[i].onParentComponentEnable(),this._setScrollbarComponentsEnabled(!0),this._setContentDraggingEnabled(!0),this._syncAll()}onDisable(){this._setScrollbarComponentsEnabled(!1),this._setContentDraggingEnabled(!1)}onRemove(){this._toggleLifecycleListeners("off",this.system),this._toggleElementListeners("off"),this._destroyDragHelper()}set scroll(t){this._onSetScroll(t.x,t.y)}get scroll(){return this._scroll}}export{S as ScrollViewComponent};
