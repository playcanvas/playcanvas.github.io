/**
 * @license
 * PlayCanvas Engine v1.62.0-dev revision 7d088032c (DEBUG PROFILER)
 * Copyright 2011-2023 PlayCanvas Ltd. All rights reserved.
 */
import { script } from '../script.js';
import { ScriptTypes } from '../script/script-types.js';

/** @typedef {import('./handler.js').ResourceHandler} ResourceHandler */

/**
 * Resource handler for loading JavaScript files dynamically.  Two types of JavaScript files can be
 * loaded, PlayCanvas scripts which contain calls to {@link createScript}, or regular JavaScript
 * files, such as third-party libraries.
 *
 * @implements {ResourceHandler}
 */
class ScriptHandler {
  /**
   * Type of the resource the handler handles.
   *
   * @type {string}
   */

  /**
   * Create a new ScriptHandler instance.
   *
   * @param {import('../app-base.js').AppBase} app - The running {@link AppBase}.
   * @hideconstructor
   */
  constructor(app) {
    this.handlerType = "script";
    this._app = app;
    this._scripts = {};
    this._cache = {};
  }
  load(url, callback) {
    // Scripts don't support bundling since we concatenate them. Below is for consistency.
    if (typeof url === 'string') {
      url = {
        load: url,
        original: url
      };
    }
    const self = this;
    script.app = this._app;
    this._loadScript(url.load, (err, url, extra) => {
      if (!err) {
        if (script.legacy) {
          let Type = null;
          // pop the type from the loading stack
          if (ScriptTypes._types.length) {
            Type = ScriptTypes._types.pop();
          }
          if (Type) {
            // store indexed by URL
            this._scripts[url] = Type;
          } else {
            Type = null;
          }

          // return the resource
          callback(null, Type, extra);
        } else {
          const obj = {};
          for (let i = 0; i < ScriptTypes._types.length; i++) obj[ScriptTypes._types[i].name] = ScriptTypes._types[i];
          ScriptTypes._types.length = 0;
          callback(null, obj, extra);

          // no cache for scripts
          delete self._loader._cache[url + 'script'];
        }
      } else {
        callback(err);
      }
    });
  }
  open(url, data) {
    return data;
  }
  patch(asset, assets) {}
  _loadScript(url, callback) {
    const head = document.head;
    const element = document.createElement('script');
    this._cache[url] = element;

    // use async=false to force scripts to execute in order
    element.async = false;
    element.addEventListener('error', function (e) {
      callback(`Script: ${e.target.src} failed to load`);
    }, false);
    let done = false;
    element.onload = element.onreadystatechange = function () {
      if (!done && (!this.readyState || this.readyState === 'loaded' || this.readyState === 'complete')) {
        done = true; // prevent double event firing
        callback(null, url, element);
      }
    };
    // set the src attribute after the onload callback is set, to avoid an instant loading failing to fire the callback
    element.src = url;
    head.appendChild(element);
  }
}

export { ScriptHandler };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NyaXB0LmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvZnJhbWV3b3JrL2hhbmRsZXJzL3NjcmlwdC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBzY3JpcHQgfSBmcm9tICcuLi9zY3JpcHQuanMnO1xuaW1wb3J0IHsgU2NyaXB0VHlwZXMgfSBmcm9tICcuLi9zY3JpcHQvc2NyaXB0LXR5cGVzLmpzJztcblxuLyoqIEB0eXBlZGVmIHtpbXBvcnQoJy4vaGFuZGxlci5qcycpLlJlc291cmNlSGFuZGxlcn0gUmVzb3VyY2VIYW5kbGVyICovXG5cbi8qKlxuICogUmVzb3VyY2UgaGFuZGxlciBmb3IgbG9hZGluZyBKYXZhU2NyaXB0IGZpbGVzIGR5bmFtaWNhbGx5LiAgVHdvIHR5cGVzIG9mIEphdmFTY3JpcHQgZmlsZXMgY2FuIGJlXG4gKiBsb2FkZWQsIFBsYXlDYW52YXMgc2NyaXB0cyB3aGljaCBjb250YWluIGNhbGxzIHRvIHtAbGluayBjcmVhdGVTY3JpcHR9LCBvciByZWd1bGFyIEphdmFTY3JpcHRcbiAqIGZpbGVzLCBzdWNoIGFzIHRoaXJkLXBhcnR5IGxpYnJhcmllcy5cbiAqXG4gKiBAaW1wbGVtZW50cyB7UmVzb3VyY2VIYW5kbGVyfVxuICovXG5jbGFzcyBTY3JpcHRIYW5kbGVyIHtcbiAgICAvKipcbiAgICAgKiBUeXBlIG9mIHRoZSByZXNvdXJjZSB0aGUgaGFuZGxlciBoYW5kbGVzLlxuICAgICAqXG4gICAgICogQHR5cGUge3N0cmluZ31cbiAgICAgKi9cbiAgICBoYW5kbGVyVHlwZSA9IFwic2NyaXB0XCI7XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBuZXcgU2NyaXB0SGFuZGxlciBpbnN0YW5jZS5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7aW1wb3J0KCcuLi9hcHAtYmFzZS5qcycpLkFwcEJhc2V9IGFwcCAtIFRoZSBydW5uaW5nIHtAbGluayBBcHBCYXNlfS5cbiAgICAgKiBAaGlkZWNvbnN0cnVjdG9yXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoYXBwKSB7XG4gICAgICAgIHRoaXMuX2FwcCA9IGFwcDtcbiAgICAgICAgdGhpcy5fc2NyaXB0cyA9IHsgfTtcbiAgICAgICAgdGhpcy5fY2FjaGUgPSB7IH07XG4gICAgfVxuXG4gICAgbG9hZCh1cmwsIGNhbGxiYWNrKSB7XG4gICAgICAgIC8vIFNjcmlwdHMgZG9uJ3Qgc3VwcG9ydCBidW5kbGluZyBzaW5jZSB3ZSBjb25jYXRlbmF0ZSB0aGVtLiBCZWxvdyBpcyBmb3IgY29uc2lzdGVuY3kuXG4gICAgICAgIGlmICh0eXBlb2YgdXJsID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgdXJsID0ge1xuICAgICAgICAgICAgICAgIGxvYWQ6IHVybCxcbiAgICAgICAgICAgICAgICBvcmlnaW5hbDogdXJsXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gICAgICAgIHNjcmlwdC5hcHAgPSB0aGlzLl9hcHA7XG5cbiAgICAgICAgdGhpcy5fbG9hZFNjcmlwdCh1cmwubG9hZCwgKGVyciwgdXJsLCBleHRyYSkgPT4ge1xuICAgICAgICAgICAgaWYgKCFlcnIpIHtcbiAgICAgICAgICAgICAgICBpZiAoc2NyaXB0LmxlZ2FjeSkge1xuICAgICAgICAgICAgICAgICAgICBsZXQgVHlwZSA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIC8vIHBvcCB0aGUgdHlwZSBmcm9tIHRoZSBsb2FkaW5nIHN0YWNrXG4gICAgICAgICAgICAgICAgICAgIGlmIChTY3JpcHRUeXBlcy5fdHlwZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBUeXBlID0gU2NyaXB0VHlwZXMuX3R5cGVzLnBvcCgpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKFR5cGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHN0b3JlIGluZGV4ZWQgYnkgVVJMXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9zY3JpcHRzW3VybF0gPSBUeXBlO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgVHlwZSA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAvLyByZXR1cm4gdGhlIHJlc291cmNlXG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIFR5cGUsIGV4dHJhKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBvYmogPSB7IH07XG5cbiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBTY3JpcHRUeXBlcy5fdHlwZXMubGVuZ3RoOyBpKyspXG4gICAgICAgICAgICAgICAgICAgICAgICBvYmpbU2NyaXB0VHlwZXMuX3R5cGVzW2ldLm5hbWVdID0gU2NyaXB0VHlwZXMuX3R5cGVzW2ldO1xuXG4gICAgICAgICAgICAgICAgICAgIFNjcmlwdFR5cGVzLl90eXBlcy5sZW5ndGggPSAwO1xuXG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIG9iaiwgZXh0cmEpO1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIG5vIGNhY2hlIGZvciBzY3JpcHRzXG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBzZWxmLl9sb2FkZXIuX2NhY2hlW3VybCArICdzY3JpcHQnXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVycik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIG9wZW4odXJsLCBkYXRhKSB7XG4gICAgICAgIHJldHVybiBkYXRhO1xuICAgIH1cblxuICAgIHBhdGNoKGFzc2V0LCBhc3NldHMpIHsgfVxuXG4gICAgX2xvYWRTY3JpcHQodXJsLCBjYWxsYmFjaykge1xuICAgICAgICBjb25zdCBoZWFkID0gZG9jdW1lbnQuaGVhZDtcbiAgICAgICAgY29uc3QgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpO1xuICAgICAgICB0aGlzLl9jYWNoZVt1cmxdID0gZWxlbWVudDtcblxuICAgICAgICAvLyB1c2UgYXN5bmM9ZmFsc2UgdG8gZm9yY2Ugc2NyaXB0cyB0byBleGVjdXRlIGluIG9yZGVyXG4gICAgICAgIGVsZW1lbnQuYXN5bmMgPSBmYWxzZTtcblxuICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2Vycm9yJywgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgIGNhbGxiYWNrKGBTY3JpcHQ6ICR7ZS50YXJnZXQuc3JjfSBmYWlsZWQgdG8gbG9hZGApO1xuICAgICAgICB9LCBmYWxzZSk7XG5cbiAgICAgICAgbGV0IGRvbmUgPSBmYWxzZTtcbiAgICAgICAgZWxlbWVudC5vbmxvYWQgPSBlbGVtZW50Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmICghZG9uZSAmJiAoIXRoaXMucmVhZHlTdGF0ZSB8fCAodGhpcy5yZWFkeVN0YXRlID09PSAnbG9hZGVkJyB8fCB0aGlzLnJlYWR5U3RhdGUgPT09ICdjb21wbGV0ZScpKSkge1xuICAgICAgICAgICAgICAgIGRvbmUgPSB0cnVlOyAvLyBwcmV2ZW50IGRvdWJsZSBldmVudCBmaXJpbmdcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhudWxsLCB1cmwsIGVsZW1lbnQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICAvLyBzZXQgdGhlIHNyYyBhdHRyaWJ1dGUgYWZ0ZXIgdGhlIG9ubG9hZCBjYWxsYmFjayBpcyBzZXQsIHRvIGF2b2lkIGFuIGluc3RhbnQgbG9hZGluZyBmYWlsaW5nIHRvIGZpcmUgdGhlIGNhbGxiYWNrXG4gICAgICAgIGVsZW1lbnQuc3JjID0gdXJsO1xuXG4gICAgICAgIGhlYWQuYXBwZW5kQ2hpbGQoZWxlbWVudCk7XG4gICAgfVxufVxuXG5leHBvcnQgeyBTY3JpcHRIYW5kbGVyIH07XG4iXSwibmFtZXMiOlsiU2NyaXB0SGFuZGxlciIsImNvbnN0cnVjdG9yIiwiYXBwIiwiaGFuZGxlclR5cGUiLCJfYXBwIiwiX3NjcmlwdHMiLCJfY2FjaGUiLCJsb2FkIiwidXJsIiwiY2FsbGJhY2siLCJvcmlnaW5hbCIsInNlbGYiLCJzY3JpcHQiLCJfbG9hZFNjcmlwdCIsImVyciIsImV4dHJhIiwibGVnYWN5IiwiVHlwZSIsIlNjcmlwdFR5cGVzIiwiX3R5cGVzIiwibGVuZ3RoIiwicG9wIiwib2JqIiwiaSIsIm5hbWUiLCJfbG9hZGVyIiwib3BlbiIsImRhdGEiLCJwYXRjaCIsImFzc2V0IiwiYXNzZXRzIiwiaGVhZCIsImRvY3VtZW50IiwiZWxlbWVudCIsImNyZWF0ZUVsZW1lbnQiLCJhc3luYyIsImFkZEV2ZW50TGlzdGVuZXIiLCJlIiwidGFyZ2V0Iiwic3JjIiwiZG9uZSIsIm9ubG9hZCIsIm9ucmVhZHlzdGF0ZWNoYW5nZSIsInJlYWR5U3RhdGUiLCJhcHBlbmRDaGlsZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFHQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1BQU1BLGFBQWEsQ0FBQztBQUNoQjtBQUNKO0FBQ0E7QUFDQTtBQUNBOztBQUdJO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7QUFDQTtFQUNJQyxXQUFXLENBQUNDLEdBQUcsRUFBRTtJQUFBLElBUmpCQyxDQUFBQSxXQUFXLEdBQUcsUUFBUSxDQUFBO0lBU2xCLElBQUksQ0FBQ0MsSUFBSSxHQUFHRixHQUFHLENBQUE7QUFDZixJQUFBLElBQUksQ0FBQ0csUUFBUSxHQUFHLEVBQUcsQ0FBQTtBQUNuQixJQUFBLElBQUksQ0FBQ0MsTUFBTSxHQUFHLEVBQUcsQ0FBQTtBQUNyQixHQUFBO0FBRUFDLEVBQUFBLElBQUksQ0FBQ0MsR0FBRyxFQUFFQyxRQUFRLEVBQUU7QUFDaEI7QUFDQSxJQUFBLElBQUksT0FBT0QsR0FBRyxLQUFLLFFBQVEsRUFBRTtBQUN6QkEsTUFBQUEsR0FBRyxHQUFHO0FBQ0ZELFFBQUFBLElBQUksRUFBRUMsR0FBRztBQUNURSxRQUFBQSxRQUFRLEVBQUVGLEdBQUFBO09BQ2IsQ0FBQTtBQUNMLEtBQUE7SUFFQSxNQUFNRyxJQUFJLEdBQUcsSUFBSSxDQUFBO0FBQ2pCQyxJQUFBQSxNQUFNLENBQUNWLEdBQUcsR0FBRyxJQUFJLENBQUNFLElBQUksQ0FBQTtBQUV0QixJQUFBLElBQUksQ0FBQ1MsV0FBVyxDQUFDTCxHQUFHLENBQUNELElBQUksRUFBRSxDQUFDTyxHQUFHLEVBQUVOLEdBQUcsRUFBRU8sS0FBSyxLQUFLO01BQzVDLElBQUksQ0FBQ0QsR0FBRyxFQUFFO1FBQ04sSUFBSUYsTUFBTSxDQUFDSSxNQUFNLEVBQUU7VUFDZixJQUFJQyxJQUFJLEdBQUcsSUFBSSxDQUFBO0FBQ2Y7QUFDQSxVQUFBLElBQUlDLFdBQVcsQ0FBQ0MsTUFBTSxDQUFDQyxNQUFNLEVBQUU7QUFDM0JILFlBQUFBLElBQUksR0FBR0MsV0FBVyxDQUFDQyxNQUFNLENBQUNFLEdBQUcsRUFBRSxDQUFBO0FBQ25DLFdBQUE7QUFFQSxVQUFBLElBQUlKLElBQUksRUFBRTtBQUNOO0FBQ0EsWUFBQSxJQUFJLENBQUNaLFFBQVEsQ0FBQ0csR0FBRyxDQUFDLEdBQUdTLElBQUksQ0FBQTtBQUM3QixXQUFDLE1BQU07QUFDSEEsWUFBQUEsSUFBSSxHQUFHLElBQUksQ0FBQTtBQUNmLFdBQUE7O0FBRUE7QUFDQVIsVUFBQUEsUUFBUSxDQUFDLElBQUksRUFBRVEsSUFBSSxFQUFFRixLQUFLLENBQUMsQ0FBQTtBQUMvQixTQUFDLE1BQU07VUFDSCxNQUFNTyxHQUFHLEdBQUcsRUFBRyxDQUFBO0FBRWYsVUFBQSxLQUFLLElBQUlDLENBQUMsR0FBRyxDQUFDLEVBQUVBLENBQUMsR0FBR0wsV0FBVyxDQUFDQyxNQUFNLENBQUNDLE1BQU0sRUFBRUcsQ0FBQyxFQUFFLEVBQzlDRCxHQUFHLENBQUNKLFdBQVcsQ0FBQ0MsTUFBTSxDQUFDSSxDQUFDLENBQUMsQ0FBQ0MsSUFBSSxDQUFDLEdBQUdOLFdBQVcsQ0FBQ0MsTUFBTSxDQUFDSSxDQUFDLENBQUMsQ0FBQTtBQUUzREwsVUFBQUEsV0FBVyxDQUFDQyxNQUFNLENBQUNDLE1BQU0sR0FBRyxDQUFDLENBQUE7QUFFN0JYLFVBQUFBLFFBQVEsQ0FBQyxJQUFJLEVBQUVhLEdBQUcsRUFBRVAsS0FBSyxDQUFDLENBQUE7O0FBRTFCO1VBQ0EsT0FBT0osSUFBSSxDQUFDYyxPQUFPLENBQUNuQixNQUFNLENBQUNFLEdBQUcsR0FBRyxRQUFRLENBQUMsQ0FBQTtBQUM5QyxTQUFBO0FBQ0osT0FBQyxNQUFNO1FBQ0hDLFFBQVEsQ0FBQ0ssR0FBRyxDQUFDLENBQUE7QUFDakIsT0FBQTtBQUNKLEtBQUMsQ0FBQyxDQUFBO0FBQ04sR0FBQTtBQUVBWSxFQUFBQSxJQUFJLENBQUNsQixHQUFHLEVBQUVtQixJQUFJLEVBQUU7QUFDWixJQUFBLE9BQU9BLElBQUksQ0FBQTtBQUNmLEdBQUE7QUFFQUMsRUFBQUEsS0FBSyxDQUFDQyxLQUFLLEVBQUVDLE1BQU0sRUFBRSxFQUFFO0FBRXZCakIsRUFBQUEsV0FBVyxDQUFDTCxHQUFHLEVBQUVDLFFBQVEsRUFBRTtBQUN2QixJQUFBLE1BQU1zQixJQUFJLEdBQUdDLFFBQVEsQ0FBQ0QsSUFBSSxDQUFBO0FBQzFCLElBQUEsTUFBTUUsT0FBTyxHQUFHRCxRQUFRLENBQUNFLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQTtBQUNoRCxJQUFBLElBQUksQ0FBQzVCLE1BQU0sQ0FBQ0UsR0FBRyxDQUFDLEdBQUd5QixPQUFPLENBQUE7O0FBRTFCO0lBQ0FBLE9BQU8sQ0FBQ0UsS0FBSyxHQUFHLEtBQUssQ0FBQTtBQUVyQkYsSUFBQUEsT0FBTyxDQUFDRyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsVUFBVUMsQ0FBQyxFQUFFO01BQzNDNUIsUUFBUSxDQUFFLFdBQVU0QixDQUFDLENBQUNDLE1BQU0sQ0FBQ0MsR0FBSSxpQkFBZ0IsQ0FBQyxDQUFBO0tBQ3JELEVBQUUsS0FBSyxDQUFDLENBQUE7SUFFVCxJQUFJQyxJQUFJLEdBQUcsS0FBSyxDQUFBO0FBQ2hCUCxJQUFBQSxPQUFPLENBQUNRLE1BQU0sR0FBR1IsT0FBTyxDQUFDUyxrQkFBa0IsR0FBRyxZQUFZO01BQ3RELElBQUksQ0FBQ0YsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDRyxVQUFVLElBQUssSUFBSSxDQUFDQSxVQUFVLEtBQUssUUFBUSxJQUFJLElBQUksQ0FBQ0EsVUFBVSxLQUFLLFVBQVcsQ0FBQyxFQUFFO1FBQ2pHSCxJQUFJLEdBQUcsSUFBSSxDQUFDO0FBQ1ovQixRQUFBQSxRQUFRLENBQUMsSUFBSSxFQUFFRCxHQUFHLEVBQUV5QixPQUFPLENBQUMsQ0FBQTtBQUNoQyxPQUFBO0tBQ0gsQ0FBQTtBQUNEO0lBQ0FBLE9BQU8sQ0FBQ00sR0FBRyxHQUFHL0IsR0FBRyxDQUFBO0FBRWpCdUIsSUFBQUEsSUFBSSxDQUFDYSxXQUFXLENBQUNYLE9BQU8sQ0FBQyxDQUFBO0FBQzdCLEdBQUE7QUFDSjs7OzsifQ==
