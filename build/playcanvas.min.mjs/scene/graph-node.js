import{EventHandler as t}from"../core/event-handler.js";import{Tags as i}from"../core/tags.js";import"../core/tracing.js";import{Mat3 as e}from"../core/math/mat3.js";import{Mat4 as r}from"../core/math/mat4.js";import{Quat as s}from"../core/math/quat.js";import{Vec3 as o}from"../core/math/vec3.js";const n=new r,l=new o,a=new s,h=new s,c=new o,d=new o,_=new r,f=new s,p=new o,y=new r,g=new s,u=new s,m=new r,w=new o,T=new o,L=new o,R=new o,W=new o;class S extends t{constructor(t="Untitled"){super(),this.name=t,this.tags=new i(this),this._labels={},this.localPosition=new o,this.localRotation=new s,this.localScale=new o(1,1,1),this.localEulerAngles=new o,this.position=new o,this.rotation=new s,this.eulerAngles=new o,this._scale=null,this.localTransform=new r,this._dirtyLocal=!1,this._wasDirty=!1,this._aabbVer=0,this._frozen=!1,this.worldTransform=new r,this._dirtyWorld=!1,this._negativeScaleWorld=0,this._normalMatrix=new e,this._dirtyNormal=!0,this._right=null,this._up=null,this._forward=null,this._parent=null,this._children=[],this._graphDepth=0,this._enabled=!0,this._enabledInHierarchy=!1,this.scaleCompensation=!1}get right(){return this._right||(this._right=new o),this.getWorldTransform().getX(this._right).normalize()}get up(){return this._up||(this._up=new o),this.getWorldTransform().getY(this._up).normalize()}get forward(){return this._forward||(this._forward=new o),this.getWorldTransform().getZ(this._forward).normalize().mulScalar(-1)}get normalMatrix(){const t=this._normalMatrix;return this._dirtyNormal&&(this.getWorldTransform().invertTo3x3(t),t.transpose(),this._dirtyNormal=!1),t}set enabled(t){var i;this._enabled!==t&&(this._enabled=t,(t&&null!=(i=this._parent)&&i.enabled||!t)&&this._notifyHierarchyStateChanged(this,t))}get enabled(){return this._enabled&&this._enabledInHierarchy}get parent(){return this._parent}get path(){let t=this._parent;if(!t)return"";let i=this.name;for(;t&&t._parent;)i=`${t.name}/${i}`,t=t._parent;return i}get root(){let t=this;for(;t._parent;)t=t._parent;return t}get children(){return this._children}get graphDepth(){return this._graphDepth}_notifyHierarchyStateChanged(t,i){t._onHierarchyStateChanged(i);const e=t._children;for(let t=0,r=e.length;t<r;t++)e[t]._enabled&&this._notifyHierarchyStateChanged(e[t],i)}_onHierarchyStateChanged(t){this._enabledInHierarchy=t,t&&!this._frozen&&this._unfreezeParentToRoot()}_cloneInternal(t){t.name=this.name;const i=this.tags._list;t.tags.clear();for(let e=0;e<i.length;e++)t.tags.add(i[e]);t._labels=Object.assign({},this._labels),t.localPosition.copy(this.localPosition),t.localRotation.copy(this.localRotation),t.localScale.copy(this.localScale),t.localEulerAngles.copy(this.localEulerAngles),t.position.copy(this.position),t.rotation.copy(this.rotation),t.eulerAngles.copy(this.eulerAngles),t.localTransform.copy(this.localTransform),t._dirtyLocal=this._dirtyLocal,t.worldTransform.copy(this.worldTransform),t._dirtyWorld=this._dirtyWorld,t._dirtyNormal=this._dirtyNormal,t._aabbVer=this._aabbVer+1,t._enabled=this._enabled,t.scaleCompensation=this.scaleCompensation,t._enabledInHierarchy=!1}clone(){const t=new this.constructor;return this._cloneInternal(t),t}copy(t){return t._cloneInternal(this),this}find(t,i){let e,r=[];const s=this._children.length;if(t instanceof Function){const i=t;e=i(this),e&&r.push(this);for(let t=0;t<s;t++){const e=this._children[t].find(i);e.length&&(r=r.concat(e))}}else{let e;this[t]&&(e=this[t]instanceof Function?this[t]():this[t],e===i&&r.push(this));for(let e=0;e<s;++e){const s=this._children[e].find(t,i);s.length&&(r=r.concat(s))}}return r}findOne(t,i){const e=this._children.length;let r=null;if(t instanceof Function){const i=t;if(r=i(this),r)return this;for(let t=0;t<e;t++)if(r=this._children[t].findOne(i),r)return r}else{let s;if(this[t]&&(s=this[t]instanceof Function?this[t]():this[t],s===i))return this;for(let s=0;s<e;s++)if(r=this._children[s].findOne(t,i),null!==r)return r}return null}findByTag(){const t=arguments,i=[],e=(r,s)=>{s&&r.tags.has(...t)&&i.push(r);for(let t=0;t<r._children.length;t++)e(r._children[t],!0)};return e(this,!1),i}findByName(t){if(this.name===t)return this;for(let i=0;i<this._children.length;i++){const e=this._children[i].findByName(t);if(null!==e)return e}return null}findByPath(t){const i=Array.isArray(t)?t:t.split("/");let e=this;for(let t=0,r=i.length;t<r;++t)if(e=e.children.find((e=>e.name===i[t])),!e)return null;return e}forEach(t,i){t.call(i,this);const e=this._children;for(let r=0;r<e.length;r++)e[r].forEach(t,i)}isDescendantOf(t){let i=this._parent;for(;i;){if(i===t)return!0;i=i._parent}return!1}isAncestorOf(t){return t.isDescendantOf(this)}getEulerAngles(){return this.getWorldTransform().getEulerAngles(this.eulerAngles),this.eulerAngles}getLocalEulerAngles(){return this.localRotation.getEulerAngles(this.localEulerAngles),this.localEulerAngles}getLocalPosition(){return this.localPosition}getLocalRotation(){return this.localRotation}getLocalScale(){return this.localScale}getLocalTransform(){return this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this.localTransform}getPosition(){return this.getWorldTransform().getTranslation(this.position),this.position}getRotation(){return this.rotation.setFromMat4(this.getWorldTransform()),this.rotation}getScale(){return this._scale||(this._scale=new o),this.getWorldTransform().getScale(this._scale)}getWorldTransform(){return this._dirtyLocal||this._dirtyWorld?(this._parent&&this._parent.getWorldTransform(),this._sync(),this.worldTransform):this.worldTransform}get negativeScaleWorld(){if(0===this._negativeScaleWorld){const t=this.getWorldTransform();t.getX(L),t.getY(R),t.getZ(W),L.cross(L,R),this._negativeScaleWorld=L.dot(W)<0?-1:1}return this._negativeScaleWorld}reparent(t,i){const e=this._parent;e&&e.removeChild(this),t&&(i>=0?t.insertChild(this,i):t.addChild(this))}setLocalEulerAngles(t,i,e){this.localRotation.setFromEulerAngles(t,i,e),this._dirtyLocal||this._dirtifyLocal()}setLocalPosition(t,i,e){t instanceof o?this.localPosition.copy(t):this.localPosition.set(t,i,e),this._dirtyLocal||this._dirtifyLocal()}setLocalRotation(t,i,e,r){t instanceof s?this.localRotation.copy(t):this.localRotation.set(t,i,e,r),this._dirtyLocal||this._dirtifyLocal()}setLocalScale(t,i,e){t instanceof o?this.localScale.copy(t):this.localScale.set(t,i,e),this._dirtyLocal||this._dirtifyLocal()}_dirtifyLocal(){this._dirtyLocal||(this._dirtyLocal=!0,this._wasDirty=!0,this._dirtyWorld||this._dirtifyWorld())}_unfreezeParentToRoot(){let t=this._parent;for(;t;)t._frozen=!1,t=t._parent}_dirtifyWorld(){this._dirtyWorld||this._unfreezeParentToRoot(),this._dirtifyWorldInternal()}_dirtifyWorldInternal(){if(!this._dirtyWorld){this._frozen=!1,this._dirtyWorld=!0;for(let t=0;t<this._children.length;t++)this._children[t]._dirtyWorld||this._children[t]._dirtifyWorldInternal()}this._dirtyNormal=!0,this._negativeScaleWorld=0,this._aabbVer++}setPosition(t,i,e){t instanceof o?p.copy(t):p.set(t,i,e),null===this._parent?this.localPosition.copy(p):(y.copy(this._parent.getWorldTransform()).invert(),y.transformPoint(p,this.localPosition)),this._dirtyLocal||this._dirtifyLocal()}setRotation(t,i,e,r){if(t instanceof s?g.copy(t):g.set(t,i,e,r),null===this._parent)this.localRotation.copy(g);else{const t=this._parent.getRotation();u.copy(t).invert(),this.localRotation.copy(u).mul(g)}this._dirtyLocal||this._dirtifyLocal()}setEulerAngles(t,i,e){if(this.localRotation.setFromEulerAngles(t,i,e),null!==this._parent){const t=this._parent.getRotation();u.copy(t).invert(),this.localRotation.mul2(u,this.localRotation)}this._dirtyLocal||this._dirtifyLocal()}addChild(t){this._prepareInsertChild(t),this._children.push(t),this._onInsertChild(t)}addChildAndSaveTransform(t){const i=t.getPosition(),e=t.getRotation();this._prepareInsertChild(t),t.setPosition(_.copy(this.worldTransform).invert().transformPoint(i)),t.setRotation(f.copy(this.getRotation()).invert().mul(e)),this._children.push(t),this._onInsertChild(t)}insertChild(t,i){this._prepareInsertChild(t),this._children.splice(i,0,t),this._onInsertChild(t)}_prepareInsertChild(t){t._parent&&t._parent.removeChild(t)}_fireOnHierarchy(t,i,e){this.fire(t,e);for(let t=0;t<this._children.length;t++)this._children[t]._fireOnHierarchy(i,i,e)}_onInsertChild(t){t._parent=this;const i=t._enabled&&this.enabled;t._enabledInHierarchy!==i&&(t._enabledInHierarchy=i,t._notifyHierarchyStateChanged(t,i)),t._updateGraphDepth(),t._dirtifyWorld(),this._frozen&&t._unfreezeParentToRoot(),t._fireOnHierarchy("insert","inserthierarchy",this),this.fire&&this.fire("childinsert",t)}_updateGraphDepth(){this._graphDepth=this._parent?this._parent._graphDepth+1:0;for(let t=0,i=this._children.length;t<i;t++)this._children[t]._updateGraphDepth()}removeChild(t){const i=this._children.indexOf(t);-1!==i&&(this._children.splice(i,1),t._parent=null,t._fireOnHierarchy("remove","removehierarchy",this),this.fire("childremove",t))}_sync(){if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){let t;const i=this._parent;let e=this.localScale,r=i;if(r){for(;r&&r.scaleCompensation;)r=r._parent;r&&(r=r._parent,r&&(t=r.worldTransform.getScale(),c.mul2(t,this.localScale),e=c))}h.setFromMat4(i.worldTransform),a.mul2(h,this.localRotation);let s=i.worldTransform;i.scaleCompensation&&(d.mul2(t,i.getLocalScale()),n.setTRS(i.worldTransform.getTranslation(l),h,d),s=n),s.transformPoint(this.localPosition,l),this.worldTransform.setTRS(l,a,e)}else this.worldTransform.mulAffine2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=!1}}syncHierarchy(){if(!this._enabled)return;if(this._frozen)return;this._frozen=!0,(this._dirtyLocal||this._dirtyWorld)&&this._sync();const t=this._children;for(let i=0,e=t.length;i<e;i++)t[i].syncHierarchy()}lookAt(t,i,e,r=0,s=1,n=0){if(t instanceof o)w.copy(t),i instanceof o?T.copy(i):T.copy(o.UP);else{if(void 0===e)return;w.set(t,i,e),T.set(r,s,n)}m.setLookAt(this.getPosition(),w,T),g.setFromMat4(m),this.setRotation(g)}translate(t,i,e){t instanceof o?p.copy(t):p.set(t,i,e),p.add(this.getPosition()),this.setPosition(p)}translateLocal(t,i,e){t instanceof o?p.copy(t):p.set(t,i,e),this.localRotation.transformVector(p,p),this.localPosition.add(p),this._dirtyLocal||this._dirtifyLocal()}rotate(t,i,e){if(g.setFromEulerAngles(t,i,e),null===this._parent)this.localRotation.mul2(g,this.localRotation);else{const t=this.getRotation(),i=this._parent.getRotation();u.copy(i).invert(),g.mul2(u,g),this.localRotation.mul2(g,t)}this._dirtyLocal||this._dirtifyLocal()}rotateLocal(t,i,e){g.setFromEulerAngles(t,i,e),this.localRotation.mul(g),this._dirtyLocal||this._dirtifyLocal()}}export{S as GraphNode};
