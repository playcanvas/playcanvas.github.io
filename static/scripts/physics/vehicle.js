var Vehicle=pc.createScript("vehicle");Vehicle.attributes.add("wheels",{type:"entity",array:!0,title:"Wheels"}),Vehicle.attributes.add("maxEngineForce",{type:"number",default:2e3,title:"Max Engine Force"}),Vehicle.attributes.add("maxBrakingForce",{type:"number",default:100,title:"Max Braking Force"}),Vehicle.attributes.add("maxSteering",{type:"number",default:.3,title:"Max Steering"}),Object.defineProperty(Vehicle.prototype,"speed",{get:function(){return this.vehicle?this.vehicle.getCurrentSpeedKmHour():0}}),Vehicle.prototype.initialize=function(){var e=this.entity.rigidbody.body,t=this.app.systems.rigidbody.dynamicsWorld,i=new Ammo.btVehicleTuning,s=new Ammo.btDefaultVehicleRaycaster(t),n=new Ammo.btRaycastVehicle(i,e,s);n.setCoordinateSystem(0,1,2),e.setActivationState(4);var r=new Ammo.btVector3(-1,0,0),o=new Ammo.btVector3(0,-1,0),h=new Ammo.btVector3(0,0,0);this.wheels.forEach((function(e){var t=e.script.vehicleWheel,s=t.frictionSlip,a=t.isFront,l=t.radius,d=t.rollInfluence,c=t.suspensionCompression,u=t.suspensionDamping,p=t.suspensionRestLength,b=t.suspensionStiffness,y=e.getLocalPosition();h.setValue(y.x,y.y,y.z);var f=n.addWheel(h,o,r,p,l,i,a);f.set_m_suspensionStiffness(b),f.set_m_wheelsDampingRelaxation(u),f.set_m_wheelsDampingCompression(c),f.set_m_frictionSlip(s),f.set_m_rollInfluence(d)}),this),Ammo.destroy(r),Ammo.destroy(o),Ammo.destroy(h),t.addAction(n),this.vehicle=n,this.engineForce=0,this.brakingForce=0,this.steering=0,this.on("enable",(function(){t.addAction(n)})),this.on("disable",(function(){t.removeAction(n)})),this.on("destroy",(function(){t.removeAction(n),Ammo.destroy(s),Ammo.destroy(n)})),this.on("vehicle:controls",(function(e,t){this.steering=pc.math.lerp(this.steering,e*this.maxSteering,.3),t>0?(this.brakingForce=0,this.engineForce=this.maxEngineForce):t<0?(this.brakingForce=0,this.engineForce=-this.maxEngineForce):(this.brakingForce=this.maxBrakingForce,this.engineForce=0)}))},Vehicle.prototype.update=function(e){var t,i=this.vehicle;this.entity.rigidbody.body.setActivationState(4),i.setSteeringValue(this.steering,0),i.setSteeringValue(this.steering,1),i.applyEngineForce(this.engineForce,2),i.setBrake(this.brakingForce,2),i.applyEngineForce(this.engineForce,3),i.setBrake(this.brakingForce,3);var s=i.getNumWheels();for(t=0;t<s;t++){i.updateWheelTransform(t,!0);var n=this.vehicle.getWheelTransformWS(t),r=n.getOrigin(),o=n.getRotation(),h=this.wheels[t];h.setPosition(r.x(),r.y(),r.z()),h.setRotation(o.x(),o.y(),o.z(),o.w())}};var VehicleWheel=pc.createScript("vehicleWheel");VehicleWheel.attributes.add("isFront",{type:"boolean",default:!0,title:"Front Wheel"}),VehicleWheel.attributes.add("radius",{type:"number",default:.4,title:"Radius"}),VehicleWheel.attributes.add("width",{type:"number",default:.4,title:"Width"}),VehicleWheel.attributes.add("suspensionStiffness",{type:"number",default:10,title:"Suspension Stiffness"}),VehicleWheel.attributes.add("suspensionDamping",{type:"number",default:2.3,title:"Suspension Damping"}),VehicleWheel.attributes.add("suspensionCompression",{type:"number",default:4.4,title:"Suspension Compression"}),VehicleWheel.attributes.add("suspensionRestLength",{type:"number",default:.4,title:"Suspension Rest Length"}),VehicleWheel.attributes.add("rollInfluence",{type:"number",default:.2,title:"Roll Influence"}),VehicleWheel.attributes.add("frictionSlip",{type:"number",default:1e3,title:"Friction Slip"}),VehicleWheel.attributes.add("debugRender",{type:"boolean",default:!1,title:"Debug Render"}),VehicleWheel.prototype.initialize=function(){var e=function(e,t){var i=new pc.Entity;return i.addComponent("model",{type:"cylinder",castShadows:!0}),i.setLocalEulerAngles(0,0,90),i.setLocalScale(2*e,t,2*e),i};this.debugRender&&(this.debugWheel=e(this.radius,this.width),this.entity.addChild(this.debugWheel)),this.on("attr:debugRender",(function(t,i){t?(this.debugWheel=e(this.radius,this.width),this.entity.addChild(this.debugWheel)):this.debugWheel&&(this.debugWheel.destroy(),this.debugWheel=null)}))};var VehicleControls=pc.createScript("vehicleControls");VehicleControls.attributes.add("targetVehicle",{type:"entity",title:"Target Vehicle"}),VehicleControls.attributes.add("leftButton",{type:"entity",title:"Left Button"}),VehicleControls.attributes.add("rightButton",{type:"entity",title:"Right Button"}),VehicleControls.attributes.add("forwardButton",{type:"entity",title:"Forward Button"}),VehicleControls.attributes.add("reverseButton",{type:"entity",title:"Reverse Button"}),VehicleControls.prototype.initialize=function(){this.leftButtonPressed=!1,this.rightButtonPressed=!1,this.upButtonPressed=!1,this.downButtonPressed=!1,this.leftKeyPressed=!1,this.rightKeyPressed=!1,this.upKeyPressed=!1,this.downKeyPressed=!1,this.leftButton&&(this.leftButton.enabled=pc.platform.mobile,this.leftButton.button.on("pressedstart",(function(){this.leftButtonPressed=!0}),this),this.leftButton.button.on("pressedend",(function(){this.leftButtonPressed=!1}),this)),this.rightButton&&(this.rightButton.enabled=pc.platform.mobile,this.rightButton.button.on("pressedstart",(function(){this.rightButtonPressed=!0}),this),this.rightButton.button.on("pressedend",(function(){this.rightButtonPressed=!1}),this)),this.forwardButton&&(this.forwardButton.enabled=pc.platform.mobile,this.forwardButton.button.on("pressedstart",(function(){this.upButtonPressed=!0}),this),this.forwardButton.button.on("pressedend",(function(){this.upButtonPressed=!1}),this)),this.reverseButton&&(this.reverseButton.enabled=pc.platform.mobile,this.reverseButton.button.on("pressedstart",(function(){this.downButtonPressed=!0}),this),this.reverseButton.button.on("pressedend",(function(){this.downButtonPressed=!1}),this)),this.app.keyboard.on("keydown",(function(e){switch(e.key){case pc.KEY_A:case pc.KEY_LEFT:this.leftKeyPressed=!0;break;case pc.KEY_D:case pc.KEY_RIGHT:this.rightKeyPressed=!0;break;case pc.KEY_W:case pc.KEY_UP:this.upKeyPressed=!0;break;case pc.KEY_S:case pc.KEY_DOWN:this.downKeyPressed=!0}}),this),this.app.keyboard.on("keyup",(function(e){switch(e.key){case pc.KEY_A:case pc.KEY_LEFT:this.leftKeyPressed=!1;break;case pc.KEY_D:case pc.KEY_RIGHT:this.rightKeyPressed=!1;break;case pc.KEY_W:case pc.KEY_UP:this.upKeyPressed=!1;break;case pc.KEY_S:case pc.KEY_DOWN:this.downKeyPressed=!1}}),this)},VehicleControls.prototype.update=function(e){var t=this.targetVehicle?this.targetVehicle:this.entity;if(t){var i=0,s=0;(this.leftButtonPressed||this.leftKeyPressed)&&i++,(this.rightButtonPressed||this.rightKeyPressed)&&i--,(this.upButtonPressed||this.upKeyPressed)&&s++,(this.downButtonPressed||this.downKeyPressed)&&s--,t.script.vehicle.fire("vehicle:controls",i,s)}};