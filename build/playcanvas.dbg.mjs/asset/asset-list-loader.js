/**
 * @license
 * PlayCanvas Engine v1.58.0-dev revision e102f2b2a (DEBUG PROFILER)
 * Copyright 2011-2022 PlayCanvas Ltd. All rights reserved.
 */
import { EventHandler } from '../core/event-handler.js';
import { Asset } from './asset.js';

class AssetListLoader extends EventHandler {
  constructor(assetList, assetRegistry) {
    super();
    this._assets = new Set();
    this._loadingAssets = new Set();
    this._waitingAssets = new Set();
    this._registry = assetRegistry;
    this._loading = false;
    this._loaded = false;
    this._failed = [];
    assetList.forEach(a => {
      if (a instanceof Asset) {
        if (!a.registry) {
          a.registry = assetRegistry;
        }

        this._assets.add(a);
      } else {
        const asset = assetRegistry.get(a);

        if (asset) {
          this._assets.add(asset);
        } else {
          this._waitForAsset(a);
        }
      }
    });
  }

  destroy() {
    const self = this;

    this._registry.off("load", this._onLoad);

    this._registry.off("error", this._onError);

    this._waitingAssets.forEach(function (id) {
      self._registry.off("add:" + id, this._onAddAsset);
    });

    this.off("progress");
    this.off("load");
  }

  _assetHasDependencies(asset) {
    var _asset$file;

    return asset.type === 'model' && ((_asset$file = asset.file) == null ? void 0 : _asset$file.url) && asset.file.url && asset.file.url.match(/.json$/g);
  }

  load(done, scope) {
    if (this._loading) {
      console.debug("AssetListLoader: Load function called multiple times.");
      return;
    }

    this._loading = true;
    this._callback = done;
    this._scope = scope;

    this._registry.on("load", this._onLoad, this);

    this._registry.on("error", this._onError, this);

    let loadingAssets = false;

    this._assets.forEach(asset => {
      if (!asset.loaded) {
        loadingAssets = true;

        if (this._assetHasDependencies(asset)) {
          this._registry.loadFromUrl(asset.file.url, asset.type, (err, loadedAsset) => {
            if (err) {
              this._onError(err, asset);

              return;
            }

            this._onLoad(asset);
          });
        }

        this._loadingAssets.add(asset);

        this._registry.add(asset);
      }
    });

    this._loadingAssets.forEach(asset => {
      if (!this._assetHasDependencies(asset)) {
        this._registry.load(asset);
      }
    });

    if (!loadingAssets && this._waitingAssets.size === 0) {
      this._loadingComplete();
    }
  }

  ready(done, scope = this) {
    if (this._loaded) {
      done.call(scope, Array.from(this._assets));
    } else {
      this.once("load", function (assets) {
        done.call(scope, assets);
      });
    }
  }

  _loadingComplete() {
    if (this._loaded) return;
    this._loaded = true;

    this._registry.off("load", this._onLoad, this);

    this._registry.off("error", this._onError, this);

    if (this._failed.length) {
      if (this._callback) {
        this._callback.call(this._scope, "Failed to load some assets", this._failed);
      }

      this.fire("error", this._failed);
    } else {
      if (this._callback) {
        this._callback.call(this._scope);
      }

      this.fire("load", Array.from(this._assets));
    }
  }

  _onLoad(asset) {
    if (this._loadingAssets.has(asset)) {
      this.fire("progress", asset);

      this._loadingAssets.delete(asset);
    }

    if (this._loadingAssets.size === 0) {
      setTimeout(() => {
        this._loadingComplete(this._failed);
      }, 0);
    }
  }

  _onError(err, asset) {
    if (this._loadingAssets.has(asset)) {
      this._failed.push(asset);

      this._loadingAssets.delete(asset);
    }

    if (this._loadingAssets.size === 0) {
      setTimeout(() => {
        this._loadingComplete(this._failed);
      }, 0);
    }
  }

  _onAddAsset(asset) {
    this._waitingAssets.delete(asset);

    this._assets.add(asset);

    if (!asset.loaded) {
      this._loadingAssets.add(asset);

      this._registry.load(asset);
    }
  }

  _waitForAsset(assetId) {
    this._waitingAssets.add(assetId);

    this._registry.once('add:' + assetId, this._onAddAsset, this);
  }

}

export { AssetListLoader };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXQtbGlzdC1sb2FkZXIuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hc3NldC9hc3NldC1saXN0LWxvYWRlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudEhhbmRsZXIgfSBmcm9tICcuLi9jb3JlL2V2ZW50LWhhbmRsZXIuanMnO1xuXG5pbXBvcnQgeyBBc3NldCB9IGZyb20gJy4vYXNzZXQuanMnO1xuXG4vKipcbiAqIFVzZWQgdG8gbG9hZCBhIGdyb3VwIG9mIGFzc2V0cyBhbmQgZmlyZXMgYSBjYWxsYmFjayB3aGVuIGFsbCBhc3NldHMgYXJlIGxvYWRlZC5cbiAqXG4gKiBAYXVnbWVudHMgRXZlbnRIYW5kbGVyXG4gKiBAZXhhbXBsZVxuICogIGNvbnN0IGFzc2V0cyA9IFtcbiAqICAgICAgbmV3IEFzc2V0KCdtb2RlbCcsICdjb250YWluZXInLCB7IHVybDogYGh0dHA6Ly9leGFtcGxlLmNvbS9hc3NldC5nbGJgIH0pLFxuICogICAgICBuZXcgQXNzZXQoJ3N0eWxpbmcnLCAnY3NzJywgeyB1cmw6IGBodHRwOi8vZXhhbXBsZS5jb20vYXNzZXQuY3NzYCB9KVxuICogIF07XG4gKiAgY29uc3QgYXNzZXRMaXN0TG9hZGVyID0gbmV3IEFzc2V0TGlzdExvYWRlcihhc3NldHMsIGFwcC5hc3NldHMpO1xuICogIGFzc2V0TGlzdExvYWRlci5sb2FkKChlcnIsIGZhaWxlZCkgPT4ge1xuICogICAgICBpZiAoZXJyKSB7XG4gKiAgICAgICAgICBjb25zb2xlLmVycm9yKGAke2ZhaWxlZC5sZW5ndGh9IGFzc2V0cyBmYWlsZWQgdG8gbG9hZGApO1xuICogICAgICB9IGVsc2Uge1xuICogICAgICAgICAgY29uc29sZS5sb2coYCR7YXNzZXRzLmxlbmd0aH0gYXNzZXRzIGxvYWRlZGApO1xuICogICAgIH1cbiAqICB9KTtcbiAqL1xuY2xhc3MgQXNzZXRMaXN0TG9hZGVyIGV4dGVuZHMgRXZlbnRIYW5kbGVyIHtcbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBuZXcgQXNzZXRMaXN0TG9hZGVyIHVzaW5nIGEgbGlzdCBvZiBhc3NldHMgdG8gbG9hZCBhbmQgdGhlIGFzc2V0IHJlZ2lzdHJ5IHVzZWQgdG8gbG9hZCBhbmQgbWFuYWdlIHRoZW0uXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge0Fzc2V0W118bnVtYmVyW119IGFzc2V0TGlzdCAtIEFuIGFycmF5IG9mIHtAbGluayBBc3NldH0gb2JqZWN0cyB0byBsb2FkIG9yIGFuIGFycmF5IG9mIEFzc2V0IElEcyB0byBsb2FkLlxuICAgICAqIEBwYXJhbSB7QXNzZXRSZWdpc3RyeX0gYXNzZXRSZWdpc3RyeSAtIFRoZSBhcHBsaWNhdGlvbidzIGFzc2V0IHJlZ2lzdHJ5LlxuICAgICAqIEBleGFtcGxlXG4gICAgICogY29uc3QgYXNzZXRMaXN0TG9hZGVyID0gbmV3IHBjLkFzc2V0TGlzdExvYWRlcihbXG4gICAgICogICAgIG5ldyBwYy5Bc3NldChcInRleHR1cmUxXCIsIFwidGV4dHVyZVwiLCB7IHVybDogJ2h0dHA6Ly9leGFtcGxlLmNvbS9teS9hc3NldHMvaGVyZS90ZXh0dXJlMS5wbmcnKSB9KSxcbiAgICAgKiAgICAgbmV3IHBjLkFzc2V0KFwidGV4dHVyZTJcIiwgXCJ0ZXh0dXJlXCIsIHsgdXJsOiAnaHR0cDovL2V4YW1wbGUuY29tL215L2Fzc2V0cy9oZXJlL3RleHR1cmUyLnBuZycpIH0pXG4gICAgICogXSwgcGMuYXBwLmFzc2V0cyk7XG4gICAgICovXG4gICAgY29uc3RydWN0b3IoYXNzZXRMaXN0LCBhc3NldFJlZ2lzdHJ5KSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMuX2Fzc2V0cyA9IG5ldyBTZXQoKTtcbiAgICAgICAgdGhpcy5fbG9hZGluZ0Fzc2V0cyA9IG5ldyBTZXQoKTtcbiAgICAgICAgdGhpcy5fd2FpdGluZ0Fzc2V0cyA9IG5ldyBTZXQoKTtcbiAgICAgICAgdGhpcy5fcmVnaXN0cnkgPSBhc3NldFJlZ2lzdHJ5O1xuICAgICAgICB0aGlzLl9sb2FkaW5nID0gZmFsc2U7XG4gICAgICAgIHRoaXMuX2xvYWRlZCA9IGZhbHNlO1xuICAgICAgICB0aGlzLl9mYWlsZWQgPSBbXTsgLy8gbGlzdCBvZiBhc3NldHMgdGhhdCBmYWlsZWQgdG8gbG9hZFxuXG4gICAgICAgIGFzc2V0TGlzdC5mb3JFYWNoKChhKSA9PiB7XG4gICAgICAgICAgICBpZiAoYSBpbnN0YW5jZW9mIEFzc2V0KSB7XG4gICAgICAgICAgICAgICAgaWYgKCFhLnJlZ2lzdHJ5KSB7XG4gICAgICAgICAgICAgICAgICAgIGEucmVnaXN0cnkgPSBhc3NldFJlZ2lzdHJ5O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLl9hc3NldHMuYWRkKGEpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBhc3NldCA9IGFzc2V0UmVnaXN0cnkuZ2V0KGEpO1xuICAgICAgICAgICAgICAgIGlmIChhc3NldCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9hc3NldHMuYWRkKGFzc2V0KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl93YWl0Rm9yQXNzZXQoYSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZW1vdmVzIGFsbCByZWZlcmVuY2VzIHRvIHRoaXMgYXNzZXQgbGlzdCBsb2FkZXIuXG4gICAgICovXG4gICAgZGVzdHJveSgpIHtcbiAgICAgICAgLy8gcmVtb3ZlIGFueSBvdXRzdGFuZGluZyBsaXN0ZW5lcnNcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XG5cbiAgICAgICAgdGhpcy5fcmVnaXN0cnkub2ZmKFwibG9hZFwiLCB0aGlzLl9vbkxvYWQpO1xuICAgICAgICB0aGlzLl9yZWdpc3RyeS5vZmYoXCJlcnJvclwiLCB0aGlzLl9vbkVycm9yKTtcblxuICAgICAgICB0aGlzLl93YWl0aW5nQXNzZXRzLmZvckVhY2goZnVuY3Rpb24gKGlkKSB7XG4gICAgICAgICAgICBzZWxmLl9yZWdpc3RyeS5vZmYoXCJhZGQ6XCIgKyBpZCwgdGhpcy5fb25BZGRBc3NldCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMub2ZmKFwicHJvZ3Jlc3NcIik7XG4gICAgICAgIHRoaXMub2ZmKFwibG9hZFwiKTtcbiAgICB9XG5cbiAgICBfYXNzZXRIYXNEZXBlbmRlbmNpZXMoYXNzZXQpIHtcbiAgICAgICAgcmV0dXJuIChhc3NldC50eXBlID09PSAnbW9kZWwnICYmIGFzc2V0LmZpbGU/LnVybCAmJiBhc3NldC5maWxlLnVybCAmJiBhc3NldC5maWxlLnVybC5tYXRjaCgvLmpzb24kL2cpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdGFydCBsb2FkaW5nIGFzc2V0IGxpc3QsIGNhbGwgZG9uZSgpIHdoZW4gYWxsIGFzc2V0cyBoYXZlIGxvYWRlZCBvciBmYWlsZWQgdG8gbG9hZC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGRvbmUgLSBDYWxsYmFjayBjYWxsZWQgd2hlbiBhbGwgYXNzZXRzIGluIHRoZSBsaXN0IGFyZSBsb2FkZWQuIFBhc3NlZCAoZXJyLCBmYWlsZWQpIHdoZXJlIGVyciBpcyB0aGUgdW5kZWZpbmVkIGlmIG5vIGVycm9ycyBhcmUgZW5jb3VudGVyZWQgYW5kIGZhaWxlZCBjb250YWlucyBhIGxpc3Qgb2YgYXNzZXRzIHRoYXQgZmFpbGVkIHRvIGxvYWQuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtzY29wZV0gLSBTY29wZSB0byB1c2Ugd2hlbiBjYWxsaW5nIGNhbGxiYWNrLlxuICAgICAqL1xuICAgIGxvYWQoZG9uZSwgc2NvcGUpIHtcbiAgICAgICAgaWYgKHRoaXMuX2xvYWRpbmcpIHtcbiAgICAgICAgICAgIC8vICNpZiBfREVCVUdcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoXCJBc3NldExpc3RMb2FkZXI6IExvYWQgZnVuY3Rpb24gY2FsbGVkIG11bHRpcGxlIHRpbWVzLlwiKTtcbiAgICAgICAgICAgIC8vICNlbmRpZlxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2xvYWRpbmcgPSB0cnVlO1xuICAgICAgICB0aGlzLl9jYWxsYmFjayA9IGRvbmU7XG4gICAgICAgIHRoaXMuX3Njb3BlID0gc2NvcGU7XG5cbiAgICAgICAgdGhpcy5fcmVnaXN0cnkub24oXCJsb2FkXCIsIHRoaXMuX29uTG9hZCwgdGhpcyk7XG4gICAgICAgIHRoaXMuX3JlZ2lzdHJ5Lm9uKFwiZXJyb3JcIiwgdGhpcy5fb25FcnJvciwgdGhpcyk7XG5cbiAgICAgICAgbGV0IGxvYWRpbmdBc3NldHMgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5fYXNzZXRzLmZvckVhY2goKGFzc2V0KSA9PiB7XG4gICAgICAgICAgICAvLyBUcmFjayBhc3NldHMgdGhhdCBhcmUgbm90IGxvYWRlZCBvciBhcmUgY3VycmVudGx5IGxvYWRpbmdcbiAgICAgICAgICAgIC8vIGFzIHNvbWUgYXNzZXRzIG1heSBiZSBsb2FkaW5nIGJ5IHRoaXMgY2FsbFxuICAgICAgICAgICAgaWYgKCFhc3NldC5sb2FkZWQpIHtcbiAgICAgICAgICAgICAgICBsb2FkaW5nQXNzZXRzID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAvLyBqc29uIGJhc2VkIG1vZGVscyBzaG91bGQgYmUgbG9hZGVkIHdpdGggdGhlIGxvYWRGcm9tVXJsIGZ1bmN0aW9uIHNvIHRoYXQgdGhlaXIgZGVwZW5kZW5jaWVzIGNhbiBiZSBsb2FkZWQgdG9vLlxuICAgICAgICAgICAgICAgIGlmICh0aGlzLl9hc3NldEhhc0RlcGVuZGVuY2llcyhhc3NldCkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVnaXN0cnkubG9hZEZyb21VcmwoYXNzZXQuZmlsZS51cmwsIGFzc2V0LnR5cGUsIChlcnIsIGxvYWRlZEFzc2V0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fb25FcnJvcihlcnIsIGFzc2V0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9vbkxvYWQoYXNzZXQpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5fbG9hZGluZ0Fzc2V0cy5hZGQoYXNzZXQpO1xuICAgICAgICAgICAgICAgIHRoaXMuX3JlZ2lzdHJ5LmFkZChhc3NldCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLl9sb2FkaW5nQXNzZXRzLmZvckVhY2goKGFzc2V0KSA9PiB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuX2Fzc2V0SGFzRGVwZW5kZW5jaWVzKGFzc2V0KSkge1xuICAgICAgICAgICAgICAgIHRoaXMuX3JlZ2lzdHJ5LmxvYWQoYXNzZXQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKCFsb2FkaW5nQXNzZXRzICYmIHRoaXMuX3dhaXRpbmdBc3NldHMuc2l6ZSA9PT0gMCkge1xuICAgICAgICAgICAgdGhpcy5fbG9hZGluZ0NvbXBsZXRlKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTZXRzIGEgY2FsbGJhY2sgd2hpY2ggd2lsbCBiZSBjYWxsZWQgd2hlbiBhbGwgYXNzZXRzIGluIHRoZSBsaXN0IGhhdmUgYmVlbiBsb2FkZWQuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBkb25lIC0gQ2FsbGJhY2sgY2FsbGVkIHdoZW4gYWxsIGFzc2V0cyBpbiB0aGUgbGlzdCBhcmUgbG9hZGVkLlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbc2NvcGVdIC0gU2NvcGUgdG8gdXNlIHdoZW4gY2FsbGluZyBjYWxsYmFjay5cbiAgICAgKi9cbiAgICByZWFkeShkb25lLCBzY29wZSA9IHRoaXMpIHtcbiAgICAgICAgaWYgKHRoaXMuX2xvYWRlZCkge1xuICAgICAgICAgICAgZG9uZS5jYWxsKHNjb3BlLCBBcnJheS5mcm9tKHRoaXMuX2Fzc2V0cykpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5vbmNlKFwibG9hZFwiLCBmdW5jdGlvbiAoYXNzZXRzKSB7XG4gICAgICAgICAgICAgICAgZG9uZS5jYWxsKHNjb3BlLCBhc3NldHMpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBjYWxsZWQgd2hlbiBhbGwgYXNzZXRzIGFyZSBsb2FkZWRcbiAgICBfbG9hZGluZ0NvbXBsZXRlKCkge1xuICAgICAgICBpZiAodGhpcy5fbG9hZGVkKSByZXR1cm47XG4gICAgICAgIHRoaXMuX2xvYWRlZCA9IHRydWU7XG4gICAgICAgIHRoaXMuX3JlZ2lzdHJ5Lm9mZihcImxvYWRcIiwgdGhpcy5fb25Mb2FkLCB0aGlzKTtcbiAgICAgICAgdGhpcy5fcmVnaXN0cnkub2ZmKFwiZXJyb3JcIiwgdGhpcy5fb25FcnJvciwgdGhpcyk7XG5cbiAgICAgICAgaWYgKHRoaXMuX2ZhaWxlZC5sZW5ndGgpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLl9jYWxsYmFjaykge1xuICAgICAgICAgICAgICAgIHRoaXMuX2NhbGxiYWNrLmNhbGwodGhpcy5fc2NvcGUsIFwiRmFpbGVkIHRvIGxvYWQgc29tZSBhc3NldHNcIiwgdGhpcy5fZmFpbGVkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuZmlyZShcImVycm9yXCIsIHRoaXMuX2ZhaWxlZCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAodGhpcy5fY2FsbGJhY2spIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9jYWxsYmFjay5jYWxsKHRoaXMuX3Njb3BlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuZmlyZShcImxvYWRcIiwgQXJyYXkuZnJvbSh0aGlzLl9hc3NldHMpKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIGNhbGxlZCB3aGVuIGFuIChhbnkpIGFzc2V0IGlzIGxvYWRlZFxuICAgIF9vbkxvYWQoYXNzZXQpIHtcbiAgICAgICAgLy8gY2hlY2sgdGhpcyBpcyBhbiBhc3NldCB3ZSBjYXJlIGFib3V0XG4gICAgICAgIGlmICh0aGlzLl9sb2FkaW5nQXNzZXRzLmhhcyhhc3NldCkpIHtcbiAgICAgICAgICAgIHRoaXMuZmlyZShcInByb2dyZXNzXCIsIGFzc2V0KTtcbiAgICAgICAgICAgIHRoaXMuX2xvYWRpbmdBc3NldHMuZGVsZXRlKGFzc2V0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLl9sb2FkaW5nQXNzZXRzLnNpemUgPT09IDApIHtcbiAgICAgICAgICAgIC8vIGNhbGwgbmV4dCB0aWNrIGJlY2F1c2Ugd2Ugd2FudFxuICAgICAgICAgICAgLy8gdGhpcyB0byBiZSBmaXJlZCBhZnRlciBhbnkgb3RoZXJcbiAgICAgICAgICAgIC8vIGFzc2V0IGxvYWQgZXZlbnRzXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLl9sb2FkaW5nQ29tcGxldGUodGhpcy5fZmFpbGVkKTtcbiAgICAgICAgICAgIH0sIDApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gY2FsbGVkIHdoZW4gYW4gYXNzZXQgZmFpbHMgdG8gbG9hZFxuICAgIF9vbkVycm9yKGVyciwgYXNzZXQpIHtcbiAgICAgICAgLy8gY2hlY2sgdGhpcyBpcyBhbiBhc3NldCB3ZSBjYXJlIGFib3V0XG4gICAgICAgIGlmICh0aGlzLl9sb2FkaW5nQXNzZXRzLmhhcyhhc3NldCkpIHtcbiAgICAgICAgICAgIHRoaXMuX2ZhaWxlZC5wdXNoKGFzc2V0KTtcbiAgICAgICAgICAgIHRoaXMuX2xvYWRpbmdBc3NldHMuZGVsZXRlKGFzc2V0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLl9sb2FkaW5nQXNzZXRzLnNpemUgPT09IDApIHtcbiAgICAgICAgICAgIC8vIGNhbGwgbmV4dCB0aWNrIGJlY2F1c2Ugd2Ugd2FudFxuICAgICAgICAgICAgLy8gdGhpcyB0byBiZSBmaXJlZCBhZnRlciBhbnkgb3RoZXJcbiAgICAgICAgICAgIC8vIGFzc2V0IGxvYWQgZXZlbnRzXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLl9sb2FkaW5nQ29tcGxldGUodGhpcy5fZmFpbGVkKTtcbiAgICAgICAgICAgIH0sIDApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gY2FsbGVkIHdoZW4gYSBleHBlY3RlZCBhc3NldCBpcyBhZGRlZCB0byB0aGUgYXNzZXQgcmVnaXN0cnlcbiAgICBfb25BZGRBc3NldChhc3NldCkge1xuICAgICAgICAvLyByZW1vdmUgZnJvbSB3YWl0aW5nIGxpc3RcbiAgICAgICAgdGhpcy5fd2FpdGluZ0Fzc2V0cy5kZWxldGUoYXNzZXQpO1xuXG4gICAgICAgIHRoaXMuX2Fzc2V0cy5hZGQoYXNzZXQpO1xuICAgICAgICBpZiAoIWFzc2V0LmxvYWRlZCkge1xuICAgICAgICAgICAgdGhpcy5fbG9hZGluZ0Fzc2V0cy5hZGQoYXNzZXQpO1xuICAgICAgICAgICAgdGhpcy5fcmVnaXN0cnkubG9hZChhc3NldCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBfd2FpdEZvckFzc2V0KGFzc2V0SWQpIHtcbiAgICAgICAgdGhpcy5fd2FpdGluZ0Fzc2V0cy5hZGQoYXNzZXRJZCk7XG4gICAgICAgIHRoaXMuX3JlZ2lzdHJ5Lm9uY2UoJ2FkZDonICsgYXNzZXRJZCwgdGhpcy5fb25BZGRBc3NldCwgdGhpcyk7XG4gICAgfVxufVxuXG5leHBvcnQgeyBBc3NldExpc3RMb2FkZXIgfTtcbiJdLCJuYW1lcyI6WyJBc3NldExpc3RMb2FkZXIiLCJFdmVudEhhbmRsZXIiLCJjb25zdHJ1Y3RvciIsImFzc2V0TGlzdCIsImFzc2V0UmVnaXN0cnkiLCJfYXNzZXRzIiwiU2V0IiwiX2xvYWRpbmdBc3NldHMiLCJfd2FpdGluZ0Fzc2V0cyIsIl9yZWdpc3RyeSIsIl9sb2FkaW5nIiwiX2xvYWRlZCIsIl9mYWlsZWQiLCJmb3JFYWNoIiwiYSIsIkFzc2V0IiwicmVnaXN0cnkiLCJhZGQiLCJhc3NldCIsImdldCIsIl93YWl0Rm9yQXNzZXQiLCJkZXN0cm95Iiwic2VsZiIsIm9mZiIsIl9vbkxvYWQiLCJfb25FcnJvciIsImlkIiwiX29uQWRkQXNzZXQiLCJfYXNzZXRIYXNEZXBlbmRlbmNpZXMiLCJ0eXBlIiwiZmlsZSIsInVybCIsIm1hdGNoIiwibG9hZCIsImRvbmUiLCJzY29wZSIsImNvbnNvbGUiLCJkZWJ1ZyIsIl9jYWxsYmFjayIsIl9zY29wZSIsIm9uIiwibG9hZGluZ0Fzc2V0cyIsImxvYWRlZCIsImxvYWRGcm9tVXJsIiwiZXJyIiwibG9hZGVkQXNzZXQiLCJzaXplIiwiX2xvYWRpbmdDb21wbGV0ZSIsInJlYWR5IiwiY2FsbCIsIkFycmF5IiwiZnJvbSIsIm9uY2UiLCJhc3NldHMiLCJsZW5ndGgiLCJmaXJlIiwiaGFzIiwiZGVsZXRlIiwic2V0VGltZW91dCIsInB1c2giLCJhc3NldElkIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQXNCQSxNQUFNQSxlQUFOLFNBQThCQyxZQUE5QixDQUEyQztBQVl2Q0MsRUFBQUEsV0FBVyxDQUFDQyxTQUFELEVBQVlDLGFBQVosRUFBMkI7QUFDbEMsSUFBQSxLQUFBLEVBQUEsQ0FBQTtBQUNBLElBQUEsSUFBQSxDQUFLQyxPQUFMLEdBQWUsSUFBSUMsR0FBSixFQUFmLENBQUE7QUFDQSxJQUFBLElBQUEsQ0FBS0MsY0FBTCxHQUFzQixJQUFJRCxHQUFKLEVBQXRCLENBQUE7QUFDQSxJQUFBLElBQUEsQ0FBS0UsY0FBTCxHQUFzQixJQUFJRixHQUFKLEVBQXRCLENBQUE7SUFDQSxJQUFLRyxDQUFBQSxTQUFMLEdBQWlCTCxh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
