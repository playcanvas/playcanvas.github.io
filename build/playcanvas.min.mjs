/**
 * @license
 * PlayCanvas Engine v1.56.0 revision 50ffa14a7
 * Copyright 2011-2022 PlayCanvas Ltd. All rights reserved.
 */
function e(e,t,s){e.prototype[t]||Object.defineProperty(e.prototype,t,{value:s,configurable:!0,enumerable:!1,writable:!0})}e(Array,"fill",(function(e){if(null==this)throw new TypeError("this is null or not defined");for(var t=Object(this),s=t.length>>>0,i=arguments[1],n=i>>0,a=n<0?Math.max(s+n,0):Math.min(n,s),r=arguments[2],o=void 0===r?s:r>>0,h=o<0?Math.max(s+o,0):Math.min(o,s);a<h;)t[a]=e,a++;return t})),e(Array,"find",(function(e){if(null==this)throw TypeError('"this" is null or not defined');var t=Object(this),s=t.length>>>0;if("function"!=typeof e)throw TypeError("predicate must be a function");for(var i=arguments[1],n=0;n<s;){var a=t[n];if(e.call(i,a,n,t))return a;n++}})),e(Array,"findIndex",(function(e){if(null==this)throw new TypeError('"this" is null or not defined');var t=Object(this),s=t.length>>>0;if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var i=arguments[1],n=0;n<s;){var a=t[n];if(e.call(i,a,n,t))return n;n++}return-1})),Math.log2=Math.log2||function(e){return Math.log(e)*Math.LOG2E},Math.sign||(Math.sign=function(e){return(e>0)-(e<0)||+e}),void 0===Number.isFinite&&(Number.isFinite=function(e){return"number"==typeof e&&isFinite(e)}),"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(e,t){if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var s=Object(e),i=1;i<arguments.length;i++){var n=arguments[i];if(null!=n)for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(s[a]=n[a])}return s},writable:!0,configurable:!0}),Object.values=Object.values||function(e){return Object.keys(e).map((t=>e[t]))},function(){if("undefined"!=typeof navigator&&"undefined"!=typeof document){navigator.pointer=navigator.pointer||navigator.webkitPointer||navigator.mozPointer;var e=function(){var e=document.createEvent("CustomEvent");e.initCustomEvent("pointerlockchange",!0,!1,null),document.dispatchEvent(e)},t=function(){var e=document.createEvent("CustomEvent");e.initCustomEvent("pointerlockerror",!0,!1,null),document.dispatchEvent(e)};document.addEventListener("webkitpointerlockchange",e,!1),document.addEventListener("webkitpointerlocklost",e,!1),document.addEventListener("mozpointerlockchange",e,!1),document.addEventListener("mozpointerlocklost",e,!1),document.addEventListener("webkitpointerlockerror",t,!1),document.addEventListener("mozpointerlockerror",t,!1),Element.prototype.mozRequestPointerLock?Element.prototype.requestPointerLock=function(){this.mozRequestPointerLock()}:Element.prototype.requestPointerLock=Element.prototype.requestPointerLock||Element.prototype.webkitRequestPointerLock||Element.prototype.mozRequestPointerLock,!Element.prototype.requestPointerLock&&navigator.pointer&&(Element.prototype.requestPointerLock=function(){document.pointerLockElement=this,navigator.pointer.lock(this,e,t)}),document.exitPointerLock=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock,document.exitPointerLock||(document.exitPointerLock=function(){navigator.pointer&&(document.pointerLockElement=null,navigator.pointer.unlock())})}}(),function(){if("undefined"!=typeof window){for(var e=0,t=["ms","moz","webkit","o"],s=0;s<t.length&&!window.requestAnimationFrame;++s)window.requestAnimationFrame=window[t[s]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[s]+"CancelAnimationFrame"]||window[t[s]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t,s){var i=(new Date).getTime(),n=Math.max(0,16-(i-e)),a=window.setTimeout((function(){t(i+n)}),n);return e=i+n,a}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}}(),e(String,"endsWith",(function(e,t){return(void 0===t||t>this.length)&&(t=this.length),this.substring(t-e.length,t)===e})),e(String,"includes",(function(e,t){return"number"!=typeof t&&(t=0),!(t+e.length>this.length)&&-1!==this.indexOf(e,t)})),e(String,"startsWith",(function(e,t){var s=t>0?0|t:0;return this.substring(s,s+e.length)===e})),e(String,"trimEnd",(function(){return this.replace(new RegExp(/[\x09\x0A\x0B\x0C\x0D\x20\xA0\u1680\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200A\u202F\u205F\u3000\u2028\u2029\uFEFF]+/.source+"$","g"),"")}));const t=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array];for(const s of t)e(s,"fill",Array.prototype.fill),e(s,"join",Array.prototype.join);var s={};function i(e,t){var i;s[e]=!0,void 0!==t&&(i=t,window.console&&window.console.error&&window.console.error(i))}var n=function e(t){var s=t.gl;this.ext=t,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(t.maxVertexAttribs);for(var i=0;i<this.attribs.length;i++){var n=new e.VertexAttrib(s);this.attribs[i]=n}this.maxAttrib=0};(n.VertexAttrib=function(e){this.enabled=!1,this.buffer=null,this.size=4,this.type=e.FLOAT,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()}).prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var a=function(e){var t=this;this.gl=e,function(e){var t=e.getError;e.getError=function(){do{(i=t.apply(e))!=e.NO_ERROR&&(s[i]=!0)}while(i!=e.NO_ERROR);for(var i in s)if(s[i])return delete s[i],parseInt(i);return e.NO_ERROR}}(e);var i=this.original={getParameter:e.getParameter,enableVertexAttribArray:e.enableVertexAttribArray,disableVertexAttribArray:e.disableVertexAttribArray,bindBuffer:e.bindBuffer,getVertexAttrib:e.getVertexAttrib,vertexAttribPointer:e.vertexAttribPointer};e.getParameter=function(e){return e==t.VERTEX_ARRAY_BINDING_OES?t.currentVertexArrayObject==t.defaultVertexArrayObject?null:t.currentVertexArrayObject:i.getParameter.apply(this,arguments)},e.enableVertexAttribArray=function(e){var s=t.currentVertexArrayObject;s.maxAttrib=Math.max(s.maxAttrib,e);var n=s.attribs[e];return n.enabled=!0,i.enableVertexAttribArray.apply(this,arguments)},e.disableVertexAttribArray=function(e){var s=t.currentVertexArrayObject;s.maxAttrib=Math.max(s.maxAttrib,e);var n=s.attribs[e];return n.enabled=!1,i.disableVertexAttribArray.apply(this,arguments)},e.bindBuffer=function(s,n){switch(s){case e.ARRAY_BUFFER:t.currentArrayBuffer=n;break;case e.ELEMENT_ARRAY_BUFFER:t.currentVertexArrayObject.elementArrayBuffer=n}return i.bindBuffer.apply(this,arguments)},e.getVertexAttrib=function(s,n){var a=t.currentVertexArrayObject,r=a.attribs[s];switch(n){case e.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:return r.buffer;case e.VERTEX_ATTRIB_ARRAY_ENABLED:return r.enabled;case e.VERTEX_ATTRIB_ARRAY_SIZE:return r.size;case e.VERTEX_ATTRIB_ARRAY_STRIDE:return r.stride;case e.VERTEX_ATTRIB_ARRAY_TYPE:return r.type;case e.VERTEX_ATTRIB_ARRAY_NORMALIZED:return r.normalized;default:return i.getVertexAttrib.apply(this,arguments)}},e.vertexAttribPointer=function(e,s,n,a,r,o){var h=t.currentVertexArrayObject;h.maxAttrib=Math.max(h.maxAttrib,e);var l=h.attribs[e];return l.buffer=t.currentArrayBuffer,l.size=s,l.type=n,l.normalized=a,l.stride=r,l.offset=o,l.recache(),i.vertexAttribPointer.apply(this,arguments)},e.instrumentExtension&&e.instrumentExtension(this,"OES_vertex_array_object"),e.canvas.addEventListener("webglcontextrestored",(function(){var e;e="OESVertexArrayObject emulation library context restored",window.console&&window.console.log&&window.console.log(e),t.reset_()}),!0),this.reset_()};a.prototype.VERTEX_ARRAY_BINDING_OES=34229,a.prototype.reset_=function(){if(void 0!==this.vertexArrayObjects)for(var e=0;e<this.vertexArrayObjects.length;++e)this.vertexArrayObjects.isAlive=!1;var t=this.gl;this.maxVertexAttribs=t.getParameter(t.MAX_VERTEX_ATTRIBS),this.defaultVertexArrayObject=new n(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)},a.prototype.createVertexArrayOES=function(){var e=new n(this);return this.vertexArrayObjects.push(e),e},a.prototype.deleteVertexArrayOES=function(e){e.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(e),1),this.currentVertexArrayObject==e&&this.bindVertexArrayOES(null)},a.prototype.isVertexArrayOES=function(e){return!!(e&&e instanceof n&&e.hasBeenBound&&e.ext==this)},a.prototype.bindVertexArrayOES=function(e){var t=this.gl;if(!e||e.isAlive){var s=this.original,n=this.currentVertexArrayObject;this.currentVertexArrayObject=e||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;var a=this.currentVertexArrayObject;if(n!=a){n&&a.elementArrayBuffer==n.elementArrayBuffer||s.bindBuffer.call(t,t.ELEMENT_ARRAY_BUFFER,a.elementArrayBuffer);for(var r=this.currentArrayBuffer,o=Math.max(n?n.maxAttrib:0,a.maxAttrib),h=0;h<=o;h++){var l=a.attribs[h],c=n?n.attribs[h]:null;if(n&&l.enabled==c.enabled||(l.enabled?s.enableVertexAttribArray.call(t,h):s.disableVertexAttribArray.call(t,h)),l.enabled){var d=!1;n&&l.buffer==c.buffer||(r!=l.buffer&&(s.bindBuffer.call(t,t.ARRAY_BUFFER,l.buffer),r=l.buffer),d=!0),(d||l.cached!=c.cached)&&s.vertexAttribPointer.call(t,h,l.size,l.type,l.normalized,l.stride,l.offset)}}this.currentArrayBuffer!=r&&s.bindBuffer.call(t,t.ARRAY_BUFFER,this.currentArrayBuffer)}}else i(t.INVALID_OPERATION,"bindVertexArrayOES: attempt to bind deleted arrayObject")};const r="RenderFrame",o="RenderPass",h="RenderPassDetail",l="RenderAction",c="RenderTargetAlloc",d="TextureAlloc",u="ShaderAlloc",p="VRAM.Texture",m="VRAM.Vb",f="VRAM.Ib",_="1.56.0",g="50ffa14a7",y={},v={},x={},b={},S=function(){const e={},t=["Array","Object","Function","Date","RegExp","Float32Array"];for(let s=0;s<t.length;s++)e["[object "+t[s]+"]"]=t[s].toLowerCase();return e}();function w(e){if(null===e)return"null";const t=typeof e;return"undefined"===t||"number"===t||"string"===t||"boolean"===t?t:S[Object.prototype.toString.call(e)]}function T(e,t){for(const s in t){const i=t[s];"object"===w(i)?e[s]=T({},i):"array"===w(i)?e[s]=T([],i):e[s]=i}return e}function M(e){return undefined!==e}class C{constructor(){this._callbacks={},this._callbackActive={}}initEventHandler(){this._callbacks={},this._callbackActive={}}_addCallback(e,t,s,i=!1){e&&"string"==typeof e&&t&&(this._callbacks[e]||(this._callbacks[e]=[]),this._callbackActive[e]&&this._callbackActive[e]===this._callbacks[e]&&(this._callbackActive[e]=this._callbackActive[e].slice()),this._callbacks[e].push({callback:t,scope:s||this,once:i}))}on(e,t,s){return this._addCallback(e,t,s,!1),this}off(e,t,s){if(e)this._callbackActive[e]&&this._callbackActive[e]===this._callbacks[e]&&(this._callbackActive[e]=this._callbackActive[e].slice());else for(const e in this._callbackActive)this._callbacks[e]&&this._callbacks[e]===this._callbackActive[e]&&(this._callbackActive[e]=this._callbackActive[e].slice());if(e)if(t){const i=this._callbacks[e];if(!i)return this;let n=i.length;for(let e=0;e<n;e++)i[e].callback===t&&(s&&i[e].scope!==s||(i[e--]=i[--n]));i.length=n}else this._callbacks[e]&&(this._callbacks[e]=[]);else this._callbacks={};return this}fire(e,t,s,i,n,a,r,o,h){if(!e||!this._callbacks[e])return this;let l;this._callbackActive[e]?(this._callbackActive[e]===this._callbacks[e]&&(this._callbackActive[e]=this._callbackActive[e].slice()),l=this._callbacks[e].slice()):this._callbackActive[e]=this._callbacks[e];for(let c=0;(l||this._callbackActive[e])&&c<(l||this._callbackActive[e]).length;c++){const d=(l||this._callbackActive[e])[c];if(d.callback.call(d.scope,t,s,i,n,a,r,o,h),d.once){const t=this._callbacks[e],s=t?t.indexOf(d):-1;-1!==s&&(this._callbackActive[e]===t&&(this._callbackActive[e]=this._callbackActive[e].slice()),this._callbacks[e].splice(s,1))}}return l||(this._callbackActive[e]=null),this}once(e,t,s){return this._addCallback(e,t,s,!0),this}hasEvent(e){return this._callbacks[e]&&0!==this._callbacks[e].length||!1}}const A={attach:function(e){const t=A;return e._addCallback=t._addCallback,e.on=t.on,e.off=t.off,e.fire=t.fire,e.once=t.once,e.hasEvent=t.hasEvent,e._callbacks={},e._callbackActive={},e},_addCallback:C.prototype._addCallback,on:C.prototype.on,off:C.prototype.off,fire:C.prototype.fire,once:C.prototype.once,hasEvent:C.prototype.hasEvent},P={create:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}},E={delimiter:"/",join:function(){const e=arguments.length;let t=arguments[0];for(let s=0;s<e-1;++s){const e=arguments[s],i=arguments[s+1];if(!M(e)||!M(i))throw new Error("undefined argument to pc.path.join");i[0]!==E.delimiter?e&&i&&e[e.length-1]!==E.delimiter&&i[0]!==E.delimiter?t+=E.delimiter+i:t+=i:t=i}return t},normalize:function(e){const t=e.startsWith(E.delimiter),s=e.endsWith(E.delimiter),i=e.split("/");let n="",a=[];for(let e=0;e<i.length;e++)""!==i[e]&&"."!==i[e]&&(".."===i[e]&&a.length>0?a=a.slice(0,a.length-2):(e>0&&a.push(E.delimiter),a.push(i[e])));return n=a.join(""),t||n[0]!==E.delimiter||(n=n.slice(1)),s&&n[n.length-1]!==E.delimiter&&(n+=E.delimiter),n},split:function(e){const t=e.split(E.delimiter),s=t.slice(t.length-1)[0];return[t.slice(0,t.length-1).join(E.delimiter),s]},getBasename:function(e){return E.split(e)[1]},getDirectory:function(e){const t=e.split(E.delimiter);return t.slice(0,t.length-1).join(E.delimiter)},getExtension:function(e){const t=e.split("?")[0].split(".").pop();return t!==e?"."+t:""},isRelativePath:function(e){return"/"!==e.charAt(0)&&null===e.match(/:\/\//)},extractPath:function(e){let t="";const s=e.split("/");let i=0;if(s.length>1)if(E.isRelativePath(e))if("."===s[0])for(i=0;i<s.length-1;++i)t+=0===i?s[i]:"/"+s[i];else if(".."===s[0])for(i=0;i<s.length-1;++i)t+=0===i?s[i]:"/"+s[i];else for(t=".",i=0;i<s.length-1;++i)t+="/"+s[i];else for(i=0;i<s.length-1;++i)t+=0===i?s[i]:"/"+s[i];return t}};let R=!1,L=!1,I=!1,D=!1,O=!1,F=!1,k=!1,B=!1,z=!1,U=!1;if("undefined"!=typeof navigator){const e=navigator.userAgent;/(windows|mac os|linux|cros)/i.test(e)&&(R=!0),/xbox/i.test(e)&&(D=!0),/(windows phone|iemobile|wpdesktop)/i.test(e)?(R=!1,L=!0,I=!0):/android/i.test(e)?(R=!1,L=!0,O=!0):/ip([ao]d|hone)/i.test(e)&&(R=!1,L=!0,F=!0),"undefined"!=typeof window&&(k="ontouchstart"in window||"maxTouchPoints"in navigator&&navigator.maxTouchPoints>0),B="getGamepads"in navigator,z="undefined"!=typeof Worker;try{const e=Object.defineProperty({},"passive",{get:function(){return U=!0,!1}});window.addEventListener("testpassive",null,e),window.removeEventListener("testpassive",null,e)}catch(e){}}const V="undefined"!=typeof window?"browser":"node",N={environment:V,global:"browser"===V?window:global,browser:"browser"===V,desktop:R,mobile:L,ios:F,android:O,windows:I,xbox:D,gamepads:B,touch:k,workers:z,passiveEvents:U};function G(e,t=0){const s=e.length;if(t<0||t>=s)return null;const i=e.charCodeAt(t);if(s>1&&i>=55296&&i<=56319){const s=e.charCodeAt(t+1);if(s>=56320&&s<=57343)return{code:1024*(i-55296)+s-56320+65536,long:!0}}return{code:i,long:!1}}function W(e,t,s){if(!e)return!1;const i=G(e);if(i){const e=i.code;return e>=t&&e<=s}return!1}function H(e,t){if(t===e.length-1)return 1;if(W(e[t],55296,56319)){const s=e.substring(t,t+2),i=e.substring(t+2,t+4);return W(i,127995,127999)||W(s,127462,127487)&&W(i,127462,127487)?4:W(i,65024,65039)?3:2}return W(e[t+1],65024,65039)?2:1}const X={ASCII_LOWERCASE:"abcdefghijklmnopqrstuvwxyz",ASCII_UPPERCASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZ",ASCII_LETTERS:"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",format:function(e){for(let t=1;t<arguments.length;t++)e=e.replace("{"+(t-1)+"}",arguments[t]);return e},toBool:function(e,t=!1){if("true"===e)return!0;if(t){if("false"===e)return!1;throw new TypeError("Not a boolean string")}return!1},getCodePoint:function(e,t){const s=G(e,t);return s&&s.code},getCodePoints:function(e){if("string"!=typeof e)throw new TypeError("Not a string");let t=0;const s=[];let i;for(;i=G(e,t);)s.push(i.code),t+=i.long?2:1;return s},getSymbols:function(e){if("string"!=typeof e)throw new TypeError("Not a string");let t=0;const s=e.length,i=[];let n,a=0;for(;t<s;){if(a+=H(e,t+a),n=e[t+a],W(n,8400,8447)&&(n=e[t+a++]),W(n,65024,65039)&&(n=e[t+a++]),n&&8205===n.charCodeAt(0)){n=e[t+a++];continue}const s=e.substring(t,t+a);i.push(s),t+=a,a=0}return i},fromCodePoint:function(){const e=[];let t,s,i;for(let n=0;n<arguments.length;++n)t=Number(arguments[n]),s=t-65536,i=t>65535?[55296+(s>>10),s%1024+56320]:[t],e.push(String.fromCharCode.apply(null,i));return e.join("")}};class q{constructor(){this._list=[],this._index={}}push(e,t){if(this._index[e])throw Error("Key already in index "+e);const s=this._list.push(t)-1;this._index[e]=s}has(e){return void 0!==this._index[e]}get(e){const t=this._index[e];return void 0!==t?this._list[t]:null}remove(e){const t=this._index[e];if(void 0!==t){for(e in this._list.splice(t,1),delete this._index[e],this._index){const s=this._index[e];s>t&&(this._index[e]=s-1)}return!0}return!1}list(){return this._list}clear(){this._list.length=0;for(const e in this._index)delete this._index[e]}}class j{static loadScript(e,t){const s=document.createElement("script");s.setAttribute("src",e),s.onload=()=>{t(null)},s.onerror=()=>{t(`Failed to load script='${e}'`)},document.body.appendChild(s)}static loadWasm(e,t,s){const i=j.wasmSupported()&&t.glueUrl&&t.wasmUrl?t.glueUrl:t.fallbackUrl;i?j.loadScript(i,(i=>{if(i)s(i,null);else{const i=window[e];window[e]=void 0,i({locateFile:()=>t.wasmUrl,onAbort:()=>{s("wasm module aborted.")}}).then((e=>{s(null,e)}))}})):s("No supported wasm modules found.",null)}static getModule(e){return j.modules.hasOwnProperty(e)||(j.modules[e]={config:null,initializing:!1,instance:null,callbacks:[]}),j.modules[e]}static initialize(e,t){if(t.initializing)return;const s=t.config;(s.glueUrl||s.wasmUrl||s.fallbackUrl)&&(t.initializing=!0,j.loadWasm(e,s,((i,n)=>{i?s.errorHandler?s.errorHandler(i):console.error(`failed to initialize module=${e} error=${i}`):(t.instance=n,t.callbacks.forEach((e=>{e(n)})))})))}}j.modules={},j.wasmSupported=(e=>{const t={};let s=t;return()=>(s===t&&(s=e()),s)})((()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){}return!1}));class Y{static setConfig(e,t){const s=j.getModule(e);s.config=t,s.callbacks.length>0&&j.initialize(e,s)}static getInstance(e,t){const s=j.getModule(e);s.instance?t(s.instance):(s.callbacks.push(t),s.config&&j.initialize(e,s))}}class ${constructor(e){this.arraybuffer=e,this.dataView=new DataView(e),this.offset=0,this.stack=[]}get remainingBytes(){return this.dataView.byteLength-this.offset}reset(e=0){this.offset=e}skip(e){this.offset+=e}align(e){this.offset=this.offset+e-1&~(e-1)}_inc(e){return this.offset+=e,this.offset-e}readChar(){return String.fromCharCode(this.dataView.getUint8(this.offset++))}readChars(e){let t="";for(let s=0;s<e;++s)t+=this.readChar();return t}readU8(){return this.dataView.getUint8(this.offset++)}readU16(){return this.dataView.getUint16(this._inc(2),!0)}readU32(){return this.dataView.getUint32(this._inc(4),!0)}readU64(){return this.readU32()+2**32*this.readU32()}readU32be(){return this.dataView.getUint32(this._inc(4),!1)}readArray(e){for(let t=0;t<e.length;++t)e[t]=this.readU8()}readLine(){const e=this.dataView;let t="";for(;!(this.offset>=e.byteLength);){const e=String.fromCharCode(this.readU8());if("\n"===e)break;t+=e}return t}}class K{constructor(e){this.items=[],this.length=0,this.loopIndex=-1,this._sortBy=e.sortBy,this._sortHandler=this._doSort.bind(this)}_binarySearch(e){let t=0,s=this.items.length-1;const i=e[this._sortBy];let n,a;for(;t<=s;)n=Math.floor((t+s)/2),a=this.items[n][this._sortBy],a<=i?t=n+1:a>i&&(s=n-1);return t}_doSort(e,t){const s=this._sortBy;return e[s]-t[s]}insert(e){const t=this._binarySearch(e);this.items.splice(t,0,e),this.length++,this.loopIndex>=t&&this.loopIndex++}append(e){this.items.push(e),this.length++}remove(e){const t=this.items.indexOf(e);t<0||(this.items.splice(t,1),this.length--,this.loopIndex>=t&&this.loopIndex--)}sort(){const e=this.loopIndex>=0?this.items[this.loopIndex]:null;this.items.sort(this._sortHandler),null!==e&&(this.loopIndex=this.items.indexOf(e))}}class Z extends C{constructor(e){super(),this._index={},this._list=[],this._parent=e}add(){let e=!1;const t=this._processArguments(arguments,!0);if(!t.length)return e;for(let s=0;s<t.length;s++)this._index[t[s]]||(e=!0,this._index[t[s]]=!0,this._list.push(t[s]),this.fire("add",t[s],this._parent));return e&&this.fire("change",this._parent),e}remove(){let e=!1;if(!this._list.length)return e;const t=this._processArguments(arguments,!0);if(!t.length)return e;for(let s=0;s<t.length;s++)this._index[t[s]]&&(e=!0,delete this._index[t[s]],this._list.splice(this._list.indexOf(t[s]),1),this.fire("remove",t[s],this._parent));return e&&this.fire("change",this._parent),e}clear(){if(!this._list.length)return;const e=this._list.slice(0);this._list=[],this._index={};for(let t=0;t<e.length;t++)this.fire("remove",e[t],this._parent);this.fire("change",this._parent)}has(){return!!this._list.length&&this._has(this._processArguments(arguments))}_has(e){if(!this._list.length||!e.length)return!1;for(let t=0;t<e.length;t++)if(1===e[t].length){if(this._index[e[t][0]])return!0}else{let s=!0;for(let i=0;i<e[t].length;i++)if(!this._index[e[t][i]]){s=!1;break}if(s)return!0}return!1}list(){return this._list.slice(0)}_processArguments(e,t){const s=[];let i=[];if(!e||!e.length)return s;for(let n=0;n<e.length;n++)if(e[n]instanceof Array){t||(i=[]);for(let a=0;a<e[n].length;a++)"string"==typeof e[n][a]&&(t?s.push(e[n][a]):i.push(e[n][a]));!t&&i.length&&s.push(i)}else"string"==typeof e[n]&&(t?s.push(e[n]):s.push([e[n]]));return s}get size(){return this._list.length}}const Q="undefined"!=typeof window&&window.performance&&window.performance.now&&window.performance.timing?performance.now.bind(performance):Date.now;class J{constructor(){this._isRunning=!1,this._a=0,this._b=0}start(){this._isRunning=!0,this._a=Q()}stop(){this._isRunning=!1,this._b=Q()}getMilliseconds(){return this._b-this._a}}function ee(e){let t="";if((e.authority||e.scheme)&&(e.host||e.hostpath))throw new Error("Can't have 'scheme' or 'authority' and 'host' or 'hostpath' option");if(e.host&&e.hostpath)throw new Error("Can't have 'host' and 'hostpath' option");if(e.path&&e.hostpath)throw new Error("Can't have 'path' and 'hostpath' option");return e.scheme&&(t+=e.scheme+":"),e.authority&&(t+="//"+e.authority),e.host&&(t+=e.host),e.path&&(t+=e.path),e.hostpath&&(t+=e.hostpath),e.query&&(t+="?"+e.query),e.fragment&&(t+="#"+e.fragment),t}const te=/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/;class se{constructor(e){const t=e.match(te);this.scheme=t[2],this.authority=t[4],this.path=t[5],this.query=t[7],this.fragment=t[9]}toString(){let e="";return this.scheme&&(e+=this.scheme+":"),this.authority&&(e+="//"+this.authority),e+=this.path,this.query&&(e+="?"+this.query),this.fragment&&(e+="#"+this.fragment),e}getQuery(){const e={};if(this.query){const t=decodeURIComponent(this.query).split("&");for(const s of t){const t=s.split("=");e[t[0]]=t[1]}}return e}setQuery(e){let t="";for(const s in e)e.hasOwnProperty(s)&&(""!==t&&(t+="&"),t+=encodeURIComponent(s)+"="+encodeURIComponent(e[s]));this.query=t}}class ie{static set(e,t=!0){}static get(e){return ie._traceChannels.has(e)}}ie._traceChannels=new Set;const ne={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:function(e,t,s){return e>=s?s:e<=t?t:e},intToBytes24:function(e){return[e>>16&255,e>>8&255,255&e]},intToBytes32:function(e){return[e>>24&255,e>>16&255,e>>8&255,255&e]},bytesToInt24:function(e,t,s){return e.length&&(s=e[2],t=e[1],e=e[0]),e<<16|t<<8|s},bytesToInt32:function(e,t,s,i){return e.length&&(i=e[3],s=e[2],t=e[1],e=e[0]),(e<<24|t<<16|s<<8|i)>>>0},lerp:function(e,t,s){return e+(t-e)*ne.clamp(s,0,1)},lerpAngle:function(e,t,s){return t-e>180&&(t-=360),t-e<-180&&(t+=360),ne.lerp(e,t,ne.clamp(s,0,1))},powerOfTwo:function(e){return 0!==e&&!(e&e-1)},nextPowerOfTwo:function(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e},random:function(e,t){const s=t-e;return Math.random()*s+e},smoothstep:function(e,t,s){return s<=e?0:s>=t?1:(s=(s-e)/(t-e))*s*(3-2*s)},smootherstep:function(e,t,s){return s<=e?0:s>=t?1:(s=(s-e)/(t-e))*s*s*(s*(6*s-15)+10)},roundUp:function(e,t){return 0===t?e:Math.ceil(e/t)*t},between:function(e,t,s,i){const n=Math.min(t,s),a=Math.max(t,s);return i?e>=n&&e<=a:e>n&&e<a}};class ae{get(e,t,s){return"function"==typeof t&&(s=t,t={}),this.request("GET",e,t,s)}post(e,t,s,i){return"function"==typeof s&&(i=s,s={}),s.postdata=t,this.request("POST",e,s,i)}put(e,t,s,i){return"function"==typeof s&&(i=s,s={}),s.postdata=t,this.request("PUT",e,s,i)}del(e,t,s){return"function"==typeof t&&(s=t,t={}),this.request("DELETE",e,t,s)}request(e,t,s,i){let n,a,r,o=!1;if("function"==typeof s&&(i=s,s={}),s.retry&&(s=Object.assign({retries:0,maxRetries:5},s)),s.callback=i,null==s.async&&(s.async=!0),null==s.headers&&(s.headers={}),null!=s.postdata)if(s.postdata instanceof Document)r=s.postdata;else if(s.postdata instanceof FormData)r=s.postdata;else if(s.postdata instanceof Object){let e=s.headers["Content-Type"];switch(void 0===e&&(s.headers["Content-Type"]=ae.ContentType.FORM_URLENCODED,e=s.headers["Content-Type"]),e){case ae.ContentType.FORM_URLENCODED:{r="";let e=!0;for(const t in s.postdata)if(s.postdata.hasOwnProperty(t)){e?e=!1:r+="&";r+=`${encodeURIComponent(t)}=${encodeURIComponent(s.postdata[t])}`}break}default:case ae.ContentType.JSON:null==e&&(s.headers["Content-Type"]=ae.ContentType.JSON),r=JSON.stringify(s.postdata)}}else r=s.postdata;if(!1===s.cache){const e=Q();n=new se(t),n.query?n.query=n.query+"&ts="+e:n.query="ts="+e,t=n.toString()}s.query&&(n=new se(t),a=T(n.getQuery(),s.query),n.setQuery(a),t=n.toString());const h=new XMLHttpRequest;h.open(e,t,s.async),h.withCredentials=void 0!==s.withCredentials&&s.withCredentials,h.responseType=s.responseType||this._guessResponseType(t);for(const e in s.headers)s.headers.hasOwnProperty(e)&&h.setRequestHeader(e,s.headers[e]);h.onreadystatechange=()=>{this._onReadyStateChange(e,t,s,h)},h.onerror=()=>{this._onError(e,t,s,h),o=!0};try{h.send(r)}catch(e){o||s.error(h.status,h,e)}return h}_guessResponseType(e){const t=new se(e),s=E.getExtension(t.path);return ae.binaryExtensions.indexOf(s)>=0?ae.ResponseType.ARRAY_BUFFER:".xml"===s?ae.ResponseType.DOCUMENT:ae.ResponseType.TEXT}_isBinaryContentType(e){return[ae.ContentType.MP4,ae.ContentType.WAV,ae.ContentType.OGG,ae.ContentType.MP3,ae.ContentType.BIN,ae.ContentType.DDS,ae.ContentType.BASIS,ae.ContentType.GLB,ae.ContentType.OPUS].indexOf(e)>=0}_onReadyStateChange(e,t,s,i){if(4===i.readyState)switch(i.status){case 0:i.responseURL&&i.responseURL.startsWith("file:///")?this._onSuccess(e,t,s,i):this._onError(e,t,s,i);break;case 200:case 201:case 206:case 304:this._onSuccess(e,t,s,i);break;default:this._onError(e,t,s,i)}}_onSuccess(e,t,s,i){let n,a;const r=i.getResponseHeader("Content-Type");if(r){a=r.split(";")[0].trim()}try{n=a===ae.ContentType.JSON||t.split("?")[0].endsWith(".json")?JSON.parse(i.responseText):this._isBinaryContentType(a)||i.responseType===ae.ResponseType.ARRAY_BUFFER||i.responseType===ae.ResponseType.BLOB||i.responseType===ae.ResponseType.JSON?i.response:i.responseType===ae.ResponseType.DOCUMENT||a===ae.ContentType.XML?i.responseXML:i.responseText,s.callback(null,n)}catch(e){s.callback(e)}}_onError(e,t,s,i){if(!s.retrying)if(s.retry&&s.retries<s.maxRetries){s.retries++,s.retrying=!0;const n=ne.clamp(Math.pow(2,s.retries)*ae.retryDelay,0,s.maxRetryDelay||5e3);console.log(`${e}: ${t} - Error ${i.status}. Retrying in ${n} ms`),setTimeout((()=>{s.retrying=!1,this.request(e,t,s,s.callback)}),n)}else s.callback(0===i.status?"Network error":i.status,null)}}ae.ContentType={FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",JPEG:"image/jpeg",DDS:"image/dds",JSON:"application/json",PNG:"image/png",TEXT:"text/plain",XML:"application/xml",WAV:"audio/x-wav",OGG:"audio/ogg",MP3:"audio/mpeg",MP4:"audio/mp4",AAC:"audio/aac",BIN:"application/octet-stream",BASIS:"image/basis",GLB:"model/gltf-binary",OPUS:'audio/ogg; codecs="opus"'},ae.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"},ae.binaryExtensions=[".model",".wav",".ogg",".mp3",".mp4",".m4a",".aac",".dds",".basis",".glb",".opus"],ae.retryDelay=100;const re=new ae,oe=0,he=1,le=2,ce=3,de=4,ue=5;class pe{constructor(e=0,t=0,s=0,i=1){const n=e.length;3===n||4===n?(this.r=e[0],this.g=e[1],this.b=e[2],this.a=void 0!==e[3]?e[3]:1):(this.r=e,this.g=t,this.b=s,this.a=i)}clone(){return new(0,this.constructor)(this.r,this.g,this.b,this.a)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}equals(e){return this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}set(e,t,s,i=1){return this.r=e,this.g=t,this.b=s,this.a=i,this}lerp(e,t,s){return this.r=e.r+s*(t.r-e.r),this.g=e.g+s*(t.g-e.g),this.b=e.b+s*(t.b-e.b),this.a=e.a+s*(t.a-e.a),this}fromString(e){const t=parseInt(e.replace("#","0x"),16);let s;return e.length>7?s=ne.intToBytes32(t):(s=ne.intToBytes24(t),s[3]=255),this.set(s[0]/255,s[1]/255,s[2]/255,s[3]/255),this}toString(e){let t="#"+((1<<24)+(Math.round(255*this.r)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.b)).toString(16).slice(1);if(!0===e){const e=Math.round(255*this.a).toString(16);this.a<16/255?t+="0"+e:t+=e}return t}}pe.BLACK=Object.freeze(new pe(0,0,0,1)),pe.BLUE=Object.freeze(new pe(0,0,1,1)),pe.CYAN=Object.freeze(new pe(0,1,1,1)),pe.GRAY=Object.freeze(new pe(.5,.5,.5,1)),pe.GREEN=Object.freeze(new pe(0,1,0,1)),pe.MAGENTA=Object.freeze(new pe(1,0,1,1)),pe.RED=Object.freeze(new pe(1,0,0,1)),pe.WHITE=Object.freeze(new pe(1,1,1,1)),pe.YELLOW=Object.freeze(new pe(1,1,0,1));class me{constructor(e,t=0){this._curve=e,this._left=-1/0,this._right=1/0,this._recip=0,this._p0=0,this._p1=0,this._m0=0,this._m1=0,this._reset(t)}evaluate(e,t=!1){let s;(t||e<this._left||e>=this._right)&&this._reset(e);const i=this._curve.type;if(5===i)s=this._p0;else{const t=0===this._recip?0:(e-this._left)*this._recip;s=0===i?ne.lerp(this._p0,this._p1,t):1===i?ne.lerp(this._p0,this._p1,t*t*(3-2*t)):this._evaluateHermite(this._p0,this._p1,this._m0,this._m1,t)}return s}_reset(e){const t=this._curve.keys,s=t.length;if(s)if(e<t[0][0])this._left=-1/0,this._right=t[0][0],this._recip=0,this._p0=this._p1=t[0][1],this._m0=this._m1=0;else if(e>=t[s-1][0])this._left=t[s-1][0],this._right=1/0,this._recip=0,this._p0=this._p1=t[s-1][1],this._m0=this._m1=0;else{let s=0;for(;e>=t[s+1][0];)s++;this._left=t[s][0],this._right=t[s+1][0];const i=1/(this._right-this._left);this._recip=isFinite(i)?i:0,this._p0=t[s][1],this._p1=t[s+1][1],this._isHermite()&&this._calcTangents(t,s)}else this._left=-1/0,this._right=1/0,this._recip=0,this._p0=this._p1=this._m0=this._m1=0}_isHermite(){return 2===this._curve.type||3===this._curve.type||4===this._curve.type}_calcTangents(e,t){let s;const i=e[t],n=e[t+1];let a;if(s=0===t?[e[0][0]+(e[0][0]-e[1][0]),e[0][1]+(e[0][1]-e[1][1])]:e[t-1],a=t===e.length-2?[e[t+1][0]+(e[t+1][0]-e[t][0]),e[t+1][1]+(e[t+1][1]-e[t][1])]:e[t+2],4===this._curve.type){const e=2*(n[0]-i[0])/(n[0]-s[0]),t=2*(n[0]-i[0])/(a[0]-i[0]);this._m0=this._curve.tension*(isFinite(e)?e:0)*(n[1]-s[1]),this._m1=this._curve.tension*(isFinite(t)?t:0)*(a[1]-i[1])}else{const e=(n[0]-i[0])/(i[0]-s[0]),t=(n[0]-i[0])/(a[0]-n[0]),r=i[1]+(s[1]-i[1])*(isFinite(e)?e:0),o=n[1]+(a[1]-n[1])*(isFinite(t)?t:0),h=2===this._curve.type?.5:this._curve.tension;this._m0=h*(n[1]-r),this._m1=h*(o-i[1])}}_evaluateHermite(e,t,s,i,n){const a=n*n,r=n+n,o=1-n,h=o*o;return e*((1+r)*h)+s*(n*h)+t*(a*(3-r))+i*(a*(n-1))}}class fe{constructor(e){if(this.keys=[],this.type=1,this.tension=.5,this._eval=new me(this),e)for(let t=0;t<e.length-1;t+=2)this.keys.push([e[t],e[t+1]]);this.sort()}get length(){return this.keys.length}add(e,t){const s=this.keys,i=s.length;let n=0;for(;n<i&&!(s[n][0]>e);n++);const a=[e,t];return this.keys.splice(n,0,a),a}get(e){return this.keys[e]}sort(){this.keys.sort((function(e,t){return e[0]-t[0]}))}value(e){return this._eval.evaluate(e,!0)}closest(e){const t=this.keys,s=t.length;let i=2,n=null;for(let a=0;a<s;a++){const s=Math.abs(e-t[a][0]);if(!(i>=s))break;i=s,n=t[a]}return n}clone(){const e=new this.constructor;return e.keys=T(e.keys,this.keys),e.type=this.type,e.tension=this.tension,e}quantize(e){e=Math.max(e,2);const t=new Float32Array(e),s=1/(e-1);t[0]=this._eval.evaluate(0,!0);for(let i=1;i<e;i++)t[i]=this._eval.evaluate(s*i);return t}quantizeClamped(e,t,s){const i=this.quantize(e);for(let e=0;e<i.length;++e)i[e]=Math.min(s,Math.max(t,i[e]));return i}}class _e{constructor(){if(this.curves=[],this._type=1,arguments.length>1)for(let e=0;e<arguments.length;e++)this.curves.push(new fe(arguments[e]));else if(0===arguments.length)this.curves.push(new fe);else{const e=arguments[0];if("number"==typeof e)for(let t=0;t<e;t++)this.curves.push(new fe);else for(let t=0;t<e.length;t++)this.curves.push(new fe(e[t]))}}get length(){return this.curves.length}set type(e){this._type=e;for(let t=0;t<this.curves.length;t++)this.curves[t].type=e}get type(){return this._type}get(e){return this.curves[e]}value(e,t=[]){const s=this.curves.length;t.length=s;for(let i=0;i<s;i++)t[i]=this.curves[i].value(e);return t}clone(){const e=new this.constructor;e.curves=[];for(let t=0;t<this.curves.length;t++)e.curves.push(this.curves[t].clone());return e._type=this._type,e}quantize(e){e=Math.max(e,2);const t=this.curves.length,s=new Float32Array(e*t),i=1/(e-1);for(let n=0;n<t;n++){const a=new me(this.curves[n]);for(let r=0;r<e;r++)s[r*t+n]=a.evaluate(i*r)}return s}quantizeClamped(e,t,s){const i=this.quantize(e);for(let e=0;e<i.length;++e)i[e]=Math.min(s,Math.max(t,i[e]));return i}}class ge{constructor(e=0,t=0,s=0){3===e.length?(this.x=e[0],this.y=e[1],this.z=e[2]):(this.x=e,this.y=t,this.z=s)}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}clone(){return new(0,this.constructor)(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}cross(e,t){const s=e.x,i=e.y,n=e.z,a=t.x,r=t.y,o=t.z;return this.x=i*o-r*n,this.y=n*a-o*s,this.z=s*r-a*i,this}distance(e){const t=this.x-e.x,s=this.y-e.y,i=this.z-e.z;return Math.sqrt(t*t+s*s+i*i)}div(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this.z=e.z/t.z,this}divScalar(e){return this.x/=e,this.y/=e,this.z/=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}lerp(e,t,s){return this.x=e.x+s*(t.x-e.x),this.y=e.y+s*(t.y-e.y),this.z=e.z+s*(t.z-e.z),this}mul(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}mulScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}normalize(){const e=this.x*this.x+this.y*this.y+this.z*this.z;if(e>0){const t=1/Math.sqrt(e);this.x*=t,this.y*=t,this.z*=t}return this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),this}project(e){const t=(this.x*e.x+this.y*e.y+this.z*e.z)/(e.x*e.x+e.y*e.y+e.z*e.z);return this.x=e.x*t,this.y=e.y*t,this.z=e.z*t,this}set(e,t,s){return this.x=e,this.y=t,this.z=s,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}toString(){return`[${this.x}, ${this.y}, ${this.z}]`}}ge.ZERO=Object.freeze(new ge(0,0,0)),ge.ONE=Object.freeze(new ge(1,1,1)),ge.UP=Object.freeze(new ge(0,1,0)),ge.DOWN=Object.freeze(new ge(0,-1,0)),ge.RIGHT=Object.freeze(new ge(1,0,0)),ge.LEFT=Object.freeze(new ge(-1,0,0)),ge.FORWARD=Object.freeze(new ge(0,0,-1)),ge.BACK=Object.freeze(new ge(0,0,1));class ye{constructor(){const e=new Float32Array(9);e[0]=e[4]=e[8]=1,this.data=e}clone(){return(new(0,this.constructor)).copy(this)}copy(e){const t=e.data,s=this.data;return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8],this}set(e){const t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],this}equals(e){const t=this.data,s=e.data;return t[0]===s[0]&&t[1]===s[1]&&t[2]===s[2]&&t[3]===s[3]&&t[4]===s[4]&&t[5]===s[5]&&t[6]===s[6]&&t[7]===s[7]&&t[8]===s[8]}isIdentity(){const e=this.data;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&1===e[4]&&0===e[5]&&0===e[6]&&0===e[7]&&1===e[8]}setIdentity(){const e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,this}toString(){return"["+this.data.join(", ")+"]"}transpose(){const e=this.data;let t;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this}setFromMat4(e){const t=e.data,s=this.data;return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[4],s[4]=t[5],s[5]=t[6],s[6]=t[8],s[7]=t[9],s[8]=t[10],this}transformVector(e,t=new ge){const s=this.data,i=e.x,n=e.y,a=e.z;return t.x=i*s[0]+n*s[3]+a*s[6],t.y=i*s[1]+n*s[4]+a*s[7],t.z=i*s[2]+n*s[5]+a*s[8],t}}ye.IDENTITY=Object.freeze(new ye),ye.ZERO=Object.freeze((new ye).set([0,0,0,0,0,0,0,0,0]));class ve{constructor(e=0,t=0){2===e.length?(this.x=e[0],this.y=e[1]):(this.x=e,this.y=t)}add(e){return this.x+=e.x,this.y+=e.y,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScalar(e){return this.x+=e,this.y+=e,this}clone(){return new(0,this.constructor)(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}cross(e){return this.x*e.y-this.y*e.x}distance(e){const t=this.x-e.x,s=this.y-e.y;return Math.sqrt(t*t+s*s)}div(e){return this.x/=e.x,this.y/=e.y,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this}divScalar(e){return this.x/=e,this.y/=e,this}dot(e){return this.x*e.x+this.y*e.y}equals(e){return this.x===e.x&&this.y===e.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSq(){return this.x*this.x+this.y*this.y}lerp(e,t,s){return this.x=e.x+s*(t.x-e.x),this.y=e.y+s*(t.y-e.y),this}mul(e){return this.x*=e.x,this.y*=e.y,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this}mulScalar(e){return this.x*=e,this.y*=e,this}normalize(){const e=this.x*this.x+this.y*this.y;if(e>0){const t=1/Math.sqrt(e);this.x*=t,this.y*=t}return this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),this}set(e,t){return this.x=e,this.y=t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}subScalar(e){return this.x-=e,this.y-=e,this}toString(){return`[${this.x}, ${this.y}]`}static angleRad(e,t){return Math.atan2(e.x*t.y-e.y*t.x,e.x*t.x+e.y*t.y)}}ve.ZERO=Object.freeze(new ve(0,0)),ve.ONE=Object.freeze(new ve(1,1)),ve.UP=Object.freeze(new ve(0,1)),ve.DOWN=Object.freeze(new ve(0,-1)),ve.RIGHT=Object.freeze(new ve(1,0)),ve.LEFT=Object.freeze(new ve(-1,0));class xe{constructor(e=0,t=0,s=0,i=0){4===e.length?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=e,this.y=t,this.z=s,this.w=i)}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}clone(){return new(0,this.constructor)(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}div(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this.z=e.z/t.z,this.w=e.w/t.w,this}divScalar(e){return this.x/=e,this.y/=e,this.z/=e,this.w/=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}lerp(e,t,s){return this.x=e.x+s*(t.x-e.x),this.y=e.y+s*(t.y-e.y),this.z=e.z+s*(t.z-e.z),this.w=e.w+s*(t.w-e.w),this}mul(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this.w=e.w*t.w,this}mulScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}normalize(){const e=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;if(e>0){const t=1/Math.sqrt(e);this.x*=t,this.y*=t,this.z*=t,this.w*=t}return this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this}set(e,t,s,i){return this.x=e,this.y=t,this.z=s,this.w=i,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}toString(){return`[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}}xe.ZERO=Object.freeze(new xe(0,0,0,0)),xe.ONE=Object.freeze(new xe(1,1,1,1));const be=new ve,Se=new ge,we=new ge,Te=new ge,Me=new ge;class Ce{constructor(){const e=new Float32Array(16);e[0]=e[5]=e[10]=e[15]=1,this.data=e}static _getPerspectiveHalfSize(e,t,s,i,n){n?(e.x=i*Math.tan(t*Math.PI/360),e.y=e.x/s):(e.y=i*Math.tan(t*Math.PI/360),e.x=e.y*s)}add2(e,t){const s=e.data,i=t.data,n=this.data;return n[0]=s[0]+i[0],n[1]=s[1]+i[1],n[2]=s[2]+i[2],n[3]=s[3]+i[3],n[4]=s[4]+i[4],n[5]=s[5]+i[5],n[6]=s[6]+i[6],n[7]=s[7]+i[7],n[8]=s[8]+i[8],n[9]=s[9]+i[9],n[10]=s[10]+i[10],n[11]=s[11]+i[11],n[12]=s[12]+i[12],n[13]=s[13]+i[13],n[14]=s[14]+i[14],n[15]=s[15]+i[15],this}add(e){return this.add2(this,e)}clone(){return(new(0,this.constructor)).copy(this)}copy(e){const t=e.data,s=this.data;return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8],s[9]=t[9],s[10]=t[10],s[11]=t[11],s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15],this}equals(e){const t=this.data,s=e.data;return t[0]===s[0]&&t[1]===s[1]&&t[2]===s[2]&&t[3]===s[3]&&t[4]===s[4]&&t[5]===s[5]&&t[6]===s[6]&&t[7]===s[7]&&t[8]===s[8]&&t[9]===s[9]&&t[10]===s[10]&&t[11]===s[11]&&t[12]===s[12]&&t[13]===s[13]&&t[14]===s[14]&&t[15]===s[15]}isIdentity(){const e=this.data;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]}mul2(e,t){const s=e.data,i=t.data,n=this.data,a=s[0],r=s[1],o=s[2],h=s[3],l=s[4],c=s[5],d=s[6],u=s[7],p=s[8],m=s[9],f=s[10],_=s[11],g=s[12],y=s[13],v=s[14],x=s[15];let b,S,w,T;return b=i[0],S=i[1],w=i[2],T=i[3],n[0]=a*b+l*S+p*w+g*T,n[1]=r*b+c*S+m*w+y*T,n[2]=o*b+d*S+f*w+v*T,n[3]=h*b+u*S+_*w+x*T,b=i[4],S=i[5],w=i[6],T=i[7],n[4]=a*b+l*S+p*w+g*T,n[5]=r*b+c*S+m*w+y*T,n[6]=o*b+d*S+f*w+v*T,n[7]=h*b+u*S+_*w+x*T,b=i[8],S=i[9],w=i[10],T=i[11],n[8]=a*b+l*S+p*w+g*T,n[9]=r*b+c*S+m*w+y*T,n[10]=o*b+d*S+f*w+v*T,n[11]=h*b+u*S+_*w+x*T,b=i[12],S=i[13],w=i[14],T=i[15],n[12]=a*b+l*S+p*w+g*T,n[13]=r*b+c*S+m*w+y*T,n[14]=o*b+d*S+f*w+v*T,n[15]=h*b+u*S+_*w+x*T,this}mulAffine2(e,t){const s=e.data,i=t.data,n=this.data,a=s[0],r=s[1],o=s[2],h=s[4],l=s[5],c=s[6],d=s[8],u=s[9],p=s[10],m=s[12],f=s[13],_=s[14];let g,y,v;return g=i[0],y=i[1],v=i[2],n[0]=a*g+h*y+d*v,n[1]=r*g+l*y+u*v,n[2]=o*g+c*y+p*v,n[3]=0,g=i[4],y=i[5],v=i[6],n[4]=a*g+h*y+d*v,n[5]=r*g+l*y+u*v,n[6]=o*g+c*y+p*v,n[7]=0,g=i[8],y=i[9],v=i[10],n[8]=a*g+h*y+d*v,n[9]=r*g+l*y+u*v,n[10]=o*g+c*y+p*v,n[11]=0,g=i[12],y=i[13],v=i[14],n[12]=a*g+h*y+d*v+m,n[13]=r*g+l*y+u*v+f,n[14]=o*g+c*y+p*v+_,n[15]=1,this}mul(e){return this.mul2(this,e)}transformPoint(e,t=new ge){const s=this.data,i=e.x,n=e.y,a=e.z;return t.x=i*s[0]+n*s[4]+a*s[8]+s[12],t.y=i*s[1]+n*s[5]+a*s[9]+s[13],t.z=i*s[2]+n*s[6]+a*s[10]+s[14],t}transformVector(e,t=new ge){const s=this.data,i=e.x,n=e.y,a=e.z;return t.x=i*s[0]+n*s[4]+a*s[8],t.y=i*s[1]+n*s[5]+a*s[9],t.z=i*s[2]+n*s[6]+a*s[10],t}transformVec4(e,t=new xe){const s=this.data,i=e.x,n=e.y,a=e.z,r=e.w;return t.x=i*s[0]+n*s[4]+a*s[8]+r*s[12],t.y=i*s[1]+n*s[5]+a*s[9]+r*s[13],t.z=i*s[2]+n*s[6]+a*s[10]+r*s[14],t.w=i*s[3]+n*s[7]+a*s[11]+r*s[15],t}setLookAt(e,t,s){Te.sub2(e,t).normalize(),we.copy(s).normalize(),Se.cross(we,Te).normalize(),we.cross(Te,Se);const i=this.data;return i[0]=Se.x,i[1]=Se.y,i[2]=Se.z,i[3]=0,i[4]=we.x,i[5]=we.y,i[6]=we.z,i[7]=0,i[8]=Te.x,i[9]=Te.y,i[10]=Te.z,i[11]=0,i[12]=e.x,i[13]=e.y,i[14]=e.z,i[15]=1,this}setFrustum(e,t,s,i,n,a){const r=2*n,o=t-e,h=i-s,l=a-n,c=this.data;return c[0]=r/o,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=r/h,c[6]=0,c[7]=0,c[8]=(t+e)/o,c[9]=(i+s)/h,c[10]=(-a-n)/l,c[11]=-1,c[12]=0,c[13]=0,c[14]=-r*a/l,c[15]=0,this}setPerspective(e,t,s,i,n){return Ce._getPerspectiveHalfSize(be,e,t,s,n),this.setFrustum(-be.x,be.x,-be.y,be.y,s,i)}setOrtho(e,t,s,i,n,a){const r=this.data;return r[0]=2/(t-e),r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=2/(i-s),r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=-2/(a-n),r[11]=0,r[12]=-(t+e)/(t-e),r[13]=-(i+s)/(i-s),r[14]=-(a+n)/(a-n),r[15]=1,this}setFromAxisAngle(e,t){t*=ne.DEG_TO_RAD;const s=e.x,i=e.y,n=e.z,a=Math.cos(t),r=Math.sin(t),o=1-a,h=o*s,l=o*i,c=this.data;return c[0]=h*s+a,c[1]=h*i+r*n,c[2]=h*n-r*i,c[3]=0,c[4]=h*i-r*n,c[5]=l*i+a,c[6]=l*n+r*s,c[7]=0,c[8]=h*n+r*i,c[9]=l*n-s*r,c[10]=o*n*n+a,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,this}setTranslate(e,t,s){const i=this.data;return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=e,i[13]=t,i[14]=s,i[15]=1,this}setScale(e,t,s){const i=this.data;return i[0]=e,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=t,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=s,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,this}setViewport(e,t,s,i){const n=this.data;return n[0]=.5*s,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=.5*i,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=.5,n[11]=0,n[12]=e+.5*s,n[13]=t+.5*i,n[14]=.5,n[15]=1,this}invert(){const e=this.data,t=e[0],s=e[1],i=e[2],n=e[3],a=e[4],r=e[5],o=e[6],h=e[7],l=e[8],c=e[9],d=e[10],u=e[11],p=e[12],m=e[13],f=e[14],_=e[15],g=t*r-s*a,y=t*o-i*a,v=t*h-n*a,x=s*o-i*r,b=s*h-n*r,S=i*h-n*o,w=l*m-c*p,T=l*f-d*p,M=l*_-u*p,C=c*f-d*m,A=c*_-u*m,P=d*_-u*f,E=g*P-y*A+v*C+x*M-b*T+S*w;if(0===E)this.setIdentity();else{const R=1/E;e[0]=(r*P-o*A+h*C)*R,e[1]=(-s*P+i*A-n*C)*R,e[2]=(m*S-f*b+_*x)*R,e[3]=(-c*S+d*b-u*x)*R,e[4]=(-a*P+o*M-h*T)*R,e[5]=(t*P-i*M+n*T)*R,e[6]=(-p*S+f*v-_*y)*R,e[7]=(l*S-d*v+u*y)*R,e[8]=(a*A-r*M+h*w)*R,e[9]=(-t*A+s*M-n*w)*R,e[10]=(p*b-m*v+_*g)*R,e[11]=(-l*b+c*v-u*g)*R,e[12]=(-a*C+r*T-o*w)*R,e[13]=(t*C-s*T+i*w)*R,e[14]=(-p*x+m*y-f*g)*R,e[15]=(l*x-c*y+d*g)*R}return this}set(e){const t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],this}setIdentity(){const e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}setTRS(e,t,s){const i=t.x,n=t.y,a=t.z,r=t.w,o=s.x,h=s.y,l=s.z,c=i+i,d=n+n,u=a+a,p=i*c,m=i*d,f=i*u,_=n*d,g=n*u,y=a*u,v=r*c,x=r*d,b=r*u,S=this.data;return S[0]=(1-(_+y))*o,S[1]=(m+b)*o,S[2]=(f-x)*o,S[3]=0,S[4]=(m-b)*h,S[5]=(1-(p+y))*h,S[6]=(g+v)*h,S[7]=0,S[8]=(f+x)*l,S[9]=(g-v)*l,S[10]=(1-(p+_))*l,S[11]=0,S[12]=e.x,S[13]=e.y,S[14]=e.z,S[15]=1,this}transpose(){let e;const t=this.data;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}invertTo3x3(e){const t=this.data,s=e.data,i=t[0],n=t[1],a=t[2],r=t[4],o=t[5],h=t[6],l=t[8],c=t[9],d=t[10],u=d*o-h*c,p=-d*n+a*c,m=h*n-a*o,f=-d*r+h*l,_=d*i-a*l,g=-h*i+a*r,y=c*r-o*l,v=-c*i+n*l,x=o*i-n*r,b=i*u+n*f+a*y;if(0===b)return this;const S=1/b;return s[0]=S*u,s[1]=S*p,s[2]=S*m,s[3]=S*f,s[4]=S*_,s[5]=S*g,s[6]=S*y,s[7]=S*v,s[8]=S*x,this}getTranslation(e=new ge){return e.set(this.data[12],this.data[13],this.data[14])}getX(e=new ge){return e.set(this.data[0],this.data[1],this.data[2])}getY(e=new ge){return e.set(this.data[4],this.data[5],this.data[6])}getZ(e=new ge){return e.set(this.data[8],this.data[9],this.data[10])}getScale(e=new ge){return this.getX(Se),this.getY(we),this.getZ(Te),e.set(Se.length(),we.length(),Te.length()),e}setFromEulerAngles(e,t,s){e*=ne.DEG_TO_RAD,t*=ne.DEG_TO_RAD,s*=ne.DEG_TO_RAD;const i=Math.sin(-e),n=Math.cos(-e),a=Math.sin(-t),r=Math.cos(-t),o=Math.sin(-s),h=Math.cos(-s),l=this.data;return l[0]=r*h,l[1]=-r*o,l[2]=a,l[3]=0,l[4]=n*o+h*i*a,l[5]=n*h-i*a*o,l[6]=-r*i,l[7]=0,l[8]=i*o-n*h*a,l[9]=h*i+n*a*o,l[10]=n*r,l[11]=0,l[12]=0,l[13]=0,l[14]=0,l[15]=1,this}getEulerAngles(e=new ge){this.getScale(Me);const t=Me.x,s=Me.y,i=Me.z;if(0===t||0===s||0===i)return e.set(0,0,0);const n=this.data,a=Math.asin(-n[2]/t),r=.5*Math.PI;let o,h;return a<r?a>-r?(o=Math.atan2(n[6]/s,n[10]/i),h=Math.atan2(n[1]/t,n[0]/t)):(h=0,o=-Math.atan2(n[4]/s,n[5]/s)):(h=0,o=Math.atan2(n[4]/s,n[5]/s)),e.set(o,a,h).mulScalar(ne.RAD_TO_DEG)}toString(){return"["+this.data.join(", ")+"]"}}Ce.IDENTITY=Object.freeze(new Ce),Ce.ZERO=Object.freeze((new Ce).set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]));class Ae{constructor(e=0,t=0,s=0,i=1){4===e.length?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=e,this.y=t,this.z=s,this.w=i)}clone(){return new(0,this.constructor)(this.x,this.y,this.z,this.w)}conjugate(){return this.x*=-1,this.y*=-1,this.z*=-1,this}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}getAxisAngle(e){let t=2*Math.acos(this.w);const s=Math.sin(t/2);return 0!==s?(e.x=this.x/s,e.y=this.y/s,e.z=this.z/s,(e.x<0||e.y<0||e.z<0)&&(e.x*=-1,e.y*=-1,e.z*=-1,t*=-1)):(e.x=1,e.y=0,e.z=0),t*ne.RAD_TO_DEG}getEulerAngles(e=new ge){let t,s,i;const n=this.x,a=this.y,r=this.z,o=this.w,h=2*(o*a-n*r);return h<=-.99999?(t=2*Math.atan2(n,o),s=-Math.PI/2,i=0):h>=.99999?(t=2*Math.atan2(n,o),s=Math.PI/2,i=0):(t=Math.atan2(2*(o*n+a*r),1-2*(n*n+a*a)),s=Math.asin(h),i=Math.atan2(2*(o*r+n*a),1-2*(a*a+r*r))),e.set(t,s,i).mulScalar(ne.RAD_TO_DEG)}invert(){return this.conjugate().normalize()}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}mul(e){const t=this.x,s=this.y,i=this.z,n=this.w,a=e.x,r=e.y,o=e.z,h=e.w;return this.x=n*a+t*h+s*o-i*r,this.y=n*r+s*h+i*a-t*o,this.z=n*o+i*h+t*r-s*a,this.w=n*h-t*a-s*r-i*o,this}mul2(e,t){const s=e.x,i=e.y,n=e.z,a=e.w,r=t.x,o=t.y,h=t.z,l=t.w;return this.x=a*r+s*l+i*h-n*o,this.y=a*o+i*l+n*r-s*h,this.z=a*h+n*l+s*o-i*r,this.w=a*l-s*r-i*o-n*h,this}normalize(){let e=this.length();return 0===e?(this.x=this.y=this.z=0,this.w=1):(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e),this}set(e,t,s,i){return this.x=e,this.y=t,this.z=s,this.w=i,this}setFromAxisAngle(e,t){t*=.5*ne.DEG_TO_RAD;const s=Math.sin(t),i=Math.cos(t);return this.x=s*e.x,this.y=s*e.y,this.z=s*e.z,this.w=i,this}setFromEulerAngles(e,t,s){if(e instanceof ge){const i=e;e=i.x,t=i.y,s=i.z}const i=.5*ne.DEG_TO_RAD;e*=i,t*=i,s*=i;const n=Math.sin(e),a=Math.cos(e),r=Math.sin(t),o=Math.cos(t),h=Math.sin(s),l=Math.cos(s);return this.x=n*o*l-a*r*h,this.y=a*r*l+n*o*h,this.z=a*o*h-n*r*l,this.w=a*o*l+n*r*h,this}setFromMat4(e){let t,s,i,n,a,r,o,h,l,c,d,u,p,m;if(t=(e=e.data)[0],s=e[1],i=e[2],n=e[4],a=e[5],r=e[6],o=e[8],h=e[9],l=e[10],u=t*t+s*s+i*i,0===u)return this;if(u=1/Math.sqrt(u),p=n*n+a*a+r*r,0===p)return this;if(p=1/Math.sqrt(p),m=o*o+h*h+l*l,0===m)return this;m=1/Math.sqrt(m),t*=u,s*=u,i*=u,n*=p,a*=p,r*=p,o*=m,h*=m,l*=m;const f=t+a+l;return f>=0?(c=Math.sqrt(f+1),this.w=.5*c,c=.5/c,this.x=(r-h)*c,this.y=(o-i)*c,this.z=(s-n)*c):t>a?t>l?(d=t-(a+l)+1,d=Math.sqrt(d),this.x=.5*d,d=.5/d,this.w=(r-h)*d,this.y=(s+n)*d,this.z=(i+o)*d):(d=l-(t+a)+1,d=Math.sqrt(d),this.z=.5*d,d=.5/d,this.w=(s-n)*d,this.x=(o+i)*d,this.y=(h+r)*d):a>l?(d=a-(l+t)+1,d=Math.sqrt(d),this.y=.5*d,d=.5/d,this.w=(o-i)*d,this.z=(r+h)*d,this.x=(n+s)*d):(d=l-(t+a)+1,d=Math.sqrt(d),this.z=.5*d,d=.5/d,this.w=(s-n)*d,this.x=(o+i)*d,this.y=(h+r)*d),this}slerp(e,t,s){const i=e.x,n=e.y,a=e.z,r=e.w;let o=t.x,h=t.y,l=t.z,c=t.w,d=r*c+i*o+n*h+a*l;if(d<0&&(c=-c,o=-o,h=-h,l=-l,d=-d),Math.abs(d)>=1)return this.w=r,this.x=i,this.y=n,this.z=a,this;const u=Math.acos(d),p=Math.sqrt(1-d*d);if(Math.abs(p)<.001)return this.w=.5*r+.5*c,this.x=.5*i+.5*o,this.y=.5*n+.5*h,this.z=.5*a+.5*l,this;const m=Math.sin((1-s)*u)/p,f=Math.sin(s*u)/p;return this.w=r*m+c*f,this.x=i*m+o*f,this.y=n*m+h*f,this.z=a*m+l*f,this}transformVector(e,t=new ge){const s=e.x,i=e.y,n=e.z,a=this.x,r=this.y,o=this.z,h=this.w,l=h*s+r*n-o*i,c=h*i+o*s-a*n,d=h*n+a*i-r*s,u=-a*s-r*i-o*n;return t.x=l*h+u*-a+c*-o-d*-r,t.y=c*h+u*-r+d*-a-l*-o,t.z=d*h+u*-o+l*-r-c*-a,t}toString(){return`[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}}Ae.IDENTITY=Object.freeze(new Ae(0,0,0,1)),Ae.ZERO=Object.freeze(new Ae(0,0,0,0));const Pe=new ge,Ee=new ge,Re=new ge,Le=new ge,Ie=new ge;class De{constructor(e=new ge,t=new ge(.5,.5,.5)){this.center=e,this.halfExtents=t,this._min=new ge,this._max=new ge}add(e){const t=this.center,s=t.x,i=t.y,n=t.z,a=this.halfExtents,r=a.x,o=a.y,h=a.z;let l=s-r,c=s+r,d=i-o,u=i+o,p=n-h,m=n+h;const f=e.center,_=f.x,g=f.y,y=f.z,v=e.halfExtents,x=v.x,b=v.y,S=v.z,w=_-x,T=_+x,M=g-b,C=g+b,A=y-S,P=y+S;w<l&&(l=w),T>c&&(c=T),M<d&&(d=M),C>u&&(u=C),A<p&&(p=A),P>m&&(m=P),t.x=.5*(l+c),t.y=.5*(d+u),t.z=.5*(p+m),a.x=.5*(c-l),a.y=.5*(u-d),a.z=.5*(m-p)}copy(e){this.center.copy(e.center),this.halfExtents.copy(e.halfExtents)}clone(){return new De(this.center.clone(),this.halfExtents.clone())}intersects(e){const t=this.getMax(),s=this.getMin(),i=e.getMax(),n=e.getMin();return s.x<=i.x&&t.x>=n.x&&s.y<=i.y&&t.y>=n.y&&s.z<=i.z&&t.z>=n.z}_intersectsRay(e,t){const s=Pe.copy(this.getMin()).sub(e.origin),i=Ee.copy(this.getMax()).sub(e.origin),n=e.direction;0===n.x?(s.x=s.x<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.x=i.x<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.x/=n.x,i.x/=n.x),0===n.y?(s.y=s.y<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.y=i.y<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.y/=n.y,i.y/=n.y),0===n.z?(s.z=s.z<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.z=i.z<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.z/=n.z,i.z/=n.z);const a=Re.set(Math.min(s.x,i.x),Math.min(s.y,i.y),Math.min(s.z,i.z)),r=Le.set(Math.max(s.x,i.x),Math.max(s.y,i.y),Math.max(s.z,i.z)),o=Math.min(Math.min(r.x,r.y),r.z),h=Math.max(Math.max(a.x,a.y),a.z),l=o>=h&&h>=0;return l&&t.copy(e.direction).mulScalar(h).add(e.origin),l}_fastIntersectsRay(e){const t=Pe,s=Ee,i=Re,n=Le,a=Ie,r=e.direction;return t.sub2(e.origin,this.center),n.set(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z)),i.mul2(t,r),!(n.x>this.halfExtents.x&&i.x>=0)&&(!(n.y>this.halfExtents.y&&i.y>=0)&&(!(n.z>this.halfExtents.z&&i.z>=0)&&(a.set(Math.abs(r.x),Math.abs(r.y),Math.abs(r.z)),s.cross(r,t),s.set(Math.abs(s.x),Math.abs(s.y),Math.abs(s.z)),!(s.x>this.halfExtents.y*a.z+this.halfExtents.z*a.y)&&(!(s.y>this.halfExtents.x*a.z+this.halfExtents.z*a.x)&&!(s.z>this.halfExtents.x*a.y+this.halfExtents.y*a.x)))))}intersectsRay(e,t){return t?this._intersectsRay(e,t):this._fastIntersectsRay(e)}setMinMax(e,t){this.center.add2(t,e).mulScalar(.5),this.halfExtents.sub2(t,e).mulScalar(.5)}getMin(){return this._min.copy(this.center).sub(this.halfExtents)}getMax(){return this._max.copy(this.center).add(this.halfExtents)}containsPoint(e){const t=this.getMin(),s=this.getMax();return!(e.x<t.x||e.x>s.x||e.y<t.y||e.y>s.y||e.z<t.z||e.z>s.z)}setFromTransformedAabb(e,t,s=!1){const i=e.center,n=e.halfExtents,a=t.data;let r=a[0],o=a[4],h=a[8],l=a[1],c=a[5],d=a[9],u=a[2],p=a[6],m=a[10];if(s){let e=r*r+o*o+h*h;if(e>0){const t=1/Math.sqrt(e);r*=t,o*=t,h*=t}if(e=l*l+c*c+d*d,e>0){const t=1/Math.sqrt(e);l*=t,c*=t,d*=t}if(e=u*u+p*p+m*m,e>0){const t=1/Math.sqrt(e);u*=t,p*=t,m*=t}}this.center.set(a[12]+r*i.x+o*i.y+h*i.z,a[13]+l*i.x+c*i.y+d*i.z,a[14]+u*i.x+p*i.y+m*i.z),this.halfExtents.set(Math.abs(r)*n.x+Math.abs(o)*n.y+Math.abs(h)*n.z,Math.abs(l)*n.x+Math.abs(c)*n.y+Math.abs(d)*n.z,Math.abs(u)*n.x+Math.abs(p)*n.y+Math.abs(m)*n.z)}compute(e,t){if((t=void 0===t?e.length/3:t)>0){const s=Pe.set(e[0],e[1],e[2]),i=Ee.set(e[0],e[1],e[2]);for(let n=1;n<t;n++){const t=e[3*n+0],a=e[3*n+1],r=e[3*n+2];t<s.x&&(s.x=t),a<s.y&&(s.y=a),r<s.z&&(s.z=r),t>i.x&&(i.x=t),a>i.y&&(i.y=a),r>i.z&&(i.z=r)}this.setMinMax(s,i)}}intersectsBoundingSphere(e){return this._distanceToBoundingSphereSq(e)<=e.radius*e.radius}_distanceToBoundingSphereSq(e){const t=this.getMin(),s=this.getMax();let i=0;const n=["x","y","z"];for(let a=0;a<3;++a){let r=0;const o=e.center[n[a]],h=t[n[a]],l=s[n[a]];let c=0;o<h&&(c=h-o,r+=c*c),o>l&&(c=o-l,r+=c*c),i+=r}return i}_expand(e,t){Pe.add2(this.getMin(),e),Ee.add2(this.getMax(),t),this.setMinMax(Pe,Ee)}}const Oe=new ge,Fe=new ge;class ke{constructor(e=new ge,t=.5){this.center=e,this.radius=t}containsPoint(e){const t=Oe.sub2(e,this.center).lengthSq(),s=this.radius;return t<s*s}intersectsRay(e,t){const s=Oe.copy(e.origin).sub(this.center),i=s.dot(Fe.copy(e.direction).normalize()),n=s.dot(s)-this.radius*this.radius;if(n>0&&i>0)return!1;const a=i*i-n;if(a<0)return!1;const r=Math.abs(-i-Math.sqrt(a));return t&&t.copy(e.direction).mulScalar(r).add(e.origin),!0}intersectsBoundingSphere(e){Oe.sub2(e.center,this.center);const t=e.radius+this.radius;return Oe.lengthSq()<=t*t}}const Be=0,ze=1,Ue=2,Ve=3,Ne=4,Ge=5,We=6,He=7,Xe=8,qe=9,je=10,Ye="none",$e="linear",Ke="exp",Ze="exp2",Qe=0,Je=2,et=0,tt=1,st=2,it=15,nt=0,at=1,rt=2,ot=3,ht=4,lt=0,ct=1,dt=1,ut=2,pt=3,mt=0,ft=1,_t=2,gt=3,yt=0,vt=1,xt=0,bt=0,St=1,wt=2,Tt=3,Mt=4,Ct=5,At=6,Pt={0:"PCF3",1:"VSM8",2:"VSM16",3:"VSM32",4:"PCF5",5:"PCF1"},Et=0,Rt=1,Lt=0,It=1,Dt=2,Ot=3,Ft=0,kt=1,Bt=0,zt=1,Ut=0,Vt=1,Nt=2,Gt=0,Wt=1,Ht=0,Xt=1,qt=2,jt=0,Yt=1,$t=0,Kt=1,Zt="mul",Qt="add",Jt="screen",es="overlay",ts="min",ss="max",is=0,ns=1,as=2,rs=3,os=0,hs=1,ls=2,cs=3,ds=4,us=0,ps=1,ms=2,fs=1,_s=2,gs=4,ys=8,vs=16,xs=32,bs=64,Ss=128,ws=256,Ts=512,Ms=1024,Cs=2048,As=4096,Ps=8192,Es=0,Rs=1,Ls=2,Is=0,Ds=1,Os=2,Fs=0,ks=1,Bs=1,zs=2,Us=4,Vs=0,Ns=1,Gs=2,Ws=3,Hs=4,Xs="forward",qs="depth",js="pick",Ys="shadow",$s=0,Ks=1,Zs=2,Qs=0,Js=1,ei=0,ti=1,si=2,ii=0,ni=1,ai=2,ri=3,oi=4,hi=5,li=1,ci=2,di=4,ui=8,pi=0,mi=1,fi=0,_i=1,gi=[new ge,new ge,new ge,new ge,new ge,new ge,new ge,new ge];class yi{constructor(){this.planes=[];for(let e=0;e<6;e++)this.planes[e]=[]}setFromMat4(e){const t=e.data;let s;const i=this.planes;s=i[0],s[0]=t[3]-t[0],s[1]=t[7]-t[4],s[2]=t[11]-t[8],s[3]=t[15]-t[12];let n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]);s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[1],s[0]=t[3]+t[0],s[1]=t[7]+t[4],s[2]=t[11]+t[8],s[3]=t[15]+t[12],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[2],s[0]=t[3]+t[1],s[1]=t[7]+t[5],s[2]=t[11]+t[9],s[3]=t[15]+t[13],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[3],s[0]=t[3]-t[1],s[1]=t[7]-t[5],s[2]=t[11]-t[9],s[3]=t[15]-t[13],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[4],s[0]=t[3]-t[2],s[1]=t[7]-t[6],s[2]=t[11]-t[10],s[3]=t[15]-t[14],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[5],s[0]=t[3]+t[2],s[1]=t[7]+t[6],s[2]=t[11]+t[10],s[3]=t[15]+t[14],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n}containsPoint(e){let t,s;for(t=0;t<6;t++)if(s=this.planes[t],s[0]*e.x+s[1]*e.y+s[2]*e.z+s[3]<=0)return!1;return!0}containsSphere(e){let t,s,i=0;const n=e.radius,a=e.center,r=a.x,o=a.y,h=a.z,l=this.planes;let c;for(s=0;s<6;s++){if(c=l[s],t=c[0]*r+c[1]*o+c[2]*h+c[3],t<=-n)return 0;t>n&&i++}return 6===i?2:1}static getPoints(e,t,s){t=t||e._nearClip,s=s||e._farClip;const i=e._fov*Math.PI/180;let n=0===e._projection?Math.tan(i/2)*t:e._orthoHeight,a=n*e._aspectRatio;const r=gi;return r[0].x=a,r[0].y=-n,r[0].z=-t,r[1].x=a,r[1].y=n,r[1].z=-t,r[2].x=-a,r[2].y=n,r[2].z=-t,r[3].x=-a,r[3].y=-n,r[3].z=-t,0===e._projection&&(n=Math.tan(i/2)*s,a=n*e._aspectRatio),r[4].x=a,r[4].y=-n,r[4].z=-s,r[5].x=a,r[5].y=n,r[5].z=-s,r[6].x=-a,r[6].y=n,r[6].z=-s,r[7].x=-a,r[7].y=-n,r[7].z=-s,r}}class vi{constructor(e=new ge,t=new ge(0,0,-1)){this.origin=e,this.direction=t}set(e,t){return this.origin.copy(e),this.direction.copy(t),this}}const xi=new vi,bi=new ge,Si=new ke,wi=new Ce;class Ti{constructor(e=new Ce,t=new ge(.5,.5,.5)){this.halfExtents=t,this._modelTransform=e.clone().invert(),this._worldTransform=e.clone(),this._aabb=new De(new ge,this.halfExtents)}set worldTransform(e){this._worldTransform.copy(e),this._modelTransform.copy(e).invert()}get worldTransform(){return this._worldTransform}intersectsRay(e,t){if(this._modelTransform.transformPoint(e.origin,xi.origin),this._modelTransform.transformVector(e.direction,xi.direction),t){const e=this._aabb._intersectsRay(xi,t);return wi.copy(this._modelTransform).invert().transformPoint(t,t),e}return this._aabb._fastIntersectsRay(xi)}containsPoint(e){return this._modelTransform.transformPoint(e,bi),this._aabb.containsPoint(bi)}intersectsBoundingSphere(e){return this._modelTransform.transformPoint(e.center,Si.center),Si.radius=e.radius,!!this._aabb.intersectsBoundingSphere(Si)}}const Mi=new ge;class Ci{constructor(e=new ge,t=new ge(0,0,1)){this.normal=t,this.point=e}intersectsLine(e,t,s){const i=-this.normal.dot(this.point),n=this.normal.dot(e)+i,a=n/(n-(this.normal.dot(t)+i)),r=a>=0&&a<=1;return r&&s&&s.lerp(e,t,a),r}intersectsRay(e,t){const s=Mi.sub2(this.point,e.origin),i=this.normal.dot(s)/this.normal.dot(e.direction),n=i>=0;return n&&t&&t.copy(e.direction).mulScalar(i).add(e.origin),n}}const Ai=0,Pi=1,Ei=2,Ri=0,Li=1,Ii=2,Di=3,Oi=4,Fi=5,ki=6,Bi=7,zi=8,Ui=9,Vi=10,Ni=11,Gi=12,Wi=13,Hi=14,Xi=0,qi=1,ji=2,Yi=3,$i=4,Ki=0,Zi=1,Qi=2,Ji=3,en=1,tn=2,sn=4,nn=0,an=1,rn=2,on=3,hn=4,ln=5,cn=0,dn=1,un=2,pn=3,mn=0,fn=1,_n=2,gn=3,yn=4,vn=5,xn=0,bn=1,Sn=2,wn=3,Tn=4,Mn=5,Cn=6,An=7,Pn=0,En=1,Rn=2,Ln=0,In=1,Dn=2,On=3,Fn=4,kn=5,Bn=6,zn=7,Un=8,Vn=9,Nn=10,Gn=11,Wn=12,Hn=13,Xn=14,qn=15,jn=16,Yn=17,$n=18,Kn=19,Zn=20,Qn=21,Jn=22,ea=23,ta=24,sa=25,ia=26,na=27,aa=28,ra=29,oa=30,ha=0,la=1,ca=2,da=3,ua=4,pa=5,ma=6,fa="POSITION",_a="NORMAL",ga="TANGENT",ya="BLENDWEIGHT",va="BLENDINDICES",xa="COLOR",ba="TEXCOORD",Sa="TEXCOORD0",wa="TEXCOORD1",Ta="TEXCOORD2",Ma="TEXCOORD3",Ca="TEXCOORD4",Aa="TEXCOORD5",Pa="TEXCOORD6",Ea="TEXCOORD7",Ra="ATTR",La="ATTR0",Ia="ATTR1",Da="ATTR2",Oa="ATTR3",Fa="ATTR4",ka="ATTR5",Ba="ATTR6",za="ATTR7",Ua="ATTR8",Va="ATTR9",Na="ATTR10",Ga="ATTR11",Wa="ATTR12",Ha="ATTR13",Xa="ATTR14",qa="ATTR15",ja=1,Ya=0,$a=1,Ka=2,Za=3,Qa=4,Ja=5,er=6,tr=7,sr=1,ir=2,nr="default",ar="rgbm",rr="rgbe",or="rgbp",hr="swizzleGGGR",lr=0,cr=1,dr=2,ur=3,pr="none",mr="cube",fr="equirect",_r="octahedral",gr=0,yr=1,vr=2,xr=3,br=4,Sr=5,wr=6,Tr=0,Mr=1,Cr=2,Ar=3,Pr=4,Er=5,Rr=6,Lr=7,Ir=8,Dr=9,Or=10,Fr=11,kr=12,Br=13,zr=14,Ur=15,Vr=16,Nr=17,Gr=18,Wr=19,Hr=20,Xr=21,qr=22,jr=23,Yr=["bool","int","float","vec2","vec3","vec4","ivec2","ivec3","ivec4","bec2","bec3","bec4","mat2","mat3","mat4","sampler2D","samplerCube","","sampler2DShadow","samplerCubeShadow","sampler3D","","",""],$r="webgl",Kr="webgpu",Zr=1,Qr=2,Jr=4,eo=0,to=1,so="default",io=["view","mesh"],no=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array],ao=[1,1,2,2,4,4,4],ro={Int8Array:0,Uint8Array:1,Int16Array:2,Uint16Array:3,Int32Array:4,Uint32Array:5,Float32Array:6},oo=[Uint8Array,Uint16Array,Uint32Array],ho=[1,2,4],lo={POSITION:0,NORMAL:1,BLENDWEIGHT:2,BLENDINDICES:3,COLOR:4,TEXCOORD0:5,TEXCOORD1:6,TEXCOORD2:7,TEXCOORD3:8,TEXCOORD4:9,TEXCOORD5:10,TEXCOORD6:11,TEXCOORD7:12,TANGENT:13,ATTR0:0,ATTR1:1,ATTR2:2,ATTR3:3,ATTR4:4,ATTR5:5,ATTR6:6,ATTR7:7,ATTR8:8,ATTR9:9,ATTR10:10,ATTR11:11,ATTR12:12,ATTR13:13,ATTR14:14,ATTR15:15},co="1.51",uo="1.55",po="1.56";let mo=0;class fo{constructor(e,t,s,i=0,n){this.device=e,this.format=t,this.numVertices=s,this.usage=i,this.id=mo++,this.impl=e.createVertexBufferImpl(this,t),this.instancing=!1,this.numBytes=t.verticesByteSize?t.verticesByteSize:t.size*s,this.adjustVramSizeTracking(e._vram,this.numBytes),n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),this.device.buffers.push(this)}destroy(){const e=this.device,t=e.buffers.indexOf(this);-1!==t&&e.buffers.splice(t,1),this.impl.initialized&&(this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this.storage.byteLength))}adjustVramSizeTracking(e,t){e.vb+=t}loseContext(){this.impl.loseContext()}getFormat(){return this.format}getUsage(){return this.usage}getNumVertices(){return this.numVertices}lock(){return this.storage}unlock(){this.impl.unlock(this)}setData(e){return e.byteLength===this.numBytes&&(this.storage=e,this.unlock(),!0)}}function _o(e){let t=0;for(let s=0,i=e.length;s<i;s++)t=(t<<5)-t+e.charCodeAt(s),t|=0;return t}class go{constructor(e,t,s){this._elements=[],this.hasUv0=!1,this.hasUv1=!1,this.hasColor=!1,this.hasTangents=!1,this.verticesByteSize=0,this.vertexCount=s,this.interleaved=void 0===s,this.size=t.reduce(((e,t)=>e+4*Math.ceil(t.components*ao[t.type]/4)),0);let i,n=0;for(let e=0,a=t.length;e<a;e++){const a=t[e];i=a.components*ao[a.type],s&&(n=ne.roundUp(n,i));const r={name:a.semantic,offset:s?n:a.hasOwnProperty("offset")?a.offset:n,stride:s?i:a.hasOwnProperty("stride")?a.stride:this.size,dataType:a.type,numComponents:a.components,normalize:void 0!==a.normalize&&a.normalize,size:i};this._elements.push(r),n+=s?i*s:4*Math.ceil(i/4),"TEXCOORD0"===a.semantic?this.hasUv0=!0:"TEXCOORD1"===a.semantic?this.hasUv1=!0:"COLOR"===a.semantic?this.hasColor=!0:"TANGENT"===a.semantic&&(this.hasTangents=!0)}s&&(this.verticesByteSize=n),this._evaluateHash()}get elements(){return this._elements}static get defaultInstancingFormat(){return go._defaultInstancingFormat||(go._defaultInstancingFormat=new go(null,[{semantic:"ATTR12",components:4,type:6},{semantic:"ATTR13",components:4,type:6},{semantic:"ATTR14",components:4,type:6},{semantic:"ATTR15",components:4,type:6}])),go._defaultInstancingFormat}_evaluateHash(){let e;const t=[];let s;const i=[],n=this._elements.length;for(let a=0;a<n;a++){const n=this._elements[a];e=n.name,e+=n.dataType,e+=n.numComponents,e+=n.normalize,t.push(e),s=e,s+=n.offset,s+=n.stride,s+=n.size,i.push(s)}t.sort(),this.batchingHash=_o(t.join()),this.renderingingHashString=i.join("_"),this.renderingingHash=_o(this.renderingingHashString)}}go._defaultInstancingFormat=null;class yo{constructor(){this._cache=new Map}get(e,t){return this._cache.has(e)||(this._cache.set(e,t()),e.on("destroy",(()=>{this.remove(e)}))),this._cache.get(e)}remove(e){var t;null==(t=this._cache.get(e))||t.destroy(),this._cache.delete(e)}}const vo={type:5,base:0,count:4,indexed:!1},xo=new yo;function bo(e,t,s,i,n,a=!1){const r=e.renderTarget;let o,h,l,c,d,u,p,m;e.setRenderTarget(t),e.updateBegin(),i?(o=i.x,h=i.y,l=i.z,c=i.w):(l=t?t.width:e.width,c=t?t.height:e.height,o=0,h=0),n?(d=n.x,u=n.y,p=n.z,m=n.w):(d=o,u=h,p=l,m=c);const f=e.vx,_=e.vy,g=e.vw,y=e.vh;e.setViewport(o,h,l,c);const v=e.sx,x=e.sy,b=e.sw,S=e.sh;e.setScissor(d,u,p,m);const w=e.getDepthTest(),T=e.getDepthWrite(),M=e.getCullMode(),C=e.writeRed,A=e.writeGreen,P=e.writeBlue,E=e.writeAlpha;e.setDepthTest(!1),e.setDepthWrite(!1),e.setCullMode(0),e.setColorWrite(!0,!0,!0,!0),a||e.setBlending(!1),e.setVertexBuffer(function(e){return xo.get(e,(()=>{const t=new go(e,[{semantic:"POSITION",components:2,type:6}]),s=new Float32Array(8);return s.set([-1,-1,1,-1,-1,1,1,1]),new fo(e,t,4,0,s)}))}(e),0),e.setShader(s),e.draw(vo),e.setDepthTest(w),e.setDepthWrite(T),e.setCullMode(M),e.setColorWrite(C,A,P,E),e.updateEnd(),e.setRenderTarget(r),e.updateBegin(),e.setViewport(f,_,g,y),e.setScissor(v,x,b,S)}function So(e,t,s,i,n,a,r=!1){i=i||e.getCopyShader(),e.constantTexSource.setValue(t),bo(e,s,i,n,a,r)}const wo=/[ \t]*#(ifn?def|if|endif|else|elif|define|undef|extension)/g,To=/define[ \t]+([^\n]+)\r?(?:\n|$)/g,Mo=/extension[ \t]+([\w-]+)[ \t]*:[ \t]*enable/g,Co=/undef[ \t]+([^\n]+)\r?(?:\n|$)/g,Ao=/(ifdef|ifndef|if)[ \t]*([^\r\n]+)\r?\n/g,Po=/(endif|else|elif)([ \t]+[^\r\n]+)?\r?(?:\n|$)/g,Eo=/([\w-]+)/,Ro=/(!|\s)?defined\(([\w-]+)\)/,Lo=/[><=|&+-]/g;class Io{static run(e){return e=(e=e.replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm,"$1")).split(/\r?\n/).map((e=>e.trimEnd())).join("\n"),null!==(e=this._preprocess(e))&&(e=(e=e.split(/\r?\n/).map((e=>""===e.trim()?"":e)).join("\n")).replace(/(\n\n){3,}/gm,"\n\n")),e}static _preprocess(e){const t=e,s=[];let i=!1;const n=new Map;let a;for(;null!==(a=wo.exec(e));){const t=a[1];switch(t){case"define":{To.lastIndex=a.index;const t=To.exec(e);i||(i=null===t);const r=t[1];Eo.lastIndex=t.index;const o=Eo.exec(r)[1];let h=r.substring(o.length).trim();""===h&&(h="true");Io._keep(s)&&n.set(o,h),wo.lastIndex=t.index+t[0].length;break}case"undef":{Co.lastIndex=a.index;const t=Co.exec(e),i=t[1].trim();Io._keep(s)&&n.delete(i),wo.lastIndex=t.index+t[0].length;break}case"extension":{Mo.lastIndex=a.index;const t=Mo.exec(e);if(i||(i=null===t),t){const e=t[1];Io._keep(s)&&n.set(e,"true")}wo.lastIndex=t.index+t[0].length;break}case"ifdef":case"ifndef":case"if":{Ao.lastIndex=a.index;const r=Ao.exec(e),o=r[2],h=Io.evaluate(o,n);i||(i=h.error);let l=h.result;"ifndef"===t&&(l=!l),s.push({anyKeep:l,keep:l,start:a.index,end:Ao.lastIndex}),wo.lastIndex=r.index+r[0].length;break}case"endif":case"else":case"elif":{Po.lastIndex=a.index;const t=Po.exec(e),r=s.pop(),o=r.keep?e.substring(r.end,a.index):"";e=e.substring(0,r.start)+o+e.substring(Po.lastIndex),wo.lastIndex=r.start+o.length;const h=t[1];if("else"===h||"elif"===h){let e=!1;if(!r.anyKeep)if("else"===h)e=!r.keep;else{const s=Io.evaluate(t[2],n);e=s.result,i||(i=s.error)}s.push({anyKeep:r.anyKeep||e,keep:e,start:wo.lastIndex,end:wo.lastIndex})}break}}}return i?(console.warn("Failed to preprocess shader: ",{source:t}),t):e}static _keep(e){for(let t=0;t<e.length;t++)if(!e[t].keep)return!1;return!0}static evaluate(e,t){const s=null===Lo.exec(e);let i=!1;const n=Ro.exec(e);n&&(i="!"===n[1],e=n[2]),e=e.trim();let a=t.has(e);return i&&(a=!a),{result:a,error:!s}}}let Do=0;class Oo{constructor(e,t){this.meshUniformBufferFormat=void 0,this.meshBindGroupFormat=void 0,this.id=Do++,this.device=e,this.definition=t,this.name=t.name||"Untitled",t.vshader=Io.run(t.vshader),t.fshader=Io.run(t.fshader),this.init(),this.impl=e.createShaderImpl(this)}init(){this.ready=!1,this.failed=!1}destroy(){this.impl.destroy(this)}loseContext(){this.init()}restoreContext(){this.impl.restoreContext(this.device,this)}}var Fo="\nvec3 decodeLinear(vec4 raw) {\n    return raw.rgb;\n}\n\nfloat decodeGamma(float raw) {\n    return pow(raw, 2.2);\n}\n\nvec3 decodeGamma(vec3 raw) {\n    return pow(raw, vec3(2.2));\n}\n\nvec3 decodeGamma(vec4 raw) {\n    return pow(raw.xyz, vec3(2.2));\n}\n\nvec3 decodeRGBM(vec4 raw) {\n    vec3 color = (8.0 * raw.a) * raw.rgb;\n    return color * color;\n}\n\nvec3 decodeRGBP(vec4 raw) {\n    vec3 color = raw.rgb * (-raw.a * 7.0 + 8.0);\n    return color * color;\n}\n\nvec3 decodeRGBE(vec4 raw) {\n    if (raw.a == 0.0) {\n        return vec3(0.0, 0.0, 0.0);\n    } else {\n        return raw.xyz * pow(2.0, raw.w * 255.0 - 128.0);\n    }\n}\n\nvec4 passThrough(vec4 raw) {\n    return raw;\n}\n",ko="\nvec4 encodeLinear(vec3 source) {\n    return vec4(source, 1.0);\n}\n\nvec4 encodeGamma(vec3 source) {\n    return vec4(pow(source + 0.0000001, vec3(1.0 / 2.2)), 1.0);\n}\n\nvec4 encodeRGBM(vec3 source) { // modified RGBM\n    vec4 result;\n    result.rgb = pow(source.rgb, vec3(0.5));\n    result.rgb *= 1.0 / 8.0;\n\n    result.a = saturate( max( max( result.r, result.g ), max( result.b, 1.0 / 255.0 ) ) );\n    result.a = ceil(result.a * 255.0) / 255.0;\n\n    result.rgb /= result.a;\n    return result;\n}\n\nvec4 encodeRGBP(vec3 source) {\n    // convert incoming linear to gamma(ish)\n    vec3 gamma = pow(source, vec3(0.5));\n\n    // calculate the maximum component clamped to 1..8\n    float maxVal = min(8.0, max(1.0, max(gamma.x, max(gamma.y, gamma.z))));\n\n    // calculate storage factor\n    float v = 1.0 - ((maxVal - 1.0) / 7.0);\n\n    // round the value for storage in 8bit channel\n    v = ceil(v * 255.0) / 255.0;\n\n    return vec4(gamma / (-v * 7.0 + 8.0), v);    \n}\n\nvec4 encodeRGBE(vec3 source) {\n    float maxVal = max(source.x, max(source.y, source.z));\n    if (maxVal < 1e-32) {\n        return vec4(0, 0, 0, 0);\n    } else {\n        float e = ceil(log2(maxVal));\n        return vec4(source / pow(2.0, e), (e + 128.0) / 255.0);\n    }\n}\n";const Bo={alphaTestPS:"\nuniform float alpha_ref;\n\nvoid alphaTest(float a) {\n    if (a < alpha_ref) discard;\n}\n",ambientConstantPS:"\nvoid addAmbient() {\n    dDiffuseLight += light_globalAmbient;\n}\n",ambientEnvPS:"\n#ifndef ENV_ATLAS\n#define ENV_ATLAS\nuniform sampler2D texture_envAtlas;\n#endif\n\nvoid addAmbient() {\n    vec3 dir = normalize(cubeMapRotate(dNormalW) * vec3(-1.0, 1.0, 1.0));\n    vec2 uv = mapUv(toSphericalUv(dir), vec4(128.0, 256.0 + 128.0, 64.0, 32.0) / atlasSize);\n\n    vec4 raw = texture2D(texture_envAtlas, uv);\n    vec3 linear = $DECODE(raw);\n    dDiffuseLight += processEnvironment(linear);\n}\n",ambientSHPS:"\nuniform vec3 ambientSH[9];\n\nvoid addAmbient() {\n    vec3 n = cubeMapRotate(dNormalW);\n\n    vec3 color =\n        ambientSH[0] +\n        ambientSH[1] * n.x +\n        ambientSH[2] * n.y +\n        ambientSH[3] * n.z +\n        ambientSH[4] * n.x * n.z +\n        ambientSH[5] * n.z * n.y +\n        ambientSH[6] * n.y * n.x +\n        ambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n        ambientSH[8] * (n.x * n.x - n.y * n.y);\n\n    dDiffuseLight += processEnvironment(max(color, vec3(0.0)));\n}\n",aoPS:"\n#ifdef MAPTEXTURE\nuniform sampler2D texture_aoMap;\n#endif\n\nvoid getAO() {\n    dAo = 1.0;\n\n    #ifdef MAPTEXTURE\n    dAo *= texture2DBias(texture_aoMap, $UV, textureBias).$CH;\n    #endif\n\n    #ifdef MAPVERTEX\n    dAo *= saturate(vVertexColor.$VC);\n    #endif\n}\n",aoDiffuseOccPS:"\nvoid occludeDiffuse() {\n    dDiffuseLight *= dAo;\n}\n",aoSpecOccPS:"\nuniform float material_occludeSpecularIntensity;\n\nvoid occludeSpecular() {\n    // approximated specular occlusion from AO\n    float specPow = exp2(dGlossiness * 11.0);\n    // http://research.tri-ace.com/Data/cedec2011_RealtimePBR_Implementation_e.pptx\n    float specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n    specOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);\n\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n",aoSpecOccConstPS:"\nvoid occludeSpecular() {\n    // approximated specular occlusion from AO\n    float specPow = exp2(dGlossiness * 11.0);\n    // http://research.tri-ace.com/Data/cedec2011_RealtimePBR_Implementation_e.pptx\n    float specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n",aoSpecOccConstSimplePS:"\nvoid occludeSpecular() {\n    dSpecularLight *= dAo;\n    dReflection *= dAo;\n}\n",aoSpecOccSimplePS:"\nuniform float material_occludeSpecularIntensity;\n\nvoid occludeSpecular() {\n    float specOcc = mix(1.0, dAo, material_occludeSpecularIntensity);\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n",basePS:"\nuniform vec3 view_position;\n\nuniform vec3 light_globalAmbient;\n\nfloat square(float x) {\n    return x*x;\n}\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nvec3 saturate(vec3 x) {\n    return clamp(x, vec3(0.0), vec3(1.0));\n}\n",baseVS:"\nattribute vec3 vertex_position;\nattribute vec3 vertex_normal;\nattribute vec4 vertex_tangent;\nattribute vec2 vertex_texCoord0;\nattribute vec2 vertex_texCoord1;\nattribute vec4 vertex_color;\n\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\n\nvec3 dPositionW;\nmat4 dModelMatrix;\nmat3 dNormalMatrix;\n",baseNineSlicedPS:"\n#define NINESLICED\n\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\n\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\n\nvec2 nineSlicedUv;\n",baseNineSlicedVS:"\n#define NINESLICED\n\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\n\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\n",baseNineSlicedTiledPS:"\n#define NINESLICED\n#define NINESLICETILED\n\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\n\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\n\nvec2 nineSlicedUv;\n",biasConstPS:"\n#define SHADOWBIAS\n\nfloat getShadowBias(float resolution, float maxBias) {\n    return maxBias;\n}\n",blurVSMPS:"\nvarying vec2 vUv0;\n\nuniform sampler2D source;\nuniform vec2 pixelOffset;\n\n#ifdef GAUSS\nuniform float weight[SAMPLES];\n#endif\n\n#ifdef PACKED\nfloat decodeFloatRG(vec2 rg) {\n    return rg.y*(1.0/255.0) + rg.x;\n}\n\nvec2 encodeFloatRG( float v ) {\n    vec2 enc = vec2(1.0, 255.0) * v;\n    enc = fract(enc);\n    enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n    return enc;\n}\n#endif\n\nvoid main(void) {\n    vec3 moments = vec3(0.0);\n    vec2 uv = vUv0 - pixelOffset * (float(SAMPLES) * 0.5);\n    for (int i=0; i<SAMPLES; i++) {\n        vec4 c = texture2D(source, uv + pixelOffset * float(i));\n\n        #ifdef PACKED\n        c.xy = vec2(decodeFloatRG(c.xy), decodeFloatRG(c.zw));\n        #endif\n\n        #ifdef GAUSS\n        moments += c.xyz * weight[i];\n        #else\n        moments += c.xyz;\n        #endif\n    }\n\n    #ifndef GAUSS\n    moments /= float(SAMPLES);\n    #endif\n\n    #ifdef PACKED\n    gl_FragColor = vec4(encodeFloatRG(moments.x), encodeFloatRG(moments.y));\n    #else\n    gl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);\n    #endif\n}\n",clearCoatPS:"\n#ifdef MAPFLOAT\nuniform float material_clearCoat;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatMap;\n#endif\n\nvoid getClearCoat() {\n    ccSpecularity = 1.0;\n\n    #ifdef MAPFLOAT\n    ccSpecularity *= material_clearCoat;\n    #endif\n\n    #ifdef MAPTEXTURE\n    ccSpecularity *= texture2DBias(texture_clearCoatMap, $UV, textureBias).$CH;\n    #endif\n\n    #ifdef MAPVERTEX\n    ccSpecularity *= saturate(vVertexColor.$VC);\n    #endif\n}\n",clearCoatGlossPS:"\n#ifdef MAPFLOAT\nuniform float material_clearCoatGlossiness;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatGlossMap;\n#endif\n\nvoid getClearCoatGlossiness() {\n    ccGlossiness = 1.0;\n\n    #ifdef MAPFLOAT\n    ccGlossiness *= material_clearCoatGlossiness;\n    #endif\n\n    #ifdef MAPTEXTURE\n    ccGlossiness *= texture2DBias(texture_clearCoatGlossMap, $UV, textureBias).$CH;\n    #endif\n\n    #ifdef MAPVERTEX\n    ccGlossiness *= saturate(vVertexColor.$VC);\n    #endif\n\n    ccGlossiness += 0.0000001;\n}\n",clearCoatNormalPS:"\n#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatNormalMap;\nuniform float material_clearCoatBumpiness;\n#endif\n\nvoid getClearCoatNormal() {\n#ifdef MAPTEXTURE\n    vec3 normalMap = unpackNormal(texture2DBias(texture_clearCoatNormalMap, $UV, textureBias));\n    normalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_clearCoatBumpiness);\n    ccNormalW = normalize(dTBN * normalMap);\n#else\n    ccNormalW = dVertexNormalW;\n#endif\n}\n",clusteredLightCookiesPS:"\nvec3 _getCookieClustered(sampler2D tex, vec2 uv, float intensity, bool isRgb, vec4 cookieChannel) {\n    vec4 pixel = mix(vec4(1.0), texture2D(tex, uv), intensity);\n    return isRgb == true ? pixel.rgb : vec3(dot(pixel, cookieChannel));\n}\n\n// getCookie2D for clustered lighting including channel selector\nvec3 getCookie2DClustered(sampler2D tex, mat4 transform, vec3 worldPosition, float intensity, bool isRgb, vec4 cookieChannel) {\n    vec4 projPos = transform * vec4(worldPosition, 1.0);\n    return _getCookieClustered(tex, projPos.xy / projPos.w, intensity, isRgb, cookieChannel);\n}\n\n// getCookie for clustered omni light with the cookie texture being stored in the cookie atlas\nvec3 getCookieCubeClustered(sampler2D tex, vec3 dir, float intensity, bool isRgb, vec4 cookieChannel, float shadowTextureResolution, float shadowEdgePixels, vec3 omniAtlasViewport) {\n    vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n    return _getCookieClustered(tex, uv, intensity, isRgb, cookieChannel);\n}\n",clusteredLightShadowsPS:"\n// Clustered Omni Sampling using atlas\n\n#ifdef GL2\n\n    #if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\n    float getShadowOmniClusteredPCF1(sampler2DShadow shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {\n\n        float shadowTextureResolution = shadowParams.x;\n        vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\n        float shadowZ = length(dir) * shadowParams.w + shadowParams.z;\n        return texture(shadowMap, vec3(uv, shadowZ));\n    }\n\n    #endif\n\n    #if defined(CLUSTER_SHADOW_TYPE_PCF3)\n\n    float getShadowOmniClusteredPCF3(sampler2DShadow shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {\n\n        float shadowTextureResolution = shadowParams.x;\n        vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\n        float shadowZ = length(dir) * shadowParams.w + shadowParams.z;\n        dShadowCoord = vec3(uv, shadowZ);\n        return getShadowPCF3x3(shadowMap, shadowParams.xyz);\n    }\n\n    #endif\n\n    #if defined(CLUSTER_SHADOW_TYPE_PCF5)\n\n    float getShadowOmniClusteredPCF5(sampler2DShadow shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {\n\n        float shadowTextureResolution = shadowParams.x;\n        vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\n        float shadowZ = length(dir) * shadowParams.w + shadowParams.z;\n        dShadowCoord = vec3(uv, shadowZ);\n        return getShadowPCF5x5(shadowMap, shadowParams.xyz);\n    }\n\n    #endif\n\n#else\n\n    #if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\n    float getShadowOmniClusteredPCF1(sampler2D shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {\n\n        float shadowTextureResolution = shadowParams.x;\n        vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\n        // no filter shadow sampling\n        float depth = unpackFloat(texture2D(shadowMap, uv));\n        float shadowZ = length(dir) * shadowParams.w + shadowParams.z;\n        return depth > shadowZ ? 1.0 : 0.0;\n    }\n\n    #endif\n\n    #if defined(CLUSTER_SHADOW_TYPE_PCF3)\n\n    float getShadowOmniClusteredPCF3(sampler2D shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {\n\n        float shadowTextureResolution = shadowParams.x;\n        vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\n        // pcf3\n        float shadowZ = length(dir) * shadowParams.w + shadowParams.z;\n        dShadowCoord = vec3(uv, shadowZ);\n        return getShadowPCF3x3(shadowMap, shadowParams.xyz);\n    }\n\n    #endif\n\n    #if defined(CLUSTER_SHADOW_TYPE_PCF5)\n\n    // we don't have PCF5 implementation for webgl1, use PCF3\n    float getShadowOmniClusteredPCF5(sampler2D shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {\n\n        float shadowTextureResolution = shadowParams.x;\n        vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\n        // pcf3\n        float shadowZ = length(dir) * shadowParams.w + shadowParams.z;\n        dShadowCoord = vec3(uv, shadowZ);\n        return getShadowPCF3x3(shadowMap, shadowParams.xyz);\n    }\n\n    #endif\n\n#endif\n\n\n// Clustered Spot Sampling using atlas\n\n#ifdef GL2\n\n    #if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\n    float getShadowSpotClusteredPCF1(sampler2DShadow shadowMap, vec4 shadowParams) {\n        return texture(shadowMap, dShadowCoord);\n    }\n\n    #endif\n\n    #if defined(CLUSTER_SHADOW_TYPE_PCF3)\n\n    float getShadowSpotClusteredPCF3(sampler2DShadow shadowMap, vec4 shadowParams) {\n        return getShadowSpotPCF3x3(shadowMap, shadowParams);\n    }\n\n    #endif\n\n    #if defined(CLUSTER_SHADOW_TYPE_PCF5)\n\n    float getShadowSpotClusteredPCF5(sampler2DShadow shadowMap, vec4 shadowParams) {\n        return getShadowPCF5x5(shadowMap, shadowParams.xyz);\n    }\n    #endif\n\n#else\n\n    #if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\n    float getShadowSpotClusteredPCF1(sampler2D shadowMap, vec4 shadowParams) {\n\n        float depth = unpackFloat(texture2D(shadowMap, dShadowCoord.xy));\n\n        return depth > dShadowCoord.z ? 1.0 : 0.0;\n\n    }\n\n    #endif\n\n    #if defined(CLUSTER_SHADOW_TYPE_PCF3)\n\n    float getShadowSpotClusteredPCF3(sampler2D shadowMap, vec4 shadowParams) {\n        return getShadowSpotPCF3x3(shadowMap, shadowParams);\n    }\n\n    #endif\n\n    #if defined(CLUSTER_SHADOW_TYPE_PCF5)\n\n    // we don't have PCF5 implementation for webgl1, use PCF3\n    float getShadowSpotClusteredPCF5(sampler2D shadowMap, vec4 shadowParams) {\n        return getShadowSpotPCF3x3(shadowMap, shadowParams);\n    }\n\n    #endif\n\n#endif\n",clusteredLightUtilsPS:"\n// Converts unnormalized direction vector to a cubemap face index [0..5] and uv coordinates within the face in [0..1] range.\n// Additionally offset to a tile in atlas within 3x3 subdivision is provided\nvec2 getCubemapFaceCoordinates(const vec3 dir, out float faceIndex, out vec2 tileOffset)\n{\n    vec3 vAbs = abs(dir);\n    float ma;\n    vec2 uv;\n    if (vAbs.z >= vAbs.x && vAbs.z >= vAbs.y) {   // front / back\n\n        faceIndex = dir.z < 0.0 ? 5.0 : 4.0;\n        ma = 0.5 / vAbs.z;\n        uv = vec2(dir.z < 0.0 ? -dir.x : dir.x, -dir.y);\n\n        tileOffset.x = 2.0;\n        tileOffset.y = dir.z < 0.0 ? 1.0 : 0.0;\n\n    } else if(vAbs.y >= vAbs.x) {  // top index 2, bottom index 3\n\n        faceIndex = dir.y < 0.0 ? 3.0 : 2.0;\n        ma = 0.5 / vAbs.y;\n        uv = vec2(dir.x, dir.y < 0.0 ? -dir.z : dir.z);\n\n        tileOffset.x = 1.0;\n        tileOffset.y = dir.y < 0.0 ? 1.0 : 0.0;\n\n    } else {    // left / right\n\n        faceIndex = dir.x < 0.0 ? 1.0 : 0.0;\n        ma = 0.5 / vAbs.x;\n        uv = vec2(dir.x < 0.0 ? dir.z : -dir.z, -dir.y);\n\n        tileOffset.x = 0.0;\n        tileOffset.y = dir.x < 0.0 ? 1.0 : 0.0;\n\n    }\n    return uv * ma + 0.5;\n}\n\n// converts unnormalized direction vector to a texture coordinate for a cubemap face stored within texture atlas described by the viewport\nvec2 getCubemapAtlasCoordinates(const vec3 omniAtlasViewport, float shadowEdgePixels, float shadowTextureResolution, const vec3 dir) {\n\n    float faceIndex;\n    vec2 tileOffset;\n    vec2 uv = getCubemapFaceCoordinates(dir, faceIndex, tileOffset);\n\n    // move uv coordinates inwards inside to compensate for larger fov when rendering shadow into atlas\n    float atlasFaceSize = omniAtlasViewport.z;\n    float tileSize = shadowTextureResolution * atlasFaceSize;\n    float offset = shadowEdgePixels / tileSize;\n    uv = uv * vec2(1.0 - offset * 2.0) + vec2(offset * 1.0);\n\n    // scale uv coordinates to cube face area within the viewport\n    uv *= atlasFaceSize;\n\n    // offset into face of the atlas (3x3 grid)\n    uv += tileOffset * atlasFaceSize;\n\n    // offset into the atlas viewport\n    uv += omniAtlasViewport.xy;\n\n    return uv;\n}\n",clusteredLightPS:"\nuniform sampler2D clusterWorldTexture;\nuniform sampler2D lightsTexture8;\nuniform highp sampler2D lightsTextureFloat;\n\n// complex ifdef expression are not supported, handle it here\n// defined(CLUSTER_COOKIES) || defined(CLUSTER_SHADOWS)\n#if defined(CLUSTER_COOKIES)\n    #define CLUSTER_COOKIES_OR_SHADOWS\n#endif\n#if defined(CLUSTER_SHADOWS)\n    #define CLUSTER_COOKIES_OR_SHADOWS\n#endif\n\n#ifdef CLUSTER_SHADOWS\n    #ifdef GL2\n        // TODO: when VSM shadow is supported, it needs to use sampler2D in webgl2\n        uniform sampler2DShadow shadowAtlasTexture;\n    #else\n        uniform sampler2D shadowAtlasTexture;\n    #endif\n#endif\n\n#ifdef CLUSTER_COOKIES\n    uniform sampler2D cookieAtlasTexture;\n#endif\n\nuniform float clusterPixelsPerCell;\nuniform vec3 clusterCellsCountByBoundsSize;\nuniform vec4 lightsTextureInvSize;\nuniform vec3 clusterTextureSize;\nuniform vec3 clusterBoundsMin;\nuniform vec3 clusterBoundsDelta;\nuniform vec3 clusterCellsDot;\nuniform vec3 clusterCellsMax;\nuniform vec2 clusterCompressionLimit0;\nuniform vec2 shadowAtlasParams;\n\n// structure storing light properties of a clustered light\nstruct ClusterLightData {\n\n    // v coordinate to look up the light textures\n    float lightV;\n\n    // type of the light (spot or omni)\n    float type;\n\n    // area light shape\n    float shape;\n\n    // area light sizes / orientation\n    vec3 halfWidth;\n    vec3 halfHeight;\n\n    // light follow mode\n    float falloffMode;\n\n    // 0.0 if the light doesn't cast shadows\n    float shadowIntensity;\n\n    // shadow bias values\n    float shadowBias;\n    float shadowNormalBias;\n\n    // world space position\n    vec3 position;\n\n    // world space direction (spot light only)\n    vec3 direction;\n\n    // range of the light\n    float range;\n\n    // spot light inner and outer angle cosine\n    float innerConeAngleCos;\n    float outerConeAngleCos;\n\n    // color\n    vec3 color;\n\n    // atlas viewport for omni light shadow and cookie (.xy is offset to the viewport slot, .z is size of the face in the atlas)\n    vec3 omniAtlasViewport;\n\n    // 1.0 if the light has a cookie texture\n    float cookie;\n\n    // 1.0 if cookie texture is rgb, otherwise it is using a single channel selectable by cookieChannelMask\n    float cookieRgb;\n\n    // intensity of the cookie\n    float cookieIntensity;\n\n    // channel mask - one of the channels has 1, the others are 0\n    vec4 cookieChannelMask;\n\n    // light mask\n    float mask;\n};\n\n// Note: on some devices (tested on Pixel 3A XL), this matrix when stored inside the light struct has lower precision compared to\n// when stored outside, so we store it outside to avoid spot shadow flickering. This might need to be done to other / all members\n// of the structure if further similar issues are observed.\n\n// shadow (spot light only) / cookie projection matrix\nmat4 lightProjectionMatrix;\n\n// macros for light properties\n#define isClusteredLightCastShadow(light) ( light.shadowIntensity > 0.0 )\n#define isClusteredLightCookie(light) (light.cookie > 0.5 )\n#define isClusteredLightCookieRgb(light) (light.cookieRgb > 0.5 )\n#define isClusteredLightSpot(light) ( light.type > 0.5 )\n#define isClusteredLightFalloffLinear(light) ( light.falloffMode < 0.5 )\n\n// macros to test light shape\n// Note: Following functions need to be called serially in listed order as they do not test both '>' and '<'\n#define isClusteredLightArea(light) ( light.shape > 0.1 )\n#define isClusteredLightRect(light) ( light.shape < 0.3 )\n#define isClusteredLightDisk(light) ( light.shape < 0.6 )\n\n// macro to test light mask (mesh accepts dynamic vs lightmapped lights)\n#ifdef CLUSTER_MESH_DYNAMIC_LIGHTS\n    // accept lights marked as dynamic or both dynamic and lightmapped\n    #define acceptLightMask(light) ( light.mask < 0.75)\n#else\n    // accept lights marked as lightmapped or both dynamic and lightmapped\n    #define acceptLightMask(light) ( light.mask > 0.25)\n#endif\n\nvec4 decodeClusterLowRange4Vec4(vec4 d0, vec4 d1, vec4 d2, vec4 d3) {\n    return vec4(\n        bytes2floatRange4(d0, -2.0, 2.0),\n        bytes2floatRange4(d1, -2.0, 2.0),\n        bytes2floatRange4(d2, -2.0, 2.0),\n        bytes2floatRange4(d3, -2.0, 2.0)\n    );\n}\n\n// use LOD sampling if supported to sample data textures as it has better chance of getting skipped inside dynamic branches\n#ifdef SUPPORTS_TEXLOD\n    #define textureData(texture, uv) texture2DLodEXT(texture, uv, 0.0)\n#else\n    #define textureData(texture, uv) texture2D(texture, uv)\n#endif\n\nvec4 sampleLightsTexture8(const ClusterLightData clusterLightData, float index) {\n    return textureData(lightsTexture8, vec2(index * lightsTextureInvSize.z, clusterLightData.lightV));\n}\n\nvec4 sampleLightTextureF(const ClusterLightData clusterLightData, float index) {\n    return textureData(lightsTextureFloat, vec2(index * lightsTextureInvSize.x, clusterLightData.lightV));\n}\n\nvoid decodeClusterLightCore(inout ClusterLightData clusterLightData, float lightIndex) {\n\n    // read omni light properties\n    clusterLightData.lightV = (lightIndex + 0.5) * lightsTextureInvSize.w;\n\n    // shared data from 8bit texture\n    vec4 lightInfo = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_FLAGS);\n    clusterLightData.type = lightInfo.x;\n    clusterLightData.shape = lightInfo.y;\n    clusterLightData.falloffMode = lightInfo.z;\n    clusterLightData.shadowIntensity = lightInfo.w;\n\n    // color\n    vec4 colorA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COLOR_A);\n    vec4 colorB = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COLOR_B);\n    clusterLightData.color = vec3(bytes2float2(colorA.xy), bytes2float2(colorA.zw), bytes2float2(colorB.xy)) * clusterCompressionLimit0.y;\n\n    // cookie\n    clusterLightData.cookie = colorB.z;\n\n    // light mask\n    clusterLightData.mask = colorB.w;\n\n    #ifdef CLUSTER_TEXTURE_FLOAT\n\n        vec4 lightPosRange = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_POSITION_RANGE);\n        clusterLightData.position = lightPosRange.xyz;\n        clusterLightData.range = lightPosRange.w;\n\n        // spot light direction\n        vec4 lightDir_Unused = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_SPOT_DIRECTION);\n        clusterLightData.direction = lightDir_Unused.xyz;\n\n    #else   // 8bit\n\n        vec4 encPosX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_POSITION_X);\n        vec4 encPosY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_POSITION_Y);\n        vec4 encPosZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_POSITION_Z);\n        clusterLightData.position = vec3(bytes2float4(encPosX), bytes2float4(encPosY), bytes2float4(encPosZ)) * clusterBoundsDelta + clusterBoundsMin;\n\n        vec4 encRange = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_RANGE);\n        clusterLightData.range = bytes2float4(encRange) * clusterCompressionLimit0.x;\n\n        // spot light direction\n        vec4 encDirX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_DIRECTION_X);\n        vec4 encDirY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_DIRECTION_Y);\n        vec4 encDirZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_DIRECTION_Z);\n        clusterLightData.direction = vec3(bytes2float4(encDirX), bytes2float4(encDirY), bytes2float4(encDirZ)) * 2.0 - 1.0;\n\n    #endif\n}\n\nvoid decodeClusterLightSpot(inout ClusterLightData clusterLightData) {\n\n    // spot light cos angles\n    vec4 coneAngle = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_ANGLES);\n    clusterLightData.innerConeAngleCos = bytes2float2(coneAngle.xy) * 2.0 - 1.0;\n    clusterLightData.outerConeAngleCos = bytes2float2(coneAngle.zw) * 2.0 - 1.0;\n}\n\nvoid decodeClusterLightOmniAtlasViewport(inout ClusterLightData clusterLightData) {\n    #ifdef CLUSTER_TEXTURE_FLOAT\n        clusterLightData.omniAtlasViewport = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_0).xyz;\n    #else\n        vec4 viewportA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_ATLAS_VIEWPORT_A);\n        vec4 viewportB = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_ATLAS_VIEWPORT_B);\n        clusterLightData.omniAtlasViewport = vec3(bytes2float2(viewportA.xy), bytes2float2(viewportA.zw), bytes2float2(viewportB.xy));\n    #endif\n}\n\nvoid decodeClusterLightAreaData(inout ClusterLightData clusterLightData) {\n    #ifdef CLUSTER_TEXTURE_FLOAT\n        clusterLightData.halfWidth = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_AREA_DATA_WIDTH).xyz;\n        clusterLightData.halfHeight = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_AREA_DATA_HEIGHT).xyz;\n    #else\n        vec4 areaWidthX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_WIDTH_X);\n        vec4 areaWidthY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_WIDTH_Y);\n        vec4 areaWidthZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_WIDTH_Z);\n        clusterLightData.halfWidth = vec3(mantissaExponent2Float(areaWidthX), mantissaExponent2Float(areaWidthY), mantissaExponent2Float(areaWidthZ));\n\n        vec4 areaHeightX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_HEIGHT_X);\n        vec4 areaHeightY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_HEIGHT_Y);\n        vec4 areaHeightZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_HEIGHT_Z);\n        clusterLightData.halfHeight = vec3(mantissaExponent2Float(areaHeightX), mantissaExponent2Float(areaHeightY), mantissaExponent2Float(areaHeightZ));\n    #endif\n}\n\nvoid decodeClusterLightProjectionMatrixData(inout ClusterLightData clusterLightData) {\n    \n    // shadow matrix\n    #ifdef CLUSTER_TEXTURE_FLOAT\n        vec4 m0 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_0);\n        vec4 m1 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_1);\n        vec4 m2 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_2);\n        vec4 m3 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_3);\n    #else\n        vec4 m00 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_00);\n        vec4 m01 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_01);\n        vec4 m02 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_02);\n        vec4 m03 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_03);\n        vec4 m0 = decodeClusterLowRange4Vec4(m00, m01, m02, m03);\n\n        vec4 m10 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_10);\n        vec4 m11 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_11);\n        vec4 m12 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_12);\n        vec4 m13 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_13);\n        vec4 m1 = decodeClusterLowRange4Vec4(m10, m11, m12, m13);\n\n        vec4 m20 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_20);\n        vec4 m21 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_21);\n        vec4 m22 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_22);\n        vec4 m23 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_23);\n        vec4 m2 = decodeClusterLowRange4Vec4(m20, m21, m22, m23);\n\n        vec4 m30 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_30);\n        vec4 m31 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_31);\n        vec4 m32 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_32);\n        vec4 m33 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_33);\n        vec4 m3 = vec4(mantissaExponent2Float(m30), mantissaExponent2Float(m31), mantissaExponent2Float(m32), mantissaExponent2Float(m33));\n    #endif\n    \n    lightProjectionMatrix = mat4(m0, m1, m2, m3);\n}\n\nvoid decodeClusterLightShadowData(inout ClusterLightData clusterLightData) {\n    \n    // shadow biases\n    vec4 biases = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SHADOW_BIAS);\n    clusterLightData.shadowBias = bytes2floatRange2(biases.xy, -1.0, 20.0),\n    clusterLightData.shadowNormalBias = bytes2float2(biases.zw);\n}\n\nvoid decodeClusterLightCookieData(inout ClusterLightData clusterLightData) {\n\n    vec4 cookieA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COOKIE_A);\n    clusterLightData.cookieIntensity = cookieA.x;\n    clusterLightData.cookieRgb = cookieA.y;\n\n    clusterLightData.cookieChannelMask = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COOKIE_B);\n}\n\nvoid evaluateLight(ClusterLightData light) {\n\n    dAtten3 = vec3(1.0);\n\n    // evaluate omni part of the light\n    getLightDirPoint(light.position);\n\n    #ifdef CLUSTER_AREALIGHTS\n\n    // distance attenuation\n    if (isClusteredLightArea(light)) { // area light\n\n        // area lights\n        decodeClusterLightAreaData(light);\n\n        // handle light shape\n        if (isClusteredLightRect(light)) {\n            calcRectLightValues(light.position, light.halfWidth, light.halfHeight);\n        } else if (isClusteredLightDisk(light)) {\n            calcDiskLightValues(light.position, light.halfWidth, light.halfHeight);\n        } else { // sphere\n            calcSphereLightValues(light.position, light.halfWidth, light.halfHeight);\n        }\n\n        dAtten = getFalloffWindow(light.range);\n\n    } else\n\n    #endif\n\n    {   // punctual light\n\n        if (isClusteredLightFalloffLinear(light))\n            dAtten = getFalloffLinear(light.range);\n        else\n            dAtten = getFalloffInvSquared(light.range);\n    }\n\n    if (dAtten > 0.00001) {\n\n        #ifdef CLUSTER_AREALIGHTS\n\n        if (isClusteredLightArea(light)) { // area light\n\n            // handle light shape\n            if (isClusteredLightRect(light)) {\n                dAttenD = getRectLightDiffuse() * 16.0;\n            } else if (isClusteredLightDisk(light)) {\n                dAttenD = getDiskLightDiffuse() * 16.0;\n            } else { // sphere\n                dAttenD = getSphereLightDiffuse() * 16.0;\n            }\n\n        } else\n\n        #endif\n\n        {\n            dAtten *= getLightDiffuse();\n        }\n\n        // spot light falloff\n        if (isClusteredLightSpot(light)) {\n            decodeClusterLightSpot(light);\n            dAtten *= getSpotEffect(light.direction, light.innerConeAngleCos, light.outerConeAngleCos);\n        }\n\n        #if defined(CLUSTER_COOKIES_OR_SHADOWS)\n\n        if (dAtten > 0.00001) {\n\n            // shadow / cookie\n            if (isClusteredLightCastShadow(light) || isClusteredLightCookie(light)) {\n\n                // shared shadow / cookie data depends on light type\n                if (isClusteredLightSpot(light)) {\n                    decodeClusterLightProjectionMatrixData(light);\n                } else {\n                    decodeClusterLightOmniAtlasViewport(light);\n                }\n\n                float shadowTextureResolution = shadowAtlasParams.x;\n                float shadowEdgePixels = shadowAtlasParams.y;\n\n                #ifdef CLUSTER_COOKIES\n\n                // cookie\n                if (isClusteredLightCookie(light)) {\n                    decodeClusterLightCookieData(light);\n\n                    if (isClusteredLightSpot(light)) {\n                        dAtten3 = getCookie2DClustered(cookieAtlasTexture, lightProjectionMatrix, vPositionW, light.cookieIntensity, isClusteredLightCookieRgb(light), light.cookieChannelMask);\n                    } else {\n                        dAtten3 = getCookieCubeClustered(cookieAtlasTexture, dLightDirW, light.cookieIntensity, isClusteredLightCookieRgb(light), light.cookieChannelMask, shadowTextureResolution, shadowEdgePixels, light.omniAtlasViewport);\n                    }\n                }\n\n                #endif\n\n                #ifdef CLUSTER_SHADOWS\n\n                // shadow\n                if (isClusteredLightCastShadow(light)) {\n                    decodeClusterLightShadowData(light);\n\n                    vec4 shadowParams = vec4(shadowTextureResolution, light.shadowNormalBias, light.shadowBias, 1.0 / light.range);\n\n                    if (isClusteredLightSpot(light)) {\n\n                        // spot shadow\n                        getShadowCoordPerspZbufferNormalOffset(lightProjectionMatrix, shadowParams);\n                        \n                        #if defined(CLUSTER_SHADOW_TYPE_PCF1)\n                            float shadow = getShadowSpotClusteredPCF1(shadowAtlasTexture, shadowParams);\n                        #elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n                            float shadow = getShadowSpotClusteredPCF3(shadowAtlasTexture, shadowParams);\n                        #elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n                            float shadow = getShadowSpotClusteredPCF5(shadowAtlasTexture, shadowParams);\n                        #endif\n                        dAtten *= mix(1.0, shadow, light.shadowIntensity);\n\n                    } else {\n\n                        // omni shadow\n                        normalOffsetPointShadow(shadowParams);  // normalBias adjusted for distance\n\n                        #if defined(CLUSTER_SHADOW_TYPE_PCF1)\n                            float shadow = getShadowOmniClusteredPCF1(shadowAtlasTexture, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dLightDirW);\n                        #elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n                            float shadow = getShadowOmniClusteredPCF3(shadowAtlasTexture, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dLightDirW);\n                        #elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n                            float shadow = getShadowOmniClusteredPCF5(shadowAtlasTexture, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dLightDirW);\n                        #endif\n                        dAtten *= mix(1.0, shadow, light.shadowIntensity);\n                    }\n                }\n\n                #endif\n            }\n        }\n\n        #endif\n\n        // diffuse / specular / clearcoat\n        #ifdef CLUSTER_AREALIGHTS\n\n        if (isClusteredLightArea(light)) { // area light\n\n            // area light diffuse\n            {\n                vec3 areaDiffuse = (dAttenD * dAtten) * light.color * dAtten3;\n\n                #if defined(LIT_SPECULAR)\n                    #if defined(LIT_CONSERVE_ENERGY)\n                        areaDiffuse = mix(areaDiffuse, vec3(0), dLTCSpecFres);\n                    #endif\n                #endif\n\n                // area light diffuse - it does not mix diffuse lighting into specular attenuation\n                dDiffuseLight += areaDiffuse;\n            }\n\n            // specular and clear coat are material settings and get included by a define based on the material\n            #ifdef LIT_SPECULAR\n\n                // area light specular\n                float areaLightSpecular;\n\n                if (isClusteredLightRect(light)) {\n                    areaLightSpecular = getRectLightSpecular();\n                } else if (isClusteredLightDisk(light)) {\n                    areaLightSpecular = getDiskLightSpecular();\n                } else { // sphere\n                    areaLightSpecular = getSphereLightSpecular();\n                }\n\n                dSpecularLight += dLTCSpecFres * areaLightSpecular * dAtten * light.color * dAtten3;\n\n                #ifdef LIT_CLEARCOAT\n\n                    // area light specular clear coat\n                    float areaLightSpecularCC;\n\n                    if (isClusteredLightRect(light)) {\n                        areaLightSpecularCC = getRectLightSpecularCC();\n                    } else if (isClusteredLightDisk(light)) {\n                        areaLightSpecularCC = getDiskLightSpecularCC();\n                    } else { // sphere\n                        areaLightSpecularCC = getSphereLightSpecularCC();\n                    }\n\n                    ccSpecularLight += ccLTCSpecFres * areaLightSpecularCC * dAtten * light.color  * dAtten3;\n\n                #endif\n\n            #endif\n\n        } else\n\n        #endif\n\n        {    // punctual light\n\n            // punctual light diffuse\n            {\n                vec3 punctualDiffuse = dAtten * light.color * dAtten3;\n\n                #if defined(CLUSTER_AREALIGHTS)\n                #if defined(LIT_SPECULAR)\n                #if defined(LIT_CONSERVE_ENERGY)\n                    punctualDiffuse = mix(punctualDiffuse, vec3(0), dSpecularity);\n                #endif\n                #endif\n                #endif\n\n                dDiffuseLight += punctualDiffuse;\n            }\n   \n            // specular and clear coat are material settings and get included by a define based on the material\n            #ifdef LIT_SPECULAR\n\n                vec3 halfDir = normalize(-dLightDirNormW + dViewDirW);\n                \n                // specular\n                #ifdef LIT_SPECULAR_FRESNEL\n                    dSpecularLight += getLightSpecular(halfDir) * dAtten * light.color * dAtten3 * getFresnel(dot(dViewDirW, halfDir), dSpecularity);\n                #else\n                    dSpecularLight += getLightSpecular(halfDir) * dAtten * light.color * dAtten3 * dSpecularity;\n                #endif\n\n                #ifdef LIT_CLEARCOAT\n                    #ifdef LIT_SPECULAR_FRESNEL\n                        ccSpecularLight += getLightSpecularCC(halfDir) * dAtten * light.color * dAtten3 * getFresnel(dot(dViewDirW, halfDir), vec3(ccSpecularity));\n                    #else\n                        ccSpecularLight += getLightSpecularCC(halfDir) * dAtten * light.color * dAtten3 * vec3(ccSpecularity);\n                    #endif\n                #endif\n\n                #ifdef LIT_SHEEN\n                    sSpecularLight += getLightSpecularSheen(halfDir) * dAtten * light.color * dAtten3 * sSpecularity;\n                #endif\n\n            #endif\n        }\n    }\n}\n\nvoid evaluateClusterLight(float lightIndex) {\n\n    // decode core light data from textures\n    ClusterLightData clusterLightData;\n    decodeClusterLightCore(clusterLightData, lightIndex);\n\n    // evaluate light if it uses accepted light mask\n    if (acceptLightMask(clusterLightData))\n        evaluateLight(clusterLightData);\n}\n\nvoid addClusteredLights() {\n    // world space position to 3d integer cell cordinates in the cluster structure\n    vec3 cellCoords = floor((vPositionW - clusterBoundsMin) * clusterCellsCountByBoundsSize);\n\n    // no lighting when cell coordinate is out of range\n    if (!(any(lessThan(cellCoords, vec3(0.0))) || any(greaterThanEqual(cellCoords, clusterCellsMax)))) {\n\n        // cell index (mapping from 3d cell coordinates to linear memory)\n        float cellIndex = dot(clusterCellsDot, cellCoords);\n\n        // convert cell index to uv coordinates\n        float clusterV = floor(cellIndex * clusterTextureSize.y);\n        float clusterU = cellIndex - (clusterV * clusterTextureSize.x);\n        clusterV = (clusterV + 0.5) * clusterTextureSize.z;\n\n        // loop over maximum possible number of supported light cells\n        const float maxLightCells = 256.0 / 4.0;  // 8 bit index, each stores 4 lights\n        for (float lightCellIndex = 0.5; lightCellIndex < maxLightCells; lightCellIndex++) {\n\n            vec4 lightIndices = textureData(clusterWorldTexture, vec2(clusterTextureSize.y * (clusterU + lightCellIndex), clusterV));\n            vec4 indices = lightIndices * 255.0;\n\n            // evaluate up to 4 lights. This is written using a loop instead of manually unrolling to keep shader compile time smaller\n            for (int i = 0; i < 4; i++) {\n                \n                if (indices.x <= 0.0)\n                    return;\n\n                evaluateClusterLight(indices.x); \n                indices = indices.yzwx;\n            }\n\n            // end of the cell array\n            if (lightCellIndex > clusterPixelsPerCell) {\n                break;\n            }\n        }\n    }\n}\n",combinePS:"\nvec3 combineColor() {\n    vec3 ret = vec3(0);\n#ifdef LIT_OLD_AMBIENT\n    ret += (dDiffuseLight - light_globalAmbient) * dAlbedo + material_ambient * light_globalAmbient;\n#else\n    ret += dAlbedo * dDiffuseLight;\n#endif\n#ifdef LIT_SPECULAR\n    ret += dSpecularLight;\n#endif\n#ifdef LIT_REFLECTIONS\n    ret += dReflection.rgb * dReflection.a;\n#endif\n#ifdef LIT_CLEARCOAT\n    ret += ccSpecularLight + ccReflection.rgb * ccReflection.a;\n#endif\n#ifdef LIT_SHEEN\n    float scaling = 1.0 - max(max(sSpecularity.r, sSpecularity.g), sSpecularity.b) * 0.157;\n    ret = ret * scaling + sSpecularLight + sReflection.rgb * sReflection.a;\n#endif\n    return ret;\n}\n",cookiePS:"\n// light cookie functionality for non-clustered lights\nvec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {\n    vec4 projPos = transform * vec4(vPositionW, 1.0);\n    projPos.xy /= projPos.w;\n    return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\n\nvec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {\n    vec4 projPos = transform * vec4(vPositionW, 1.0);\n    projPos.xy /= projPos.w;\n    if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n    return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\n\nvec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n    vec4 projPos = transform * vec4(vPositionW, 1.0);\n    projPos.xy /= projPos.w;\n    projPos.xy += cookieOffset;\n    vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n    return mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\n\nvec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n    vec4 projPos = transform * vec4(vPositionW, 1.0);\n    projPos.xy /= projPos.w;\n    projPos.xy += cookieOffset;\n    if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n    vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n    return mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\n\nvec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {\n    return mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);\n}\n",cubeMapProjectBoxPS:"\nuniform vec3 envBoxMin, envBoxMax;\n\nvec3 cubeMapProject(vec3 nrdir) {\n    nrdir = cubeMapRotate(nrdir);\n\n    vec3 rbmax = (envBoxMax - vPositionW) / nrdir;\n    vec3 rbmin = (envBoxMin - vPositionW) / nrdir;\n\n    vec3 rbminmax;\n    rbminmax.x = nrdir.x>0.0? rbmax.x : rbmin.x;\n    rbminmax.y = nrdir.y>0.0? rbmax.y : rbmin.y;\n    rbminmax.z = nrdir.z>0.0? rbmax.z : rbmin.z;\n\n    float fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n\n    vec3 posonbox = vPositionW + nrdir * fa;\n    vec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;\n    return normalize(posonbox - envBoxPos);\n}\n",cubeMapProjectNonePS:"\nvec3 cubeMapProject(vec3 dir) {\n    return cubeMapRotate(dir);\n}\n",cubeMapRotatePS:"\n#ifdef CUBEMAP_ROTATION\nuniform mat3 cubeMapRotationMatrix;\n#endif\n\nvec3 cubeMapRotate(vec3 refDir) {\n#ifdef CUBEMAP_ROTATION\n    return refDir * cubeMapRotationMatrix;\n#else\n    return refDir;\n#endif\n}\n",detailModesPS:"\nvec3 detailMode_mul(vec3 c1, vec3 c2) {\n    return c1 * c2;\n}\n\nvec3 detailMode_add(vec3 c1, vec3 c2) {\n    return c1 + c2;\n}\n\n// https://en.wikipedia.org/wiki/Blend_modes#Screen\nvec3 detailMode_screen(vec3 c1, vec3 c2) {\n    return 1.0 - (1.0 - c1)*(1.0 - c2);\n}\n\n// https://en.wikipedia.org/wiki/Blend_modes#Overlay\nvec3 detailMode_overlay(vec3 c1, vec3 c2) {\n    return mix(1.0 - 2.0*(1.0 - c1)*(1.0 - c2), 2.0*c1*c2, step(c1, vec3(0.5)));\n}\n\nvec3 detailMode_min(vec3 c1, vec3 c2) {\n    return min(c1, c2);\n}\n\nvec3 detailMode_max(vec3 c1, vec3 c2) {\n    return max(c1, c2);\n}\n",diffusePS:"\n#ifdef MAPCOLOR\nuniform vec3 material_diffuse;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseMap;\n#endif\n\nvoid getAlbedo() {\n    dAlbedo = vec3(1.0);\n\n#ifdef MAPCOLOR\n    dAlbedo *= material_diffuse.rgb;\n#endif\n\n#ifdef MAPTEXTURE\n    vec3 albedoBase = gammaCorrectInput(texture2DBias(texture_diffuseMap, $UV, textureBias).$CH);\n    dAlbedo *= addAlbedoDetail(albedoBase);\n#endif\n\n#ifdef MAPVERTEX\n    dAlbedo *= gammaCorrectInput(saturate(vVertexColor.$VC));\n#endif\n}\n",diffuseDetailMapPS:"\n#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseDetailMap;\n#endif\n\nvec3 addAlbedoDetail(vec3 albedo) {\n#ifdef MAPTEXTURE\n    vec3 albedoDetail = gammaCorrectInput(texture2DBias(texture_diffuseDetailMap, $UV, textureBias).$CH);\n    return detailMode_$DETAILMODE(albedo, albedoDetail);\n#else\n    return albedo;\n#endif\n}\n",decodePS:Fo,emissivePS:"\n#ifdef MAPCOLOR\nuniform vec3 material_emissive;\n#endif\n\n#ifdef MAPFLOAT\nuniform float material_emissiveIntensity;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_emissiveMap;\n#endif\n\nvoid getEmission() {\n    dEmission = vec3(1.0);\n\n    #ifdef MAPFLOAT\n    dEmission *= material_emissiveIntensity;\n    #endif\n\n    #ifdef MAPCOLOR\n    dEmission *= material_emissive;\n    #endif\n\n    #ifdef MAPTEXTURE\n    dEmission *= $DECODE(texture2DBias(texture_emissiveMap, $UV, textureBias)).$CH;\n    #endif\n\n    #ifdef MAPVERTEX\n    dEmission *= gammaCorrectInput(saturate(vVertexColor.$VC));\n    #endif\n}\n",encodePS:ko,endPS:"\n    gl_FragColor.rgb = combineColor();\n\n    gl_FragColor.rgb += dEmission;\n    gl_FragColor.rgb = addFog(gl_FragColor.rgb);\n\n    #ifndef HDR\n    gl_FragColor.rgb = toneMap(gl_FragColor.rgb);\n    gl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n    #endif\n",endVS:"\n",envAtlasPS:"\n// the envAtlas is fixed at 512 pixels. every equirect is generated with 1 pixel boundary.\nconst float atlasSize = 512.0;\nconst float seamSize = 1.0 / atlasSize;\n\n// map a normalized equirect UV to the given rectangle (taking 1 pixel seam into account).\nvec2 mapUv(vec2 uv, vec4 rect) {\n    return vec2(mix(rect.x + seamSize, rect.x + rect.z - seamSize, uv.x),\n                mix(rect.y + seamSize, rect.y + rect.w - seamSize, uv.y));\n}\n\n// map a normalized equirect UV and roughness level to the correct atlas rect.\nvec2 mapRoughnessUv(vec2 uv, float level) {\n    float t = 1.0 / exp2(level);\n    return mapUv(uv, vec4(0, 1.0 - t, t, t * 0.5));\n}\n\n// map shiny level UV\nvec2 mapShinyUv(vec2 uv, float level) {\n    float t = 1.0 / exp2(level);\n    return mapUv(uv, vec4(1.0 - t, 1.0 - t, t, t * 0.5));\n}\n",envConstPS:"\nvec3 processEnvironment(vec3 color) {\n    return color;\n}\n",envMultiplyPS:"\nuniform float skyboxIntensity;\n\nvec3 processEnvironment(vec3 color) {\n    return color * skyboxIntensity;\n}\n",extensionPS:"\n",extensionVS:"\n",falloffInvSquaredPS:"\nfloat getFalloffWindow(float lightRadius) {\n    float sqrDist = dot(dLightDirW, dLightDirW);\n    float invRadius = 1.0 / lightRadius;\n    return square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n}\n\nfloat getFalloffInvSquared(float lightRadius) {\n    float sqrDist = dot(dLightDirW, dLightDirW);\n    float falloff = 1.0 / (sqrDist + 1.0);\n    float invRadius = 1.0 / lightRadius;\n\n    falloff *= 16.0;\n    falloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n\n    return falloff;\n}\n",falloffLinearPS:"\nfloat getFalloffLinear(float lightRadius) {\n    float d = length(dLightDirW);\n    return max(((lightRadius - d) / lightRadius), 0.0);\n}\n",fixCubemapSeamsNonePS:"\nvec3 fixSeams(vec3 vec, float mipmapIndex) {\n    return vec;\n}\n\nvec3 fixSeams(vec3 vec) {\n    return vec;\n}\n\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n    return vec;\n}\n\nvec3 calcSeam(vec3 vec) {\n    return vec3(0);\n}\n\nvec3 applySeam(vec3 vec, vec3 seam, float scale) {\n    return vec;\n}\n",fixCubemapSeamsStretchPS:"\nvec3 fixSeams(vec3 vec, float mipmapIndex) {\n    vec3 avec = abs(vec);\n    float scale = 1.0 - exp2(mipmapIndex) / 128.0;\n    float M = max(max(avec.x, avec.y), avec.z);\n    if (avec.x != M) vec.x *= scale;\n    if (avec.y != M) vec.y *= scale;\n    if (avec.z != M) vec.z *= scale;\n    return vec;\n}\n\nvec3 fixSeams(vec3 vec) {\n    vec3 avec = abs(vec);\n    float scale = 1.0 - 1.0 / 128.0;\n    float M = max(max(avec.x, avec.y), avec.z);\n    if (avec.x != M) vec.x *= scale;\n    if (avec.y != M) vec.y *= scale;\n    if (avec.z != M) vec.z *= scale;\n    return vec;\n}\n\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n    vec3 avec = abs(vec);\n    float scale = invRecMipSize;\n    float M = max(max(avec.x, avec.y), avec.z);\n    if (avec.x != M) vec.x *= scale;\n    if (avec.y != M) vec.y *= scale;\n    if (avec.z != M) vec.z *= scale;\n    return vec;\n}\n\nvec3 calcSeam(vec3 vec) {\n    vec3 avec = abs(vec);\n    float M = max(avec.x, max(avec.y, avec.z));\n    return vec3(avec.x != M ? 1.0 : 0.0,\n                avec.y != M ? 1.0 : 0.0,\n                avec.z != M ? 1.0 : 0.0);\n}\n\nvec3 applySeam(vec3 vec, vec3 seam, float scale) {\n    return vec * (seam * -scale + vec3(1.0));\n}\n",floatUnpackingPS:"\n// float unpacking functionality, complimentary to float-packing.js\nfloat bytes2float2(vec2 data) {\n    return dot(data, vec2(1.0, 1.0 / 255.0));\n}\n\nfloat bytes2float3(vec3 data) {\n    return dot(data, vec3(1.0, 1.0 / 255.0, 1.0 / 65025.0));\n}\n\nfloat bytes2float4(vec4 data) {\n    return dot(data, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nfloat bytes2floatRange2(vec2 data, float min, float max) {\n    return mix(min, max, bytes2float2(data));\n}\n\nfloat bytes2floatRange3(vec3 data, float min, float max) {\n    return mix(min, max, bytes2float3(data));\n}\n\nfloat bytes2floatRange4(vec4 data, float min, float max) {\n    return mix(min, max, bytes2float4(data));\n}\n\nfloat mantissaExponent2Float(vec4 pack)\n{\n    float value = bytes2floatRange3(pack.xyz, -1.0, 1.0);\n    float exponent = floor(pack.w * 255.0 - 127.0);\n    return value * exp2(exponent);\n}\n",fogExpPS:"\nuniform vec3 fog_color;\nuniform float fog_density;\nfloat dBlendModeFogFactor = 1.0;\n\nvec3 addFog(vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = exp(-depth * fog_density);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    return mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogExp2PS:"\nuniform vec3 fog_color;\nuniform float fog_density;\nfloat dBlendModeFogFactor = 1.0;\n\nvec3 addFog(vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = exp(-depth * depth * fog_density * fog_density);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    return mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogLinearPS:"\nuniform vec3 fog_color;\nuniform float fog_start;\nuniform float fog_end;\nfloat dBlendModeFogFactor = 1.0;\n\nvec3 addFog(vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = (fog_end - depth) / (fog_end - fog_start);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    return mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogNonePS:"\nfloat dBlendModeFogFactor = 1.0;\n\nvec3 addFog(vec3 color) {\n    return color;\n}\n",fresnelSchlickPS:"\n// Schlick's approximation\nvec3 getFresnel(float cosTheta, vec3 f0) {\n    float fresnel = pow(1.0 - max(cosTheta, 0.0), 5.0);\n    float glossSq = dGlossiness * dGlossiness;\n    return f0 + (max(vec3(glossSq), f0) - f0) * fresnel;\n}\n",fullscreenQuadPS:"\nvarying vec2 vUv0;\n\nuniform sampler2D source;\n\nvoid main(void) {\n    gl_FragColor = texture2D(source, vUv0);\n}\n",fullscreenQuadVS:"\nattribute vec2 vertex_position;\n\nvarying vec2 vUv0;\n\nvoid main(void)\n{\n    gl_Position = vec4(vertex_position, 0.5, 1.0);\n    vUv0 = vertex_position.xy*0.5+0.5;\n}\n",gamma1_0PS:"\nfloat gammaCorrectInput(float color) {\n    return color;\n}\n\nvec3 gammaCorrectInput(vec3 color) {\n    return color;\n}\n\nvec4 gammaCorrectInput(vec4 color) {\n    return color;\n}\n\nvec3 gammaCorrectOutput(vec3 color) {\n    return color;\n}\n",gamma2_2PS:"\nfloat gammaCorrectInput(float color) {\n    return decodeGamma(color);\n}\n\nvec3 gammaCorrectInput(vec3 color) {\n    return decodeGamma(color);\n}\n\nvec4 gammaCorrectInput(vec4 color) {\n    return vec4(decodeGamma(color.xyz), color.w);\n}\n\nvec3 gammaCorrectOutput(vec3 color) {\n#ifdef HDR\n    return color;\n#else\n    return pow(color + 0.0000001, vec3(1.0 / 2.2));\n#endif\n}\n",gles2PS:"\n#define texture2DBias texture2D\n",gles3PS:"\n#define varying in\nout highp vec4 pc_fragColor;\n#define gl_FragColor pc_fragColor\n#define texture2D texture\n#define texture2DBias texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n#define GL2\n#define SUPPORTS_TEXLOD\n",gles3VS:"\n#define attribute in\n#define varying out\n#define texture2D texture\n#define GL2\n#define VERTEXSHADER\n",glossPS:"\n#ifdef MAPFLOAT\nuniform float material_shininess;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_glossMap;\n#endif\n\nvoid getGlossiness() {\n    dGlossiness = 1.0;\n\n    #ifdef MAPFLOAT\n    dGlossiness *= material_shininess;\n    #endif\n\n    #ifdef MAPTEXTURE\n    dGlossiness *= texture2DBias(texture_glossMap, $UV, textureBias).$CH;\n    #endif\n\n    #ifdef MAPVERTEX\n    dGlossiness *= saturate(vVertexColor.$VC);\n    #endif\n\n    dGlossiness += 0.0000001;\n}\n",instancingVS:"\nattribute vec4 instance_line1;\nattribute vec4 instance_line2;\nattribute vec4 instance_line3;\nattribute vec4 instance_line4;\n",lightDiffuseLambertPS:"\nfloat getLightDiffuse() {\n    return max(dot(dNormalW, -dLightDirNormW), 0.0);\n}\n",lightDirPointPS:"\nvoid getLightDirPoint(vec3 lightPosW) {\n    dLightDirW = vPositionW - lightPosW;\n    dLightDirNormW = normalize(dLightDirW);\n    dLightPosW = lightPosW;\n}\n",lightmapAddPS:"\nvoid addLightMap() {\n    dDiffuseLight += dLightmap;\n}\n",lightmapDirAddPS:"\nvoid addLightMap() {\n    if (dot(dLightmapDir, dLightmapDir) < 0.0001) {\n        dDiffuseLight += dLightmap;\n    } else {\n        dLightDirNormW = dLightmapDir;\n\n        float vlight = saturate(dot(dLightDirNormW, -dVertexNormalW));\n        float flight = saturate(dot(dLightDirNormW, -dNormalW));\n        float nlight = (flight / max(vlight, 0.01)) * 0.5;\n\n        dDiffuseLight += dLightmap * nlight * 2.0;\n\n        vec3 halfDirW = normalize(-dLightmapDir + dViewDirW);\n        vec3 specularLight = dLightmap * getLightSpecular(halfDirW);\n\n        #ifdef LIT_SPECULAR_FRESNEL\n        specularLight *= getFresnel(dot(dViewDirW, halfDirW), dSpecularity);\n        #endif\n\n        dSpecularLight += specularLight;\n    }\n}\n",lightmapDirPS:"\nuniform sampler2D texture_lightMap;\nuniform sampler2D texture_dirLightMap;\n\nvoid getLightMap() {\n    dLightmap = $DECODE(texture2DBias(texture_lightMap, $UV, textureBias)).$CH;\n\n    vec3 dir = texture2DBias(texture_dirLightMap, $UV, textureBias).xyz * 2.0 - 1.0;\n    float dirDot = dot(dir, dir);\n    dLightmapDir = (dirDot > 0.001) ? dir / sqrt(dirDot) : vec3(0.0);\n}\n",lightmapSinglePS:"\n#ifdef MAPTEXTURE\nuniform sampler2D texture_lightMap;\n#endif\n\nvoid getLightMap() {\n    dLightmap = vec3(1.0);\n\n    #ifdef MAPTEXTURE\n    dLightmap *= $DECODE(texture2DBias(texture_lightMap, $UV, textureBias)).$CH;\n    #endif\n\n    #ifdef MAPVERTEX\n    dLightmap *= saturate(vVertexColor.$VC);\n    #endif\n}\n",lightSpecularAnisoGGXPS:"\n// Anisotropic GGX\nfloat calcLightSpecular(float tGlossiness, vec3 tNormalW, vec3 h) {\n    float PI = 3.141592653589793;\n    float roughness = max((1.0 - tGlossiness) * (1.0 - tGlossiness), 0.001);\n    float anisotropy = material_anisotropy * roughness;\n \n    float at = max((roughness + anisotropy), roughness / 4.0);\n    float ab = max((roughness - anisotropy), roughness / 4.0);\n\n    float NoH = dot(tNormalW, h);\n    float ToH = dot(dTBN[0], h);\n    float BoH = dot(dTBN[1], h);\n\n    float a2 = at * ab;\n    vec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);\n    float v2 = dot(v, v);\n    float w2 = a2 / v2;\n    float D = a2 * w2 * w2 * (1.0 / PI);\n\n    float ToV = dot(dTBN[0], dViewDirW);\n    float BoV = dot(dTBN[1], dViewDirW);\n    float ToL = dot(dTBN[0], -dLightDirNormW);\n    float BoL = dot(dTBN[1], -dLightDirNormW);\n    float NoV = dot(tNormalW, dViewDirW);\n    float NoL = dot(tNormalW, -dLightDirNormW);\n\n    float lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));\n    float lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));\n    float G = 0.5 / (lambdaV + lambdaL);\n\n    return D * G;\n}\n\nfloat getLightSpecular(vec3 h) {\n    return calcLightSpecular(dGlossiness, dNormalW, h);\n}\n\n#ifdef LIT_CLEARCOAT\nfloat getLightSpecularCC(vec3 h) {\n    return calcLightSpecular(ccGlossiness, ccNormalW, h);\n}\n#endif\n",lightSpecularBlinnPS:"\n// Energy-conserving (hopefully) Blinn-Phong\nfloat calcLightSpecular(float tGlossiness, vec3 tNormalW, vec3 h) {\n    float nh = max( dot( h, tNormalW ), 0.0 );\n\n    float specPow = exp2(tGlossiness * 11.0); // glossiness is linear, power is not; 0 - 2048\n\n    // Hack: On Mac OS X, calling pow with zero for the exponent generates hideous artifacts so bias up a little\n    specPow = max(specPow, 0.0001);\n\n    return pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\n\nfloat getLightSpecular(vec3 h) {\n    return calcLightSpecular(dGlossiness, dNormalW, h);\n}\n\n#ifdef LIT_CLEARCOAT\nfloat getLightSpecularCC(vec3 h) {\n    return calcLightSpecular(ccGlossiness, ccNormalW, h);\n}\n#endif\n",lightSpecularPhongPS:"\nfloat calcLightSpecular(float tGlossiness, vec3 tReflDirW, vec3 h) {\n    float specPow = tGlossiness;\n\n    // Hack: On Mac OS X, calling pow with zero for the exponent generates hideous artifacts so bias up a little\n    return pow(max(dot(tReflDirW, -dLightDirNormW), 0.0), specPow + 0.0001);\n}\n\nfloat getLightSpecular(vec3 h) {\n    return calcLightSpecular(dGlossiness, dReflDirW, h);\n}\n\n#ifdef LIT_CLEARCOAT\nfloat getLightSpecularCC(vec3 h) {\n    return calcLightSpecular(ccGlossiness, ccReflDirW,h );\n}\n#endif\n",lightSheenPS:"\n\nfloat sheenD(vec3 normal, vec3 h, float roughness) {\n    float invR = 1.0 / (roughness * roughness);\n    float cos2h = max(dot(normal, h), 0.0);\n    cos2h *= cos2h;\n    float sin2h = max(1.0 - cos2h, 0.0078125);\n    return (2.0 + invR) * pow(sin2h, invR * 0.5) / (2.0 * PI);\n}\n\nfloat sheenV(vec3 normal, vec3 view, vec3 light) {\n    float NoV = max(dot(normal, view), 0.000001);\n    float NoL = max(dot(normal, light), 0.000001);\n    return 1.0 / (4.0 * (NoL + NoV - NoL * NoV));\n}\n\nfloat getLightSpecularSheen(vec3 h) {\n    float D = sheenD(dNormalW, h, sGlossiness);\n    float V = sheenV(dNormalW, dViewDirW, -dLightDirNormW);\n    return D * V;\n}\n",ltc:'\n// Real-Time Polygonal-Light Shading with Linearly Transformed Cosines\n// by Eric Heitz, Jonathan Dupuy, Stephen Hill and David Neubelt\n// code: https://github.com/selfshadow/ltc_code/\n\nmat3 transposeMat3( const in mat3 m ) {\n    mat3 tmp;\n    tmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n    tmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n    tmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n    return tmp;\n}\n\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n    const float LUT_SIZE = 64.0;\n    const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n    const float LUT_BIAS = 0.5 / LUT_SIZE;\n    float dotNV = saturate( dot( N, V ) );\n    // texture parameterized by sqrt( GGX alpha ) and sqrt( 1 - cos( theta ) )\n    vec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n    uv = uv * LUT_SCALE + LUT_BIAS;\n    return uv;\n}\n\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n    // Real-Time Area Lighting: a Journey from Research to Production (p.102)\n    // An approximation of the form factor of a horizon-clipped rectangle.\n    float l = length( f );\n    return max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\n\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n    float x = dot( v1, v2 );\n    float y = abs( x );\n    // rational polynomial approximation to theta / sin( theta ) / 2PI\n    float a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n    float b = 3.4175940 + ( 4.1616724 + y ) * y;\n    float v = a / b;\n    float theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n    return cross( v1, v2 ) * theta_sintheta;\n}\n\nstruct Coords {\n    vec3 coord0;\n    vec3 coord1;\n    vec3 coord2;\n    vec3 coord3;\n};\n\nfloat LTC_EvaluateRect( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in Coords rectCoords) {\n    // bail if point is on back side of plane of light\n    // assumes ccw winding order of light vertices\n    vec3 v1 = rectCoords.coord1 - rectCoords.coord0;\n    vec3 v2 = rectCoords.coord3 - rectCoords.coord0;\n    \n    vec3 lightNormal = cross( v1, v2 );\n    // if( dot( lightNormal, P - rectCoords.coord0 ) < 0.0 ) return 0.0;\n    float factor = sign(-dot( lightNormal, P - rectCoords.coord0 ));\n\n    // construct orthonormal basis around N\n    vec3 T1, T2;\n    T1 = normalize( V - N * dot( V, N ) );\n    T2 =  factor * cross( N, T1 ); // negated from paper; possibly due to a different handedness of world coordinate system\n    // compute transform\n    mat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n    // transform rect\n    vec3 coords[ 4 ];\n    coords[ 0 ] = mat * ( rectCoords.coord0 - P );\n    coords[ 1 ] = mat * ( rectCoords.coord1 - P );\n    coords[ 2 ] = mat * ( rectCoords.coord2 - P );\n    coords[ 3 ] = mat * ( rectCoords.coord3 - P );\n    // project rect onto sphere\n    coords[ 0 ] = normalize( coords[ 0 ] );\n    coords[ 1 ] = normalize( coords[ 1 ] );\n    coords[ 2 ] = normalize( coords[ 2 ] );\n    coords[ 3 ] = normalize( coords[ 3 ] );\n    // calculate vector form factor\n    vec3 vectorFormFactor = vec3( 0.0 );\n    vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n    vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n    vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n    vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n    // adjust for horizon clipping\n    float result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\n    return result;\n}\n\nCoords dLTCCoords;\nCoords getLTCLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n    Coords coords;\n    coords.coord0 = lightPos + halfWidth - halfHeight;\n    coords.coord1 = lightPos - halfWidth - halfHeight;\n    coords.coord2 = lightPos - halfWidth + halfHeight;\n    coords.coord3 = lightPos + halfWidth + halfHeight;\n    return coords;\n}\n\nfloat dSphereRadius;\nCoords getSphereLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n    // used for simple sphere light falloff\n    // also, the code only handles a spherical light, it cannot be non-uniformly scaled in world space, and so we enforce it here\n    dSphereRadius = max(length(halfWidth), length(halfHeight));\n\n    // Billboard the 2d light quad to reflection vector, as it\'s used for specular. This allows us to use disk math for the sphere.\n    vec3 f = reflect(normalize(lightPos - view_position), vNormalW);\n    vec3 w = normalize(cross(f, halfHeight));\n    vec3 h = normalize(cross(f, w));\n\n    return getLTCLightCoords(lightPos, w * dSphereRadius, h * dSphereRadius);\n}\n\n// used for LTC LUT texture lookup\nvec2 dLTCUV;\n#ifdef LIT_CLEARCOAT\nvec2 ccLTCUV;\n#endif\nvec2 getLTCLightUV(float tGlossiness, vec3 tNormalW)\n{\n    float roughness = max((1.0 - tGlossiness) * (1.0 - tGlossiness), 0.001);\n    return LTC_Uv( tNormalW, dViewDirW, roughness );\n}\n\n//used for energy conservation and to modulate specular\nvec3 dLTCSpecFres;\n#ifdef LIT_CLEARCOAT\nvec3 ccLTCSpecFres;\n#endif\nvec3 getLTCLightSpecFres(vec2 uv, vec3 tSpecularity)\n{\n    vec4 t2 = texture2D( areaLightsLutTex2, uv );\n\n    #ifdef AREA_R8_G8_B8_A8_LUTS\n    t2 *= vec4(0.693103,1,1,1);\n    t2 += vec4(0.306897,0,0,0);\n    #endif\n\n    return tSpecularity * t2.x + ( vec3( 1.0 ) - tSpecularity) * t2.y;\n}\n\nvoid calcLTCLightValues()\n{\n    dLTCUV = getLTCLightUV(dGlossiness, dNormalW);\n    dLTCSpecFres = getLTCLightSpecFres(dLTCUV, dSpecularity); \n\n#ifdef LIT_CLEARCOAT\n    ccLTCUV = getLTCLightUV(ccGlossiness, ccNormalW);\n    ccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, vec3(ccSpecularity));\n#endif\n}\n\nvoid calcRectLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n    dLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);\n}\nvoid calcDiskLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n    calcRectLightValues(lightPos, halfWidth, halfHeight);\n}\nvoid calcSphereLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n    dLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);\n}\n\n// An extended version of the implementation from\n// "How to solve a cubic equation, revisited"\n// http://momentsingraphics.de/?p=105\nvec3 SolveCubic(vec4 Coefficient)\n{\n    float pi = 3.14159;\n    // Normalize the polynomial\n    Coefficient.xyz /= Coefficient.w;\n    // Divide middle coefficients by three\n    Coefficient.yz /= 3.0;\n\n    float A = Coefficient.w;\n    float B = Coefficient.z;\n    float C = Coefficient.y;\n    float D = Coefficient.x;\n\n    // Compute the Hessian and the discriminant\n    vec3 Delta = vec3(\n        -Coefficient.z * Coefficient.z + Coefficient.y,\n        -Coefficient.y * Coefficient.z + Coefficient.x,\n        dot(vec2(Coefficient.z, -Coefficient.y), Coefficient.xy)\n    );\n\n    float Discriminant = dot(vec2(4.0 * Delta.x, -Delta.y), Delta.zy);\n\n    vec3 RootsA, RootsD;\n\n    vec2 xlc, xsc;\n\n    // Algorithm A\n    {\n        float A_a = 1.0;\n        float C_a = Delta.x;\n        float D_a = -2.0 * B * Delta.x + Delta.y;\n\n        // Take the cubic root of a normalized complex number\n        float Theta = atan(sqrt(Discriminant), -D_a) / 3.0;\n\n        float x_1a = 2.0 * sqrt(-C_a) * cos(Theta);\n        float x_3a = 2.0 * sqrt(-C_a) * cos(Theta + (2.0 / 3.0) * pi);\n\n        float xl;\n        if ((x_1a + x_3a) > 2.0 * B)\n            xl = x_1a;\n        else\n            xl = x_3a;\n\n        xlc = vec2(xl - B, A);\n    }\n\n    // Algorithm D\n    {\n        float A_d = D;\n        float C_d = Delta.z;\n        float D_d = -D * Delta.y + 2.0 * C * Delta.z;\n\n        // Take the cubic root of a normalized complex number\n        float Theta = atan(D * sqrt(Discriminant), -D_d) / 3.0;\n\n        float x_1d = 2.0 * sqrt(-C_d) * cos(Theta);\n        float x_3d = 2.0 * sqrt(-C_d) * cos(Theta + (2.0 / 3.0) * pi);\n\n        float xs;\n        if (x_1d + x_3d < 2.0 * C)\n            xs = x_1d;\n        else\n            xs = x_3d;\n\n        xsc = vec2(-D, xs + C);\n    }\n\n    float E =  xlc.y * xsc.y;\n    float F = -xlc.x * xsc.y - xlc.y * xsc.x;\n    float G =  xlc.x * xsc.x;\n\n    vec2 xmc = vec2(C * F - B * G, -B * F + C * E);\n\n    vec3 Root = vec3(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);\n\n    if (Root.x < Root.y && Root.x < Root.z)\n        Root.xyz = Root.yxz;\n    else if (Root.z < Root.x && Root.z < Root.y)\n        Root.xyz = Root.xzy;\n\n    return Root;\n}\n\nfloat LTC_EvaluateDisk(vec3 N, vec3 V, vec3 P, mat3 Minv, Coords points)\n{\n    // construct orthonormal basis around N\n    vec3 T1, T2;\n    T1 = normalize(V - N * dot(V, N));\n    T2 = cross(N, T1);\n\n    // rotate area light in (T1, T2, N) basis\n    //mat3 R = transpose(mat3(T1, T2, N));\n    mat3 R = transposeMat3( mat3( T1, T2, N ) );\n    // polygon (allocate 5 vertices for clipping)\n    vec3 L_[ 3 ];\n    L_[ 0 ] = R * ( points.coord0 - P );\n    L_[ 1 ] = R * ( points.coord1 - P );\n    L_[ 2 ] = R * ( points.coord2 - P );\n\n    vec3 Lo_i = vec3(0);\n\n    // init ellipse\n    vec3 C  = 0.5 * (L_[0] + L_[2]);\n    vec3 V1 = 0.5 * (L_[1] - L_[2]);\n    vec3 V2 = 0.5 * (L_[1] - L_[0]);\n\n    C  = Minv * C;\n    V1 = Minv * V1;\n    V2 = Minv * V2;\n\n    //if(dot(cross(V1, V2), C) > 0.0)\n    //    return 0.0;\n\n    // compute eigenvectors of ellipse\n    float a, b;\n    float d11 = dot(V1, V1);\n    float d22 = dot(V2, V2);\n    float d12 = dot(V1, V2);\n    if (abs(d12) / sqrt(d11 * d22) > 0.0001)\n    {\n        float tr = d11 + d22;\n        float det = -d12 * d12 + d11 * d22;\n\n        // use sqrt matrix to solve for eigenvalues\n        det = sqrt(det);\n        float u = 0.5 * sqrt(tr - 2.0 * det);\n        float v = 0.5 * sqrt(tr + 2.0 * det);\n        float e_max = (u + v) * (u + v);\n        float e_min = (u - v) * (u - v);\n\n        vec3 V1_, V2_;\n\n        if (d11 > d22)\n        {\n            V1_ = d12 * V1 + (e_max - d11) * V2;\n            V2_ = d12 * V1 + (e_min - d11) * V2;\n        }\n        else\n        {\n            V1_ = d12*V2 + (e_max - d22)*V1;\n            V2_ = d12*V2 + (e_min - d22)*V1;\n        }\n\n        a = 1.0 / e_max;\n        b = 1.0 / e_min;\n        V1 = normalize(V1_);\n        V2 = normalize(V2_);\n    }\n    else\n    {\n        a = 1.0 / dot(V1, V1);\n        b = 1.0 / dot(V2, V2);\n        V1 *= sqrt(a);\n        V2 *= sqrt(b);\n    }\n\n    vec3 V3 = cross(V1, V2);\n    if (dot(C, V3) < 0.0)\n        V3 *= -1.0;\n\n    float L  = dot(V3, C);\n    float x0 = dot(V1, C) / L;\n    float y0 = dot(V2, C) / L;\n\n    float E1 = inversesqrt(a);\n    float E2 = inversesqrt(b);\n\n    a *= L * L;\n    b *= L * L;\n\n    float c0 = a * b;\n    float c1 = a * b * (1.0 + x0 * x0 + y0 * y0) - a - b;\n    float c2 = 1.0 - a * (1.0 + x0 * x0) - b * (1.0 + y0 * y0);\n    float c3 = 1.0;\n\n    vec3 roots = SolveCubic(vec4(c0, c1, c2, c3));\n    float e1 = roots.x;\n    float e2 = roots.y;\n    float e3 = roots.z;\n\n    vec3 avgDir = vec3(a * x0 / (a - e2), b * y0 / (b - e2), 1.0);\n\n    mat3 rotate = mat3(V1, V2, V3);\n\n    avgDir = rotate * avgDir;\n    avgDir = normalize(avgDir);\n\n    float L1 = sqrt(-e2 / e3);\n    float L2 = sqrt(-e2 / e1);\n\n    float formFactor = L1 * L2 * inversesqrt((1.0 + L1 * L1) * (1.0 + L2 * L2));\n    \n    const float LUT_SIZE = 64.0;\n    const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n    const float LUT_BIAS = 0.5 / LUT_SIZE;\n\n    // use tabulated horizon-clipped sphere\n    vec2 uv = vec2(avgDir.z * 0.5 + 0.5, formFactor);\n    uv = uv*LUT_SCALE + LUT_BIAS;\n\n    float scale = texture2D( areaLightsLutTex2, uv ).w;\n\n    return formFactor*scale;\n}\n\nfloat getRectLightDiffuse() {\n    return LTC_EvaluateRect( dNormalW, dViewDirW, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\n\nfloat getDiskLightDiffuse() {\n    return LTC_EvaluateDisk( dNormalW, dViewDirW, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\n\nfloat getSphereLightDiffuse() {\n    // NB: this could be improved further with distance based wrap lighting\n    float falloff = dSphereRadius / (dot(dLightDirW, dLightDirW) + dSphereRadius);\n    return getLightDiffuse()*falloff;\n}\n\nmat3 getLTCLightInvMat(vec2 uv)\n{\n    vec4 t1 = texture2D( areaLightsLutTex1, uv );\n\n    #ifdef AREA_R8_G8_B8_A8_LUTS\n    t1 *= vec4(1.001, 0.3239, 0.60437568, 1.0);\n    t1 += vec4(0.0, -0.2976, -0.01381, 0.0);\n    #endif\n\n    return mat3(\n        vec3( t1.x, 0, t1.y ),\n        vec3(    0, 1,    0 ),\n        vec3( t1.z, 0, t1.w )\n    );\n}\n\nfloat calcRectLightSpecular(vec3 tNormalW, vec2 uv) {\n    mat3 mInv = getLTCLightInvMat(uv);\n    return LTC_EvaluateRect( tNormalW, dViewDirW, vPositionW, mInv, dLTCCoords );\n}\n\nfloat getRectLightSpecular() {\n    return calcRectLightSpecular(dNormalW, dLTCUV);\n}\n\n#ifdef LIT_CLEARCOAT\nfloat getRectLightSpecularCC() {\n    return calcRectLightSpecular(ccNormalW, ccLTCUV);\n}\n#endif\n\nfloat calcDiskLightSpecular(vec3 tNormalW, vec2 uv) {\n    mat3 mInv = getLTCLightInvMat(uv);\n    return LTC_EvaluateDisk( tNormalW, dViewDirW, vPositionW, mInv, dLTCCoords );\n}\n\nfloat getDiskLightSpecular() {\n    return calcDiskLightSpecular(dNormalW, dLTCUV);\n}\n\n#ifdef LIT_CLEARCOAT\nfloat getDiskLightSpecularCC() {\n    return calcDiskLightSpecular(ccNormalW, ccLTCUV);\n}\n#endif\n\nfloat getSphereLightSpecular() {\n    return calcDiskLightSpecular(dNormalW, dLTCUV);\n}\n\n#ifdef LIT_CLEARCOAT\nfloat getSphereLightSpecularCC() {\n    return calcDiskLightSpecular(ccNormalW, ccLTCUV);\n}\n#endif\n',metalnessPS:"\n#ifdef MAPFLOAT\nuniform float material_metalness;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_metalnessMap;\n#endif\n\nvoid getMetalness() {\n    float metalness = 1.0;\n\n    #ifdef MAPFLOAT\n    metalness *= material_metalness;\n    #endif\n\n    #ifdef MAPTEXTURE\n    metalness *= texture2DBias(texture_metalnessMap, $UV, textureBias).$CH;\n    #endif\n\n    #ifdef MAPVERTEX\n    metalness *= saturate(vVertexColor.$VC);\n    #endif\n\n    dMetalness = metalness;\n}\n",metalnessModulatePS:"\n\nuniform float material_f0;\n\nvoid getMetalnessModulate() {\n    vec3 dielectricF0 = material_f0 * dSpecularity;\n    dSpecularity = mix(dielectricF0, dAlbedo, dMetalness);\n    dAlbedo *= 1.0 - dMetalness;\n}\n",msdfPS:"\nuniform sampler2D texture_msdfMap;\n\n#ifdef GL_OES_standard_derivatives\n#define USE_FWIDTH\n#endif\n\n#ifdef GL2\n#define USE_FWIDTH\n#endif\n\nfloat median(float r, float g, float b) {\n    return max(min(r, g), min(max(r, g), b));\n}\n\nfloat map (float min, float max, float v) {\n    return (v - min) / (max - min);\n}\n\nuniform float font_sdfIntensity; // intensity is used to boost the value read from the SDF, 0 is no boost, 1.0 is max boost\nuniform float font_pxrange;      // the number of pixels between inside and outside the font in SDF\nuniform float font_textureWidth; // the width of the texture atlas\n\n#ifdef UNIFORM_TEXT_PARAMETERS\nuniform vec4 outline_color;\nuniform float outline_thickness;\nuniform vec4 shadow_color;\nuniform vec2 shadow_offset;\n#else\nvarying vec4 outline_color;\nvarying float outline_thickness;\nvarying vec4 shadow_color;\nvarying vec2 shadow_offset;\n#endif\n\nvec4 applyMsdf(vec4 color) {\n    // sample the field\n    vec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;\n    vec2 uvShdw = vUv0 - shadow_offset;\n    vec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;\n    // get the signed distance value\n    float sigDist = median(tsample.r, tsample.g, tsample.b);\n    float sigDistShdw = median(ssample.r, ssample.g, ssample.b);\n\n    // smoothing limit - smaller value makes for sharper but more aliased text, especially on angles\n    // too large value (0.5) creates a dark glow around the letters\n    float smoothingMax = 0.2;\n\n    #ifdef USE_FWIDTH\n    // smoothing depends on size of texture on screen\n    vec2 w = fwidth(vUv0);\n    float smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, smoothingMax);\n    #else\n    float font_size = 16.0; // TODO fix this\n    // smoothing gets smaller as the font size gets bigger\n    // don't have fwidth we can approximate from font size, this doesn't account for scaling\n    // so a big font scaled down will be wrong...\n    float smoothing = clamp(font_pxrange / font_size, 0.0, smoothingMax);\n    #endif\n\n    float mapMin = 0.05;\n    float mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);\n\n    // remap to a smaller range (used on smaller font sizes)\n    float sigDistInner = map(mapMin, mapMax, sigDist);\n    float sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);\n    sigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);\n\n    float center = 0.5;\n    // calculate smoothing and use to generate opacity\n    float inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);\n    float outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);\n    float shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);\n\n    vec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);\n    tcolor = mix(tcolor, color, inside);\n\n    vec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;\n    tcolor = mix(scolor, tcolor, outline);\n    \n    return tcolor;\n}\n",msdfVS:"\nattribute vec3 vertex_outlineParameters;\nattribute vec3 vertex_shadowParameters;\n\nvarying vec4 outline_color;\nvarying float outline_thickness;\nvarying vec4 shadow_color;\nvarying vec2 shadow_offset;\n\nvoid unpackMsdfParams() {\n    outline_color.rb = mod(vertex_outlineParameters.xy, 256.) / 256.;\n    outline_color.ga = vertex_outlineParameters.xy / 256. / 256.;\n\n    // _outlineThicknessScale === 0.2\n    outline_thickness = vertex_outlineParameters.z / 255. * 0.2;\n\n    vec3 little = mod(vertex_shadowParameters, 256.) / 256.;\n    vec3 big = vertex_shadowParameters / 256. / 256.;\n\n    shadow_color.rb = little.xy;\n    shadow_color.ga = big.xy;\n\n    // vec2(little.z, big.z) * 2. srink from (0.5, 0.5) to (1, 1)\n    // _shadowOffsetScale === 0.005\n    shadow_offset = (vec2(little.z, big.z) * 2. - 1.) * 0.005;\n}\n",normalVS:"\n#ifdef MORPHING_TEXTURE_BASED_NORMAL\nuniform highp sampler2D morphNormalTex;\n#endif\n\nvec3 getNormal() {\n    #ifdef SKIN\n    dNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n    #elif defined(INSTANCING)\n    dNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n    #else\n    dNormalMatrix = matrix_normal;\n    #endif\n\n    vec3 tempNormal = vertex_normal;\n\n    #ifdef MORPHING\n    #ifdef MORPHING_NRM03\n    tempNormal += morph_weights_a[0] * morph_nrm0;\n    tempNormal += morph_weights_a[1] * morph_nrm1;\n    tempNormal += morph_weights_a[2] * morph_nrm2;\n    tempNormal += morph_weights_a[3] * morph_nrm3;\n    #endif\n    #ifdef MORPHING_NRM47\n    tempNormal += morph_weights_b[0] * morph_nrm4;\n    tempNormal += morph_weights_b[1] * morph_nrm5;\n    tempNormal += morph_weights_b[2] * morph_nrm6;\n    tempNormal += morph_weights_b[3] * morph_nrm7;\n    #endif\n    #endif\n\n    #ifdef MORPHING_TEXTURE_BASED_NORMAL\n    // apply morph offset from texture\n    vec2 morphUV = getTextureMorphCoords();\n    vec3 morphNormal = texture2D(morphNormalTex, morphUV).xyz;\n    tempNormal += morphNormal;\n    #endif\n\n    return normalize(dNormalMatrix * tempNormal);\n}\n",normalDetailMapPS:"\n#ifdef MAPTEXTURE\nuniform sampler2D texture_normalDetailMap;\nuniform float material_normalDetailMapBumpiness;\n\nvec3 blendNormals(vec3 n1, vec3 n2) {\n    // https://blog.selfshadow.com/publications/blending-in-detail/#detail-oriented\n    n1 += vec3(0, 0, 1);\n    n2 *= vec3(-1, -1, 1);\n    return n1 * dot(n1, n2) / n1.z - n2;\n}\n#endif\n\nvec3 addNormalDetail(vec3 normalMap) {\n#ifdef MAPTEXTURE\n    vec3 normalDetailMap = unpackNormal(texture2DBias(texture_normalDetailMap, $UV, textureBias));\n    normalDetailMap = mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness);\n    return blendNormals(normalMap, normalDetailMap);\n#else\n    return normalMap;\n#endif\n}\n",normalInstancedVS:"\nvec3 getNormal() {\n    dNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n    return normalize(dNormalMatrix * vertex_normal);\n}\n",normalMapPS:"\n#ifdef MAPTEXTURE\nuniform sampler2D texture_normalMap;\nuniform float material_bumpiness;\n#endif\n\nvoid getNormal() {\n#ifdef MAPTEXTURE\n    vec3 normalMap = unpackNormal(texture2DBias(texture_normalMap, $UV, textureBias));\n    normalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness);\n    dNormalW = normalize(dTBN * addNormalDetail(normalMap));\n#else\n    dNormalW = dVertexNormalW;\n#endif\n}\n",normalSkinnedVS:"\nvec3 getNormal() {\n    dNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n    return normalize(dNormalMatrix * vertex_normal);\n}\n",normalXYPS:"\nvec3 unpackNormal(vec4 nmap) {\n    vec3 normal;\n    normal.xy = nmap.wy * 2.0 - 1.0;\n    normal.z = sqrt(1.0 - saturate(dot(normal.xy, normal.xy)));\n    return normal;\n}\n",normalXYZPS:"\nvec3 unpackNormal(vec4 nmap) {\n    return nmap.xyz * 2.0 - 1.0;\n}\n",opacityPS:"\n#ifdef MAPFLOAT\nuniform float material_opacity;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_opacityMap;\n#endif\n\nvoid getOpacity() {\n    dAlpha = 1.0;\n\n    #ifdef MAPFLOAT\n    dAlpha *= material_opacity;\n    #endif\n\n    #ifdef MAPTEXTURE\n    dAlpha *= texture2DBias(texture_opacityMap, $UV, textureBias).$CH;\n    #endif\n\n    #ifdef MAPVERTEX\n    dAlpha *= clamp(vVertexColor.$VC, 0.0, 1.0);\n    #endif\n}\n",outputAlphaPS:"\ngl_FragColor.a = dAlpha;\n",outputAlphaOpaquePS:"\n    gl_FragColor.a = 1.0;\n",outputAlphaPremulPS:"\ngl_FragColor.rgb *= dAlpha;\ngl_FragColor.a = dAlpha;\n",outputTex2DPS:"\nvarying vec2 vUv0;\n\nuniform sampler2D source;\n\nvoid main(void) {\n    gl_FragColor = texture2D(source, vUv0);\n}\n",packDepthPS:"\n// Packing a float in GLSL with multiplication and mod\n// http://blog.gradientstudios.com/2012/08/23/shadow-map-improvement\nvec4 packFloat(float depth) {\n    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\n    // combination of mod and multiplication and division works better\n    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n    res -= res.xxyz * bit_mask;\n    return res;\n}\n",sheenPS:"\n\n#ifdef MAPCOLOR\nuniform vec3 material_sheen;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_sheenMap;\n#endif\n\nvoid getSheen() {\n    vec3 sheenColor = vec3(1, 1, 1);\n\n    #ifdef MAPCOLOR\n    sheenColor *= material_sheen;\n    #endif\n\n    #ifdef MAPTEXTURE\n    sheenColor *= $DECODE(texture2DBias(texture_sheenMap, $UV, textureBias)).$CH;\n    #endif\n\n    #ifdef MAPVERTEX\n    sheenColor *= saturate(vVertexColor.$VC);\n    #endif\n\n    sSpecularity = sheenColor;\n}\n",sheenGlossPS:"\n#ifdef MAPFLOAT\nuniform float material_sheenGlossiness;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_sheenGlossinessMap;\n#endif\n\nvoid getSheenGlossiness() {\n    float sheenGlossiness = 1.0;\n\n    #ifdef MAPFLOAT\n    sheenGlossiness *= material_sheenGlossiness;\n    #endif\n\n    #ifdef MAPTEXTURE\n    sheenGlossiness *= texture2DBias(texture_sheenGlossinessMap, $UV, textureBias).$CH;\n    #endif\n\n    #ifdef MAPVERTEX\n    sheenGlossiness *= saturate(vVertexColor.$VC);\n    #endif\n\n    sheenGlossiness += 0.0000001;\n    sGlossiness = sheenGlossiness;\n}\n",parallaxPS:"\nuniform sampler2D texture_heightMap;\nuniform float material_heightMapFactor;\n\nvoid getParallax() {\n    float parallaxScale = material_heightMapFactor;\n\n    float height = texture2DBias(texture_heightMap, $UV, textureBias).$CH;\n    height = height * parallaxScale - parallaxScale*0.5;\n    vec3 viewDirT = dViewDirW * dTBN;\n\n    viewDirT.z += 0.42;\n    dUvOffset = height * (viewDirT.xy / viewDirT.z);\n}\n",particlePS:"\nvarying vec4 texCoordsAlphaLife;\n\nuniform sampler2D colorMap;\nuniform sampler2D colorParam;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\n\nuniform float softening;\nuniform float colorMult;\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n    const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n    float depth = dot(rgbaDepth, bitShift);\n    return depth;\n}\n#endif\n\nvoid main(void) {\n    vec4 tex  = gammaCorrectInput(texture2D(colorMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y)));\n    vec4 ramp = gammaCorrectInput(texture2D(colorParam, vec2(texCoordsAlphaLife.w, 0.0)));\n    ramp.rgb *= colorMult;\n\n    ramp.a += texCoordsAlphaLife.z;\n\n    vec3 rgb = tex.rgb * ramp.rgb;\n    float a  = tex.a * ramp.a;\n",particleVS:"\nvec3 unpack3NFloats(float src) {\n    float r = fract(src);\n    float g = fract(src * 256.0);\n    float b = fract(src * 65536.0);\n    return vec3(r, g, b);\n}\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nvec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc) {\n    return mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );\n}\n\nvec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {\n    vec4 a = texture2D(tex,tc);\n    vec4 b = texture2D(tex,tc + graphSampleSize);\n    float c = fract(tc.x*graphNumSamples);\n\n    vec3 unpackedA = unpack3NFloats(a.w);\n    vec3 unpackedB = unpack3NFloats(b.w);\n    w = mix(unpackedA, unpackedB, c);\n\n    return mix(a, b, c);\n}\n\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {\n    float c = cos(pRotation);\n    float s = sin(pRotation);\n\n    mat2 m = mat2(c, -s, s, c);\n    rotMatrix = m;\n\n    return m * quadXY;\n}\n\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY) {\n    #ifdef SCREEN_SPACE\n        vec3 pos = vec3(-1, 0, 0) * quadXY.x + vec3(0, -1, 0) * quadXY.y;\n    #else\n        vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n    #endif\n\n    return pos;\n}\n\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY) {\n    vec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n    return pos;\n}\n\nvec2 safeNormalize(vec2 v) {\n    float l = length(v);\n    return (l > 1e-06) ? v / l : v;\n}\n\nvoid main(void) {\n    vec3 meshLocalPos = particle_vertexData.xyz;\n    float id = floor(particle_vertexData.w);\n\n    float rndFactor = fract(sin(id + 1.0 + seed));\n    vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n\n    float uv = id / numParticlesPot;\n    readInput(uv);\n\n#ifdef LOCAL_SPACE\n    inVel = mat3(matrix_model) * inVel;\n#endif\n    vec2 velocityV = safeNormalize((mat3(matrix_view) * inVel).xy); // should be removed by compiler if align/stretch is not used\n\n    float particleLifetime = lifetime;\n\n    if (inLife <= 0.0 || inLife > particleLifetime || !inShow) meshLocalPos = vec3(0.0);\n    vec2 quadXY = meshLocalPos.xy;\n    float nlife = clamp(inLife / particleLifetime, 0.0, 1.0);\n\n    vec3 paramDiv;\n    vec4 params = tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n    float scale = params.y;\n    float scaleDiv = paramDiv.x;\n    float alphaDiv = paramDiv.z;\n\n    scale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);\n\n#ifndef USE_MESH\n    texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#else\n    texCoordsAlphaLife = vec4(particle_uv, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#endif\n\n    vec3 particlePos = inPos;\n    vec3 particlePosMoved = vec3(0.0);\n\n    mat2 rotMatrix;\n",particleAnimFrameClampVS:"\n    float animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.y) + animTexParams.x, animTexParams.z);\n",particleAnimFrameLoopVS:"\n    float animFrame = floor(mod(texCoordsAlphaLife.w * animTexParams.y + animTexParams.x, animTexParams.z + 1.0));\n",particleAnimTexVS:"\n    float animationIndex;\n\n    if (animTexIndexParams.y == 1.0) {\n        animationIndex = floor((animTexParams.w + 1.0) * rndFactor3.z) * (animTexParams.z + 1.0);\n    } else {\n        animationIndex = animTexIndexParams.x * (animTexParams.z + 1.0);\n    }\n\n    float atlasX = (animationIndex + animFrame) * animTexTilesParams.x;\n    float atlasY = 1.0 - floor(atlasX + 1.0) * animTexTilesParams.y;\n    atlasX = fract(atlasX);\n\n    texCoordsAlphaLife.xy *= animTexTilesParams.xy;\n    texCoordsAlphaLife.xy += vec2(atlasX, atlasY);\n",particleInputFloatPS:"\nvoid readInput(float uv) {\n    vec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));\n    vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));\n\n    inPos = tex.xyz;\n    inVel = tex2.xyz;\n    inAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;\n    inShow = tex.w >= 0.0;\n    inLife = tex2.w;\n}\n",particleInputRgba8PS:"\n//RG=X, BA=Y\n//RG=Z, BA=A\n//RGB=V, A=visMode\n//RGBA=life\n\n#define PI2 6.283185307179586\n\nuniform vec3 inBoundsSize;\nuniform vec3 inBoundsCenter;\n\nuniform float maxVel;\n\nfloat decodeFloatRG(vec2 rg) {\n    return rg.y*(1.0/255.0) + rg.x;\n}\n\nfloat decodeFloatRGBA( vec4 rgba ) {\n  return dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );\n}\n\nvoid readInput(float uv) {\n    vec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));\n    vec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));\n    vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));\n    vec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));\n\n    inPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));\n    inPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;\n\n    inVel = tex2.xyz;\n    inVel = (inVel - vec3(0.5)) * maxVel;\n\n    inAngle = decodeFloatRG(tex1.ba) * PI2;\n    inShow = tex2.a > 0.5;\n\n    inLife = decodeFloatRGBA(tex3);\n    float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n    float maxPosLife = lifetime+1.0;\n    inLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;\n}\n",particleOutputFloatPS:"\nvoid writeOutput() {\n    if (gl_FragCoord.y<1.0) {\n        gl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);\n    } else {\n        gl_FragColor = vec4(outVel, outLife);\n    }\n}\n",particleOutputRgba8PS:"\nuniform vec3 outBoundsMul;\nuniform vec3 outBoundsAdd;\n\nvec2 encodeFloatRG( float v ) {\n    vec2 enc = vec2(1.0, 255.0) * v;\n    enc = fract(enc);\n    enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n    return enc;\n}\n\nvec4 encodeFloatRGBA( float v ) {\n    vec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;\n    enc = fract(enc);\n    enc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n    return enc;\n}\n\nvoid writeOutput() {\n    outPos = outPos * outBoundsMul + outBoundsAdd;\n    outAngle = fract(outAngle / PI2);\n\n    outVel = (outVel / maxVel) + vec3(0.5); // TODO: mul\n\n    float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n    float maxPosLife = lifetime+1.0;\n    outLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);\n\n    if (gl_FragCoord.y < 1.0) {\n        gl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));\n    } else if (gl_FragCoord.y < 2.0) {\n        gl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));\n    } else if (gl_FragCoord.y < 3.0) {\n        gl_FragColor = vec4(outVel, visMode*0.5+0.5);\n    } else {\n        gl_FragColor = encodeFloatRGBA(outLife);\n    }\n}\n",particleUpdaterAABBPS:"\nuniform mat3 spawnBounds;\nuniform vec3 spawnPosInnerRatio;\n\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n    vec3 pos = inBounds - vec3(0.5);\n\n    vec3 posAbs = abs(pos);\n    vec3 maxPos = vec3(max(posAbs.x, max(posAbs.y, posAbs.z)));\n\n    vec3 edge = maxPos + (vec3(0.5) - maxPos) * spawnPosInnerRatio;\n\n    pos.x = edge.x * (maxPos.x == posAbs.x ? sign(pos.x) : 2.0 * pos.x);\n    pos.y = edge.y * (maxPos.y == posAbs.y ? sign(pos.y) : 2.0 * pos.y);\n    pos.z = edge.z * (maxPos.z == posAbs.z ? sign(pos.z) : 2.0 * pos.z);\n\n#ifndef LOCAL_SPACE\n    return emitterPos + spawnBounds * pos;\n#else\n    return spawnBounds * pos;\n#endif\n}\n\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n    localVelocity -= vec3(0, 0, initialVelocity);\n}\n",particleUpdaterEndPS:"\n    writeOutput();\n}\n",particleUpdaterInitPS:"\nvarying vec2 vUv0;\n\nuniform highp sampler2D particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform highp sampler2D internalTex3;\n\nuniform mat3 emitterMatrix, emitterMatrixInv;\nuniform vec3 emitterScale;\n\nuniform vec3 emitterPos, frameRandom, localVelocityDivMult, velocityDivMult;\nuniform float delta, rate, rateDiv, lifetime, numParticles, rotSpeedDivMult, radialSpeedDivMult, seed;\nuniform float startAngle, startAngle2;\nuniform float initialVelocity;\n\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\nfloat visMode;\n\nvec3 outPos;\nvec3 outVel;\nfloat outAngle;\nbool outShow;\nfloat outLife;\n",particleUpdaterNoRespawnPS:"\n    if (outLife >= lifetime) {\n        outLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n        visMode = -1.0;\n    }\n",particleUpdaterOnStopPS:"\n    visMode = outLife < 0.0? -1.0: visMode;\n",particleUpdaterRespawnPS:"\n    if (outLife >= lifetime) {\n        outLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n        visMode = 1.0;\n    }\n    visMode = outLife < 0.0? 1.0: visMode;\n",particleUpdaterSpherePS:"\nuniform float spawnBoundsSphere;\nuniform float spawnBoundsSphereInnerRatio;\n\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n    float rnd4 = fract(rndFactor * 1000.0);\n    vec3 norm = normalize(inBounds.xyz - vec3(0.5));\n    float r = rnd4 * (1.0 - spawnBoundsSphereInnerRatio) + spawnBoundsSphereInnerRatio;\n#ifndef LOCAL_SPACE\n    return emitterPos + norm * r * spawnBoundsSphere;\n#else\n    return norm * r * spawnBoundsSphere;\n#endif\n}\n\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n    localVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;\n}\n",particleUpdaterStartPS:"\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nvec3 unpack3NFloats(float src) {\n    float r = fract(src);\n    float g = fract(src * 256.0);\n    float b = fract(src * 65536.0);\n    return vec3(r, g, b);\n}\n\nvec3 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {\n    vec4 a = texture2D(tex, tc);\n    vec4 b = texture2D(tex, tc + graphSampleSize);\n    float c = fract(tc.x * graphNumSamples);\n\n    vec3 unpackedA = unpack3NFloats(a.w);\n    vec3 unpackedB = unpack3NFloats(b.w);\n    w = mix(unpackedA, unpackedB, c);\n\n    return mix(a.xyz, b.xyz, c);\n}\n\n#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)\nvec4 hash41(float p) {\n    vec4 p4 = fract(vec4(p) * HASHSCALE4);\n    p4 += dot(p4, p4.wzxy+19.19);\n    return fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));\n}\n\nvoid main(void) {\n    if (gl_FragCoord.x > numParticles) discard;\n\n    readInput(vUv0.x);\n    visMode = inShow? 1.0 : -1.0;\n\n    vec4 rndFactor = hash41(gl_FragCoord.x + seed);\n\n    float particleRate = rate + rateDiv * rndFactor.x;\n\n    outLife = inLife + delta;\n    float nlife = clamp(outLife / lifetime, 0.0, 1.0);\n\n    vec3 localVelocityDiv;\n    vec3 velocityDiv;\n    vec3 paramDiv;\n    vec3 localVelocity = tex1Dlod_lerp(internalTex0, vec2(nlife, 0), localVelocityDiv);\n    vec3 velocity =      tex1Dlod_lerp(internalTex1, vec2(nlife, 0), velocityDiv);\n    vec3 params =        tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n    float rotSpeed = params.x;\n    float rotSpeedDiv = paramDiv.y;\n\n    vec3 radialParams = tex1Dlod_lerp(internalTex3, vec2(nlife, 0), paramDiv);\n    float radialSpeed = radialParams.x;\n    float radialSpeedDiv = radialParams.y;\n\n    bool respawn = inLife <= 0.0 || outLife >= lifetime;\n    inPos = respawn ? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : inPos;\n    inAngle = respawn ? mix(startAngle, startAngle2, rndFactor.x) : inAngle;\n\n#ifndef LOCAL_SPACE\n    vec3 radialVel = inPos - emitterPos;\n#else\n    vec3 radialVel = inPos;\n#endif\n    radialVel = (dot(radialVel, radialVel) > 1.0E-8) ? radialSpeed * normalize(radialVel) : vec3(0.0);\n    radialVel += (radialSpeedDiv * vec3(2.0) - vec3(1.0)) * radialSpeedDivMult * rndFactor.xyz;\n\n    localVelocity +=    (localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;\n    velocity +=         (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;\n    rotSpeed +=         (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;\n\n    addInitialVelocity(localVelocity, rndFactor.xyz);\n\n#ifndef LOCAL_SPACE\n    outVel = emitterMatrix * localVelocity + (radialVel + velocity) * emitterScale;\n#else\n    outVel = (localVelocity + radialVel) / emitterScale + emitterMatrixInv * velocity;\n#endif\n\n    outPos = inPos + outVel * delta;\n    outAngle = inAngle + rotSpeed * delta;\n",particle_billboardVS:"\n    quadXY = rotate(quadXY, inAngle, rotMatrix);\n    vec3 localPos = billboard(particlePos, quadXY);\n",particle_blendAddPS:"\n    dBlendModeFogFactor = 0.0;\n    rgb *= saturate(gammaCorrectInput(max(a, 0.0)));\n    if ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;\n",particle_blendMultiplyPS:"\n    rgb = mix(vec3(1.0), rgb, vec3(a));\n    if (rgb.r + rgb.g + rgb.b > 2.99) discard;\n",particle_blendNormalPS:"\n    if (a < 0.01) discard;\n",particle_cpuVS:"\nattribute vec4 particle_vertexData;   // XYZ = world pos, W = life\nattribute vec4 particle_vertexData2;  // X = angle, Y = scale, Z = alpha, W = velocity.x\nattribute vec4 particle_vertexData3;  // XYZ = particle local pos, W = velocity.y\nattribute float particle_vertexData4; // particle id\n#ifndef USE_MESH\n#define VDATA5TYPE vec2\n#else\n#define VDATA5TYPE vec4\n#endif\nattribute VDATA5TYPE particle_vertexData5; // VDATA4TYPE depends on useMesh property. Start with X = velocity.z, Y = particle ID and for mesh particles proceeds with Z = mesh UV.x, W = mesh UV.y\n\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\n\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n\nuniform float numParticles;\nuniform float lifetime;\nuniform float stretch;\nuniform float seed;\nuniform vec3 wrapBounds, emitterScale, faceTangent, faceBinorm;\nuniform sampler2D texLifeAndSourcePosOUT;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform vec3 emitterPos;\n\nvarying vec4 texCoordsAlphaLife;\n\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)\n{\n    float c = cos(pRotation);\n    float s = sin(pRotation);\n    //vec4 rotationMatrix = vec4(c, -s, s, c);\n\n    mat2 m = mat2(c, -s, s, c);\n    rotMatrix = m;\n\n    return m * quadXY;\n}\n\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY)\n{\n    vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n    return pos;\n}\n\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY)\n{\n    vec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n    return pos;\n}\n\nvoid main(void)\n{\n    vec3 particlePos = particle_vertexData.xyz;\n    vec3 inPos = particlePos;\n    vec3 vertPos = particle_vertexData3.xyz;\n    vec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData5.x);\n\n    float id = floor(particle_vertexData4);\n    float rndFactor = fract(sin(id + 1.0 + seed));\n    vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n\n#ifdef LOCAL_SPACE\n    inVel = mat3(matrix_model) * inVel;\n#endif\n    vec2 velocityV = normalize((mat3(matrix_view) * inVel).xy); // should be removed by compiler if align/stretch is not used\n\n    vec2 quadXY = vertPos.xy;\n\n#ifdef USE_MESH\n    texCoordsAlphaLife = vec4(particle_vertexData5.zw, particle_vertexData2.z, particle_vertexData.w);\n#else\n    texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);\n#endif\n    mat2 rotMatrix;\n\n    float inAngle = particle_vertexData2.x;\n    vec3 particlePosMoved = vec3(0.0);\n    vec3 meshLocalPos = particle_vertexData3.xyz;\n",particle_cpu_endVS:"\n    localPos *= particle_vertexData2.y * emitterScale;\n    localPos += particlePos;\n\n    gl_Position = matrix_viewProjection * vec4(localPos, 1.0);\n",particle_customFaceVS:"\n    quadXY = rotate(quadXY, inAngle, rotMatrix);\n    vec3 localPos = customFace(particlePos, quadXY);\n",particle_endPS:"\n    rgb = addFog(rgb);\n    rgb = toneMap(rgb);\n    rgb = gammaCorrectOutput(rgb);\n    gl_FragColor = vec4(rgb, a);\n}\n",particle_endVS:"\n    localPos *= scale * emitterScale;\n    localPos += particlePos;\n\n    #ifdef SCREEN_SPACE\n    gl_Position = vec4(localPos.x, localPos.y, 0.0, 1.0);\n    #else\n    gl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);\n    #endif\n",particle_halflambertPS:"\n    vec3 negNormal = normal*0.5+0.5;\n    vec3 posNormal = -normal*0.5+0.5;\n    negNormal *= negNormal;\n    posNormal *= posNormal;\n",particle_initVS:"\nattribute vec4 particle_vertexData; // XYZ = particle position, W = particle ID + random factor\n#ifdef USE_MESH\nattribute vec2 particle_uv;         // mesh UV\n#endif\n\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n\nuniform float numParticles, numParticlesPot;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float stretch;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale, emitterPos, faceTangent, faceBinorm;\nuniform float rate, rateDiv, lifetime, deltaRandomnessStatic, scaleDivMult, alphaDivMult, seed, delta;\nuniform sampler2D particleTexOUT, particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\n\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\n\nvarying vec4 texCoordsAlphaLife;\n\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\n",particle_lambertPS:"\n    vec3 negNormal = max(normal, vec3(0.0));\n    vec3 posNormal = max(-normal, vec3(0.0));\n",particle_lightingPS:"\n    vec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +\n                        negNormal.y*lightCube[2] + posNormal.y*lightCube[3] +\n                        negNormal.z*lightCube[4] + posNormal.z*lightCube[5];\n\n    rgb *= light;\n",particle_localShiftVS:"\n    particlePos = (matrix_model * vec4(particlePos, 1.0)).xyz;\n",particle_meshVS:"\n    vec3 localPos = meshLocalPos;\n    localPos.xy = rotate(localPos.xy, inAngle, rotMatrix);\n    localPos.yz = rotate(localPos.yz, inAngle, rotMatrix);\n\n    billboard(particlePos, quadXY);\n",particle_normalVS:"\n    Normal = normalize(localPos + matrix_viewInverse[2].xyz);\n",particle_normalMapPS:"\n    vec3 normalMap = normalize(texture2D(normalMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y)).xyz * 2.0 - 1.0);\n    vec3 normal = ParticleMat * normalMap;\n",particle_pointAlongVS:"\n    inAngle = atan(velocityV.x, velocityV.y); // not the fastest way, but easier to plug in; TODO: create rot matrix right from vectors\n\n",particle_softPS:"\n    float depth = getLinearScreenDepth();\n    float particleDepth = vDepth;\n    float depthDiff = saturate(abs(particleDepth - depth) * softening);\n    a *= depthDiff;\n",particle_softVS:"\n    vDepth = getLinearDepth(localPos);\n",particle_stretchVS:"\n    vec3 moveDir = inVel * stretch;\n    vec3 posPrev = particlePos - moveDir;\n    posPrev += particlePosMoved;\n\n    vec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);\n\n    float interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;\n\n    particlePos = mix(particlePos, posPrev, interpolation);\n",particle_TBNVS:"\n    mat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0, rotMatrix[1][0], rotMatrix[1][1], 0.0, 0.0, 0.0, 1.0);\n    ParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;\n",particle_wrapVS:"\n    vec3 origParticlePos = particlePos;\n    particlePos -= matrix_model[3].xyz;\n    particlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;\n    particlePos += matrix_model[3].xyz;\n    particlePosMoved = particlePos - origParticlePos;\n",precisionTestPS:"\nvoid main(void) {\n    gl_FragColor = vec4(2147483648.0);\n}\n",precisionTest2PS:"\nuniform sampler2D source;\n\nvec4 packFloat(float depth) {\n    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\n    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n    res -= res.xxyz * bit_mask;\n    return res;\n}\n\nvoid main(void) {\n    float c = texture2D(source, vec2(0.0)).r;\n    float diff = abs(c - 2147483648.0) / 2147483648.0;\n    gl_FragColor = packFloat(diff);\n}\n",reflDirPS:"\nvoid getReflDir() {\n    dReflDirW = normalize(-reflect(dViewDirW, dNormalW));\n}\n",reflDirAnisoPS:"\nvoid getReflDir() {\n    float roughness = sqrt(1.0 - min(dGlossiness, 1.0));\n    float anisotropy = material_anisotropy * roughness;\n    vec3 anisotropicDirection = anisotropy >= 0.0 ? dTBN[1] : dTBN[0];\n    vec3 anisotropicTangent = cross(anisotropicDirection, dViewDirW);\n    vec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);\n    vec3 bentNormal = normalize(mix(normalize(dNormalW), normalize(anisotropicNormal), anisotropy));\n    dReflDirW = reflect(-dViewDirW, bentNormal);\n}\n",reflectionCCPS:"\n#ifdef LIT_CLEARCOAT\nuniform float material_clearCoatReflectivity;\n\nvoid addReflectionCC() {\n    ccReflection += vec4(calcReflection(ccReflDirW, ccGlossiness), material_clearCoatReflectivity);\n}\n#endif\n",reflectionCubePS:"\nuniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\n\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n    vec3 lookupVec = fixSeams(cubeMapProject(tReflDirW));\n    lookupVec.x *= -1.0;\n    return $DECODE(textureCube(texture_cubeMap, lookupVec));\n}\n\nvoid addReflection() {   \n    dReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionEnvHQPS:"\n#ifndef ENV_ATLAS\n#define ENV_ATLAS\nuniform sampler2D texture_envAtlas;\n#endif\nuniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\n\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n    vec3 dir = cubeMapProject(tReflDirW) * vec3(-1.0, 1.0, 1.0);\n    vec2 uv = toSphericalUv(dir);\n\n    // calculate roughness level\n    float level = saturate(1.0 - tGlossiness) * 5.0;\n    float ilevel = floor(level);\n    float flevel = level - ilevel;\n\n    vec3 sharp = $DECODE(textureCube(texture_cubeMap, fixSeams(dir)));\n    vec3 roughA = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel)));\n    vec3 roughB = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));\n\n    return processEnvironment(mix(sharp, mix(roughA, roughB, flevel), min(level, 1.0)));\n}\n\nvoid addReflection() {   \n    dReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionEnvPS:"\n#ifndef ENV_ATLAS\n#define ENV_ATLAS\nuniform sampler2D texture_envAtlas;\n#endif\nuniform float material_reflectivity;\n\n// calculate mip level for shiny reflection given equirect coords uv.\nfloat shinyMipLevel(vec2 uv) {\n    vec2 dx = dFdx(uv);\n    vec2 dy = dFdy(uv);\n\n    // calculate second dF at 180 degrees\n    vec2 uv2 = vec2(fract(uv.x + 0.5), uv.y);\n    vec2 dx2 = dFdx(uv2);\n    vec2 dy2 = dFdy(uv2);\n\n    // calculate min of both sets of dF to handle discontinuity at the azim edge\n    float maxd = min(max(dot(dx, dx), dot(dy, dy)), max(dot(dx2, dx2), dot(dy2, dy2)));\n\n    return clamp(0.5 * log2(maxd) - 1.0 + textureBias, 0.0, 5.0);\n}\n\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n    vec3 dir = cubeMapProject(tReflDirW) * vec3(-1.0, 1.0, 1.0);\n    vec2 uv = toSphericalUv(dir);\n\n    // calculate roughness level\n    float level = saturate(1.0 - tGlossiness) * 5.0;\n    float ilevel = floor(level);\n\n    // accessing the shiny (top level) reflection - perform manual mipmap lookup\n    float level2 = shinyMipLevel(uv * atlasSize);\n    float ilevel2 = floor(level2);\n\n    vec2 uv0, uv1;\n    float weight;\n    if (ilevel == 0.0) {\n        uv0 = mapShinyUv(uv, ilevel2);\n        uv1 = mapShinyUv(uv, ilevel2 + 1.0);\n        weight = level2 - ilevel2;\n    } else {\n        // accessing rough reflection - just sample the same part twice\n        uv0 = uv1 = mapRoughnessUv(uv, ilevel);\n        weight = 0.0;\n    }\n\n    vec3 linearA = $DECODE(texture2D(texture_envAtlas, uv0));\n    vec3 linearB = $DECODE(texture2D(texture_envAtlas, uv1));\n    vec3 linear0 = mix(linearA, linearB, weight);\n    vec3 linear1 = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));\n\n    return processEnvironment(mix(linear0, linear1, level - ilevel));\n}\n\nvoid addReflection() {   \n    dReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionSpherePS:"\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\n\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n    vec3 reflDirV = (mat3(matrix_view) * tReflDirW).xyz;\n\n    float m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );\n    vec2 sphereMapUv = reflDirV.xy / m + 0.5;\n\n    return $DECODE(texture2D(texture_sphereMap, sphereMapUv));\n}\n\nvoid addReflection() {   \n    dReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionSphereLowPS:"\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\n\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n    vec3 reflDirV = vNormalV;\n\n    vec2 sphereMapUv = reflDirV.xy * 0.5 + 0.5;\n    return $DECODE(texture2D(texture_sphereMap, sphereMapUv));\n}\n\nvoid addReflection() {   \n    dReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionSheenPS:"\n\nvoid addReflectionSheen() {\n    float NoV = dot(dNormalW, dViewDirW);\n    float alphaG = sGlossiness * sGlossiness;\n\n    // Avoid using a LUT and approximate the values analytically\n    float a = sGlossiness < 0.25 ? -339.2 * alphaG + 161.4 * sGlossiness - 25.9 : -8.48 * alphaG + 14.3 * sGlossiness - 9.95;\n    float b = sGlossiness < 0.25 ? 44.0 * alphaG - 23.7 * sGlossiness + 3.26 : 1.97 * alphaG - 3.27 * sGlossiness + 0.72;\n    float DG = exp( a * NoV + b ) + ( sGlossiness < 0.25 ? 0.0 : 0.1 * ( sGlossiness - 0.25 ) );\n    sReflection += vec4(calcReflection(dReflDirW, sGlossiness), saturate(DG * 1.0/PI));\n}\n",refractionCubePS:"\nuniform float material_refractionIndex;\n\nvec3 refract2(vec3 viewVec, vec3 Normal, float IOR) {\n    float vn = dot(viewVec, Normal);\n    float k = 1.0 - IOR * IOR * (1.0 - vn * vn);\n    vec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * Normal;\n    return refrVec;\n}\n\nvoid addRefraction() {\n    // use same reflection code with refraction vector\n    vec3 tmpDir = dReflDirW;\n    vec4 tmpRefl = dReflection;\n    dReflDirW = refract2(-dViewDirW, dNormalW, material_refractionIndex);\n    dReflection = vec4(0);\n    addReflection();\n    dDiffuseLight = mix(dDiffuseLight, dReflection.rgb * dAlbedo, dTransmission);\n    dReflection = tmpRefl;\n    dReflDirW = tmpDir;\n}\n",refractionDynamicPS:"\nuniform float material_refractionIndex;\nuniform float material_invAttenuationDistance;\nuniform vec3 material_attenuation;\n\nvec3 refract2(vec3 viewVec, vec3 Normal, float IOR) {\n    float vn = dot(viewVec, Normal);\n    float k = 1.0 - IOR * IOR * (1.0 - vn * vn);\n    vec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * Normal;\n    return refrVec;\n}\n\nvoid addRefraction() {\n\n    // Extract scale from the model transform\n    vec3 modelScale;\n    modelScale.x = length(vec3(matrix_model[0].xyz));\n    modelScale.y = length(vec3(matrix_model[1].xyz));\n    modelScale.z = length(vec3(matrix_model[2].xyz));\n\n    // Calculate the refraction vector, scaled by the thickness and scale of the object\n    vec3 refractionVector = normalize(refract(-dViewDirW, dNormalW, material_refractionIndex)) * dThickness * modelScale;\n\n    // The refraction point is the entry point + vector to exit point\n    vec4 pointOfRefraction = vec4(vPositionW + refractionVector, 1.0);\n\n    // Project to texture space so we can sample it\n    vec4 projectionPoint = matrix_viewProjection * pointOfRefraction;\n    vec2 uv = projectionPoint.xy / projectionPoint.ww;\n    uv += vec2(1.0);\n    uv *= vec2(0.5);\n\n    #ifdef GL2\n        // Use IOR and roughness to select mip\n        float iorToRoughness = (1.0 - dGlossiness) * clamp((1.0 / material_refractionIndex) * 2.0 - 2.0, 0.0, 1.0);\n        float refractionLod = log2(uScreenSize.x) * iorToRoughness;\n        vec3 refraction = texture2DLodEXT(uSceneColorMap, uv, refractionLod).rgb;\n    #else\n        vec3 refraction = texture2D(uSceneColorMap, uv).rgb;\n    #endif\n\n    // Transmittance is our final refraction color\n    vec3 transmittance;\n    if (material_invAttenuationDistance != 0.0)\n    {\n        vec3 attenuation = -log(material_attenuation) * material_invAttenuationDistance;\n        transmittance = exp(-attenuation * length(refractionVector));\n    }\n    else\n    {\n        transmittance = refraction;\n    }\n\n    // Apply fresnel effect on refraction\n    vec3 fresnel = vec3(1.0) - getFresnel(dot(dViewDirW, dNormalW), dSpecularity);\n    dDiffuseLight = mix(dDiffuseLight, refraction * transmittance * fresnel, dTransmission);\n}\n",reprojectPS:`\n// This shader requires the following #DEFINEs:\n//\n// PROCESS_FUNC - must be one of reproject, prefilter\n// DECODE_FUNC - must be one of decodeRGBM, decodeRGBE, decodeGamma or decodeLinear\n// ENCODE_FUNC - must be one of encodeRGBM, encodeRGBE, encideGamma or encodeLinear\n// SOURCE_FUNC - must be one of sampleCubemap, sampleEquirect, sampleOctahedral\n// TARGET_FUNC - must be one of getDirectionCubemap, getDirectionEquirect, getDirectionOctahedral\n//\n// When filtering:\n// NUM_SAMPLES - number of samples\n// NUM_SAMPLES_SQRT - sqrt of number of samples\n//\n// SUPPORTS_TEXLOD - whether supports texlod is supported\n\nvarying vec2 vUv0;\n\n// source\nuniform sampler2D sourceTex;\nuniform samplerCube sourceCube;\n\n// samples\nuniform sampler2D samplesTex;\nuniform vec2 samplesTexInverseSize;\n\n// params:\n// x - target cubemap face 0..6\n// y - specular power (when prefiltering)\n// z - source cubemap seam scale (0 to disable)\n// w - target cubemap size for seam calc (0 to disable)\nuniform vec4 params;\n\n// params2:\n// x - target image total pixels\n// y - source cubemap size\nuniform vec2 params2;\n\nfloat targetFace() { return params.x; }\nfloat specularPower() { return params.y; }\nfloat sourceCubeSeamScale() { return params.z; }\nfloat targetCubeSeamScale() { return params.w; }\n\nfloat targetTotalPixels() { return params2.x; }\nfloat sourceTotalPixels() { return params2.y; }\n\nfloat PI = 3.141592653589793;\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\n${Fo}\n${ko}\n\n//-- supported projections\n\nvec3 modifySeams(vec3 dir, float scale) {\n    vec3 adir = abs(dir);\n    float M = max(max(adir.x, adir.y), adir.z);\n    return dir / M * vec3(\n        adir.x == M ? 1.0 : scale,\n        adir.y == M ? 1.0 : scale,\n        adir.z == M ? 1.0 : scale\n    );\n}\n\nvec2 toSpherical(vec3 dir) {\n    return vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));\n}\n\nvec3 fromSpherical(vec2 uv) {\n    return vec3(cos(uv.y) * sin(uv.x),\n                sin(uv.y),\n                cos(uv.y) * cos(uv.x));\n}\n\nvec3 getDirectionEquirect() {\n    return fromSpherical((vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0) * vec2(PI, PI * 0.5));\n}\n\nvec4 sampleEquirect(vec2 sph) {\n    vec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;\n    return texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n}\n\nvec4 sampleEquirect(vec3 dir) {\n    return sampleEquirect(toSpherical(dir));\n}\n\nvec4 sampleCubemap(vec3 dir) {\n    return textureCube(sourceCube, modifySeams(dir, 1.0 - sourceCubeSeamScale()));\n}\n\nvec4 sampleCubemap(vec2 sph) {\n    return sampleCubemap(fromSpherical(sph));\n}\n\nvec4 sampleEquirect(vec2 sph, float mipLevel) {\n    vec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;\n#ifdef SUPPORTS_TEXLOD\n    return texture2DLodEXT(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);\n#else\n    return texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n#endif\n}\n\nvec4 sampleEquirect(vec3 dir, float mipLevel) {\n    return sampleEquirect(toSpherical(dir), mipLevel);\n}\n\nvec4 sampleCubemap(vec3 dir, float mipLevel) {\n#ifdef SUPPORTS_TEXLOD\n    return textureCubeLodEXT(sourceCube, modifySeams(dir, 1.0 - exp2(mipLevel) * sourceCubeSeamScale()), mipLevel);\n#else\n    return textureCube(sourceCube, modifySeams(dir, 1.0 - exp2(mipLevel) * sourceCubeSeamScale()));\n#endif\n}\n\nvec4 sampleCubemap(vec2 sph, float mipLevel) {\n    return sampleCubemap(fromSpherical(sph), mipLevel);\n}\n\n// octahedral code, based on http://jcgt.org/published/0003/02/01\n// "Survey of Efficient Representations for Independent Unit Vectors" by Cigolle, Donow, Evangelakos, Mara, McGuire, Meyer\n\nfloat signNotZero(float k){\n    return(k >= 0.0) ? 1.0 : -1.0;\n}\n\nvec2 signNotZero(vec2 v) {\n    return vec2(signNotZero(v.x), signNotZero(v.y));\n}\n\n// Returns a unit vector. Argument o is an octahedral vector packed via octEncode, on the [-1, +1] square\nvec3 octDecode(vec2 o) {\n    vec3 v = vec3(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);\n    if (v.y < 0.0) {\n        v.xz = (1.0 - abs(v.zx)) * signNotZero(v.xz);\n    }\n    return normalize(v);\n}\n\nvec3 getDirectionOctahedral() {\n    return octDecode(vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0);\n}\n\n// Assumes that v is a unit vector. The result is an octahedral vector on the [-1, +1] square\nvec2 octEncode(in vec3 v) {\n    float l1norm = abs(v.x) + abs(v.y) + abs(v.z);\n    vec2 result = v.xz * (1.0 / l1norm);\n    if (v.y < 0.0) {\n        result = (1.0 - abs(result.yx)) * signNotZero(result.xy);\n    }\n    return result;\n}\n\nvec4 sampleOctahedral(vec3 dir) {\n    vec2 uv = octEncode(dir) * 0.5 + 0.5;\n    return texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n}\n\nvec4 sampleOctahedral(vec2 sph) {\n    return sampleOctahedral(fromSpherical(sph));\n}\n\nvec4 sampleOctahedral(vec3 dir, float mipLevel) {\n    vec2 uv = octEncode(dir) * 0.5 + 0.5;\n#ifdef SUPPORTS_TEXLOD\n    return texture2DLodEXT(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);\n#else\n    return texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n#endif\n}\n\nvec4 sampleOctahedral(vec2 sph, float mipLevel) {\n    return sampleOctahedral(fromSpherical(sph), mipLevel);\n}\n\n/////////////////////////////////////////////////////////////////////\n\nvec3 getDirectionCubemap() {\n    vec2 st = vUv0 * 2.0 - 1.0;\n    float face = targetFace();\n\n    vec3 vec;\n    if (face == 0.0) {\n        vec = vec3(1, -st.y, -st.x);\n    } else if (face == 1.0) {\n        vec = vec3(-1, -st.y, st.x);\n    } else if (face == 2.0) {\n        vec = vec3(st.x, 1, st.y);\n    } else if (face == 3.0) {\n        vec = vec3(st.x, -1, -st.y);\n    } else if (face == 4.0) {\n        vec = vec3(st.x, -st.y, 1);\n    } else {\n        vec = vec3(-st.x, -st.y, -1);\n    }\n\n    return normalize(modifySeams(vec, 1.0 / (1.0 - targetCubeSeamScale())));\n}\n\nmat3 matrixFromVector(vec3 n) { // frisvad\n    float a = 1.0 / (1.0 + n.z);\n    float b = -n.x * n.y * a;\n    vec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n    vec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n    return mat3(b1, b2, n);\n}\n\nmat3 matrixFromVectorSlow(vec3 n) {\n    vec3 up = (1.0 - abs(n.y) <= 0.0000001) ? vec3(0.0, 0.0, n.y > 0.0 ? 1.0 : -1.0) : vec3(0.0, 1.0, 0.0);\n    vec3 x = normalize(cross(up, n));\n    vec3 y = cross(n, x);\n    return mat3(x, y, n);\n}\n\nvec4 reproject() {\n    if (NUM_SAMPLES <= 1) {\n        // single sample\n        return ENCODE_FUNC(DECODE_FUNC(SOURCE_FUNC(TARGET_FUNC())));\n    } else {\n        // multi sample\n        vec3 t = TARGET_FUNC();\n        vec3 tu = dFdx(t);\n        vec3 tv = dFdy(t);\n\n        vec3 result = vec3(0.0);\n        for (float u = 0.0; u < NUM_SAMPLES_SQRT; ++u) {\n            for (float v = 0.0; v < NUM_SAMPLES_SQRT; ++v) {\n                result += DECODE_FUNC(SOURCE_FUNC(normalize(t +\n                                                            tu * (u / NUM_SAMPLES_SQRT - 0.5) +\n                                                            tv * (v / NUM_SAMPLES_SQRT - 0.5))));\n            }\n        }\n        return ENCODE_FUNC(result / (NUM_SAMPLES_SQRT * NUM_SAMPLES_SQRT));\n    }\n}\n\nvec4 unpackFloat = vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0);\n\nvoid unpackSample(int i, out vec3 L, out float mipLevel) {\n    float u = (float(i * 4) + 0.5) * samplesTexInverseSize.x;\n    float v = (floor(u) + 0.5) * samplesTexInverseSize.y;\n\n    vec4 raw;\n    raw.x = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n    raw.y = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n    raw.z = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n    raw.w = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat);\n\n    L.xyz = raw.xyz * 2.0 - 1.0;\n    mipLevel = raw.w * 8.0;\n}\n\n// convolve an environment given pre-generated samples\nvec4 prefilterSamples() {\n    // construct vector space given target direction\n    mat3 vecSpace = matrixFromVectorSlow(TARGET_FUNC());\n\n    vec3 L;\n    float mipLevel;\n\n    vec3 result = vec3(0.0);\n    float totalWeight = 0.0;\n    for (int i = 0; i < NUM_SAMPLES; ++i) {\n        unpackSample(i, L, mipLevel);\n        result += DECODE_FUNC(SOURCE_FUNC(vecSpace * L, mipLevel)) * L.z;\n        totalWeight += L.z;\n    }\n\n    return ENCODE_FUNC(result / totalWeight);\n}\n\n// unweighted version of prefilterSamples\nvec4 prefilterSamplesUnweighted() {\n    // construct vector space given target direction\n    mat3 vecSpace = matrixFromVectorSlow(TARGET_FUNC());\n\n    vec3 L;\n    float mipLevel;\n\n    vec3 result = vec3(0.0);\n    float totalWeight = 0.0;\n    for (int i = 0; i < NUM_SAMPLES; ++i) {\n        unpackSample(i, L, mipLevel);\n        result += DECODE_FUNC(SOURCE_FUNC(vecSpace * L, mipLevel));\n    }\n\n    return ENCODE_FUNC(result / float(NUM_SAMPLES));\n}\n\nvoid main(void) {\n    gl_FragColor = PROCESS_FUNC();\n}\n`,screenDepthPS:"\nuniform highp sampler2D uSceneDepthMap;\n\n#ifndef SCREENSIZE\n#define SCREENSIZE\nuniform vec4 uScreenSize;\n#endif\n\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n\n\n\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params; // 1 / camera_far,      camera_far,     camera_near,        is_ortho\n#endif\n\n#ifdef GL2\nfloat linearizeDepth(float z) {\n    if (camera_params.w == 0.0)\n        return (camera_params.z * camera_params.y) / (camera_params.y + z * (camera_params.z - camera_params.y));\n    else\n        return camera_params.z + z * (camera_params.y - camera_params.z);\n}\n#else\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n    const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n    return dot(rgbaDepth, bitShift);\n}\n#endif\n#endif\n\n// Retrieves rendered linear camera depth by UV\nfloat getLinearScreenDepth(vec2 uv) {\n    #ifdef GL2\n        return linearizeDepth(texture2D(uSceneDepthMap, uv).r);\n    #else\n        return unpackFloat(texture2D(uSceneDepthMap, uv)) * camera_params.y;\n    #endif\n}\n\n#ifndef VERTEXSHADER\n// Retrieves rendered linear camera depth under the current pixel\nfloat getLinearScreenDepth() {\n    vec2 uv = gl_FragCoord.xy * uScreenSize.zw;\n    return getLinearScreenDepth(uv);\n}\n#endif\n\n// Generates linear camera depth for the given world position\nfloat getLinearDepth(vec3 pos) {\n    return -(matrix_view * vec4(pos, 1.0)).z;\n}\n",shadowCascadesPS:"\nconst float maxCascades = 4.0;\n\n// shadow matrix for selected cascade\nmat4 cascadeShadowMat;\n\n// function which selects a shadow projection matrix based on cascade distances \nvoid getShadowCascadeMatrix(mat4 shadowMatrixPalette[4], float shadowCascadeDistances[4], float shadowCascadeCount) {\n\n    // depth in 0 .. far plane range\n    float depth = 1.0 / gl_FragCoord.w;\n\n    // find cascade index based on the depth (loop as there is no per component vec compare operator in webgl)\n    float cascadeIndex = 0.0;\n    for (float i = 0.0; i < maxCascades; i++) {\n        if (depth < shadowCascadeDistances[int(i)]) {\n            cascadeIndex = i;\n            break;\n        }\n    }\n\n    // limit to actual number of used cascades\n    cascadeIndex = min(cascadeIndex, shadowCascadeCount - 1.0);\n\n    // pick shadow matrix\n    #ifdef GL2\n        cascadeShadowMat = shadowMatrixPalette[int(cascadeIndex)];\n    #else\n        // webgl 1 does not allow non-cost index array lookup\n        if (cascadeIndex == 0.0) {\n            cascadeShadowMat = shadowMatrixPalette[0];\n        }\n        else if (cascadeIndex == 1.0) {\n            cascadeShadowMat = shadowMatrixPalette[1];\n        }\n        else if (cascadeIndex == 2.0) {\n            cascadeShadowMat = shadowMatrixPalette[2];\n        }\n        else {\n            cascadeShadowMat = shadowMatrixPalette[3];\n        }\n    #endif\n}\n\nvoid fadeShadow(float shadowCascadeDistances[4]) {                  \n\n    // if the pixel is past the shadow distance, remove shadow\n    // this enforces straight line instead of corner of shadow which moves when camera rotates  \n    float depth = 1.0 / gl_FragCoord.w;\n    if (depth > shadowCascadeDistances[int(maxCascades - 1.0)]) {\n        dShadowCoord.z = -9999999.0;\n    }\n}\n",shadowCommonPS:"\nvoid normalOffsetPointShadow(vec4 shadowParams) {\n    float distScale = length(dLightDirW);\n    vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale; //0.02\n    vec3 dir = wPos - dLightPosW;\n    dLightDirW = dir;\n}\n",shadowCoordPS:"\nvoid _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n    dShadowCoord = (shadowMatrix * vec4(wPos, 1.0)).xyz;\n    dShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n\n    #ifdef SHADOWBIAS\n    dShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n    #endif\n}\n\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    projPos.xy /= projPos.w;\n    dShadowCoord.xy = projPos.xy;\n    dShadowCoord.z = length(dLightDirW) * shadowParams.w;\n\n    #ifdef SHADOWBIAS\n    dShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n    #endif\n}\n\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\n\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams) {\n    _getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\n\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n    float distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW)); // fov?\n    vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\n    _getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\n\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n    vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0); //0.08\n\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n",shadowCoordPerspZbufferPS:"\nvoid _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    projPos.xyz /= projPos.w;\n    dShadowCoord = projPos.xyz;\n    // depth bias is already applied on render\n}\n\nvoid getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n    vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y;\n    _getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);\n}\n\nvoid getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams) {\n    _getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, vPositionW);\n}\n",shadowEVSMPS:"\nfloat VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n    vec3 moments = texture2D(tex, texCoords).xyz;\n    return calculateEVSM(moments, Z, vsmBias, exponent);\n}\n\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n    return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\n\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n    return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",shadowEVSMnPS:"\nfloat VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n    float pixelSize = 1.0 / resolution;\n    texCoords -= vec2(pixelSize);\n    vec3 s00 = texture2D(tex, texCoords).xyz;\n    vec3 s10 = texture2D(tex, texCoords + vec2(pixelSize, 0)).xyz;\n    vec3 s01 = texture2D(tex, texCoords + vec2(0, pixelSize)).xyz;\n    vec3 s11 = texture2D(tex, texCoords + vec2(pixelSize)).xyz;\n    vec2 fr = fract(texCoords * resolution);\n    vec3 h0 = mix(s00, s10, fr.x);\n    vec3 h1 = mix(s01, s11, fr.x);\n    vec3 moments = mix(h0, h1, fr.y);\n    return calculateEVSM(moments, Z, vsmBias, exponent);\n}\n\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n    return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\n\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n    return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",shadowStandardPS:"\nvec3 lessThan2(vec3 a, vec3 b) {\n    return clamp((b - a)*1000.0, 0.0, 1.0); // softer version\n}\n\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n    const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n    return dot(rgbaDepth, bitShift);\n}\n#endif\n\n// ----- Direct/Spot Sampling -----\n\n#ifdef GL2\nfloat _getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n    float z = dShadowCoord.z;\n    vec2 uv = dShadowCoord.xy * shadowParams.x; // 1 unit - 1 texel\n    float shadowMapSizeInv = 1.0 / shadowParams.x;\n    vec2 base_uv = floor(uv + 0.5);\n    float s = (uv.x + 0.5 - base_uv.x);\n    float t = (uv.y + 0.5 - base_uv.y);\n    base_uv -= vec2(0.5);\n    base_uv *= shadowMapSizeInv;\n\n    float sum = 0.0;\n\n    float uw0 = (3.0 - 2.0 * s);\n    float uw1 = (1.0 + 2.0 * s);\n\n    float u0 = (2.0 - s) / uw0 - 1.0;\n    float u1 = s / uw1 + 1.0;\n\n    float vw0 = (3.0 - 2.0 * t);\n    float vw1 = (1.0 + 2.0 * t);\n\n    float v0 = (2.0 - t) / vw0 - 1.0;\n    float v1 = t / vw1 + 1.0;\n\n    u0 = u0 * shadowMapSizeInv + base_uv.x;\n    v0 = v0 * shadowMapSizeInv + base_uv.y;\n\n    u1 = u1 * shadowMapSizeInv + base_uv.x;\n    v1 = v1 * shadowMapSizeInv + base_uv.y;\n\n    sum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n    sum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n    sum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n    sum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n\n    sum *= 1.0f / 16.0;\n    return sum;\n}\n\nfloat getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n    return _getShadowPCF3x3(shadowMap, shadowParams);\n}\n\nfloat getShadowSpotPCF3x3(sampler2DShadow shadowMap, vec4 shadowParams) {\n    return _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n}\n#else\nfloat _xgetShadowPCF3x3(mat3 depthKernel, sampler2D shadowMap, vec3 shadowParams) {\n    mat3 shadowKernel;\n    vec3 shadowCoord = dShadowCoord;\n    vec3 shadowZ = vec3(shadowCoord.z);\n    shadowKernel[0] = vec3(greaterThan(depthKernel[0], shadowZ));\n    shadowKernel[1] = vec3(greaterThan(depthKernel[1], shadowZ));\n    shadowKernel[2] = vec3(greaterThan(depthKernel[2], shadowZ));\n\n    vec2 fractionalCoord = fract( shadowCoord.xy * shadowParams.x );\n\n    shadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n    shadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\n    vec4 shadowValues;\n    shadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n    shadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n    shadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n    shadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\n    return dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\n\nfloat _getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n    vec3 shadowCoord = dShadowCoord;\n\n    float xoffset = 1.0 / shadowParams.x; // 1/shadow map width\n    float dx0 = -xoffset;\n    float dx1 = xoffset;\n\n    mat3 depthKernel;\n    depthKernel[0][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx0)));\n    depthKernel[0][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, 0.0)));\n    depthKernel[0][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx1)));\n    depthKernel[1][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx0)));\n    depthKernel[1][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy));\n    depthKernel[1][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx1)));\n    depthKernel[2][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx0)));\n    depthKernel[2][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, 0.0)));\n    depthKernel[2][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx1)));\n\n    return _xgetShadowPCF3x3(depthKernel, shadowMap, shadowParams);\n}\n\nfloat getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n    return _getShadowPCF3x3(shadowMap, shadowParams);\n}\n\nfloat getShadowSpotPCF3x3(sampler2D shadowMap, vec4 shadowParams) {\n    return _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n}\n#endif\n\n\n// ----- Omni Sampling -----\n\nfloat _getShadowPoint(samplerCube shadowMap, vec4 shadowParams, vec3 dir) {\n\n    vec3 tc = normalize(dir);\n    vec3 tcAbs = abs(tc);\n\n    vec4 dirX = vec4(1,0,0, tc.x);\n    vec4 dirY = vec4(0,1,0, tc.y);\n    float majorAxisLength = tc.z;\n    if ((tcAbs.x > tcAbs.y) && (tcAbs.x > tcAbs.z)) {\n        dirX = vec4(0,0,1, tc.z);\n        dirY = vec4(0,1,0, tc.y);\n        majorAxisLength = tc.x;\n    } else if ((tcAbs.y > tcAbs.x) && (tcAbs.y > tcAbs.z)) {\n        dirX = vec4(1,0,0, tc.x);\n        dirY = vec4(0,0,1, tc.z);\n        majorAxisLength = tc.y;\n    }\n\n    float shadowParamsInFaceSpace = ((1.0/shadowParams.x) * 2.0) * abs(majorAxisLength);\n\n    vec3 xoffset = (dirX.xyz * shadowParamsInFaceSpace);\n    vec3 yoffset = (dirY.xyz * shadowParamsInFaceSpace);\n    vec3 dx0 = -xoffset;\n    vec3 dy0 = -yoffset;\n    vec3 dx1 = xoffset;\n    vec3 dy1 = yoffset;\n\n    mat3 shadowKernel;\n    mat3 depthKernel;\n\n    depthKernel[0][0] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy0));\n    depthKernel[0][1] = unpackFloat(textureCube(shadowMap, tc + dx0));\n    depthKernel[0][2] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy1));\n    depthKernel[1][0] = unpackFloat(textureCube(shadowMap, tc + dy0));\n    depthKernel[1][1] = unpackFloat(textureCube(shadowMap, tc));\n    depthKernel[1][2] = unpackFloat(textureCube(shadowMap, tc + dy1));\n    depthKernel[2][0] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy0));\n    depthKernel[2][1] = unpackFloat(textureCube(shadowMap, tc + dx1));\n    depthKernel[2][2] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy1));\n\n    vec3 shadowZ = vec3(length(dir) * shadowParams.w + shadowParams.z);\n\n    shadowKernel[0] = vec3(lessThan2(depthKernel[0], shadowZ));\n    shadowKernel[1] = vec3(lessThan2(depthKernel[1], shadowZ));\n    shadowKernel[2] = vec3(lessThan2(depthKernel[2], shadowZ));\n\n    vec2 uv = (vec2(dirX.w, dirY.w) / abs(majorAxisLength)) * 0.5;\n\n    vec2 fractionalCoord = fract( uv * shadowParams.x );\n\n    shadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n    shadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\n    vec4 shadowValues;\n    shadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n    shadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n    shadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n    shadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\n    return 1.0 - dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\n\nfloat getShadowPointPCF3x3(samplerCube shadowMap, vec4 shadowParams) {\n    return _getShadowPoint(shadowMap, shadowParams, dLightDirW);\n}\n",shadowStandardGL2PS:"\nfloat _getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n    // http://the-witness.net/news/2013/09/shadow-mapping-summary-part-1/\n\n    float z = dShadowCoord.z;\n    vec2 uv = dShadowCoord.xy * shadowParams.x; // 1 unit - 1 texel\n    float shadowMapSizeInv = 1.0 / shadowParams.x;\n    vec2 base_uv = floor(uv + 0.5);\n    float s = (uv.x + 0.5 - base_uv.x);\n    float t = (uv.y + 0.5 - base_uv.y);\n    base_uv -= vec2(0.5);\n    base_uv *= shadowMapSizeInv;\n\n\n    float uw0 = (4.0 - 3.0 * s);\n    float uw1 = 7.0;\n    float uw2 = (1.0 + 3.0 * s);\n\n    float u0 = (3.0 - 2.0 * s) / uw0 - 2.0;\n    float u1 = (3.0 + s) / uw1;\n    float u2 = s / uw2 + 2.0;\n\n    float vw0 = (4.0 - 3.0 * t);\n    float vw1 = 7.0;\n    float vw2 = (1.0 + 3.0 * t);\n\n    float v0 = (3.0 - 2.0 * t) / vw0 - 2.0;\n    float v1 = (3.0 + t) / vw1;\n    float v2 = t / vw2 + 2.0;\n\n    float sum = 0.0;\n\n    u0 = u0 * shadowMapSizeInv + base_uv.x;\n    v0 = v0 * shadowMapSizeInv + base_uv.y;\n\n    u1 = u1 * shadowMapSizeInv + base_uv.x;\n    v1 = v1 * shadowMapSizeInv + base_uv.y;\n\n    u2 = u2 * shadowMapSizeInv + base_uv.x;\n    v2 = v2 * shadowMapSizeInv + base_uv.y;\n\n    sum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n    sum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n    sum += uw2 * vw0 * texture(shadowMap, vec3(u2, v0, z));\n\n    sum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n    sum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n    sum += uw2 * vw1 * texture(shadowMap, vec3(u2, v1, z));\n\n    sum += uw0 * vw2 * texture(shadowMap, vec3(u0, v2, z));\n    sum += uw1 * vw2 * texture(shadowMap, vec3(u1, v2, z));\n    sum += uw2 * vw2 * texture(shadowMap, vec3(u2, v2, z));\n\n    sum *= 1.0f / 144.0;\n\n    sum = gammaCorrectInput(sum); // gives softer gradient\n    sum = saturate(sum);\n\n    return sum;\n}\n\nfloat getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n    return _getShadowPCF5x5(shadowMap, shadowParams);\n}\n\nfloat getShadowSpotPCF5x5(sampler2DShadow shadowMap, vec4 shadowParams) {\n    return _getShadowPCF5x5(shadowMap, shadowParams.xyz);\n}\n",shadowVSM8PS:"\nfloat calculateVSM8(vec3 moments, float Z, float vsmBias) {\n    float VSMBias = vsmBias;//0.01 * 0.25;\n    float depthScale = VSMBias * Z;\n    float minVariance1 = depthScale * depthScale;\n    return chebyshevUpperBound(moments.xy, Z, minVariance1, 0.1);\n}\n\nfloat decodeFloatRG(vec2 rg) {\n    return rg.y*(1.0/255.0) + rg.x;\n}\n\nfloat VSM8(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n    vec4 c = texture2D(tex, texCoords);\n    vec3 moments = vec3(decodeFloatRG(c.xy), decodeFloatRG(c.zw), 0.0);\n    return calculateVSM8(moments, Z, vsmBias);\n}\n\nfloat getShadowVSM8(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n    return VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, 0.0);\n}\n\nfloat getShadowSpotVSM8(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n    return VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, 0.0);\n}\n",shadowVSM_commonPS:"\nfloat linstep(float a, float b, float v) {\n    return saturate((v - a) / (b - a));\n}\n\nfloat reduceLightBleeding(float pMax, float amount) {\n   // Remove the [0, amount] tail and linearly rescale (amount, 1].\n   return linstep(amount, 1.0, pMax);\n}\n\nfloat chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {\n    // Compute variance\n    float variance = moments.y - (moments.x * moments.x);\n    variance = max(variance, minVariance);\n\n    // Compute probabilistic upper bound\n    float d = mean - moments.x;\n    float pMax = variance / (variance + (d * d));\n\n    pMax = reduceLightBleeding(pMax, lightBleedingReduction);\n\n    // One-tailed Chebyshev\n    return (mean <= moments.x ? 1.0 : pMax);\n}\n\nfloat calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {\n    Z = 2.0 * Z - 1.0;\n    float warpedDepth = exp(exponent * Z);\n\n    moments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);\n\n    float VSMBias = vsmBias;//0.01 * 0.25;\n    float depthScale = VSMBias * exponent * warpedDepth;\n    float minVariance1 = depthScale * depthScale;\n    return chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);\n}\n",skinBatchConstVS:"\nattribute float vertex_boneIndices;\n\nuniform vec4 matrix_pose[BONE_LIMIT * 3];\n\nmat4 getBoneMatrix(const in float i) {\n    // read 4x3 matrix\n    vec4 v1 = matrix_pose[int(3.0 * i)];\n    vec4 v2 = matrix_pose[int(3.0 * i + 1.0)];\n    vec4 v3 = matrix_pose[int(3.0 * i + 2.0)];\n\n    // transpose to 4x4 matrix\n    return mat4(\n        v1.x, v2.x, v3.x, 0,\n        v1.y, v2.y, v3.y, 0,\n        v1.z, v2.z, v3.z, 0,\n        v1.w, v2.w, v3.w, 1\n    );\n}\n",skinBatchTexVS:"\nattribute float vertex_boneIndices;\n\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\n\nmat4 getBoneMatrix(const in float i) {\n    float j = i * 3.0;\n    float dx = texture_poseMapSize.z;\n    float dy = texture_poseMapSize.w;\n\n    float y = floor(j * dx);\n    float x = j - (y * texture_poseMapSize.x);\n    y = dy * (y + 0.5);\n\n    // read elements of 4x3 matrix\n    vec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n    vec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n    vec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n\n    // transpose to 4x4 matrix\n    return mat4(\n        v1.x, v2.x, v3.x, 0,\n        v1.y, v2.y, v3.y, 0,\n        v1.z, v2.z, v3.z, 0,\n        v1.w, v2.w, v3.w, 1\n    );\n}\n",skinConstVS:"\nattribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\n\nuniform vec4 matrix_pose[BONE_LIMIT * 3];\n\nvoid getBoneMatrix(const in float i, out vec4 v1, out vec4 v2, out vec4 v3) {\n    // read 4x3 matrix\n    v1 = matrix_pose[int(3.0 * i)];\n    v2 = matrix_pose[int(3.0 * i + 1.0)];\n    v3 = matrix_pose[int(3.0 * i + 2.0)];\n}\n\nmat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {\n    // get 4 bone matrices\n    vec4 a1, a2, a3;\n    getBoneMatrix(indices.x, a1, a2, a3);\n\n    vec4 b1, b2, b3;\n    getBoneMatrix(indices.y, b1, b2, b3);\n\n    vec4 c1, c2, c3;\n    getBoneMatrix(indices.z, c1, c2, c3);\n\n    vec4 d1, d2, d3;\n    getBoneMatrix(indices.w, d1, d2, d3);\n\n    // multiply them by weights and add up to get final 4x3 matrix\n    vec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n    vec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n    vec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\n    // add up weights\n    float one = dot(weights, vec4(1.0));\n\n    // transpose to 4x4 matrix\n    return mat4(\n        v1.x, v2.x, v3.x, 0,\n        v1.y, v2.y, v3.y, 0,\n        v1.z, v2.z, v3.z, 0,\n        v1.w, v2.w, v3.w, one\n    );\n}\n",skinTexVS:"\nattribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\n\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\n\nvoid getBoneMatrix(const in float i, out vec4 v1, out vec4 v2, out vec4 v3) {\n    float j = i * 3.0;\n    float dx = texture_poseMapSize.z;\n    float dy = texture_poseMapSize.w;\n    \n    float y = floor(j * dx);\n    float x = j - (y * texture_poseMapSize.x);\n    y = dy * (y + 0.5);\n\n    // read elements of 4x3 matrix\n    v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n    v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n    v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n}\n\nmat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {\n    // get 4 bone matrices\n    vec4 a1, a2, a3;\n    getBoneMatrix(indices.x, a1, a2, a3);\n\n    vec4 b1, b2, b3;\n    getBoneMatrix(indices.y, b1, b2, b3);\n\n    vec4 c1, c2, c3;\n    getBoneMatrix(indices.z, c1, c2, c3);\n\n    vec4 d1, d2, d3;\n    getBoneMatrix(indices.w, d1, d2, d3);\n\n    // multiply them by weights and add up to get final 4x3 matrix\n    vec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n    vec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n    vec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\n    // add up weights\n    float one = dot(weights, vec4(1.0));\n\n    // transpose to 4x4 matrix\n    return mat4(\n        v1.x, v2.x, v3.x, 0,\n        v1.y, v2.y, v3.y, 0,\n        v1.z, v2.z, v3.z, 0,\n        v1.w, v2.w, v3.w, one\n    );\n}\n",skyboxEnvPS:"\nvarying vec3 vViewDir;\n\nuniform sampler2D texture_envAtlas;\nuniform float mipLevel;\n\nvoid main(void) {\n    vec3 dir = vViewDir * vec3(-1.0, 1.0, 1.0);\n    vec2 uv = toSphericalUv(normalize(dir));\n\n    vec3 linear = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, mipLevel)));\n\n    gl_FragColor = vec4(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);\n}\n",skyboxHDRPS:"\nvarying vec3 vViewDir;\n\nuniform samplerCube texture_cubeMap;\n\nvoid main(void) {\n    vec3 dir=vViewDir;\n    dir.x *= -1.0;\n\n    vec3 linear = $DECODE(textureCube(texture_cubeMap, fixSeamsStatic(dir, $FIXCONST)));\n\n    gl_FragColor = vec4(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);\n}\n",skyboxVS:"\nattribute vec3 aPosition;\n\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n\nuniform mat4 matrix_projectionSkybox;\nuniform mat3 cubeMapRotationMatrix;\n\nvarying vec3 vViewDir;\n\nvoid main(void) {\n    mat4 view = matrix_view;\n    view[3][0] = view[3][1] = view[3][2] = 0.0;\n    gl_Position = matrix_projectionSkybox * view * vec4(aPosition, 1.0);\n\n    // Force skybox to far Z, regardless of the clip planes on the camera\n    // Subtract a tiny fudge factor to ensure floating point errors don't\n    // still push pixels beyond far Z. See:\n    // http://www.opengl.org/discussion_boards/showthread.php/171867-skybox-problem\n\n    gl_Position.z = gl_Position.w - 0.00001;\n    vViewDir = aPosition * cubeMapRotationMatrix;\n}\n",specularPS:"\n\n#ifdef MAPCOLOR\nuniform vec3 material_specular;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_specularMap;\n#endif\n\nvoid getSpecularity() {\n    vec3 specularColor = vec3(1,1,1);\n\n    #ifdef MAPCOLOR\n    specularColor *= material_specular;\n    #endif\n\n    #ifdef MAPTEXTURE\n    specularColor *= $DECODE(texture2DBias(texture_specularMap, $UV, textureBias)).$CH;\n    #endif\n\n    #ifdef MAPVERTEX\n    specularColor *= saturate(vVertexColor.$VC);\n    #endif\n\n    dSpecularity = specularColor;\n}\n",sphericalPS:"\n// equirectangular helper functions\nconst float PI = 3.141592653589793;\n\nvec2 toSpherical(vec3 dir) {\n    return vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));\n}\n\nvec2 toSphericalUv(vec3 dir) {\n    vec2 uv = toSpherical(dir) / vec2(PI * 2.0, PI) + 0.5;\n    return vec2(uv.x, 1.0 - uv.y);\n}\n",specularityFactorPS:"\n\n#ifdef MAPFLOAT\nuniform float material_specularityFactor;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_specularityFactorMap;\n#endif\n\nvoid getSpecularityFactor() {\n    float specularityFactor = 1.0;\n\n    #ifdef MAPFLOAT\n    specularityFactor *= material_specularityFactor;\n    #endif\n\n    #ifdef MAPTEXTURE\n    specularityFactor *= texture2DBias(texture_specularityFactorMap, $UV, textureBias).$CH;\n    #endif\n\n    #ifdef MAPVERTEX\n    specularityFactor *= saturate(vVertexColor.$VC);\n    #endif\n\n    dSpecularityFactor = specularityFactor;\n}\n",spotPS:"\nfloat getSpotEffect(vec3 lightSpotDirW, float lightInnerConeAngle, float lightOuterConeAngle) {\n    float cosAngle = dot(dLightDirNormW, lightSpotDirW);\n    return smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n",startPS:"\nvoid main(void) {\n    dReflection = vec4(0);\n\n    #ifdef LIT_CLEARCOAT\n    ccSpecularLight = vec3(0);\n    ccReflection = vec4(0);\n    #endif\n",startVS:"\nvoid main(void) {\n    gl_Position = getPosition();\n",startNineSlicedPS:"\n    nineSlicedUv = vUv0;\n    nineSlicedUv.y = 1.0 - nineSlicedUv.y;\n\n",startNineSlicedTiledPS:"\n    vec2 tileMask = step(vMask, vec2(0.99999));\n    vec2 tileSize = 0.5 * (innerOffset.xy + innerOffset.zw);\n    vec2 tileScale = vec2(1.0) / (vec2(1.0) - tileSize);\n    vec2 clampedUv = mix(innerOffset.xy * 0.5, vec2(1.0) - innerOffset.zw * 0.5, fract((vTiledUv - tileSize) * tileScale));\n    clampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\n    nineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);\n    nineSlicedUv.y = 1.0 - nineSlicedUv.y;\n    \n",storeEVSMPS:"\nfloat exponent = VSM_EXPONENT;\n\ndepth = 2.0 * depth - 1.0;\ndepth =  exp(exponent * depth);\ngl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);\n",tangentBinormalVS:"\nvec3 getTangent() {\n    return normalize(dNormalMatrix * vertex_tangent.xyz);\n}\n\nvec3 getBinormal() {\n    return cross(vNormalW, vTangentW) * vertex_tangent.w;\n}\n\nvec3 getObjectSpaceUp() {\n    return normalize(dNormalMatrix * vec3(0, 1, 0));\n}\n",TBNPS:"\nvoid getTBN() {\n    dTBN = mat3(normalize(dTangentW), normalize(dBinormalW), normalize(dVertexNormalW));\n}\n",TBNderivativePS:"\nuniform float tbnBasis;\n\n// http://www.thetenthplanet.de/archives/1180\nvoid getTBN() {\n    vec2 uv = $UV;\n\n    // get edge vectors of the pixel triangle\n    vec3 dp1 = dFdx( vPositionW );\n    vec3 dp2 = dFdy( vPositionW );\n    vec2 duv1 = dFdx( uv );\n    vec2 duv2 = dFdy( uv );\n\n    // solve the linear system\n    vec3 dp2perp = cross( dp2, dVertexNormalW );\n    vec3 dp1perp = cross( dVertexNormalW, dp1 );\n    vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n    vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\n    // construct a scale-invariant frame\n    float denom = max( dot(T,T), dot(B,B) );\n    float invmax = (denom == 0.0) ? 0.0 : tbnBasis / sqrt( denom );\n    dTBN = mat3(T * invmax, -B * invmax, dVertexNormalW );\n}\n",TBNfastPS:"\nvoid getTBN() {\n    dTBN = mat3(dTangentW, dBinormalW, dVertexNormalW);\n}\n",TBNObjectSpacePS:"\nvoid getTBN() {\n\n    vec3 B = cross(dVertexNormalW, vObjectSpaceUpW);\n    vec3 T = cross(dVertexNormalW, B);\n\n    if (dot(B,B)==0.0) // deal with case when vObjectSpaceUpW dVertexNormalW are parallel\n    {\n        float major=max(max(dVertexNormalW.x, dVertexNormalW.y),dVertexNormalW.z);\n\n        if (dVertexNormalW.x==major)\n        {\n            B=cross(dVertexNormalW, vec3(0,1,0));\n            T=cross(dVertexNormalW, B);\n        }\n        else if (dVertexNormalW.y==major)\n        {\n            B=cross(dVertexNormalW, vec3(0,0,1));\n            T=cross(dVertexNormalW, B);\n        }\n        else if (dVertexNormalW.z==major)\n        {\n            B=cross(dVertexNormalW, vec3(1,0,0));\n            T=cross(dVertexNormalW, B);\n        }\n    }\n\n    dTBN = mat3(normalize(T), normalize(B), normalize(dVertexNormalW));\n}\n",textureSamplePS:"\nvec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n    return gammaCorrectInput(texture2D(tex, uv));\n}\n\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n    return gammaCorrectInput(texture2D(tex, uv, bias));\n}\n\nvec3 texture2DRGBM(sampler2D tex, vec2 uv) {\n    return decodeRGBM(texture2D(tex, uv));\n}\n\nvec3 texture2DRGBM(sampler2D tex, vec2 uv, float bias) {\n    return decodeRGBM(texture2D(tex, uv, bias));\n}\n\nvec3 texture2DRGBE(sampler2D tex, vec2 uv) {\n    return decodeRGBM(texture2D(tex, uv));\n}\n\nvec3 texture2DRGBE(sampler2D tex, vec2 uv, float bias) {\n    return decodeRGBM(texture2D(tex, uv, bias));\n}\n",thicknessPS:"\n#ifdef MAPFLOAT\nuniform float material_thickness;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_thicknessMap;\n#endif\n\nvoid getThickness() {\n    dThickness = 1.0;\n\n    #ifdef MAPFLOAT\n    dThickness *= material_thickness;\n    #endif\n\n    #ifdef MAPTEXTURE\n    dThickness *= texture2DBias(texture_thicknessMap, $UV, textureBias).$CH;\n    #endif\n\n    #ifdef MAPVERTEX\n    dThickness *= saturate(vVertexColor.$VC);\n    #endif\n}\n",tonemappingAcesPS:"\nuniform float exposure;\n\nvec3 toneMap(vec3 color) {\n    float tA = 2.51;\n    float tB = 0.03;\n    float tC = 2.43;\n    float tD = 0.59;\n    float tE = 0.14;\n    vec3 x = color * exposure;\n    return (x*(tA*x+tB))/(x*(tC*x+tD)+tE);\n}\n",tonemappingAces2PS:"\nuniform float exposure;\n\n// ACES approximation by Stephen Hill\n\n// sRGB => XYZ => D65_2_D60 => AP1 => RRT_SAT\nconst mat3 ACESInputMat = mat3(\n    0.59719, 0.35458, 0.04823,\n    0.07600, 0.90834, 0.01566,\n    0.02840, 0.13383, 0.83777\n);\n\n// ODT_SAT => XYZ => D60_2_D65 => sRGB\nconst mat3 ACESOutputMat = mat3(\n     1.60475, -0.53108, -0.07367,\n    -0.10208,  1.10813, -0.00605,\n    -0.00327, -0.07276,  1.07602\n);\n\nvec3 RRTAndODTFit(vec3 v) {\n    vec3 a = v * (v + 0.0245786) - 0.000090537;\n    vec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;\n    return a / b;\n}\n\nvec3 toneMap(vec3 color) {\n    color *= exposure;\n    color = color * ACESInputMat;\n\n    // Apply RRT and ODT\n    color = RRTAndODTFit(color);\n    color = color * ACESOutputMat;\n\n    // Clamp to [0, 1]\n    color = clamp(color, 0.0, 1.0);\n\n    return color;\n}\n",tonemappingFilmicPS:"\nconst float A =  0.15;\nconst float B =  0.50;\nconst float C =  0.10;\nconst float D =  0.20;\nconst float E =  0.02;\nconst float F =  0.30;\nconst float W =  11.2;\n\nuniform float exposure;\n\nvec3 uncharted2Tonemap(vec3 x) {\n   return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\n\nvec3 toneMap(vec3 color) {\n    color = uncharted2Tonemap(color * exposure);\n    vec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));\n    color = color * whiteScale;\n\n    return color;\n}\n",tonemappingHejlPS:"\nuniform float exposure;\n\nvec3 toneMap(vec3 color) {\n    color *= exposure;\n    const float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;\n    const float Scl = 1.25;\n\n    vec3 h = max( vec3(0.0), color - vec3(0.004) );\n    return (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);\n}\n",tonemappingLinearPS:"\nuniform float exposure;\n\nvec3 toneMap(vec3 color) {\n    return color * exposure;\n}\n",tonemappingNonePS:"\nvec3 toneMap(vec3 color) {\n    return color;\n}\n",transformVS:"\n#ifdef PIXELSNAP\nuniform vec4 uScreenSize;\n#endif\n\n#ifdef SCREENSPACE\nuniform float projectionFlipY;\n#endif\n\n#ifdef MORPHING\nuniform vec4 morph_weights_a;\nuniform vec4 morph_weights_b;\n#endif\n\n#ifdef MORPHING_TEXTURE_BASED\nuniform vec4 morph_tex_params;\n\nvec2 getTextureMorphCoords() {\n    float vertexId = morph_vertex_id;\n    vec2 textureSize = morph_tex_params.xy;\n    vec2 invTextureSize = morph_tex_params.zw;\n\n    // turn vertexId into int grid coordinates\n    float morphGridV = floor(vertexId * invTextureSize.x);\n    float morphGridU = vertexId - (morphGridV * textureSize.x);\n\n    // convert grid coordinates to uv coordinates with half pixel offset\n    return (vec2(morphGridU, morphGridV) * invTextureSize) + (0.5 * invTextureSize);\n}\n#endif\n\n#ifdef MORPHING_TEXTURE_BASED_POSITION\nuniform highp sampler2D morphPositionTex;\n#endif\n\nmat4 getModelMatrix() {\n    #ifdef DYNAMICBATCH\n    return getBoneMatrix(vertex_boneIndices);\n    #elif defined(SKIN)\n    return matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);\n    #elif defined(INSTANCING)\n    return mat4(instance_line1, instance_line2, instance_line3, instance_line4);\n    #else\n    return matrix_model;\n    #endif\n}\n\nvec4 getPosition() {\n    dModelMatrix = getModelMatrix();\n    vec3 localPos = vertex_position;\n\n    #ifdef NINESLICED\n    // outer and inner vertices are at the same position, scale both\n    localPos.xz *= outerScale;\n\n    // offset inner vertices inside\n    // (original vertices must be in [-1;1] range)\n    vec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n    vec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n    localPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\n    vTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0; // uv = local pos - inner corner\n\n    localPos.xz *= -0.5; // move from -1;1 to -0.5;0.5\n    localPos = localPos.xzy;\n    #endif\n\n    #ifdef MORPHING\n    #ifdef MORPHING_POS03\n    localPos.xyz += morph_weights_a[0] * morph_pos0;\n    localPos.xyz += morph_weights_a[1] * morph_pos1;\n    localPos.xyz += morph_weights_a[2] * morph_pos2;\n    localPos.xyz += morph_weights_a[3] * morph_pos3;\n    #endif // MORPHING_POS03\n    #ifdef MORPHING_POS47\n    localPos.xyz += morph_weights_b[0] * morph_pos4;\n    localPos.xyz += morph_weights_b[1] * morph_pos5;\n    localPos.xyz += morph_weights_b[2] * morph_pos6;\n    localPos.xyz += morph_weights_b[3] * morph_pos7;\n    #endif // MORPHING_POS47\n    #endif // MORPHING\n\n    #ifdef MORPHING_TEXTURE_BASED_POSITION\n    // apply morph offset from texture\n    vec2 morphUV = getTextureMorphCoords();\n    vec3 morphPos = texture2D(morphPositionTex, morphUV).xyz;\n    localPos += morphPos;\n    #endif\n\n    vec4 posW = dModelMatrix * vec4(localPos, 1.0);\n    #ifdef SCREENSPACE\n    posW.zw = vec2(0.0, 1.0);\n    #endif\n    dPositionW = posW.xyz;\n\n    vec4 screenPos;\n    #ifdef UV1LAYOUT\n    screenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);\n    #else\n    #ifdef SCREENSPACE\n    screenPos = posW;\n    screenPos.y *= projectionFlipY;\n    #else\n    screenPos = matrix_viewProjection * posW;\n    #endif\n\n    #ifdef PIXELSNAP\n    // snap vertex to a pixel boundary\n    screenPos.xy = (screenPos.xy * 0.5) + 0.5;\n    screenPos.xy *= uScreenSize.xy;\n    screenPos.xy = floor(screenPos.xy);\n    screenPos.xy *= uScreenSize.zw;\n    screenPos.xy = (screenPos.xy * 2.0) - 1.0;\n    #endif\n    #endif\n\n    return screenPos;\n}\n\nvec3 getWorldPosition() {\n    return dPositionW;\n}\n",transformDeclVS:"\nattribute vec3 vertex_position;\n\nuniform mat4 matrix_model;\nuniform mat4 matrix_viewProjection;\n\nvec3 dPositionW;\nmat4 dModelMatrix;\n",transmissionPS:"\n\n#ifdef MAPFLOAT\nuniform float material_refraction;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_refractionMap;\n#endif\n\nvoid getRefraction() {\n    float refraction = 1.0;\n\n    #ifdef MAPFLOAT\n    refraction = material_refraction;\n    #endif\n\n    #ifdef MAPTEXTURE\n    refraction *= gammaCorrectInput(texture2DBias(texture_refractionMap, $UV, textureBias)).$CH;\n    #endif\n\n    #ifdef MAPVERTEX\n    refraction *= saturate(vVertexColor.$VC);\n    #endif\n\n    dTransmission = refraction;\n}\n",uv0VS:"\n#ifdef NINESLICED\nvec2 getUv0() {\n    vec2 uv = vertex_position.xz;\n\n    // offset inner vertices inside\n    // (original vertices must be in [-1;1] range)\n    vec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n    vec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n    uv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\n    uv = uv * -0.5 + 0.5;\n    uv = uv * atlasRect.zw + atlasRect.xy;\n\n    vMask = vertex_texCoord0.xy;\n\n    return uv;\n}\n#else\nvec2 getUv0() {\n    return vertex_texCoord0;\n}\n#endif\n",uv1VS:"\nvec2 getUv1() {\n    return vertex_texCoord1;\n}\n",viewDirPS:"\nvoid getViewDir() {\n    dViewDirW = normalize(view_position - vPositionW);\n}\n",viewNormalVS:"\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n\nvec3 getViewNormal() {\n    return mat3(matrix_view) * vNormalW;\n}\n",webgpuPS:"\n\nlayout(location = 0) out highp vec4 pc_fragColor;\n#define gl_FragColor pc_fragColor\n\n#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)\n#define texture2DBias(res, uv, bias) texture(sampler2D(res, res ## _sampler), uv, bias)\n\n// TODO: implement other texture sampling macros\n// #define textureCube texture\n// #define texture2DProj textureProj\n// #define texture2DLodEXT textureLod\n// #define texture2DProjLodEXT textureProjLod\n// #define textureCubeLodEXT textureLod\n// #define texture2DGradEXT textureGrad\n// #define texture2DProjGradEXT textureProjGrad\n// #define textureCubeGradEXT textureGrad\n#define GL2\n#define SUPPORTS_TEXLOD\n",webgpuVS:"\n#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)\n\n#define GL2\n#define VERTEXSHADER\n"};class zo{static getType(e){switch(e){case 0:case 1:return"forward";case 2:return"depth";case 3:return"pick";default:return e>=4&&e<22?"shadow":"forward"}}static isForward(e){return"forward"===this.getType(e)}static isShadow(e){return"shadow"===this.getType(e)}static toLightType(e){const t=e-4;return Math.floor(t/6)}static toShadowType(e){const t=e-4;return t-6*Math.floor(t/6)}static getShadow(e,t){return 4+(t+6*e)}static getPassShaderDefine(e){return 3===e?"#define PICK_PASS\n":2===e?"#define DEPTH_PASS\n":zo.isShadow(e)?"#define SHADOW_PASS\n":""}}function Uo(e,t){return t||(t=Bo),1===e||2===e?t.gamma2_2PS?t.gamma2_2PS:Bo.gamma2_2PS:3===e?"#define HDR\n"+(t.gamma2_2PS?t.gamma2_2PS:Bo.gamma2_2PS):t.gamma1_0PS?t.gamma1_0PS:Bo.gamma1_0PS}function Vo(e,t){return t||(t=Bo),1===e?t.tonemappingFilmicPS?t.tonemappingFilmicPS:Bo.tonemappingFilmicPS:0===e?t.tonemappingLinearPS?t.tonemappingLinearPS:Bo.tonemappingLinearPS:2===e?t.tonemappingHejlPS?t.tonemappingHejlPS:Bo.tonemappingHejlPS:3===e?t.tonemappingAcesPS?t.tonemappingAcesPS:Bo.tonemappingAcesPS:4===e?t.tonemappingAces2PS?t.tonemappingAces2PS:Bo.tonemappingAces2PS:t.tonemapingNonePS?t.tonemapingNonePS:Bo.tonemappingNonePS}function No(e,t){return t||(t=Bo),"linear"===e?t.fogLinearPS?t.fogLinearPS:Bo.fogLinearPS:"exp"===e?t.fogExpPS?t.fogExpPS:Bo.fogExpPS:"exp2"===e?t.fogExp2PS?t.fogExp2PS:Bo.fogExp2PS:t.fogNonePS?t.fogNonePS:Bo.fogNonePS}function Go(e,t){return t||(t=Bo),e.supportsBoneTextures?t.skinTexVS:"#define BONE_LIMIT "+e.getBoneLimit()+"\n"+t.skinConstVS}function Wo(e,t,s){let i="";if("webgl"===e.deviceType){t&&"highp"!==t&&"mediump"!==t&&"lowp"!==t&&(t=null),t&&("highp"===t&&"highp"!==e.maxPrecision&&(t="mediump"),"mediump"===t&&"lowp"===e.maxPrecision&&(t="lowp"));const n=t||e.precision;i=`precision ${n} float;\n`,s&&e.webgl2&&(i+=`precision ${n} sampler2DShadow;\n`)}return i}function Ho(e){return"webgpu"===e.deviceType?"#version 450\n":e.webgl2?"#version 300 es\n":""}function Xo(e){return`#define SHADER_NAME ${e}\n`}function qo(e,t,s,i){let n=Ho(e);return"webgpu"===e.deviceType?n+=Bo.webgpuVS:(i&&(n+=i+"\n"),e.webgl2&&(n+=Bo.gles3VS)),n+=Xo(t),n+=zo.getPassShaderDefine(s),n}function jo(e,t,s,i,n){let a=Ho(e);return"webgpu"===e.deviceType?a+=Bo.webgpuPS:(i&&(a+=i+"\n"),e.webgl2?a+=Bo.gles3PS:(e.extStandardDerivatives&&(a+="#extension GL_OES_standard_derivatives : enable\n"),e.extTextureLod&&(a+="#extension GL_EXT_shader_texture_lod : enable\n",a+="#define SUPPORTS_TEXLOD\n"),a+=Bo.gles2PS)),a+=Wo(e,n,!0),a+=Xo(t),a+=zo.getPassShaderDefine(s),a}function Yo(){return"void main(void) {gl_FragColor = vec4(0.0);}"}function $o(){return"void main(void)\n{\n"}function Ko(){return"}\n"}const Zo={vertex_position:"POSITION",vertex_normal:"NORMAL",vertex_tangent:"TANGENT",vertex_texCoord0:"TEXCOORD0",vertex_texCoord1:"TEXCOORD1",vertex_texCoord2:"TEXCOORD2",vertex_texCoord3:"TEXCOORD3",vertex_texCoord4:"TEXCOORD4",vertex_texCoord5:"TEXCOORD5",vertex_texCoord6:"TEXCOORD6",vertex_texCoord7:"TEXCOORD7",vertex_color:"COLOR",vertex_boneIndices:"BLENDINDICES",vertex_boneWeights:"BLENDWEIGHT"};function Qo(e){const t={};let s=0,i=e.indexOf("attribute");for(;i>=0&&!(i>0&&"/"===e[i-1]);){const n=e.indexOf(";",i),a=e.lastIndexOf(" ",n),r=e.substring(a+1,n),o=Zo[r];void 0!==o?t[r]=o:(t[r]="ATTR"+s,s++),i=e.indexOf("attribute",i+1)}return t}function Jo(e,t,s,i=!1){let n=Bo[t],a=Wo(e)+"\n"+Bo[s];const r=Qo(n);return"webgpu"===e.deviceType?(n=Ho(e)+Bo.webgpuVS+n,a=Ho(e)+Bo.webgpuPS+a):e.webgl2&&(n=Ho(e)+Bo.gles3VS+n,a=Ho(e)+Bo.gles3PS+a),new Oo(e,{attributes:r,vshader:n,fshader:a,useTransformFeedback:i,name:`${t}_${s}`})}function eh(e,t,s,i,n=!1,a=""){const r=e.programLib._cache,o=r[i];if(void 0!==o)return o;s=Wo(e)+"\n"+(s||"void main(void) {gl_FragColor = vec4(0.0);}");const h=Qo(t);return"webgpu"===e.deviceType?(t=Ho(e)+Bo.webgpuVS+t,s=Ho(e)+Bo.webgpuPS+s):e.webgl2&&(t=Ho(e)+Bo.gles3VS+t,s=Ho(e)+Bo.gles3PS+s),r[i]=new Oo(e,{name:i,attributes:h,vshader:t,fshader:a+s,useTransformFeedback:n}),r[i]}Bo.collectAttribs=Qo,Bo.createShader=Jo,Bo.createShaderFromCode=eh;class th{constructor(){this.globalId=0,this.revision=0}equals(e){return this.globalId===e.globalId&&this.revision===e.revision}copy(e){this.globalId=e.globalId,this.revision=e.revision}reset(){this.globalId=0,this.revision=0}}let sh=0;class ih{constructor(){sh++,this.version=new th,this.version.globalId=sh}increment(){this.version.revision++}}class nh{constructor(e){this.name=e,this.value=null,this.versionObject=new ih}toJSON(e){}setValue(e){this.value=e,this.versionObject.increment()}getValue(){return this.value}}class ah{constructor(e){this.name=e,this.variables=new Map}resolve(e){return this.variables.has(e)||this.variables.set(e,new nh(e)),this.variables.get(e)}removeValue(e){for(const t in this.variables){const s=this.variables[t];s.value===e&&(s.value=null)}}}const rh={linear:"decodeLinear",srgb:"decodeGamma",rgbm:"decodeRGBM",rgbe:"decodeRGBE",rgbp:"decodeRGBP"},oh={linear:"encodeLinear",srgb:"encodeGamma",rgbm:"encodeRGBM",rgbe:"encodeRGBE",rgbp:"encodeRGBP"};class hh{static decodeFunc(e){return rh[e]||"decodeGamma"}static encodeFunc(e){return oh[e]||"encodeGamma"}}const lh=new Float32Array(1),ch=new Int32Array(lh.buffer);class dh{static float2Half(e){lh[0]=e;const t=ch[0];let s=t>>16&32768,i=t>>12&2047;const n=t>>23&255;return n<103?s:n>142?(s|=31744,s|=(255===n?0:1)&&8388607&t,s):n<113?(i|=2048,s|=(i>>114-n)+(i>>113-n&1),s):(s|=n-112<<10|i>>1,s+=1&i,s)}static float2Bytes(e,t,s,i){const n=255*e%1;if(t[s+0]=Math.round(255*(e%1-.00392156862745098*n)),i>1){const a=65025*e%1;if(t[s+1]=Math.round(255*(n-.00392156862745098*a)),i>2){const n=16581375*e%1;t[s+2]=Math.round(255*(a-.00392156862745098*n)),i>3&&(t[s+3]=Math.round(255*n))}}}static float2BytesRange(e,t,s,i,n,a){e=ne.clamp((e-i)/(n-i),0,1),dh.float2Bytes(e,t,s,a)}static float2MantissaExponent(e,t,s,i){const n=Math.floor(Math.log2(Math.abs(e)))+1;e/=Math.pow(2,n),dh.float2BytesRange(e,t,s,-1,1,i-1),t[s+i-1]=Math.round(n+127)}}let uh=null,ph=null,mh=0;class fh{constructor(e,t){this.id=mh++,this.device=e,this.name=null,this._width=4,this._height=4,this._depth=1,this._format=7,this.type="default",this.projection="none",this._cubemap=!1,this._volume=!1,this.fixCubemapSeams=!1,this._flipY=!1,this._premultiplyAlpha=!1,this._isRenderTarget=!1,this._mipmaps=!0,this._minFilter=5,this._magFilter=1,this._anisotropy=1,this._addressU=0,this._addressV=0,this._addressW=0,this._compareOnRead=!1,this._compareFunc=1,void 0!==t&&(void 0!==t.name&&(this.name=t.name),this._width=void 0!==t.width?t.width:this._width,this._height=void 0!==t.height?t.height:this._height,this._format=void 0!==t.format?t.format:this._format,t.hasOwnProperty("type")?this.type=t.type:t.hasOwnProperty("rgbm")?this.type=t.rgbm?"rgbm":"default":t.hasOwnProperty("swizzleGGGR")&&(this.type=t.swizzleGGGR?"swizzleGGGR":"default"),void 0!==t.mipmaps?this._mipmaps=t.mipmaps:this._mipmaps=void 0!==t.autoMipmap?t.autoMipmap:this._mipmaps,this._levels=t.levels,this._cubemap=void 0!==t.cubemap?t.cubemap:this._cubemap,this.fixCubemapSeams=void 0!==t.fixCubemapSeams?t.fixCubemapSeams:this.fixCubemapSeams,this._cubemap?this.projection="cube":t.projection&&"cube"!==t.projection&&(this.projection=t.projection),this._minFilter=void 0!==t.minFilter?t.minFilter:this._minFilter,this._magFilter=void 0!==t.magFilter?t.magFilter:this._magFilter,this._anisotropy=void 0!==t.anisotropy?t.anisotropy:this._anisotropy,this._addressU=void 0!==t.addressU?t.addressU:this._addressU,this._addressV=void 0!==t.addressV?t.addressV:this._addressV,this._compareOnRead=void 0!==t.compareOnRead?t.compareOnRead:this._compareOnRead,this._compareFunc=void 0!==t._compareFunc?t._compareFunc:this._compareFunc,this._flipY=void 0!==t.flipY?t.flipY:this._flipY,this._premultiplyAlpha=void 0!==t.premultiplyAlpha?t.premultiplyAlpha:this._premultiplyAlpha,e.webgl2&&(this._depth=void 0!==t.depth?t.depth:this._depth,this._volume=void 0!==t.volume?t.volume:this._volume,this._addressW=void 0!==t.addressW?t.addressW:this._addressW)),this._compressed=8===this._format||9===this._format||10===this._format||this._format>=21,this._invalid=!1,this._lockedLevel=-1,this._levels||(this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]),this.dirtyAll(),this._gpuSize=0,this.impl=e.createTextureImpl(this),e.textures.push(this)}destroy(){if(this.device){const e=this.device,t=e.textures.indexOf(this);-1!==t&&e.textures.splice(t,1),e.scope.removeValue(this),this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this._gpuSize),this._levels=null,this.device=null}}loseContext(){this.impl.loseContext(),this.dirtyAll()}adjustVramSizeTracking(e,t){e.tex+=t}set minFilter(e){this._minFilter!==e&&(this._minFilter=e,this._parameterFlags|=1)}get minFilter(){return this._minFilter}set magFilter(e){this._magFilter!==e&&(this._magFilter=e,this._parameterFlags|=2)}get magFilter(){return this._magFilter}set addressU(e){this._addressU!==e&&(this._addressU=e,this._parameterFlags|=4)}get addressU(){return this._addressU}set addressV(e){this._addressV!==e&&(this._addressV=e,this._parameterFlags|=8)}get addressV(){return this._addressV}set addressW(e){this.device.webgl2&&this._volume&&e!==this._addressW&&(this._addressW=e,this._parameterFlags|=16)}get addressW(){return this._addressW}set compareOnRead(e){this._compareOnRead!==e&&(this._compareOnRead=e,this._parameterFlags|=32)}get compareOnRead(){return this._compareOnRead}set compareFunc(e){this._compareFunc!==e&&(this._compareFunc=e,this._parameterFlags|=64)}get compareFunc(){return this._compareFunc}set anisotropy(e){this._anisotropy!==e&&(this._anisotropy=e,this._parameterFlags|=128)}get anisotropy(){return this._anisotropy}set autoMipmap(e){this._mipmaps=e}get autoMipmap(){return this._mipmaps}set mipmaps(e){this._mipmaps!==e&&(this._mipmaps=e,e&&(this._needsMipmapsUpload=!0))}get mipmaps(){return this._mipmaps}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get format(){return this._format}get cubemap(){return this._cubemap}get gpuSize(){const e=this.pot&&this._mipmaps&&!(this._compressed&&1===this._levels.length);return fh.calcGpuSize(this._width,this._height,this._depth,this._format,e,this._cubemap)}get volume(){return this._volume}set flipY(e){this._flipY!==e&&(this._flipY=e,this._needsUpload=!0)}get flipY(){return this._flipY}set premultiplyAlpha(e){this._premultiplyAlpha!==e&&(this._premultiplyAlpha=e,this._needsUpload=!0)}get premultiplyAlpha(){return this._premultiplyAlpha}get pot(){return ne.powerOfTwo(this._width)&&ne.powerOfTwo(this._height)}get encoding(){switch(this.type){case"rgbm":return"rgbm";case"rgbe":return"rgbe";case"rgbp":return"rgbp";default:return 11===this.format||13===this.format||12===this.format||14===this.format?"linear":"srgb"}}static calcGpuSize(e,t,s,i,n,a){uh||(uh=[],uh[0]=1,uh[1]=1,uh[2]=2,uh[3]=2,uh[4]=2,uh[5]=2,uh[6]=4,uh[7]=4,uh[11]=8,uh[12]=8,uh[13]=16,uh[14]=16,uh[15]=4,uh[16]=4,uh[17]=4,uh[18]=4,uh[19]=4,uh[20]=4),ph||(ph=[],ph[21]=8,ph[22]=8,ph[24]=8,ph[25]=8,ph[26]=8,ph[27]=8,ph[8]=8,ph[29]=8,ph[23]=16,ph[9]=16,ph[10]=16,ph[28]=16,ph[30]=16);const r=uh.hasOwnProperty(i)?uh[i]:0,o=ph.hasOwnProperty(i)?ph[i]:0;let h=0;for(;;){if(r>0)h+=e*t*s*r;else{let n=Math.floor((e+3)/4);const a=Math.floor((t+3)/4),r=Math.floor((s+3)/4);24!==i&&25!==i||(n=Math.max(Math.floor(n/2),1)),h+=n*a*r*o}if(!n||1===e&&1===t&&1===s)break;e=Math.max(Math.floor(e/2),1),t=Math.max(Math.floor(t/2),1),s=Math.max(Math.floor(s/2),1)}return h*(a?6:1)}dirtyAll(){this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0],this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this._mipmapsUploaded=!1,this._parameterFlags=255}lock(e={}){if(void 0===e.level&&(e.level=0),void 0===e.face&&(e.face=0),void 0===e.mode&&(e.mode=2),this._lockedLevel=e.level,null===this._levels[e.level])switch(this._format){case 0:case 1:this._levels[e.level]=new Uint8Array(this._width*this._height*this._depth);break;case 2:this._levels[e.level]=new Uint8Array(this._width*this._height*this._depth*2);break;case 3:case 4:case 5:this._levels[e.level]=new Uint16Array(this._width*this._height*this._depth);break;case 6:this._levels[e.level]=new Uint8Array(this._width*this._height*this._depth*3);break;case 7:this._levels[e.level]=new Uint8Array(this._width*this._height*this._depth*4);break;case 8:this._levels[e.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*8*this._depth);break;case 9:case 10:this._levels[e.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*16*this._depth);break;case 11:this._levels[e.level]=new Uint16Array(this._width*this._height*this._depth*3);break;case 13:this._levels[e.level]=new Float32Array(this._width*this._height*this._depth*3);break;case 12:this._levels[e.level]=new Uint16Array(this._width*this._height*this._depth*4);break;case 14:this._levels[e.level]=new Float32Array(this._width*this._height*this._depth*4)}return this._levels[e.level]}setSource(e,t=0){let s,i,n=!1;if(this._cubemap){if(e[0]){s=e[0].width||0,i=e[0].height||0;for(let t=0;t<6;t++){const a=e[t];if(!a||a.width!==s||a.height!==i||!this.device._isBrowserInterface(a)){n=!0;break}}}else n=!0;if(!n)for(let s=0;s<6;s++)this._levels[t][s]!==e[s]&&(this._levelsUpdated[t][s]=!0)}else this.device._isBrowserInterface(e)||(n=!0),n||(e!==this._levels[t]&&(this._levelsUpdated[t]=!0),s=e.width,i=e.height);if(n)if(this._width=4,this._height=4,this._cubemap)for(let e=0;e<6;e++)this._levels[t][e]=null,this._levelsUpdated[t][e]=!0;else this._levels[t]=null,this._levelsUpdated[t]=!0;else 0===t&&(this._width=s,this._height=i),this._levels[t]=e;this._invalid===n&&n||(this._invalid=n,this.upload())}getSource(e=0){return this._levels[e]}unlock(){this._lockedLevel,this.upload(),this._lockedLevel=-1}upload(){this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps}getDds(){let e=128,t=0;for(;this._levels[t];){if(this.cubemap)for(let s=0;s<6;s++){if(!this._levels[t][s])return;const i=this._levels[t][s].length;if(!i)return;e+=i}else{const s=this._levels[t].length;if(!s)return;e+=s}e+=this._levels[t].length,t++}const s=new ArrayBuffer(e),i=new Uint32Array(s,0,32);let n=528391;this._levels.length>1&&(n|=131072);let a=4096;this._levels.length>1&&(a|=4194304),(this._levels.length>1||this.cubemap)&&(a|=8);const r=this.cubemap?65024:0;i[0]=542327876,i[1]=124,i[2]=n,i[3]=this.height,i[4]=this.width,i[5]=this.width*this.height*4,i[6]=0,i[7]=this._levels.length;for(let e=0;e<11;e++)i[8+e]=0;i[19]=32,i[20]=65,i[21]=0,i[22]=32,i[23]=16711680,i[24]=65280,i[25]=255,i[26]=4278190080,i[27]=a,i[28]=r,i[29]=0,i[30]=0,i[31]=0;let o=128;if(this.cubemap)for(let e=0;e<6;e++)for(let t=0;t<this._levels.length;t++){const i=this._levels[t][e],n=new Uint8Array(s,o,i.length);for(let e=0;e<i.length;e++)n[e]=i[e];o+=i.length}else for(let e=0;e<this._levels.length;e++){const t=this._levels[e],i=new Uint8Array(s,o,t.length);for(let e=0;e<t.length;e++)i[e]=t[e];o+=t.length}return s}}const _h=new ge,gh=new ge,yh=new ge,vh=new Ce;class xh{constructor(){this._aspectRatio=16/9,this._aspectRatioMode=0,this._calculateProjection=null,this._calculateTransform=null,this._clearColor=new pe(.75,.75,.75,1),this._clearColorBuffer=!0,this._clearDepth=1,this._clearDepthBuffer=!0,this._clearStencil=0,this._clearStencilBuffer=!0,this._cullingMask=4294967295,this._cullFaces=!0,this._farClip=1e3,this._flipFaces=!1,this._fov=45,this._frustumCulling=!0,this._horizontalFov=!1,this._layers=[0,1,2,4,3],this._layersSet=new Set(this._layers),this._nearClip=.1,this._node=null,this._orthoHeight=10,this._projection=0,this._rect=new xe(0,0,1,1),this._renderTarget=null,this._scissorRect=new xe(0,0,1,1),this._scissorRectClear=!1,this._projMat=new Ce,this._projMatDirty=!0,this._projMatSkybox=new Ce,this._viewMat=new Ce,this._viewMatDirty=!0,this._viewProjMat=new Ce,this._viewProjMatDirty=!0,this.frustum=new yi}get fullSizeClearRect(){const e=this._scissorRectClear?this.scissorRect:this._rect;return 0===e.x&&0===e.y&&1===e.z&&1===e.w}set aspectRatio(e){this._aspectRatio!==e&&(this._aspectRatio=e,this._projMatDirty=!0)}get aspectRatio(){return this._aspectRatio}set aspectRatioMode(e){this._aspectRatioMode!==e&&(this._aspectRatioMode=e,this._projMatDirty=!0)}get aspectRatioMode(){return this._aspectRatioMode}set calculateProjection(e){this._calculateProjection=e,this._projMatDirty=!0}get calculateProjection(){return this._calculateProjection}set calculateTransform(e){this._calculateTransform=e}get calculateTransform(){return this._calculateTransform}set clearColor(e){this._clearColor.copy(e)}get clearColor(){return this._clearColor}set clearColorBuffer(e){this._clearColorBuffer=e}get clearColorBuffer(){return this._clearColorBuffer}set clearDepth(e){this._clearDepth=e}get clearDepth(){return this._clearDepth}set clearDepthBuffer(e){this._clearDepthBuffer=e}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencil(e){this._clearStencil=e}get clearStencil(){return this._clearStencil}set clearStencilBuffer(e){this._clearStencilBuffer=e}get clearStencilBuffer(){return this._clearStencilBuffer}set cullingMask(e){this._cullingMask=e}get cullingMask(){return this._cullingMask}set cullFaces(e){this._cullFaces=e}get cullFaces(){return this._cullFaces}set farClip(e){this._farClip!==e&&(this._farClip=e,this._projMatDirty=!0)}get farClip(){return this._farClip}set flipFaces(e){this._flipFaces=e}get flipFaces(){return this._flipFaces}set fov(e){this._fov!==e&&(this._fov=e,this._projMatDirty=!0)}get fov(){return this._fov}set frustumCulling(e){this._frustumCulling=e}get frustumCulling(){return this._frustumCulling}set horizontalFov(e){this._horizontalFov!==e&&(this._horizontalFov=e,this._projMatDirty=!0)}get horizontalFov(){return this._horizontalFov}set layers(e){this._layers=e.slice(0),this._layersSet=new Set(this._layers)}get layers(){return this._layers}get layersSet(){return this._layersSet}set nearClip(e){this._nearClip!==e&&(this._nearClip=e,this._projMatDirty=!0)}get nearClip(){return this._nearClip}set node(e){this._node=e}get node(){return this._node}set orthoHeight(e){this._orthoHeight!==e&&(this._orthoHeight=e,this._projMatDirty=!0)}get orthoHeight(){return this._orthoHeight}set projection(e){this._projection!==e&&(this._projection=e,this._projMatDirty=!0)}get projection(){return this._projection}get projectionMatrix(){return this._evaluateProjectionMatrix(),this._projMat}set rect(e){this._rect.copy(e)}get rect(){return this._rect}set renderTarget(e){this._renderTarget=e}get renderTarget(){return this._renderTarget}set scissorRect(e){this._scissorRect.copy(e)}get scissorRect(){return this._scissorRect}get viewMatrix(){if(this._viewMatDirty){const e=this._node.getWorldTransform();this._viewMat.copy(e).invert(),this._viewMatDirty=!1}return this._viewMat}clone(){return(new xh).copy(this)}copy(e){return this.aspectRatio=e.aspectRatio,this.aspectRatioMode=e.aspectRatioMode,this.calculateProjection=e.calculateProjection,this.calculateTransform=e.calculateTransform,this.clearColor=e.clearColor,this.clearColorBuffer=e.clearColorBuffer,this.clearDepth=e.clearDepth,this.clearDepthBuffer=e.clearDepthBuffer,this.clearStencil=e.clearStencil,this.clearStencilBuffer=e.clearStencilBuffer,this.cullFaces=e.cullFaces,this.cullingMask=e.cullingMask,this.farClip=e.farClip,this.flipFaces=e.flipFaces,this.fov=e.fov,this.frustumCulling=e.frustumCulling,this.horizontalFov=e.horizontalFov,this.layers=e.layers,this.nearClip=e.nearClip,this.orthoHeight=e.orthoHeight,this.projection=e.projection,this.rect=e.rect,this.renderTarget=e.renderTarget,this.scissorRect=e.scissorRect,this}_updateViewProjMat(){(this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty)&&(this._viewProjMat.mul2(this.projectionMatrix,this.viewMatrix),this._viewProjMatDirty=!1)}worldToScreen(e,t,s,i=new ge){this._updateViewProjMat(),this._viewProjMat.transformPoint(e,i);const n=this._viewProjMat.data,a=e.x*n[3]+e.y*n[7]+e.z*n[11]+1*n[15];return i.x=.5*(i.x/a+1)*t,i.y=.5*(1-i.y/a)*s,i}screenToWorld(e,t,s,i,n,a=new ge){const r=this._farClip-this._nearClip;if(_h.set(e/i,(n-t)/n,s/r),_h.mulScalar(2),_h.sub(ge.ONE),0===this._projection){Ce._getPerspectiveHalfSize(gh,this._fov,this._aspectRatio,this._nearClip,this._horizontalFov),gh.x*=_h.x,gh.y*=_h.y;const e=this._node.getWorldTransform();gh.z=-this._nearClip,e.transformPoint(gh,yh);const t=this._node.getPosition();a.sub2(yh,t),a.normalize(),a.mulScalar(s),a.add(t)}else this._updateViewProjMat(),vh.copy(this._viewProjMat).invert(),vh.transformPoint(_h,a);return a}_evaluateProjectionMatrix(){if(this._projMatDirty){if(0===this._projection)this._projMat.setPerspective(this._fov,this._aspectRatio,this._nearClip,this._farClip,this._horizontalFov),this._projMatSkybox.copy(this._projMat);else{const e=this._orthoHeight,t=e*this._aspectRatio;this._projMat.setOrtho(-t,t,-e,e,this._nearClip,this._farClip),this._projMatSkybox.setPerspective(this._fov,this._aspectRatio,this._nearClip,this._farClip)}this._projMatDirty=!1}}getProjectionMatrixSkybox(){return this._evaluateProjectionMatrix(),this._projMatSkybox}getScreenSize(e){if(0===this._projection){const t=this._node.getPosition().distance(e.center);if(t<e.radius)return 1;const s=Math.asin(e.radius/t),i=Math.tan(s),n=Math.tan(this._fov/2*ne.DEG_TO_RAD);return Math.min(i/n,1)}return ne.clamp(e.radius/this._orthoHeight,0,1)}}const bh=new Ce,Sh=new ge,wh=new Ae,Th=new Ae,Mh=new ge,Ch=new ge,Ah=new Ce,Ph=new Ae,Eh=new ge,Rh=new Ce,Lh=new Ae,Ih=new Ae,Dh=new Ce,Oh=new ge,Fh=new ge;class kh extends C{constructor(e="Untitled"){super(),this.name=e,this.tags=new Z(this),this._labels={},this.localPosition=new ge,this.localRotation=new Ae,this.localScale=new ge(1,1,1),this.localEulerAngles=new ge,this.position=new ge,this.rotation=new Ae,this.eulerAngles=new ge,this._scale=null,this.localTransform=new Ce,this._dirtyLocal=!1,this._aabbVer=0,this._frozen=!1,this.worldTransform=new Ce,this._dirtyWorld=!1,this.normalMatrix=new ye,this._dirtyNormal=!0,this._right=null,this._up=null,this._forward=null,this._parent=null,this._children=[],this._graphDepth=0,this._enabled=!0,this._enabledInHierarchy=!1,this.scaleCompensation=!1}get right(){return this._right||(this._right=new ge),this.getWorldTransform().getX(this._right).normalize()}get up(){return this._up||(this._up=new ge),this.getWorldTransform().getY(this._up).normalize()}get forward(){return this._forward||(this._forward=new ge),this.getWorldTransform().getZ(this._forward).normalize().mulScalar(-1)}set enabled(e){var t;this._enabled!==e&&(this._enabled=e,(e&&null!=(t=this._parent)&&t.enabled||!e)&&this._notifyHierarchyStateChanged(this,e))}get enabled(){return this._enabled&&this._enabledInHierarchy}get parent(){return this._parent}get path(){let e=this._parent;if(!e)return"";let t=this.name;for(;e&&e._parent;)t=`${e.name}/${t}`,e=e._parent;return t}get root(){let e=this;for(;e._parent;)e=e._parent;return e}get children(){return this._children}get graphDepth(){return this._graphDepth}_notifyHierarchyStateChanged(e,t){e._onHierarchyStateChanged(t);const s=e._children;for(let e=0,i=s.length;e<i;e++)s[e]._enabled&&this._notifyHierarchyStateChanged(s[e],t)}_onHierarchyStateChanged(e){this._enabledInHierarchy=e,e&&!this._frozen&&this._unfreezeParentToRoot()}_cloneInternal(e){e.name=this.name;const t=this.tags._list;e.tags.clear();for(let s=0;s<t.length;s++)e.tags.add(t[s]);e._labels=Object.assign({},this._labels),e.localPosition.copy(this.localPosition),e.localRotation.copy(this.localRotation),e.localScale.copy(this.localScale),e.localEulerAngles.copy(this.localEulerAngles),e.position.copy(this.position),e.rotation.copy(this.rotation),e.eulerAngles.copy(this.eulerAngles),e.localTransform.copy(this.localTransform),e._dirtyLocal=this._dirtyLocal,e.worldTransform.copy(this.worldTransform),e._dirtyWorld=this._dirtyWorld,e._dirtyNormal=this._dirtyNormal,e._aabbVer=this._aabbVer+1,e._enabled=this._enabled,e.scaleCompensation=this.scaleCompensation,e._enabledInHierarchy=!1}clone(){const e=new this.constructor;return this._cloneInternal(e),e}copy(e){return e._cloneInternal(this),this}find(e,t){let s,i=[];const n=this._children.length;if(e instanceof Function){const t=e;s=t(this),s&&i.push(this);for(let e=0;e<n;e++){const s=this._children[e].find(t);s.length&&(i=i.concat(s))}}else{let s;this[e]&&(s=this[e]instanceof Function?this[e]():this[e],s===t&&i.push(this));for(let s=0;s<n;++s){const n=this._children[s].find(e,t);n.length&&(i=i.concat(n))}}return i}findOne(e,t){const s=this._children.length;let i=null;if(e instanceof Function){const t=e;if(i=t(this),i)return this;for(let e=0;e<s;e++)if(i=this._children[e].findOne(t),i)return i}else{let n;if(this[e]&&(n=this[e]instanceof Function?this[e]():this[e],n===t))return this;for(let n=0;n<s;n++)if(i=this._children[n].findOne(e,t),null!==i)return i}return null}findByTag(){const e=arguments,t=[],s=(i,n)=>{n&&i.tags.has(...e)&&t.push(i);for(let e=0;e<i._children.length;e++)s(i._children[e],!0)};return s(this,!1),t}findByName(e){if(this.name===e)return this;for(let t=0;t<this._children.length;t++){const s=this._children[t].findByName(e);if(null!==s)return s}return null}findByPath(e){const t=Array.isArray(e)?e:e.split("/");let s=this;for(let e=0,i=t.length;e<i;++e)if(s=s.children.find((s=>s.name===t[e])),!s)return null;return s}forEach(e,t){e.call(t,this);const s=this._children;for(let i=0;i<s.length;i++)s[i].forEach(e,t)}isDescendantOf(e){let t=this._parent;for(;t;){if(t===e)return!0;t=t._parent}return!1}isAncestorOf(e){return e.isDescendantOf(this)}getEulerAngles(){return this.getWorldTransform().getEulerAngles(this.eulerAngles),this.eulerAngles}getLocalEulerAngles(){return this.localRotation.getEulerAngles(this.localEulerAngles),this.localEulerAngles}getLocalPosition(){return this.localPosition}getLocalRotation(){return this.localRotation}getLocalScale(){return this.localScale}getLocalTransform(){return this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this.localTransform}getPosition(){return this.getWorldTransform().getTranslation(this.position),this.position}getRotation(){return this.rotation.setFromMat4(this.getWorldTransform()),this.rotation}getScale(){return this._scale||(this._scale=new ge),this.getWorldTransform().getScale(this._scale)}getWorldTransform(){return this._dirtyLocal||this._dirtyWorld?(this._parent&&this._parent.getWorldTransform(),this._sync(),this.worldTransform):this.worldTransform}reparent(e,t){const s=this._parent;s&&s.removeChild(this),e&&(t>=0?e.insertChild(this,t):e.addChild(this))}setLocalEulerAngles(e,t,s){this.localRotation.setFromEulerAngles(e,t,s),this._dirtyLocal||this._dirtifyLocal()}setLocalPosition(e,t,s){e instanceof ge?this.localPosition.copy(e):this.localPosition.set(e,t,s),this._dirtyLocal||this._dirtifyLocal()}setLocalRotation(e,t,s,i){e instanceof Ae?this.localRotation.copy(e):this.localRotation.set(e,t,s,i),this._dirtyLocal||this._dirtifyLocal()}setLocalScale(e,t,s){e instanceof ge?this.localScale.copy(e):this.localScale.set(e,t,s),this._dirtyLocal||this._dirtifyLocal()}_dirtifyLocal(){this._dirtyLocal||(this._dirtyLocal=!0,this._dirtyWorld||this._dirtifyWorld())}_unfreezeParentToRoot(){let e=this._parent;for(;e;)e._frozen=!1,e=e._parent}_dirtifyWorld(){this._dirtyWorld||this._unfreezeParentToRoot(),this._dirtifyWorldInternal()}_dirtifyWorldInternal(){if(!this._dirtyWorld){this._frozen=!1,this._dirtyWorld=!0;for(let e=0;e<this._children.length;e++)this._children[e]._dirtyWorld||this._children[e]._dirtifyWorldInternal()}this._dirtyNormal=!0,this._aabbVer++}setPosition(e,t,s){e instanceof ge?Eh.copy(e):Eh.set(e,t,s),null===this._parent?this.localPosition.copy(Eh):(Rh.copy(this._parent.getWorldTransform()).invert(),Rh.transformPoint(Eh,this.localPosition)),this._dirtyLocal||this._dirtifyLocal()}setRotation(e,t,s,i){if(e instanceof Ae?Lh.copy(e):Lh.set(e,t,s,i),null===this._parent)this.localRotation.copy(Lh);else{const e=this._parent.getRotation();Ih.copy(e).invert(),this.localRotation.copy(Ih).mul(Lh)}this._dirtyLocal||this._dirtifyLocal()}setEulerAngles(e,t,s){if(this.localRotation.setFromEulerAngles(e,t,s),null!==this._parent){const e=this._parent.getRotation();Ih.copy(e).invert(),this.localRotation.mul2(Ih,this.localRotation)}this._dirtyLocal||this._dirtifyLocal()}addChild(e){this._prepareInsertChild(e),this._children.push(e),this._onInsertChild(e)}addChildAndSaveTransform(e){const t=e.getPosition(),s=e.getRotation();this._prepareInsertChild(e),e.setPosition(Ah.copy(this.worldTransform).invert().transformPoint(t)),e.setRotation(Ph.copy(this.getRotation()).invert().mul(s)),this._children.push(e),this._onInsertChild(e)}insertChild(e,t){this._prepareInsertChild(e),this._children.splice(t,0,e),this._onInsertChild(e)}_prepareInsertChild(e){e._parent&&e._parent.removeChild(e)}_fireOnHierarchy(e,t,s){this.fire(e,s);for(let e=0;e<this._children.length;e++)this._children[e]._fireOnHierarchy(t,t,s)}_onInsertChild(e){e._parent=this;const t=e._enabled&&this.enabled;e._enabledInHierarchy!==t&&(e._enabledInHierarchy=t,e._notifyHierarchyStateChanged(e,t)),e._updateGraphDepth(),e._dirtifyWorld(),this._frozen&&e._unfreezeParentToRoot(),e._fireOnHierarchy("insert","inserthierarchy",this),this.fire&&this.fire("childinsert",e)}_updateGraphDepth(){this._graphDepth=this._parent?this._parent._graphDepth+1:0;for(let e=0,t=this._children.length;e<t;e++)this._children[e]._updateGraphDepth()}removeChild(e){const t=this._children.indexOf(e);-1!==t&&(this._children.splice(t,1),e._parent=null,e._fireOnHierarchy("remove","removehierarchy",this),this.fire("childremove",e))}_sync(){if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){let e;const t=this._parent;let s=this.localScale,i=t;if(i){for(;i&&i.scaleCompensation;)i=i._parent;i&&(i=i._parent,i&&(e=i.worldTransform.getScale(),Mh.mul2(e,this.localScale),s=Mh))}Th.setFromMat4(t.worldTransform),wh.mul2(Th,this.localRotation);let n=t.worldTransform;t.scaleCompensation&&(Ch.mul2(e,t.getLocalScale()),bh.setTRS(t.worldTransform.getTranslation(Sh),Th,Ch),n=bh),n.transformPoint(this.localPosition,Sh),this.worldTransform.setTRS(Sh,wh,s)}else this.worldTransform.mulAffine2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=!1}}syncHierarchy(){if(!this._enabled)return;if(this._frozen)return;this._frozen=!0,(this._dirtyLocal||this._dirtyWorld)&&this._sync();const e=this._children;for(let t=0,s=e.length;t<s;t++)e[t].syncHierarchy()}lookAt(e,t,s,i=0,n=1,a=0){if(e instanceof ge)Oh.copy(e),t instanceof ge?Fh.copy(t):Fh.copy(ge.UP);else{if(void 0===s)return;Oh.set(e,t,s),Fh.set(i,n,a)}Dh.setLookAt(this.getPosition(),Oh,Fh),Lh.setFromMat4(Dh),this.setRotation(Lh)}translate(e,t,s){e instanceof ge?Eh.copy(e):Eh.set(e,t,s),Eh.add(this.getPosition()),this.setPosition(Eh)}translateLocal(e,t,s){e instanceof ge?Eh.copy(e):Eh.set(e,t,s),this.localRotation.transformVector(Eh,Eh),this.localPosition.add(Eh),this._dirtyLocal||this._dirtifyLocal()}rotate(e,t,s){if(Lh.setFromEulerAngles(e,t,s),null===this._parent)this.localRotation.mul2(Lh,this.localRotation);else{const e=this.getRotation(),t=this._parent.getRotation();Ih.copy(t).invert(),Lh.mul2(Ih,Lh),this.localRotation.mul2(Lh,e)}this._dirtyLocal||this._dirtifyLocal()}rotateLocal(e,t,s){Lh.setFromEulerAngles(e,t,s),this.localRotation.mul(Lh),this._dirtyLocal||this._dirtifyLocal()}}const Bh=new Ce,zh=new Ce,Uh=new Ce;class Vh{static create(e,t,s){const i=new xh;switch(i.node=new kh(e),i.aspectRatio=1,i.aspectRatioMode=1,i._scissorRectClear=!0,t){case 1:i.node.setRotation(Vh.pointLightRotations[s]),i.fov=90,i.projection=0;break;case 2:i.projection=0;break;case 0:i.projection=1}return i}static evalSpotCookieMatrix(e){let t=Vh._spotCookieCamera;t||(t=Vh.create("SpotCookieCamera",2),Vh._spotCookieCamera=t),t.fov=2*e._outerConeAngle;const s=t._node;s.setPosition(e._node.getPosition()),s.setRotation(e._node.getRotation()),s.rotateLocal(-90,0,0),Bh.setTRS(s.getPosition(),s.getRotation(),ge.ONE).invert(),zh.mul2(t.projectionMatrix,Bh);const i=e.cookieMatrix,n=e.atlasViewport;return Uh.setViewport(n.x,n.y,n.z,n.w),i.mul2(Uh,zh),i}}Vh.pointLightRotations=[(new Ae).setFromEulerAngles(0,90,180),(new Ae).setFromEulerAngles(0,-90,180),(new Ae).setFromEulerAngles(90,0,0),(new Ae).setFromEulerAngles(-90,0,0),(new Ae).setFromEulerAngles(0,180,180),(new Ae).setFromEulerAngles(0,0,180)],Vh._spotCookieCamera=null;const Nh=new ge,Gh=new Float32Array(6),Wh=new ge(-.5,0,0),Hh=new ge(0,0,.5),Xh={FLAGS:0,COLOR_A:1,COLOR_B:2,SPOT_ANGLES:3,SHADOW_BIAS:4,COOKIE_A:5,COOKIE_B:6,COUNT_ALWAYS:7,POSITION_X:7,POSITION_Y:8,POSITION_Z:9,RANGE:10,SPOT_DIRECTION_X:11,SPOT_DIRECTION_Y:12,SPOT_DIRECTION_Z:13,PROJ_MAT_00:14,ATLAS_VIEWPORT_A:14,PROJ_MAT_01:15,ATLAS_VIEWPORT_B:15,PROJ_MAT_02:16,PROJ_MAT_03:17,PROJ_MAT_10:18,PROJ_MAT_11:19,PROJ_MAT_12:20,PROJ_MAT_13:21,PROJ_MAT_20:22,PROJ_MAT_21:23,PROJ_MAT_22:24,PROJ_MAT_23:25,PROJ_MAT_30:26,PROJ_MAT_31:27,PROJ_MAT_32:28,PROJ_MAT_33:29,AREA_DATA_WIDTH_X:30,AREA_DATA_WIDTH_Y:31,AREA_DATA_WIDTH_Z:32,AREA_DATA_HEIGHT_X:33,AREA_DATA_HEIGHT_Y:34,AREA_DATA_HEIGHT_Z:35,COUNT:36},qh={POSITION_RANGE:0,SPOT_DIRECTION:1,PROJ_MAT_0:2,ATLAS_VIEWPORT:2,PROJ_MAT_1:3,PROJ_MAT_2:4,PROJ_MAT_3:5,AREA_DATA_WIDTH:6,AREA_DATA_HEIGHT:7,COUNT:8};class jh{static initShaderDefines(){const e=jh.lightTextureFormat===jh.FORMAT_FLOAT?"FLOAT":"8BIT";jh.shaderDefines=`\n            \n#define CLUSTER_TEXTURE_${e}\n            ${jh.buildShaderDefines(Xh,"CLUSTER_TEXTURE_8_")}\n            ${jh.buildShaderDefines(qh,"CLUSTER_TEXTURE_F_")}\n        `}static buildShaderDefines(e,t){let s="";return Object.keys(e).forEach((i=>{s+=`\n#define ${t}${i} ${e[i]}.5`})),s}static init(e){jh.lightTextureFormat=e.extTextureFloat&&e.maxTextures>8?jh.FORMAT_FLOAT:jh.FORMAT_8BIT,jh.initShaderDefines()}static createTexture(e,t,s,i,n){return new fh(e,{name:n,width:t,height:s,mipmaps:!1,format:i,addressU:1,addressV:1,type:"default",magFilter:0,minFilter:0,anisotropy:1})}constructor(e){this.device=e,this.cookiesEnabled=!1,this.shadowsEnabled=!1,this.areaLightsEnabled=!1,this.maxLights=255;let t=Xh.COUNT_ALWAYS,s=0;jh.lightTextureFormat===jh.FORMAT_FLOAT?s=qh.COUNT:t=Xh.COUNT,this.lights8=new Uint8ClampedArray(4*t*this.maxLights),this.lightsTexture8=jh.createTexture(this.device,t,this.maxLights,7,"LightsTexture8"),this._lightsTexture8Id=this.device.scope.resolve("lightsTexture8"),s?(this.lightsFloat=new Float32Array(4*s*this.maxLights),this.lightsTextureFloat=jh.createTexture(this.device,s,this.maxLights,14,"LightsTextureFloat"),this._lightsTextureFloatId=this.device.scope.resolve("lightsTextureFloat")):(this.lightsFloat=null,this.lightsTextureFloat=null,this._lightsTextureFloatId=void 0),this._lightsTextureInvSizeId=this.device.scope.resolve("lightsTextureInvSize"),this._lightsTextureInvSizeData=new Float32Array(4),this._lightsTextureInvSizeData[0]=s?1/this.lightsTextureFloat.width:0,this._lightsTextureInvSizeData[1]=s?1/this.lightsTextureFloat.height:0,this._lightsTextureInvSizeData[2]=1/this.lightsTexture8.width,this._lightsTextureInvSizeData[3]=1/this.lightsTexture8.height,this.invMaxColorValue=0,this.invMaxAttenuation=0,this.boundsMin=new ge,this.boundsDelta=new ge}destroy(){this.lightsTexture8&&(this.lightsTexture8.destroy(),this.lightsTexture8=null),this.lightsTextureFloat&&(this.lightsTextureFloat.destroy(),this.lightsTextureFloat=null)}setCompressionRanges(e,t){this.invMaxColorValue=1/t,this.invMaxAttenuation=1/e}setBounds(e,t){this.boundsMin.copy(e),this.boundsDelta.copy(t)}uploadTextures(){this.lightsTextureFloat&&(this.lightsTextureFloat.lock().set(this.lightsFloat),this.lightsTextureFloat.unlock()),this.lightsTexture8.lock().set(this.lights8),this.lightsTexture8.unlock()}updateUniforms(){this._lightsTexture8Id.setValue(this.lightsTexture8),jh.lightTextureFormat===jh.FORMAT_FLOAT&&this._lightsTextureFloatId.setValue(this.lightsTextureFloat),this._lightsTextureInvSizeId.setValue(this._lightsTextureInvSizeData)}getSpotDirection(e,t){t._node.getWorldTransform().getY(e).mulScalar(-1),e.normalize()}getLightAreaSizes(e){const t=e._node.getWorldTransform();return t.transformVector(Wh,Nh),Gh[0]=Nh.x,Gh[1]=Nh.y,Gh[2]=Nh.z,t.transformVector(Hh,Nh),Gh[3]=Nh.x,Gh[4]=Nh.y,Gh[5]=Nh.z,Gh}addLightDataFlags(e,t,s,i,n,a){e[t+0]=i?255:0,e[t+1]=64*s._shape,e[t+2]=255*s._falloffMode,e[t+3]=n?255*a:0}addLightDataColor(e,t,s,i,n){const a=this.invMaxColorValue,r=i?s._linearFinalColor:s._finalColor;dh.float2Bytes(r[0]*a,e,t+0,2),dh.float2Bytes(r[1]*a,e,t+2,2),dh.float2Bytes(r[2]*a,e,t+4,2),e[t+6]=n?255:0;const o=!!(1&s.mask),h=!!(2&s.mask);e[t+7]=o&&h?127:h?255:0}addLightDataSpotAngles(e,t,s){dh.float2Bytes(.499999*s._innerConeAngleCos+.5,e,t+0,2),dh.float2Bytes(.499999*s._outerConeAngleCos+.5,e,t+2,2)}addLightDataShadowBias(e,t,s){const i=s.getRenderData(null,0),n=s._getUniformBiasValues(i);dh.float2BytesRange(n.bias,e,t,-1,20,2),dh.float2Bytes(n.normalBias,e,t+2,2)}addLightDataPositionRange(e,t,s,i){const n=Nh.sub2(i,this.boundsMin).div(this.boundsDelta);dh.float2Bytes(n.x,e,t+0,4),dh.float2Bytes(n.y,e,t+4,4),dh.float2Bytes(n.z,e,t+8,4),dh.float2Bytes(s.attenuationEnd*this.invMaxAttenuation,e,t+12,4)}addLightDataSpotDirection(e,t,s){this.getSpotDirection(Nh,s),dh.float2Bytes(.499999*Nh.x+.5,e,t+0,4),dh.float2Bytes(.499999*Nh.y+.5,e,t+4,4),dh.float2Bytes(.499999*Nh.z+.5,e,t+8,4)}addLightDataLightProjMatrix(e,t,s){const i=s.data;for(let s=0;s<12;s++)dh.float2BytesRange(i[s],e,t+4*s,-2,2,4);for(let s=12;s<16;s++)dh.float2MantissaExponent(i[s],e,t+4*s,4)}addLightDataCookies(e,t,s){const i="rgb"===s._cookieChannel;if(e[t+0]=Math.floor(255*s.cookieIntensity),e[t+1]=i?255:0,!i){const i=s._cookieChannel;e[t+4]="rrr"===i?255:0,e[t+5]="ggg"===i?255:0,e[t+6]="bbb"===i?255:0,e[t+7]="aaa"===i?255:0}}addLightAtlasViewport(e,t,s){dh.float2Bytes(s.x,e,t+0,2),dh.float2Bytes(s.y,e,t+2,2),dh.float2Bytes(s.z/3,e,t+4,2)}addLightAreaSizes(e,t,s){const i=this.getLightAreaSizes(s);for(let s=0;s<6;s++)dh.float2MantissaExponent(i[s],e,t+4*s,4)}addLightData(e,t,s){const i=2===e._type,n=e.atlasViewportAllocated,a=this.cookiesEnabled&&!!e._cookie&&n,r=this.areaLightsEnabled&&0!==e.shape,o=this.shadowsEnabled&&e.castShadows&&n,h=e._node.getPosition();let l=null,c=null;if(i)if(o){l=e.getRenderData(null,0).shadowMatrix}else a&&(l=Vh.evalSpotCookieMatrix(e));else(o||a)&&(c=e.atlasViewport);const d=this.lights8,u=t*this.lightsTexture8.width*4;if(this.addLightDataFlags(d,u+4*Xh.FLAGS,e,i,o,e.shadowIntensity),this.addLightDataColor(d,u+4*Xh.COLOR_A,e,s,a),i&&this.addLightDataSpotAngles(d,u+4*Xh.SPOT_ANGLES,e),e.castShadows&&this.addLightDataShadowBias(d,u+4*Xh.SHADOW_BIAS,e),a&&this.addLightDataCookies(d,u+4*Xh.COOKIE_A,e),jh.lightTextureFormat===jh.FORMAT_FLOAT){const s=this.lightsFloat,n=t*this.lightsTextureFloat.width*4;if(s[n+4*qh.POSITION_RANGE+0]=h.x,s[n+4*qh.POSITION_RANGE+1]=h.y,s[n+4*qh.POSITION_RANGE+2]=h.z,s[n+4*qh.POSITION_RANGE+3]=e.attenuationEnd,i&&(this.getSpotDirection(Nh,e),s[n+4*qh.SPOT_DIRECTION+0]=Nh.x,s[n+4*qh.SPOT_DIRECTION+1]=Nh.y,s[n+4*qh.SPOT_DIRECTION+2]=Nh.z),l){const e=l.data;for(let t=0;t<16;t++)s[n+4*qh.PROJ_MAT_0+t]=e[t]}if(c&&(s[n+4*qh.ATLAS_VIEWPORT+0]=c.x,s[n+4*qh.ATLAS_VIEWPORT+1]=c.y,s[n+4*qh.ATLAS_VIEWPORT+2]=c.z/3),r){const t=this.getLightAreaSizes(e);s[n+4*qh.AREA_DATA_WIDTH+0]=t[0],s[n+4*qh.AREA_DATA_WIDTH+1]=t[1],s[n+4*qh.AREA_DATA_WIDTH+2]=t[2],s[n+4*qh.AREA_DATA_HEIGHT+0]=t[3],s[n+4*qh.AREA_DATA_HEIGHT+1]=t[4],s[n+4*qh.AREA_DATA_HEIGHT+2]=t[5]}}else this.addLightDataPositionRange(d,u+4*Xh.POSITION_X,e,h),i&&this.addLightDataSpotDirection(d,u+4*Xh.SPOT_DIRECTION_X,e),l&&this.addLightDataLightProjMatrix(d,u+4*Xh.PROJ_MAT_00,l),c&&this.addLightAtlasViewport(d,u+4*Xh.ATLAS_VIEWPORT_A,c),r&&this.addLightAreaSizes(d,u+4*Xh.AREA_DATA_WIDTH_X,e)}}jh.FORMAT_FLOAT=0,jh.FORMAT_8BIT=1,jh.lightTextureFormat=jh.FORMAT_8BIT,jh.shaderDefines="";const Yh={vertex_normal:"NORMAL",vertex_tangent:"TANGENT",vertex_texCoord0:"TEXCOORD0",vertex_texCoord1:"TEXCOORD1",vertex_color:"COLOR",vertex_boneWeights:"BLENDWEIGHT",vertex_boneIndices:"BLENDINDICES"},$h={vVertexColor:"vec4",vPositionW:"vec3",vNormalV:"vec3",vNormalW:"vec3",vTangentW:"vec3",vBinormalW:"vec3",vObjectSpaceUpW:"vec3",vUv0:"vec2",vUv1:"vec2"};class Kh{constructor(e,t){if(this.device=e,this.options=t,this.attributes={vertex_position:"POSITION"},t.chunks){this.chunks={};const e=t.chunks;for(const t in Bo)if(e.hasOwnProperty(t)){const s=e[t];for(const e in Yh)Yh.hasOwnProperty(e)&&s.indexOf(e)>=0&&(this.attributes[e]=Yh[e]);this.chunks[t]=s}else this.chunks[t]=Bo[t]}else this.chunks=Bo;this.lighting=t.lights.length>0||!!t.dirLightMap||!!t.clusteredLightingEnabled,this.reflections=!!t.reflectionSource,t.useSpecular||(t.specularMap=t.glossMap=null),this.shadowPass=zo.isShadow(t.pass),this.needsNormal=this.lighting||this.reflections||t.useSpecular||t.ambientSH||t.heightMap||t.enableGGXSpecular||t.clusteredLightingEnabled&&!this.shadowPass||t.clearCoatNormalMap,this.needsSceneColor=t.useDynamicRefraction,this.needsScreenSize=t.useDynamicRefraction,this.needsTransforms=t.useDynamicRefraction,this.varyings="",this.vshader=null,this.frontendDecl=null,this.frontendCode=null,this.frontendFunc=null,this.lightingUv=null,this.defines=[],this.fshader=null}_vsAddBaseCode(e,t,s){return e+=t.baseVS,1!==s.nineSlicedMode&&2!==s.nineSlicedMode||(e+=t.baseNineSlicedVS),e}_vsAddTransformCode(e,t,s,i){return e+=this.chunks.transformVS}_setMapTransform(e,t,s,i){const n=s+100*i;if(!e[3][n]){const a=`texture_${t}MapTransform`;e[0]+=`uniform vec3 ${a}0;\n`,e[0]+=`uniform vec3 ${a}1;\n`,e[1]+=`varying vec2 vUV${i}_${s};\n`,e[2]+=`   vUV${i}_${s} = vec2(dot(vec3(uv${i}, 1), ${a}0), dot(vec3(uv${i}, 1), ${a}1));\n`,e[3][n]=!0}return e}_fsGetBaseCode(){const e=this.options,t=this.chunks;let s=this.chunks.basePS;return 1===e.nineSlicedMode?s+=t.baseNineSlicedPS:2===e.nineSlicedMode&&(s+=t.baseNineSlicedTiledPS),s}_fsGetStartCode(e,t,s,i){let n=s.startPS;return 1===i.nineSlicedMode?n+=s.startNineSlicedPS:2===i.nineSlicedMode&&(n+=s.startNineSlicedTiledPS),n}_directionalShadowMapProjection(e,t,s,i,n){let a="";return e.numCascades>1&&(a+=`getShadowCascadeMatrix(light${i}_shadowMatrixPalette, light${i}_shadowCascadeDistances, light${i}_shadowCascadeCount);\n`,t=`(cascadeShadowMat, ${s});\n`),a+=n+t,a+=`fadeShadow(light${i}_shadowCascadeDistances);\n`,a}_nonPointShadowMapProjection(e,t,s,i,n){const a=`(${s}, ${i});\n`;return!t._normalOffsetBias||t._isVsm?2===t._type?t._isPcf&&(e.webgl2||e.extStandardDerivatives)?"       getShadowCoordPerspZbuffer"+a:"       getShadowCoordPersp"+a:this._directionalShadowMapProjection(t,a,i,n,"getShadowCoordOrtho"):2===t._type?t._isPcf&&(e.webgl2||e.extStandardDerivatives)?"       getShadowCoordPerspZbufferNormalOffset"+a:"       getShadowCoordPerspNormalOffset"+a:this._directionalShadowMapProjection(t,a,i,n,"getShadowCoordOrthoNormalOffset")}_getLightSourceShapeString(e){switch(e){case 1:return"Rect";case 2:return"Disk";case 3:return"Sphere";default:return""}}generateVertexShader(e,t,s){const i=this.device,n=this.options,a=this.chunks;let r="",o="";r=this._vsAddBaseCode(r,a,n),o+="   vPositionW    = getWorldPosition();\n",2===this.options.pass&&(r+="varying float vDepth;\n",r+="#ifndef VIEWMATRIX\n",r+="#define VIEWMATRIX\n",r+="uniform mat4 matrix_view;\n",r+="#endif\n",r+="#ifndef CAMERAPLANES\n",r+="#define CAMERAPLANES\n",r+="uniform vec4 camera_params;\n\n",r+="#endif\n",o+="    vDepth = -(matrix_view * vec4(vPositionW,1.0)).z * camera_params.x;\n"),this.options.useInstancing&&(this.attributes.instance_line1="ATTR12",this.attributes.instance_line2="ATTR13",this.attributes.instance_line3="ATTR14",this.attributes.instance_line4="ATTR15",r+=a.instancingVS),this.needsNormal&&(this.attributes.vertex_normal="NORMAL",o+="   vNormalW = getNormal();\n","sphereMap"===n.reflectionSource&&i.fragmentUniformsCount<=16&&(r+=a.viewNormalVS,o+="   vNormalV    = getViewNormal();\n"),n.hasTangents&&(n.heightMap||n.normalMap||n.enableGGXSpecular)?(this.attributes.vertex_tangent="TANGENT",r+=a.tangentBinormalVS,o+="   vTangentW   = getTangent();\n",o+="   vBinormalW  = getBinormal();\n"):n.enableGGXSpecular&&(r+=a.tangentBinormalVS,o+="   vObjectSpaceUpW  = getObjectSpaceUp();\n"));for(let s=0;s<2;s++)e[s]&&(this.attributes["vertex_texCoord"+s]="TEXCOORD"+s,r+=a["uv"+s+"VS"],o+="   vec2 uv"+s+" = getUv"+s+"();\n"),t[s]&&(o+="   vUv"+s+" = uv"+s+";\n");const h=[r,this.varyings,o,[]];s.forEach((e=>{this._setMapTransform(h,e.name,e.id,e.uv)})),r=h[0],this.varyings=h[1],o=h[2],n.vertexColors&&(this.attributes.vertex_color="COLOR",o+="   vVertexColor = vertex_color;\n"),n.msdf&&n.msdfTextAttribute&&(this.attributes.vertex_outlineParameters="ATTR8",this.attributes.vertex_shadowParameters="ATTR9",o+="    unpackMsdfParams();\n",r+=a.msdfVS),(n.useMorphPosition||n.useMorphNormal)&&(n.useMorphTextureBased?(r+="#define MORPHING_TEXTURE_BASED\n",n.useMorphPosition&&(r+="#define MORPHING_TEXTURE_BASED_POSITION\n"),n.useMorphNormal&&(r+="#define MORPHING_TEXTURE_BASED_NORMAL\n"),this.attributes.morph_vertex_id="ATTR15",r+="attribute float morph_vertex_id;\n"):(r+="#define MORPHING\n",n.useMorphPosition?(this.attributes.morph_pos0="ATTR8",this.attributes.morph_pos1="ATTR9",this.attributes.morph_pos2="ATTR10",this.attributes.morph_pos3="ATTR11",r+="#define MORPHING_POS03\n",r+="attribute vec3 morph_pos0;\n",r+="attribute vec3 morph_pos1;\n",r+="attribute vec3 morph_pos2;\n",r+="attribute vec3 morph_pos3;\n"):n.useMorphNormal&&(this.attributes.morph_nrm0="ATTR8",this.attributes.morph_nrm1="ATTR9",this.attributes.morph_nrm2="ATTR10",this.attributes.morph_nrm3="ATTR11",r+="#define MORPHING_NRM03\n",r+="attribute vec3 morph_nrm0;\n",r+="attribute vec3 morph_nrm1;\n",r+="attribute vec3 morph_nrm2;\n",r+="attribute vec3 morph_nrm3;\n"),n.useMorphNormal?(this.attributes.morph_nrm4="ATTR12",this.attributes.morph_nrm5="ATTR13",this.attributes.morph_nrm6="ATTR14",this.attributes.morph_nrm7="ATTR15",r+="#define MORPHING_NRM47\n",r+="attribute vec3 morph_nrm4;\n",r+="attribute vec3 morph_nrm5;\n",r+="attribute vec3 morph_nrm6;\n",r+="attribute vec3 morph_nrm7;\n"):(this.attributes.morph_pos4="ATTR12",this.attributes.morph_pos5="ATTR13",this.attributes.morph_pos6="ATTR14",this.attributes.morph_pos7="ATTR15",r+="#define MORPHING_POS47\n",r+="attribute vec3 morph_pos4;\n",r+="attribute vec3 morph_pos5;\n",r+="attribute vec3 morph_pos6;\n",r+="attribute vec3 morph_pos7;\n"))),n.skin?(this.attributes.vertex_boneWeights="BLENDWEIGHT",this.attributes.vertex_boneIndices="BLENDINDICES",r+=Go(i,a),r+="#define SKIN\n"):n.useInstancing&&(r+="#define INSTANCING\n"),n.screenSpace&&(r+="#define SCREENSPACE\n"),n.pixelSnap&&(r+="#define PIXELSNAP\n"),r=this._vsAddTransformCode(r,i,a,n),this.needsNormal&&(r+=a.normalVS),r+="\n",r+=a.startVS,r+=o,r+=a.endVS,r+="}",Object.keys($h).forEach((e=>{r.indexOf(e)>=0&&(this.varyings+=`varying ${$h[e]} ${e};\n`)}));const l=qo(i,"LitShader",this.options.pass,a.extensionVS);this.vshader=l+this.varyings+r}_fsGetBeginCode(){const e=this.device,t=this.chunks,s=this.options.forceFragmentPrecision;let i=jo(e,"LitShader",this.options.pass,t.extensionPS,s);for(let e=0;e<this.defines.length;e++)i+=`#define ${this.defines[e]}\n`;return i}_fsGetPickPassCode(){let e=this._fsGetBeginCode();return e+="uniform vec4 uColor;\n",e+=this.varyings,e+=this.frontendDecl,e+=this.frontendCode,e+="void main(void)\n{\n",e+=this.frontendFunc,e+="    gl_FragColor = uColor;\n",e+="}\n",e}_fsGetDepthPassCode(){const e=this.chunks;let t=this._fsGetBeginCode();return t+="varying float vDepth;\n",t+=this.varyings,t+=e.packDepthPS,t+=this.frontendDecl,t+=this.frontendCode,t+="void main(void)\n{\n",t+=this.frontendFunc,t+="    gl_FragColor = packFloat(vDepth);\n",t+="}\n",t}_fsGetShadowPassCode(){const e=this.device,t=this.options,s=this.chunks,i=this.varyings,n=zo.toLightType(t.pass),a=zo.toShadowType(t.pass);let r=this._fsGetBeginCode();e.extStandardDerivatives&&!e.webgl2&&(r+="uniform vec2 polygonOffset;\n"),3===a?e.textureFloatHighPrecision?r+="#define VSM_EXPONENT 15.0\n\n":r+="#define VSM_EXPONENT 5.54\n\n":2===a&&(r+="#define VSM_EXPONENT 5.54\n\n"),0!==n&&(r+="uniform vec3 view_position;\n",r+="uniform float light_radius;\n"),r+=i,r+=this.frontendDecl,r+=this.frontendCode,0!==a||e.webgl2&&1!==n?1===a&&(r+="vec2 encodeFloatRG( float v ) {\n",r+="    vec2 enc = vec2(1.0, 255.0) * v;\n",r+="    enc = fract(enc);\n",r+="    enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n",r+="    return enc;\n",r+="}\n\n"):r+=s.packDepthPS,r+="void main(void)\n{\n",r+=this.frontendFunc;return r+=1===n||(1===a||2===a||3===a)&&0!==n?"    float depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);\n":"    float depth = gl_FragCoord.z;\n",!e.webgl2&&e.extStandardDerivatives&&(r+="    float minValue = 2.3374370500153186e-10; //(1.0 / 255.0) / (256.0 * 256.0 * 256.0);\n",r+="    depth += polygonOffset.x * max(abs(dFdx(depth)), abs(dFdy(depth))) + minValue * polygonOffset.y;\n"),0!==a||e.webgl2&&(1!==n||t.clusteredLightingEnabled)?0===a||4===a?(r+="    gl_FragColor = vec4(1.0);\n",t.clusteredLightingEnabled&&1===n&&e.webgl2&&(r+="    gl_FragDepth = depth;\n")):r+=1===a?"    gl_FragColor = vec4(encodeFloatRG(depth), encodeFloatRG(depth*depth));\n":s.storeEVSMPS:r+="    gl_FragColor = packFloat(depth);\n",r+="}\n",r}_fsGetLitPassCode(){const e=this.device,t=this.options,s=this.chunks;let i="";!1===t.opacityFadesSpecular&&(i+="uniform float material_alphaFade;\n"),t.useSpecular&&(this.defines.push("LIT_SPECULAR"),this.reflections&&this.defines.push("LIT_REFLECTIONS"),t.clearCoat&&this.defines.push("LIT_CLEARCOAT"),t.fresnelModel>0&&this.defines.push("LIT_SPECULAR_FRESNEL"),t.conserveEnergy&&this.defines.push("LIT_CONSERVE_ENERGY"),t.sheen&&this.defines.push("LIT_SHEEN"));const n=[];let a=0,r=!1,o=!1,h=!1,l=t.lights.some((function(e){return e._shape&&0!==e._shape}));t.clusteredLightingEnabled&&t.clusteredLightingAreaLightsEnabled&&(l=!0),7===e.areaLightLutFormat?(i+="#define AREA_R8_G8_B8_A8_LUTS\n",i+="#define AREA_LUTS_PRECISION lowp\n"):i+="#define AREA_LUTS_PRECISION highp\n",(l||t.clusteredLightingEnabled)&&(i+="#define AREA_LIGHTS\n",i+="uniform AREA_LUTS_PRECISION sampler2D areaLightsLutTex1;\n",i+="uniform AREA_LUTS_PRECISION sampler2D areaLightsLutTex2;\n");for(let s=0;s<t.lights.length;s++){const c=t.lights[s],d=c._type;if(t.clusteredLightingEnabled&&0!==d)continue;i+="uniform vec3 light"+s+"_color;\n",0===d?i+="uniform vec3 light"+s+"_direction;\n":(i+="uniform vec3 light"+s+"_position;\n",i+="uniform float light"+s+"_radius;\n",2===d&&(i+="uniform vec3 light"+s+"_direction;\n",i+="uniform float light"+s+"_innerConeAngle;\n",i+="uniform float light"+s+"_outerConeAngle;\n")),0!==(l&&c._shape?c._shape:0)&&(0===d&&(i+="uniform vec3 light"+s+"_position;\n"),i+="uniform vec3 light"+s+"_halfWidth;\n",i+="uniform vec3 light"+s+"_halfHeight;\n"),c.castShadows&&!t.noShadow&&(i+="uniform mat4 light"+s+"_shadowMatrix;\n",i+="uniform float light"+s+"_shadowIntensity;\n",0===d&&(i+="uniform mat4 light"+s+"_shadowMatrixPalette[4];\n",i+="uniform float light"+s+"_shadowCascadeDistances[4];\n",i+="uniform float light"+s+"_shadowCascadeCount;\n"),0!==d?i+="uniform vec4 light"+s+"_shadowParams;\n":(r=!0,i+="uniform vec3 light"+s+"_shadowParams;\n"),1===d?i+="uniform samplerCube light"+s+"_shadowMap;\n":c._isPcf&&e.webgl2?i+="uniform sampler2DShadow light"+s+"_shadowMap;\n":i+="uniform sampler2D light"+s+"_shadowMap;\n",a++,n[c._shadowType]=!0,c._isVsm&&(o=!0),c._isPcf&&(e.webgl2||e.extStandardDerivatives)&&2===d&&(h=!0)),c._cookie&&(c._cookie._cubemap?1===d&&(i+="uniform samplerCube light"+s+"_cookie;\n",i+="uniform float light"+s+"_cookieIntensity;\n",c.castShadows&&!t.noShadow||(i+="uniform mat4 light"+s+"_shadowMatrix;\n")):2===d&&(i+="uniform sampler2D light"+s+"_cookie;\n",i+="uniform float light"+s+"_cookieIntensity;\n",c.castShadows&&!t.noShadow||(i+="uniform mat4 light"+s+"_shadowMatrix;\n"),c._cookieTransform&&(i+="uniform vec4 light"+s+"_cookieMatrix;\n",i+="uniform vec2 light"+s+"_cookieOffset;\n")))}i+="\n";const c=this.needsNormal&&(t.normalMap||t.clearCoatNormalMap||t.enableGGXSpecular&&!t.heightMap);c&&(t.hasTangents?i+=t.fastTbn?s.TBNfastPS:s.TBNPS:e.extStandardDerivatives&&(t.normalMap||t.clearCoatNormalMap)?i+=s.TBNderivativePS.replace(/\$UV/g,this.lightingUv):i+=s.TBNObjectSpacePS),i+=s.sphericalPS,i+=s.decodePS,i+=Uo(t.gamma,s),i+=Vo(t.toneMap,s),i+=No(t.fog,s),i+=this.frontendCode,t.useCubeMapRotation&&(i+="#define CUBEMAP_ROTATION\n"),this.needsNormal&&(i+=s.cubeMapRotatePS,i+=t.cubeMapProjection>0?s.cubeMapProjectBoxPS:s.cubeMapProjectNonePS,i+=t.skyboxIntensity?s.envMultiplyPS:s.envConstPS),(this.lighting&&t.useSpecular||this.reflections)&&(t.useMetalness&&(i+=s.metalnessModulatePS),2===t.fresnelModel&&(i+=s.fresnelSchlickPS));const d=t.aoMap||t.aoVertexColor;if(d)switch(i+=s.aoDiffuseOccPS,t.occludeSpecular){case 1:i+=t.occludeSpecularFloat?s.aoSpecOccSimplePS:s.aoSpecOccConstSimplePS;break;case 2:i+=t.occludeSpecularFloat?s.aoSpecOccPS:s.aoSpecOccConstPS}if("envAtlasHQ"===t.reflectionSource)i+=t.fixSeams?s.fixCubemapSeamsStretchPS:s.fixCubemapSeamsNonePS,i+=s.envAtlasPS,i+=s.reflectionEnvHQPS.replace(/\$DECODE/g,hh.decodeFunc(t.reflectionEncoding));else if("envAtlas"===t.reflectionSource)i+=s.envAtlasPS,i+=s.reflectionEnvPS.replace(/\$DECODE/g,hh.decodeFunc(t.reflectionEncoding));else if("cubeMap"===t.reflectionSource)i+=t.fixSeams?s.fixCubemapSeamsStretchPS:s.fixCubemapSeamsNonePS,i+=s.reflectionCubePS.replace(/\$DECODE/g,hh.decodeFunc(t.reflectionEncoding));else if("sphereMap"===t.reflectionSource){i+=(e.fragmentUniformsCount>16?s.reflectionSpherePS:s.reflectionSphereLowPS).replace(/\$DECODE/g,hh.decodeFunc(t.reflectionEncoding))}this.reflections&&(t.clearCoat&&(i+=s.reflectionCCPS),t.refraction&&(t.useDynamicRefraction?i+=s.refractionDynamicPS:i+=s.refractionCubePS),t.sheen&&(i+=s.reflectionSheenPS)),t.sheen&&(i+=s.lightSheenPS),t.clusteredLightingEnabled&&(i+=s.clusteredLightUtilsPS,i+=s.clusteredLightCookiesPS,n[0]=!0,n[4]=!0,h=!0),(a>0||t.clusteredLightingEnabled)&&(r&&(i+=s.shadowCascadesPS),n[0]&&(i+=s.shadowStandardPS),n[4]&&e.webgl2&&(i+=s.shadowStandardGL2PS),o&&(i+=s.shadowVSM_commonPS,n[1]&&(i+=s.shadowVSM8PS),n[2]&&(i+=e.extTextureHalfFloatLinear?s.shadowEVSMPS.replace(/\$/g,"16"):s.shadowEVSMnPS.replace(/\$/g,"16")),n[3]&&(i+=e.extTextureFloatLinear?s.shadowEVSMPS.replace(/\$/g,"32"):s.shadowEVSMnPS.replace(/\$/g,"32"))),e.webgl2||e.extStandardDerivatives||(i+=s.biasConstPS),i+=s.shadowCoordPS+s.shadowCommonPS,h&&(i+=s.shadowCoordPerspZbufferPS)),t.enableGGXSpecular&&(i+="uniform float material_anisotropy;\n"),this.lighting&&(i+=s.lightDiffuseLambertPS,(l||t.clusteredLightingEnabled)&&(i+=s.ltc)),i+="\n";let u=!1;t.useSpecular&&(this.lighting&&(i+=0===t.shadingModel?s.lightSpecularPhongPS:t.enableGGXSpecular?s.lightSpecularAnisoGGXPS:s.lightSpecularBlinnPS),t.fresnelModel||this.reflections||t.diffuseMap||(i+="    uniform vec3 material_ambient;\n",i+="#define LIT_OLD_AMBIENT",u=!0)),i+=s.combinePS,(t.lightMap||t.lightVertexColor)&&(i+=t.useSpecular&&t.dirLightMap?s.lightmapDirAddPS:s.lightmapAddPS);const p=!t.lightMap&&!t.lightVertexColor||t.lightMapWithoutAmbient;p&&("ambientSH"===t.ambientSource?i+=s.ambientSHPS:"envAtlas"===t.ambientSource?("envAtlas"!==t.reflectionSource&&"envAtlasHQ"!==t.reflectionSource&&(i+=s.envAtlasPS),i+=s.ambientEnvPS.replace(/\$DECODE/g,hh.decodeFunc(t.ambientEncoding))):i+=s.ambientConstantPS),t.ambientTint&&!u&&(i+="uniform vec3 material_ambient;\n"),t.msdf&&(t.msdfTextAttribute||(i+="\n#define UNIFORM_TEXT_PARAMETERS"),i+=s.msdfPS),this.needsNormal&&(i+=s.viewDirPS,t.useSpecular&&(i+=t.enableGGXSpecular?s.reflDirAnisoPS:s.reflDirPS));let m,f=!1,_=!1,g=!1,y=!1,v=!1;if(t.clusteredLightingEnabled&&this.lighting&&(y=!0,f=!0,_=!0,v=!0,i+=s.floatUnpackingPS,t.lightMaskDynamic&&(i+="\n#define CLUSTER_MESH_DYNAMIC_LIGHTS"),t.clusteredLightingCookiesEnabled&&(i+="\n#define CLUSTER_COOKIES"),t.clusteredLightingShadowsEnabled&&!t.noShadow&&(i+="\n#define CLUSTER_SHADOWS",i+="\n#define CLUSTER_SHADOW_TYPE_"+Pt[t.clusteredLightingShadowType]),t.clusteredLightingAreaLightsEnabled&&(i+="\n#define CLUSTER_AREALIGHTS"),i+=jh.shaderDefines,i+=s.clusteredLightShadowsPS,i+=s.clusteredLightPS),t.twoSidedLighting&&(i+="uniform float twoSidedLightingNegScaleFactor;\n"),i+=this._fsGetStartCode(i,e,s,t),this.needsNormal&&(t.twoSidedLighting?i+="    dVertexNormalW = normalize(gl_FrontFacing ? vNormalW * twoSidedLightingNegScaleFactor : -vNormalW * twoSidedLightingNegScaleFactor);\n":i+="    dVertexNormalW = normalize(vNormalW);\n",(t.heightMap||t.normalMap)&&t.hasTangents&&(t.twoSidedLighting?(i+="    dTangentW = gl_FrontFacing ? vTangentW * twoSidedLightingNegScaleFactor : -vTangentW * twoSidedLightingNegScaleFactor;\n",i+="    dBinormalW = gl_FrontFacing ? vBinormalW * twoSidedLightingNegScaleFactor : -vBinormalW * twoSidedLightingNegScaleFactor;\n"):(i+="    dTangentW = vTangentW;\n",i+="    dBinormalW = vBinormalW;\n")),i+="    getViewDir();\n",c&&(i+="    getTBN();\n")),i+=this.frontendFunc,this.needsNormal&&(t.useSpecular&&(i+="    getReflDir();\n"),t.clearCoat&&(i+="    ccReflDirW = normalize(-reflect(dViewDirW, ccNormalW));\n")),(this.lighting&&t.useSpecular||this.reflections)&&t.useMetalness&&(i+="    getMetalnessModulate();\n"),p&&(i+="    addAmbient();\n",t.separateAmbient&&(i+="\n                    vec3 dAmbientLight = dDiffuseLight;\n                    dDiffuseLight = vec3(0);\n                ")),t.ambientTint&&!u&&(i+="    dDiffuseLight *= material_ambient;\n"),d&&!t.occludeDirect&&(i+="    occludeDiffuse();\n"),(t.lightMap||t.lightVertexColor)&&(i+="    addLightMap();\n"),this.lighting||this.reflections){this.reflections&&(t.clearCoat&&(i+="    addReflectionCC();\n",t.fresnelModel>0?i+="    ccReflection.rgb *= getFresnel(dot(dViewDirW, ccNormalW), vec3(ccSpecularity));\n":i+="    ccReflection.rgb *= ccSpecularity;\n"),t.useSpecularityFactor&&(i+="    ccReflection.rgb *= dSpecularityFactor;\n"),t.sheen&&(i+="    addReflectionSheen();\n",i+="    sReflection.rgb *= sSpecularity;\n"),i+="    addReflection();\n",t.fresnelModel>0?i+="    dReflection.rgb *= getFresnel(dot(dViewDirW, dNormalW), dSpecularity);\n":i+="    dReflection.rgb *= dSpecularity;\n",t.useSpecularityFactor&&(i+="    dReflection.rgb *= dSpecularityFactor;\n")),l&&(i+="    dSpecularLight *= dSpecularity;\n",t.useSpecular&&(i+="    calcLTCLightValues();\n"));for(let s=0;s<t.lights.length;s++){const n=t.lights[s],a=n._type;if(t.clusteredLightingEnabled&&0!==a)continue;m=!1;const r=l&&n._shape?n.shape:0,o=l&&n._shape?this._getLightSourceShapeString(r):"";if(0!==r&&(i+="    calc"+o+"LightValues(light"+s+"_position, light"+s+"_halfWidth, light"+s+"_halfHeight);\n"),0===a?(i+="    dLightDirNormW = light"+s+"_direction;\n",i+="    dAtten = 1.0;\n"):(n._cookie&&(2!==a||n._cookie._cubemap?1===a&&n._cookie._cubemap&&(v=!0,m=!0):(v=!0,m=!0)),i+="    getLightDirPoint(light"+s+"_position);\n",f=!0,m&&(i+=2===a?"    dAtten3 = getCookie2D"+(n._cookieFalloff?"":"Clip")+(n._cookieTransform?"Xform":"")+"(light"+s+"_cookie, light"+s+"_shadowMatrix, light"+s+"_cookieIntensity"+(n._cookieTransform?", light"+s+"_cookieMatrix, light"+s+"_cookieOffset":"")+")."+n._cookieChannel+";\n":"    dAtten3 = getCookieCube(light"+s+"_cookie, light"+s+"_shadowMatrix, light"+s+"_cookieIntensity)."+n._cookieChannel+";\n"),0===r?0===n._falloffMode?(i+="    dAtten = getFalloffLinear(light"+s+"_radius);\n",_=!0):(i+="    dAtten = getFalloffInvSquared(light"+s+"_radius);\n",g=!0):(i+="    dAtten = getFalloffWindow(light"+s+"_radius);\n",g=!0),i+="    if (dAtten > 0.00001) {\n",2===a&&(m&&!n._cookieFalloff||(i+="    dAtten *= getSpotEffect(light"+s+"_direction, light"+s+"_innerConeAngle, light"+s+"_outerConeAngle);\n",y=!0))),i+=0!==r?0===a?"    dAttenD = getLightDiffuse();\n":"    dAttenD = get"+o+"LightDiffuse() * 16.0;\n":"    dAtten *= getLightDiffuse();\n",n.castShadows&&!t.noShadow){let r,o=null;if(1===n._shadowType?(o="VSM8",r="0.0"):2===n._shadowType?(o="VSM16",r="5.54"):3===n._shadowType?(o="VSM32",r=e.textureFloatHighPrecision?"15.0":"5.54"):o=4===n._shadowType?"PCF5x5":"PCF3x3",null!==o)if(1===a){const e="(light"+s+"_shadowMap, light"+s+"_shadowParams);\n";n._normalOffsetBias&&(i+="    normalOffsetPointShadow(light"+s+"_shadowParams);\n"),i+=`    float shadow${s} = getShadowPoint${o}${e}`,i+=`    dAtten *= mix(1.0, shadow${s}, light${s}_shadowIntensity);\n`}else{const h=`light${s}_shadowMatrix`,l=`light${s}_shadowParams`;i+=this._nonPointShadowMapProjection(e,t.lights[s],h,l,s),2===a&&(o="Spot"+o),i+=`    float shadow${s} = getShadow${o}(light${s}_shadowMap, light${s}_shadowParams${n._isVsm?", "+r:""});\n`,i+=`    dAtten *= mix(1.0, shadow${s}, light${s}_shadowIntensity);\n`}}if(0!==r?t.conserveEnergy&&t.useSpecular?i+="    dDiffuseLight += mix((dAttenD * dAtten) * light"+s+"_color"+(m?" * dAtten3":"")+", vec3(0), dLTCSpecFres);\n":i+="    dDiffuseLight += (dAttenD * dAtten) * light"+s+"_color"+(m?" * dAtten3":"")+";\n":l&&t.conserveEnergy&&t.useSpecular?i+="    dDiffuseLight += mix(dAtten * light"+s+"_color"+(m?" * dAtten3":"")+", vec3(0), dSpecularity);\n":i+="    dDiffuseLight += dAtten * light"+s+"_color"+(m?" * dAtten3":"")+";\n",t.useSpecular&&(i+="    dHalfDirW = normalize(-dLightDirNormW + dViewDirW);\n"),0!==r)t.clearCoat&&(i+="    ccSpecularLight += ccLTCSpecFres * get"+o+"LightSpecularCC() * dAtten * light"+s+"_color"+(m?" * dAtten3":"")+";\n"),t.useSpecular&&(i+="    dSpecularLight += dLTCSpecFres * get"+o+"LightSpecular() * dAtten * light"+s+"_color"+(m?" * dAtten3":"")+";\n");else{var x=!1;0===a&&t.fresnelModel>0&&(x=!0),t.clearCoat&&(i+="    ccSpecularLight += getLightSpecularCC(dHalfDirW) * dAtten * light"+s+"_color",i+=m?" * dAtten3":"",i+=x?" * getFresnel(dot(dViewDirW, dHalfDirW), vec3(ccSpecularity))":" * vec3(ccSpecularity)",i+=";\n"),t.sheen&&(i+="    dSpecularLight += getLightSpecularSheen(dHalfDirW) * dAtten * light"+s+"_color * sSpecularity",i+=m?" * dAtten3":"",i+=";\n"),t.useSpecular&&(i+="    dSpecularLight += getLightSpecular(dHalfDirW) * dAtten * light"+s+"_color",i+=m?" * dAtten3":"",i+=x?" * getFresnel(dot(dViewDirW, dHalfDirW), dSpecularity)":" * dSpecularity",i+=";\n")}0!==a&&(i+="    }\n"),i+="\n"}t.clusteredLightingEnabled&&this.lighting&&(_=!0,g=!0,f=!0,i+="    addClusteredLights();\n"),l&&(t.clearCoat&&(i+="    ccSpecularity = 1.0;\n"),t.useSpecular&&(i+="    dSpecularity = vec3(1);\n")),this.reflections&&t.refraction&&(i+="    addRefraction();\n")}i+="\n",d&&(t.occludeDirect&&(i+="    occludeDiffuse();\n"),1!==t.occludeSpecular&&2!==t.occludeSpecular||(i+="    occludeSpecular();\n")),t.useSpecularityFactor&&(i+="    dSpecularLight *= dSpecularityFactor;\n"),!1===t.opacityFadesSpecular&&(2!==t.blendType&&4!==t.blendType||(i+="float specLum = dot((dSpecularLight + dReflection.rgb * dReflection.a), vec3( 0.2126, 0.7152, 0.0722 ));\n",i+="#ifdef LIT_CLEARCOAT\n specLum += dot(ccSpecularLight * ccSpecularity + ccReflection.rgb * ccReflection.a * ccSpecularity, vec3( 0.2126, 0.7152, 0.0722 ));\n#endif\n",i+="dAlpha = clamp(dAlpha + gammaCorrectInput(specLum), 0.0, 1.0);\n"),i+="dAlpha *= material_alphaFade;\n"),i+=s.endPS,2===t.blendType||6===t.blendType||t.alphaToCoverage?i+=s.outputAlphaPS:4===t.blendType?i+=s.outputAlphaPremulPS:i+=s.outputAlphaOpaquePS,t.msdf&&(i+="    gl_FragColor = applyMsdf(gl_FragColor);\n"),i+="\n",i+="}\n",f&&(i=s.lightDirPointPS+i),_&&(i=s.falloffLinearPS+i),g&&(i=s.falloffInvSquaredPS+i),y&&(i=s.spotPS+i),v&&(i=s.cookiePS+i);let b="";i.includes("dReflection")&&(b+="vec4 dReflection;\n"),i.includes("dTBN")&&(b+="mat3 dTBN;\n"),i.includes("dVertexNormalW")&&(b+="vec3 dVertexNormalW;\n"),i.includes("dTangentW")&&(b+="vec3 dTangentW;\n"),i.includes("dBinormalW")&&(b+="vec3 dBinormalW;\n"),i.includes("dViewDirW")&&(b+="vec3 dViewDirW;\n"),i.includes("dReflDirW")&&(b+="vec3 dReflDirW;\n"),i.includes("dHalfDirW")&&(b+="vec3 dHalfDirW;\n"),i.includes("dDiffuseLight")&&(b+="vec3 dDiffuseLight;\n"),i.includes("dSpecularLight")&&(b+="vec3 dSpecularLight;\n"),i.includes("dLightDirNormW")&&(b+="vec3 dLightDirNormW;\n"),i.includes("dLightDirW")&&(b+="vec3 dLightDirW;\n"),i.includes("dLightPosW")&&(b+="vec3 dLightPosW;\n"),i.includes("dShadowCoord")&&(b+="vec3 dShadowCoord;\n"),i.includes("dAtten")&&(b+="float dAtten;\n"),i.includes("dAttenD")&&(b+="float dAttenD;\n"),i.includes("dAtten3")&&(b+="vec3 dAtten3;\n"),i.includes("dMsdf")&&(b+="vec4 dMsdf;\n"),i.includes("ccReflection")&&(b+="vec4 ccReflection;\n"),i.includes("ccReflDirW")&&(b+="vec3 ccReflDirW;\n"),i.includes("ccSpecularLight")&&(b+="vec3 ccSpecularLight;\n"),i.includes("ccSpecularityNoFres")&&(b+="float ccSpecularityNoFres;\n"),i.includes("sSpecularLight")&&(b+="vec3 sSpecularLight;\n"),i.includes("sReflection")&&(b+="vec4 sReflection;\n");return this._fsGetBeginCode()+this.varyings+this._fsGetBaseCode()+(t.detailModes?s.detailModesPS:"")+b+this.frontendDecl+i}generateFragmentShader(e,t,s,i){const n=this.options;this.frontendDecl=e,this.frontendCode=t,this.frontendFunc=s,this.lightingUv=i,3===n.pass?this.fshader=this._fsGetPickPassCode():2===n.pass?this.fshader=this._fsGetDepthPassCode():this.shadowPass?this.fshader=this._fsGetShadowPassCode():n.customFragmentShader?this.fshader=this._fsGetBeginCode()+n.customFragmentShader:this.fshader=this._fsGetLitPassCode()}getDefinition(){const e={attributes:this.attributes,vshader:this.vshader,fshader:this.fshader};return zo.isForward(this.options.pass)&&(e.tag=1),e}}class Zh{constructor(){this.code=""}append(...e){e.forEach((e=>{e.endsWith("\n")?this.code+=e:this.code+=e+"\n"}))}prepend(...e){e.forEach((e=>{e.endsWith("\n")?this.code=e+this.code:this.code=e+"\n"+this.code}))}}const Qh=[],Jh={optionsContext:{},optionsContextMin:{},generateKey:function(e){const t=function(e){const t=[];for(const s in e)e.hasOwnProperty(s)&&"chunks"!==s&&"lights"!==s&&t.push(s);return t.sort()};let s;e===this.optionsContextMin?(this.propsMin||(this.propsMin=t(e)),s=this.propsMin):e===this.optionsContext?(this.props||(this.props=t(e)),s=this.props):s=t(e);let i="standard";for(let t=0;t<s.length;t++)e[s[t]]&&(i+=s[t]+e[s[t]]);if(e.chunks){const t=[];for(const s in e.chunks)e.chunks.hasOwnProperty(s)&&t.push(s+e.chunks[s]);t.sort(),i+=t}if(e.lights){const t=e.clusteredLightingEnabled;for(let s=0;s<e.lights.length;s++){const n=e.lights[s];t&&0!==n._type||(i+=n.key)}}return _o(i)},_getUvSourceExpression:function(e,t,s){const i=s[e],n=s[t],a=zo.isForward(s.pass);let r;return a&&1===s.nineSlicedMode||a&&2===s.nineSlicedMode?r="nineSlicedUv":(r=0===i?"vUv"+n:"vUV"+n+"_"+i,s.heightMap&&"heightMapTransform"!==e&&(r+=" + dUvOffset")),r},_addMapDef:function(e,t){return t?`#define ${e}\n`:`#undef ${e}\n`},_addMapDefs:function(e,t,s,i){return this._addMapDef("MAPFLOAT",e)+this._addMapDef("MAPCOLOR",t)+this._addMapDef("MAPVERTEX",s)+this._addMapDef("MAPTEXTURE",i)},_addMap:function(e,t,s,i,n=null){const a=e+"Map",r=a+"Uv",o=a+"Transform",h=a+"Channel",l=e+"VertexColorChannel",c=e+"VertexColor",d=e+"Mode",u=s[e+"Tint"],p=s[c],m=s[a],f=s[d];let _=i[t];if(m){const e=this._getUvSourceExpression(o,r,s);if(_=_.replace(/\$UV/g,e).replace(/\$CH/g,s[h]),n&&(_="aaa"===s[h]?_.replace(/\$DECODE/g,"passThrough"):_.replace(/\$DECODE/g,hh.decodeFunc(s.gamma||"srgb"!==n?n:"linear")),_.indexOf("$texture2DSAMPLE"))){const e={linear:"texture2D",srgb:"texture2DSRGB",rgbm:"texture2DRGBM",rgbe:"texture2DRGBE"};_=_.replace(/\$texture2DSAMPLE/g,e[n]||"texture2D")}}p&&(_=_.replace(/\$VC/g,s[l])),f&&(_=_.replace(/\$DETAILMODE/g,f));const g=!!(1&u),y=!!(2&u);return _=this._addMapDefs(g,y,p,m)+_,_.replace(/\$/g,"")},_correctChannel:function(e,t,s){if(s[e]>0){if(s[e]<t.length)return t.substring(0,s[e]);if(s[e]>t.length){let i=t;const n=i.charAt(i.length-1),a=s[e]-i.length;for(let e=0;e<a;e++)i+=n;return i}return t}},createShaderDefinition:function(e,t){const s=new Kh(e,t),i=[],n=[],a=[];for(const e in Qh){const s=e+"Map";if(t[e+"VertexColor"]){const s=e+"VertexColorChannel";t[s]=this._correctChannel(e,t[s],Qh)}if(t[s]){const r=s+"Channel",o=s+"Transform",h=s+"Uv";t[h]=Math.min(t[h],1),t[r]=this._correctChannel(e,t[r],Qh);const l=t[h];i[l]=!0,n[l]=n[l]||t[s]&&!t[o],t[o]&&a.push({name:e,id:t[o],uv:t[h]})}}t.forceUv1&&(i[1]=!0,n[1]=void 0===n[1]||n[1]),s.generateVertexShader(i,n,a),0===t.shadingModel?(t.fresnelModel=0,t.ambientSH=!1):t.fresnelModel=0===t.fresnelModel?2:t.fresnelModel;const r=new Zh,o=new Zh,h=new Zh;let l="";if(2===t.nineSlicedMode?r.append("const float textureBias = -1000.0;"):r.append("uniform float textureBias;"),zo.isForward(t.pass)){if(t.heightMap&&(r.append("vec2 dUvOffset;"),o.append(this._addMap("height","parallaxPS",t,s.chunks)),h.append("getParallax();")),3!==t.blendType||t.alphaTest||t.alphaToCoverage?(r.append("float dAlpha;"),o.append(this._addMap("opacity","opacityPS",t,s.chunks)),h.append("getOpacity();"),t.alphaTest&&(o.append(s.chunks.alphaTestPS),h.append("alphaTest(dAlpha);"))):r.append("float dAlpha = 1.0;"),s.needsNormal){if((t.normalMap||t.clearCoatNormalMap)&&(o.append(t.packedNormal?s.chunks.normalXYPS:s.chunks.normalXYZPS),!t.hasTangents)){const e=t.normalMap?"normalMap":"clearCoatNormalMap";l=this._getUvSourceExpression(`${e}Transform`,`${e}Uv`,t)}r.append("vec3 dNormalW;"),o.append(this._addMap("normalDetail","normalDetailMapPS",t,s.chunks)),o.append(this._addMap("normal","normalMapPS",t,s.chunks)),h.append("getNormal();")}if(s.needsSceneColor&&r.append("uniform sampler2D uSceneColorMap;"),s.needsScreenSize&&r.append("uniform vec4 uScreenSize;"),s.needsTransforms&&(r.append("uniform mat4 matrix_viewProjection;"),r.append("uniform mat4 matrix_model;")),r.append("vec3 dAlbedo;"),t.diffuseDetail&&o.append(this._addMap("diffuseDetail","diffuseDetailMapPS",t,s.chunks)),o.append(this._addMap("diffuse","diffusePS",t,s.chunks)),h.append("getAlbedo();"),t.refraction&&(r.append("float dTransmission;"),o.append(this._addMap("refraction","transmissionPS",t,s.chunks)),h.append("getRefraction();"),r.append("float dThickness;"),o.append(this._addMap("thickness","thicknessPS",t,s.chunks)),h.append("getThickness();")),s.lighting&&t.useSpecular||s.reflections?(r.append("vec3 dSpecularity;"),r.append("float dGlossiness;"),t.sheen&&(r.append("vec3 sSpecularity;"),o.append(this._addMap("sheen","sheenPS",t,s.chunks)),h.append("getSheen();"),r.append("float sGlossiness;"),o.append(this._addMap("sheenGlossiness","sheenGlossPS",t,s.chunks)),h.append("getSheenGlossiness();")),t.useMetalness&&(r.append("float dMetalness;"),o.append(this._addMap("metalness","metalnessPS",t,s.chunks)),h.append("getMetalness();")),t.useSpecularityFactor&&(r.append("float dSpecularityFactor;"),o.append(this._addMap("specularityFactor","specularityFactorPS",t,s.chunks)),h.append("getSpecularityFactor();")),t.useSpecularColor?o.append(this._addMap("specular","specularPS",t,s.chunks,t.specularEncoding)):o.append("void getSpecularity() { dSpecularity = vec3(1); }"),o.append(this._addMap("gloss","glossPS",t,s.chunks)),h.append("getGlossiness();"),h.append("getSpecularity();")):(r.append("vec3 dSpecularity = vec3(0.0);"),r.append("float dGlossiness = 0.0;")),(t.aoMap||t.aoVertexColor)&&(r.append("float dAo;"),o.append(this._addMap("ao","aoPS",t,s.chunks)),h.append("getAO();")),r.append("vec3 dEmission;"),o.append(this._addMap("emissive","emissivePS",t,s.chunks,t.emissiveEncoding)),h.append("getEmission();"),t.clearCoat>0&&(r.append("float ccSpecularity;"),r.append("float ccGlossiness;"),r.append("vec3 ccNormalW;"),o.append(this._addMap("clearCoat","clearCoatPS",t,s.chunks)),o.append(this._addMap("clearCoatGloss","clearCoatGlossPS",t,s.chunks)),o.append(this._addMap("clearCoatNormal","clearCoatNormalPS",t,s.chunks)),h.append("getClearCoat();"),h.append("getClearCoatGlossiness();"),h.append("getClearCoatNormal();")),t.lightMap||t.lightVertexColor){const e=t.dirLightMap&&t.useSpecular,i=e?"lightmapDirPS":"lightmapSinglePS";r.append("vec3 dLightmap;"),e&&r.append("vec3 dLightmapDir;"),o.append(this._addMap("light",i,t,s.chunks,t.lightMapEncoding)),h.append("getLightMap();")}-1===o.code.indexOf("texture2DSRGB")&&-1===o.code.indexOf("texture2DRGBM")&&-1===o.code.indexOf("texture2DRGBE")||o.prepend(s.chunks.textureSamplePS)}else t.alphaTest&&(r.append("float dAlpha;"),o.append(this._addMap("opacity","opacityPS",t,s.chunks)),o.append(s.chunks.alphaTestPS),h.append("getOpacity();"),h.append("alphaTest(dAlpha);"));return h.code=`\n${h.code.split("\n").map((e=>`    ${e}`)).join("\n")}\n\n`,s.generateFragmentShader(r.code,o.code,h.code,l),s.getDefinition()}},el=function(e,t,s){const i=2.399963229728653*t,n=Math.sqrt(t)/Math.sqrt(s);e.x=n*Math.cos(i),e.y=n*Math.sin(i)},tl=function(e,t,s,i=0,n=1){i=1-2*i,n=1-2*n;const a=ne.lerp(i,n,t/s),r=Math.sqrt(1-a*a),o=2.399963229728653*t;e.x=Math.cos(o)*r,e.y=a,e.z=Math.sin(o)*r},sl=function(e){let t=(e<<16|e>>>16)>>>0;return t=((1431655765&t)<<1|(2863311530&t)>>>1)>>>0,t=((858993459&t)<<2|(3435973836&t)>>>2)>>>0,t=((252645135&t)<<4|(4042322160&t)>>>4)>>>0,t=((16711935&t)<<8|(4278255360&t)>>>8)>>>0,2.3283064365386963e-10*t},il=e=>{switch(e){case"cube":return"Cubemap";case"octahedral":return"Octahedral";default:return"Equirect"}},nl=(e,t,s)=>{if(e<=0)t[s+0]=0,t[s+1]=0,t[s+2]=0,t[s+3]=0;else if(e>=1)t[s+0]=255,t[s+1]=0,t[s+2]=0,t[s+3]=0;else{let i=1*e%1,n=255*e%1,a=65025*e%1;const r=16581375*e%1;i-=n/255,n-=a/255,a-=r/255,t[s+0]=Math.min(255,Math.floor(256*i)),t[s+1]=Math.min(255,Math.floor(256*n)),t[s+2]=Math.min(255,Math.floor(256*a)),t[s+3]=Math.min(255,Math.floor(256*r))}},al=(e,t,s,i)=>{const n=2*s*Math.PI,a=Math.pow(1-t,1/(i+1)),r=Math.sqrt(1-a*a);e.set(Math.cos(n)*r,Math.sin(n)*r,a).normalize()},rl=(e,t,s)=>{const i=2*s*Math.PI,n=Math.sqrt(1-t),a=Math.sqrt(t);e.set(Math.cos(i)*a,Math.sin(i)*a,n).normalize()},ol=(e,t,s,i)=>{const n=2*s*Math.PI,a=Math.sqrt((1-t)/(1+(i*i-1)*t)),r=Math.sqrt(1-a*a);e.set(Math.cos(n)*r,Math.sin(n)*r,a).normalize()},hl=(e,t)=>{const s=e*t,i=t/(1-e*e+s*s);return i*i*(1/Math.PI)},ll={16:{2:26,8:20,32:17,128:16,512:16},32:{2:53,8:40,32:34,128:32,512:32},128:{2:214,8:163,32:139,128:130,512:128},1024:{2:1722,8:1310,32:1114,128:1041,512:1025}},cl=(e,t,s)=>{const i=s/e,n=1-Math.log2(t)/11,a=n*n,r=new ge,o=new ge,h=new ge(0,0,1),l=[],c=((e,t)=>{const s=ll[e];return s&&s[t]||e})(e,t);for(let e=0;e<c;++e){ol(r,e/c,sl(e),a);const t=r.z;if(o.set(r.x,r.y,r.z).mulScalar(2*t).sub(h),o.z>0){const e=hl(Math.min(1,t),a)/4+.001,s=.5*Math.log2(i/e);l.push(o.x,o.y,o.z,s)}}for(;l.length<4*e;)l.push(0,0,0,0);return l},dl=(e,t,s)=>{const i=(e=>{const t=e.length,s=Math.min(t,512),i=Math.ceil(t/s),n=new Uint8Array(s*i*4);let a=0;for(let s=0;s<t;++s)nl(.5*e[4*s+0]+.5,n,a+0),nl(.5*e[4*s+1]+.5,n,a+4),nl(.5*e[4*s+2]+.5,n,a+8),nl(e[4*s+3]/8,n,a+12),a+=16;return{width:s,height:i,data:n}})(s);return new fh(e,{name:t,width:i.width,height:i.height,mipmaps:!1,minFilter:0,magFilter:0,levels:[i.data]})};class ul{constructor(e=!0){this.map=new Map,this.destroyContent=e}destroy(){this.destroyContent&&this.map.forEach(((e,t)=>{e.destroy()}))}get(e,t){if(!this.map.has(e)){const s=t();return this.map.set(e,s),s}return this.map.get(e)}}const pl=new ul(!1),ml=new yo,fl=(e,t,s)=>ml.get(e,(()=>new ul)).get(t,(()=>dl(e,t,pl.get(t,s)))),_l=(e,t,s)=>fl(e,`lambert-samples-${t}-${s}`,(()=>((e,t)=>{const s=t/e,i=new ge,n=[];for(let t=0;t<e;++t){rl(i,t/e,sl(t));const a=i.z/Math.PI,r=.5*Math.log2(s/a);n.push(i.x,i.y,i.z,r)}return n})(t,s))),gl=(e,t,s)=>fl(e,`phong-samples-${t}-${s}`,(()=>((e,t)=>{const s=new ge,i=[];for(let n=0;n<e;++n)al(s,n/e,sl(n),t),i.push(s.x,s.y,s.z,0);return i})(t,s))),yl=(e,t,s,i)=>fl(e,`ggx-samples-${t}-${s}-${i}`,(()=>cl(t,s,i))),vl="\nattribute vec2 vertex_position;\n\nuniform vec4 uvMod;\n\nvarying vec2 vUv0;\n\nvoid main(void) {\n    gl_Position = vec4(vertex_position, 0.5, 1.0);\n    vUv0 = (vertex_position.xy * 0.5 + 0.5) * uvMod.xy + uvMod.zw;\n}\n";function xl(e,t,s={}){var i;e instanceof Kl&&(e=arguments[1],t=arguments[2],s={},void 0!==arguments[3]&&(s.specularPower=arguments[3]),void 0!==arguments[4]&&(s.numSamples=arguments[4]));const n={none:"reproject",lambert:"prefilterSamplesUnweighted",phong:"prefilterSamplesUnweighted",ggx:"prefilterSamples"},a=s.hasOwnProperty("specularPower")?s.specularPower:1,r=s.hasOwnProperty("face")?s.face:null,o=s.hasOwnProperty("distribution")?s.distribution:1===a?"none":"phong",h=n[o]||"reproject",l=hh.decodeFunc(e.encoding),c=hh.encodeFunc(t.encoding),d=`sample${il(e.projection)}`,u=`getDirection${il(t.projection)}`,p=s.hasOwnProperty("numSamples")?s.numSamples:1024,m=`${h}_${l}_${c}_${d}_${u}_${p}`,f=e.device;let _=f.programLib._cache[m];if(!_){const e=`#define PROCESS_FUNC ${h}\n#define DECODE_FUNC ${l}\n#define ENCODE_FUNC ${c}\n#define SOURCE_FUNC ${d}\n#define TARGET_FUNC ${u}\n#define NUM_SAMPLES ${p}\n#define NUM_SAMPLES_SQRT ${Math.round(Math.sqrt(p)).toFixed(1)}\n`+(f.extTextureLod?"#define SUPPORTS_TEXLOD\n":"");let t="";f.webgl2||(t="#extension GL_OES_standard_derivatives: enable\n",f.extTextureLod&&(t+="#extension GL_EXT_shader_texture_lod: enable\n\n")),_=eh(f,vl,`${e}\n${Bo.reprojectPS}`,m,!1,t)}const g=f.scope.resolve(e.cubemap?"sourceCube":"sourceTex");g.setValue(e);const y=f.scope.resolve("params"),v=f.scope.resolve("params2"),x=f.scope.resolve("uvMod");if(null!=(i=s)&&i.seamPixels){const e=s.seamPixels,i=(s.rect?s.rect.z:t.width)-2*e,n=(s.rect?s.rect.w:t.height)-2*e;x.setValue([(i+2*e)/i,(n+2*e)/n,-e/i,-e/n])}else x.setValue([1,1,0,0]);const b=[0,a,e.fixCubemapSeams?1/e.width:0,t.fixCubemapSeams?1/t.width:0],S=[t.width*t.height*(t.cubemap?6:1),e.width*e.height*(e.cubemap?6:1)];if(h.startsWith("prefilterSamples")){const t=e.width*e.height*(e.cubemap?6:1),s="ggx"===o?yl(f,p,a,t):"lambert"===o?_l(f,p,t):gl(f,p,a);f.scope.resolve("samplesTex").setValue(s),f.scope.resolve("samplesTexInverseSize").setValue([1/s.width,1/s.height])}for(let e=0;e<(t.cubemap?6:1);e++)if(null===r||e===r){var w;const i=new Jl({colorBuffer:t,face:e,depth:!1});b[0]=e,y.setValue(b),v.setValue(S),bo(f,i,_,null==(w=s)?void 0:w.rect),i.destroy()}}const bl=(e,t=0)=>1+Math.floor(Math.log2(Math.max(e,t)));class Sl{static generateSkyboxCubemap(e,t){const s=((e,t,s,i)=>new fh(e,{name:`lighting-${t}`,cubemap:!0,width:t,height:t,format:s,type:7===s?"rgbm":"default",addressU:1,addressV:1,fixCubemapSeams:!0,mipmaps:!!i}))(e.device,t||(e.cubemap?e.width:e.width/4),7,!1);return xl(e,s,{numSamples:1024}),s}static generateLightingSource(e,t){const s=e.device,i=(e=>(e=>e.extTextureHalfFloat&&e.textureHalfFloatRenderable)(e)?12:(e=>e.extTextureFloat&&e.textureFloatRenderable)(e)?14:7)(s),n=(null==t?void 0:t.target)||new fh(s,{name:"lighting-source",cubemap:!0,width:(null==t?void 0:t.size)||128,height:(null==t?void 0:t.size)||128,format:i,type:7===i?"rgbm":"default",addressU:1,addressV:1,fixCubemapSeams:!1,mipmaps:!0});return xl(e,n,{numSamples:e.mipmaps?1:1024}),n}static generateAtlas(e,t){const s=e.device,i=(null==t?void 0:t.target)||new fh(s,{name:"envAtlas",width:(null==t?void 0:t.size)||512,height:(null==t?void 0:t.size)||512,format:7,type:"rgbm",projection:"equirect",addressU:1,addressV:1,mipmaps:!1}),n=i.width/512,a=new xe(0,0,512*n,256*n),r=bl(256)-bl(4);for(let t=0;t<r;++t)xl(e,i,{numSamples:1,rect:a,seamPixels:n}),a.x+=a.w,a.y+=a.w,a.z=Math.max(1,Math.floor(.5*a.z)),a.w=Math.max(1,Math.floor(.5*a.w));a.set(0,256*n,256*n,128*n);for(let s=1;s<7;++s)xl(e,i,{numSamples:(null==t?void 0:t.numReflectionSamples)||1024,distribution:(null==t?void 0:t.distribution)||"ggx",specularPower:Math.max(1,2048>>2*s),rect:a,seamPixels:n}),a.y+=a.w,a.z=Math.max(1,Math.floor(.5*a.z)),a.w=Math.max(1,Math.floor(.5*a.w));return a.set(128*n,384*n,64*n,32*n),xl(e,i,{numSamples:(null==t?void 0:t.numAmbientSamples)||2048,distribution:"lambert",rect:a,seamPixels:n}),i}static generatePrefilteredAtlas(e,t){const s=e[0].device,i=(null==t?void 0:t.target)||new fh(s,{name:"envPrefilteredAtlas",width:(null==t?void 0:t.size)||512,height:(null==t?void 0:t.size)||512,format:7,type:"rgbm",projection:"equirect",addressU:1,addressV:1,mipmaps:!1}),n=i.width/512,a=new xe(0,0,512*n,256*n),r=bl(512);for(let t=0;t<r;++t)xl(e[0],i,{numSamples:1,rect:a,seamPixels:n}),a.x+=a.w,a.y+=a.w,a.z=Math.max(1,Math.floor(.5*a.z)),a.w=Math.max(1,Math.floor(.5*a.w));a.set(0,256*n,256*n,128*n);for(let t=1;t<e.length;++t)xl(e[t],i,{numSamples:1,rect:a,seamPixels:n}),a.y+=a.w,a.z=Math.max(1,Math.floor(.5*a.z)),a.w=Math.max(1,Math.floor(.5*a.w));return a.set(128*n,384*n,64*n,32*n),null!=t&&t.legacyAmbient?xl(e[5],i,{numSamples:1,rect:a,seamPixels:n}):xl(e[0],i,{numSamples:(null==t?void 0:t.numSamples)||2048,distribution:"lambert",rect:a,seamPixels:n}),i}}const wl=new yo;function Tl(e){return wl.get(e)}class Ml{constructor(e,t){this.uniformFormats=[],this.bindGroupFormats=[],this.uniformFormats[0]=e,this.bindGroupFormats[0]=t}hasUniform(e){for(let t=0;t<this.uniformFormats.length;t++){if(this.uniformFormats[t].get(e))return!0}return!1}hasTexture(e){for(let t=0;t<this.bindGroupFormats.length;t++){if(this.bindGroupFormats[t].getTexture(e))return!0}return!1}}let Cl=0;class Al{constructor(){this._shader=null,this.meshInstances=[],this.name="Untitled",this.id=Cl++,this.variants={},this.parameters={},this.alphaTest=0,this.alphaToCoverage=!1,this.blend=!1,this.blendSrc=1,this.blendDst=0,this.blendEquation=0,this.separateAlphaBlend=!1,this.blendSrcAlpha=1,this.blendDstAlpha=0,this.blendAlphaEquation=0,this.cull=1,this.depthTest=!0,this.depthFunc=3,this.depthWrite=!0,this.stencilFront=null,this.stencilBack=null,this.depthBias=0,this.slopeDepthBias=0,this.redWrite=!0,this.greenWrite=!0,this.blueWrite=!0,this.alphaWrite=!0,this._shaderVersion=0,this._scene=null,this._dirtyBlend=!1,this.dirty=!0}set shader(e){this._shader=e}get shader(){return this._shader}get transparent(){return this.blend}set blendType(e){let t=!0;switch(e){case 3:t=!1,this.blendSrc=1,this.blendDst=0,this.blendEquation=0;break;case 2:this.blendSrc=6,this.blendDst=8,this.blendEquation=0;break;case 4:this.blendSrc=1,this.blendDst=8,this.blendEquation=0;break;case 1:this.blendSrc=1,this.blendDst=1,this.blendEquation=0;break;case 6:this.blendSrc=6,this.blendDst=1,this.blendEquation=0;break;case 7:this.blendSrc=4,this.blendDst=2,this.blendEquation=0;break;case 8:this.blendSrc=5,this.blendDst=1,this.blendEquation=0;break;case 5:this.blendSrc=4,this.blendDst=0,this.blendEquation=0;break;case 9:this.blendSrc=1,this.blendDst=1,this.blendEquation=3;break;case 10:this.blendSrc=1,this.blendDst=1,this.blendEquation=4}this.blend!==t&&(this.blend=t,this._scene?this._scene.layers._dirtyBlend=!0:this._dirtyBlend=!0),this._updateMeshInstanceKeys()}get blendType(){return this.blend?6===this.blendSrc&&8===this.blendDst&&0===this.blendEquation?2:1===this.blendSrc&&1===this.blendDst&&0===this.blendEquation?1:6===this.blendSrc&&1===this.blendDst&&0===this.blendEquation?6:4===this.blendSrc&&2===this.blendDst&&0===this.blendEquation?7:5===this.blendSrc&&1===this.blendDst&&0===this.blendEquation?8:1===this.blendSrc&&1===this.blendDst&&3===this.blendEquation?9:1===this.blendSrc&&1===this.blendDst&&4===this.blendEquation?10:4===this.blendSrc&&0===this.blendDst&&0===this.blendEquation?5:1===this.blendSrc&&8===this.blendDst&&0===this.blendEquation?4:2:3}copy(e){return this.name=e.name,this._shader=e._shader,this.alphaTest=e.alphaTest,this.alphaToCoverage=e.alphaToCoverage,this.blend=e.blend,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.separateAlphaBlend=e.separateAlphaBlend,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendAlphaEquation=e.blendAlphaEquation,this.cull=e.cull,this.depthTest=e.depthTest,this.depthFunc=e.depthFunc,this.depthWrite=e.depthWrite,this.depthBias=e.depthBias,this.slopeDepthBias=e.slopeDepthBias,e.stencilFront&&(this.stencilFront=e.stencilFront.clone()),e.stencilBack&&(e.stencilFront===e.stencilBack?this.stencilBack=this.stencilFront:this.stencilBack=e.stencilBack.clone()),this.redWrite=e.redWrite,this.greenWrite=e.greenWrite,this.blueWrite=e.blueWrite,this.alphaWrite=e.alphaWrite,this}clone(){return(new this.constructor).copy(this)}_updateMeshInstanceKeys(){const e=this.meshInstances;for(let t=0;t<e.length;t++)e[t].updateKey()}updateUniforms(e,t){}getShaderVariant(e,t,s,i,n,a,r,o){const h=`shader-id-${this._shader.id}`,l=this._shader.definition,c={generateKey:function(e){return h},createShaderDefinition:function(e,t){return l}},d="shader",u=e.getProgramLibrary();u.register(d,c);const p=new Ml(r,o),m=u.getProgram(d,{},p);return u.unregister(d),m}update(){this.dirty=!0,this._shader&&(this._shader.failed=!1)}clearParameters(){this.parameters={}}getParameters(){return this.parameters}clearVariants(){this.variants={};const e=this.meshInstances,t=e.length;for(let s=0;s<t;s++)e[s].clearShaders()}getParameter(e){return this.parameters[e]}setParameter(e,t){if(void 0===t&&"object"==typeof e){const s=e;if(s.length){for(let e=0;e<s.length;e++)this.setParameter(s[e]);return}e=s.name,t=s.value}const s=this.parameters[e];s?s.data=t:this.parameters[e]={scopeId:null,data:t}}deleteParameter(e){this.parameters[e]&&delete this.parameters[e]}setParameters(e,t){const s=this.parameters;void 0===t&&(t=s);for(const i in t){const t=s[i];t&&(t.scopeId||(t.scopeId=e.scope.resolve(i)),t.scopeId.setValue(t.data))}}destroy(){this.variants={},this._shader=null;for(let e=0;e<this.meshInstances.length;e++){const t=this.meshInstances[e];if(t.clearShaders(),t._material=null,t.mesh){const e=Tl(t.mesh.device);this!==e&&(t.material=e)}}this.meshInstances.length=0}addMeshInstanceRef(e){this.meshInstances.push(e)}removeMeshInstanceRef(e){const t=this.meshInstances,s=t.indexOf(e);-1!==s&&t.splice(s,1)}}const Pl=(e,t)=>{if(e.length!==t.length)return!1;for(let s=0;s<e.length;++s)if(e[s]!==t[s])return!1;return!0},El=e=>1!==e.r||1!==e.g||1!==e.b;class Rl{constructor(){this._mapXForms=null}updateMinRef(e,t,s,i,n,a,r){this._updateSharedOptions(e,t,s,i,a),this._updateMinOptions(e,s),this._updateUVOptions(e,s,i,!0)}updateRef(e,t,s,i,n,a,r){this._updateSharedOptions(e,t,s,i,a),this._updateEnvOptions(e,s,t),this._updateMaterialOptions(e,s),1===a&&(e.gamma&&(e.gamma=3),e.toneMap=0),e.hasTangents=i&&0!=(512&i),this._updateLightOptions(e,s,i,r,n),this._updateUVOptions(e,s,i,!1)}_updateSharedOptions(e,t,s,i,n){e.pass=n,e.alphaTest=s.alphaTest>0,e.forceFragmentPrecision=s.forceFragmentPrecision||"",e.chunks=s.chunks||"",e.blendType=s.blendType,e.forceUv1=s.forceUv1,e.separateAmbient=!1,e.screenSpace=i&&0!=(256&i),e.skin=i&&0!=(2&i),e.useInstancing=i&&0!=(32&i),e.useMorphPosition=i&&0!=(1024&i),e.useMorphNormal=i&&0!=(2048&i),e.useMorphTextureBased=i&&0!=(4096&i),e.nineSlicedMode=s.nineSlicedMode||0,t.clusteredLightingEnabled&&s.useLighting?(e.clusteredLightingEnabled=!0,e.clusteredLightingCookiesEnabled=t.lighting.cookiesEnabled,e.clusteredLightingShadowsEnabled=t.lighting.shadowsEnabled,e.clusteredLightingShadowType=t.lighting.shadowType,e.clusteredLightingAreaLightsEnabled=t.lighting.areaLightsEnabled):(e.clusteredLightingEnabled=!1,e.clusteredLightingCookiesEnabled=!1,e.clusteredLightingShadowsEnabled=!1,e.clusteredLightingAreaLightsEnabled=!1)}_updateUVOptions(e,t,s,i){let n=!1,a=!1,r=!1;s&&(n=0!=(4&s),a=0!=(8&s),r=0!=(16&s)),e.vertexColors=!1,this._mapXForms=[];for(const s in Qh)this._updateTexOptions(e,t,s,n,a,r,i);this._mapXForms=null}_updateMinOptions(e,t){e.opacityTint=1!==t.opacity&&3!==t.blendType,e.lights=[]}_updateMaterialOptions(e,t){const s=(t.diffuseTint||!t.diffuseMap&&!t.diffuseVertexColor)&&El(t.diffuse),i=!!(t.useMetalness||t.specularMap||t.sphereMap||t.cubeMap||(n=t.specular,0!==n.r||0!==n.g||0!==n.b)||t.specularityFactor>0||t.enableGGXSpecular||t.clearCoat>0);var n;const a=!t.useMetalness||t.useMetalnessSpecularColor,r=i&&(t.specularTint||!t.specularMap&&!t.specularVertexColor)&&El(t.specular),o=i&&t.useMetalness&&(t.specularityFactorTint||t.specularityFactor<1&&!t.specularityFactorMap),h=!t.emissiveMap||El(t.emissive)&&t.emissiveTint,l=1!==t.emissiveIntensity,c=!!t.normalMap&&(10===t.normalMap.format||"swizzleGGGR"===t.normalMap.type);e.opacityTint=1!==t.opacity&&3!==t.blendType?1:0,e.blendMapsWithColors=!0,e.ambientTint=t.ambientTint,e.diffuseTint=s?2:0,e.specularTint=r?2:0,e.specularityFactorTint=o?1:0,e.useSpecularityFactor=o||!!t.specularityFactorMap,e.useSpecularColor=a,e.metalnessTint=t.useMetalness&&t.metalness<1?1:0,e.glossTint=1,e.emissiveTint=(h?2:0)+(l?1:0),e.alphaToCoverage=t.alphaToCoverage,e.normalizeNormalMap=t.normalizeNormalMap,e.ambientSH=!!t.ambientSH,e.useSpecular=i,e.emissiveEncoding=t.emissiveMap?t.emissiveMap.encoding:null,e.lightMapEncoding=t.lightMap?t.lightMap.encoding:null,e.conserveEnergy=t.conserveEnergy,e.opacityFadesSpecular=t.opacityFadesSpecular,e.alphaFade=t.alphaFade,e.occludeSpecular=t.occludeSpecular,e.occludeSpecularFloat=1!==t.occludeSpecularIntensity,e.occludeDirect=t.occludeDirect,e.shadingModel=t.shadingModel,e.fresnelModel=t.fresnelModel,e.packedNormal=c,e.fastTbn=t.fastTbn,e.cubeMapProjection=t.cubeMapProjection,e.customFragmentShader=t.customFragmentShader,e.refraction=!!t.refraction||!!t.refractionMap,e.useDynamicRefraction=t.useDynamicRefraction,e.refractionIndexTint=t.refractionIndex!==1/1.5?1:0,e.thicknessTint=t.useDynamicRefraction&&1!==t.thickness?1:0,e.useMetalness=t.useMetalness,e.specularEncoding=void 0===t.specularEncoding?"linear":t.specularEncoding,e.enableGGXSpecular=t.enableGGXSpecular,e.msdf=!!t.msdfMap,e.msdfTextAttribute=!!t.msdfTextAttribute,e.twoSidedLighting=t.twoSidedLighting,e.pixelSnap=t.pixelSnap,e.aoMapUv=t.aoUvSet,e.diffuseDetail=!!t.diffuseMap,e.normalDetail=!!t.normalMap,e.diffuseDetailMode=t.diffuseDetailMode,e.detailModes=!!e.diffuseDetail,e.clearCoat=!!t.clearCoat,e.clearCoatTint=1!==t.clearCoat?1:0,e.clearCoatGlossiness=!!t.clearCoatGlossiness,e.clearCoatGlossTint=1!==t.clearCoatGlossiness?1:0,e.sheen=t.useSheen,e.sheenTint=t.useSheen&&El(t.sheen)?2:0,e.sheenGlossinessTint=t.useSheen&&t.sheenGlossiness<1?1:0}_updateEnvOptions(e,t,s){e.fog=t.useFog?s.fog:"none",e.gamma=t.useGammaTonemap?s.gammaCorrection:0,e.toneMap=t.useGammaTonemap?s.toneMapping:-1,e.fixSeams=!!t.cubeMap&&t.cubeMap.fixCubemapSeams;const i=0===t.shadingModel;let n=!1;if(t.envAtlas&&t.cubeMap&&!i?(e.reflectionSource="envAtlasHQ",e.reflectionEncoding=t.envAtlas.encoding):t.envAtlas&&!i?(e.reflectionSource="envAtlas",e.reflectionEncoding=t.envAtlas.encoding):t.cubeMap?(e.reflectionSource="cubeMap",e.reflectionEncoding=t.cubeMap.encoding):t.sphereMap?(e.reflectionSource="sphereMap",e.reflectionEncoding=t.sphereMap.encoding):t.useSkybox&&s.envAtlas&&s.skybox&&!i?(e.reflectionSource="envAtlasHQ",e.reflectionEncoding=s.envAtlas.encoding,n=!0):t.useSkybox&&s.envAtlas&&!i?(e.reflectionSource="envAtlas",e.reflectionEncoding=s.envAtlas.encoding,n=!0):t.useSkybox&&s.skybox?(e.reflectionSource="cubeMap",e.reflectionEncoding=s.skybox.encoding,n=!0):(e.reflectionSource=null,e.reflectionEncoding=null),t.ambientSH&&!i)e.ambientSource="ambientSH",e.ambientEncoding=null;else{const n=t.envAtlas||(t.useSkybox&&s.envAtlas?s.envAtlas:null);n&&!i?(e.ambientSource="envAtlas",e.ambientEncoding=n.encoding):(e.ambientSource="constant",e.ambientEncoding=null)}e.skyboxIntensity=n&&1!==s.skyboxIntensity,e.useCubeMapRotation=n&&s.skyboxRotation&&!s.skyboxRotation.equals(Ae.IDENTITY)}_updateLightOptions(e,t,s,i,n){if(e.lightMap=!1,e.lightMapChannel="",e.lightMapUv=0,e.lightMapTransform=0,e.lightMapWithoutAmbient=!1,e.dirLightMap=!1,s&&(e.noShadow=0!=(1&s),0!=(64&s)&&(e.lightMapEncoding="rgbm",e.lightMap=!0,e.lightMapChannel="rgb",e.lightMapUv=1,e.lightMapTransform=0,e.lightMapWithoutAmbient=!t.lightMap,0!=(128&s)&&(e.dirLightMap=!0),0!=(8192&s)&&(e.lightMapWithoutAmbient=!1))),t.useLighting){const t=[],a=s?s>>16:1;e.lightMaskDynamic=!!(1&a),i&&(this._collectLights(0,i[0],t,a),this._collectLights(1,i[1],t,a,n),this._collectLights(2,i[2],t,a,n)),e.lights=t}else e.lights=[];0===e.lights.length&&(e.noShadow=!0)}_updateTexOptions(e,t,s,i,n,a,r){const o=s+"Map",h=s+"VertexColor",l=s+"VertexColorChannel",c=o+"Channel",d=o+"Transform",u=o+"Uv";"light"!==s&&(e[o]=!1,e[c]="",e[d]=0,e[u]=0),e[h]=!1,e[l]="";const p="opacity"===s;if((!p||3!==t.blendType||0!==t.alphaTest||t.alphaToCoverage)&&(!r||p)&&("height"!==s&&t[h]&&a&&(e[h]=t[h],e[l]=t[l],e.vertexColors=!0),t[o])){let s=!0;0!==t[u]||i||(s=!1),1!==t[u]||n||(s=!1),s&&(e[o]=!!t[o],e[d]=this._getMapTransformID(t.getUniform(d),t[u]),e[c]=t[c],e[u]=t[u])}}_collectLights(e,t,s,i,n){for(let n=0;n<t.length;n++){const a=t[n];if(a.enabled&&a.mask&i){if(0!==e&&a.isStatic)continue;s.push(a)}}if(n)for(let t=0;t<n.length;t++){const i=n[t];i._type===e&&s.push(i)}}_getMapTransformID(e,t){if(!e)return 0;let s=this._mapXForms[t];s||(s=[],this._mapXForms[t]=s);for(let t=0;t<s.length;t++)if(Pl(s[t][0].value,e[0].value)&&Pl(s[t][1].value,e[1].value))return t+1;return s.push(e)}}const Ll={name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb",ambientTint:"boolean",aoVertexColor:"boolean",aoVertexColorChannel:"string",aoMap:"texture",aoMapChannel:"string",aoMapUv:"number",aoMapTiling:"vec2",aoMapOffset:"vec2",aoMapRotation:"number",diffuse:"rgb",diffuseTint:"boolean",diffuseVertexColor:"boolean",diffuseVertexColorChannel:"string",diffuseMap:"texture",diffuseMapChannel:"string",diffuseMapUv:"number",diffuseMapTiling:"vec2",diffuseMapOffset:"vec2",diffuseMapRotation:"number",diffuseDetailMap:"texture",diffuseDetailMapChannel:"string",diffuseDetailMapUv:"number",diffuseDetailMapTiling:"vec2",diffuseDetailMapOffset:"vec2",diffuseDetailMapRotation:"number",diffuseDetailMode:"string",specular:"rgb",specularTint:"boolean",specularVertexColor:"boolean",specularVertexColorChannel:"string",specularMap:"texture",specularMapChannel:"string",specularMapUv:"number",specularMapTiling:"vec2",specularMapOffset:"vec2",specularMapRotation:"number",occludeSpecular:"enum:occludeSpecular",specularityFactor:"number",specularityFactorTint:"boolean",specularityFactorVertexColor:"boolean",specularityFactorVertexColorChannel:"string",specularityFactorMap:"texture",specularityFactorMapChannel:"string",specularityFactorMapUv:"number",specularityFactorMapTiling:"vec2",specularityFactorMapOffset:"vec2",specularityFactorMapRotation:"number",useMetalness:"boolean",metalness:"number",enableGGXSpecular:"boolean",anisotropy:"number",metalnessTint:"boolean",metalnessVertexColor:"boolean",metalnessVertexColorChannel:"string",metalnessMap:"texture",metalnessMapChannel:"string",metalnessMapUv:"number",metalnessMapTiling:"vec2",metalnessMapOffset:"vec2",metalnessMapRotation:"number",useMetalnessSpecularColor:"boolean",conserveEnergy:"boolean",shininess:"number",glossVertexColor:"boolean",glossVertexColorChannel:"string",glossMap:"texture",glossMapChannel:"string",glossMapUv:"number",glossMapTiling:"vec2",glossMapOffset:"vec2",glossMapRotation:"number",clearCoat:"number",clearCoatVertexColor:"boolean",clearCoatVertexColorChannel:"string",clearCoatMap:"texture",clearCoatMapChannel:"string",clearCoatMapUv:"number",clearCoatMapTiling:"vec2",clearCoatMapOffset:"vec2",clearCoatMapRotation:"number",clearCoatGlossiness:"number",clearCoatGlossVertexColor:"boolean",clearCoatGlossVertexColorChannel:"string",clearCoatGlossMap:"texture",clearCoatGlossMapChannel:"string",clearCoatGlossMapUv:"number",clearCoatGlossMapTiling:"vec2",clearCoatGlossMapOffset:"vec2",clearCoatGlossMapRotation:"number",clearCoatBumpiness:"number",clearCoatNormalMap:"texture",clearCoatNormalMapUv:"number",clearCoatNormalMapTiling:"vec2",clearCoatNormalMapOffset:"vec2",clearCoatNormalMapRotation:"number",useSheen:"boolean",sheen:"rgb",sheenMap:"texture",sheenMapChannel:"string",sheenMapUv:"number",sheenMapTiling:"vec2",sheenMapOffset:"vec2",sheenMapMapRotation:"number",sheenTint:"boolean",sheenVertexColor:"boolean",sheenVertexColorChannel:"string",fresnelModel:"number",emissive:"rgb",emissiveTint:"boolean",emissiveVertexColor:"boolean",emissiveVertexColorChannel:"string",emissiveMap:"texture",emissiveMapChannel:"string",emissiveMapUv:"number",emissiveMapTiling:"vec2",emissiveMapOffset:"vec2",emissiveMapMapRotation:"number",emissiveIntensity:"number",normalMap:"texture",normalMapTiling:"vec2",normalMapOffset:"vec2",normalMapRotation:"number",normalMapUv:"number",bumpiness:"number",normalDetailMap:"texture",normalDetailMapTiling:"vec2",normalDetailMapOffset:"vec2",normalDetailMapRotation:"number",normalDetailMapUv:"number",normalDetailMapBumpiness:"number",heightMap:"texture",heightMapChannel:"string",heightMapUv:"number",heightMapTiling:"vec2",heightMapOffset:"vec2",heightMapRotation:"number",heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",alphaFade:"number",opacity:"number",opacityVertexColor:"boolean",opacityVertexColorChannel:"string",opacityMap:"texture",opacityMapChannel:"string",opacityMapUv:"number",opacityMapTiling:"vec2",opacityMapOffset:"vec2",opacityMapRotation:"number",opacityFadesSpecular:"boolean",reflectivity:"number",refraction:"number",refractionIndex:"number",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",lightVertexColor:"boolean",lightVertexColorChannel:"string",lightMap:"texture",lightMapChannel:"string",lightMapUv:"number",lightMapTiling:"vec2",lightMapOffset:"vec2",lightMapRotation:"number",depthTest:"boolean",depthFunc:"enum:depthFunc",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",shadingModel:"enum:shadingModel",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useGammaTonemap:"boolean",envAtlas:"texture"},Il=[];for(const e in Ll){"texture"===Ll[e]&&Il.push(e)}const Dl=[];for(const e in Ll){"cubemap"===Ll[e]&&Dl.push(e)}const Ol={specularAntialias:"boolean"},Fl={},kl={};let Bl=new Set;class zl extends Al{constructor(){super(),this._dirtyShader=!0,this._assetReferences={},this._activeParams=new Set,this._activeLightingParams=new Set,this.shaderOptBuilder=new Rl,this.reset()}reset(){Object.keys(Fl).forEach((e=>{this[`_${e}`]=Fl[e].value()})),this._chunks={},this._uniformCache={}}set shader(e){}get shader(){return null}set chunks(e){this._dirtyShader=!0,this._chunks=e}get chunks(){return this._dirtyShader=!0,this._chunks}copy(e){super.copy(e),Object.keys(Fl).forEach((t=>{this[t]=e[t]}));for(const t in e._chunks)e._chunks.hasOwnProperty(t)&&(this._chunks[t]=e._chunks[t]);return this}_setParameter(e,t){Bl.add(e),this.setParameter(e,t)}_setParameters(e){e.forEach((e=>{this._setParameter(e.name,e.value)}))}_processParameters(e){const t=this[e];t.forEach((e=>{Bl.has(e)||delete this.parameters[e]})),this[e]=Bl,Bl=t,Bl.clear()}_updateMap(e){const t=e+"Map",s=this[t];if(s){this._setParameter("texture_"+t,s);const e=t+"Transform",i=this.getUniform(e);i&&this._setParameters(i)}}_allocUniform(e,t){let s=this._uniformCache[e];return s||(s=t(),this._uniformCache[e]=s),s}getUniform(e,t,s){return kl[e](this,t,s)}updateUniforms(e,t){const s=s=>this.getUniform(s,e,t);if(this._setParameter("material_ambient",s("ambient")),this.diffuseMap&&!this.diffuseTint||this._setParameter("material_diffuse",s("diffuse")),this.useMetalness)if((!this.metalnessMap||this.metalness<1)&&this._setParameter("material_metalness",this.metalness),this.specularMap&&!this.specularTint||this._setParameter("material_specular",s("specular")),this.specularityFactorMap&&!this.specularityFactorTint||this._setParameter("material_specularityFactor",this.specularityFactor),this.sheenMap&&!this.sheenTint||this._setParameter("material_sheen",s("sheen")),this.sheenGlossinessMap&&!this.sheenGlossinessTint||this._setParameter("material_sheenGlossiness",this.sheenGlossiness),this.refractionIndex>0){const e=1/this.refractionIndex,t=(e-1)/(e+1);this._setParameter("material_f0",t*t)}else this._setParameter("material_f0",1);else this.specularMap&&!this.specularTint||this._setParameter("material_specular",s("specular"));this.enableGGXSpecular&&this._setParameter("material_anisotropy",this.anisotropy),this.clearCoat>0&&(this._setParameter("material_clearCoat",this.clearCoat),this._setParameter("material_clearCoatGlossiness",this.clearCoatGlossiness),this._setParameter("material_clearCoatReflectivity",this.clearCoat),this._setParameter("material_clearCoatBumpiness",this.clearCoatBumpiness)),this._setParameter("material_shininess",s("shininess")),this.emissiveMap&&!this.emissiveTint||this._setParameter("material_emissive",s("emissive")),1!==this.emissiveIntensity&&this._setParameter("material_emissiveIntensity",this.emissiveIntensity),this.refraction>0&&(this._setParameter("material_refraction",this.refraction),this._setParameter("material_refractionIndex",this.refractionIndex)),this.useDynamicRefraction&&(this._setParameter("material_thickness",this.thickness),this._setParameter("material_attenuation",s("attenuation")),this._setParameter("material_invAttenuationDistance",0===this.attenuationDistance?0:1/this.attenuationDistance)),this._setParameter("material_opacity",this.opacity),!1===this.opacityFadesSpecular&&this._setParameter("material_alphaFade",this.alphaFade),this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity),1===this.cubeMapProjection&&this._setParameter(s("cubeMapProjectionBox"));for(const e in Qh)this._updateMap(e);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH),this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness),this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness),this.heightMap&&this._setParameter("material_heightMapFactor",s("heightMapFactor"));const i=0===this.shadingModel;this.envAtlas&&this.cubeMap&&!i?(this._setParameter("texture_envAtlas",this.envAtlas),this._setParameter("texture_cubeMap",this.cubeMap)):this.envAtlas&&!i?this._setParameter("texture_envAtlas",this.envAtlas):this.cubeMap?this._setParameter("texture_cubeMap",this.cubeMap):this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap),this._setParameter("material_reflectivity",this.reflectivity),this._processParameters("_activeParams"),this._dirtyShader&&this.clearVariants()}updateEnvUniforms(e,t){const s=0===this.shadingModel;!(this.envAtlas&&!s||this.cubeMap||this.sphereMap)&&this.useSkybox&&(t.envAtlas&&t.skybox&&!s?(this._setParameter("texture_envAtlas",t.envAtlas),this._setParameter("texture_cubeMap",t.skybox)):t.envAtlas&&!s?this._setParameter("texture_envAtlas",t.envAtlas):t.skybox&&this._setParameter("texture_cubeMap",t.skybox),!t.skyboxRotation.equals(Ae.IDENTITY)&&t._skyboxRotationMat3&&this._setParameter("cubeMapRotationMatrix",t._skyboxRotationMat3.data)),this._processParameters("_activeLightingParams")}getShaderVariant(e,t,s,i,n,a,r,o){this.updateEnvUniforms(e,t);const h=2===n||3===n||zo.isShadow(n);let l=h?Jh.optionsContextMin:Jh.optionsContext;h?this.shaderOptBuilder.updateMinRef(l,t,this,s,i,n,a):this.shaderOptBuilder.updateRef(l,t,this,s,i,n,a),this.onUpdateShader&&(l=this.onUpdateShader(l));const c=new Ml(r,o),d=e.getProgramLibrary();d.register("standard",Jh);const u=d.getProgram("standard",l,c);return this._dirtyShader=!1,u}destroy(){for(const e in this._assetReferences)this._assetReferences[e]._unbind();this._assetReferences=null,super.destroy()}}zl.TEXTURE_PARAMETERS=Il,zl.CUBEMAP_PARAMETERS=Dl;const Ul=(e,t)=>{kl[e]=t},Vl=(e,t,s,i)=>{Object.defineProperty(zl.prototype,e,{get:i||function(){return this[`_${e}`]},set:s}),Fl[e]={value:t}},Nl=e=>{const t=`_${e.name}`,s=e.dirtyShaderFunc||(()=>!0);Vl(e.name,(()=>e.defaultValue),(function(e){const i=this[t];i!==e&&(this._dirtyShader=this._dirtyShader||s(i,e),this[t]=e)}),e.getterFunc)},Gl=e=>{const t=`_${e.name}`,s=e.dirtyShaderFunc||(()=>!0);Vl(e.name,(()=>e.defaultValue.clone()),(function(e){const i=this[t];i.equals(e)||(this._dirtyShader=this._dirtyShader||s(i,e),this[t]=i.copy(e))}),e.getterFunc)},Wl=e=>e.defaultValue&&e.defaultValue.clone?Gl(e):Nl(e);function Hl(e,t,s,i,n,a){Qh[e]=s,Wl({name:`${e}Map`,defaultValue:null,dirtyShaderFunc:(e,t)=>!!e!=!!t||e&&(e.type!==t.type||e.fixCubemapSeams!==t.fixCubemapSeams||e.format!==t.format)}),Wl({name:`${e}MapTiling`,defaultValue:new ve(1,1)}),Wl({name:`${e}MapOffset`,defaultValue:new ve(0,0)}),Wl({name:`${e}MapRotation`,defaultValue:0}),Wl({name:`${e}MapUv`,defaultValue:t}),s>0&&Wl({name:`${e}MapChannel`,defaultValue:i||(s>1?"rgb":"g")}),n&&(Wl({name:`${e}VertexColor`,defaultValue:!1}),s>0&&Wl({name:`${e}VertexColorChannel`,defaultValue:i||(s>1?"rgb":"g")})),a&&Wl({name:`${e}Mode`,defaultValue:"mul"});const r=`${e}MapTiling`,o=`${e}MapOffset`,h=`${e}MapRotation`,l=`${e}MapTransform`;Ul(l,((e,t,s)=>{const i=e[r],n=e[o],a=e[h];if(1===i.x&&1===i.y&&0===n.x&&0===n.y&&0===a)return null;const c=e._allocUniform(l,(()=>[{name:`texture_${l}0`,value:new Float32Array(3)},{name:`texture_${l}1`,value:new Float32Array(3)}])),d=Math.cos(a*ne.DEG_TO_RAD),u=Math.sin(a*ne.DEG_TO_RAD),p=c[0].value;p[0]=d*i.x,p[1]=-u*i.y,p[2]=n.x;const m=c[1].value;return m[0]=u*i.x,m[1]=d*i.y,m[2]=1-i.y-n.y,c}))}function Xl(e,t){Wl({name:e,defaultValue:t,getterFunc:function(){return this._dirtyShader=!0,this[`_${e}`]}}),Ul(e,((t,s,i)=>{const n=t._allocUniform(e,(()=>new Float32Array(3))),a=t[e];return t.useGammaTonemap&&i.gammaCorrection?(n[0]=Math.pow(a.r,2.2),n[1]=Math.pow(a.g,2.2),n[2]=Math.pow(a.b,2.2)):(n[0]=a.r,n[1]=a.g,n[2]=a.b),n}))}function ql(e,t,s){Wl({name:e,defaultValue:t,dirtyShaderFunc:(e,t)=>(0===e||1===e)!=(0===t||1===t)}),Ul(e,s)}function jl(e,t){Wl({name:e,defaultValue:null,dirtyShaderFunc:(e,t)=>!!e==!!t}),Ul(e,t)}function Yl(e,t){Wl({name:e,defaultValue:t})}!function(){Xl("ambient",new pe(.7,.7,.7)),Xl("diffuse",new pe(1,1,1)),Xl("specular",new pe(0,0,0)),Xl("emissive",new pe(0,0,0)),Xl("sheen",new pe(1,1,1)),Xl("attenuation",new pe(1,1,1)),ql("emissiveIntensity",1),ql("specularityFactor",1),ql("sheenGlossiness",0),ql("shininess",25,((e,t,s)=>0===e.shadingModel?Math.pow(2,.01*e.shininess*11):.01*e.shininess)),ql("heightMapFactor",1,((e,t,s)=>.025*e.heightMapFactor)),ql("opacity",1),ql("alphaFade",1),ql("alphaTest",0),ql("bumpiness",1),ql("normalDetailMapBumpiness",1),ql("reflectivity",1),ql("occludeSpecularIntensity",1),ql("refraction",0),ql("refractionIndex",1/1.5),ql("thickness",0),ql("attenuationDistance",0),ql("metalness",1),ql("anisotropy",0),ql("clearCoat",0),ql("clearCoatGlossiness",1),ql("clearCoatBumpiness",1),ql("aoUvSet",0,null),jl("ambientSH"),jl("cubeMapProjectionBox",((e,t,s)=>{const i=e._allocUniform("cubeMapProjectionBox",(()=>[{name:"envBoxMin",value:new Float32Array(3)},{name:"envBoxMax",value:new Float32Array(3)}])),n=e.cubeMapProjectionBox.getMin(),a=i[0].value;a[0]=n.x,a[1]=n.y,a[2]=n.z;const r=e.cubeMapProjectionBox.getMax(),o=i[1].value;return o[0]=r.x,o[1]=r.y,o[2]=r.z,i})),Yl("ambientTint",!1),Yl("diffuseTint",!1),Yl("specularTint",!1),Yl("specularityFactorTint",!1),Yl("emissiveTint",!1),Yl("fastTbn",!1),Yl("useMetalness",!1),Yl("useMetalnessSpecularColor",!1),Yl("useSheen",!1),Yl("enableGGXSpecular",!1),Yl("occludeDirect",!1),Yl("normalizeNormalMap",!0),Yl("conserveEnergy",!0),Yl("opacityFadesSpecular",!0),Yl("occludeSpecular",1),Yl("shadingModel",1),Yl("fresnelModel",2),Yl("useDynamicRefraction",!1),Yl("cubeMapProjection",0),Yl("customFragmentShader",null),Yl("forceFragmentPrecision",null),Yl("useFog",!0),Yl("useLighting",!0),Yl("useGammaTonemap",!0),Yl("useSkybox",!0),Yl("forceUv1",!1),Yl("pixelSnap",!1),Yl("twoSidedLighting",!1),Yl("nineSlicedMode",void 0),Yl("msdfTextAttribute",!1),Hl("diffuse",0,3,"",!0),Hl("specular",0,3,"",!0),Hl("emissive",0,3,"",!0),Hl("thickness",0,1,"",!0),Hl("specularityFactor",0,1,"",!0),Hl("normal",0,-1,"",!1),Hl("metalness",0,1,"",!0),Hl("gloss",0,1,"",!0),Hl("opacity",0,1,"a",!0),Hl("refraction",0,1,"",!0),Hl("height",0,1,"",!1),Hl("ao",0,1,"",!0),Hl("light",1,3,"",!0),Hl("msdf",0,3,"",!1),Hl("diffuseDetail",0,3,"",!1,!0),Hl("normalDetail",0,-1,"",!1),Hl("clearCoat",0,1,"",!0),Hl("clearCoatGloss",0,1,"",!0),Hl("clearCoatNormal",0,-1,"",!1),jl("cubeMap"),jl("sphereMap"),jl("envAtlas");const e=[null,null,null,null,null,null];Vl("prefilteredCubemaps",(()=>e.slice()),(function(e){const t=this._prefilteredCubemaps;e=e||[];let s=!1,i=!0;for(let n=0;n<6;++n){const a=e[n]||null;t[n]!==a&&(t[n]=a,s=!0),i=i&&!!t[n]}s&&(i?this.envAtlas=Sl.generatePrefilteredAtlas(t,{target:this.envAtlas}):this.envAtlas&&(this.envAtlas.destroy(),this.envAtlas=null),this._dirtyShader=!0)}),(function(){return this._prefilteredCubemaps}))}();class $l{constructor(e){this.processedCache=new Map,this._device=e,this._cache={},this._generators={},this._isClearingCache=!1,this._precached=!1,this._programsCollection=[],this._defaultStdMatOption={},this._defaultStdMatOptionMin={};const t=new zl;t.shaderOptBuilder.updateRef(this._defaultStdMatOption,{},t,null,[],0,null),t.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,{},t,null,[],4,null)}register(e,t){this.isRegistered(e)||(this._generators[e]=t)}unregister(e){this.isRegistered(e)&&delete this._generators[e]}isRegistered(e){return void 0!==this._generators[e]}generateShader(e,t,s,i){let n=this._cache[s];if(!n){let a;i.lights&&(a=i.lights,i.lights=a.map((function(e){const t=e.clone?e.clone():e;return t.key=e.key,t}))),this.storeNewProgram(t,i),i.lights&&(i.lights=a),this._precached;const r=this._device,o=e.createShaderDefinition(r,i);o.name=`${t}-pass:${i.pass}`,n=this._cache[s]=new Oo(r,o)}return n}getProgram(e,t,s){const i=this._generators[e];if(!i)return null;const n=i.generateKey(t),a=`${n}#${JSON.stringify(s)}`;let r=this.processedCache.get(a);if(!r){const o=this.generateShader(i,e,n,t).definition,h={attributes:o.attributes,vshader:o.vshader,fshader:o.fshader,processingOptions:s};r=new Oo(this._device,h),this.processedCache.set(a,r)}return r}storeNewProgram(e,t){let s={};if("standard"===e){const e=this._getDefaultStdMatOptions(t.pass);for(const i in t)(t.hasOwnProperty(i)&&e[i]!==t[i]||"pass"===i)&&(s[i]=t[i])}else s=t;this._programsCollection.push(JSON.stringify({name:e,options:s}))}dumpPrograms(){let e="let device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;\n";e+="let shaders = [",this._programsCollection[0]&&(e+="\n\t"+this._programsCollection[0]);for(let t=1;t<this._programsCollection.length;++t)e+=",\n\t"+this._programsCollection[t];e+="\n];\n",e+="device.programLib.precompile(shaders);\n",e+='if (pc.version != "1.56.0" || pc.revision != "50ffa14a7")\n',e+='\tconsole.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");';const t=document.createElement("a");t.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(e)),t.setAttribute("download","precompile-shaders.js"),t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)}clearCache(){const e=this._cache;this._isClearingCache=!0;for(const t in e)e.hasOwnProperty(t)&&e[t].destroy();this._cache={},this._isClearingCache=!1}removeFromCache(e){if(this._isClearingCache)return;const t=this._cache;for(const s in t)if(t.hasOwnProperty(s)&&t[s]===e){delete t[s];break}}_getDefaultStdMatOptions(e){return 2===e||3===e||zo.isShadow(e)?this._defaultStdMatOptionMin:this._defaultStdMatOption}precompile(e){if(e){const t=new Array(e.length);for(let s=0;s<e.length;s++){if("standard"===e[s].name){const t=e[s].options,i=this._getDefaultStdMatOptions(t.pass);for(const e in i)i.hasOwnProperty(e)&&void 0===t[e]&&(t[e]=i[e])}t[s]=this.getProgram(e[s].name,e[s].options)}}this._precached=!0}}class Kl extends C{constructor(e){super(),this.canvas=void 0,this.deviceType=void 0,this.scope=void 0,this.boneLimit=void 0,this.maxAnisotropy=void 0,this.maxCubeMapSize=void 0,this.maxTextureSize=void 0,this.maxVolumeSize=void 0,this.precision=void 0,this.renderTarget=null,this.insideRenderPass=!1,this.supportsInstancing=void 0,this.supportsUniformBuffers=!1,this.textureFloatRenderable=void 0,this.textureHalfFloatRenderable=void 0,this.canvas=e,this._width=0,this._height=0,this._maxPixelRatio=1,this.shaders=[],this.buffers=[],this.textures=[],this.targets=[],this._vram={tex:0,vb:0,ib:0,ub:0},this._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0},this.initializeContextCaches(),this._drawCallsPerFrame=0,this._shaderSwitchesPerFrame=0,this._primsPerFrame=[];for(let e=0;e<=6;e++)this._primsPerFrame[e]=0;this._renderTargetCreationTime=0,this.scope=new ah("Device"),this.textureBias=this.scope.resolve("textureBias"),this.textureBias.setValue(0),this.programLib=new $l(this)}destroy(){this.fire("destroy")}postDestroy(){this.scope=null,this.canvas=null}toJSON(e){}initializeContextCaches(){this.indexBuffer=null,this.vertexBuffers=[],this.shader=null,this.renderTarget=null}getProgramLibrary(){return this.programLib}setProgramLibrary(e){this.programLib=e}setRenderTarget(e){this.renderTarget=e}setIndexBuffer(e){this.indexBuffer=e}setVertexBuffer(e){e&&this.vertexBuffers.push(e)}getRenderTarget(){return this.renderTarget}initRenderTarget(e){e.initialized||(e.init(),this.targets.push(e))}_isBrowserInterface(e){return"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap}resizeCanvas(e,t){this._width=e,this._height=t;const s=Math.min(this._maxPixelRatio,N.browser?window.devicePixelRatio:1);e=Math.floor(e*s),t=Math.floor(t*s),this.canvas.width===e&&this.canvas.height===t||(this.canvas.width=e,this.canvas.height=t,this.fire("resizecanvas",e,t))}setResolution(e,t){this._width=e,this._height=t,this.canvas.width=e,this.canvas.height=t,this.fire("resizecanvas",e,t)}updateClientRect(){this.clientRect=this.canvas.getBoundingClientRect()}get width(){return this.canvas.width}get height(){return this.canvas.height}set fullscreen(e){}get fullscreen(){return!1}set maxPixelRatio(e){this._maxPixelRatio=e,this.resizeCanvas(this._width,this._height)}get maxPixelRatio(){return this._maxPixelRatio}getBoneLimit(){return this.boneLimit}setBoneLimit(e){this.boneLimit=e}}const Zl={depth:!0,face:0};let Ql=0;class Jl{constructor(e){var t,s;this.id=Ql++;const i=arguments[1],n=arguments[2];if(e instanceof Kl?(this._colorBuffer=i,e=n):this._colorBuffer=e.colorBuffer,this._colorBuffer&&(this._colorBuffer._isRenderTarget=!0),e=void 0!==e?e:Zl,this._depthBuffer=e.depthBuffer,this._face=void 0!==e.face?e.face:0,this._depthBuffer){const e=this._depthBuffer._format;16===e?(this._depth=!0,this._stencil=!1):17===e?(this._depth=!0,this._stencil=!0):(this._depth=!1,this._stencil=!1)}else this._depth=void 0===e.depth||e.depth,this._stencil=void 0!==e.stencil&&e.stencil;const a=(null==(t=this._colorBuffer)?void 0:t.device)||(null==(s=this._depthBuffer)?void 0:s.device)||e.graphicsDevice;var r,o;(this._device=a,this._samples=void 0!==e.samples?Math.min(e.samples,this._device.maxSamples):1,this.autoResolve=void 0===e.autoResolve||e.autoResolve,this.name=e.name,this.name)||(this.name=null==(r=this._colorBuffer)?void 0:r.name);this.name||(this.name=null==(o=this._depthBuffer)?void 0:o.name);this.name||(this.name="Untitled"),this.flipY=!!e.flipY,this.impl=a.createRenderTargetImpl(this)}destroy(){const e=this._device;if(e){const t=e.targets.indexOf(this);-1!==t&&e.targets.splice(t,1),this.destroyFrameBuffers()}}destroyFrameBuffers(){const e=this._device;e&&this.impl.destroy(e)}destroyTextureBuffers(){this._depthBuffer&&(this._depthBuffer.destroy(),this._depthBuffer=null),this._colorBuffer&&(this._colorBuffer.destroy(),this._colorBuffer=null)}init(){this.impl.init(this._device,this)}get initialized(){return this.impl.initialized}loseContext(){this.impl.loseContext()}resolve(e=!0,t=!!this._depthBuffer){this._device&&this._samples>1&&this.impl.resolve(this._device,this,e,t)}copy(e,t,s){if(!this._device){if(!e._device)return!1;this._device=e._device}return this._device.copyRenderTarget(e,this,t,s)}get samples(){return this._samples}get depth(){return this._depth}get stencil(){return this._stencil}get colorBuffer(){return this._colorBuffer}get depthBuffer(){return this._depthBuffer}get face(){return this._face}get width(){var e,t;return(null==(e=this._colorBuffer)?void 0:e.width)||(null==(t=this._depthBuffer)?void 0:t.width)||this._device.width}get height(){var e,t;return(null==(e=this._colorBuffer)?void 0:e.height)||(null==(t=this._depthBuffer)?void 0:t.height)||this._device.height}}function ec(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}function tc(e,t,s){let i=2*(e+.5)/s-1,n=2*(t+.5)/s-1;i*=1-1/s,n*=1-1/s;const a=1/s,r=i-a,o=n-a,h=i+a,l=n+a;let c=ec(r,o)-ec(r,l)-ec(h,o)+ec(h,l);return 0===e&&0===t||e===s-1&&0===t||0===e&&t===s-1||e===s-1&&t===s-1?c/=3:0!==e&&0!==t&&e!==s-1&&t!==s-1||(c*=.5),c}function sc(e,t,s){if(7!==t.format)return null;if(!t._levels[0]||!t._levels[0][0])return null;const i=t.width;if(!t._levels[0][0].length){if(!(t._levels[0][0]instanceof HTMLImageElement))return null;{const s=eh(e,Bo.fullscreenQuadVS,Bo.fullscreenQuadPS,"fsQuadSimple"),n=e.scope.resolve("source");for(let a=0;a<6;a++){const r=t._levels[0][a],o=new fh(e,{name:"prefiltered-cube",cubemap:!1,type:"default",format:t.format,width:i,height:i,mipmaps:!1});o._levels[0]=r,o.upload();const h=new fh(e,{name:"prefiltered-cube",cubemap:!1,type:"default",format:t.format,width:i,height:i,mipmaps:!1}),l=new Jl({colorBuffer:h,depth:!1});n.setValue(o),bo(e,l,s);const c=e.gl;c.bindFramebuffer(c.FRAMEBUFFER,l.impl._glFrameBuffer);const d=new Uint8Array(i*i*4);c.readPixels(0,0,o.width,o.height,c.RGBA,c.UNSIGNED_BYTE,d),t._levels[0][a]=d}}}const n=[];for(let e=0;e<i;e++)for(let t=0;t<i;t++){const s=t/(i-1)*2-1,a=e/(i-1)*2-1;n[e*i+t]=new ge(s,a,1).normalize()}const a=new Float32Array(27);let r=0;for(let e=0;e<6;e++)for(let o=0;o<i;o++)for(let h=0;h<i;h++){const l=o*i+h,c=tc(h,o,i),d=4*c/17,u=8*c/17,p=15*c/17,m=5*c/68,f=15*c/68,_=n[l];let g,y,v;0===e?(g=_.z,y=-_.y,v=-_.x):1===e?(g=-_.z,y=-_.y,v=_.x):2===e?(g=_.x,y=_.z,v=_.y):3===e?(g=_.x,y=-_.z,v=-_.y):4===e?(g=_.x,y=-_.y,v=_.z):5===e&&(g=-_.x,y=-_.y,v=-_.z),s||(g=-g);const x=t._levels[0][e][4*l+3]/255;for(let s=0;s<3;s++){let i=t._levels[0][e][4*l+s]/255;"rgbm"===t.type?(i*=8*x,i*=i):i=Math.pow(i,2.2),a[0+s]+=i*d,a[3+s]+=i*u*g,a[6+s]+=i*u*y,a[9+s]+=i*u*v,a[12+s]+=i*p*g*v,a[15+s]+=i*p*v*y,a[18+s]+=i*p*y*g,a[21+s]+=i*m*(3*v*v-1),a[24+s]+=i*f*(g*g-y*y),r+=c}}for(let e=0;e<a.length;e++)a[e]*=4*Math.PI/r;return a}let ic=0;class nc{constructor(e,t,s,i=0,n){this.device=e,this.format=t,this.numIndices=s,this.usage=i,this.id=ic++,this.impl=e.createIndexBufferImpl(this);const a=ho[t];this.bytesPerIndex=a,this.numBytes=this.numIndices*a,n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),this.adjustVramSizeTracking(e._vram,this.numBytes),this.device.buffers.push(this)}destroy(){const e=this.device,t=e.buffers.indexOf(this);-1!==t&&e.buffers.splice(t,1),this.device.indexBuffer===this&&(this.device.indexBuffer=null),this.impl.initialized&&(this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this.storage.byteLength))}adjustVramSizeTracking(e,t){e.ib+=t}loseContext(){this.impl.loseContext()}getFormat(){return this.format}getNumIndices(){return this.numIndices}lock(){return this.storage}unlock(){this.impl.unlock(this)}setData(e){return e.byteLength===this.numBytes&&(this.storage=e,this.unlock(),!0)}_lockTypedArray(){const e=this.lock();return 2===this.format?new Uint32Array(e):1===this.format?new Uint16Array(e):new Uint8Array(e)}writeData(e,t){const s=this._lockTypedArray();if(e.length>t)if(ArrayBuffer.isView(e))e=e.subarray(0,t),s.set(e);else for(let i=0;i<t;i++)s[i]=e[i];else s.set(e);this.unlock()}readData(e){const t=this._lockTypedArray(),s=this.numIndices;if(ArrayBuffer.isView(e))e.set(t);else{e.length=0;for(let i=0;i<s;i++)e[i]=t[i]}return s}}function ac(e){this.array[this.index]=e}function rc(e,t){this.array[this.index]=e,this.array[this.index+1]=t}function oc(e,t,s){this.array[this.index]=e,this.array[this.index+1]=t,this.array[this.index+2]=s}function hc(e,t,s,i){this.array[this.index]=e,this.array[this.index+1]=t,this.array[this.index+2]=s,this.array[this.index+3]=i}function lc(e,t,s){this.array[e]=t[s]}function cc(e,t,s){this.array[e]=t[s],this.array[e+1]=t[s+1]}function dc(e,t,s){this.array[e]=t[s],this.array[e+1]=t[s+1],this.array[e+2]=t[s+2]}function uc(e,t,s){this.array[e]=t[s],this.array[e+1]=t[s+1],this.array[e+2]=t[s+2],this.array[e+3]=t[s+3]}function mc(e,t,s){t[s]=this.array[e]}function fc(e,t,s){t[s]=this.array[e],t[s+1]=this.array[e+1]}function _c(e,t,s){t[s]=this.array[e],t[s+1]=this.array[e+1],t[s+2]=this.array[e+2]}function gc(e,t,s){t[s]=this.array[e],t[s+1]=this.array[e+1],t[s+2]=this.array[e+2],t[s+3]=this.array[e+3]}class yc{constructor(e,t,s){switch(this.index=0,this.numComponents=t.numComponents,s.interleaved?this.array=new no[t.dataType](e,t.offset):this.array=new no[t.dataType](e,t.offset,s.vertexCount*t.numComponents),this.stride=t.stride/this.array.constructor.BYTES_PER_ELEMENT,t.numComponents){case 1:this.set=ac,this.getToArray=mc,this.setFromArray=lc;break;case 2:this.set=rc,this.getToArray=fc,this.setFromArray=cc;break;case 3:this.set=oc,this.getToArray=_c,this.setFromArray=dc;break;case 4:this.set=hc,this.getToArray=gc,this.setFromArray=uc}}get(e){return this.array[this.index+e]}set(e,t,s,i){}getToArray(e,t,s){}setFromArray(e,t,s){}}class vc{constructor(e){this.vertexBuffer=e,this.vertexFormatSize=e.getFormat().size,this.buffer=this.vertexBuffer.lock(),this.accessors=[],this.element={};const t=this.vertexBuffer.getFormat();for(let e=0;e<t.elements.length;e++){const s=t.elements[e];this.accessors[e]=new yc(this.buffer,s,t),this.element[s.name]=this.accessors[e]}}next(e=1){let t=0;const s=this.accessors,i=this.accessors.length;for(;t<i;){const i=s[t++];i.index+=e*i.stride}}end(){this.vertexBuffer.unlock()}writeData(e,t,s){const i=this.element[e];if(i){s>this.vertexBuffer.numVertices&&(s=this.vertexBuffer.numVertices);const e=i.numComponents;if(this.vertexBuffer.getFormat().interleaved){let n=0;for(let a=0;a<s;a++)i.setFromArray(n,t,a*e),n+=i.stride}else if(t.length>s*e){const n=s*e;if(ArrayBuffer.isView(t))t=t.subarray(0,n),i.array.set(t);else for(let e=0;e<n;e++)i.array[e]=t[e]}else i.array.set(t)}}readData(e,t){const s=this.element[e];let i=0;if(s){let e;i=this.vertexBuffer.numVertices;const n=s.numComponents;if(this.vertexBuffer.getFormat().interleaved){Array.isArray(t)&&(t.length=0),s.index=0;let a=0;for(e=0;e<i;e++)s.getToArray(a,t,e*n),a+=s.stride}else if(ArrayBuffer.isView(t))t.set(s.array);else{t.length=0;const a=i*n;for(e=0;e<a;e++)t[e]=s.array[e]}}return i}}const xc={type:5,base:0,count:4,indexed:!1};class bc{constructor(e){this.device=e,this.shader=null,this.vertexBuffer=Sc(e),this.needsDepthBuffer=!1,this.depthMap=null}render(e,t,s){}}function Sc(e){const t=new go(e,[{semantic:"POSITION",components:2,type:6}]),s=new fo(e,t,4),i=new vc(s);return i.element.POSITION.set(-1,-1),i.next(),i.element.POSITION.set(1,-1),i.next(),i.element.POSITION.set(-1,1),i.next(),i.element.POSITION.set(1,1),i.end(),s}function wc(e,t,s,i,n){const a=e.getRenderTarget();e.setRenderTarget(t),e.updateBegin();let r=t?t.width:e.width,o=t?t.height:e.height,h=0,l=0;n&&(h=n.x*r,l=n.y*o,r*=n.z,o*=n.w);const c=e.vx,d=e.vy,u=e.vw,p=e.vh;e.setViewport(h,l,r,o);const m=e.sx,f=e.sy,_=e.sw,g=e.sh;e.setScissor(h,l,r,o);const y=e.getBlending(),v=e.getDepthTest(),x=e.getDepthWrite(),b=e.getCullMode(),S=e.writeRed,w=e.writeGreen,T=e.writeBlue,M=e.writeAlpha;e.setBlending(!1),e.setDepthTest(!1),e.setDepthWrite(!1),e.setCullMode(0),e.setColorWrite(!0,!0,!0,!0),e.setVertexBuffer(s,0),e.setShader(i),e.draw(xc),e.setBlending(y),e.setDepthTest(v),e.setDepthWrite(x),e.setCullMode(b),e.setColorWrite(S,w,T,M),e.updateEnd(),e.setRenderTarget(a),e.updateBegin(),e.setViewport(c,d,u,p),e.setScissor(m,f,_,g)}class Tc{constructor(e,t=3){this.device=e.device;const s=this.device.gl;this._inputBuffer=e,3===t&&e.usage!==t&&(s.bindBuffer(s.ARRAY_BUFFER,e.impl.bufferId),s.bufferData(s.ARRAY_BUFFER,e.storage,s.DYNAMIC_COPY)),this._outputBuffer=new fo(e.device,e.format,e.numVertices,t,e.storage)}static createShader(e,t,s){return eh(e,t,null,s,!0)}destroy(){this._outputBuffer.destroy()}process(e,t=!0){const s=this.device,i=s.getRenderTarget();if(s.setRenderTarget(null),s.updateBegin(),s.setVertexBuffer(this._inputBuffer,0),s.setRaster(!1),s.setTransformFeedbackBuffer(this._outputBuffer),s.setShader(e),s.draw({type:0,base:0,count:this._inputBuffer.numVertices,indexed:!1}),s.setTransformFeedbackBuffer(null),s.setRaster(!0),s.updateEnd(),s.setRenderTarget(i),t){let e=this._inputBuffer.impl.bufferId;this._inputBuffer.impl.bufferId=this._outputBuffer.impl.bufferId,this._outputBuffer.impl.bufferId=e,e=this._inputBuffer.impl.vao,this._inputBuffer.impl.vao=this._outputBuffer.impl.vao,this._outputBuffer.impl.vao=e}}get inputBuffer(){return this._inputBuffer}get outputBuffer(){return this._outputBuffer}}class Mc{constructor(){this.bufferId=null}destroy(e){this.bufferId&&(e.gl.deleteBuffer(this.bufferId),this.bufferId=null)}get initialized(){return!!this.bufferId}loseContext(){this.bufferId=null}unlock(e,t,s,i){const n=e.gl;let a;switch(this.bufferId||(this.bufferId=n.createBuffer()),t){case 0:a=n.STATIC_DRAW;break;case 1:a=n.DYNAMIC_DRAW;break;case 2:a=n.STREAM_DRAW;break;case 3:a=e.webgl2?n.DYNAMIC_COPY:n.STATIC_DRAW}n.bindBuffer(s,this.bufferId),n.bufferData(s,i,a)}}class Cc extends Mc{constructor(...e){super(...e),this.vao=null}destroy(e){super.destroy(e),e.boundVao=null,e.gl.bindVertexArray(null)}loseContext(){super.loseContext(),this.vao=null}unlock(e){const t=e.device;super.unlock(t,e.usage,t.gl.ARRAY_BUFFER,e.storage)}}class Ac extends Mc{constructor(e){super();const t=e.device.gl,s=e.format;0===s?this.glFormat=t.UNSIGNED_BYTE:1===s?this.glFormat=t.UNSIGNED_SHORT:2===s&&(this.glFormat=t.UNSIGNED_INT)}unlock(e){const t=e.device;super.unlock(t,e.usage,t.gl.ELEMENT_ARRAY_BUFFER,e.storage)}}class Pc{constructor(e,t,s,i){if(this.locationId=i,this.scopeId=e.scope.resolve(t),this.version=new th,"[0]"===t.substring(t.length-3))switch(s){case 2:s=17;break;case 3:s=21;break;case 4:s=22;break;case 5:s=23}this.dataType=s,this.value=[null,null,null,null],this.array=[]}}class Ec{constructor(e){this.uniforms=[],this.samplers=[],this.attributes=[],this.glProgram=null,this.glVertexShader=null,this.glFragmentShader=null,this.compileAndLink(e.device,e),e.device.shaders.push(e)}destroy(e){const t=e.device,s=t.shaders.indexOf(e);-1!==s&&t.shaders.splice(s,1),this.glProgram&&(t.gl.deleteProgram(this.glProgram),this.glProgram=null,t.removeShaderFromCache(e))}restoreContext(e,t){this.compileAndLink(e,t)}compileAndLink(e,t){const s=t.definition,i=this._compileShaderSource(e,s.vshader,!0),n=this._compileShaderSource(e,s.fshader,!1),a=e.gl,r=a.createProgram();a.attachShader(r,i),a.attachShader(r,n);const o=s.attributes;if(e.webgl2&&s.useTransformFeedback){const e=[];for(const t in o)o.hasOwnProperty(t)&&e.push("out_"+t);a.transformFeedbackVaryings(r,e,a.INTERLEAVED_ATTRIBS)}for(const e in o)if(o.hasOwnProperty(e)){const t=o[e],s=lo[t];a.bindAttribLocation(r,s,e)}a.linkProgram(r),this.glVertexShader=i,this.glFragmentShader=n,this.glProgram=r}_compileShaderSource(e,t,s){const i=e.gl,n=s?e.vertexShaderCache:e.fragmentShaderCache;let a=n[t];return a||(a=i.createShader(s?i.VERTEX_SHADER:i.FRAGMENT_SHADER),i.shaderSource(a,t),i.compileShader(a),n[t]=a),a}postLink(e,t){const s=e.gl,i=this.glProgram,n=t.definition;if(!this._isCompiled(e,t,this.glVertexShader,n.vshader,"vertex"))return!1;if(!this._isCompiled(e,t,this.glFragmentShader,n.fshader,"fragment"))return!1;if(!s.getProgramParameter(i,s.LINK_STATUS)){const e="Failed to link shader program. Error: "+s.getProgramInfoLog(i);return console.error(e),!1}let a,r,o,h;a=0;const l=s.getProgramParameter(i,s.ACTIVE_ATTRIBUTES);for(;a<l;)r=s.getActiveAttrib(i,a++),o=s.getAttribLocation(i,r.name),void 0===n.attributes[r.name]&&console.error(`Vertex shader attribute "${r.name}" is not mapped to a semantic in shader definition.`),h=new Pc(e,n.attributes[r.name],e.pcUniformType[r.type],o),this.attributes.push(h);a=0;const c=s.getProgramParameter(i,s.ACTIVE_UNIFORMS);for(;a<c;)r=s.getActiveUniform(i,a++),o=s.getUniformLocation(i,r.name),h=new Pc(e,r.name,e.pcUniformType[r.type],o),r.type===s.SAMPLER_2D||r.type===s.SAMPLER_CUBE||e.webgl2&&(r.type===s.SAMPLER_2D_SHADOW||r.type===s.SAMPLER_CUBE_SHADOW||r.type===s.SAMPLER_3D)?this.samplers.push(h):this.uniforms.push(h);return t.ready=!0,!0}_isCompiled(e,t,s,i,n){const a=e.gl;if(!a.getShaderParameter(s,a.COMPILE_STATUS)){const e=a.getShaderInfoLog(s),[t,r]=this._processError(i,e),o=`Failed to compile ${n} shader:\n\n${e}\n${t}`;return console.error(o),!1}return!0}_processError(e,t){const s={};let i="";if(e){const n=e.split("\n");let a=0,r=n.length;if(t&&t.startsWith("ERROR:")){const e=t.match(/^ERROR:\s([0-9]+):([0-9]+):\s*(.+)/);e&&(s.message=e[3],s.line=parseInt(e[2],10),a=Math.max(0,s.line-6),r=Math.min(n.length,s.line+5))}for(let e=a;e<r;e++)i+=e+1+":\t"+n[e]+"\n";s.source=e}return[i,s]}}function Rc(e,t){const s=e.width,i=e.height;if(s>t||i>t){const n=t/Math.max(s,i),a=Math.floor(s*n),r=Math.floor(i*n),o=document.createElement("canvas");o.width=a,o.height=r;return o.getContext("2d").drawImage(e,0,0,s,i,0,0,a,r),o}return e}class Lc{constructor(){this._glTexture=null,this._glTarget=void 0,this._glFormat=void 0,this._glInternalFormat=void 0,this._glPixelType=void 0}destroy(e){if(this._glTexture){for(let t=0;t<e.textureUnits.length;t++){const s=e.textureUnits[t];for(let e=0;e<s.length;e++)s[e]===this._glTexture&&(s[e]=null)}e.gl.deleteTexture(this._glTexture),this._glTexture=null}}loseContext(){this._glTexture=null}initialize(e,t){const s=e.gl;switch(this._glTexture=s.createTexture(),this._glTarget=t._cubemap?s.TEXTURE_CUBE_MAP:t._volume?s.TEXTURE_3D:s.TEXTURE_2D,t._format){case 0:this._glFormat=s.ALPHA,this._glInternalFormat=s.ALPHA,this._glPixelType=s.UNSIGNED_BYTE;break;case 1:this._glFormat=s.LUMINANCE,this._glInternalFormat=s.LUMINANCE,this._glPixelType=s.UNSIGNED_BYTE;break;case 2:this._glFormat=s.LUMINANCE_ALPHA,this._glInternalFormat=s.LUMINANCE_ALPHA,this._glPixelType=s.UNSIGNED_BYTE;break;case 3:this._glFormat=s.RGB,this._glInternalFormat=s.RGB,this._glPixelType=s.UNSIGNED_SHORT_5_6_5;break;case 4:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA,this._glPixelType=s.UNSIGNED_SHORT_5_5_5_1;break;case 5:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA,this._glPixelType=s.UNSIGNED_SHORT_4_4_4_4;break;case 6:this._glFormat=s.RGB,this._glInternalFormat=e.webgl2?s.RGB8:s.RGB,this._glPixelType=s.UNSIGNED_BYTE;break;case 7:this._glFormat=s.RGBA,this._glInternalFormat=e.webgl2?s.RGBA8:s.RGBA,this._glPixelType=s.UNSIGNED_BYTE;break;case 8:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case 9:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case 10:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case 21:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureETC1.COMPRESSED_RGB_ETC1_WEBGL;break;case 24:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case 25:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case 26:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case 27:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case 22:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_RGB8_ETC2;break;case 23:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC;break;case 28:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case 29:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureATC.COMPRESSED_RGB_ATC_WEBGL;break;case 30:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureATC.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL;break;case 11:this._glFormat=s.RGB,e.webgl2?(this._glInternalFormat=s.RGB16F,this._glPixelType=s.HALF_FLOAT):(this._glInternalFormat=s.RGB,this._glPixelType=e.extTextureHalfFloat.HALF_FLOAT_OES);break;case 12:this._glFormat=s.RGBA,e.webgl2?(this._glInternalFormat=s.RGBA16F,this._glPixelType=s.HALF_FLOAT):(this._glInternalFormat=s.RGBA,this._glPixelType=e.extTextureHalfFloat.HALF_FLOAT_OES);break;case 13:this._glFormat=s.RGB,e.webgl2?this._glInternalFormat=s.RGB32F:this._glInternalFormat=s.RGB,this._glPixelType=s.FLOAT;break;case 14:this._glFormat=s.RGBA,e.webgl2?this._glInternalFormat=s.RGBA32F:this._glInternalFormat=s.RGBA,this._glPixelType=s.FLOAT;break;case 15:this._glFormat=s.RED,this._glInternalFormat=s.R32F,this._glPixelType=s.FLOAT;break;case 16:e.webgl2?(this._glFormat=s.DEPTH_COMPONENT,this._glInternalFormat=s.DEPTH_COMPONENT32F,this._glPixelType=s.FLOAT):(this._glFormat=s.DEPTH_COMPONENT,this._glInternalFormat=s.DEPTH_COMPONENT,this._glPixelType=s.UNSIGNED_SHORT);break;case 17:this._glFormat=s.DEPTH_STENCIL,e.webgl2?(this._glInternalFormat=s.DEPTH24_STENCIL8,this._glPixelType=s.UNSIGNED_INT_24_8):(this._glInternalFormat=s.DEPTH_STENCIL,this._glPixelType=e.extDepthTexture.UNSIGNED_INT_24_8_WEBGL);break;case 18:this._glFormat=s.RGB,this._glInternalFormat=s.R11F_G11F_B10F,this._glPixelType=s.UNSIGNED_INT_10F_11F_11F_REV;break;case 19:this._glFormat=s.RGB,this._glInternalFormat=s.SRGB8,this._glPixelType=s.UNSIGNED_BYTE;break;case 20:this._glFormat=s.RGBA,this._glInternalFormat=s.SRGB8_ALPHA8,this._glPixelType=s.UNSIGNED_BYTE}}upload(e,t){const s=e.gl;if(!t._needsUpload&&(t._needsMipmapsUpload&&t._mipmapsUploaded||!t.pot))return;let i,n,a=0;const r=Math.log2(Math.max(t._width,t._height))+1;for(;t._levels[a]||0===a;)if(t._needsUpload||0!==a){if(a&&(!t._needsMipmapsUpload||!t._mipmaps))break;if(i=t._levels[a],1===a&&!t._compressed&&t._levels.length<r&&(s.generateMipmap(this._glTarget),t._mipmapsUploaded=!0),t._cubemap){let r;if(e._isBrowserInterface(i[0]))for(r=0;r<6;r++){if(!t._levelsUpdated[0][r])continue;let n=i[r];n instanceof HTMLImageElement&&(n.width>e.maxCubeMapSize||n.height>e.maxCubeMapSize)&&(n=Rc(n,e.maxCubeMapSize),0===a&&(t._width=n.width,t._height=n.height)),e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+r,a,this._glInternalFormat,this._glFormat,this._glPixelType,n)}else for(n=1/Math.pow(2,a),r=0;r<6;r++){if(!t._levelsUpdated[0][r])continue;const o=i[r];t._compressed?s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+r,a,this._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),0,o):(e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+r,a,this._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),0,this._glFormat,this._glPixelType,o))}}else t._volume?(n=1/Math.pow(2,a),t._compressed?s.compressedTexImage3D(s.TEXTURE_3D,a,this._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),Math.max(t._depth*n,1),0,i):(e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),s.texImage3D(s.TEXTURE_3D,a,this._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),Math.max(t._depth*n,1),0,this._glFormat,this._glPixelType,i))):(e._isBrowserInterface(i)?(i instanceof HTMLImageElement&&(i.width>e.maxTextureSize||i.height>e.maxTextureSize)&&(i=Rc(i,e.maxTextureSize),0===a&&(t._width=i.width,t._height=i.height)),e.setUnpackFlipY(t._flipY),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),s.texImage2D(s.TEXTURE_2D,a,this._glInternalFormat,this._glFormat,this._glPixelType,i)):(n=1/Math.pow(2,a),t._compressed?s.compressedTexImage2D(s.TEXTURE_2D,a,this._glInternalFormat,Math.max(Math.floor(t._width*n),1),Math.max(Math.floor(t._height*n),1),0,i):(e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),s.texImage2D(s.TEXTURE_2D,a,this._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),0,this._glFormat,this._glPixelType,i))),t._mipmapsUploaded=0!==a);a++}else a++;if(t._needsUpload)if(t._cubemap)for(let e=0;e<6;e++)t._levelsUpdated[0][e]=!1;else t._levelsUpdated[0]=!1;!t._compressed&&t._mipmaps&&t._needsMipmapsUpload&&(t.pot||e.webgl2)&&1===t._levels.length&&(s.generateMipmap(this._glTarget),t._mipmapsUploaded=!0),t._gpuSize&&t.adjustVramSizeTracking(e._vram,-t._gpuSize),t._gpuSize=t.gpuSize,t.adjustVramSizeTracking(e._vram,t._gpuSize)}}class Ic{constructor(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this._glMsaaColorBuffer=null,this._glMsaaDepthBuffer=null}destroy(e){const t=e.gl;this._glFrameBuffer&&(t.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null),this._glDepthBuffer&&(t.deleteRenderbuffer(this._glDepthBuffer),this._glDepthBuffer=null),this._glResolveFrameBuffer&&(t.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null),this._glMsaaColorBuffer&&(t.deleteRenderbuffer(this._glMsaaColorBuffer),this._glMsaaColorBuffer=null),this._glMsaaDepthBuffer&&(t.deleteRenderbuffer(this._glMsaaDepthBuffer),this._glMsaaDepthBuffer=null)}get initialized(){return null!==this._glFrameBuffer}init(e,t){const s=e.gl;this._glFrameBuffer=s.createFramebuffer(),e.setFramebuffer(this._glFrameBuffer);const i=t._colorBuffer;i&&(i.impl._glTexture||(i._width=Math.min(i.width,e.maxRenderBufferSize),i._height=Math.min(i.height,e.maxRenderBufferSize),e.setTexture(i,0)),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,i._cubemap?s.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:s.TEXTURE_2D,i.impl._glTexture,0));const n=t._depthBuffer;if(n)n.impl._glTexture||(n._width=Math.min(n.width,e.maxRenderBufferSize),n._height=Math.min(n.height,e.maxRenderBufferSize),e.setTexture(n,0)),t._stencil?s.framebufferTexture2D(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,n._cubemap?s.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:s.TEXTURE_2D,t._depthBuffer.impl._glTexture,0):s.framebufferTexture2D(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,n._cubemap?s.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:s.TEXTURE_2D,t._depthBuffer.impl._glTexture,0);else if(t._depth){if(!(t._samples>1&&e.webgl2)){if(this._glDepthBuffer||(this._glDepthBuffer=s.createRenderbuffer()),s.bindRenderbuffer(s.RENDERBUFFER,this._glDepthBuffer),t._stencil)s.renderbufferStorage(s.RENDERBUFFER,s.DEPTH_STENCIL,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.RENDERBUFFER,this._glDepthBuffer);else{const i=e.webgl2?s.DEPTH_COMPONENT32F:s.DEPTH_COMPONENT16;s.renderbufferStorage(s.RENDERBUFFER,i,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.RENDERBUFFER,this._glDepthBuffer)}s.bindRenderbuffer(s.RENDERBUFFER,null)}}e.webgl2&&t._samples>1&&(this._glResolveFrameBuffer=this._glFrameBuffer,this._glFrameBuffer=s.createFramebuffer(),e.setFramebuffer(this._glFrameBuffer),i&&(this._glMsaaColorBuffer||(this._glMsaaColorBuffer=s.createRenderbuffer()),s.bindRenderbuffer(s.RENDERBUFFER,this._glMsaaColorBuffer),s.renderbufferStorageMultisample(s.RENDERBUFFER,t._samples,i.impl._glInternalFormat,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.RENDERBUFFER,this._glMsaaColorBuffer)),t._depth&&(this._glMsaaDepthBuffer||(this._glMsaaDepthBuffer=s.createRenderbuffer()),s.bindRenderbuffer(s.RENDERBUFFER,this._glMsaaDepthBuffer),t._stencil?(s.renderbufferStorageMultisample(s.RENDERBUFFER,t._samples,s.DEPTH24_STENCIL8,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.RENDERBUFFER,this._glMsaaDepthBuffer)):(s.renderbufferStorageMultisample(s.RENDERBUFFER,t._samples,s.DEPTH_COMPONENT32F,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.RENDERBUFFER,this._glMsaaDepthBuffer))))}_checkFbo(e){const t=e.gl;switch(t.checkFramebufferStatus(t.FRAMEBUFFER)){case t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case t.FRAMEBUFFER_UNSUPPORTED:console.error("ERROR: FRAMEBUFFER_UNSUPPORTED");case t.FRAMEBUFFER_COMPLETE:}}loseContext(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this._glMsaaColorBuffer=null,this._glMsaaDepthBuffer=null}resolve(e,t,s,i){if(e.webgl2){const n=e.gl;n.bindFramebuffer(n.READ_FRAMEBUFFER,this._glFrameBuffer),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,this._glResolveFrameBuffer),n.blitFramebuffer(0,0,t.width,t.height,0,0,t.width,t.height,(s?n.COLOR_BUFFER_BIT:0)|(i?n.DEPTH_BUFFER_BIT:0),n.NEAREST),n.bindFramebuffer(n.FRAMEBUFFER,this._glFrameBuffer)}}}const Dc=[];function Oc(e,t){let s=!0;const i=e.createTexture();e.bindTexture(e.TEXTURE_2D,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,2,2,0,e.RGBA,t,null);const n=e.createFramebuffer();return e.bindFramebuffer(e.FRAMEBUFFER,n),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,i,0),e.checkFramebufferStatus(e.FRAMEBUFFER)!==e.FRAMEBUFFER_COMPLETE&&(s=!1),e.bindTexture(e.TEXTURE_2D,null),e.deleteTexture(i),e.bindFramebuffer(e.FRAMEBUFFER,null),e.deleteFramebuffer(n),s}class Fc extends Kl{constructor(e,t={}){super(e),this.gl=void 0,this.webgl2=void 0,this.deviceType="webgl",this.defaultFramebuffer=null,this.defaultFramebufferAlpha=t.alpha,this.updateClientRect(),this.contextLost=!1,this._contextLostHandler=e=>{e.preventDefault(),this.contextLost=!0,this.loseContext(),this.fire("devicelost")},this._contextRestoredHandler=()=>{this.restoreContext(),this.contextLost=!1,this.fire("devicerestored")},t.stencil=!0,t.powerPreference||(t.powerPreference="high-performance");const s="undefined"!=typeof navigator&&navigator.userAgent;this.forceDisableMultisampling=s&&s.includes("AppleWebKit")&&(s.includes("15.4")||s.includes("15_4")),this.forceDisableMultisampling&&(t.antialias=!1);const i=void 0===t.preferWebGl2||t.preferWebGl2?["webgl2","webgl","experimental-webgl"]:["webgl","experimental-webgl"];let n=null;for(let s=0;s<i.length;s++)if(n=e.getContext(i[s],t),n){this.webgl2="webgl2"===i[s];break}if(!n)throw new Error("WebGL not supported");const r=N.browser&&!!window.chrome,o=N.browser&&-1!==navigator.appVersion.indexOf("Mac");let h,l,c,d,u;this.gl=n,this._tempEnableSafariTextureUnitWorkaround=N.browser&&!!window.safari,this._tempMacChromeBlitFramebufferWorkaround=o&&r&&!t.alpha,this.webgl2||function(e){if(e.getSupportedExtensions){if(-1!=e.getSupportedExtensions().indexOf("OES_vertex_array_object"))return}else if(e.getExtension&&e.getExtension("OES_vertex_array_object"))return;if(e.getSupportedExtensions){var t=e.getSupportedExtensions;e.getSupportedExtensions=function(){var e=t.call(this)||[];return e.push("OES_vertex_array_object"),e}}var s=e.getExtension;e.getExtension=function(t){return"OES_vertex_array_object"==t?(e.__OESVertexArrayObject||(e.__OESVertexArrayObject=new a(e)),e.__OESVertexArrayObject):s?s.call(this,t):null}}(n),e.addEventListener("webglcontextlost",this._contextLostHandler,!1),e.addEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches(),this.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:3},this.glAddress=[n.REPEAT,n.CLAMP_TO_EDGE,n.MIRRORED_REPEAT],this.glBlendEquation=[n.FUNC_ADD,n.FUNC_SUBTRACT,n.FUNC_REVERSE_SUBTRACT,this.webgl2?n.MIN:this.extBlendMinmax?this.extBlendMinmax.MIN_EXT:n.FUNC_ADD,this.webgl2?n.MAX:this.extBlendMinmax?this.extBlendMinmax.MAX_EXT:n.FUNC_ADD],this.glBlendFunction=[n.ZERO,n.ONE,n.SRC_COLOR,n.ONE_MINUS_SRC_COLOR,n.DST_COLOR,n.ONE_MINUS_DST_COLOR,n.SRC_ALPHA,n.SRC_ALPHA_SATURATE,n.ONE_MINUS_SRC_ALPHA,n.DST_ALPHA,n.ONE_MINUS_DST_ALPHA,n.CONSTANT_COLOR,n.ONE_MINUS_CONSTANT_COLOR,n.CONSTANT_ALPHA,n.ONE_MINUS_CONSTANT_ALPHA],this.glComparison=[n.NEVER,n.LESS,n.EQUAL,n.LEQUAL,n.GREATER,n.NOTEQUAL,n.GEQUAL,n.ALWAYS],this.glStencilOp=[n.KEEP,n.ZERO,n.REPLACE,n.INCR,n.INCR_WRAP,n.DECR,n.DECR_WRAP,n.INVERT],this.glClearFlag=[0,n.COLOR_BUFFER_BIT,n.DEPTH_BUFFER_BIT,n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT,n.STENCIL_BUFFER_BIT,n.STENCIL_BUFFER_BIT|n.COLOR_BUFFER_BIT,n.STENCIL_BUFFER_BIT|n.DEPTH_BUFFER_BIT,n.STENCIL_BUFFER_BIT|n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT],this.glCull=[0,n.BACK,n.FRONT,n.FRONT_AND_BACK],this.glFilter=[n.NEAREST,n.LINEAR,n.NEAREST_MIPMAP_NEAREST,n.NEAREST_MIPMAP_LINEAR,n.LINEAR_MIPMAP_NEAREST,n.LINEAR_MIPMAP_LINEAR],this.glPrimitive=[n.POINTS,n.LINES,n.LINE_LOOP,n.LINE_STRIP,n.TRIANGLES,n.TRIANGLE_STRIP,n.TRIANGLE_FAN],this.glType=[n.BYTE,n.UNSIGNED_BYTE,n.SHORT,n.UNSIGNED_SHORT,n.INT,n.UNSIGNED_INT,n.FLOAT],this.pcUniformType={},this.pcUniformType[n.BOOL]=0,this.pcUniformType[n.INT]=1,this.pcUniformType[n.FLOAT]=2,this.pcUniformType[n.FLOAT_VEC2]=3,this.pcUniformType[n.FLOAT_VEC3]=4,this.pcUniformType[n.FLOAT_VEC4]=5,this.pcUniformType[n.INT_VEC2]=6,this.pcUniformType[n.INT_VEC3]=7,this.pcUniformType[n.INT_VEC4]=8,this.pcUniformType[n.BOOL_VEC2]=9,this.pcUniformType[n.BOOL_VEC3]=10,this.pcUniformType[n.BOOL_VEC4]=11,this.pcUniformType[n.FLOAT_MAT2]=12,this.pcUniformType[n.FLOAT_MAT3]=13,this.pcUniformType[n.FLOAT_MAT4]=14,this.pcUniformType[n.SAMPLER_2D]=15,this.pcUniformType[n.SAMPLER_CUBE]=16,this.webgl2&&(this.pcUniformType[n.SAMPLER_2D_SHADOW]=18,this.pcUniformType[n.SAMPLER_CUBE_SHADOW]=19,this.pcUniformType[n.SAMPLER_3D]=20),this.targetToSlot={},this.targetToSlot[n.TEXTURE_2D]=0,this.targetToSlot[n.TEXTURE_CUBE_MAP]=1,this.targetToSlot[n.TEXTURE_3D]=2,this.commitFunction=[],this.commitFunction[0]=function(e,t){e.value!==t&&(n.uniform1i(e.locationId,t),e.value=t)},this.commitFunction[1]=this.commitFunction[0],this.commitFunction[2]=function(e,t){e.value!==t&&(n.uniform1f(e.locationId,t),e.value=t)},this.commitFunction[3]=function(e,t){u=e.value,h=t[0],l=t[1],u[0]===h&&u[1]===l||(n.uniform2fv(e.locationId,t),u[0]=h,u[1]=l)},this.commitFunction[4]=function(e,t){u=e.value,h=t[0],l=t[1],c=t[2],u[0]===h&&u[1]===l&&u[2]===c||(n.uniform3fv(e.locationId,t),u[0]=h,u[1]=l,u[2]=c)},this.commitFunction[5]=function(e,t){u=e.value,h=t[0],l=t[1],c=t[2],d=t[3],u[0]===h&&u[1]===l&&u[2]===c&&u[3]===d||(n.uniform4fv(e.locationId,t),u[0]=h,u[1]=l,u[2]=c,u[3]=d)},this.commitFunction[6]=function(e,t){u=e.value,h=t[0],l=t[1],u[0]===h&&u[1]===l||(n.uniform2iv(e.locationId,t),u[0]=h,u[1]=l)},this.commitFunction[9]=this.commitFunction[6],this.commitFunction[7]=function(e,t){u=e.value,h=t[0],l=t[1],c=t[2],u[0]===h&&u[1]===l&&u[2]===c||(n.uniform3iv(e.locationId,t),u[0]=h,u[1]=l,u[2]=c)},this.commitFunction[10]=this.commitFunction[7],this.commitFunction[8]=function(e,t){u=e.value,h=t[0],l=t[1],c=t[2],d=t[3],u[0]===h&&u[1]===l&&u[2]===c&&u[3]===d||(n.uniform4iv(e.locationId,t),u[0]=h,u[1]=l,u[2]=c,u[3]=d)},this.commitFunction[11]=this.commitFunction[8],this.commitFunction[12]=function(e,t){n.uniformMatrix2fv(e.locationId,!1,t)},this.commitFunction[13]=function(e,t){n.uniformMatrix3fv(e.locationId,!1,t)},this.commitFunction[14]=function(e,t){n.uniformMatrix4fv(e.locationId,!1,t)},this.commitFunction[17]=function(e,t){n.uniform1fv(e.locationId,t)},this.commitFunction[21]=function(e,t){n.uniform2fv(e.locationId,t)},this.commitFunction[22]=function(e,t){n.uniform3fv(e.locationId,t)},this.commitFunction[23]=function(e,t){n.uniform4fv(e.locationId,t)},this.supportsBoneTextures=this.extTextureFloat&&this.maxVertexTextures>0;let p=this.vertexUniformsCount;p-=16,p-=8,p-=1,p-=16,this.boneLimit=Math.floor(p/3),this.boneLimit=Math.min(this.boneLimit,128),"Mali-450 MP"===this.unmaskedRenderer&&(this.boneLimit=34),this.constantTexSource=this.scope.resolve("source"),this.extTextureFloat?this.webgl2?this.textureFloatRenderable=!!this.extColorBufferFloat:this.textureFloatRenderable=Oc(n,n.FLOAT):this.textureFloatRenderable=!1,this.extColorBufferHalfFloat?this.textureHalfFloatRenderable=!!this.extColorBufferHalfFloat:this.extTextureHalfFloat?this.webgl2?this.textureHalfFloatRenderable=!!this.extColorBufferFloat:this.textureHalfFloatRenderable=Oc(n,this.extTextureHalfFloat.HALF_FLOAT_OES):this.textureHalfFloatRenderable=!1,this.supportsMorphTargetTexturesCore="highp"===this.maxPrecision&&this.maxVertexTextures>=2,this._textureFloatHighPrecision=void 0,this._textureHalfFloatUpdatable=void 0,this.areaLightLutFormat=7,this.extTextureHalfFloat&&this.textureHalfFloatUpdatable&&this.extTextureHalfFloatLinear?this.areaLightLutFormat=12:this.extTextureFloat&&this.extTextureFloatLinear&&(this.areaLightLutFormat=14)}destroy(){super.destroy();const e=this.gl;this.webgl2&&this.feedback&&e.deleteTransformFeedback(this.feedback),this.clearShaderCache(),this.clearVertexArrayObjectCache(),this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,!1),this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this._contextLostHandler=null,this._contextRestoredHandler=null,this.gl=null,super.postDestroy()}createVertexBufferImpl(e,t){return new Cc}createIndexBufferImpl(e){return new Ac(e)}createShaderImpl(e){return new Ec(e)}createTextureImpl(e){return new Lc}createRenderTargetImpl(e){return new Ic}getPrecision(){const e=this.gl;let t="highp";if(e.getShaderPrecisionFormat){const s=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT),i=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT),n=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT),a=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT),r=s.precision>0&&n.precision>0,o=i.precision>0&&a.precision>0;r||(t=o?"mediump":"lowp")}return t}initializeExtensions(){const e=this.gl,t=e.getSupportedExtensions(),s=function(){for(let s=0;s<arguments.length;s++)if(-1!==t.indexOf(arguments[s]))return e.getExtension(arguments[s]);return null};if(this.webgl2)this.extBlendMinmax=!0,this.extDrawBuffers=!0,this.extInstancing=!0,this.extStandardDerivatives=!0,this.extTextureFloat=!0,this.extTextureHalfFloat=!0,this.extTextureLod=!0,this.extUintElement=!0,this.extVertexArrayObject=!0,this.extColorBufferFloat=s("EXT_color_buffer_float"),this.extDisjointTimerQuery=s("EXT_disjoint_timer_query_webgl2","EXT_disjoint_timer_query"),this.extDepthTexture=!0;else{if(this.extBlendMinmax=s("EXT_blend_minmax"),this.extDrawBuffers=s("EXT_draw_buffers"),this.extInstancing=s("ANGLE_instanced_arrays"),this.extInstancing){const t=this.extInstancing;e.drawArraysInstanced=t.drawArraysInstancedANGLE.bind(t),e.drawElementsInstanced=t.drawElementsInstancedANGLE.bind(t),e.vertexAttribDivisor=t.vertexAttribDivisorANGLE.bind(t)}if(this.extStandardDerivatives=s("OES_standard_derivatives"),this.extTextureFloat=s("OES_texture_float"),this.extTextureHalfFloat=s("OES_texture_half_float"),this.extTextureLod=s("EXT_shader_texture_lod"),this.extUintElement=s("OES_element_index_uint"),this.extVertexArrayObject=s("OES_vertex_array_object"),this.extVertexArrayObject){const t=this.extVertexArrayObject;e.createVertexArray=t.createVertexArrayOES.bind(t),e.deleteVertexArray=t.deleteVertexArrayOES.bind(t),e.isVertexArray=t.isVertexArrayOES.bind(t),e.bindVertexArray=t.bindVertexArrayOES.bind(t)}this.extColorBufferFloat=null,this.extDisjointTimerQuery=null,this.extDepthTexture=e.getExtension("WEBGL_depth_texture")}this.extDebugRendererInfo=s("WEBGL_debug_renderer_info"),this.extTextureFloatLinear=s("OES_texture_float_linear"),this.extTextureHalfFloatLinear=s("OES_texture_half_float_linear"),this.extFloatBlend=s("EXT_float_blend"),this.extTextureFilterAnisotropic=s("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic"),this.extCompressedTextureETC1=s("WEBGL_compressed_texture_etc1"),this.extCompressedTextureETC=s("WEBGL_compressed_texture_etc"),this.extCompressedTexturePVRTC=s("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"),this.extCompressedTextureS3TC=s("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"),this.extCompressedTextureATC=s("WEBGL_compressed_texture_atc"),this.extCompressedTextureASTC=s("WEBGL_compressed_texture_astc"),this.extParallelShaderCompile=s("KHR_parallel_shader_compile"),this.extColorBufferHalfFloat=s("EXT_color_buffer_half_float")}initializeCapabilities(){const e=this.gl;let t;const s="undefined"!=typeof navigator?navigator.userAgent:"";this.maxPrecision=this.precision=this.getPrecision();const i=e.getContextAttributes();this.supportsMsaa=i.antialias,this.supportsStencil=i.stencil,this.supportsInstancing=!!this.extInstancing,this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.maxCubeMapSize=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxRenderBufferSize=e.getParameter(e.MAX_RENDERBUFFER_SIZE),this.maxTextures=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this.maxCombinedTextures=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.vertexUniformsCount=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this.fragmentUniformsCount=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),this.webgl2?(this.maxDrawBuffers=e.getParameter(e.MAX_DRAW_BUFFERS),this.maxColorAttachments=e.getParameter(e.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=e.getParameter(e.MAX_3D_TEXTURE_SIZE)):(t=this.extDrawBuffers,this.maxDrawBuffers=t?e.getParameter(t.MAX_DRAW_BUFFERS_EXT):1,this.maxColorAttachments=t?e.getParameter(t.MAX_COLOR_ATTACHMENTS_EXT):1,this.maxVolumeSize=1),t=this.extDebugRendererInfo,this.unmaskedRenderer=t?e.getParameter(t.UNMASKED_RENDERER_WEBGL):"",this.unmaskedVendor=t?e.getParameter(t.UNMASKED_VENDOR_WEBGL):"";this.supportsGpuParticles=!("ARM"===this.unmaskedVendor&&s.match(/SM-[a-zA-Z0-9]+/)),t=this.extTextureFilterAnisotropic,this.maxAnisotropy=t?e.getParameter(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1,this.samples=e.getParameter(e.SAMPLES),this.maxSamples=this.webgl2&&!this.forceDisableMultisampling?e.getParameter(e.MAX_SAMPLES):1,this.supportsAreaLights=this.webgl2||!N.android,this.maxTextures<=8&&(this.supportsAreaLights=!1)}initializeRenderState(){const e=this.gl;this.blending=!1,e.disable(e.BLEND),this.blendSrc=1,this.blendDst=0,this.blendSrcAlpha=1,this.blendDstAlpha=0,this.separateAlphaBlend=!1,this.blendEquation=0,this.blendAlphaEquation=0,this.separateAlphaEquation=!1,e.blendFunc(e.ONE,e.ZERO),e.blendEquation(e.FUNC_ADD),this.blendColor=new pe(0,0,0,0),e.blendColor(0,0,0,0),this.writeRed=!0,this.writeGreen=!0,this.writeBlue=!0,this.writeAlpha=!0,e.colorMask(!0,!0,!0,!0),this.cullMode=1,e.enable(e.CULL_FACE),e.cullFace(e.BACK),this.depthTest=!0,e.enable(e.DEPTH_TEST),this.depthFunc=3,e.depthFunc(e.LEQUAL),this.depthWrite=!0,e.depthMask(!0),this.stencil=!1,e.disable(e.STENCIL_TEST),this.stencilFuncFront=this.stencilFuncBack=7,this.stencilRefFront=this.stencilRefBack=0,this.stencilMaskFront=this.stencilMaskBack=255,e.stencilFunc(e.ALWAYS,0,255),this.stencilFailFront=this.stencilFailBack=0,this.stencilZfailFront=this.stencilZfailBack=0,this.stencilZpassFront=this.stencilZpassBack=0,this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255,e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.stencilMask(255),this.alphaToCoverage=!1,this.raster=!0,this.webgl2&&(e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.RASTERIZER_DISCARD)),this.depthBiasEnabled=!1,e.disable(e.POLYGON_OFFSET_FILL),this.clearDepth=1,e.clearDepth(1),this.clearColor=new pe(0,0,0,0),e.clearColor(0,0,0,0),this.clearStencil=0,e.clearStencil(0),this.vx=this.vy=this.vw=this.vh=0,this.sx=this.sy=this.sw=this.sh=0,this.webgl2?e.hint(e.FRAGMENT_SHADER_DERIVATIVE_HINT,e.NICEST):this.extStandardDerivatives&&e.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,e.NICEST),e.enable(e.SCISSOR_TEST),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.NONE),this.unpackFlipY=!1,e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),this.unpackPremultiplyAlpha=!1,e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),e.pixelStorei(e.UNPACK_ALIGNMENT,1)}initializeContextCaches(){super.initializeContextCaches(),this.vertexShaderCache={},this.fragmentShaderCache={},this._vaoMap=new Map,this.boundVao=null,this.activeFramebuffer=null,this.feedback=null,this.transformFeedbackBuffer=null,this.textureUnit=0,this.textureUnits=[];for(let e=0;e<this.maxCombinedTextures;e++)this.textureUnits.push([null,null,null])}loseContext(){for(const e of this.shaders)e.loseContext();for(const e of this.textures)e.loseContext();for(const e of this.buffers)e.loseContext();for(const e of this.targets)e.loseContext()}restoreContext(){this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches();for(const e of this.shaders)e.restoreContext();for(const e of this.buffers)e.unlock()}setViewport(e,t,s,i){this.vx===e&&this.vy===t&&this.vw===s&&this.vh===i||(this.gl.viewport(e,t,s,i),this.vx=e,this.vy=t,this.vw=s,this.vh=i)}setScissor(e,t,s,i){this.sx===e&&this.sy===t&&this.sw===s&&this.sh===i||(this.gl.scissor(e,t,s,i),this.sx=e,this.sy=t,this.sw=s,this.sh=i)}setFramebuffer(e){if(this.activeFramebuffer!==e){const t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,e),this.activeFramebuffer=e}}copyRenderTarget(e,t,s,i){const n=this.gl;if(!this.webgl2&&i)return!1;if(s)if(t){if(e){if(!e._colorBuffer||!t._colorBuffer)return!1;if(e._colorBuffer._format!==t._colorBuffer._format)return!1}}else if(!e._colorBuffer)return!1;if(i&&e&&!e._depth){if(!e._depthBuffer||!t._depthBuffer)return!1;if(e._depthBuffer._format!==t._depthBuffer._format)return!1}if(this.webgl2&&t){const a=this.renderTarget;this.renderTarget=t,this.updateBegin(),n.bindFramebuffer(n.READ_FRAMEBUFFER,e?e.impl._glFrameBuffer:null),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,t.impl._glFrameBuffer);const r=e?e.width:t.width,o=e?e.height:t.height;n.blitFramebuffer(0,0,r,o,0,0,r,o,(s?n.COLOR_BUFFER_BIT:0)|(i?n.DEPTH_BUFFER_BIT:0),n.NEAREST),this.renderTarget=a,n.bindFramebuffer(n.FRAMEBUFFER,a?a.impl._glFrameBuffer:null)}else{const s=this.getCopyShader();this.constantTexSource.setValue(e._colorBuffer),bo(this,t,s)}return!0}getCopyShader(){if(!this._copyShader){const e=Bo.fullscreenQuadVS,t=Bo.outputTex2DPS;this._copyShader=eh(this,e,t,"outputTex2D")}return this._copyShader}startPass(e){this.setRenderTarget(e.renderTarget),this.updateBegin();const t=e.colorOps,s=e.depthStencilOps;if(t.clear||s.clearDepth||s.clearStencil){const i=e.renderTarget,n=i?i.width:this.width,a=i?i.height:this.height;this.setViewport(0,0,n,a),this.setScissor(0,0,n,a);let r=0;const o={};t.clear&&(r|=1,o.color=[t.clearValue.r,t.clearValue.g,t.clearValue.b,t.clearValue.a]),s.clearDepth&&(r|=2,o.depth=s.clearDepthValue),s.clearStencil&&(r|=4,o.stencil=s.clearStencilValue),o.flags=r,this.clear(o)}this.insideRenderPass=!0}endPass(e){this.unbindVertexArray();const t=this.renderTarget;if(t){if(this.webgl2){Dc.length=0;const t=this.gl;e.colorOps.store||e.colorOps.resolve||Dc.push(t.COLOR_ATTACHMENT0),e.depthStencilOps.storeDepth||Dc.push(t.DEPTH_ATTACHMENT),e.depthStencilOps.storeStencil||Dc.push(t.STENCIL_ATTACHMENT),Dc.length>0&&e.fullSizeClearRect&&t.invalidateFramebuffer(t.DRAW_FRAMEBUFFER,Dc)}if(e.colorOps.resolve&&this.webgl2&&e.samples>1&&t.autoResolve&&t.resolve(!0,!1),e.colorOps.mipmaps){const e=t._colorBuffer;e&&e.impl._glTexture&&e.mipmaps&&(e.pot||this.webgl2)&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(e),this.gl.generateMipmap(e.impl._glTarget))}}this.insideRenderPass=!1}updateBegin(){if(this.boundVao=null,this._tempEnableSafariTextureUnitWorkaround)for(let e=0;e<this.textureUnits.length;++e)for(let t=0;t<3;++t)this.textureUnits[e][t]=null;const e=this.renderTarget;e?e.impl.initialized?this.setFramebuffer(e.impl._glFrameBuffer):this.initRenderTarget(e):this.setFramebuffer(this.defaultFramebuffer)}updateEnd(){this.unbindVertexArray();const e=this.renderTarget;if(e){const t=e._colorBuffer;t&&t.impl._glTexture&&t.mipmaps&&(t.pot||this.webgl2)&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(t),this.gl.generateMipmap(t.impl._glTarget)),this.webgl2&&e._samples>1&&e.autoResolve&&e.resolve()}}setUnpackFlipY(e){if(this.unpackFlipY!==e){this.unpackFlipY=e;const t=this.gl;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,e)}}setUnpackPremultiplyAlpha(e){if(this.unpackPremultiplyAlpha!==e){this.unpackPremultiplyAlpha=e;const t=this.gl;t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e)}}activeTexture(e){this.textureUnit!==e&&(this.gl.activeTexture(this.gl.TEXTURE0+e),this.textureUnit=e)}bindTexture(e){const t=e.impl,s=t._glTarget,i=t._glTexture,n=this.textureUnit,a=this.targetToSlot[s];this.textureUnits[n][a]!==i&&(this.gl.bindTexture(s,i),this.textureUnits[n][a]=i)}bindTextureOnUnit(e,t){const s=e.impl,i=s._glTarget,n=s._glTexture,a=this.targetToSlot[i];this.textureUnits[t][a]!==n&&(this.activeTexture(t),this.gl.bindTexture(i,n),this.textureUnits[t][a]=n)}setTextureParameters(e){const t=this.gl,s=e._parameterFlags,i=e.impl._glTarget;if(1&s){let s=e._minFilter;(!e.pot&&!this.webgl2||!e._mipmaps||e._compressed&&1===e._levels.length)&&(2===s||3===s?s=0:4!==s&&5!==s||(s=1)),t.texParameteri(i,t.TEXTURE_MIN_FILTER,this.glFilter[s])}if(2&s&&t.texParameteri(i,t.TEXTURE_MAG_FILTER,this.glFilter[e._magFilter]),4&s&&(this.webgl2?t.texParameteri(i,t.TEXTURE_WRAP_S,this.glAddress[e._addressU]):t.texParameteri(i,t.TEXTURE_WRAP_S,this.glAddress[e.pot?e._addressU:1])),8&s&&(this.webgl2?t.texParameteri(i,t.TEXTURE_WRAP_T,this.glAddress[e._addressV]):t.texParameteri(i,t.TEXTURE_WRAP_T,this.glAddress[e.pot?e._addressV:1])),16&s&&this.webgl2&&t.texParameteri(i,t.TEXTURE_WRAP_R,this.glAddress[e._addressW]),32&s&&this.webgl2&&t.texParameteri(i,t.TEXTURE_COMPARE_MODE,e._compareOnRead?t.COMPARE_REF_TO_TEXTURE:t.NONE),64&s&&this.webgl2&&t.texParameteri(i,t.TEXTURE_COMPARE_FUNC,this.glComparison[e._compareFunc]),128&s){const s=this.extTextureFilterAnisotropic;s&&t.texParameterf(i,s.TEXTURE_MAX_ANISOTROPY_EXT,Math.max(1,Math.min(Math.round(e._anisotropy),this.maxAnisotropy)))}}setTexture(e,t){e.impl._glTexture||e.impl.initialize(this,e),e._parameterFlags>0||e._needsUpload||e._needsMipmapsUpload?(this.activeTexture(t),this.bindTexture(e),e._parameterFlags&&(this.setTextureParameters(e),e._parameterFlags=0),(e._needsUpload||e._needsMipmapsUpload)&&(e.impl.upload(this,e),e._needsUpload=!1,e._needsMipmapsUpload=!1)):this.bindTextureOnUnit(e,t)}createVertexArray(e){let t,s;const i=e.length>1;if(i){t="";for(let s=0;s<e.length;s++){const i=e[s];t+=i.id+i.format.renderingingHash}s=this._vaoMap.get(t)}if(!s){const n=this.gl;s=n.createVertexArray(),n.bindVertexArray(s),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null);for(let t=0;t<e.length;t++){const s=e[t];n.bindBuffer(n.ARRAY_BUFFER,s.impl.bufferId);const i=s.format.elements;for(let e=0;e<i.length;e++){const t=i[e],a=lo[t.name];n.vertexAttribPointer(a,t.numComponents,this.glType[t.dataType],t.normalize,t.stride,t.offset),n.enableVertexAttribArray(a),s.instancing&&n.vertexAttribDivisor(a,1)}}n.bindVertexArray(null),n.bindBuffer(n.ARRAY_BUFFER,null),i&&this._vaoMap.set(t,s)}return s}unbindVertexArray(){this.boundVao&&(this.boundVao=null,this.gl.bindVertexArray(null))}setBuffers(){const e=this.gl;let t;if(1===this.vertexBuffers.length){const e=this.vertexBuffers[0];e.impl.vao||(e.impl.vao=this.createVertexArray(this.vertexBuffers)),t=e.impl.vao}else t=this.createVertexArray(this.vertexBuffers);this.boundVao!==t&&(this.boundVao=t,e.bindVertexArray(t)),this.vertexBuffers.length=0;const s=this.indexBuffer?this.indexBuffer.impl.bufferId:null;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,s)}draw(e,t,s){const i=this.gl;let n,a,r,o,h,l,c,d;const u=this.shader;if(!u)return;const p=u.impl.samplers,m=u.impl.uniforms;s||this.setBuffers();let f=0;for(let e=0,t=p.length;e<t;e++)if(n=p[e],a=n.scopeId.value,a)if(a instanceof fh)r=a,this.setTexture(r,f),n.slot!==f&&(i.uniform1i(n.locationId,f),n.slot=f),f++;else{n.array.length=0,o=a.length;for(let e=0;e<o;e++)r=a[e],this.setTexture(r,f),n.array[e]=f,f++;i.uniform1iv(n.locationId,n.array)}for(let e=0,t=m.length;e<t;e++)h=m[e],l=h.scopeId,c=h.version,d=l.versionObject.version,c.globalId===d.globalId&&c.revision===d.revision||(c.globalId=d.globalId,c.revision=d.revision,null!==l.value&&this.commitFunction[h.dataType](h,l.value));this.webgl2&&this.transformFeedbackBuffer&&(i.bindBufferBase(i.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.impl.bufferId),i.beginTransformFeedback(i.POINTS));const _=this.glPrimitive[e.type],g=e.count;if(e.indexed){const s=this.indexBuffer,n=s.impl.glFormat,a=e.base*s.bytesPerIndex;t>0?i.drawElementsInstanced(_,g,n,a,t):i.drawElements(_,g,n,a)}else{const s=e.base;t>0?i.drawArraysInstanced(_,s,g,t):i.drawArrays(_,s,g)}this.webgl2&&this.transformFeedbackBuffer&&(i.endTransformFeedback(),i.bindBufferBase(i.TRANSFORM_FEEDBACK_BUFFER,0,null)),this._drawCallsPerFrame++}clear(e){const t=this.defaultClearOptions,s=void 0===(e=e||t).flags?t.flags:e.flags;if(0!==s){const i=this.gl;if(1&s){const s=void 0===e.color?t.color:e.color;this.setClearColor(s[0],s[1],s[2],s[3]),this.setColorWrite(!0,!0,!0,!0)}if(2&s){const s=void 0===e.depth?t.depth:e.depth;this.setClearDepth(s),this.setDepthWrite(!0)}if(4&s){const s=void 0===e.stencil?t.stencil:e.stencil;this.setClearStencil(s)}i.clear(this.glClearFlag[s])}}readPixels(e,t,s,i,n){const a=this.gl;a.readPixels(e,t,s,i,a.RGBA,a.UNSIGNED_BYTE,n)}setClearDepth(e){e!==this.clearDepth&&(this.gl.clearDepth(e),this.clearDepth=e)}setClearColor(e,t,s,i){const n=this.clearColor;e===n.r&&t===n.g&&s===n.b&&i===n.a||(this.gl.clearColor(e,t,s,i),this.clearColor.set(e,t,s,i))}setClearStencil(e){e!==this.clearStencil&&(this.gl.clearStencil(e),this.clearStencil=e)}getDepthTest(){return this.depthTest}setDepthTest(e){if(this.depthTest!==e){const t=this.gl;e?t.enable(t.DEPTH_TEST):t.disable(t.DEPTH_TEST),this.depthTest=e}}setDepthFunc(e){this.depthFunc!==e&&(this.gl.depthFunc(this.glComparison[e]),this.depthFunc=e)}getDepthWrite(){return this.depthWrite}setDepthWrite(e){this.depthWrite!==e&&(this.gl.depthMask(e),this.depthWrite=e)}setColorWrite(e,t,s,i){this.writeRed===e&&this.writeGreen===t&&this.writeBlue===s&&this.writeAlpha===i||(this.gl.colorMask(e,t,s,i),this.writeRed=e,this.writeGreen=t,this.writeBlue=s,this.writeAlpha=i)}setAlphaToCoverage(e){this.webgl2&&this.alphaToCoverage!==e&&(this.alphaToCoverage=e,e?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))}setTransformFeedbackBuffer(e){if(this.transformFeedbackBuffer!==e&&(this.transformFeedbackBuffer=e,this.webgl2)){const t=this.gl;e?(this.feedback||(this.feedback=t.createTransformFeedback()),t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,this.feedback)):t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,null)}}setRaster(e){this.raster!==e&&(this.raster=e,this.webgl2&&(e?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD)))}setDepthBias(e){this.depthBiasEnabled!==e&&(this.depthBiasEnabled=e,e?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL))}setDepthBiasValues(e,t){this.gl.polygonOffset(t,e)}getBlending(){return this.blending}setBlending(e){if(this.blending!==e){const t=this.gl;e?t.enable(t.BLEND):t.disable(t.BLEND),this.blending=e}}setStencilTest(e){if(this.stencil!==e){const t=this.gl;e?t.enable(t.STENCIL_TEST):t.disable(t.STENCIL_TEST),this.stencil=e}}setStencilFunc(e,t,s){if(this.stencilFuncFront!==e||this.stencilRefFront!==t||this.stencilMaskFront!==s||this.stencilFuncBack!==e||this.stencilRefBack!==t||this.stencilMaskBack!==s){this.gl.stencilFunc(this.glComparison[e],t,s),this.stencilFuncFront=this.stencilFuncBack=e,this.stencilRefFront=this.stencilRefBack=t,this.stencilMaskFront=this.stencilMaskBack=s}}setStencilFuncFront(e,t,s){if(this.stencilFuncFront!==e||this.stencilRefFront!==t||this.stencilMaskFront!==s){const i=this.gl;i.stencilFuncSeparate(i.FRONT,this.glComparison[e],t,s),this.stencilFuncFront=e,this.stencilRefFront=t,this.stencilMaskFront=s}}setStencilFuncBack(e,t,s){if(this.stencilFuncBack!==e||this.stencilRefBack!==t||this.stencilMaskBack!==s){const i=this.gl;i.stencilFuncSeparate(i.BACK,this.glComparison[e],t,s),this.stencilFuncBack=e,this.stencilRefBack=t,this.stencilMaskBack=s}}setStencilOperation(e,t,s,i){this.stencilFailFront===e&&this.stencilZfailFront===t&&this.stencilZpassFront===s&&this.stencilFailBack===e&&this.stencilZfailBack===t&&this.stencilZpassBack===s||(this.gl.stencilOp(this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[s]),this.stencilFailFront=this.stencilFailBack=e,this.stencilZfailFront=this.stencilZfailBack=t,this.stencilZpassFront=this.stencilZpassBack=s),this.stencilWriteMaskFront===i&&this.stencilWriteMaskBack===i||(this.gl.stencilMask(i),this.stencilWriteMaskFront=i,this.stencilWriteMaskBack=i)}setStencilOperationFront(e,t,s,i){this.stencilFailFront===e&&this.stencilZfailFront===t&&this.stencilZpassFront===s||(this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[s]),this.stencilFailFront=e,this.stencilZfailFront=t,this.stencilZpassFront=s),this.stencilWriteMaskFront!==i&&(this.gl.stencilMaskSeparate(this.gl.FRONT,i),this.stencilWriteMaskFront=i)}setStencilOperationBack(e,t,s,i){this.stencilFailBack===e&&this.stencilZfailBack===t&&this.stencilZpassBack===s||(this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[s]),this.stencilFailBack=e,this.stencilZfailBack=t,this.stencilZpassBack=s),this.stencilWriteMaskBack!==i&&(this.gl.stencilMaskSeparate(this.gl.BACK,i),this.stencilWriteMaskBack=i)}setBlendFunction(e,t){(this.blendSrc!==e||this.blendDst!==t||this.separateAlphaBlend)&&(this.gl.blendFunc(this.glBlendFunction[e],this.glBlendFunction[t]),this.blendSrc=e,this.blendDst=t,this.separateAlphaBlend=!1)}setBlendFunctionSeparate(e,t,s,i){this.blendSrc===e&&this.blendDst===t&&this.blendSrcAlpha===s&&this.blendDstAlpha===i&&this.separateAlphaBlend||(this.gl.blendFuncSeparate(this.glBlendFunction[e],this.glBlendFunction[t],this.glBlendFunction[s],this.glBlendFunction[i]),this.blendSrc=e,this.blendDst=t,this.blendSrcAlpha=s,this.blendDstAlpha=i,this.separateAlphaBlend=!0)}setBlendEquation(e){(this.blendEquation!==e||this.separateAlphaEquation)&&(this.gl.blendEquation(this.glBlendEquation[e]),this.blendEquation=e,this.separateAlphaEquation=!1)}setBlendEquationSeparate(e,t){this.blendEquation===e&&this.blendAlphaEquation===t&&this.separateAlphaEquation||(this.gl.blendEquationSeparate(this.glBlendEquation[e],this.glBlendEquation[t]),this.blendEquation=e,this.blendAlphaEquation=t,this.separateAlphaEquation=!0)}setBlendColor(e,t,s,i){const n=this.blendColor;e===n.r&&t===n.g&&s===n.b&&i===n.a||(this.gl.blendColor(e,t,s,i),n.set(e,t,s,i))}setCullMode(e){if(this.cullMode!==e){if(0===e)this.gl.disable(this.gl.CULL_FACE);else{0===this.cullMode&&this.gl.enable(this.gl.CULL_FACE);const t=this.glCull[e];this.cullFace!==t&&(this.gl.cullFace(t),this.cullFace=t)}this.cullMode=e}}getCullMode(){return this.cullMode}setShader(e){if(e!==this.shader){if(e.failed)return!1;if(!e.ready&&!e.impl.postLink(this,e))return e.failed=!0,!1;this.shader=e,this.gl.useProgram(e.impl.glProgram),this.attributesInvalidated=!0}return!0}getHdrFormat(){return this.textureHalfFloatRenderable?12:this.textureFloatRenderable?14:7}clearShaderCache(){const e=this.gl;for(const t in this.fragmentShaderCache)e.deleteShader(this.fragmentShaderCache[t]),delete this.fragmentShaderCache[t];for(const t in this.vertexShaderCache)e.deleteShader(this.vertexShaderCache[t]),delete this.vertexShaderCache[t];this.programLib.clearCache()}clearVertexArrayObjectCache(){const e=this.gl;this._vaoMap.forEach(((t,s,i)=>{e.deleteVertexArray(t)})),this._vaoMap.clear()}removeShaderFromCache(e){this.programLib.removeFromCache(e)}get width(){return this.gl.drawingBufferWidth||this.canvas.width}get height(){return this.gl.drawingBufferHeight||this.canvas.height}set fullscreen(e){if(e){this.gl.canvas.requestFullscreen()}else document.exitFullscreen()}get fullscreen(){return!!document.fullscreenElement}get textureFloatHighPrecision(){return void 0===this._textureFloatHighPrecision&&(this._textureFloatHighPrecision=function(e){if(!e.textureFloatRenderable)return!1;const t=eh(e,Bo.fullscreenQuadVS,Bo.precisionTestPS,"ptest1"),s=eh(e,Bo.fullscreenQuadVS,Bo.precisionTest2PS,"ptest2"),i={format:14,width:1,height:1,mipmaps:!1,minFilter:0,magFilter:0,name:"testFHP"},n=new fh(e,i),a=new Jl({colorBuffer:n,depth:!1});bo(e,a,t),i.format=7;const r=new fh(e,i),o=new Jl({colorBuffer:r,depth:!1});e.constantTexSource.setValue(n),bo(e,o,s);const h=e.activeFramebuffer;e.setFramebuffer(o.impl._glFrameBuffer);const l=new Uint8Array(4);e.readPixels(0,0,1,1,l),e.setFramebuffer(h);const c=l[0]/255/16777216+l[1]/255/65536+l[2]/255/256+l[3]/255;return n.destroy(),a.destroy(),r.destroy(),o.destroy(),0===c}(this)),this._textureFloatHighPrecision}get textureHalfFloatUpdatable(){return void 0===this._textureHalfFloatUpdatable&&(this.webgl2?this._textureHalfFloatUpdatable=!0:this._textureHalfFloatUpdatable=function(e,t){let s=!0;const i=e.createTexture();e.bindTexture(e.TEXTURE_2D,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const n=new Uint16Array(16);return e.texImage2D(e.TEXTURE_2D,0,e.RGBA,2,2,0,e.RGBA,t,n),e.getError()!==e.NO_ERROR&&(s=!1,console.log("Above error related to HALF_FLOAT_OES can be ignored, it was triggered by testing half float texture support")),e.bindTexture(e.TEXTURE_2D,null),e.deleteTexture(i),s}(this.gl,this.extTextureHalfFloat.HALF_FLOAT_OES)),this._textureHalfFloatUpdatable}}class kc{constructor(){this._refCount=0}incRefCount(){this._refCount++}decRefCount(){this._refCount--}get refCount(){return this._refCount}}let Bc;function zc(){return Bc}function Uc(e){Bc=e}let Vc=0;class Nc{constructor(){this.initDefaults()}initDefaults(){this.recreate=!1,this.verticesUsage=0,this.indicesUsage=0,this.maxVertices=0,this.maxIndices=0,this.vertexCount=0,this.indexCount=0,this.vertexStreamsUpdated=!1,this.indexStreamUpdated=!1,this.vertexStreamDictionary={},this.indices=null}_changeVertexCount(e,t){this.vertexCount||(this.vertexCount=e)}}Nc.DEFAULT_COMPONENTS_POSITION=3,Nc.DEFAULT_COMPONENTS_NORMAL=3,Nc.DEFAULT_COMPONENTS_UV=2,Nc.DEFAULT_COMPONENTS_COLORS=4;class Gc{constructor(e,t,s,i){this.data=e,this.componentCount=t,this.dataType=s,this.dataTypeNormalize=i}}class Wc extends kc{constructor(e){super(),this.id=Vc++,this.device=e||zc().graphicsDevice,this.vertexBuffer=null,this.indexBuffer=[null],this.primitive=[{type:0,base:0,count:0}],this.skin=null,this._morph=null,this._geometryData=null,this._aabb=new De,this.boneAabb=null}set morph(e){e!==this._morph&&(this._morph&&this._morph.decRefCount(),this._morph=e,e&&e.incRefCount())}get morph(){return this._morph}set aabb(e){this._aabb=e}get aabb(){return this._aabb}destroy(){const e=this.morph;e&&(this.morph=null,e.refCount<1&&e.destroy()),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);for(let e=0;e<this.indexBuffer.length;e++)this._destroyIndexBuffer(e);this.indexBuffer.length=0,this._geometryData=null}_destroyIndexBuffer(e){this.indexBuffer[e]&&(this.indexBuffer[e].destroy(),this.indexBuffer[e]=null)}_initBoneAabbs(e){let t,s,i,n,a;this.boneAabb=[],this.boneUsed=[];const r=[],o=[],h=this.boneUsed,l=this.skin.boneNames.length;let c,d,u;for(let e=0;e<l;e++)r[e]=new ge(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o[e]=new ge(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);const p=new vc(this.vertexBuffer),m=p.element.POSITION,f=p.element.BLENDWEIGHT,_=p.element.BLENDINDICES,g=this.vertexBuffer.numVertices;for(let l=0;l<g;l++){for(let p=0;p<4;p++){if(f.array[f.index+p]>0){const f=_.array[_.index+p];if(h[f]=!0,t=m.array[m.index],s=m.array[m.index+1],i=m.array[m.index+2],n=o[f],a=r[f],a.x>t&&(a.x=t),a.y>s&&(a.y=s),a.z>i&&(a.z=i),n.x<t&&(n.x=t),n.y<s&&(n.y=s),n.z<i&&(n.z=i),e){let r=c=t,o=d=s,h=u=i;for(let t=0;t<e.length;t++){const s=e[t],i=s.deltaPositions[3*l],n=s.deltaPositions[3*l+1],a=s.deltaPositions[3*l+2];i<0?r+=i:c+=i,n<0?o+=n:d+=n,a<0?h+=a:u+=a}a.x>r&&(a.x=r),a.y>o&&(a.y=o),a.z>h&&(a.z=h),n.x<c&&(n.x=c),n.y<d&&(n.y=d),n.z<u&&(n.z=u)}}}p.next()}const y=this.vertexBuffer.getFormat().elements.find((e=>"POSITION"===e.name));if(y&&y.normalize){const e=(()=>{switch(y.dataType){case 0:return e=>Math.max(e/127,-1);case 1:return e=>e/255;case 2:return e=>Math.max(e/32767,-1);case 3:return e=>e/65535;default:return e=>e}})();for(let t=0;t<l;t++)if(h[t]){const s=r[t],i=o[t];s.set(e(s.x),e(s.y),e(s.z)),i.set(e(i.x),e(i.y),e(i.z))}}for(let e=0;e<l;e++){const t=new De;t.setMinMax(r[e],o[e]),this.boneAabb.push(t)}}_initGeometryData(){this._geometryData||(this._geometryData=new Nc,this.vertexBuffer&&(this._geometryData.vertexCount=this.vertexBuffer.numVertices,this._geometryData.maxVertices=this.vertexBuffer.numVertices),this.indexBuffer.length>0&&this.indexBuffer[0]&&(this._geometryData.indexCount=this.indexBuffer[0].numIndices,this._geometryData.maxIndices=this.indexBuffer[0].numIndices))}clear(e,t,s=0,i=0){this._initGeometryData(),this._geometryData.initDefaults(),this._geometryData.recreate=!0,this._geometryData.maxVertices=s,this._geometryData.maxIndices=i,this._geometryData.verticesUsage=e?0:1,this._geometryData.indicesUsage=t?0:1}setVertexStream(e,t,s,i,n=6,a=!1){this._initGeometryData();const r=i||t.length/s;this._geometryData._changeVertexCount(r,e),this._geometryData.vertexStreamsUpdated=!0,this._geometryData.vertexStreamDictionary[e]=new Gc(t,s,n,a)}getVertexStream(e,t){let s=0,i=!1;if(this._geometryData){const n=this._geometryData.vertexStreamDictionary[e];n&&(i=!0,s=this._geometryData.vertexCount,ArrayBuffer.isView(t)?t.set(n.data):(t.length=0,t.push(n.data)))}if(!i&&this.vertexBuffer){s=new vc(this.vertexBuffer).readData(e,t)}return s}setPositions(e,t=Nc.DEFAULT_COMPONENTS_POSITION,s){this.setVertexStream("POSITION",e,t,s,6,!1)}setNormals(e,t=Nc.DEFAULT_COMPONENTS_NORMAL,s){this.setVertexStream("NORMAL",e,t,s,6,!1)}setUvs(e,t,s=Nc.DEFAULT_COMPONENTS_UV,i){this.setVertexStream("TEXCOORD"+e,t,s,i,6,!1)}setColors(e,t=Nc.DEFAULT_COMPONENTS_COLORS,s){this.setVertexStream("COLOR",e,t,s,6,!1)}setColors32(e,t){this.setVertexStream("COLOR",e,Nc.DEFAULT_COMPONENTS_COLORS,t,1,!0)}setIndices(e,t){this._initGeometryData(),this._geometryData.indexStreamUpdated=!0,this._geometryData.indices=e,this._geometryData.indexCount=t||e.length}getPositions(e){return this.getVertexStream("POSITION",e)}getNormals(e){return this.getVertexStream("NORMAL",e)}getUvs(e,t){return this.getVertexStream("TEXCOORD"+e,t)}getColors(e){return this.getVertexStream("COLOR",e)}getIndices(e){let t=0;if(this._geometryData&&this._geometryData.indices){const s=this._geometryData.indices;t=this._geometryData.indexCount,ArrayBuffer.isView(e)?e.set(s):(e.length=0,e.push(s))}else if(this.indexBuffer.length>0&&this.indexBuffer[0]){t=this.indexBuffer[0].readData(e)}return t}update(e=4,t=!0){if(this._geometryData){if(t){const e=this._geometryData.vertexStreamDictionary.POSITION;e&&3===e.componentCount&&this._aabb.compute(e.data,this._geometryData.vertexCount)}let s=this._geometryData.recreate;this._geometryData.vertexCount>this._geometryData.maxVertices&&(s=!0,this._geometryData.maxVertices=this._geometryData.vertexCount),s&&this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);let i=this._geometryData.recreate;this._geometryData.indexCount>this._geometryData.maxIndices&&(i=!0,this._geometryData.maxIndices=this._geometryData.indexCount),i&&this.indexBuffer.length>0&&this.indexBuffer[0]&&(this.indexBuffer[0].destroy(),this.indexBuffer[0]=null),this._geometryData.vertexStreamsUpdated&&this._updateVertexBuffer(),this._geometryData.indexStreamUpdated&&this._updateIndexBuffer(),this.primitive[0].type=e,this.indexBuffer.length>0&&this.indexBuffer[0]?this._geometryData.indexStreamUpdated&&(this.primitive[0].count=this._geometryData.indexCount,this.primitive[0].indexed=!0):this._geometryData.vertexStreamsUpdated&&(this.primitive[0].count=this._geometryData.vertexCount,this.primitive[0].indexed=!1),this._geometryData.vertexCount=0,this._geometryData.indexCount=0,this._geometryData.vertexStreamsUpdated=!1,this._geometryData.indexStreamUpdated=!1,this._geometryData.recreate=!1,this.updateRenderStates()}}_buildVertexFormat(e){const t=[];for(const e in this._geometryData.vertexStreamDictionary){const s=this._geometryData.vertexStreamDictionary[e];t.push({semantic:e,components:s.componentCount,type:s.dataType,normalize:s.dataTypeNormalize})}return new go(this.device,t,e)}_updateVertexBuffer(){if(!this.vertexBuffer){const e=this._geometryData.maxVertices,t=this._buildVertexFormat(e);this.vertexBuffer=new fo(this.device,t,e,this._geometryData.verticesUsage)}const e=new vc(this.vertexBuffer),t=this._geometryData.vertexCount;for(const s in this._geometryData.vertexStreamDictionary){const i=this._geometryData.vertexStreamDictionary[s];e.writeData(s,i.data,t),delete this._geometryData.vertexStreamDictionary[s]}e.end()}_updateIndexBuffer(){if(this.indexBuffer.length<=0||!this.indexBuffer[0]){const e=this._geometryData.maxVertices>65535?2:1;this.indexBuffer[0]=new nc(this.device,e,this._geometryData.maxIndices,this._geometryData.indicesUsage)}const e=this._geometryData.indices;if(e){this.indexBuffer[0].writeData(e,this._geometryData.indexCount),this._geometryData.indices=null}}prepareRenderState(e){1===e?this.generateWireframe():2===e&&(this.primitive[2]={type:0,base:0,count:this.vertexBuffer?this.vertexBuffer.numVertices:0,indexed:!1})}updateRenderStates(){this.primitive[2]&&this.prepareRenderState(2),this.primitive[1]&&this.prepareRenderState(1)}generateWireframe(){this._destroyIndexBuffer(1);const e=[];let t;if(this.indexBuffer.length>0&&this.indexBuffer[0]){const s=[[0,1],[1,2],[2,0]],i=this.primitive[0].base,n=this.primitive[0].count,a=this.indexBuffer[0],r=new oo[a.format](a.storage),o={};for(let t=i;t<i+n;t+=3)for(let i=0;i<3;i++){const n=r[t+s[i][0]],a=r[t+s[i][1]],h=n>a?a<<16|n:n<<16|a;void 0===o[h]&&(o[h]=0,e.push(n,a))}t=a.format}else{for(let t=0;t<this.vertexBuffer.numVertices;t+=3)e.push(t,t+1,t+1,t+2,t+2,t);t=e.length>65535?2:1}const s=new nc(this.vertexBuffer.device,t,e.length);new oo[s.format](s.storage).set(e),s.unlock(),this.primitive[1]={type:1,base:0,count:e.length,indexed:!0},this.indexBuffer[1]=s}}const Hc=[];function Xc(e,t){const s=t.length/3,i=e.length/3,n=new ge,a=new ge,r=new ge,o=new ge,h=new ge,l=new ge,c=[];for(let t=0;t<e.length;t++)c[t]=0;for(let i=0;i<s;i++){const s=t[3*i],d=t[3*i+1],u=t[3*i+2];n.set(e[3*s],e[3*s+1],e[3*s+2]),a.set(e[3*d],e[3*d+1],e[3*d+2]),r.set(e[3*u],e[3*u+1],e[3*u+2]),o.sub2(a,n),h.sub2(r,n),l.cross(o,h).normalize(),c[3*s]+=l.x,c[3*s+1]+=l.y,c[3*s+2]+=l.z,c[3*d]+=l.x,c[3*d+1]+=l.y,c[3*d+2]+=l.z,c[3*u]+=l.x,c[3*u+1]+=l.y,c[3*u+2]+=l.z}for(let e=0;e<i;e++){const t=c[3*e],s=c[3*e+1],i=c[3*e+2],n=1/Math.sqrt(t*t+s*s+i*i);c[3*e]*=n,c[3*e+1]*=n,c[3*e+2]*=n}return c}function qc(e,t,s,i){const n=i.length/3,a=e.length/3,r=new ge,o=new ge,h=new ge,l=new ve,c=new ve,d=new ve,u=new ge,p=new ge,m=new Float32Array(3*a),f=new Float32Array(3*a),_=[];for(let t=0;t<n;t++){const n=i[3*t],a=i[3*t+1],_=i[3*t+2];r.set(e[3*n],e[3*n+1],e[3*n+2]),o.set(e[3*a],e[3*a+1],e[3*a+2]),h.set(e[3*_],e[3*_+1],e[3*_+2]),l.set(s[2*n],s[2*n+1]),c.set(s[2*a],s[2*a+1]),d.set(s[2*_],s[2*_+1]);const g=o.x-r.x,y=h.x-r.x,v=o.y-r.y,x=h.y-r.y,b=o.z-r.z,S=h.z-r.z,w=c.x-l.x,T=d.x-l.x,M=c.y-l.y,C=d.y-l.y,A=w*C-T*M;if(0===A)u.set(0,1,0),p.set(1,0,0);else{const e=1/A;u.set((C*g-M*y)*e,(C*v-M*x)*e,(C*b-M*S)*e),p.set((w*y-T*g)*e,(w*x-T*v)*e,(w*S-T*b)*e)}m[3*n+0]+=u.x,m[3*n+1]+=u.y,m[3*n+2]+=u.z,m[3*a+0]+=u.x,m[3*a+1]+=u.y,m[3*a+2]+=u.z,m[3*_+0]+=u.x,m[3*_+1]+=u.y,m[3*_+2]+=u.z,f[3*n+0]+=p.x,f[3*n+1]+=p.y,f[3*n+2]+=p.z,f[3*a+0]+=p.x,f[3*a+1]+=p.y,f[3*a+2]+=p.z,f[3*_+0]+=p.x,f[3*_+1]+=p.y,f[3*_+2]+=p.z}const g=new ge,y=new ge,v=new ge,x=new ge;for(let e=0;e<a;e++){v.set(t[3*e],t[3*e+1],t[3*e+2]),g.set(m[3*e],m[3*e+1],m[3*e+2]),y.set(f[3*e],f[3*e+1],f[3*e+2]);const s=v.dot(g);x.copy(v).mulScalar(s),x.sub2(g,x).normalize(),_[4*e]=x.x,_[4*e+1]=x.y,_[4*e+2]=x.z,x.cross(v,g),_[4*e+3]=x.dot(y)<0?-1:1}return _}function jc(e,t,s){const i=new Wc(e);return i.setPositions(t),s&&(s.normals&&i.setNormals(s.normals),s.tangents&&i.setVertexStream("TANGENT",s.tangents,4),s.colors&&i.setColors32(s.colors),s.uvs&&i.setUvs(0,s.uvs),s.uvs1&&i.setUvs(1,s.uvs1),s.blendIndices&&i.setVertexStream("BLENDINDICES",s.blendIndices,4,s.blendIndices.length/4,1),s.blendWeights&&i.setVertexStream("BLENDWEIGHT",s.blendWeights,4),s.indices&&i.setIndices(s.indices)),i.update(),i}function Yc(e,t){const s=t&&void 0!==t.tubeRadius?t.tubeRadius:.2,i=t&&void 0!==t.ringRadius?t.ringRadius:.3,n=t&&void 0!==t.segments?t.segments:30,a=t&&void 0!==t.sides?t.sides:20,r=!(!t||void 0===t.calculateTangents)&&t.calculateTangents,o=[],h=[],l=[],c=[];for(let e=0;e<=a;e++)for(let t=0;t<=n;t++){const r=Math.cos(2*Math.PI*t/n)*(i+s*Math.cos(2*Math.PI*e/a)),d=Math.sin(2*Math.PI*e/a)*s,u=Math.sin(2*Math.PI*t/n)*(i+s*Math.cos(2*Math.PI*e/a)),p=Math.cos(2*Math.PI*t/n)*Math.cos(2*Math.PI*e/a),m=Math.sin(2*Math.PI*e/a),f=Math.sin(2*Math.PI*t/n)*Math.cos(2*Math.PI*e/a),_=e/a,g=1-t/n;if(o.push(r,d,u),h.push(p,m,f),l.push(_,1-g),e<a&&t<n){const s=e*(n+1)+t,i=(e+1)*(n+1)+t,a=e*(n+1)+(t+1),r=(e+1)*(n+1)+(t+1);c.push(s,i,a),c.push(i,r,a)}}const d={normals:h,uvs:l,uvs1:l,indices:c};return r&&(d.tangents=qc(o,h,l,c)),jc(e,o,d)}function $c(e,t,s,i,n,a){const r=new ge,o=new ge,h=new ge,l=new ge,c=new ge,d=new ge,u=[],p=[],m=[],f=[],_=[];let g;if(s>0)for(let a=0;a<=i;a++)for(let g=0;g<=n;g++){const y=g/n*2*Math.PI-Math.PI,v=Math.sin(y),x=Math.cos(y);c.set(v*e,-s/2,x*e),l.set(v*t,s/2,x*t),r.lerp(c,l,a/i),o.sub2(l,c).normalize(),d.set(x,0,-v),h.cross(d,o).normalize(),u.push(r.x,r.y,r.z),p.push(h.x,h.y,h.z);let b=g/n,S=a/i;m.push(b,1-S);const w=S;if(S=b,b=w,b=.875*b+.0625,S=.875*S+.0625,b/=3,f.push(b,1-S),a<i&&g<n){const e=a*(n+1)+g,t=a*(n+1)+(g+1),s=(a+1)*(n+1)+g,i=(a+1)*(n+1)+(g+1);_.push(e,t,s),_.push(t,i,s)}}if(a){const e=Math.floor(n/2),a=n,r=s/2;for(let s=0;s<=e;s++){const i=s*Math.PI*.5/e,n=Math.sin(i),o=Math.cos(i);for(let i=0;i<=a;i++){const h=2*i*Math.PI/a-Math.PI/2,l=Math.sin(h),c=Math.cos(h)*n,d=o,_=l*n;let g=1-i/a,y=1-s/e;u.push(c*t,d*t+r,_*t),p.push(c,d,_),m.push(g,1-y),g=.875*g+.0625,y=.875*y+.0625,g/=3,y/=3,g+=1/3,f.push(g,1-y)}}g=(i+1)*(n+1);for(let t=0;t<e;++t)for(let e=0;e<a;++e){const s=t*(a+1)+e,i=s+a+1;_.push(g+s+1,g+i,g+s),_.push(g+s+1,g+i+1,g+i)}for(let s=0;s<=e;s++){const i=.5*Math.PI+s*Math.PI*.5/e,n=Math.sin(i),o=Math.cos(i);for(let i=0;i<=a;i++){const h=2*i*Math.PI/a-Math.PI/2,l=Math.sin(h),c=Math.cos(h)*n,d=o,_=l*n;let g=1-i/a,y=1-s/e;u.push(c*t,d*t-r,_*t),p.push(c,d,_),m.push(g,1-y),g=.875*g+.0625,y=.875*y+.0625,g/=3,y/=3,g+=2/3,f.push(g,1-y)}}g=(i+1)*(n+1)+(a+1)*(e+1);for(let t=0;t<e;++t)for(let e=0;e<a;++e){const s=t*(a+1)+e,i=s+a+1;_.push(g+s+1,g+i,g+s),_.push(g+s+1,g+i+1,g+i)}}else{if(g=(i+1)*(n+1),e>0)for(let t=0;t<n;t++){const i=t/n*2*Math.PI,a=Math.sin(i),r=-s/2,o=Math.cos(i);let h=1-(a+1)/2,l=(o+1)/2;u.push(a*e,r,o*e),p.push(0,-1,0),m.push(h,1-l),h=.875*h+.0625,l=.875*l+.0625,h/=3,l/=3,h+=1/3,f.push(h,1-l),t>1&&_.push(g,g+t,g+t-1)}if(g+=n,t>0)for(let e=0;e<n;e++){const i=e/n*2*Math.PI,a=Math.sin(i),r=s/2,o=Math.cos(i);let h=1-(a+1)/2,l=(o+1)/2;u.push(a*t,r,o*t),p.push(0,1,0),m.push(h,1-l),h=.875*h+.0625,l=.875*l+.0625,h/=3,l/=3,h+=2/3,f.push(h,1-l),e>1&&_.push(g,g+e-1,g+e)}}return{positions:u,normals:p,uvs:m,uvs1:f,indices:_}}function Kc(e,t){let s=t&&(t.radius||t.baseRadius);s=void 0!==s?s:.5;const i=t&&void 0!==t.height?t.height:1,n=t&&void 0!==t.heightSegments?t.heightSegments:5,a=t&&void 0!==t.capSegments?t.capSegments:20,r=!(!t||void 0===t.calculateTangents)&&t.calculateTangents,o=$c(s,s,i,n,a,!1);return r&&(o.tangents=qc(o.positions,o.normals,o.uvs,o.indices)),jc(e,o.positions,o)}function Zc(e,t){const s=t&&void 0!==t.radius?t.radius:.3,i=t&&void 0!==t.height?t.height:1,n=t&&void 0!==t.heightSegments?t.heightSegments:1,a=t&&void 0!==t.sides?t.sides:20,r=!(!t||void 0===t.calculateTangents)&&t.calculateTangents,o=$c(s,s,i-2*s,n,a,!0);return r&&(o.tangents=qc(o.positions,o.normals,o.uvs,o.indices)),jc(e,o.positions,o)}function Qc(e,t){const s=t&&void 0!==t.baseRadius?t.baseRadius:.5,i=t&&void 0!==t.peakRadius?t.peakRadius:0,n=t&&void 0!==t.height?t.height:1,a=t&&void 0!==t.heightSegments?t.heightSegments:5,r=t&&void 0!==t.capSegments?t.capSegments:18,o=!(!t||void 0===t.calculateTangents)&&t.calculateTangents,h=$c(s,i,n,a,r,!1);return o&&(h.tangents=qc(h.positions,h.normals,h.uvs,h.indices)),jc(e,h.positions,h)}function Jc(e,t){const s=t&&void 0!==t.radius?t.radius:.5,i=t&&void 0!==t.latitudeBands?t.latitudeBands:16,n=t&&void 0!==t.longitudeBands?t.longitudeBands:16,a=!(!t||void 0===t.calculateTangents)&&t.calculateTangents,r=[],o=[],h=[],l=[];for(let e=0;e<=i;e++){const t=e*Math.PI/i,a=Math.sin(t),l=Math.cos(t);for(let t=0;t<=n;t++){const c=2*t*Math.PI/n-Math.PI/2,d=Math.sin(c),u=Math.cos(c)*a,p=l,m=d*a,f=1-t/n,_=1-e/i;r.push(u*s,p*s,m*s),o.push(u,p,m),h.push(f,1-_)}}for(let e=0;e<i;++e)for(let t=0;t<n;++t){const s=e*(n+1)+t,i=s+n+1;l.push(s+1,i,s),l.push(s+1,i+1,i)}const c={normals:o,uvs:h,uvs1:h,indices:l};return a&&(c.tangents=qc(r,o,h,l)),jc(e,r,c)}function ed(e,t){const s=t&&void 0!==t.halfExtents?t.halfExtents:new ve(.5,.5),i=t&&void 0!==t.widthSegments?t.widthSegments:5,n=t&&void 0!==t.lengthSegments?t.lengthSegments:5,a=!(!t||void 0===t.calculateTangents)&&t.calculateTangents,r=[],o=[],h=[],l=[];let c=0;for(let e=0;e<=i;e++)for(let t=0;t<=n;t++){const a=-s.x+2*s.x*e/i,d=0,u=-(-s.y+2*s.y*t/n),p=e/i,m=t/n;r.push(a,d,u),o.push(0,1,0),h.push(p,1-m),e<i&&t<n&&(l.push(c+n+1,c+1,c),l.push(c+n+1,c+n+2,c+1)),c++}const d={normals:o,uvs:h,uvs1:h,indices:l};return a&&(d.tangents=qc(r,o,h,l)),jc(e,r,d)}function td(e,t){const s=t&&void 0!==t.halfExtents?t.halfExtents:new ge(.5,.5,.5),i=t&&void 0!==t.widthSegments?t.widthSegments:1,n=t&&void 0!==t.lengthSegments?t.lengthSegments:1,a=t&&void 0!==t.heightSegments?t.heightSegments:1,r=!(!t||void 0===t.calculateTangents)&&t.calculateTangents,o=[new ge(-s.x,-s.y,s.z),new ge(s.x,-s.y,s.z),new ge(s.x,s.y,s.z),new ge(-s.x,s.y,s.z),new ge(s.x,-s.y,-s.z),new ge(-s.x,-s.y,-s.z),new ge(-s.x,s.y,-s.z),new ge(s.x,s.y,-s.z)],h=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],l=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],c=1,d=2,u=3,p=4,m=5,f=[],_=[],g=[],y=[],v=[];let x=0;const b=(e,t,s)=>{const i=new ge,n=new ge,a=new ge,r=new ge;for(let c=0;c<=t;c++)for(let d=0;d<=s;d++){i.lerp(o[h[e][0]],o[h[e][1]],c/t),n.lerp(o[h[e][0]],o[h[e][2]],d/s),a.sub2(n,o[h[e][0]]),r.add2(i,a);let u=c/t,p=d/s;f.push(r.x,r.y,r.z),_.push(l[e][0],l[e][1],l[e][2]),g.push(u,1-p),u=.875*u+.0625,p=.875*p+.0625,u/=3,p/=3,u+=e%3/3,p+=Math.floor(e/3)/3,y.push(u,1-p),c<t&&d<s&&(v.push(x+s+1,x+1,x),v.push(x+s+1,x+s+2,x+1)),x++}};b(0,i,a),b(c,i,a),b(d,i,n),b(u,i,n),b(p,n,a),b(m,n,a);const S={normals:_,uvs:g,uvs1:y,indices:v};return r&&(S.tangents=qc(f,_,g,v)),jc(e,f,S)}function sd(e,t){let s=null;for(let i=0;i<Hc.length;i++)Hc[i].type===t&&Hc[i].device===e&&(s=Hc[i].primData);if(!s){let i,n;switch(t){case"box":i=td(e,{halfExtents:new ge(.5,.5,.5)}),n={x:2,y:2,z:2,uv:2/3};break;case"capsule":i=Zc(e,{radius:.5,height:2}),n={x:2*Math.PI,y:Math.PI,z:2*Math.PI,uv:1/3+1/3/3*2};break;case"cone":i=Qc(e,{baseRadius:.5,peakRadius:0,height:1}),n={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case"cylinder":i=Kc(e,{radius:.5,height:1}),n={x:Math.PI,y:1.58,z:Math.PI,uv:1/3+1/3/3*2};break;case"plane":i=ed(e,{halfExtents:new ve(.5,.5),widthSegments:1,lengthSegments:1}),n={x:0,y:1,z:0,uv:1};break;case"sphere":i=Jc(e,{radius:.5}),n={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;case"torus":i=Yc(e,{tubeRadius:.2,ringRadius:.3}),n={x:.5*Math.PI*.5-.1*Math.PI*.1,y:.4,z:.4,uv:1};break;default:throw new Error("Invalid primitive type: "+t)}i.incRefCount(),s={mesh:i,area:n},Hc.push({type:t,device:e,primData:s})}return s}const id={generateKey:function(e){let t="basic";return e.fog&&(t+="_fog"),e.alphaTest&&(t+="_atst"),e.vertexColors&&(t+="_vcol"),e.diffuseMap&&(t+="_diff"),e.skin&&(t+="_skin"),e.screenSpace&&(t+="_ss"),e.useInstancing&&(t+="_inst"),e.useMorphPosition&&(t+="_morphp"),e.useMorphNormal&&(t+="_morphn"),e.useMorphTextureBased&&(t+="_morpht"),t+="_"+e.pass,t},createShaderDefinition:function(e,t){const s={vertex_position:"POSITION"};t.skin&&(s.vertex_boneWeights="BLENDWEIGHT",s.vertex_boneIndices="BLENDINDICES"),t.vertexColors&&(s.vertex_color="COLOR"),t.diffuseMap&&(s.vertex_texCoord0="TEXCOORD0");let i=qo(e,"BasicShader",t.pass);i+=Bo.transformDeclVS,t.skin?(i+=Go(e),i+=Bo.transformSkinnedVS):i+=Bo.transformVS,t.vertexColors&&(i+="attribute vec4 vertex_color;\n",i+="varying vec4 vColor;\n"),t.diffuseMap&&(i+="attribute vec2 vertex_texCoord0;\n",i+="varying vec2 vUv0;\n"),2===t.pass&&(i+="varying float vDepth;\n",i+="#ifndef VIEWMATRIX\n",i+="#define VIEWMATRIX\n",i+="uniform mat4 matrix_view;\n",i+="#endif\n",i+="#ifndef CAMERAPLANES\n",i+="#define CAMERAPLANES\n",i+="uniform vec4 camera_params;\n\n",i+="#endif\n"),i+="void main(void)\n{\n",i+="   gl_Position = getPosition();\n",2===t.pass&&(i+="    vDepth = -(matrix_view * vec4(getWorldPosition(),1.0)).z * camera_params.x;\n"),t.vertexColors&&(i+="    vColor = vertex_color;\n"),t.diffuseMap&&(i+="    vUv0 = vertex_texCoord0;\n"),i+="}\n";const n=i;i=jo(e,"BasicMaterial",t.pass),t.vertexColors?i+="varying vec4 vColor;\n":i+="uniform vec4 uColor;\n",t.diffuseMap&&(i+="varying vec2 vUv0;\n",i+="uniform sampler2D texture_diffuseMap;\n"),t.fog&&(i+=No(t.fog)),t.alphaTest&&(i+=Bo.alphaTestPS),2===t.pass&&(i+="varying float vDepth;\n",i+=Bo.packDepthPS),i+="void main(void)\n{\n",t.vertexColors?i+="    gl_FragColor = vColor;\n":i+="    gl_FragColor = uColor;\n",t.diffuseMap&&(i+="    gl_FragColor *= texture2D(texture_diffuseMap, vUv0);\n"),t.alphaTest&&(i+="   alphaTest(gl_FragColor.a);\n"),3!==t.pass&&(2===t.pass?i+="    gl_FragColor = packFloat(vDepth);\n":t.fog&&(i+="   glFragColor.rgb = addFog(gl_FragColor.rgb);\n")),i+="}\n";return{attributes:s,vshader:n,fshader:i}}};class nd extends Al{constructor(){super(),this.color=new pe(1,1,1,1),this.colorUniform=new Float32Array(4),this.colorMap=null,this.vertexColors=!1}copy(e){return super.copy(e),this.color.copy(e.color),this.colorMap=e.colorMap,this.vertexColors=e.vertexColors,this}updateUniforms(e,t){this.clearParameters(),this.colorUniform[0]=this.color.r,this.colorUniform[1]=this.color.g,this.colorUniform[2]=this.color.b,this.colorUniform[3]=this.color.a,this.setParameter("uColor",this.colorUniform),this.colorMap&&this.setParameter("texture_diffuseMap",this.colorMap)}getShaderVariant(e,t,s,i,n,a,r,o){if(this.updateShader)return this.updateShader(e,t,s,i,n,a),this.shader;const h={skin:s&&0!=(2&s),screenSpace:s&&0!=(256&s),useInstancing:s&&0!=(32&s),useMorphPosition:s&&0!=(1024&s),useMorphNormal:s&&0!=(2048&s),useMorphTextureBased:s&&0!=(4096&s),alphaTest:this.alphaTest>0,vertexColors:this.vertexColors,diffuseMap:!!this.colorMap,pass:n},l=new Ml(r,o),c=e.getProgramLibrary();return c.register("basic",id),c.getProgram("basic",h,l)}}class ad{constructor(e,t,s){this.origMeshInstances=e,this._aabb=new De,this.meshInstance=null,this.dynamic=t,this.batchGroupId=s}destroy(e,t){this.meshInstance&&(this.removeFromLayers(e,t),this.meshInstance.destroy())}addToLayers(e,t){for(let s=0;s<t.length;s++){const i=e.layers.getLayerById(t[s]);i&&i.addMeshInstances([this.meshInstance])}}removeFromLayers(e,t){for(let s=0;s<t.length;s++){const i=e.layers.getLayerById(t[s]);i&&i.removeMeshInstances([this.meshInstance])}}updateBoundingBox(){this._aabb.copy(this.origMeshInstances[0].aabb);for(let e=1;e<this.origMeshInstances.length;e++)this._aabb.add(this.origMeshInstances[e].aabb);this.meshInstance.aabb=this._aabb,this.meshInstance._aabbVer=0}}class rd{constructor(e,t,s,i,n=[0]){this.dynamic=s,this.maxAabbSize=i,this.id=e,this.name=t,this.layers=n,this._ui=!1,this._sprite=!1,this._obj={model:[],element:[],sprite:[],render:[]}}}rd.MODEL="model",rd.ELEMENT="element",rd.SPRITE="sprite",rd.RENDER="render";const od=new Ce;class hd{constructor(e){this.bones=void 0,this._dirty=!0,this._rootBone=null,this._skinUpdateIndex=-1,this._updateBeforeCull=!0,e&&this.initSkin(e)}set rootBone(e){this._rootBone=e}get rootBone(){return this._rootBone}init(e,t){if(e.supportsBoneTextures){const s=3*t;let i=Math.ceil(Math.sqrt(s));i=ne.roundUp(i,3);const n=Math.ceil(s/i);this.boneTexture=new fh(e,{width:i,height:n,format:14,mipmaps:!1,minFilter:0,magFilter:0,name:"skin"}),this.matrixPalette=this.boneTexture.lock()}else this.matrixPalette=new Float32Array(12*t)}destroy(){this.boneTexture&&(this.boneTexture.destroy(),this.boneTexture=null)}resolve(e,t){this.rootBone=e;const s=this.skin,i=[];for(let n=0;n<s.boneNames.length;n++){const a=s.boneNames[n];let r=e.findByName(a);r||(r=t),i.push(r)}this.bones=i}initSkin(e){this.skin=e,this.bones=[];const t=e.inverseBindPose.length;this.init(e.device,t),this.matrices=[];for(let e=0;e<t;e++)this.matrices[e]=new Ce}uploadBones(e){e.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())}_updateMatrices(e,t){if(this._skinUpdateIndex!==t){this._skinUpdateIndex=t,od.copy(e.getWorldTransform()).invert();for(let e=this.bones.length-1;e>=0;e--)this.matrices[e].mulAffine2(od,this.bones[e].getWorldTransform()),this.matrices[e].mulAffine2(this.matrices[e],this.skin.inverseBindPose[e])}}updateMatrices(e,t){this._updateBeforeCull&&this._updateMatrices(e,t)}updateMatrixPalette(e,t){this._updateMatrices(e,t);const s=this.matrixPalette,i=this.bones.length;for(let e=0;e<i;e++){const t=this.matrices[e].data,i=12*e;s[i]=t[0],s[i+1]=t[4],s[i+2]=t[8],s[i+3]=t[12],s[i+4]=t[1],s[i+5]=t[5],s[i+6]=t[9],s[i+7]=t[13],s[i+8]=t[2],s[i+9]=t[6],s[i+10]=t[10],s[i+11]=t[14]}this.uploadBones(this.skin.device)}}class ld extends hd{constructor(e,t,s){super();const i=t.length;this.init(e,i),this.device=e,this.rootNode=s,this.bones=t}updateMatrices(e,t){}updateMatrixPalette(e,t){const s=this.matrixPalette,i=this.bones.length;for(let e=0;e<i;e++){const t=this.bones[e].getWorldTransform().data,i=12*e;s[i]=t[0],s[i+1]=t[4],s[i+2]=t[8],s[i+3]=t[12],s[i+4]=t[1],s[i+5]=t[5],s[i+6]=t[9],s[i+7]=t[13],s[i+8]=t[2],s[i+9]=t[6],s[i+10]=t[10],s[i+11]=t[14]}this.uploadBones(this.device)}}class cd{constructor(e,t,s){this.device=e,this.format=t,this.dirty=!0,this.impl=e.createBindGroupImpl(this),this.textures=[],this.uniformBuffers=[],this.defaultUniformBuffer=s,s&&this.setUniformBuffer("default",s)}destroy(){this.impl.destroy(),this.impl=null,this.format=null,this.defaultUniformBuffer=null}setUniformBuffer(e,t){const s=this.format.bufferFormatsMap.get(e);this.uniformBuffers[s]!==t&&(this.uniformBuffers[s]=t,this.dirty=!0)}setTexture(e,t){const s=this.format.textureFormatsMap.get(e);this.textures[s]!==t&&(this.textures[s]=t,this.dirty=!0)}update(){const e=this.format.textureFormats;for(let t=0;t<e.length;t++){const s=e[t],i=s.scopeId.value;this.setTexture(s.name,i)}this.dirty&&(this.dirty=!1,this.impl.update(this))}}const dd=[];dd[2]=function(e,t,s){e.storageFloat32[s]=t},dd[3]=(e,t,s)=>{const i=e.storageFloat32;i[s]=t[0],i[s+1]=t[1]},dd[4]=(e,t,s)=>{const i=e.storageFloat32;i[s]=t[0],i[s+1]=t[1],i[s+2]=t[2]},dd[5]=(e,t,s)=>{const i=e.storageFloat32;i[s]=t[0],i[s+1]=t[1],i[s+2]=t[2],i[s+3]=t[3]},dd[1]=function(e,t,s){e.storageInt32[s]=t},dd[6]=function(e,t,s){const i=e.storageInt32;i[s]=t[0],i[s+1]=t[1]},dd[7]=function(e,t,s){const i=e.storageInt32;i[s]=t[0],i[s+1]=t[1],i[s+2]=t[2]},dd[8]=function(e,t,s){const i=e.storageInt32;i[s]=t[0],i[s+1]=t[1],i[s+2]=t[2],i[s+3]=t[3]},dd[12]=(e,t,s)=>{const i=e.storageFloat32;i[s]=t[0],i[s+1]=t[1],i[s+4]=t[2],i[s+5]=t[3],i[s+8]=t[4],i[s+9]=t[5]},dd[13]=(e,t,s)=>{const i=e.storageFloat32;i[s]=t[0],i[s+1]=t[1],i[s+2]=t[2],i[s+4]=t[3],i[s+5]=t[4],i[s+6]=t[5],i[s+8]=t[6],i[s+9]=t[7],i[s+10]=t[8]};class ud{constructor(e,t){this.device=e,this.format=t,this.impl=e.createUniformBufferImpl(this),this.storage=new ArrayBuffer(t.byteSize),this.storageFloat32=new Float32Array(this.storage),this.storageInt32=new Int32Array(this.storage),e._vram.ub+=this.format.byteSize}destroy(){const e=this.device;this.impl.destroy(e),e._vram.ub-=this.format.byteSize}loseContext(){this.impl.loseContext()}setUniform(e){const t=e.offset,s=e.scopeId.value;if(null!=s){const i=dd[e.type];i?i(this,s,t):this.storageFloat32.set(s,t)}}set(e){const t=this.format.map.get(e);t&&this.setUniform(t)}update(){const e=this.format.uniforms;for(let t=0;t<e.length;t++)this.setUniform(e[t]);this.impl.unlock(this)}}class pd{static incRef(e){this.cache.incRef(e)}static decRef(e){this.cache.decRef(e)}static destroy(){this.cache.destroy()}}pd.cache=new class{constructor(){this.cache=new Map}destroy(){this.cache.forEach(((e,t)=>{t.destroy()})),this.cache.clear()}incRef(e){const t=(this.cache.get(e)||0)+1;this.cache.set(e,t)}decRef(e){if(e){let t=this.cache.get(e);t&&(t--,0===t?(this.cache.delete(e),e.destroy()):this.cache.set(e,t))}}};const md=new De,fd=new De,_d=new ke,gd=new Set;class yd{constructor(e){this.vertexBuffer=null,this.count=e}}class vd{constructor(e,t,s){this._key=[],this._key[0]=bd(e,t,!0,0),this.command=s}set key(e){this._key[0]=e}get key(){return this._key[0]}}class xd{constructor(e,t,s=null){if(this._material=void 0,this._shader=[],this._bindGroups=[],e instanceof kh){const i=e;e=t,t=s,s=i}this._key=[0,0],this.isStatic=!1,this._staticLightList=null,this._staticSource=null,this.node=s,this._mesh=e,e.incRefCount(),this.material=t,this._shaderDefs=65536,this._shaderDefs|=e.vertexBuffer.format.hasUv0?4:0,this._shaderDefs|=e.vertexBuffer.format.hasUv1?8:0,this._shaderDefs|=e.vertexBuffer.format.hasColor?16:0,this._shaderDefs|=e.vertexBuffer.format.hasTangents?512:0,this._lightHash=0,this.visible=!0,this.layer=15,this._renderStyle=0,this.castShadow=!1,this._receiveShadow=!0,this._screenSpace=!1,this._noDepthDrawGl1=!1,this.cull=!0,this.pick=!0,this._updateAabb=!0,this._updateAabbFunc=null,this._calculateSortDistance=null,this.updateKey(),this._skinInstance=null,this._morphInstance=null,this.instancingData=null,this._customAabb=null,this.aabb=new De,this._aabbVer=-1,this.drawOrder=0,this.visibleThisFrame=!1,this.isVisibleFunc=null,this.parameters={},this.stencilFront=null,this.stencilBack=null,this.flipFaces=!1}set renderStyle(e){this._renderStyle=e,this.mesh.prepareRenderState(e)}get renderStyle(){return this._renderStyle}set mesh(e){e!==this._mesh&&(this._mesh&&this._mesh.decRefCount(),this._mesh=e,e&&e.incRefCount())}get mesh(){return this._mesh}set aabb(e){this._aabb=e}get aabb(){if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);let e=this._customAabb,t=!!e;if(!e)if(e=md,this.skinInstance){if(!this.mesh.boneAabb){const e=this._morphInstance?this._morphInstance.morph._targets:null;this.mesh._initBoneAabbs(e)}const s=this.mesh.boneUsed;let i=!0;for(let t=0;t<this.mesh.boneAabb.length;t++)s[t]&&(fd.setFromTransformedAabb(this.mesh.boneAabb[t],this.skinInstance.matrices[t]),i?(i=!1,e.center.copy(fd.center),e.halfExtents.copy(fd.halfExtents)):e.add(fd));t=!0}else this.node._aabbVer!==this._aabbVer&&(this.mesh?(e.center.copy(this.mesh.aabb.center),e.halfExtents.copy(this.mesh.aabb.halfExtents)):(e.center.set(0,0,0),e.halfExtents.set(0,0,0)),this.mesh&&this.mesh.morph&&e._expand(this.mesh.morph.aabb.getMin(),this.mesh.morph.aabb.getMax()),t=!0,this._aabbVer=this.node._aabbVer);return t&&this._aabb.setFromTransformedAabb(e,this.node.getWorldTransform()),this._aabb}clearShaders(){const e=this._shader;for(let t=0;t<e.length;t++)e[t]=null;this.destroyBindGroups()}destroyBindGroups(){const e=this._bindGroups;for(let t=0;t<e.length;t++){const s=e[t];if(s){const e=s.defaultUniformBuffer;e&&e.destroy(),s.destroy()}}e.length=0}getBindGroup(e,t){let s=this._bindGroups[t];if(!s){const i=this._shader[t],n=i.meshUniformBufferFormat,a=new ud(e,n),r=i.meshBindGroupFormat;s=new cd(e,r,a),this._bindGroups[t]=s}return s}set material(e){this.clearShaders();const t=this._material;if(t&&t.removeMeshInstanceRef(this),this._material=e,e){e.addMeshInstanceRef(this),this.updateKey();const s=t&&t.transparent;if(e.transparent!==s){const s=this._material._scene||(null==t?void 0:t._scene);s?s.layers._dirtyBlend=!0:e._dirtyBlend=!0}}}get material(){return this._material}set layer(e){this._layer=e,this.updateKey()}get layer(){return this._layer}set calculateSortDistance(e){this._calculateSortDistance=e}get calculateSortDistance(){return this._calculateSortDistance}set receiveShadow(e){this._receiveShadow=e,this._shaderDefs=e?-2&this._shaderDefs:1|this._shaderDefs,this._shader[0]=null,this._shader[1]=null}get receiveShadow(){return this._receiveShadow}set skinInstance(e){this._skinInstance=e,this._shaderDefs=e?2|this._shaderDefs:-3&this._shaderDefs;for(let e=0;e<this._shader.length;e++)this._shader[e]=null;this._setupSkinUpdate()}get skinInstance(){return this._skinInstance}set morphInstance(e){this._morphInstance=e,this._morphInstance&&(this._morphInstance.meshInstance=this),this._shaderDefs=e&&e.morph.useTextureMorph?4096|this._shaderDefs:-4097&this._shaderDefs,this._shaderDefs=e&&e.morph.morphPositions?1024|this._shaderDefs:-1025&this._shaderDefs,this._shaderDefs=e&&e.morph.morphNormals?2048|this._shaderDefs:-2049&this._shaderDefs;for(let e=0;e<this._shader.length;e++)this._shader[e]=null}get morphInstance(){return this._morphInstance}set screenSpace(e){this._screenSpace=e,this._shaderDefs=e?256|this._shaderDefs:-257&this._shaderDefs,this._shader[0]=null}get screenSpace(){return this._screenSpace}set key(e){this._key[0]=e}get key(){return this._key[0]}set mask(e){const t=65535&this._shaderDefs;this._shaderDefs=t|e<<16,this._shader[0]=null,this._shader[1]=null}get mask(){return this._shaderDefs>>16}set instancingCount(e){this.instancingData&&(this.instancingData.count=e)}get instancingCount(){return this.instancingData?this.instancingData.count:0}destroy(){const e=this.mesh;e&&(this.mesh=null,e.refCount<1&&e.destroy()),this.setRealtimeLightmap(xd.lightmapParamNames[0],null),this.setRealtimeLightmap(xd.lightmapParamNames[1],null),this._skinInstance&&(this._skinInstance.destroy(),this._skinInstance=null),this.morphInstance&&(this.morphInstance.destroy(),this.morphInstance=null),this.destroyBindGroups(),this.material=null}static _prepareRenderStyleForArray(e,t){if(e){for(let s=0;s<e.length;s++){e[s]._renderStyle=t;const i=e[s].mesh;gd.has(i)||(gd.add(i),i.prepareRenderState(t))}gd.clear()}}_isVisible(e){return!!this.visible&&(this.isVisibleFunc?this.isVisibleFunc(e):(_d.center=this.aabb.center,_d.radius=this._aabb.halfExtents.length(),e.frustum.containsSphere(_d)))}updateKey(){const e=this.material;this._key[0]=bd(this.layer,e.alphaToCoverage||e.alphaTest?2:e.blendType,!1,e.id)}setInstancing(e){e?(this.instancingData=new yd(e.numVertices),this.instancingData.vertexBuffer=e,e.instancing=!0,this.cull=!1):(this.instancingData=null,this.cull=!0)}updatePassShader(e,t,s,i,n,a){this._shader[t]=this.material.getShaderVariant(this.mesh.device,e,this._shaderDefs,s,t,i,n,a)}ensureMaterial(e){this.material||(this.material=Tl(e))}clearParameters(){this.parameters={}}getParameters(){return this.parameters}getParameter(e){return this.parameters[e]}setParameter(e,t,s=-262141){if(void 0===t&&"object"==typeof e){const s=e;if(s.length){for(let e=0;e<s.length;e++)this.setParameter(s[e]);return}e=s.name,t=s.value}const i=this.parameters[e];i?(i.data=t,i.passFlags=s):this.parameters[e]={scopeId:null,data:t,passFlags:s}}setRealtimeLightmap(e,t){const s=this.getParameter(e);s!==t&&(s&&pd.decRef(s.data),t?(pd.incRef(t),this.setParameter(e,t)):this.deleteParameter(e))}deleteParameter(e){this.parameters[e]&&delete this.parameters[e]}setParameters(e,t){const s=this.parameters;for(const i in s){const n=s[i];n.passFlags&t&&(n.scopeId||(n.scopeId=e.scope.resolve(i)),n.scopeId.setValue(n.data))}}setLightmapped(e){e?this.mask=-6&(2|this.mask):(this.setRealtimeLightmap(xd.lightmapParamNames[0],null),this.setRealtimeLightmap(xd.lightmapParamNames[1],null),this._shaderDefs&=-8385,this.mask=-7&(1|this.mask))}setCustomAabb(e){e?this._customAabb?this._customAabb.copy(e):this._customAabb=e.clone():(this._customAabb=null,this._aabbVer=-1),this._setupSkinUpdate()}_setupSkinUpdate(){this._skinInstance&&(this._skinInstance._updateBeforeCull=!this._customAabb)}}function bd(e,t,s,i){return(15&e)<<27|(3===t?1:0)<<26|(s?1:0)<<25|(33554431&i)<<0}function Sd(e,t){if(e&&!t)return!1;if(!e&&t)return!1;if((e=e.data)===(t=t.data))return!0;if(e instanceof Float32Array&&t instanceof Float32Array){if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++)if(e[s]!==t[s])return!1;return!0}return!1}function wd(e,t){for(const s in e)if(e.hasOwnProperty(s)&&!Sd(e[s],t[s]))return!1;for(const s in t)if(t.hasOwnProperty(s)&&!Sd(t[s],e[s]))return!1;return!0}function Td(e,t){for(let s=0;s<e.length;s++)if(t.indexOf(e[s])<0)return!1;for(let s=0;s<t.length;s++)if(e.indexOf(t[s])<0)return!1;return!0}xd.lightmapParamNames=["texture_lightMap","texture_dirLightMap"];const Md=new ye,Cd=new ge,Ad=new ge,Pd=new ge;function Ed(e){const t=e.node.worldTransform;return t.getX(Cd),t.getY(Ad),t.getZ(Pd),Cd.cross(Cd,Ad),Cd.dot(Pd)>=0?1:-1}class Rd{constructor(e,t,s){this.device=e,this.rootNode=t,this.scene=s,this._init=!1,this._batchGroups={},this._batchGroupCounter=0,this._batchList=[],this._dirtyGroups=[]}destroy(){this.device=null,this.rootNode=null,this.scene=null,this._batchGroups={},this._batchList=[],this._dirtyGroups=[]}addGroup(e,t,s,i,n){if(void 0===i&&(i=this._batchGroupCounter,this._batchGroupCounter++),this._batchGroups[i])return;const a=new rd(i,e,t,s,n);return this._batchGroups[i]=a,a}removeGroup(e){if(!this._batchGroups[e])return;const t=[];for(let s=0;s<this._batchList.length;s++)this._batchList[s].batchGroupId===e?this.destroyBatch(this._batchList[s]):t.push(this._batchList[s]);this._batchList=t,this._removeModelsFromBatchGroup(this.rootNode,e),delete this._batchGroups[e]}markGroupDirty(e){this._dirtyGroups.indexOf(e)<0&&this._dirtyGroups.push(e)}getGroupByName(e){const t=this._batchGroups;for(const s in t)if(t.hasOwnProperty(s)&&t[s].name===e)return t[s];return null}getBatches(e){const t=[],s=this._batchList.length;for(let i=0;i<s;i++){const s=this._batchList[i];s.batchGroupId===e&&t.push(s)}return t}_removeModelsFromBatchGroup(e,t){if(e.enabled){e.model&&e.model.batchGroupId===t&&(e.model.batchGroupId=-1),e.render&&e.render.batchGroupId===t&&(e.render.batchGroupId=-1),e.element&&e.element.batchGroupId===t&&(e.element.batchGroupId=-1),e.sprite&&e.sprite.batchGroupId===t&&(e.sprite.batchGroupId=-1);for(let s=0;s<e._children.length;s++)this._removeModelsFromBatchGroup(e._children[s],t)}}insert(e,t,s){const i=this._batchGroups[t];i&&i._obj[e].indexOf(s)<0&&(i._obj[e].push(s),this.markGroupDirty(t))}remove(e,t,s){const i=this._batchGroups[t];if(i){const n=i._obj[e].indexOf(s);n>=0&&(i._obj[e].splice(n,1),this.markGroupDirty(t))}}_extractRender(e,t,s,i){if(e.render){if(e.render.isStatic){const s=this.scene.drawCalls,i=e.render.meshInstances;for(let e=0;e<s.length;e++)s[e]._staticSource&&(i.indexOf(s[e]._staticSource)<0||t.push(s[e]));for(let e=0;e<i.length;e++)s.indexOf(i[e])>=0&&t.push(i[e])}else t=i[e.render.batchGroupId]=t.concat(e.render.meshInstances);e.render.removeFromLayers()}return t}_extractModel(e,t,s,i){if(e.model&&e.model.model){if(e.model.isStatic){const s=this.scene.drawCalls,i=e.model.meshInstances;for(let e=0;e<s.length;e++)s[e]._staticSource&&(i.indexOf(s[e]._staticSource)<0||t.push(s[e]));for(let e=0;e<i.length;e++)s.indexOf(i[e])>=0&&t.push(i[e])}else t=i[e.model.batchGroupId]=t.concat(e.model.meshInstances);e.model.removeModelFromLayers()}return t}_extractElement(e,t,s){if(!e.element)return;let i=!1;e.element._text&&e.element._text._model.meshInstances.length>0?(t.push(e.element._text._model.meshInstances[0]),e.element.removeModelFromLayers(e.element._text._model),i=!0):e.element._image&&(t.push(e.element._image._renderable.meshInstance),e.element.removeModelFromLayers(e.element._image._renderable.model),e.element._image._renderable.unmaskMeshInstance&&(t.push(e.element._image._renderable.unmaskMeshInstance),e.element._image._renderable.unmaskMeshInstance.stencilFront&&e.element._image._renderable.unmaskMeshInstance.stencilBack||(e.element._dirtifyMask(),e.element._onPrerender())),i=!0),i&&(s._ui=!0)}_collectAndRemoveMeshInstances(e,t){for(let s=0;s<t.length;s++){const i=t[s],n=this._batchGroups[i];if(!n)continue;let a=e[i];a||(a=e[i]=[]);for(let t=0;t<n._obj.model.length;t++)a=this._extractModel(n._obj.model[t],a,n,e);for(let t=0;t<n._obj.render.length;t++)a=this._extractRender(n._obj.render[t],a,n,e);for(let e=0;e<n._obj.element.length;e++)this._extractElement(n._obj.element[e],a,n);for(let e=0;e<n._obj.sprite.length;e++){const t=n._obj.sprite[e];t.sprite&&t.sprite._meshInstance&&(n.dynamic||0===t.sprite.sprite._renderMode)&&(a.push(t.sprite._meshInstance),t.sprite.removeModelFromLayers(),n._sprite=!0,t.sprite._batchGroup=n)}}}generate(e){const t={};e||(e=Object.keys(this._batchGroups));const s=[];for(let t=0;t<this._batchList.length;t++)e.indexOf(this._batchList[t].batchGroupId)<0?s.push(this._batchList[t]):this.destroyBatch(this._batchList[t]);if(this._batchList=s,this._collectAndRemoveMeshInstances(t,e),e===this._dirtyGroups)this._dirtyGroups.length=0;else{const t=[];for(let s=0;s<this._dirtyGroups.length;s++)e.indexOf(this._dirtyGroups[s])<0&&t.push(this._dirtyGroups[s]);this._dirtyGroups=t}let i,n,a,r;for(const e in t)if(t.hasOwnProperty(e)&&(i=t[e],a=this._batchGroups[e],a)){n=this.prepare(i,a.dynamic,a.maxAabbSize,a._ui||a._sprite);for(let t=0;t<n.length;t++)r=this.create(n[t],a.dynamic,parseInt(e,10)),r&&r.addToLayers(this.scene,a.layers)}}prepare(e,t,s=Number.POSITIVE_INFINITY,i){if(0===e.length)return[];const n=.5*s,a=this.device.supportsBoneTextures?1024:this.device.boneLimit,r=this.device.extUintElement?4294967295:65535,o=new De,h=new De;let l,c=null;const d=[];let u=0;i&&e.sort((function(e,t){return e.drawOrder-t.drawOrder}));let p,m=e;const f=i?function(e){c?c.add(e.aabb):c=e.aabb.clone(),p.push(e)}:function(e){p.push(e)};for(;m.length>0;){d[u]=[m[0]],p=[];const e=m[0].material,s=m[0].layer,_=m[0]._shaderDefs,g=m[0].parameters,y=m[0].stencilFront,v=m[0]._staticLightList;let x=m[0].mesh.vertexBuffer.getNumVertices();const b=m[0].drawOrder;o.copy(m[0].aabb);const S=Ed(m[0]),w=m[0].mesh.vertexBuffer.format.batchingHash,T=m[0].mesh.primitive[0].indexed;c=null;for(let M=1;M<m.length;M++){const C=m[M];if(t&&d[u].length>=a){p=p.concat(m.slice(M));break}if(e!==C.material||s!==C.layer||w!==C.mesh.vertexBuffer.format.batchingHash||T!==C.mesh.primitive[0].indexed||_!==C._shaderDefs||x+C.mesh.vertexBuffer.getNumVertices()>r){f(C);continue}if(h.copy(o),h.add(C.aabb),h.halfExtents.x>n||h.halfExtents.y>n||h.halfExtents.z>n){f(C);continue}if(y&&(!(l=C.stencilFront)||y.func!==l.func||y.zpass!==l.zpass)){f(C);continue}if(S!==Ed(C)){f(C);continue}if(!wd(g,C.parameters)){f(C);continue}const A=C._staticLightList;if(v&&A){if(!Td(v,A)){f(C);continue}}else if(v||A){f(C);continue}i&&c&&c.intersects(C.aabb)&&C.drawOrder!==b?f(C):(o.add(C.aabb),x+=C.mesh.vertexBuffer.getNumVertices(),d[u].push(C))}u++,m=p}return d}collectBatchedMeshData(e,t){let s=null,i=0,n=0,a=null;for(let r=0;r<e.length;r++)if(e[r].visible){const o=e[r].mesh;if(i+=o.vertexBuffer.numVertices,n+=o.primitive[0].indexed?o.primitive[0].count:6===o.primitive[0].type&&4===o.primitive[0].count?6:0,!s){a=e[r].material,s={};const i=o.vertexBuffer.format.elements;for(let e=0;e<i.length;e++){s[i[e].name]={numComponents:i[e].numComponents,dataType:i[e].dataType,normalize:i[e].normalize,count:0}}t&&(s.BLENDINDICES={numComponents:1,dataType:6,normalize:!1,count:0})}}return{streams:s,batchNumVerts:i,batchNumIndices:n,material:a}}create(e,t,s){if(!this._init){const e="#define BONE_LIMIT "+this.device.getBoneLimit()+"\n";this.transformVS=e+"#define DYNAMICBATCH\n"+Bo.transformVS,this.skinTexVS=Bo.skinBatchTexVS,this.skinConstVS=Bo.skinBatchConstVS,this.vertexFormats={},this._init=!0}let i,n,a,r=null,o=null;const h=this.collectBatchedMeshData(e,t);if(h.streams){const l=h.streams;let c=h.material;const d=h.batchNumVerts,u=h.batchNumIndices;let p,m,f;o=new ad(e,t,s),this._batchList.push(o);let _,g=0,y=0;const v=new ge,x=new(d<=65535?Uint16Array:Uint32Array)(u);for(i in l)r=l[i],r.typeArrayType=no[r.dataType],r.elementByteSize=ao[r.dataType],r.buffer=new r.typeArrayType(d*r.numComponents);for(let s=0;s<e.length;s++)if(e[s].visible){for(i in n=e[s].mesh,a=n.vertexBuffer.numVertices,t||(_=e[s].node.getWorldTransform()),l)if("BLENDINDICES"!==i){r=l[i];const e=new r.typeArrayType(r.buffer.buffer,r.elementByteSize*r.count),s=n.getVertexStream(i,e)*r.numComponents;if(r.count+=s,!t&&r.numComponents>=3)if("POSITION"===i)for(let t=0;t<s;t+=r.numComponents)v.set(e[t],e[t+1],e[t+2]),_.transformPoint(v,v),e[t]=v.x,e[t+1]=v.y,e[t+2]=v.z;else if("NORMAL"===i||"TANGENT"===i){_.invertTo3x3(Md),Md.transpose();for(let t=0;t<s;t+=r.numComponents)v.set(e[t],e[t+1],e[t+2]),Md.transformVector(v,v),e[t]=v.x,e[t+1]=v.y,e[t+2]=v.z}}if(t){r=l.BLENDINDICES;for(let e=0;e<a;e++)r.buffer[r.count++]=s}if(n.primitive[0].indexed){p=n.primitive[0].base,m=n.primitive[0].count;const e=n.indexBuffer[0].getFormat();f=new oo[e](n.indexBuffer[0].storage)}else{if(6!==n.primitive[0].type||4!==n.primitive[0].count){m=0;continue}p=0,m=6,f=[0,1,3,2,3,1]}for(let e=0;e<m;e++)x[e+y]=f[p+e]+g;y+=m,g+=a}for(i in n=new Wc(this.device),l)r=l[i],n.setVertexStream(i,r.buffer,r.numComponents,void 0,r.dataType,r.normalize);x.length>0&&n.setIndices(x),n.update(4,!1),t&&(c=c.clone(),c.chunks.transformVS=this.transformVS,c.chunks.skinTexVS=this.skinTexVS,c.chunks.skinConstVS=this.skinConstVS,c.update());const b=new xd(n,c,this.rootNode);b.castShadow=o.origMeshInstances[0].castShadow,b.parameters=o.origMeshInstances[0].parameters,b.isStatic=o.origMeshInstances[0].isStatic,b.layer=o.origMeshInstances[0].layer,b._staticLightList=o.origMeshInstances[0]._staticLightList,b._shaderDefs=o.origMeshInstances[0]._shaderDefs,b.cull=o.origMeshInstances[0].cull;const S=this._batchGroups[s];if(S&&S._ui&&(b.cull=!1),t){const e=[];for(let t=0;t<o.origMeshInstances.length;t++)e.push(o.origMeshInstances[t].node);b.skinInstance=new ld(this.device,e,this.rootNode)}b._updateAabb=!1,b.drawOrder=o.origMeshInstances[0].drawOrder,b.stencilFront=o.origMeshInstances[0].stencilFront,b.stencilBack=o.origMeshInstances[0].stencilBack,b.flipFaces=Ed(o.origMeshInstances[0])<0,b.castShadow=o.origMeshInstances[0].castShadow,o.meshInstance=b,o.updateBoundingBox()}return o}updateAll(){this._dirtyGroups.length>0&&this.generate(this._dirtyGroups);for(let e=0;e<this._batchList.length;e++)this._batchList[e].dynamic&&this._batchList[e].updateBoundingBox()}clone(e,t){const s=new ad(t,e.dynamic,e.batchGroupId);this._batchList.push(s);const i=[];for(let e=0;e<t.length;e++)i.push(t[e].node);return s.meshInstance=new xd(e.meshInstance.mesh,e.meshInstance.material,e.meshInstance.node),s.meshInstance._updateAabb=!1,s.meshInstance.parameters=t[0].parameters,s.meshInstance.isStatic=t[0].isStatic,s.meshInstance.cull=t[0].cull,s.meshInstance.layer=t[0].layer,s.meshInstance._staticLightList=t[0]._staticLightList,e.dynamic&&(s.meshInstance.skinInstance=new ld(this.device,i,this.rootNode)),s.meshInstance.castShadow=e.meshInstance.castShadow,s.meshInstance._shader=e.meshInstance._shader.slice(),s.meshInstance.castShadow=e.meshInstance.castShadow,s}destroyBatch(e){e.destroy(this.scene,this._batchGroups[e.batchGroupId].layers)}}const Ld=new ge,Id=new ge,Dd=new ge,Od=new De;class Fd{constructor(){this.light=null,this.min=new ge,this.max=new ge}}class kd{constructor(e){this.device=e,this.name="Untitled",this.reportCount=0,this.boundsMin=new ge,this.boundsMax=new ge,this.boundsDelta=new ge,this._cells=new ge(1,1,1),this._cellsLimit=new ge,this.cells=this._cells,this._maxCellLightCount=0,this._pixelsPerCellCount=0,this.maxCellLightCount=4,this._maxAttenuation=0,this._maxColorValue=0,this._usedLights=[],this._usedLights.push(new Fd),this.lightsBuffer=new jh(e),this.registerUniforms(e)}set maxCellLightCount(e){const t=ne.roundUp(e,4);t!==this._maxCellLightCount&&(this._maxCellLightCount=t,this._pixelsPerCellCount=this._maxCellLightCount/4,this._cellsDirty=!0)}get maxCellLightCount(){return this._maxCellLightCount}set cells(e){Ld.copy(e).floor(),this._cells.equals(Ld)||(this._cells.copy(Ld),this._cellsLimit.copy(Ld).sub(ge.ONE),this._cellsDirty=!0)}get cells(){return this._cells}destroy(){this.lightsBuffer.destroy(),this.releaseClusterTexture()}releaseClusterTexture(){this.clusterTexture&&(this.clusterTexture.destroy(),this.clusterTexture=null)}registerUniforms(e){this._clusterWorldTextureId=e.scope.resolve("clusterWorldTexture"),this._clusterPixelsPerCellId=e.scope.resolve("clusterPixelsPerCell"),this._clusterTextureSizeId=e.scope.resolve("clusterTextureSize"),this._clusterTextureSizeData=new Float32Array(3),this._clusterBoundsMinId=e.scope.resolve("clusterBoundsMin"),this._clusterBoundsMinData=new Float32Array(3),this._clusterBoundsDeltaId=e.scope.resolve("clusterBoundsDelta"),this._clusterBoundsDeltaData=new Float32Array(3),this._clusterCellsCountByBoundsSizeId=e.scope.resolve("clusterCellsCountByBoundsSize"),this._clusterCellsCountByBoundsSizeData=new Float32Array(3),this._clusterCellsDotId=e.scope.resolve("clusterCellsDot"),this._clusterCellsDotData=new Float32Array(3),this._clusterCellsMaxId=e.scope.resolve("clusterCellsMax"),this._clusterCellsMaxData=new Float32Array(3),this._clusterCompressionLimit0Id=e.scope.resolve("clusterCompressionLimit0"),this._clusterCompressionLimit0Data=new Float32Array(2)}updateParams(e){e&&(this.cells=e.cells,this.maxCellLightCount=e.maxLightsPerCell,this.lightsBuffer.cookiesEnabled=e.cookiesEnabled,this.lightsBuffer.shadowsEnabled=e.shadowsEnabled,this.lightsBuffer.areaLightsEnabled=e.areaLightsEnabled)}updateCells(){if(this._cellsDirty){this._cellsDirty=!1;const e=this._cells.x,t=this._cells.y,s=this._cells.z,i=e*t*s,n=this._pixelsPerCellCount*i;let a=Math.ceil(Math.sqrt(n));a=ne.roundUp(a,this._pixelsPerCellCount);const r=Math.ceil(n/a);this._clusterCellsMaxData[0]=e,this._clusterCellsMaxData[1]=t,this._clusterCellsMaxData[2]=s,this._clusterCellsDotData[0]=this._pixelsPerCellCount,this._clusterCellsDotData[1]=e*s*this._pixelsPerCellCount,this._clusterCellsDotData[2]=e*this._pixelsPerCellCount,this.clusters=new Uint8ClampedArray(4*n),this.counts=new Int32Array(i),this._clusterTextureSizeData[0]=a,this._clusterTextureSizeData[1]=1/a,this._clusterTextureSizeData[2]=1/r,this.releaseClusterTexture(),this.clusterTexture=jh.createTexture(this.device,a,r,7,"ClusterTexture")}}uploadTextures(){this.clusterTexture.lock().set(this.clusters),this.clusterTexture.unlock(),this.lightsBuffer.uploadTextures()}updateUniforms(){this.lightsBuffer.updateUniforms(),this._clusterWorldTextureId.setValue(this.clusterTexture);const e=this.boundsDelta;this._clusterCellsCountByBoundsSizeData[0]=this._cells.x/e.x,this._clusterCellsCountByBoundsSizeData[1]=this._cells.y/e.y,this._clusterCellsCountByBoundsSizeData[2]=this._cells.z/e.z,this._clusterCellsCountByBoundsSizeId.setValue(this._clusterCellsCountByBoundsSizeData),this._clusterBoundsMinData[0]=this.boundsMin.x,this._clusterBoundsMinData[1]=this.boundsMin.y,this._clusterBoundsMinData[2]=this.boundsMin.z,this._clusterBoundsDeltaData[0]=e.x,this._clusterBoundsDeltaData[1]=e.y,this._clusterBoundsDeltaData[2]=e.z,this._clusterCompressionLimit0Data[0]=this._maxAttenuation,this._clusterCompressionLimit0Data[1]=this._maxColorValue,this._clusterPixelsPerCellId.setValue(this._pixelsPerCellCount),this._clusterTextureSizeId.setValue(this._clusterTextureSizeData),this._clusterBoundsMinId.setValue(this._clusterBoundsMinData),this._clusterBoundsDeltaId.setValue(this._clusterBoundsDeltaData),this._clusterCellsDotId.setValue(this._clusterCellsDotData),this._clusterCellsMaxId.setValue(this._clusterCellsMaxData),this._clusterCompressionLimit0Id.setValue(this._clusterCompressionLimit0Data)}evalLightCellMinMax(e,t,s){t.copy(e.min),t.sub(this.boundsMin),t.div(this.boundsDelta),t.mul2(t,this.cells),t.floor(),s.copy(e.max),s.sub(this.boundsMin),s.div(this.boundsDelta),s.mul2(s,this.cells),s.ceil(),t.max(ge.ZERO),s.min(this._cellsLimit)}collectLights(e){const t=this.lightsBuffer.maxLights,s=this._usedLights;let i=1;for(let n=0;n<e.length;n++){const a=e[n],r=!!(3&a.mask);if(a.enabled&&0!==a.type&&a.visibleThisFrame&&a.intensity>0&&r){if(!(i<t)){console.warn(`Clustered lighting: more than ${t-1} lights in the frame, ignoring some.`);break}{let e;i<s.length?e=s[i]:(e=new Fd,s.push(e)),e.light=a,a.getBoundingBox(Od),e.min.copy(Od.getMin()),e.max.copy(Od.getMax()),i++}}}s.length=i}evaluateBounds(){const e=this._usedLights,t=this.boundsMin,s=this.boundsMax;if(e.length>1){t.copy(e[1].min),s.copy(e[1].max);for(let i=2;i<e.length;i++)t.min(e[i].min),s.max(e[i].max)}else t.set(0,0,0),s.set(1,1,1);this.boundsDelta.sub2(s,t),this.lightsBuffer.setBounds(t,this.boundsDelta)}evaluateCompressionLimits(e){let t=0,s=0;const i=this._usedLights;for(let n=1;n<i.length;n++){const a=i[n].light;t=Math.max(a.attenuationEnd,t);const r=e?a._linearFinalColor:a._finalColor;s=Math.max(r[0],s),s=Math.max(r[1],s),s=Math.max(r[2],s)}this._maxAttenuation=t+1e-6,this._maxColorValue=s+1e-6,this.lightsBuffer.setCompressionRanges(this._maxAttenuation,this._maxColorValue)}updateClusters(e){this.counts.fill(0),this.clusters.fill(0);const t=this._cells.x,s=this._cells.z,i=this.counts,n=this._maxCellLightCount,a=this.clusters,r=this._pixelsPerCellCount,o=this._usedLights;for(let h=1;h<o.length;h++){const l=o[h],c=l.light;this.lightsBuffer.addLightData(c,h,e),this.evalLightCellMinMax(l,Id,Dd);const d=Id.x,u=Dd.x,p=Id.y,m=Dd.y,f=Id.z,_=Dd.z;for(let e=d;e<=u;e++)for(let o=f;o<=_;o++)for(let l=p;l<=m;l++){const c=e+t*(o+l*s),d=i[c];d<n&&(a[r*c*4+d]=h,i[c]=d+1)}}}update(e,t,s){this.updateParams(s),this.updateCells(),this.collectLights(e),this.evaluateBounds(),this.evaluateCompressionLimits(t),this.updateClusters(t),this.uploadTextures()}activate(){this.updateUniforms()}}const Bd=[];Bd[2]=1,Bd[3]=2,Bd[4]=3,Bd[5]=4,Bd[1]=1,Bd[6]=2,Bd[7]=3,Bd[8]=4,Bd[0]=1,Bd[9]=2,Bd[10]=3,Bd[11]=4,Bd[12]=8,Bd[13]=12,Bd[14]=16;class zd{constructor(e,t,s=1){this.name=void 0,this.type=void 0,this.byteSize=void 0,this.offset=void 0,this.scopeId=void 0,this.count=void 0,this.name=e,this.type=t,this.count=s;const i=Bd[t];this.byteSize=s*i*4}calculateOffset(e){const t=this.byteSize<=8?this.byteSize:16;e=ne.roundUp(e,t),this.offset=e/4}}class Ud{constructor(e,t){this.byteSize=0,this.map=new Map,this.scope=e.scope,this.uniforms=t;let s=0;for(let e=0;e<t.length;e++){const i=t[e];i.calculateOffset(s),s=4*i.offset+i.byteSize,i.scopeId=this.scope.resolve(i.name),this.map.set(i.name,i)}this.byteSize=ne.roundUp(s,16)}get(e){return this.map.get(e)}getShaderDeclaration(e,t){let s=`layout(set = ${e}, binding = ${t}, std140) uniform ub_${io[e]} {\n`;return this.uniforms.forEach((e=>{const t=Yr[e.type];s+=`    ${t} ${e.name};\n`})),s+"};\n"}}class Vd{constructor(e,t){this.name=e,this.visibility=t}}class Nd{constructor(e,t,s){this.device=e,this.bufferFormats=t,this.bufferFormatsMap=new Map,t.forEach(((e,t)=>this.bufferFormatsMap.set(e.name,t))),this.textureFormats=s;const i=e.scope;this.textureFormatsMap=new Map,s.forEach(((e,t)=>{this.textureFormatsMap.set(e.name,t),e.scopeId=i.resolve(e.name)})),this.impl=e.createBindGroupFormatImpl(this)}destroy(){this.impl.destroy()}getTexture(e){const t=this.textureFormatsMap.get(e);return void 0!==t?this.textureFormats[t]:null}getShaderDeclarationTextures(e){let t="",s=this.bufferFormats.length;return this.textureFormats.forEach((i=>{t+=`layout(set = ${e}, binding = ${s++}) uniform texture2D ${i.name};\nlayout(set = ${e}, binding = ${s++}) uniform sampler ${i.name}_sampler;\n`})),t}loseContext(){}}class Gd{constructor(){this.clearValue=new pe(0,0,0,1),this.clear=!1,this.store=!1,this.resolve=!0,this.mipmaps=!1}}class Wd{constructor(){this.clearDepthValue=1,this.clearStencilValue=0,this.clearDepth=!1,this.clearStencil=!1,this.storeDepth=!1,this.storeStencil=!1}}class Hd{constructor(e,t){this.name=void 0,this.renderTarget=void 0,this.samples=0,this.colorOps=void 0,this.depthStencilOps=void 0,this.requiresCubemaps=!0,this.fullSizeClearRect=!0,this.device=e,this.execute=t}init(e){var t,s;this.renderTarget=e||null,this.colorOps=new Gd,this.depthStencilOps=new Wd,this.samples=Math.max(this.renderTarget?this.renderTarget.samples:this.device.samples,1),1===this.samples&&(this.colorOps.store=!0,this.colorOps.resolve=!1),null!=(t=this.renderTarget)&&null!=(s=t.colorBuffer)&&s.mipmaps&&(this.colorOps.mipmaps=!0)}setClearColor(e){this.colorOps.clearValue.copy(e),this.colorOps.clear=!0}setClearDepth(e){this.depthStencilOps.clearDepthValue=e,this.depthStencilOps.clearDepth=!0}setClearStencil(e){this.depthStencilOps.clearStencilValue=e,this.depthStencilOps.clearStencil=!0}render(){const e=this.device,t=void 0!==this.renderTarget;t&&e.startPass(this),this.execute(),t&&e.endPass(this)}}const Xd=new xe;class qd{constructor(e,t){this.device=e,this.lightTextureAtlas=t,this.blitShader2d=null,this.blitShaderCube=null,this.blitTextureId=null,this.invViewProjId=null}destroy(){}getShader(e,t){return this[e]||(this[e]=eh(this.device,"\n    attribute vec2 vertex_position;\n    varying vec2 uv0;\n    void main(void) {\n        gl_Position = vec4(vertex_position, 0.5, 1.0);\n        uv0 = vertex_position.xy * 0.5 + 0.5;\n    }",t,`cookie_renderer_${e}`)),this.blitTextureId||(this.blitTextureId=this.device.scope.resolve("blitTexture")),this.invViewProjId||(this.invViewProjId=this.device.scope.resolve("invViewProj")),this[e]}get shader2d(){return this.getShader("blitShader2d","\n    varying vec2 uv0;\n    uniform sampler2D blitTexture;\n    void main(void) {\n        gl_FragColor = texture2D(blitTexture, uv0);\n    }")}get shaderCube(){return this.getShader("blitShaderCube","\n    varying vec2 uv0;\n    uniform samplerCube blitTexture;\n    uniform mat4 invViewProj;\n    void main(void) {\n        vec4 projPos = vec4(uv0 * 2.0 - 1.0, 0.5, 1.0);\n        vec4 worldPos = invViewProj * projPos;\n        gl_FragColor = textureCube(blitTexture, worldPos.xyz);\n    }")}static createTexture(e,t){return new fh(e,{name:"CookieAtlas",width:t,height:t,format:7,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1})}initInvViewProjMatrices(){if(!qd._invViewProjMatrices){qd._invViewProjMatrices=[];for(let e=0;e<6;e++){const t=Vh.create(null,1,e),s=t.projectionMatrix,i=t.node.getLocalTransform().clone().invert();qd._invViewProjMatrices[e]=(new Ce).mul2(s,i).invert()}}}render(e,t){if(e.enabled&&e.cookie&&e.visibleThisFrame){const s=e.numShadowFaces,i=s>1?this.shaderCube:this.shader2d,n=this.device;s>1&&this.initInvViewProjMatrices(),this.blitTextureId.setValue(e.cookie);for(let a=0;a<s;a++){if(Xd.copy(e.atlasViewport),s>1){const e=Xd.z/3,t=this.lightTextureAtlas.cubeSlotsOffsets[a];Xd.x+=e*t.x,Xd.y+=e*t.y,Xd.z=e,Xd.w=e,this.invViewProjId.setValue(qd._invViewProjMatrices[a].data)}Xd.mulScalar(t.colorBuffer.width),bo(n,t,i,Xd)}}}}qd._invViewProjMatrices=null;class jd{constructor(e,t){this.texture=e,this.cached=!1,this.renderTargets=t}destroy(){this.texture&&(this.texture.destroy(),this.texture=null);const e=this.renderTargets;for(let t=0;t<e.length;t++)e[t].destroy();this.renderTargets.length=0}static getShadowFormat(e,t){return 3===t?14:2===t?12:4===t||0===t&&e.webgl2?16:7}static getShadowFiltering(e,t){return 0!==t||e.webgl2?3===t?e.extTextureFloatLinear?1:0:2===t?e.extTextureHalfFloatLinear?1:0:1:0}static create(e,t){let s=null;return s=1===t._type?this.createCubemap(e,t._shadowResolution):this.create2dMap(e,t._shadowResolution,t._shadowType),s}static createAtlas(e,t,s){const i=this.create2dMap(e,t,s),n=i.renderTargets,a=n[0];for(let e=0;e<5;e++)n.push(a);return i}static create2dMap(e,t,s){const i=this.getShadowFormat(e,s),n=this.getShadowFiltering(e,s),a=new fh(e,{format:i,width:t,height:t,mipmaps:!1,minFilter:n,magFilter:n,addressU:1,addressV:1,name:"ShadowMap2D"});let r=null;return 4===s||0===s&&e.webgl2?(a.compareOnRead=!0,a.compareFunc=1,r=new Jl({depthBuffer:a})):r=new Jl({colorBuffer:a,depth:!0}),new jd(a,[r])}static createCubemap(e,t){const s=new fh(e,{format:7,width:t,height:t,cubemap:!0,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1,name:"ShadowMapCube"}),i=[];for(let e=0;e<6;e++){const t=new Jl({colorBuffer:s,face:e,depth:!0});i.push(t)}return new jd(s,i)}}const Yd=[],$d=[],Kd=new xe,Zd=new xe;class Qd{constructor(e){this.size=Math.floor(1024*e.w),this.used=!1,this.lightId=-1,this.rect=e}}class Jd{constructor(e){this.device=e,this.version=1,this.shadowAtlasResolution=2048,this.shadowAtlas=null,this.shadowEdgePixels=3,this.cookieAtlasResolution=2048,this.cookieAtlas=null,this.cookieRenderTarget=null,this.slots=[],this.atlasSplit=[],this.cubeSlotsOffsets=[new ve(0,0),new ve(0,1),new ve(1,0),new ve(1,1),new ve(2,0),new ve(2,1)],this.scissorVec=new xe,this.allocateShadowAtlas(1),this.allocateCookieAtlas(1),this.allocateUniforms()}destroy(){this.destroyShadowAtlas(),this.destroyCookieAtlas()}destroyShadowAtlas(){this.shadowAtlas&&(this.shadowAtlas.destroy(),this.shadowAtlas=null)}destroyCookieAtlas(){this.cookieAtlas&&(this.cookieAtlas.destroy(),this.cookieAtlas=null),this.cookieRenderTarget&&(this.cookieRenderTarget.destroy(),this.cookieRenderTarget=null)}allocateShadowAtlas(e){if(!this.shadowAtlas||this.shadowAtlas.texture.width!==e){this.version++,this.destroyShadowAtlas(),this.shadowAtlas=jd.createAtlas(this.device,e,0),this.shadowAtlas.cached=!0;const t=4/this.shadowAtlasResolution;this.scissorVec.set(t,t,-2*t,-2*t)}}allocateCookieAtlas(e){this.cookieAtlas&&this.cookieAtlas.width===e||(this.version++,this.destroyCookieAtlas(),this.cookieAtlas=qd.createTexture(this.device,e),this.cookieRenderTarget=new Jl({colorBuffer:this.cookieAtlas,depth:!1,flipY:!0}))}allocateUniforms(){this._shadowAtlasTextureId=this.device.scope.resolve("shadowAtlasTexture"),this._shadowAtlasParamsId=this.device.scope.resolve("shadowAtlasParams"),this._shadowAtlasParams=new Float32Array(2),this._cookieAtlasTextureId=this.device.scope.resolve("cookieAtlasTexture")}updateUniforms(){const e=this.shadowAtlas.renderTargets[0],t=this.device.webgl2?e.depthBuffer:e.colorBuffer;this._shadowAtlasTextureId.setValue(t),this._shadowAtlasParams[0]=this.shadowAtlasResolution,this._shadowAtlasParams[1]=this.shadowEdgePixels,this._shadowAtlasParamsId.setValue(this._shadowAtlasParams),this._cookieAtlasTextureId.setValue(this.cookieAtlas)}subdivide(e,t){let s=t.atlasSplit;if(!s){const t=Math.ceil(Math.sqrt(e));s=$d,s[0]=t,s.length=1}if(i=s,n=this.atlasSplit,i.length!==n.length||!i.every(((e,t)=>e===n[t]))){this.version++,this.slots.length=0,this.atlasSplit.length=0,this.atlasSplit.push(...s);const e=this.atlasSplit[0];if(e>1){const t=1/e;for(let s=0;s<e;s++)for(let i=0;i<e;i++){const n=new xe(s*t,i*t,t,t),a=this.atlasSplit[1+s*e+i];if(a>1)for(let e=0;e<a;e++)for(let s=0;s<a;s++){const i=t/a,r=new xe(n.x+e*i,n.y+s*i,i,i);this.slots.push(new Qd(r))}else this.slots.push(new Qd(n))}}else this.slots.push(new Qd(new xe(0,0,1,1)));this.slots.sort(((e,t)=>t.size-e.size))}var i,n}collectLights(e,t,s){const i=s.cookiesEnabled,n=s.shadowsEnabled;let a=!1,r=!1;const o=Yd;o.length=0;const h=e=>{for(let t=0;t<e.length;t++){const s=e[t];if(s.visibleThisFrame){const e=n&&s.castShadows,t=i&&!!s.cookie;a||(a=e),r||(r=t),(e||t)&&o.push(s)}}};return(i||n)&&(h(e),h(t)),o.sort(((e,t)=>t.maxScreenSize-e.maxScreenSize)),a&&this.allocateShadowAtlas(this.shadowAtlasResolution),r&&this.allocateCookieAtlas(this.cookieAtlasResolution),(a||r)&&this.subdivide(o.length,s),o}setupSlot(e,t){e.atlasViewport.copy(t);const s=e.numShadowFaces;for(let i=0;i<s;i++)if(e.castShadows||e._cookie){if(Kd.copy(t),Zd.copy(t),2===e._type&&Kd.add(this.scissorVec),1===e._type){const e=Kd.z/3,t=this.cubeSlotsOffsets[i];Kd.x+=e*t.x,Kd.y+=e*t.y,Kd.z=e,Kd.w=e,Zd.copy(Kd)}if(e.castShadows){const t=e.getRenderData(null,i);t.shadowViewport.copy(Kd),t.shadowScissor.copy(Zd)}}}assignSlot(e,t,s){e.atlasViewportAllocated=!0;const i=this.slots[t];i.lightId=e.id,i.used=!0,s&&(e.atlasSlotUpdated=!0,e.atlasVersion=this.version,e.atlasSlotIndex=t)}update(e,t,s){this.shadowAtlasResolution=s.shadowAtlasResolution,this.cookieAtlasResolution=s.cookieAtlasResolution;const i=this.collectLights(e,t,s);if(i.length>0){const e=this.slots;for(let t=0;t<e.length;t++)e[t].used=!1;const t=Math.min(i.length,e.length);for(let s=0;s<t;s++){const t=i[s];t.castShadows&&(t._shadowMap=this.shadowAtlas);const n=e[t.atlasSlotIndex];if(t.atlasVersion===this.version&&t.id===(null==n?void 0:n.lightId)){const i=e[t.atlasSlotIndex];i.size!==e[s].size||i.used||this.assignSlot(t,t.atlasSlotIndex,!1)}}let s=0;for(let n=0;n<t;n++){for(;s<e.length&&e[s].used;)s++;const t=i[n];t.atlasViewportAllocated||this.assignSlot(t,s,!0);const a=e[t.atlasSlotIndex];this.setupSlot(t,a.rect)}}this.updateUniforms()}}class eu{constructor(){this.shadowMapCache=new Map}destroy(){this.clear(),this.shadowMapCache=null}clear(){this.shadowMapCache.forEach((e=>{e.forEach((e=>{e.destroy()}))})),this.shadowMapCache.clear()}getKey(e){return`${1===e._type}-${e._shadowType}-${e._shadowResolution}`}get(e,t){const s=this.getKey(t),i=this.shadowMapCache.get(s);if(i&&i.length)return i.pop();const n=jd.create(e,t);return n.cached=!0,n}add(e,t){const s=this.getKey(e),i=this.shadowMapCache.get(s);i?i.push(t):this.shadowMapCache.set(s,[t])}}const tu=[new ge,new ge,new ge,new ge,new ge,new ge,new ge,new ge],su={min:0,max:0};function iu(e,t,s){tu[0].x=tu[1].x=tu[2].x=tu[3].x=t.x,tu[1].y=tu[3].y=tu[7].y=tu[5].y=t.y,tu[2].z=tu[3].z=tu[6].z=tu[7].z=t.z,tu[4].x=tu[5].x=tu[6].x=tu[7].x=s.x,tu[0].y=tu[2].y=tu[4].y=tu[6].y=s.y,tu[0].z=tu[1].z=tu[4].z=tu[5].z=s.z;let i=9999999999,n=-9999999999;for(let t=0;t<8;++t){e.transformPoint(tu[t],tu[t]);const s=tu[t].z;s<i&&(i=s),s>n&&(n=s)}return su.min=i,su.max=n,su}function nu(e,t){return Math.exp(-e*e/(2*t*t))}const au=new De,ru=new Ce,ou=new Ce,hu=new Float32Array(2),lu=new xe(1,1,0,0),cu={r:1,g:2,b:3,a:4},du=new ge,uu=new Ce;function pu(e){const t=e.material,s=e.skinInstance?10:0;let i=0;if(t.opacityMap){const e=t.opacityMapChannel;e&&(i=cu[e])}return s+i}class mu{constructor(e,t){this.device=e.device,this.forwardRenderer=e,this.lightTextureAtlas=t;const s=this.device.scope;this.polygonOffsetId=s.resolve("polygonOffset"),this.polygonOffset=new Float32Array(2),this.sourceId=s.resolve("source"),this.pixelOffsetId=s.resolve("pixelOffset"),this.weightId=s.resolve("weight[0]"),this.blurVsmShaderCode=[Bo.blurVSMPS,"#define GAUSS\n"+Bo.blurVSMPS];const i="#define PACKED\n";this.blurPackedVsmShaderCode=[i+this.blurVsmShaderCode[0],i+this.blurVsmShaderCode[1]],this.blurVsmShader=[{},{}],this.blurPackedVsmShader=[{},{}],this.blurVsmWeights={},this.shadowMapLightRadiusId=s.resolve("light_radius"),this.shadowMapCache=new eu}destroy(){this.shadowMapCache.destroy(),this.shadowMapCache=null}static createShadowCamera(e,t,s,i){const n=Vh.create("ShadowCamera",s,i);return n.clearColor=t>=1&&t<=3?new pe(0,0,0,0):new pe(1,1,1,1),n.clearDepthBuffer=!0,n.clearStencilBuffer=!1,n}static setShadowCameraSettings(e,t,s,i,n){let a=4===s||0===s&&t.webgl2;1!==i||n||(a=!1),e.clearColorBuffer=!a}cullShadowCasters(e,t,s){let i=0;const n=e.length;for(let a=0;a<n;a++){const n=e[a];n.cull&&!n._isVisible(s)||(n.visibleThisFrame=!0,t[i]=n,i++)}t.length=i,t.sort(this.forwardRenderer.depthSortCompare)}cullLocal(e,t){const s=this.forwardRenderer.scene.clusteredLightingEnabled;e.visibleThisFrame=!0,s||e._shadowMap||(e._shadowMap=jd.create(this.device,e));const i=e._type,n=2===i?1:6;for(let a=0;a<n;a++){const n=e.getRenderData(null,a),r=n.shadowCamera;r.nearClip=e.attenuationEnd/1e3,r.farClip=e.attenuationEnd;const o=r._node,h=e._node;if(o.setPosition(h.getPosition()),2===i)r.fov=2*e._outerConeAngle,o.setRotation(h.getRotation()),o.rotateLocal(-90,0,0);else if(1===i)if(s){const t=2/(this.lightTextureAtlas.shadowAtlasResolution*e.atlasViewport.z/3)*this.lightTextureAtlas.shadowEdgePixels;r.fov=Math.atan(1+t)*ne.RAD_TO_DEG*2}else r.fov=90;this.forwardRenderer.updateCameraFrustum(r),this.cullShadowCasters(t,n.visibleCasters,r)}}generateSplitDistances(e,t,s){e._shadowCascadeDistances.fill(s);for(let i=1;i<e.numCascades;i++){const n=i/e.numCascades,a=t+(s-t)*n,r=t*(s/t)**n,o=ne.lerp(a,r,e.cascadeDistribution);e._shadowCascadeDistances[i-1]=o}}cullDirectional(e,t,s){e.visibleThisFrame=!0,e._shadowMap||(e._shadowMap=jd.create(this.device,e));const i=s._nearClip;this.generateSplitDistances(e,i,e.shadowDistance);for(let n=0;n<e.numCascades;n++){const a=e.getRenderData(s,n),r=a.shadowCamera;r.renderTarget=e._shadowMap.renderTargets[0],a.shadowViewport.copy(e.cascades[n]),a.shadowScissor.copy(e.cascades[n]);const o=r._node,h=e._node;o.setPosition(h.getPosition()),o.setRotation(h.getRotation()),o.rotateLocal(-90,0,0);const l=0===n?i:e._shadowCascadeDistances[n-1],c=e._shadowCascadeDistances[n],d=yi.getPoints(s,l,c);du.set(0,0,0);const u=s.node.getWorldTransform();for(let e=0;e<8;e++)u.transformPoint(d[e],d[e]),du.add(d[e]);du.mulScalar(1/8);let p=0;for(let e=0;e<8;e++){const t=d[e].sub(du).length();t>p&&(p=t)}const m=o.right,f=o.up,_=o.forward,g=.25*e._shadowResolution/p,y=Math.ceil(du.dot(f)*g)/g,v=Math.ceil(du.dot(m)*g)/g,x=f.mulScalar(y),b=m.mulScalar(v),S=du.dot(_),w=_.mulScalar(S);du.add2(x,b).add(w),o.setPosition(du),o.translateLocal(0,0,1e6),r.nearClip=0,r.farClip=2e6,r.orthoHeight=p,this.forwardRenderer.updateCameraFrustum(r),this.cullShadowCasters(t,a.visibleCasters,r);let T=!0;const M=a.visibleCasters;for(let e=0;e<M.length;e++){const t=M[e];T?(T=!1,au.copy(t.aabb)):au.add(t.aabb)}ru.copy(o.getWorldTransform()).invert();const C=iu(ru,au.getMin(),au.getMax());o.translateLocal(0,0,C.max+.1),r.farClip=C.max-C.min+.2}}setupRenderState(e,t){const s=this.forwardRenderer.scene.clusteredLightingEnabled;e.webgl2?1!==t._type||s?(e.setDepthBias(!0),e.setDepthBiasValues(-1e3*t.shadowBias,-1e3*t.shadowBias)):e.setDepthBias(!1):e.extStandardDerivatives&&(1===t._type?(this.polygonOffset[0]=0,this.polygonOffset[1]=0,this.polygonOffsetId.setValue(this.polygonOffset)):(this.polygonOffset[0]=-1e3*t.shadowBias,this.polygonOffset[1]=-1e3*t.shadowBias,this.polygonOffsetId.setValue(this.polygonOffset))),e.setBlending(!1),e.setDepthWrite(!0),e.setDepthTest(!0),e.setDepthFunc(3);(s?t._isPcf&&e.webgl2:t._isPcf&&e.webgl2&&1!==t._type)?e.setColorWrite(!1,!1,!1,!1):e.setColorWrite(!0,!0,!0,!0)}restoreRenderState(e){e.webgl2?e.setDepthBias(!1):e.extStandardDerivatives&&(this.polygonOffset[0]=0,this.polygonOffset[1]=0,this.polygonOffsetId.setValue(this.polygonOffset))}dispatchUniforms(e,t,s,i){const n=t._node;0!==e._type&&(this.forwardRenderer.dispatchViewPos(n.getPosition()),this.shadowMapLightRadiusId.setValue(e.attenuationEnd)),ru.setTRS(n.getPosition(),n.getRotation(),ge.ONE).invert(),ou.mul2(t.projectionMatrix,ru);const a=s.shadowViewport;t.rect=a,t.scissorRect=s.shadowScissor,uu.setViewport(a.x,a.y,a.z,a.w),s.shadowMatrix.mul2(uu,ou),0===e._type&&e._shadowMatrixPalette.set(s.shadowMatrix.data,16*i)}submitCasters(e,t){const s=this.device,i=this.forwardRenderer,n=i.scene,a=zo.getShadow(t._type,t._shadowType),r=e.length;for(let t=0;t<r;t++){const r=e[t],o=r.mesh;r.ensureMaterial(s);const h=r.material;i.setBaseConstants(s,h),i.setSkinning(s,r,h),h.dirty&&(h.updateUniforms(s,n),h.dirty=!1),h.chunks&&(i.setCullMode(!0,!1,r),h.setParameters(s),r.setParameters(s,16));let l=r._shader[a];l||(r.updatePassShader(n,a),l=r._shader[a],r._key[1]=pu(r)),!l.failed&&s.setShader(l),i.setVertexBuffers(s,o),i.setMorphing(s,r.morphInstance);const c=r.renderStyle;s.setIndexBuffer(o.indexBuffer[c]),i.drawInstance(s,r,o,c),i._shadowDrawCalls++}}render(e,t){if(e.enabled&&e.castShadows&&0!==e.shadowUpdateMode&&e.visibleThisFrame){const s=this.device;1===e.shadowUpdateMode&&(e.shadowUpdateMode=0);const i=e._type,n=e._shadowType,a=e.numShadowFaces,r=this.forwardRenderer;r._shadowMapUpdates+=a;const o=r.scene.clusteredLightingEnabled;this.setupRenderState(s,e);for(let h=0;h<a;h++){const a=e.getRenderData(0===i?t:null,h),l=a.shadowCamera;mu.setShadowCameraSettings(l,s,n,i,o);const c=0===i?0:h;l.renderTarget=e._shadowMap.renderTargets[c],this.dispatchUniforms(e,l,a,h),r.setCamera(l,l.renderTarget,!0),this.submitCasters(a.visibleCasters,e)}if(e._isVsm&&e._vsmBlurSize>1){this.forwardRenderer.scene.clusteredLightingEnabled&&0!==i||this.applyVsmBlur(e,t)}this.restoreRenderState(s)}}getVsmBlurShader(e,t,s){let i=(e?this.blurPackedVsmShader:this.blurVsmShader)[t][s];if(!i){this.blurVsmWeights[s]=function(e){e>25&&(e=25);const t=(e-1)/6,s=.5*(e-1),i=new Array(e);let n=0;for(let a=0;a<e;++a)i[a]=nu(a-s,t),n+=i[a];for(let t=0;t<e;++t)i[t]/=n;return i}(s);const n=Bo.fullscreenQuadVS;let a="#define SAMPLES "+s+"\n";a+=e?this.blurPackedVsmShaderCode[t]:this.blurVsmShaderCode[t];const r="blurVsm"+t+s+e;i=eh(this.device,n,a,r),e?this.blurPackedVsmShader[t][s]=i:this.blurVsmShader[t][s]=i}return i}applyVsmBlur(e,t){const s=this.device,i=e.getRenderData(0===e._type?t:null,0).shadowCamera.renderTarget,n=this.shadowMapCache.get(s,e),a=n.renderTargets[0],r=1===e._shadowType,o=e.vsmBlurMode,h=e._vsmBlurSize,l=this.getVsmBlurShader(r,o,h);lu.z=e._shadowResolution-2,lu.w=lu.z,this.sourceId.setValue(i.colorBuffer),hu[0]=1/e._shadowResolution,hu[1]=0,this.pixelOffsetId.setValue(hu),1===o&&this.weightId.setValue(this.blurVsmWeights[h]),bo(s,a,l,null,lu),this.sourceId.setValue(a.colorBuffer),hu[1]=hu[0],hu[0]=0,this.pixelOffsetId.setValue(hu),bo(s,i,l,null,lu),this.shadowMapCache.add(e,n)}}const fu=new ke;class _u{static lightCompare(e,t){return e.key-t.key}static prepare(e,t,s,i){const n=s,a=n.length,r=[],o=new ge,h=new ge,l=new De,c=new Ce,d=[],u=[],p=[],m=[];for(let t=0;t<a;t++){const s=n[t];if(s.isStatic){const t=s.aabb;m.length=0;for(let e=1;e<=2;e++)for(let n=0;n<i.length;n++){const a=i[n];if(a._type===e&&(a.enabled&&a.mask&s.mask&&a.isStatic)){if(u[n]||(u[n]=new De,a._node.getWorldTransform(),a.getBoundingSphere(fu),u[n].center.copy(fu.center),u[n].halfExtents.set(fu.radius,fu.radius,fu.radius)),!u[n].intersects(t))continue;m.push(n)}}if(0===m.length){r.push(s);continue}const n=s.mesh,a=n.vertexBuffer,f=n.indexBuffer[s.renderStyle],_=2===f.bytesPerIndex?new Uint16Array(f.lock()):new Uint32Array(f.lock()),g=n.primitive[s.renderStyle].count/3,y=n.primitive[s.renderStyle].base,v=a.format.elements,x=a.format.size/4,b=new Float32Array(a.storage);let S;for(let e=0;e<v.length;e++)"POSITION"===v[e].name&&(S=v[e].offset/4);d.length=g;for(let e=0;e<g;e++)d[e]=0;let w=!1;p.length=6*g;for(let e=0;e<g;e++){let t=Number.MAX_VALUE,s=Number.MAX_VALUE,i=Number.MAX_VALUE,n=-Number.MAX_VALUE,a=-Number.MAX_VALUE,r=-Number.MAX_VALUE;for(let o=0;o<3;o++){let h=_[3*e+o+y];h=h*x+S;const l=b[h],c=b[h+1],d=b[h+2];l<t&&(t=l),c<s&&(s=c),d<i&&(i=d),l>n&&(n=l),c>a&&(a=c),d>r&&(r=d)}const o=6*e;p[o]=t,p[o+1]=s,p[o+2]=i,p[o+3]=n,p[o+4]=a,p[o+5]=r}for(let e=0;e<m.length;e++){const t=m[e];c.copy(s.node.worldTransform).invert(),l.setFromTransformedAabb(u[t],c);const i=l.getMin(),n=l.getMax(),a=1<<e;for(let e=0;e<g;e++){const t=6*e;p[t]<=n.x&&p[t+3]>=i.x&&p[t+1]<=n.y&&p[t+4]>=i.y&&p[t+2]<=n.z&&p[t+5]>=i.z&&(d[e]|=a,w=!0)}}if(w){const t={};for(let e=0;e<g;e++){const s=3*e+y,i=d[e];t[i]||(t[i]=[]);const n=t[i];n.push(_[s]),n.push(_[s+1]),n.push(_[s+2])}for(const n in t){const l=t[n],c=new nc(e,f.format,l.length,f.usage);(2===c.bytesPerIndex?new Uint16Array(c.lock()):new Uint32Array(c.lock())).set(l),c.unlock();let d=Number.MAX_VALUE,u=Number.MAX_VALUE,p=Number.MAX_VALUE,_=-Number.MAX_VALUE,g=-Number.MAX_VALUE,y=-Number.MAX_VALUE;for(let e=0;e<l.length;e++){const t=l[e],s=b[t*x+S],i=b[t*x+S+1],n=b[t*x+S+2];s<d&&(d=s),i<u&&(u=i),n<p&&(p=n),s>_&&(_=s),i>g&&(g=i),n>y&&(y=n)}o.set(d,u,p),h.set(_,g,y);const v=new De;v.setMinMax(o,h);const w=new Wc(e);w.vertexBuffer=a,w.indexBuffer[0]=c,w.primitive[0].type=4,w.primitive[0].base=0,w.primitive[0].count=l.length,w.primitive[0].indexed=!0,w.aabb=v;const T=new xd(w,s.material,s.node);T.isStatic=s.isStatic,T.visible=s.visible,T.layer=s.layer,T.castShadow=s.castShadow,T._receiveShadow=s._receiveShadow,T.cull=s.cull,T.pick=s.pick,T.mask=s.mask,T.parameters=s.parameters,T._shaderDefs=s._shaderDefs,T._staticSource=s,s._staticLightList?T._staticLightList=s._staticLightList:T._staticLightList=[];for(let e=0;e<m.length;e++){if(n&1<<e){const t=i[m[e]];T._staticLightList.indexOf(t)<0&&T._staticLightList.push(t)}}T._staticLightList.sort(_u.lightCompare),r.push(T)}}else r.push(s)}else r.push(s)}s.length=r.length;for(let e=0;e<r.length;e++)s[e]=r[e]}static revert(e){const t=e,s=t.length,i=[];let n;for(let e=0;e<s;e++){const s=t[e];s._staticSource?s._staticSource!==n&&(i.push(s._staticSource),n=s._staticSource):i.push(s)}e.length=i.length;for(let t=0;t<i.length;t++)e[t]=i[t]}}new ge(1,1,1),new ge(40,0,0);const gu=new Ce,yu=new Ce,vu=new ye,xu=new Ce;let bu;const Su=(new Ce).setScale(1,-1,1),wu=new Ce,Tu=new Ce,Mu=new ge,Cu=new ge,Au=new ge,Pu=new pe(254/255,254/255,254/255,254/255),Eu=new ke,Ru=[0,0,0,0];let Lu,Iu,Du,Ou,Fu,ku,Bu=0;const zu={drawCalls:[],isNewMaterial:[],lightMaskChanged:[]},Uu=new Set;class Vu{constructor(e){this.clustersDebugRendered=!1,this.device=e,this.scene=null,this._shadowDrawCalls=0,this._forwardDrawCalls=0,this._skinDrawCalls=0,this._numDrawCallsCulled=0,this._instancedDrawCalls=0,this._camerasRendered=0,this._materialSwitches=0,this._shadowMapUpdates=0,this._shadowMapTime=0,this._depthMapTime=0,this._forwardTime=0,this._cullTime=0,this._sortTime=0,this._skinTime=0,this._morphTime=0,this._layerCompositionUpdateTime=0,this._lightClustersTime=0,this._lightClusters=0;const t=this.device;this.library=t.getProgramLibrary(),this.lightTextureAtlas=new Jd(t),this._shadowRenderer=new mu(this,this.lightTextureAtlas),this._cookieRenderer=new qd(t,this.lightTextureAtlas);const s=t.scope;this.projId=s.resolve("matrix_projection"),this.projSkyboxId=s.resolve("matrix_projectionSkybox"),this.viewId=s.resolve("matrix_view"),this.viewId3=s.resolve("matrix_view3"),this.viewInvId=s.resolve("matrix_viewInverse"),this.viewProjId=s.resolve("matrix_viewProjection"),this.flipYId=s.resolve("projectionFlipY"),this.viewPos=new Float32Array(3),this.viewPosId=s.resolve("view_position"),this.nearClipId=s.resolve("camera_near"),this.farClipId=s.resolve("camera_far"),this.cameraParamsId=s.resolve("camera_params"),this.tbnBasis=s.resolve("tbnBasis"),this.fogColorId=s.resolve("fog_color"),this.fogStartId=s.resolve("fog_start"),this.fogEndId=s.resolve("fog_end"),this.fogDensityId=s.resolve("fog_density"),this.modelMatrixId=s.resolve("matrix_model"),this.normalMatrixId=s.resolve("matrix_normal"),this.poseMatrixId=s.resolve("matrix_pose[0]"),this.boneTextureId=s.resolve("texture_poseMap"),this.boneTextureSizeId=s.resolve("texture_poseMapSize"),this.morphWeightsA=s.resolve("morph_weights_a"),this.morphWeightsB=s.resolve("morph_weights_b"),this.morphPositionTex=s.resolve("morphPositionTex"),this.morphNormalTex=s.resolve("morphNormalTex"),this.morphTexParams=s.resolve("morph_tex_params"),this.alphaTestId=s.resolve("alpha_ref"),this.opacityMapId=s.resolve("texture_opacityMap"),this.ambientId=s.resolve("light_globalAmbient"),this.exposureId=s.resolve("exposure"),this.skyboxIntensityId=s.resolve("skyboxIntensity"),this.lightColorId=[],this.lightDir=[],this.lightDirId=[],this.lightShadowMapId=[],this.lightShadowMatrixId=[],this.lightShadowParamsId=[],this.lightShadowIntensity=[],this.lightRadiusId=[],this.lightPos=[],this.lightPosId=[],this.lightWidth=[],this.lightWidthId=[],this.lightHeight=[],this.lightHeightId=[],this.lightInAngleId=[],this.lightOutAngleId=[],this.lightCookieId=[],this.lightCookieIntId=[],this.lightCookieMatrixId=[],this.lightCookieOffsetId=[],this.shadowMatrixPaletteId=[],this.shadowCascadeDistancesId=[],this.shadowCascadeCountId=[],this.screenSizeId=s.resolve("uScreenSize"),this._screenSize=new Float32Array(4),this.twoSidedLightingNegScaleFactorId=s.resolve("twoSidedLightingNegScaleFactor"),this.fogColor=new Float32Array(3),this.ambientColor=new Float32Array(3),this.cameraParams=new Float32Array(4),this.viewUniformFormat=null,this.viewBindGroupFormat=null}destroy(){this._shadowRenderer.destroy(),this._shadowRenderer=null,this._cookieRenderer.destroy(),this._cookieRenderer=null,this.lightTextureAtlas.destroy(),this.lightTextureAtlas=null}sortCompare(e,t){if(e.layer===t.layer){if(e.drawOrder&&t.drawOrder)return e.drawOrder-t.drawOrder;if(e.zdist&&t.zdist)return t.zdist-e.zdist;if(e.zdist2&&t.zdist2)return e.zdist2-t.zdist2}return t._key[0]-e._key[0]}sortCompareMesh(e,t){if(e.layer===t.layer){if(e.drawOrder&&t.drawOrder)return e.drawOrder-t.drawOrder;if(e.zdist&&t.zdist)return t.zdist-e.zdist}return Fu=e._key[0],ku=t._key[0],Fu===ku&&e.mesh&&t.mesh?t.mesh.id-e.mesh.id:ku-Fu}depthSortCompare(e,t){return Fu=e._key[1],ku=t._key[1],Fu===ku&&e.mesh&&t.mesh?t.mesh.id-e.mesh.id:ku-Fu}updateCameraFrustum(e){if(e.xr&&e.xr.views.length){const t=e.xr.views[0];return xu.mul2(t.projMat,t.viewOffMat),void e.frustum.setFromMat4(xu)}if(bu=e.projectionMatrix,e.calculateProjection&&e.calculateProjection(bu,0),e.calculateTransform)e.calculateTransform(gu,0);else{const t=e._node.getPosition(),s=e._node.getRotation();gu.setTRS(t,s,ge.ONE),this.viewInvId.setValue(gu.data)}yu.copy(gu).invert(),xu.mul2(bu,yu),e.frustum.setFromMat4(xu)}initViewBindGroupFormat(){this.device.supportsUniformBuffers&&!this.viewUniformFormat&&(this.viewUniformFormat=new Ud(this.device,[new zd("matrix_viewProjection",14)]),this.viewBindGroupFormat=new Nd(this.device,[new Vd("default",3)],[]))}setCameraUniforms(e,t,s){let i,n=1;if(e.xr&&e.xr.session){const t=e._node.parent;t&&(i=t.getWorldTransform());const s=e.xr.views;n=s.length;for(let a=0;a<n;a++){const n=s[a];t?(n.viewInvOffMat.mul2(i,n.viewInvMat),n.viewOffMat.copy(n.viewInvOffMat).invert()):(n.viewInvOffMat.copy(n.viewInvMat),n.viewOffMat.copy(n.viewMat)),n.viewMat3.setFromMat4(n.viewOffMat),n.projViewOffMat.mul2(n.projMat,n.viewOffMat),n.position[0]=n.viewInvOffMat.data[12],n.position[1]=n.viewInvOffMat.data[13],n.position[2]=n.viewInvOffMat.data[14],e.frustum.setFromMat4(n.projViewOffMat)}}else{if(bu=e.projectionMatrix,e.calculateProjection&&e.calculateProjection(bu,0),this.projId.setValue(bu.data),this.projSkyboxId.setValue(e.getProjectionMatrixSkybox().data),e.calculateTransform)e.calculateTransform(gu,0);else{const t=e._node.getPosition(),s=e._node.getRotation();gu.setTRS(t,s,ge.ONE)}this.viewInvId.setValue(gu.data),yu.copy(gu).invert(),this.viewId.setValue(yu.data),vu.setFromMat4(yu),this.viewId3.setValue(vu.data),xu.mul2(bu,yu),t&&t.flipY?(wu.mul2(Su,xu),Tu.mul2(Su,e.getProjectionMatrixSkybox()),this.viewProjId.setValue(wu.data),this.projSkyboxId.setValue(Tu.data)):(this.viewProjId.setValue(xu.data),this.projSkyboxId.setValue(e.getProjectionMatrixSkybox().data)),this.flipYId.setValue(null!=t&&t.flipY?-1:1),this.dispatchViewPos(e._node.getPosition()),e.frustum.setFromMat4(xu)}this.tbnBasis.setValue(t&&t.flipY?-1:1),this.nearClipId.setValue(e._nearClip),this.farClipId.setValue(e._farClip);const a=e._nearClip,r=e._farClip;this.cameraParams[0]=1/r,this.cameraParams[1]=r,this.cameraParams[2]=a,this.cameraParams[3]=1===e.projection?1:0,this.cameraParamsId.setValue(this.cameraParams),this.device.supportsUniformBuffers&&this.setupViewUniformBuffers(s,n)}setCamera(e,t,s,i=null){this.setCameraUniforms(e,t,i),this.clearView(e,t,s,!1)}setupViewUniformBuffers(e,t){if(e){const s=this.device;for(;e.viewBindGroups.length<t;){const t=new ud(s,this.viewUniformFormat),i=new cd(s,this.viewBindGroupFormat,t);e.viewBindGroups.push(i)}const i=e.viewBindGroups[0];i.defaultUniformBuffer.update(),i.update(),s.setBindGroup(0,i)}}setupViewport(e,t){const s=this.device,i=t?t.width:s.width,n=t?t.height:s.height,a=e.rect;let r=Math.floor(a.x*i),o=Math.floor(a.y*n),h=Math.floor(a.z*i),l=Math.floor(a.w*n);if(s.setViewport(r,o,h,l),e._scissorRectClear){const t=e.scissorRect;r=Math.floor(t.x*i),o=Math.floor(t.y*n),h=Math.floor(t.z*i),l=Math.floor(t.w*n)}s.setScissor(r,o,h,l)}clear(e,t){this.device.clear({color:[t._clearColor.r,t._clearColor.g,t._clearColor.b,t._clearColor.a],depth:t._clearDepth,stencil:t._clearStencil,flags:(e.clearColor?1:0)|(e.clearDepth?2:0)|(e.clearStencil?4:0)})}clearView(e,t,s,i){const n=this.device;if(n.setRenderTarget(t),n.updateBegin(),i&&(n.setColorWrite(!0,!0,!0,!0),n.setDepthWrite(!0)),this.setupViewport(e,t),s){const t=e._clearOptions;n.clear(t||{color:[e._clearColor.r,e._clearColor.g,e._clearColor.b,e._clearColor.a],depth:e._clearDepth,flags:(e._clearColorBuffer?1:0)|(e._clearDepthBuffer?2:0)|(e._clearStencilBuffer?4:0),stencil:e._clearStencil})}}dispatchGlobalLights(e){if(this.ambientColor[0]=e.ambientLight.r,this.ambientColor[1]=e.ambientLight.g,this.ambientColor[2]=e.ambientLight.b,e.gammaCorrection)for(let e=0;e<3;e++)this.ambientColor[e]=Math.pow(this.ambientColor[e],2.2);this.ambientId.setValue(this.ambientColor),this.exposureId.setValue(e.exposure),e.sky&&this.skyboxIntensityId.setValue(e.skyboxIntensity)}_resolveLight(e,t){const s="light"+t;this.lightColorId[t]=e.resolve(s+"_color"),this.lightDir[t]=new Float32Array(3),this.lightDirId[t]=e.resolve(s+"_direction"),this.lightShadowMapId[t]=e.resolve(s+"_shadowMap"),this.lightShadowMatrixId[t]=e.resolve(s+"_shadowMatrix"),this.lightShadowParamsId[t]=e.resolve(s+"_shadowParams"),this.lightShadowIntensity[t]=e.resolve(s+"_shadowIntensity"),this.lightRadiusId[t]=e.resolve(s+"_radius"),this.lightPos[t]=new Float32Array(3),this.lightPosId[t]=e.resolve(s+"_position"),this.lightWidth[t]=new Float32Array(3),this.lightWidthId[t]=e.resolve(s+"_halfWidth"),this.lightHeight[t]=new Float32Array(3),this.lightHeightId[t]=e.resolve(s+"_halfHeight"),this.lightInAngleId[t]=e.resolve(s+"_innerConeAngle"),this.lightOutAngleId[t]=e.resolve(s+"_outerConeAngle"),this.lightCookieId[t]=e.resolve(s+"_cookie"),this.lightCookieIntId[t]=e.resolve(s+"_cookieIntensity"),this.lightCookieMatrixId[t]=e.resolve(s+"_cookieMatrix"),this.lightCookieOffsetId[t]=e.resolve(s+"_cookieOffset"),this.shadowMatrixPaletteId[t]=e.resolve(s+"_shadowMatrixPalette[0]"),this.shadowCascadeDistancesId[t]=e.resolve(s+"_shadowCascadeDistances[0]"),this.shadowCascadeCountId[t]=e.resolve(s+"_shadowCascadeCount")}setLTCDirectionalLight(e,t,s,i,n){this.lightPos[t][0]=i.x-s.x*n,this.lightPos[t][1]=i.y-s.y*n,this.lightPos[t][2]=i.z-s.z*n,this.lightPosId[t].setValue(this.lightPos[t]);const a=e.transformVector(new ge(-.5,0,0));this.lightWidth[t][0]=a.x*n,this.lightWidth[t][1]=a.y*n,this.lightWidth[t][2]=a.z*n,this.lightWidthId[t].setValue(this.lightWidth[t]);const r=e.transformVector(new ge(0,0,.5));this.lightHeight[t][0]=r.x*n,this.lightHeight[t][1]=r.y*n,this.lightHeight[t][2]=r.z*n,this.lightHeightId[t].setValue(this.lightHeight[t])}dispatchDirectLights(e,t,s,i){let n=0;const a=this.device.scope;for(let r=0;r<e.length;r++){if(!(e[r].mask&s))continue;const o=e[r],h=o._node.getWorldTransform();if(this.lightColorId[n]||this._resolveLight(a,n),this.lightColorId[n].setValue(t.gammaCorrection?o._linearFinalColor:o._finalColor),h.getY(o._direction).mulScalar(-1),o._direction.normalize(),this.lightDir[n][0]=o._direction.x,this.lightDir[n][1]=o._direction.y,this.lightDir[n][2]=o._direction.z,this.lightDirId[n].setValue(this.lightDir[n]),0!==o.shape&&this.setLTCDirectionalLight(h,n,o._direction,i._node.getPosition(),i.farClip),o.castShadows){const e=o.getRenderData(i,0),t=o._getUniformBiasValues(e);this.lightShadowMapId[n].setValue(e.shadowBuffer),this.lightShadowMatrixId[n].setValue(e.shadowMatrix.data),this.shadowMatrixPaletteId[n].setValue(o._shadowMatrixPalette),this.shadowCascadeDistancesId[n].setValue(o._shadowCascadeDistances),this.shadowCascadeCountId[n].setValue(o.numCascades),this.lightShadowIntensity[n].setValue(o.shadowIntensity);const s=o._shadowRenderParams;s.length=3,s[0]=o._shadowResolution,s[1]=t.normalBias,s[2]=t.bias,this.lightShadowParamsId[n].setValue(s)}n++}return n}setLTCPositionalLight(e,t){const s=e.transformVector(new ge(-.5,0,0));this.lightWidth[t][0]=s.x,this.lightWidth[t][1]=s.y,this.lightWidth[t][2]=s.z,this.lightWidthId[t].setValue(this.lightWidth[t]);const i=e.transformVector(new ge(0,0,.5));this.lightHeight[t][0]=i.x,this.lightHeight[t][1]=i.y,this.lightHeight[t][2]=i.z,this.lightHeightId[t].setValue(this.lightHeight[t])}dispatchOmniLight(e,t,s,i){const n=s._node.getWorldTransform();if(this.lightColorId[i]||this._resolveLight(t,i),this.lightRadiusId[i].setValue(s.attenuationEnd),this.lightColorId[i].setValue(e.gammaCorrection?s._linearFinalColor:s._finalColor),n.getTranslation(s._position),this.lightPos[i][0]=s._position.x,this.lightPos[i][1]=s._position.y,this.lightPos[i][2]=s._position.z,this.lightPosId[i].setValue(this.lightPos[i]),0!==s.shape&&this.setLTCPositionalLight(n,i),s.castShadows){const e=s.getRenderData(null,0);this.lightShadowMapId[i].setValue(e.shadowBuffer);const t=s._getUniformBiasValues(e),n=s._shadowRenderParams;n.length=4,n[0]=s._shadowResolution,n[1]=t.normalBias,n[2]=t.bias,n[3]=1/s.attenuationEnd,this.lightShadowParamsId[i].setValue(n),this.lightShadowIntensity[i].setValue(s.shadowIntensity)}s._cookie&&(this.lightCookieId[i].setValue(s._cookie),this.lightShadowMatrixId[i].setValue(n.data),this.lightCookieIntId[i].setValue(s.cookieIntensity))}dispatchSpotLight(e,t,s,i){const n=s._node.getWorldTransform();if(this.lightColorId[i]||this._resolveLight(t,i),this.lightInAngleId[i].setValue(s._innerConeAngleCos),this.lightOutAngleId[i].setValue(s._outerConeAngleCos),this.lightRadiusId[i].setValue(s.attenuationEnd),this.lightColorId[i].setValue(e.gammaCorrection?s._linearFinalColor:s._finalColor),n.getTranslation(s._position),this.lightPos[i][0]=s._position.x,this.lightPos[i][1]=s._position.y,this.lightPos[i][2]=s._position.z,this.lightPosId[i].setValue(this.lightPos[i]),0!==s.shape&&this.setLTCPositionalLight(n,i),n.getY(s._direction).mulScalar(-1),s._direction.normalize(),this.lightDir[i][0]=s._direction.x,this.lightDir[i][1]=s._direction.y,this.lightDir[i][2]=s._direction.z,this.lightDirId[i].setValue(this.lightDir[i]),s.castShadows){const e=s.getRenderData(null,0);this.lightShadowMapId[i].setValue(e.shadowBuffer),this.lightShadowMatrixId[i].setValue(e.shadowMatrix.data);const t=s._getUniformBiasValues(e),n=s._shadowRenderParams;n.length=4,n[0]=s._shadowResolution,n[1]=t.normalBias,n[2]=t.bias,n[3]=1/s.attenuationEnd,this.lightShadowParamsId[i].setValue(n),this.lightShadowIntensity[i].setValue(s.shadowIntensity)}if(s._cookie){if(!s.castShadows){const e=Vh.evalSpotCookieMatrix(s);this.lightShadowMatrixId[i].setValue(e.data)}this.lightCookieId[i].setValue(s._cookie),this.lightCookieIntId[i].setValue(s.cookieIntensity),s._cookieTransform&&(s._cookieTransformUniform[0]=s._cookieTransform.x,s._cookieTransformUniform[1]=s._cookieTransform.y,s._cookieTransformUniform[2]=s._cookieTransform.z,s._cookieTransformUniform[3]=s._cookieTransform.w,this.lightCookieMatrixId[i].setValue(s._cookieTransformUniform),s._cookieOffsetUniform[0]=s._cookieOffset.x,s._cookieOffsetUniform[1]=s._cookieOffset.y,this.lightCookieOffsetId[i].setValue(s._cookieOffsetUniform))}}dispatchLocalLights(e,t,s,i,n){let a=i;const r=this.device.scope,o=e[1],h=o.length;for(let e=0;e<h;e++){const i=o[e];i.mask&s&&(i.isStatic||(this.dispatchOmniLight(t,r,i,a),a++))}let l=0;if(n){let e=n[l];for(;e&&1===e._type;)this.dispatchOmniLight(t,r,e,a),a++,l++,e=n[l]}const c=e[2],d=c.length;for(let e=0;e<d;e++){const i=c[e];i.mask&s&&(i.isStatic||(this.dispatchSpotLight(t,r,i,a),a++))}if(n){let e=n[l];for(;e&&2===e._type;)this.dispatchSpotLight(t,r,e,a),a++,l++,e=n[l]}}cull(e,t,s){let i=0;const n=t.length,a=e.cullingMask||4294967295;if(!e.frustumCulling){for(let e=0;e<n;e++){const n=t[e];(n.visible||n.command)&&(n.mask&&0==(n.mask&a)||(s[i]=n,i++,n.visibleThisFrame=!0))}return i}for(let r=0;r<n;r++){const n=t[r];if(n.command)s[i]=n,i++,n.visibleThisFrame=!0;else{if(!n.visible)continue;let t=!0;if(n.mask&&0==(n.mask&a))continue;n.cull&&(t=n._isVisible(e)),t&&(s[i]=n,i++,n.visibleThisFrame=!0)}}return i}cullLights(e,t){const s=this.scene.clusteredLightingEnabled;for(let i=0;i<t.length;i++){const n=t[i];if(n.enabled&&0!==n._type)if(n.getBoundingSphere(Eu),e.frustum.containsSphere(Eu)){n.visibleThisFrame=!0;const t=e.getScreenSize(Eu);n.maxScreenSize=Math.max(n.maxScreenSize,t)}else s||n.castShadows&&!n.shadowMap&&(n.visibleThisFrame=!0)}}updateCpuSkinMatrices(e){Bu++;const t=e.length;if(0!==t)for(let s=0;s<t;s++){const t=e[s].skinInstance;t&&(t.updateMatrices(e[s].node,Bu),t._dirty=!0)}}updateGpuSkinMatrices(e){const t=e.length;for(let s=0;s<t;s++){if(!e[s].visibleThisFrame)continue;const t=e[s].skinInstance;t&&t._dirty&&(t.updateMatrixPalette(e[s].node,Bu),t._dirty=!1)}}updateMorphing(e){const t=e.length;for(let s=0;s<t;s++){const t=e[s].morphInstance;t&&t._dirty&&e[s].visibleThisFrame&&t.update()}}setBaseConstants(e,t){e.setCullMode(t.cull),t.opacityMap&&(this.opacityMapId.setValue(t.opacityMap),this.alphaTestId.setValue(t.alphaTest))}setSkinning(e,t,s){t.skinInstance&&(this._skinDrawCalls++,e.supportsBoneTextures?(Lu=t.skinInstance.boneTexture,this.boneTextureId.setValue(Lu),Ru[0]=Lu.width,Ru[1]=Lu.height,Ru[2]=1/Lu.width,Ru[3]=1/Lu.height,this.boneTextureSizeId.setValue(Ru)):this.poseMatrixId.setValue(t.skinInstance.matrixPalette))}drawInstance(e,t,s,i,n){Iu=t.instancingData,Iu?Iu.count>0&&(this._instancedDrawCalls++,e.setVertexBuffer(Iu.vertexBuffer),e.draw(s.primitive[i],Iu.count)):(Du=t.node.worldTransform,this.modelMatrixId.setValue(Du.data),n&&(Ou=t.node.normalMatrix,t.node._dirtyNormal&&(Du.invertTo3x3(Ou),Ou.transpose(),t.node._dirtyNormal=!1),this.normalMatrixId.setValue(Ou.data)),e.draw(s.primitive[i]))}drawInstance2(e,t,s,i){Iu=t.instancingData,Iu?Iu.count>0&&(this._instancedDrawCalls++,e.draw(s.primitive[i],Iu.count,!0)):e.draw(s.primitive[i],void 0,!0)}renderShadows(e,t){const s=this.scene.clusteredLightingEnabled;for(let i=0;i<e.length;i++){const n=e[i];if(s&&0!==n._type){if(!n.atlasViewportAllocated)continue;n.atlasSlotUpdated&&0===n.shadowUpdateMode&&(n.shadowUpdateMode=1)}this._shadowRenderer.render(n,t)}}renderCookies(e){const t=this.lightTextureAtlas.cookieRenderTarget;for(let s=0;s<e.length;s++){const i=e[s];i.atlasViewportAllocated&&(i.atlasSlotUpdated&&this._cookieRenderer.render(i,t))}}setCullMode(e,t,s){const i=s.material;let n=0;if(e){let e=1;if(i.cull>0&&i.cull<3){s.flipFaces&&(e*=-1),t&&(e*=-1);const i=s.node.worldTransform;i.getX(Mu),i.getY(Cu),i.getZ(Au),Mu.cross(Mu,Cu),Mu.dot(Au)<0&&(e*=-1)}n=e<0?2===i.cull?1:2:i.cull}if(this.device.setCullMode(n),0===n&&0===i.cull){const e=s.node.worldTransform;e.getX(Mu),e.getY(Cu),e.getZ(Au),Mu.cross(Mu,Cu),Mu.dot(Au)<0?this.twoSidedLightingNegScaleFactorId.setValue(-1):this.twoSidedLightingNegScaleFactorId.setValue(1)}}setVertexBuffers(e,t){e.setVertexBuffer(t.vertexBuffer)}setMorphing(e,t){if(t)if(t.morph.useTextureMorph)e.setVertexBuffer(t.morph.vertexBufferIds),this.morphPositionTex.setValue(t.texturePositions),this.morphNormalTex.setValue(t.textureNormals),this.morphTexParams.setValue(t._textureParams);else{for(let s=0;s<t._activeVertexBuffers.length;s++){const i=t._activeVertexBuffers[s];if(i){const t="ATTR"+(s+8);i.format.elements[0].name=t,i.format.elements[0].scopeId=e.scope.resolve(t),i.format.update(),e.setVertexBuffer(i)}}this.morphWeightsA.setValue(t._shaderMorphWeightsA),this.morphWeightsB.setValue(t._shaderMorphWeightsB)}}dispatchViewPos(e){const t=this.viewPos;t[0]=e.x,t[1]=e.y,t[2]=e.z,this.viewPosId.setValue(t)}renderForwardPrepareMaterials(e,t,s,i,n,a,r){const o=(e,t,s)=>{zu.drawCalls.push(e),zu.isNewMaterial.push(t),zu.lightMaskChanged.push(s)};zu.drawCalls.length=0,zu.isNewMaterial.length=0,zu.lightMaskChanged.length=0;const h=this.device,l=this.scene,c=a?a._lightHash:0;let d,u,p,m=null;for(let e=0;e<s;e++){const s=t[e];if(!n||!s.mask||n&s.mask)if(s.command)o(s,!1,!1);else{s.ensureMaterial(h);const e=s.material,t=s._shaderDefs,n=s.mask;if(e&&e===m&&t!==d&&(m=null),(s.isStatic||u)&&(m=null),e!==m&&(this._materialSwitches++,e._scene=l,e.dirty&&(e.updateUniforms(h,l),e.dirty=!1),e._dirtyBlend&&(l.layers._dirtyBlend=!0),!s._shader[r]||s._shaderDefs!==t||s._lightHash!==c)){if(s.isStatic)s.updatePassShader(l,r,s._staticLightList,i,this.viewUniformFormat,this.viewBindGroupFormat);else{const n=r+"_"+t+"_"+c;s._shader[r]=e.variants[n],s._shader[r]||(s.updatePassShader(l,r,null,i,this.viewUniformFormat,this.viewBindGroupFormat),e.variants[n]=s._shader[r])}s._lightHash=c}o(s,e!==m,!m||n!==p),m=e,d=t,p=n,u=s.isStatic}}return zu}renderForwardInternal(e,t,s,i,n,a){const r=this.device,o=r.supportsUniformBuffers,h=this.scene,l=1<<i,c=t.drawCalls.length;for(let d=0;d<c;d++){const u=t.drawCalls[d];if(u.command)u.command();else{const p=t.isNewMaterial[d],m=t.lightMaskChanged[d],f=u.material;u._shaderDefs;const _=u.mask;if(p){const t=u._shader[i];if(!t.failed&&r.setShader(t),f.setParameters(r),m){const t=this.dispatchDirectLights(s[0],h,_,e);this.dispatchLocalLights(s,h,_,t,u._staticLightList)}this.alphaTestId.setValue(f.alphaTest),r.setBlending(f.blend),f.blend&&(f.separateAlphaBlend?(r.setBlendFunctionSeparate(f.blendSrc,f.blendDst,f.blendSrcAlpha,f.blendDstAlpha),r.setBlendEquationSeparate(f.blendEquation,f.blendAlphaEquation)):(r.setBlendFunction(f.blendSrc,f.blendDst),r.setBlendEquation(f.blendEquation))),r.setColorWrite(f.redWrite,f.greenWrite,f.blueWrite,f.alphaWrite),r.setDepthWrite(f.depthWrite),f.depthWrite&&!f.depthTest?(r.setDepthFunc(7),r.setDepthTest(!0)):(r.setDepthFunc(f.depthFunc),r.setDepthTest(f.depthTest)),r.setAlphaToCoverage(f.alphaToCoverage),f.depthBias||f.slopeDepthBias?(r.setDepthBias(!0),r.setDepthBiasValues(f.depthBias,f.slopeDepthBias)):r.setDepthBias(!1)}this.setCullMode(e._cullFaces,a,u);const g=u.stencilFront||f.stencilFront,y=u.stencilBack||f.stencilBack;g||y?(r.setStencilTest(!0),g===y?(r.setStencilFunc(g.func,g.ref,g.readMask),r.setStencilOperation(g.fail,g.zfail,g.zpass,g.writeMask)):(g?(r.setStencilFuncFront(g.func,g.ref,g.readMask),r.setStencilOperationFront(g.fail,g.zfail,g.zpass,g.writeMask)):(r.setStencilFuncFront(7,0,255),r.setStencilOperationFront(0,0,0,255)),y?(r.setStencilFuncBack(y.func,y.ref,y.readMask),r.setStencilOperationBack(y.fail,y.zfail,y.zpass,y.writeMask)):(r.setStencilFuncBack(7,0,255),r.setStencilOperationBack(0,0,0,255)))):r.setStencilTest(!1);const v=u.mesh;if(u.setParameters(r,l),this.setVertexBuffers(r,v),this.setMorphing(r,u.morphInstance),this.setSkinning(r,u,f),o){this.modelMatrixId.setValue(u.node.worldTransform.data);const e=u.getBindGroup(r,i);e.defaultUniformBuffer.update(),e.update(),r.setBindGroup(1,e)}const x=u.renderStyle;if(r.setIndexBuffer(v.indexBuffer[x]),n&&n(u,d),e.xr&&e.xr.session&&e.xr.views.length){const t=e.xr.views;for(let e=0;e<t.length;e++){const s=t[e];r.setViewport(s.viewport.x,s.viewport.y,s.viewport.z,s.viewport.w),this.projId.setValue(s.projMat.data),this.projSkyboxId.setValue(s.projMat.data),this.viewId.setValue(s.viewOffMat.data),this.viewInvId.setValue(s.viewInvOffMat.data),this.viewId3.setValue(s.viewMat3.data),this.viewProjId.setValue(s.projViewOffMat.data),this.viewPosId.setValue(s.position),0===e?this.drawInstance(r,u,v,x,!0):this.drawInstance2(r,u,v,x),this._forwardDrawCalls++}}else this.drawInstance(r,u,v,x,!0),this._forwardDrawCalls++;d<c-1&&!t.isNewMaterial[d+1]&&f.setParameters(r,u.parameters)}}}renderForward(e,t,s,i,n,a,r,o,h){const l=this.renderForwardPrepareMaterials(e,t,s,i,a,o,n);this.renderForwardInternal(e,l,i,n,r,h),zu.length=0}updateShaders(e,t){const s=e.length;for(let i=0;i<s;i++){const s=e[i].material;if(s&&!Uu.has(s)&&(Uu.add(s),s.getShaderVariant!==Al.prototype.getShaderVariant)){if(t&&(!s.useLighting||s.emitter&&!s.emitter.lighting))continue;s.clearVariants()}}Uu.clear()}beginFrame(e,t){const s=e._meshInstances,i=this.scene;if(i.updateShaders||t){const e=!i.updateShaders&&t;this.updateShaders(s,e),i.updateShaders=!1,i._shaderVersion++}this.updateCpuSkinMatrices(s);const n=s.length;for(let e=0;e<n;e++)s[e].visibleThisFrame=!1;const a=e._lights,r=a.length;for(let e=0;e<r;e++)a[e].beginFrame()}updateLayerComposition(e,t){const s=e.layerList.length;for(let t=0;t<s;t++)e.layerList[t]._postRenderCounter=0;const i=this.scene,n=i._shaderVersion;for(let t=0;t<s;t++){const s=e.layerList[t];s._shaderVersion=n,s._preRenderCalledForCameras=0,s._postRenderCalledForCameras=0;const a=e.subLayerList[t];s._postRenderCounter|=a?2:1,s._postRenderCounterMax=s._postRenderCounter;for(let e=0;e<s.cameras.length;e++)s.instances.prepare(e);s._needsStaticPrepare&&s._staticLightHash&&!this.scene.clusteredLightingEnabled&&(s._staticPrepareDone&&(_u.revert(s.opaqueMeshInstances),_u.revert(s.transparentMeshInstances)),_u.prepare(this.device,i,s.opaqueMeshInstances,s._lights),_u.prepare(this.device,i,s.transparentMeshInstances,s._lights),e._dirty=!0,i.updateShaders=!0,s._needsStaticPrepare=!1,s._staticPrepareDone=!0)}return e._update(this.device,t)}gpuUpdate(e){this.updateGpuSkinMatrices(e),this.updateMorphing(e)}setSceneConstants(){const e=this.scene;if(this.dispatchGlobalLights(e),"none"!==e.fog){if(this.fogColor[0]=e.fogColor.r,this.fogColor[1]=e.fogColor.g,this.fogColor[2]=e.fogColor.b,e.gammaCorrection)for(let e=0;e<3;e++)this.fogColor[e]=Math.pow(this.fogColor[e],2.2);this.fogColorId.setValue(this.fogColor),"linear"===e.fog?(this.fogStartId.setValue(e.fogStart),this.fogEndId.setValue(e.fogEnd)):this.fogDensityId.setValue(e.fogDensity)}const t=this.device;this._screenSize[0]=t.width,this._screenSize[1]=t.height,this._screenSize[2]=1/t.width,this._screenSize[3]=1/t.height,this.screenSizeId.setValue(this._screenSize)}updateLightStats(e,t){}cullShadowmaps(e){for(let t=0;t<e._lights.length;t++){const s=e._lights[t];if(0!==s._type&&s.visibleThisFrame&&s.castShadows&&0!==s.shadowUpdateMode){const i=e._lightCompositionData[t].shadowCastersList;this._shadowRenderer.cullLocal(s,i)}}const t=e._renderActions;for(let s=0;s<t.length;s++){const i=t[s],n=i.directionalLightsIndices.length;for(let t=0;t<n;t++){const s=i.directionalLightsIndices[t],n=e._lights[s],a=e._lightCompositionData[s].shadowCastersList;this._shadowRenderer.cullDirectional(n,a,i.camera.camera)}}}cullComposition(e){const t=e._renderActions;for(let s=0;s<t.length;s++){const i=t[s],n=i.layerIndex,a=e.layerList[n];if(!a.enabled||!e.subLayerEnabled[n])continue;const r=e.subLayerList[n],o=i.cameraIndex,h=a.cameras[o];if(h){h.frameUpdate(i.renderTarget),i.firstCameraUse&&(this.updateCameraFrustum(h.camera),this._camerasRendered++),this.cullLights(h.camera,a._lights);const e=a.instances,t=r?e.visibleTransparent[o]:e.visibleOpaque[o];if(!t.done){a.onPreCull&&a.onPreCull(o);const e=r?a.transparentMeshInstances:a.opaqueMeshInstances;t.length=this.cull(h.camera,e,t.list),t.done=!0,a.onPostCull&&a.onPostCull(o)}}}this.cullShadowmaps(e)}updateLightTextureAtlas(e){this.lightTextureAtlas.update(e._splitLights[2],e._splitLights[1],this.scene.lighting)}updateClusters(e){for(let t=0;t<e._worldClusters.length;t++){e._worldClusters[t].update(e._lights,this.scene.gammaCorrection,this.scene.lighting)}}buildFrameGraph(e,t){e.reset(),this.update(t);const s=this.scene.clusteredLightingEnabled;if(s){this.updateLightTextureAtlas(t);const s=new Hd(this.device,(()=>{this.scene.lighting.cookiesEnabled&&(this.renderCookies(t._splitLights[2]),this.renderCookies(t._splitLights[1]))}));s.requiresCubemaps=!1,e.addRenderPass(s)}const i=new Hd(this.device,(()=>{(!s||s&&this.scene.lighting.shadowsEnabled)&&(this.renderShadows(t._splitLights[2]),this.renderShadows(t._splitLights[1])),s&&this.updateClusters(t)}));i.requiresCubemaps=!1,e.addRenderPass(i);let n=0,a=!0,r=null;const o=t._renderActions;for(let s=n;s<o.length;s++){const i=o[s],h=t.layerList[i.layerIndex],l=h.cameras[i.cameraIndex];if(!i.isLayerEnabled(t))continue;const c=1===h.id&&(l.renderSceneColorMap||l.renderSceneDepthMap);if(i.hasDirectionalShadowLights&&l){const s=new Hd(this.device,(()=>{this.renderPassDirectionalShadows(i,t)}));s.requiresCubemaps=!1,e.addRenderPass(s)}a&&(a=!1,n=s,r=i.renderTarget);let d=s+1;for(;o[d]&&!o[d].isLayerEnabled(t);)d++;const u=o[d],p=!!u&&1===t.layerList[u.layerIndex].id&&(l.renderSceneColorMap||l.renderSceneDepthMap);if(!u||u.renderTarget!==r||u.hasDirectionalShadowLights||p||c){if(this.addMainRenderPass(e,t,r,n,s,c),i.triggerPostprocess&&null!=l&&l.onPostprocessing){const s=new Hd(this.device,(()=>{this.renderPassPostprocessing(i,t)}));s.requiresCubemaps=!1,e.addRenderPass(s)}a=!0}}}addMainRenderPass(e,t,s,i,n,a){const r={start:i,end:n},o=new Hd(this.device,(()=>{this.renderPassRenderActions(t,r)})),h=t._renderActions[i],l=t.layerList[h.layerIndex].cameras[h.cameraIndex],c=a&&!this.device.webgl2&&l.renderSceneDepthMap;(!a||c)&&(o.init(s),o.fullSizeClearRect=l.camera.fullSizeClearRect,c?(o.setClearColor(Pu),o.setClearDepth(1)):o.fullSizeClearRect&&(h.clearColor&&o.setClearColor(l.camera.clearColor),h.clearDepth&&o.setClearDepth(l.camera.clearDepth),h.clearStencil&&o.setClearStencil(l.camera.clearStencil))),e.addRenderPass(o)}update(e){const t=this.scene.clusteredLightingEnabled;this.clustersDebugRendered=!1,this.initViewBindGroupFormat(),this.scene._updateSky(this.device);const s=this.updateLayerComposition(e,t),i=0!=(2&s);this.updateLightStats(e,s),this.beginFrame(e,i),this.setSceneConstants(),this.cullComposition(e),this.gpuUpdate(e._meshInstances)}renderPassDirectionalShadows(e,t){const s=t.layerList[e.layerIndex].cameras[e.cameraIndex];this.renderShadows(e.directionalLights,s.camera)}renderPassPostprocessing(e,t){t.layerList[e.layerIndex].cameras[e.cameraIndex].onPostprocessing()}renderPassRenderActions(e,t){const s=e._renderActions;for(let i=t.start;i<=t.end;i++)this.renderRenderAction(e,s[i],i===t.start)}renderRenderAction(e,t,s){const i=this.scene.clusteredLightingEnabled,n=this.device,a=t.layerIndex,r=e.layerList[a],o=e.subLayerList[a],h=t.cameraIndex,l=r.cameras[h];if(t.isLayerEnabled(e)){if(l&&t.firstCameraUse&&l.onPreRender&&l.onPreRender(),!o&&r.onPreRenderOpaque?r.onPreRenderOpaque(h):o&&r.onPreRenderTransparent&&r.onPreRenderTransparent(h),r._preRenderCalledForCameras&1<<h||(r.onPreRender&&r.onPreRender(h),r._preRenderCalledForCameras|=1<<h),l){var c;this.setupViewport(l.camera,t.renderTarget),s&&l.camera.fullSizeClearRect||this.clear(t,l.camera),r._sortVisible(o,l.camera.node,h);const e=r.instances,a=o?e.visibleTransparent[h]:e.visibleOpaque[h];this.scene.immediate.onPreRenderLayer(r,a,o),this.scene._activeCamera=l.camera,this.setCameraUniforms(l.camera,t.renderTarget,t),i&&t.lightClusters&&(t.lightClusters.activate(this.lightTextureAtlas),this.clustersDebugRendered||this.scene.lighting.debugLayer!==r.id||(this.clustersDebugRendered=!0));const d=!!(l.camera._flipFaces^(null==t||null==(c=t.renderTarget)?void 0:c.flipY)),u=this._forwardDrawCalls;this.renderForward(l.camera,a.list,a.length,r._splitLights,r.shaderPass,r.cullingMask,r.onDrawCall,r,d),r._forwardDrawCalls+=this._forwardDrawCalls-u,n.setColorWrite(!0,!0,!0,!0),n.setStencilTest(!1),n.setAlphaToCoverage(!1),n.setDepthBias(!1),t.lastCameraUse&&l.onPostRender&&l.onPostRender()}!o&&r.onPostRenderOpaque?r.onPostRenderOpaque(h):o&&r.onPostRenderTransparent&&r.onPostRenderTransparent(h),!r.onPostRender||r._postRenderCalledForCameras&1<<h||(r._postRenderCounter&=~(o?2:1),0===r._postRenderCounter&&(r.onPostRender(h),r._postRenderCalledForCameras|=1<<h,r._postRenderCounter=r._postRenderCounterMax))}}}let Nu,Gu,Wu,Hu;const Xu=[null,function(e,t){return e.drawOrder-t.drawOrder},function(e,t){return Nu=e._key[0],Gu=t._key[0],Nu===Gu&&e.mesh&&t.mesh?t.mesh.id-e.mesh.id:Gu-Nu},function(e,t){return t.zdist-e.zdist},function(e,t){return e.zdist-t.zdist}];function qu(e,t){return t.key-e.key}let ju=0;class Yu{constructor(){this.list=[],this.length=0,this.done=!1}}class $u{constructor(){this.opaqueMeshInstances=[],this.transparentMeshInstances=[],this.shadowCasters=[],this.visibleOpaque=[],this.visibleTransparent=[]}prepare(e){this.visibleOpaque[e]||(this.visibleOpaque[e]=new Yu),this.visibleTransparent[e]||(this.visibleTransparent[e]=new Yu),this.visibleOpaque[e].done=!1,this.visibleTransparent[e].done=!1}delete(e){e<this.visibleOpaque.length&&this.visibleOpaque.splice(e,1),e<this.visibleTransparent.length&&this.visibleTransparent.splice(e,1)}}class Ku{constructor(e={}){void 0!==e.id?(this.id=e.id,ju=Math.max(this.id+1,ju)):this.id=ju++,this.name=e.name,this._enabled=void 0===e.enabled||e.enabled,this._refCounter=this._enabled?1:0,this.opaqueSortMode=void 0===e.opaqueSortMode?2:e.opaqueSortMode,this.transparentSortMode=void 0===e.transparentSortMode?3:e.transparentSortMode,e.renderTarget&&(this.renderTarget=e.renderTarget),this.shaderPass=void 0===e.shaderPass?0:e.shaderPass,this.passThrough=void 0!==e.passThrough&&e.passThrough,this._clearColorBuffer=!!e.clearColorBuffer,this._clearDepthBuffer=!!e.clearDepthBuffer,this._clearStencilBuffer=!!e.clearStencilBuffer,this.onPreCull=e.onPreCull,this.onPreRender=e.onPreRender,this.onPreRenderOpaque=e.onPreRenderOpaque,this.onPreRenderTransparent=e.onPreRenderTransparent,this.onPostCull=e.onPostCull,this.onPostRender=e.onPostRender,this.onPostRenderOpaque=e.onPostRenderOpaque,this.onPostRenderTransparent=e.onPostRenderTransparent,this.onDrawCall=e.onDrawCall,this.onEnable=e.onEnable,this.onDisable=e.onDisable,this._enabled&&this.onEnable&&this.onEnable(),this.layerReference=e.layerReference,this.instances=e.layerReference?e.layerReference.instances:new $u,this.cullingMask=e.cullingMask?e.cullingMask:4294967295,this.opaqueMeshInstances=this.instances.opaqueMeshInstances,this.transparentMeshInstances=this.instances.transparentMeshInstances,this.shadowCasters=this.instances.shadowCasters,this.customSortCallback=null,this.customCalculateSortValues=null,this._lights=[],this._lightsSet=new Set,this._clusteredLightsSet=new Set,this._splitLights=[[],[],[]],this.cameras=[],this._dirty=!1,this._dirtyLights=!1,this._dirtyCameras=!1,this._lightHash=0,this._staticLightHash=0,this._needsStaticPrepare=!0,this._staticPrepareDone=!1,this._shaderVersion=-1,this._lightCube=null}get hasClusteredLights(){return this._clusteredLightsSet.size>0}set renderTarget(e){this._renderTarget=e,this._dirtyCameras=!0}get renderTarget(){return this._renderTarget}set enabled(e){e!==this._enabled&&(this._enabled=e,e?(this.incrementCounter(),this.onEnable&&this.onEnable()):(this.decrementCounter(),this.onDisable&&this.onDisable()))}get enabled(){return this._enabled}set clearColorBuffer(e){this._clearColorBuffer=e,this._dirtyCameras=!0}get clearColorBuffer(){return this._clearColorBuffer}set clearDepthBuffer(e){this._clearDepthBuffer=e,this._dirtyCameras=!0}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencilBuffer(e){this._clearStencilBuffer=e,this._dirtyCameras=!0}get clearStencilBuffer(){return this._clearStencilBuffer}get clusteredLightsSet(){return this._clusteredLightsSet}incrementCounter(){0===this._refCounter&&(this._enabled=!0,this.onEnable&&this.onEnable()),this._refCounter++}decrementCounter(){if(1===this._refCounter)this._enabled=!1,this.onDisable&&this.onDisable();else if(0===this._refCounter)return;this._refCounter--}addMeshInstances(e,t){const s=this._shaderVersion,i=this.shadowCasters;for(let n=0;n<e.length;n++){const a=e[n],r=a.material,o=3===r.blendType?this.opaqueMeshInstances:this.transparentMeshInstances;this.opaqueMeshInstances.indexOf(a)<0&&this.transparentMeshInstances.indexOf(a)<0&&o.push(a),!t&&a.castShadow&&i.indexOf(a)<0&&i.push(a),!this.passThrough&&s>=0&&r._shaderVersion!==s&&(r.getShaderVariant!==Al.prototype.getShaderVariant&&r.clearVariants(),r._shaderVersion=s)}this.passThrough||(this._dirty=!0)}removeMeshInstanceFromArray(e,t){let s=-1,i=0;const n=t.length;for(let a=0;a<n;a++){const n=t[a];if(n===e){s=a,i=1;break}if(n._staticSource===e)s<0&&(s=a),i++;else if(s>=0)break}s>=0&&t.splice(s,i)}removeMeshInstances(e,t){const s=this.opaqueMeshInstances,i=this.transparentMeshInstances,n=this.shadowCasters;for(let a=0;a<e.length;a++){const r=e[a];if(this.removeMeshInstanceFromArray(r,s),this.removeMeshInstanceFromArray(r,i),!t){const e=n.indexOf(r);e>=0&&n.splice(e,1)}}this._dirty=!0}clearMeshInstances(e){(0!==this.opaqueMeshInstances.length||0!==this.transparentMeshInstances.length||!e&&0!==this.shadowCasters.length)&&(this.opaqueMeshInstances.length=0,this.transparentMeshInstances.length=0,e||(this.shadowCasters.length=0),this.passThrough||(this._dirty=!0))}addLight(e){const t=e.light;this._lightsSet.has(t)||(this._lightsSet.add(t),0!==t.type&&this._clusteredLightsSet.add(t),this._lights.push(t),this._dirtyLights=!0,this._generateLightHash())}removeLight(e){const t=e.light;this._lightsSet.has(t)&&(this._lightsSet.delete(t),0!==t.type&&this._clusteredLightsSet.delete(t),this._lights.splice(this._lights.indexOf(t),1),this._dirtyLights=!0,this._generateLightHash())}clearLights(){this._lightsSet.clear(),this._clusteredLightsSet.clear(),this._lights.length=0,this._dirtyLights=!0}addShadowCasters(e){const t=this.shadowCasters;for(let s=0;s<e.length;s++){const i=e[s];i.castShadow&&(t.indexOf(i)<0&&t.push(i))}this._dirtyLights=!0}removeShadowCasters(e){const t=this.shadowCasters;for(let s=0;s<e.length;s++){const i=t.indexOf(e[s]);i>=0&&t.splice(i,1)}this._dirtyLights=!0}_generateLightHash(){if(this._lights.length>0){this._lights.sort(qu);let e="",t="";for(let s=0;s<this._lights.length;s++)this._lights[s].isStatic?t+=this._lights[s].key:e+=this._lights[s].key;0===e.length?this._lightHash=0:this._lightHash=_o(e),0===t.length?this._staticLightHash=0:this._staticLightHash=_o(t)}else this._lightHash=0,this._staticLightHash=0}addCamera(e){this.cameras.indexOf(e)>=0||(this.cameras.push(e),this._dirtyCameras=!0)}removeCamera(e){const t=this.cameras.indexOf(e);t>=0&&(this.cameras.splice(t,1),this._dirtyCameras=!0,this.instances.delete(t))}clearCameras(){this.cameras.length=0,this._dirtyCameras=!0}_calculateSortDistances(e,t,s,i){for(let n=0;n<t;n++){const t=e[n];if(t.command)continue;if(t.layer<=2)continue;if(t.calculateSortDistance){t.zdist=t.calculateSortDistance(t,s,i);continue}const a=t.aabb.center,r=a.x-s.x,o=a.y-s.y,h=a.z-s.z;t.zdist=r*i.x+o*i.y+h*i.z}}_sortVisible(e,t,s){const i=this.instances,n=e?this.transparentSortMode:this.opaqueSortMode;if(0===n)return;const a=e?i.visibleTransparent[s]:i.visibleOpaque[s];5===n?(Wu=t.getPosition(),Hu=t.forward,this.customCalculateSortValues&&this.customCalculateSortValues(a.list,a.length,Wu,Hu),a.list.length!==a.length&&(a.list.length=a.length),this.customSortCallback&&a.list.sort(this.customSortCallback)):(3!==n&&4!==n||(Wu=t.getPosition(),Hu=t.forward,this._calculateSortDistances(a.list,a.length,Wu,Hu)),a.list.length!==a.length&&(a.list.length=a.length),a.list.sort(Xu[n]))}}const Zu=function(e,t){if(e.size!==t.size)return!1;for(const s of e)if(!t.has(s))return!1;return!0},Qu=(e,t)=>e.priority-t.priority,Ju=e=>e.sort(Qu);class ep{constructor(){this.layerIndex=0,this.cameraIndex=0,this.camera=null,this.renderTarget=null,this.lightClusters=null,this.clearColor=!1,this.clearDepth=!1,this.clearStencil=!1,this.triggerPostprocess=!1,this.firstCameraUse=!1,this.lastCameraUse=!1,this.directionalLightsSet=new Set,this.directionalLights=[],this.directionalLightsIndices=[],this.viewBindGroups=[]}destroy(){this.viewBindGroups.forEach((e=>{e.defaultUniformBuffer.destroy(),e.destroy()})),this.viewBindGroups.length=0}get hasDirectionalShadowLights(){return this.directionalLights.length>0}reset(){this.lightClusters=null,this.directionalLightsSet.clear(),this.directionalLights.length=0,this.directionalLightsIndices.length=0}isLayerEnabled(e){return e.layerList[this.layerIndex].enabled&&e.subLayerEnabled[this.layerIndex]}collectDirectionalLights(e,t,s){this.directionalLightsSet.clear(),this.directionalLights.length=0,this.directionalLightsIndices.length=0;for(let i=0;i<t.length;i++){const n=t[i];if(n.castShadows)for(let t=0;t<e.length;t++)if(e[t]._splitLights[0].indexOf(n)>=0&&!this.directionalLightsSet.has(n)){this.directionalLightsSet.add(n),this.directionalLights.push(n);const e=s.indexOf(n);this.directionalLightsIndices.push(e)}}}}class tp{constructor(){this.shadowCastersSet=new Set,this.shadowCastersList=[]}clearShadowCasters(){this.shadowCastersSet.clear(),this.shadowCastersList.length=0}addShadowCasters(e){for(let t=0;t<e.length;t++){const s=e[t];this.shadowCastersSet.has(s)||(this.shadowCastersSet.add(s),this.shadowCastersList.push(s))}}}const sp=new Set,ip=[];class np extends C{constructor(e="Untitled"){super(),this.name=e,this.layerList=[],this.subLayerList=[],this.subLayerEnabled=[],this._opaqueOrder={},this._transparentOrder={},this._dirty=!1,this._dirtyBlend=!1,this._dirtyLights=!1,this._dirtyCameras=!1,this._meshInstances=[],this._meshInstancesSet=new Set,this._lights=[],this._lightsMap=new Map,this._lightCompositionData=[],this._splitLights=[[],[],[]],this.cameras=[],this._renderActions=[],this._worldClusters=[],this._emptyWorldClusters=null}destroy(){this._emptyWorldClusters&&(this._emptyWorldClusters.destroy(),this._emptyWorldClusters=null),this._worldClusters.forEach((e=>{e.destroy()})),this._worldClusters=null,this._renderActions.forEach((e=>e.destroy())),this._renderActions=null}getEmptyWorldClusters(e){return this._emptyWorldClusters||(this._emptyWorldClusters=new kd(e),this._emptyWorldClusters.name="ClusterEmpty",this._emptyWorldClusters.update([],!1,null)),this._emptyWorldClusters}_splitLightsArray(e){const t=e._lights;e._splitLights[0].length=0,e._splitLights[1].length=0,e._splitLights[2].length=0;for(let s=0;s<t.length;s++){const i=t[s];i.enabled&&e._splitLights[i._type].push(i)}}_update(e,t=!1){const s=this.layerList.length;let i=0;if(!this._dirty||!this._dirtyLights||!this._dirtyCameras)for(let e=0;e<s;e++){const t=this.layerList[e];t._dirty&&(this._dirty=!0),t._dirtyLights&&(this._dirtyLights=!0),t._dirtyCameras&&(this._dirtyCameras=!0)}function n(e,t,s){let i=!1;const n=s.length;for(let a=0;a<n;a++){const n=s[a];if(!t.has(n)){t.add(n),e.push(n);const s=n.material;s&&s._dirtyBlend&&(i=!0,s._dirtyBlend=!1)}}return i}if(this._dirty){i|=1,this._meshInstances.length=0,this._meshInstancesSet.clear();for(let e=0;e<s;e++){const t=this.layerList[e];t.passThrough||(this._dirtyBlend=n(this._meshInstances,this._meshInstancesSet,t.opaqueMeshInstances)||this._dirtyBlend,this._dirtyBlend=n(this._meshInstances,this._meshInstancesSet,t.transparentMeshInstances)||this._dirtyBlend),t._dirty=!1}this._dirty=!1}function a(e,t,s){for(let n=0;n<t.length;){var i;(null==(i=t[n].material)?void 0:i.transparent)===s?(e.push(t[n]),t[n]=t[t.length-1],t.length--):n++}}if(this._dirtyBlend){i|=8;for(let e=0;e<s;e++){const t=this.layerList[e];t.passThrough||(a(t.opaqueMeshInstances,t.transparentMeshInstances,!1),a(t.transparentMeshInstances,t.opaqueMeshInstances,!0))}this._dirtyBlend=!1}if(this._dirtyLights&&(i|=2,this._dirtyLights=!1,this.updateLights()),i&&this.updateShadowCasters(),this._dirtyCameras||2&i){this._dirtyCameras=!1,i|=4,this.cameras.length=0;for(let e=0;e<s;e++){const t=this.layerList[e];t._dirtyCameras=!1;for(let e=0;e<t.cameras.length;e++){const s=t.cameras[e];this.cameras.indexOf(s)<0&&this.cameras.push(s)}}this.cameras.length>1&&Ju(this.cameras);const e=[];let t=0;for(let i=0;i<this.cameras.length;i++){const n=this.cameras[i];e.length=0;let a=!0;const r=t;let o=null,h=!1;for(let i=0;i<s;i++){const s=this.layerList[i];if(s&&s.cameras.length>0&&n.layers.indexOf(s.id)>=0){e.push(s),h||s.id!==n.disablePostEffectsLayer||(h=!0,o&&(o.triggerPostprocess=!0));const r=s.cameras.indexOf(n);r>=0&&(o=this.addRenderAction(this._renderActions,t,s,i,r,a,h),t++,a=!1)}}r<t&&(this._renderActions[r].collectDirectionalLights(e,this._splitLights[0],this._lights),o.lastCameraUse=!0),!h&&o&&(o.triggerPostprocess=!0),n.renderTarget&&n.postEffectsEnabled&&this.propagateRenderTarget(r-1,n)}for(let e=t;e<this._renderActions.length;e++)this._renderActions[e].destroy();this._renderActions.length=t}return 7&i&&t&&this.allocateLightClusters(e),2&i&&this._logRenderActions(),i}updateShadowCasters(){const e=this._lights.length;for(let t=0;t<e;t++)this._lightCompositionData[t].clearShadowCasters();const t=this.layerList.length;for(let e=0;e<t;e++){const t=this.layerList[e];if(!sp.has(t)){sp.add(t);const e=t._lights;for(let s=0;s<e.length;s++)if(e[s].castShadows){const i=this._lightsMap.get(e[s]);this._lightCompositionData[i].addShadowCasters(t.shadowCasters)}}}sp.clear()}updateLights(){this._lights.length=0,this._lightsMap.clear();const e=this.layerList.length;for(let t=0;t<e;t++){const e=this.layerList[t];if(!sp.has(e)){sp.add(e);const t=e._lights;for(let e=0;e<t.length;e++){const s=t[e];let i=this._lightsMap.get(s);if(void 0===i){i=this._lights.length,this._lightsMap.set(s,i),this._lights.push(s);let e=this._lightCompositionData[i];e||(e=new tp,this._lightCompositionData[i]=e)}}}this._splitLightsArray(e),e._dirtyLights=!1}sp.clear(),this._splitLightsArray(this);const t=this._lights.length;this._lightCompositionData.length=t}findCompatibleCluster(e,t,s){for(let i=0;i<t;i++){const t=this._renderActions[i],n=this.layerList[t.layerIndex];if(t.lightClusters!==s){if(e===n)return t.lightClusters;if(t.lightClusters&&Zu(e._clusteredLightsSet,n._clusteredLightsSet))return t.lightClusters}}return null}allocateLightClusters(e){ip.push(...this._worldClusters);const t=this.getEmptyWorldClusters(e);this._worldClusters.length=0;const s=this._renderActions.length;for(let i=0;i<s;i++){const s=this._renderActions[i],n=this.layerList[s.layerIndex];if(n.hasClusteredLights){if((this.subLayerList[s.layerIndex]?n.transparentMeshInstances:n.opaqueMeshInstances).length){let a=this.findCompatibleCluster(n,i,t);a||(ip.length&&(a=ip.pop()),a||(a=new kd(e)),a.name="Cluster-"+this._worldClusters.length,this._worldClusters.push(a)),s.lightClusters=a}}s.lightClusters||(s.lightClusters=t)}ip.forEach((e=>{e.destroy()})),ip.length=0}addRenderAction(e,t,s,i,n,a,r){let o=e[t];o||(o=e[t]=new ep);let h=s.renderTarget;const l=s.cameras[n];l&&l.renderTarget&&1!==s.id&&(h=l.renderTarget);let c=!1;for(let s=t-1;s>=0;s--)if(e[s].camera===l&&e[s].renderTarget===h){c=!0;break}const d=a||!c;let u=!!d&&l.clearColorBuffer,p=!!d&&l.clearDepthBuffer,m=!!d&&l.clearStencilBuffer;return u||(u=s.clearColorBuffer),p||(p=s.clearDepthBuffer),m||(m=s.clearStencilBuffer),r&&l.postEffectsEnabled&&(h=null),o.reset(),o.triggerPostprocess=!1,o.layerIndex=i,o.cameraIndex=n,o.camera=l,o.renderTarget=h,o.clearColor=u,o.clearDepth=p,o.clearStencil=m,o.firstCameraUse=a,o.lastCameraUse=!1,o}propagateRenderTarget(e,t){for(let s=e;s>=0;s--){const e=this._renderActions[s],i=this.layerList[e.layerIndex];if(e.renderTarget&&1!==i.id)break;if(1===i.id)continue;const n=null==e?void 0:e.camera.camera;if(n&&(!t.camera.rect.equals(n.rect)||!t.camera.scissorRect.equals(n.scissorRect)))break;e.renderTarget=t.renderTarget}}_logRenderActions(){}_isLayerAdded(e){return this.layerList.indexOf(e)>=0}_isSublayerAdded(e,t){for(let s=0;s<this.layerList.length;s++)if(this.layerList[s]===e&&this.subLayerList[s]===t)return!0;return!1}push(e){this._isLayerAdded(e)||(this.layerList.push(e),this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(!1)-1,this._transparentOrder[e.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this.subLayerEnabled.push(!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",e))}insert(e,t){if(this._isLayerAdded(e))return;this.layerList.splice(t,0,e,e),this.subLayerList.splice(t,0,!1,!0);const s=this.layerList.length;this._updateOpaqueOrder(t,s-1),this._updateTransparentOrder(t,s-1),this.subLayerEnabled.splice(t,0,!0,!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",e)}remove(e){let t=this.layerList.indexOf(e);for(delete this._opaqueOrder[t],delete this._transparentOrder[t];t>=0;)this.layerList.splice(t,1),this.subLayerList.splice(t,1),this.subLayerEnabled.splice(t,1),t=this.layerList.indexOf(e),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("remove",e);const s=this.layerList.length;this._updateOpaqueOrder(0,s-1),this._updateTransparentOrder(0,s-1)}pushOpaque(e){this._isSublayerAdded(e,!1)||(this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(!1)-1,this.subLayerEnabled.push(!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",e))}insertOpaque(e,t){if(this._isSublayerAdded(e,!1))return;this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,!1);const s=this.subLayerList.length;this._updateOpaqueOrder(t,s-1),this.subLayerEnabled.splice(t,0,!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",e)}removeOpaque(e){for(let t=0,s=this.layerList.length;t<s;t++)if(this.layerList[t]===e&&!this.subLayerList[t])return this.layerList.splice(t,1),this.subLayerList.splice(t,1),s--,this._updateOpaqueOrder(t,s-1),this.subLayerEnabled.splice(t,1),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,void(this.layerList.indexOf(e)<0&&this.fire("remove",e))}pushTransparent(e){this._isSublayerAdded(e,!0)||(this.layerList.push(e),this._transparentOrder[e.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",e))}insertTransparent(e,t){if(this._isSublayerAdded(e,!0))return;this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,!0);const s=this.subLayerList.length;this._updateTransparentOrder(t,s-1),this.subLayerEnabled.splice(t,0,!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",e)}removeTransparent(e){for(let t=0,s=this.layerList.length;t<s;t++)if(this.layerList[t]===e&&this.subLayerList[t])return this.layerList.splice(t,1),this.subLayerList.splice(t,1),s--,this._updateTransparentOrder(t,s-1),this.subLayerEnabled.splice(t,1),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,void(this.layerList.indexOf(e)<0&&this.fire("remove",e))}_getSublayerIndex(e,t){let s=this.layerList.indexOf(e);if(s<0)return-1;if(this.subLayerList[s]!==t){if(s=this.layerList.indexOf(e,s+1),s<0)return-1;if(this.subLayerList[s]!==t)return-1}return s}getOpaqueIndex(e){return this._getSublayerIndex(e,!1)}getTransparentIndex(e){return this._getSublayerIndex(e,!0)}getLayerById(e){for(let t=0;t<this.layerList.length;t++)if(this.layerList[t].id===e)return this.layerList[t];return null}getLayerByName(e){for(let t=0;t<this.layerList.length;t++)if(this.layerList[t].name===e)return this.layerList[t];return null}_updateOpaqueOrder(e,t){for(let s=e;s<=t;s++)!1===this.subLayerList[s]&&(this._opaqueOrder[this.layerList[s].id]=s)}_updateTransparentOrder(e,t){for(let s=e;s<=t;s++)!0===this.subLayerList[s]&&(this._transparentOrder[this.layerList[s].id]=s)}_sortLayersDescending(e,t,s){let i=-1,n=-1;for(let t=0,n=e.length;t<n;t++){const n=e[t];s.hasOwnProperty(n)&&(i=Math.max(i,s[n]))}for(let e=0,i=t.length;e<i;e++){const i=t[e];s.hasOwnProperty(i)&&(n=Math.max(n,s[i]))}return-1===i&&-1!==n?1:-1===n&&-1!==i?-1:n-i}sortTransparentLayers(e,t){return this._sortLayersDescending(e,t,this._transparentOrder)}sortOpaqueLayers(e,t){return this._sortLayersDescending(e,t,this._opaqueOrder)}}const ap=new ge,rp=new ge,op=new ge,hp={bias:0,normalBias:0},lp={r:0,g:1,b:2,a:3},cp=[[new xe(0,0,1,1)],[new xe(0,0,.5,.5),new xe(0,.5,.5,.5)],[new xe(0,0,.5,.5),new xe(0,.5,.5,.5),new xe(.5,0,.5,.5)],[new xe(0,0,.5,.5),new xe(0,.5,.5,.5),new xe(.5,0,.5,.5),new xe(.5,.5,.5,.5)]];let dp=0;class up{constructor(e,t,s,i){this.light=i,this.camera=t,this.shadowCamera=mu.createShadowCamera(e,i._shadowType,i._type,s),this.shadowMatrix=new Ce,this.shadowViewport=new xe(0,0,1,1),this.shadowScissor=new xe(0,0,1,1),this.face=s,this.visibleCasters=[]}get shadowBuffer(){const e=this.shadowCamera.renderTarget;if(e){const t=this.light;return 1===t._type?e.colorBuffer:t._isPcf&&t.device.webgl2?e.depthBuffer:e.colorBuffer}return null}}class pp{constructor(e){this.device=e,this.id=dp++,this._type=0,this._color=new pe(.8,.8,.8),this._intensity=1,this._luminance=0,this._castShadows=!1,this._enabled=!1,this.mask=1,this.isStatic=!1,this.key=0,this.bakeDir=!0,this.bakeNumSamples=1,this.bakeArea=0,this.attenuationStart=10,this.attenuationEnd=10,this._falloffMode=0,this._shadowType=0,this._vsmBlurSize=11,this.vsmBlurMode=1,this.vsmBias=.0025,this._cookie=null,this.cookieIntensity=1,this._cookieFalloff=!0,this._cookieChannel="rgb",this._cookieTransform=null,this._cookieTransformUniform=new Float32Array(4),this._cookieOffset=null,this._cookieOffsetUniform=new Float32Array(2),this._cookieTransformSet=!1,this._cookieOffsetSet=!1,this._innerConeAngle=40,this._outerConeAngle=45,this.cascades=null,this._shadowMatrixPalette=null,this._shadowCascadeDistances=null,this.numCascades=1,this.cascadeDistribution=.5,this._shape=0,this._finalColor=new Float32Array([.8,.8,.8]);const t=Math.pow(this._finalColor[0],2.2);this._linearFinalColor=new Float32Array([t,t,t]),this._position=new ge(0,0,0),this._direction=new ge(0,0,0),this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180),this._outerConeAngleCos=Math.cos(this._outerConeAngle*Math.PI/180),this._shadowMap=null,this._shadowRenderParams=[],this.shadowDistance=40,this._shadowResolution=1024,this.shadowBias=-5e-4,this.shadowIntensity=1,this._normalOffsetBias=0,this.shadowUpdateMode=2,this._isVsm=!1,this._isPcf=!0,this._cookieMatrix=null,this._atlasViewport=null,this.atlasViewportAllocated=!1,this.atlasVersion=0,this.atlasSlotIndex=0,this.atlasSlotUpdated=!1,this._scene=null,this._node=null,this._renderData=[],this.visibleThisFrame=!1,this.maxScreenSize=0}destroy(){this._destroyShadowMap(),this._renderData=null}set numCascades(e){this.cascades&&this.numCascades===e||(this.cascades=cp[e-1],this._shadowMatrixPalette=new Float32Array(64),this._shadowCascadeDistances=new Float32Array(4),this._destroyShadowMap(),this.updateKey())}get numCascades(){return this.cascades.length}set shadowMap(e){this._shadowMap!==e&&(this._destroyShadowMap(),this._shadowMap=e)}get shadowMap(){return this._shadowMap}get numShadowFaces(){const e=this._type;return 0===e?this.numCascades:1===e?6:1}set type(e){if(this._type===e)return;this._type=e,this._destroyShadowMap(),this.updateKey();const t=this._shadowType;this._shadowType=null,this.shadowType=t}get type(){return this._type}set shape(e){if(this._shape===e)return;this._shape=e,this._destroyShadowMap(),this.updateKey();const t=this._shadowType;this._shadowType=null,this.shadowType=t}get shape(){return this._shape}set shadowType(e){if(this._shadowType===e)return;const t=this.device;1===this._type&&(e=0),4!==e||t.webgl2||(e=0),3!==e||t.textureFloatRenderable||(e=2),2!==e||t.textureHalfFloatRenderable||(e=1),this._isVsm=e>=1&&e<=3,this._isPcf=4===e||0===e,this._shadowType=e,this._destroyShadowMap(),this.updateKey()}get shadowType(){return this._shadowType}set enabled(e){this._enabled!==e&&(this._enabled=e,this.layersDirty())}get enabled(){return this._enabled}set castShadows(e){this._castShadows!==e&&(this._castShadows=e,this._destroyShadowMap(),this.layersDirty(),this.updateKey())}get castShadows(){return this._castShadows&&4!==this.mask&&0!==this.mask}set shadowResolution(e){this._shadowResolution!==e&&(e=1===this._type?Math.min(e,this.device.maxCubeMapSize):Math.min(e,this.device.maxTextureSize),this._shadowResolution=e,this._destroyShadowMap())}get shadowResolution(){return this._shadowResolution}set vsmBlurSize(e){this._vsmBlurSize!==e&&(e%2==0&&e++,this._vsmBlurSize=e)}get vsmBlurSize(){return this._vsmBlurSize}set normalOffsetBias(e){this._normalOffsetBias!==e&&((!this._normalOffsetBias&&e||this._normalOffsetBias&&!e)&&this.updateKey(),this._normalOffsetBias=e)}get normalOffsetBias(){return this._normalOffsetBias}set falloffMode(e){this._falloffMode!==e&&(this._falloffMode=e,this.updateKey())}get falloffMode(){return this._falloffMode}set innerConeAngle(e){this._innerConeAngle!==e&&(this._innerConeAngle=e,this._innerConeAngleCos=Math.cos(e*Math.PI/180))}get innerConeAngle(){return this._innerConeAngle}set outerConeAngle(e){this._outerConeAngle!==e&&(this._outerConeAngle=e,this._outerConeAngleCos=Math.cos(e*Math.PI/180))}get outerConeAngle(){return this._outerConeAngle}set intensity(e){this._intensity!==e&&(this._intensity=e,this._updateFinalColor())}get intensity(){return this._intensity}set luminance(e){this._luminance!==e&&(this._luminance=e,this._updateFinalColor())}get luminance(){return this._luminance}get cookieMatrix(){return this._cookieMatrix||(this._cookieMatrix=new Ce),this._cookieMatrix}get atlasViewport(){return this._atlasViewport||(this._atlasViewport=new xe(0,0,1,1)),this._atlasViewport}set cookie(e){this._cookie!==e&&(this._cookie=e,this.updateKey())}get cookie(){return this._cookie}set cookieFalloff(e){this._cookieFalloff!==e&&(this._cookieFalloff=e,this.updateKey())}get cookieFalloff(){return this._cookieFalloff}set cookieChannel(e){if(this._cookieChannel!==e){if(e.length<3){const t=e.charAt(e.length-1),s=3-e.length;for(let i=0;i<s;i++)e+=t}this._cookieChannel=e,this.updateKey()}}get cookieChannel(){return this._cookieChannel}set cookieTransform(e){this._cookieTransform!==e&&(this._cookieTransform=e,this._cookieTransformSet=!!e,e&&!this._cookieOffset&&(this.cookieOffset=new ve,this._cookieOffsetSet=!1),this.updateKey())}get cookieTransform(){return this._cookieTransform}set cookieOffset(e){if(this._cookieOffset===e)return;!(!this._cookieTransformSet&&!e)&&!e&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=e,this._cookieOffsetSet=!!e,e&&!this._cookieTransform&&(this.cookieTransform=new xe(1,1,0,0),this._cookieTransformSet=!1),this.updateKey()}get cookieOffset(){return this._cookieOffset}beginFrame(){this.visibleThisFrame=0===this._type&&this._enabled,this.maxScreenSize=0,this.atlasViewportAllocated=!1,this.atlasSlotUpdated=!1}_destroyShadowMap(){this._renderData&&(this._renderData.length=0),this._shadowMap&&(this._shadowMap.cached||this._shadowMap.destroy(),this._shadowMap=null),0===this.shadowUpdateMode&&(this.shadowUpdateMode=1)}getRenderData(e,t){for(let s=0;s<this._renderData.length;s++){const i=this._renderData[s];if(i.camera===e&&i.face===t)return i}const s=new up(this.device,e,t,this);return this._renderData.push(s),s}clone(){const e=new pp(this.device);return e.type=this._type,e.setColor(this._color),e.intensity=this._intensity,e.castShadows=this.castShadows,e._enabled=this._enabled,e.attenuationStart=this.attenuationStart,e.attenuationEnd=this.attenuationEnd,e.falloffMode=this._falloffMode,e.shadowType=this._shadowType,e.vsmBlurSize=this._vsmBlurSize,e.vsmBlurMode=this.vsmBlurMode,e.vsmBias=this.vsmBias,e.shadowUpdateMode=this.shadowUpdateMode,e.mask=this.mask,e.innerConeAngle=this._innerConeAngle,e.outerConeAngle=this._outerConeAngle,e.numCascades=this.numCascades,e.cascadeDistribution=this.cascadeDistribution,e.shape=this._shape,e.shadowBias=this.shadowBias,e.normalOffsetBias=this._normalOffsetBias,e.shadowResolution=this._shadowResolution,e.shadowDistance=this.shadowDistance,e.shadowIntensity=this.shadowIntensity,e}_getUniformBiasValues(e){const t=e.shadowCamera._farClip;switch(this._type){case 1:hp.bias=this.shadowBias,hp.normalBias=this._normalOffsetBias;break;case 2:this._isVsm?hp.bias=-2e-4:(hp.bias=20*this.shadowBias,!this.device.webgl2&&this.device.extStandardDerivatives&&(hp.bias*=-100)),hp.normalBias=this._isVsm?this.vsmBias/(this.attenuationEnd/7):this._normalOffsetBias;break;case 0:this._isVsm?hp.bias=-2e-4:(hp.bias=this.shadowBias/t*100,!this.device.webgl2&&this.device.extStandardDerivatives&&(hp.bias*=-100)),hp.normalBias=this._isVsm?this.vsmBias/(t/7):this._normalOffsetBias}return hp}getColor(){return this._color}getBoundingSphere(e){if(2===this._type){const t=this.attenuationEnd,s=this._outerConeAngle,i=Math.cos(s*ne.DEG_TO_RAD),n=this._node;ap.copy(n.up),ap.mulScalar(.5*-t*i),ap.add(n.getPosition()),e.center=ap,rp.copy(n.up),rp.mulScalar(-t),op.copy(n.right),op.mulScalar(Math.sin(s*ne.DEG_TO_RAD)*t),rp.add(op),e.radius=.5*rp.length()}else 1===this._type&&(e.center=this._node.getPosition(),e.radius=this.attenuationEnd)}getBoundingBox(e){if(2===this._type){const t=this.attenuationEnd,s=this._outerConeAngle,i=this._node,n=Math.abs(Math.sin(s*ne.DEG_TO_RAD)*t);e.center.set(0,.5*-t,0),e.halfExtents.set(n,.5*t,n),e.setFromTransformedAabb(e,i.getWorldTransform(),!0)}else 1===this._type&&(e.center.copy(this._node.getPosition()),e.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd))}_updateFinalColor(){const e=this._color,t=e.r,s=e.g,i=e.b;let n=this._intensity;this._luminance>0&&(2===this._type?n=this._luminance/(2*Math.PI)*(1-Math.cos(this._outerConeAngle/2)):1===this._type&&(n=this._luminance/(4*Math.PI)));const a=this._finalColor,r=this._linearFinalColor;a[0]=t*n,a[1]=s*n,a[2]=i*n,n>=1?(r[0]=Math.pow(t,2.2)*n,r[1]=Math.pow(s,2.2)*n,r[2]=Math.pow(i,2.2)*n):(r[0]=Math.pow(a[0],2.2),r[1]=Math.pow(a[1],2.2),r[2]=Math.pow(a[2],2.2))}setColor(){1===arguments.length?this._color.set(arguments[0].r,arguments[0].g,arguments[0].b):3===arguments.length&&this._color.set(arguments[0],arguments[1],arguments[2]),this._updateFinalColor()}updateShadow(){2!==this.shadowUpdateMode&&(this.shadowUpdateMode=1)}layersDirty(){var e;null!=(e=this._scene)&&e.layers&&(this._scene.layers._dirtyLights=!0)}updateKey(){let e=this._type<<29|(this._castShadows?1:0)<<28|this._shadowType<<25|this._falloffMode<<23|(0!==this._normalOffsetBias?1:0)<<22|(this._cookie?1:0)<<21|(this._cookieFalloff?1:0)<<20|lp[this._cookieChannel.charAt(0)]<<18|(this._cookieTransform?1:0)<<12|this._shape<<10|this.numCascades-1<<8;3===this._cookieChannel.length&&(e|=lp[this._cookieChannel.charAt(1)]<<16,e|=lp[this._cookieChannel.charAt(2)]<<14),e!==this.key&&null!==this._scene&&this.layersDirty(),this.key=e}}class mp{constructor(e,t,s){this._maxTextureSize=t,this._supportsAreaLights=e,this._dirtyLightsFnc=s,this._areaLightsEnabled=!1,this._cells=new ge(10,3,10),this._maxLightsPerCell=255,this._shadowsEnabled=!0,this._shadowType=0,this._shadowAtlasResolution=2048,this._cookiesEnabled=!1,this._cookieAtlasResolution=2048,this.atlasSplit=null,this.debugLayer=void 0}applySettings(e){this.shadowsEnabled=e.lightingShadowsEnabled,this.cookiesEnabled=e.lightingCookiesEnabled,this.areaLightsEnabled=e.lightingAreaLightsEnabled,this.shadowAtlasResolution=e.lightingShadowAtlasResolution,this.cookieAtlasResolution=e.lightingCookieAtlasResolution,this.maxLightsPerCell=e.lightingMaxLightsPerCell,this.shadowType=e.lightingShadowType,this.cell=new ge(e.lightingCells)}set cells(e){this._cells.copy(e)}get cells(){return this._cells}set maxLightsPerCell(e){this._maxLightsPerCell=ne.clamp(e,1,255)}get maxLightsPerCell(){return this._maxLightsPerCell}set cookieAtlasResolution(e){this._cookieAtlasResolution=ne.clamp(e,32,this._maxTextureSize)}get cookieAtlasResolution(){return this._cookieAtlasResolution}set shadowAtlasResolution(e){this._shadowAtlasResolution=ne.clamp(e,32,this._maxTextureSize)}get shadowAtlasResolution(){return this._shadowAtlasResolution}set shadowType(e){this._shadowType!==e&&(this._shadowType=e,this._dirtyLightsFnc())}get shadowType(){return this._shadowType}set cookiesEnabled(e){this._cookiesEnabled!==e&&(this._cookiesEnabled=e,this._dirtyLightsFnc())}get cookiesEnabled(){return this._cookiesEnabled}set areaLightsEnabled(e){this._supportsAreaLights&&this._areaLightsEnabled!==e&&(this._areaLightsEnabled=e,this._dirtyLightsFnc())}get areaLightsEnabled(){return this._areaLightsEnabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this._dirtyLightsFnc())}get shadowsEnabled(){return this._shadowsEnabled}}const fp={bakeDirLmEndPS:"\n    vec4 dirLm = texture2D(texture_dirLightMap, vUv1);\n\n    if (bakeDir > 0.5) {\n        if (dAtten > 0.00001) {\n            dirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);\n            dAtten = saturate(dAtten);\n            gl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);\n            gl_FragColor.a = dirLm.w + dAtten;\n            gl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);\n        } else {\n            gl_FragColor = dirLm;\n        }\n    } else {\n        gl_FragColor.rgb = dirLm.xyz;\n        gl_FragColor.a = max(dirLm.w, dAtten > 0.00001? (1.0/255.0) : 0.0);\n    }\n",bakeLmEndPS:"\n    gl_FragColor.rgb = dDiffuseLight;\n    gl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));\n    gl_FragColor.rgb /= 8.0;\n    gl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );\n    gl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;\n    gl_FragColor.rgb /= gl_FragColor.a;\n",dilatePS:"\n#define SHADER_NAME Dilate\n\nvarying vec2 vUv0;\n\nuniform sampler2D source;\nuniform vec2 pixelOffset;\n\nvoid main(void) {\n    vec4 c = texture2D(source, vUv0);\n    c = c.a>0.0? c : texture2D(source, vUv0 - pixelOffset);\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, -pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, 0));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, 0));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + pixelOffset);\n    gl_FragColor = c;\n}\n",bilateralDeNoisePS:"\n// bilateral filter, based on https://www.shadertoy.com/view/4dfGDH# and\n// http://people.csail.mit.edu/sparis/bf_course/course_notes.pdf\n\n// A bilateral filter is a non-linear, edge-preserving, and noise-reducing smoothing filter for images.\n// It replaces the intensity of each pixel with a weighted average of intensity values from nearby pixels.\n// This weight can be based on a Gaussian distribution. Crucially, the weights depend not only on\n// Euclidean distance of pixels, but also on the radiometric differences (e.g., range differences, such\n// as color intensity, depth distance, etc.). This preserves sharp edges.\n\n#define SHADER_NAME BilateralDeNoise\n\nfloat normpdf3(in vec3 v, in float sigma) {\n    return 0.39894 * exp(-0.5 * dot(v, v) / (sigma * sigma)) / sigma;\n}\n\nvec3 decodeRGBM(vec4 rgbm) {\n    vec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n    return color * color;\n}\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nvec4 encodeRGBM(vec3 color) { // modified RGBM\n    vec4 encoded;\n    encoded.rgb = pow(color.rgb, vec3(0.5));\n    encoded.rgb *= 1.0 / 8.0;\n\n    encoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );\n    encoded.a = ceil(encoded.a * 255.0) / 255.0;\n\n    encoded.rgb /= encoded.a;\n    return encoded;\n}\n\n// filter size\n#define MSIZE 15\n\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nuniform vec2 sigmas;\nuniform float bZnorm;\nuniform float kernel[MSIZE];\n\nvoid main(void) {\n    \n    vec4 pixelRgbm = texture2D(source, vUv0);\n\n    // lightmap specific optimization - skip pixels that were not baked\n    // this also allows dilate filter that work on the output of this to work correctly, as it depends on .a being zero\n    // to dilate, which the following blur filter would otherwise modify\n    if (pixelRgbm.a <= 0.0) {\n        gl_FragColor = pixelRgbm;\n        return ;\n    }\n\n    // range sigma - controls blurriness based on a pixel distance\n    float sigma = sigmas.x;\n\n    // domain sigma - controls blurriness based on a pixel similarity (to preserve edges)\n    float bSigma = sigmas.y;\n\n    vec3 pixelHdr = decodeRGBM(pixelRgbm);\n    vec3 accumulatedHdr = vec3(0.0);\n    float accumulatedFactor = 0.0;\n\n    // read out the texels\n    const int kSize = (MSIZE-1)/2;\n    for (int i = -kSize; i <= kSize; ++i) {\n        for (int j = -kSize; j <= kSize; ++j) {\n            \n            // sample the pixel with offset\n            vec2 coord = vUv0 + vec2(float(i), float(j)) * pixelOffset;\n            vec4 rgbm = texture2D(source, coord);\n\n            // lightmap - only use baked pixels\n            if (rgbm.a > 0.0) {\n                vec3 hdr = decodeRGBM(rgbm);\n\n                // bilateral factors\n                float factor = kernel[kSize + j] * kernel[kSize + i];\n                factor *= normpdf3(hdr - pixelHdr, bSigma) * bZnorm;\n\n                // accumulate\n                accumulatedHdr += factor * hdr;\n                accumulatedFactor += factor;\n            }\n        }\n    }\n\n    gl_FragColor = encodeRGBM(accumulatedHdr / accumulatedFactor);\n}\n"},_p=new ke;class gp{constructor(e,t){this.scene=e,this.light=t,this.store(),t.numCascades=1,0!==t.type&&(t._node.getWorldTransform(),t.getBoundingSphere(_p),this.lightBounds=new De,this.lightBounds.center.copy(_p.center),this.lightBounds.halfExtents.set(_p.radius,_p.radius,_p.radius))}store(){this.mask=this.light.mask,this.shadowUpdateMode=this.light.shadowUpdateMode,this.enabled=this.light.enabled,this.intensity=this.light.intensity,this.rotation=this.light._node.getLocalRotation().clone(),this.numCascades=this.light.numCascades}restore(){const e=this.light;e.mask=this.mask,e.shadowUpdateMode=this.shadowUpdateMode,e.enabled=this.enabled,e.intensity=this.intensity,e._node.setLocalRotation(this.rotation),e.numCascades=this.numCascades}startBake(){this.light.enabled=!0,this.light._destroyShadowMap()}endBake(e){const t=this.light;t.enabled=!1,t.shadowMap&&(t.shadowMap.cached&&e.add(t,t.shadowMap),t.shadowMap=null)}}const yp=new ve;class vp extends gp{get numVirtualLights(){return 0===this.light.type?this.light.bakeNumSamples:1}prepareVirtualLight(e,t){const s=this.light;if(s._node.setLocalRotation(this.rotation),e>0){const i=s.bakeArea;el(yp,e,t),yp.mulScalar(.5*i),s._node.rotateLocal(yp.x,0,yp.y)}s._node.getWorldTransform();const i=this.scene.gammaCorrection?2.2:1,n=Math.pow(this.intensity,i);s.intensity=Math.pow(n/t,1/i)}}class xp{constructor(){this.renderPasses=[],this.renderTargetMap=new Map}addRenderPass(e){this.renderPasses.push(e)}reset(){this.renderPasses.length=0}compile(){const e=this.renderTargetMap,t=this.renderPasses;for(let s=0;s<t.length;s++){const i=t[s],n=i.renderTarget;if(void 0!==n){const t=e.get(n);t&&(i.colorOps.clear||(t.colorOps.store=!0),i.depthStencilOps.clearDepth||(t.depthStencilOps.storeDepth=!0),i.depthStencilOps.clearStencil||(t.depthStencilOps.storeStencil=!0)),e.set(n,i)}}let s=null,i=null;for(let e=0;e<t.length;e++){const n=t[e],a=n.renderTarget,r=null==a?void 0:a.colorBuffer;null!=r&&r.cubemap?(s===r&&(i.colorOps.mipmaps=!1),s=a.colorBuffer,i=n):n.requiresCubemaps&&(s=null,i=null)}e.forEach(((e,t)=>{null===t&&(e.colorOps.store=!0,e.colorOps.resolve=!1,e.colorOps.mipmaps=!1)})),e.clear(),this.log()}render(){this.compile();const e=this.renderPasses;for(let t=0;t<e.length;t++)e[t].render()}log(){}}class bp{constructor(e,t){this.texture0=e,this.texture1=t}destroy(){var e,t;null==(e=this.texture0)||e.destroy(),null==(t=this.texture1)||t.destroy()}}const Sp=new yo;class wp{static createTexture(e,t,s,i=""){return new fh(e,{width:s,height:s,format:t,addressU:1,addressV:1,type:"default",magFilter:1,minFilter:0,anisotropy:1,name:`AreaLightLUT${i}`})}static applyTextures(e,t,s){Sp.remove(e),Sp.get(e,(()=>new bp(t,t===s?null:s))),e.scope.resolve("areaLightsLutTex1").setValue(t),e.scope.resolve("areaLightsLutTex2").setValue(s)}static createPlaceholder(e){const t=wp.createTexture(e,7,2,"placeholder");t.lock().fill(0),t.unlock(),wp.applyTextures(e,t,t)}static set(e,t){function s(e,t,s){const i=wp.createTexture(e,s,64);return i.lock().set(t),i.unlock(),i.upload(),i}function i(e,t,s){const i=e.length,n=new Float32Array(i);for(let a=0;a<i;a++){const i=a%4;n[a]=(e[a]+t[i])*s[i]}return n}function n(e){const t=e.length,s=new Uint16Array(t),i=dh.float2Half;for(let n=0;n<t;n++)s[n]=i(e[n]);return s}function a(e){const t=e.length,s=new Uint8ClampedArray(t);for(let i=0;i<t;i++)s[i]=255*e[i];return s}const r=new Int16Array(t,0,2),o=r[0],h=r[1];if(0!==o||1!==h);else{const r=new Float32Array(t,4,16384),o=new Float32Array(t,65540,16384);let h,l;const c=e.areaLightLutFormat;if(14===c)h=r,l=o;else if(12===c)h=n(r),l=n(o);else{const e=[-.306897,0,0,0],t=[1.442787,1,1,1];h=a(i(r,[0,.2976,.01381,0],[.999,3.08737,1.6546,.603249])),l=a(i(o,e,t))}const d=s(e,h,c),u=s(e,l,c);wp.applyTextures(e,d,u)}}}const Tp={generateKey:function(e){return"cubemap"===e.type?`skybox-${e.type}-${e.encoding}-${e.useIntensity}-${e.gamma}-${e.toneMapping}-${e.fixSeams}-${e.mip}`:`skybox-${e.type}-${e.encoding}-${e.useIntensity}-${e.gamma}-${e.toneMapping}`},createShaderDefinition:function(e,t){let s;if("cubemap"===t.type){const i=[128,64,16,8,4,2];s=Wo(e),s+=t.mip?Bo.fixCubemapSeamsStretchPS:Bo.fixCubemapSeamsNonePS,s+=t.useIntensity?Bo.envMultiplyPS:Bo.envConstPS,s+=Bo.decodePS,s+=Uo(t.gamma),s+=Vo(t.toneMapping),s+=Bo.skyboxHDRPS.replace(/\$DECODE/g,hh.decodeFunc(t.encoding)).replace(/\$FIXCONST/g,1-1/i[t.mip]+"")}else s=Wo(e),s+=t.useIntensity?Bo.envMultiplyPS:Bo.envConstPS,s+=Bo.decodePS,s+=Uo(t.gamma),s+=Vo(t.toneMapping),s+=Bo.sphericalPS,s+=Bo.envAtlasPS,s+=Bo.skyboxEnvPS.replace(/\$DECODE/g,hh.decodeFunc(t.encoding));return{attributes:{aPosition:"POSITION"},vshader:Bo.skyboxVS,fshader:s}}};let Mp;class Cp{constructor(e,t,s){this.meshInstance=void 0,this._rotationMat3=void 0;const i=new Al;i.getShaderVariant=function(i,n,a,r,o,h,l,c){const d=e.getProgramLibrary();return d.register("skybox",Tp),s.cubemap?d.getProgram("skybox",{type:"cubemap",encoding:s.encoding,useIntensity:1!==t.skyboxIntensity,mip:s.fixCubemapSeams?t.skyboxMip:0,fixSeams:s.fixCubemapSeams,gamma:1===o?t.gammaCorrection?3:0:t.gammaCorrection,toneMapping:1===o?0:t.toneMapping}):d.getProgram("skybox",{type:"envAtlas",encoding:s.encoding,useIntensity:1!==t.skyboxIntensity,gamma:1===o?t.gammaCorrection?3:0:t.gammaCorrection,toneMapping:1===o?0:t.toneMapping})},s.cubemap?i.setParameter("texture_cubeMap",s):(i.setParameter("texture_envAtlas",s),i.setParameter("mipLevel",t._skyboxMip)),t.skyboxRotation.equals(Ae.IDENTITY)?i.setParameter("cubeMapRotationMatrix",ye.IDENTITY.data):(Mp=Mp||new Ce,this._rotationMat3=this._rotationMat3||new ye,Mp.setTRS(ge.ZERO,t._skyboxRotation,ge.ONE),Mp.invertTo3x3(this._rotationMat3),i.setParameter("cubeMapRotationMatrix",this._rotationMat3.data)),i.cull=2,i.depthWrite=!1;const n=t.layers.getLayerById(2);if(n){const t=new kh("Skybox"),s=td(e),a=new xd(s,i,t);this.meshInstance=a,a.cull=!1,a._noDepthDrawGl1=!0,a.pick=!1,n.addMeshInstances([a]),this.skyLayer=n}}destroy(){this.meshInstance&&(this.skyLayer&&this.skyLayer.removeMeshInstances([this.meshInstance]),this.meshInstance.destroy(),this.meshInstance=null)}}const Ap=new kh;Ap.worldTransform=Ce.IDENTITY,Ap._dirtyWorld=Ap._dirtyNormal=!1;class Pp{constructor(e,t,s){this.material=t,this.layer=s,this.positions=[],this.colors=[],this.mesh=new Wc(e),this.meshInstance=null}addLines(e,t){const s=this.positions,i=e.length;for(let t=0;t<i;t++){const i=e[t];s.push(i.x,i.y,i.z)}const n=this.colors;if(t.length)for(let e=0;e<i;e++){const s=t[e];n.push(s.r,s.g,s.b,s.a)}else for(let e=0;e<i;e++)n.push(t.r,t.g,t.b,t.a)}addLinesArrays(e,t){const s=this.positions;for(let t=0;t<e.length;t+=3)s.push(e[t],e[t+1],e[t+2]);const i=this.colors;if(t.length)for(let e=0;e<t.length;e+=4)i.push(t[e],t[e+1],t[e+2],t[e+3]);else{const s=e.length/3;for(let e=0;e<s;e++)i.push(t.r,t.g,t.b,t.a)}}onPreRender(e,t){this.positions.length>0&&this.material.transparent===t&&(this.mesh.setPositions(this.positions),this.mesh.setColors(this.colors),this.mesh.update(1,!1),this.meshInstance||(this.meshInstance=new xd(this.mesh,this.material,Ap)),this.positions.length=0,this.colors.length=0,e.list.push(this.meshInstance),e.length++)}}class Ep{constructor(e){this.device=e,this.map=new Map}getBatch(e,t){let s=this.map.get(e);return s||(s=new Pp(this.device,e,t),this.map.set(e,s)),s}onPreRender(e,t){this.map.forEach((s=>{s.onPreRender(e,t)}))}}const Rp=[];class Lp{constructor(e){this.device=e,this.quadMesh=null,this.textureShader=null,this.depthTextureShader=null,this.cubeLocalPos=null,this.cubeWorldPos=null,this.batchesMap=new Map,this.allBatches=new Set,this.updatedLayers=new Set,this._materialDepth=null,this._materialNoDepth=null,this.layerMeshInstances=new Map}createMaterial(e){const t=new nd;return t.vertexColors=!0,t.blend=!0,t.blendType=2,t.depthTest=e,t.update(),t}get materialDepth(){return this._materialDepth||(this._materialDepth=this.createMaterial(!0)),this._materialDepth}get materialNoDepth(){return this._materialNoDepth||(this._materialNoDepth=this.createMaterial(!1)),this._materialNoDepth}getBatch(e,t){let s=this.batchesMap.get(e);s||(s=new Ep(this.device),this.batchesMap.set(e,s)),this.allBatches.add(s);const i=t?this.materialDepth:this.materialNoDepth;return s.getBatch(i,e)}static getTextureVS(){return"\n            attribute vec2 vertex_position;\n            uniform mat4 matrix_model;\n            varying vec2 uv0;\n            void main(void) {\n                gl_Position = matrix_model * vec4(vertex_position, 0, 1);\n                uv0 = vertex_position.xy + 0.5;\n            }\n        "}getTextureShader(){if(!this.textureShader){const e="\n                varying vec2 uv0;\n                uniform sampler2D colorMap;\n                void main (void) {\n                    gl_FragColor = vec4(texture2D(colorMap, uv0).xyz, 1);\n                }\n            ";this.textureShader=eh(this.device,Lp.getTextureVS(),e,"DebugTextureShader")}return this.textureShader}getDepthTextureShader(){if(!this.depthTextureShader){const e=`\n                ${Bo.screenDepthPS}\n                varying vec2 uv0;\n                void main() {\n                    float depth = getLinearScreenDepth(uv0) * camera_params.x;\n                    gl_FragColor = vec4(vec3(depth), 1.0);\n                }\n            `;this.depthTextureShader=eh(this.device,Lp.getTextureVS(),e,"DebugDepthTextureShader")}return this.depthTextureShader}getQuadMesh(){return this.quadMesh||(this.quadMesh=new Wc(this.device),this.quadMesh.setPositions([-.5,-.5,0,.5,-.5,0,-.5,.5,0,.5,.5,0]),this.quadMesh.update(5)),this.quadMesh}drawMesh(e,t,s,i,n){if(!i){const n=this.getGraphNode(t);i=new xd(s,e,n)}let a=this.layerMeshInstances.get(n);a||(a=[],this.layerMeshInstances.set(n,a)),a.push(i)}drawWireAlignedBox(e,t,s,i,n){Rp.push(e.x,e.y,e.z,e.x,t.y,e.z,e.x,t.y,e.z,t.x,t.y,e.z,t.x,t.y,e.z,t.x,e.y,e.z,t.x,e.y,e.z,e.x,e.y,e.z,e.x,e.y,t.z,e.x,t.y,t.z,e.x,t.y,t.z,t.x,t.y,t.z,t.x,t.y,t.z,t.x,e.y,t.z,t.x,e.y,t.z,e.x,e.y,t.z,e.x,e.y,e.z,e.x,e.y,t.z,e.x,t.y,e.z,e.x,t.y,t.z,t.x,t.y,e.z,t.x,t.y,t.z,t.x,e.y,e.z,t.x,e.y,t.z);this.getBatch(n,i).addLinesArrays(Rp,s),Rp.length=0}drawWireSphere(e,t,s,i,n,a){const r=2*Math.PI/i;let o=0;for(let s=0;s<i;s++){const s=Math.sin(o),i=Math.cos(o);o+=r;const n=Math.sin(o),a=Math.cos(o);Rp.push(e.x+t*s,e.y,e.z+t*i),Rp.push(e.x+t*n,e.y,e.z+t*a),Rp.push(e.x+t*s,e.y+t*i,e.z),Rp.push(e.x+t*n,e.y+t*a,e.z),Rp.push(e.x,e.y+t*s,e.z+t*i),Rp.push(e.x,e.y+t*n,e.z+t*a)}this.getBatch(a,n).addLinesArrays(Rp,s),Rp.length=0}getGraphNode(e){const t=new kh("ImmediateDebug");return t.worldTransform=e,t._dirtyWorld=t._dirtyNormal=!1,t}onPreRenderLayer(e,t,s){if(this.batchesMap.forEach(((i,n)=>{n===e&&i.onPreRender(t,s)})),!this.updatedLayers.has(e)){this.updatedLayers.add(e);const s=this.layerMeshInstances.get(e);if(s){for(let e=0;e<s.length;e++)t.list[t.length+e]=s[e];t.length+=s.length,s.length=0}}}onPostRender(){this.allBatches.clear(),this.updatedLayers.clear()}}class Ip extends C{constructor(e){super(),this.ambientBake=!1,this.ambientBakeOcclusionBrightness=0,this.ambientBakeOcclusionContrast=0,this.ambientLight=new pe(0,0,0),this.exposure=1,this.fogColor=new pe(0,0,0),this.fogDensity=0,this.fogEnd=1e3,this.fogStart=1,this.lightmapSizeMultiplier=1,this.lightmapMaxResolution=2048,this.lightmapMode=1,this.lightmapFilterEnabled=!1,this.root=null,this.sky=null,this.device=e||zc().graphicsDevice,this._gravity=new ge(0,-9.8,0),this._layers=null,this._fog="none",this._gammaCorrection=1,this._toneMapping=0,this._skyboxCubeMap=null,this._prefilteredCubemaps=[null,null,null,null,null,null],this._envAtlas=null,this._internalEnvAtlas=null,this._skyboxIntensity=1,this._skyboxMip=0,this._skyboxRotation=new Ae,this._skyboxRotationMat3=null,this._skyboxRotationMat4=null,this._ambientBakeNumSamples=1,this._ambientBakeSpherePart=.4,this._lightmapFilterRange=10,this._lightmapFilterSmoothness=.2,this._clusteredLightingEnabled=!0,this._lightingParams=new mp(this.device.supportsAreaLights,this.device.maxTextureSize,(()=>{this._layers._dirtyLights=!0})),this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,lastStaticPrepareFullTime:0,lastStaticPrepareSearchTime:0,lastStaticPrepareWriteTime:0,lastStaticPrepareTriAabbTime:0,lastStaticPrepareCombineTime:0,updateShadersTime:0},this.updateShaders=!0,this._shaderVersion=0,this._statsUpdated=!1,this.immediate=new Lp(this.device)}get defaultDrawLayer(){return this.layers.getLayerById(3)}set ambientBakeNumSamples(e){this._ambientBakeNumSamples=ne.clamp(Math.floor(e),1,255)}get ambientBakeNumSamples(){return this._ambientBakeNumSamples}set ambientBakeSpherePart(e){this._ambientBakeSpherePart=ne.clamp(e,.001,1)}get ambientBakeSpherePart(){return this._ambientBakeSpherePart}set clusteredLightingEnabled(e){this._clusteredLightingEnabled||!e?this._clusteredLightingEnabled=e:console.error("Turning on disabled clustered lighting is not currently supported")}get clusteredLightingEnabled(){return this._clusteredLightingEnabled}set drawCalls(e){}get drawCalls(){let e=this.layers._meshInstances;return e.length||(this.layers._update(this.device,this.clusteredLightingEnabled),e=this.layers._meshInstances),e}set envAtlas(e){e!==this._envAtlas&&(this._envAtlas=e,this.updateShaders=!0)}get envAtlas(){return this._envAtlas}set fog(e){e!==this._fog&&(this._fog=e,this.updateShaders=!0)}get fog(){return this._fog}set gammaCorrection(e){e!==this._gammaCorrection&&(this._gammaCorrection=e,this.updateShaders=!0)}get gammaCorrection(){return this._gammaCorrection}set layers(e){const t=this._layers;this._layers=e,this.fire("set:layers",t,e)}get layers(){return this._layers}get lighting(){return this._lightingParams}set lightmapFilterRange(e){this._lightmapFilterRange=Math.max(e,.001)}get lightmapFilterRange(){return this._lightmapFilterRange}set lightmapFilterSmoothness(e){this._lightmapFilterSmoothness=Math.max(e,.001)}get lightmapFilterSmoothness(){return this._lightmapFilterSmoothness}set prefilteredCubemaps(e){const t=this._prefilteredCubemaps;e=e||[];let s=!1,i=!0;for(let n=0;n<6;++n){const a=e[n]||null;t[n]!==a&&(t[n]=a,s=!0),i=i&&!!t[n]}s&&(this._resetSky(),i?(this._internalEnvAtlas=Sl.generatePrefilteredAtlas(t,{target:this._internalEnvAtlas}),this._envAtlas||(this.envAtlas=this._internalEnvAtlas)):this._internalEnvAtlas&&(this._envAtlas===this._internalEnvAtlas&&(this.envAtlas=null),this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null))}get prefilteredCubemaps(){return this._prefilteredCubemaps}set skybox(e){e!==this._skyboxCubeMap&&(this._skyboxCubeMap=e,this._resetSky())}get skybox(){return this._skyboxCubeMap}set skyboxIntensity(e){e!==this._skyboxIntensity&&(this._skyboxIntensity=e,this._resetSky())}get skyboxIntensity(){return this._skyboxIntensity}set skyboxMip(e){e!==this._skyboxMip&&(this._skyboxMip=e,this._resetSky())}get skyboxMip(){return this._skyboxMip}set skyboxRotation(e){this._skyboxRotation.equals(e)||(this._skyboxRotation.copy(e),this._resetSky())}get skyboxRotation(){return this._skyboxRotation}set toneMapping(e){e!==this._toneMapping&&(this._toneMapping=e,this.updateShaders=!0)}get toneMapping(){return this._toneMapping}destroy(){this._resetSky(),this.root=null,this.off()}drawLine(e,t,s=pe.WHITE,i=!0,n=this.defaultDrawLayer){this.immediate.getBatch(n,i).addLines([e,t],[s,s])}drawLines(e,t,s=!0,i=this.defaultDrawLayer){this.immediate.getBatch(i,s).addLines(e,t)}drawLineArrays(e,t,s=!0,i=this.defaultDrawLayer){this.immediate.getBatch(i,s).addLinesArrays(e,t)}applySettings(e){const t=e.physics,s=e.render;this._gravity.set(t.gravity[0],t.gravity[1],t.gravity[2]),this.ambientLight.set(s.global_ambient[0],s.global_ambient[1],s.global_ambient[2]),this._fog=s.fog,this.fogColor.set(s.fog_color[0],s.fog_color[1],s.fog_color[2]),this.fogStart=s.fog_start,this.fogEnd=s.fog_end,this.fogDensity=s.fog_density,this._gammaCorrection=s.gamma_correction,this._toneMapping=s.tonemapping,this.lightmapSizeMultiplier=s.lightmapSizeMultiplier,this.lightmapMaxResolution=s.lightmapMaxResolution,this.lightmapMode=s.lightmapMode,this.exposure=s.exposure,this._skyboxIntensity=void 0===s.skyboxIntensity?1:s.skyboxIntensity,this._skyboxMip=void 0===s.skyboxMip?0:s.skyboxMip,s.skyboxRotation&&this._skyboxRotation.setFromEulerAngles(s.skyboxRotation[0],s.skyboxRotation[1],s.skyboxRotation[2]),this.clusteredLightingEnabled=s.clusteredLightingEnabled,this.lighting.applySettings(s),["lightmapFilterEnabled","lightmapFilterRange","lightmapFilterSmoothness","ambientBake","ambientBakeNumSamples","ambientBakeSpherePart","ambientBakeOcclusionBrightness","ambientBakeOcclusionContrast"].forEach((e=>{s.hasOwnProperty(e)&&(this[e]=s[e])})),this._resetSky()}_getSkyboxTex(){const e=this._prefilteredCubemaps;if(this._skyboxMip){return e[[0,1,3,4,5,6][this._skyboxMip]]||this._envAtlas||e[0]||this._skyboxCubeMap}return this._skyboxCubeMap||e[0]||this._envAtlas}_updateSky(e){if(!this.sky){const t=this._getSkyboxTex();t&&(this.sky=new Cp(e,this,t),this.fire("set:skybox",t))}}_resetSky(){var e;null==(e=this.sky)||e.destroy(),this.sky=null,this.updateShaders=!0}setSkybox(e){e?(this.skybox=e[0]||null,this.prefilteredCubemaps=e.slice(1)):(this.skybox=null,this.prefilteredCubemaps=[null,null,null,null,null,null])}}class Dp{constructor(e){this._blobUrls={};for(let t=0,s=e.length;t<s;t++)e[t].url&&(this._blobUrls[e[t].name]=e[t].url)}hasBlobUrl(e){return!!this._blobUrls[e]}getBlobUrl(e){return this._blobUrls[e]}destroy(){for(const e in this._blobUrls)URL.revokeObjectURL(this._blobUrls[e]);this._blobUrls=null}}let Op;function Fp(e){let t,s;if("undefined"!=typeof TextDecoder)try{t=new TextDecoder("utf-8"),s=new TextDecoder("windows-1252")}catch(e){console.warn("TextDecoder not supported - pc.Untar module will not work")}else console.warn("TextDecoder not supported - pc.Untar module will not work");function i(e){this._fields=e}function n(e){this._arrayBuffer=e||new ArrayBuffer(0),this._bufferView=new DataView(this._arrayBuffer),this._globalPaxHeader=null,this._paxHeader=null,this._bytesRead=0}i.parse=function(e,s,n){const a=new Uint8Array(e,s,n);let r=0;const o=[];for(;r<n;){let i;for(i=r;i<n&&32!==a[i];i++);if(i>=n)throw new Error("Invalid PAX header data format.");const h=parseInt(t.decode(new Uint8Array(e,s+r,i-r)),10),l=t.decode(new Uint8Array(e,s+i+1,h-(i-r)-2)).split("=");if(2!==l.length)throw new Error("Invalid PAX header data format.");0===l[1].length&&(l[1]=null),o.push({name:l[0],value:l[1]}),r+=h}return new i(o)},i.prototype.applyHeader=function(e){for(let t=0;t<this._fields.length;t++){let s=this._fields[t].name;const i=this._fields[t].value;"path"===s&&(s="name"),null===i?delete e[s]:e[s]=i}},e||(Op=n),n.prototype._hasNext=function(){return this._bytesRead+4<this._arrayBuffer.byteLength&&0!==this._bufferView.getUint32(this._bytesRead)},n.prototype._readNextFile=function(){const t=new DataView(this._arrayBuffer,this._bytesRead,512),n=s.decode(t);this._bytesRead+=512;let a=n.substring(0,100).replace(/\0/g,"");const r=n.substring(257,263),o=parseInt(n.substring(124,136),8),h=n.substring(156,157),l=this._bytesRead;let c=null,d=!1;switch(h){case"0":case"":if(d=!0,!e){const e=new Blob([this._arrayBuffer.slice(this._bytesRead,this._bytesRead+o)]);c=URL.createObjectURL(e)}break;case"g":this._globalPaxHeader=i.parse(this._arrayBuffer,this._bytesRead,o);break;case"x":this._paxHeader=i.parse(this._arrayBuffer,this._bytesRead,o)}this._bytesRead+=o;const u=o%512;if(0!==u&&(this._bytesRead+=512-u),!d)return null;if(-1!==r.indexOf("ustar")){const e=n.substring(345,500).replace(/\0/g,"");e.length>0&&(a=e.trim()+a.trim())}const p={name:a,start:l,size:o,url:c};return this._globalPaxHeader&&this._globalPaxHeader.applyHeader(p),this._paxHeader&&(this._paxHeader.applyHeader(p),this._paxHeader=null),p},n.prototype.untar=function(e){if(!t)return console.error("Cannot untar because TextDecoder interface is not available for this platform."),[];const s=[];for(;this._hasNext();){const t=this._readNextFile();t&&(e&&t.name&&(t.name=e+t.name),s.push(t))}return s},e&&(self.onmessage=function(e){const t=e.data.id;try{const s=new n(e.data.arrayBuffer).untar(e.data.prefix);postMessage({id:t,files:s,arrayBuffer:e.data.arrayBuffer},[e.data.arrayBuffer])}catch(e){postMessage({id:t,error:e.toString()})}})}let kp=null;class Bp{constructor(e){this._requestId=0,this._pendingRequests={},this._filenamePrefix=e,this._worker=new Worker(function(){if(!kp){const e="("+Fp.toString()+")(true)\n\n",t=new Blob([e],{type:"application/javascript"});kp=URL.createObjectURL(t)}return kp}()),this._worker.addEventListener("message",this._onMessage.bind(this))}_onMessage(e){const t=e.data.id;if(!this._pendingRequests[t])return;const s=this._pendingRequests[t];if(delete this._pendingRequests[t],e.data.error)s(e.data.error);else{const t=e.data.arrayBuffer;for(let s=0,i=e.data.files.length;s<i;s++){const i=e.data.files[s],n=new Blob([t.slice(i.start,i.start+i.size)]);i.url=URL.createObjectURL(n)}s(null,e.data.files)}}untar(e,t){const s=this._requestId++;this._pendingRequests[s]=t,this._worker.postMessage({id:s,prefix:this._filenamePrefix,arrayBuffer:e},[e])}hasPendingRequests(){return Object.keys(this._pendingRequests).length>0}destroy(){this._worker&&(this._worker.terminate(),this._worker=null,this._pendingRequests=null)}}Fp();class zp{constructor(e){this.handlerType="bundle",this._assets=e.assets,this._worker=null,this.maxRetries=0}load(e,t){"string"==typeof e&&(e={load:e,original:e});const s=this;re.get(e.load,{responseType:ae.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(i,n){if(i)t("Error loading bundle resource "+e.original+": "+i);else try{s._untar(n,t)}catch(s){t("Error loading bundle resource "+e.original+": "+s)}}))}_untar(e,t){const s=this;if(N.workers)s._worker||(s._worker=new Bp(s._assets.prefix)),s._worker.untar(e,(function(e,i){t(e,i),s._worker.hasPendingRequests()||(s._worker.destroy(),s._worker=null)}));else{const i=new Op(e).untar(s._assets.prefix);t(null,i)}}open(e,t){return new Dp(t)}patch(e,t){}}class Up{constructor(e){this._handlers={},this._requests={},this._cache={},this._app=e}addHandler(e,t){this._handlers[e]=t,t._loader=this}removeHandler(e){delete this._handlers[e]}getHandler(e){return this._handlers[e]}load(e,t,s,i){const n=this._handlers[t];if(!n){return void s(`No resource handler for asset type: '${t}' when loading [${e}]`)}if(!e)return void this._loadNull(n,s,i);const a=e+t;if(void 0!==this._cache[a])s(null,this._cache[a]);else if(this._requests[a])this._requests[a].push(s);else{this._requests[a]=[s];const t=this,r=function(e,s){e?t._onFailure(a,e):n.load(s,(function(e,r,o){if(t._requests[a])if(e)t._onFailure(a,e);else try{t._onSuccess(a,n.open(s.original,r,i),o)}catch(e){t._onFailure(a,e)}}),i)},o=e.split("?")[0];if(this._app.enableBundles&&this._app.bundles.hasUrl(o)){if(!this._app.bundles.canLoadUrl(o))return void r(`Bundle for ${e} not loaded yet`);this._app.bundles.loadUrl(o,(function(e,t){r(e,{load:t,original:o})}))}else r(null,{load:e,original:i&&i.file.filename||e})}}_loadNull(e,t,s){e.load(null,(function(i,n,a){if(i)t(i);else try{t(null,e.open(null,n,s),a)}catch(e){t(e)}}),s)}_onSuccess(e,t,s){this._cache[e]=t;for(let i=0;i<this._requests[e].length;i++)this._requests[e][i](null,t,s);delete this._requests[e]}_onFailure(e,t){if(console.error(t),this._requests[e]){for(let s=0;s<this._requests[e].length;s++)this._requests[e][s](t);delete this._requests[e]}}open(e,t){const s=this._handlers[e];return s?s.open(null,t):(console.warn("No resource handler found for: "+e),t)}patch(e,t){const s=this._handlers[e.type];s?s.patch&&s.patch(e,t):console.warn("No resource handler found for: "+e.type)}clearCache(e,t){delete this._cache[e+t]}getFromCache(e,t){if(this._cache[e+t])return this._cache[e+t]}enableRetry(e=5){e=Math.max(0,e)||0;for(const t in this._handlers)this._handlers[t].maxRetries=e}disableRetry(){for(const e in this._handlers)this._handlers[e].maxRetries=0}destroy(){this._handlers={},this._requests={},this._cache={}}}const Vp={en:"en-US",es:"en-ES",zh:"zh-CN","zh-HK":"zh-TW","zh-TW":"zh-HK","zh-MO":"zh-HK",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"},Np={};function Gp(e,t){for(let s=0,i=e.length;s<i;s++)Np[e[s]]=t}function Wp(e){const t=e.indexOf("-");return-1!==t?e.substring(0,t):e}function Hp(e,t){if(t[e])return e;let s=Vp[e];if(s&&t[s])return s;const i=Wp(e);return s=Vp[i],t[s]?s:t[i]?i:"en-US"}Gp(["ja","ko","th","vi","zh","id"],(function(e){return 0})),Gp(["fa","hi"],(function(e){return e>=0&&e<=1?0:1})),Gp(["fr","pt"],(function(e){return e>=0&&e<2?0:1})),Gp(["da"],(function(e){return 1===e||!Number.isInteger(e)&&e>=0&&e<=1?0:1})),Gp(["de","en","it","el","es","tr","fi","sv","nb","no","ur"],(function(e){return 1===e?0:1})),Gp(["ru","uk"],(function(e){if(Number.isInteger(e)){const t=e%10,s=e%100;if(1===t&&11!==s)return 0;if(t>=2&&t<=4&&(s<12||s>14))return 1;if(0===t||t>=5&&t<=9||s>=11&&s<=14)return 2}return 3})),Gp(["pl"],(function(e){if(Number.isInteger(e)){if(1===e)return 0;const t=e%10,s=e%100;if(t>=2&&t<=4&&(s<12||s>14))return 1;if(t>=0&&t<=1||t>=5&&t<=9||s>=12&&s<=14)return 2}return 3})),Gp(["ar"],(function(e){if(0===e)return 0;if(1===e)return 1;if(2===e)return 2;if(Number.isInteger(e)){const t=e%100;if(t>=3&&t<=10)return 3;if(t>=11&&t<=99)return 4}return 5}));const Xp=Np[Wp("en-US")];function qp(e){return Np[e]||Xp}const jp=new RegExp("^\\s*(?:(?:[a-z]+[a-z0-9\\-\\+\\.]*:)?//|data:|blob:)","i"),Yp="animation",$p="audio",Kp="image",Zp="json",Qp="model",Jp="material",em="text",tm="texture",sm="cubemap",im="shader",nm="css",am="html",rm="script",om="container";class hm{constructor(e,t,s,i,n,a){this.url=e||"",this.filename=t||"",this.hash=void 0===s?null:s,this.size=void 0===i?null:i,this.opt=void 0===n?null:n,this.contents=a||null}equals(e){return this.url===e.url&&this.filename===e.filename&&this.hash===e.hash&&this.size===e.size&&this.opt===e.opt&&this.contents===e.contents}}let lm=-1;const cm={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",basis:"canvas"},dm=["pvr","dxt","etc2","etc1","basis"];class um extends C{constructor(e,t,s,i,n){super(),this._id=lm--,this.name=e||"",this.type=t,this.tags=new Z(this),this._preload=!1,this._file=null,this._data=i||{},this.options=n||{},this._resources=[],this._i18n={},this.loaded=!1,this.loading=!1,this.registry=null,s&&(this.file=s)}set id(e){this._id=e}get id(){return this._id}set file(e){if(e&&e.variants&&-1!==["texture","textureatlas","bundle"].indexOf(this.type)){var t,s;const i=(null==(t=this.registry)||null==(s=t._loader)?void 0:s._app)||zc(),n=null==i?void 0:i.graphicsDevice;if(n)for(let t=0,s=dm.length;t<s;t++){const s=dm[t];if(e.variants[s]&&n[cm[s]]){e=e.variants[s];break}if(i.enableBundles){const e=i.bundles.listBundlesForAsset(this);if(e&&e.find((e=>{var t;return null==e||null==(t=e.file)?void 0:t.variants[s]})))break}}}const i=this._file,n=e?new hm(e.url,e.filename,e.hash,e.size,e.opt,e.contents):null;(!!n!=!!i||n&&!n.equals(i))&&(this._file=n,this.fire("change",this,"file",n,i),this.reload())}get file(){return this._file}set data(e){const t=this._data;this._data=e,e!==t&&(this.fire("change",this,"data",e,t),this.loaded&&this.registry._loader.patch(this,this.registry))}get data(){return this._data}set resource(e){const t=this._resources[0];this._resources[0]=e,this.fire("change",this,"resource",e,t)}get resource(){return this._resources[0]}set resources(e){const t=this._resources;this._resources=e,this.fire("change",this,"resources",e,t)}get resources(){return this._resources}set preload(e){e=!!e,this._preload!==e&&(this._preload=e,this._preload&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this))}get preload(){return this._preload}set loadFaces(e){e=!!e,this.hasOwnProperty("_loadFaces")&&e===this._loadFaces||(this._loadFaces=e,this.loaded&&this.registry._loader.patch(this,this.registry))}get loadFaces(){return this._loadFaces}getFileUrl(){const e=this.file;if(!e||!e.url)return null;let t=e.url;if(this.registry&&this.registry.prefix&&!jp.test(t)&&(t=this.registry.prefix+t),"script"!==this.type&&e.hash){const s=-1!==t.indexOf("?")?"&":"?";t+=s+"t="+e.hash}return t}getAbsoluteUrl(e){if(e.startsWith("blob:")||e.startsWith("data:"))return e;const t=E.getDirectory(this.file.url);return E.join(t,e)}getLocalizedAssetId(e){return e=Hp(e,this._i18n),this._i18n[e]||null}addLocalizedAssetId(e,t){this._i18n[e]=t,this.fire("add:localized",e,t)}removeLocalizedAssetId(e){const t=this._i18n[e];t&&(delete this._i18n[e],this.fire("remove:localized",e,t))}ready(e,t){t=t||this,this.loaded?e.call(t,this):this.once("load",(function(s){e.call(t,s)}))}reload(){this.loaded&&(this.loaded=!1,this.registry.load(this))}unload(){if(!this.loaded&&0===this._resources.length)return;this.fire("unload",this),this.registry.fire("unload:"+this.id,this);const e=this._resources;this.resources=[],this.loaded=!1,this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type);for(let t=0;t<e.length;++t){const s=e[t];s&&s.destroy&&s.destroy()}}static fetchArrayBuffer(e,t,s,i=0){var n;null!=s&&null!=(n=s.file)&&n.contents?setTimeout((()=>{t(null,s.file.contents)})):re.get(e,{cache:!0,responseType:"arraybuffer",retry:i>0,maxRetries:i},t)}}class pm{constructor(e=null){this._index={},this._key=e}addItem(e){const t=e.tags._list;for(const s of t)this.add(s,e)}removeItem(e){const t=e.tags._list;for(const s of t)this.remove(s,e)}add(e,t){this._index[e]&&-1!==this._index[e].list.indexOf(t)||(this._index[e]||(this._index[e]={list:[]},this._key&&(this._index[e].keys={})),this._index[e].list.push(t),this._key&&(this._index[e].keys[t[this._key]]=t))}remove(e,t){if(!this._index[e])return;if(this._key&&!this._index[e].keys[t[this._key]])return;const s=this._index[e].list.indexOf(t);-1!==s&&(this._index[e].list.splice(s,1),this._key&&delete this._index[e].keys[t[this._key]],0===this._index[e].list.length&&delete this._index[e])}find(e){const t={},s=[];let i,n,a,r,o;const h=(e,t)=>this._index[e].list.length-this._index[t].list.length;for(let l=0;l<e.length;l++){if(n=e[l],n instanceof Array){if(0===n.length)continue;if(1!==n.length){o=!1;for(let e=0;e<n.length;e++)if(!this._index[n[e]]){o=!0;break}if(o)continue;a=n.slice(0).sort(h),r=a.slice(1),1===r.length&&(r=r[0]);for(let e=0;e<this._index[a[0]].list.length;e++)i=this._index[a[0]].list[e],(this._key?!t[i[this._key]]:-1===s.indexOf(i))&&i.tags.has(r)&&(this._key&&(t[i[this._key]]=!0),s.push(i));continue}n=n[0]}if(n&&"string"==typeof n&&this._index[n])for(let e=0;e<this._index[n].list.length;e++)i=this._index[n].list[e],this._key?t[i[this._key]]||(t[i[this._key]]=!0,s.push(i)):-1===s.indexOf(i)&&s.push(i)}return s}}class mm{constructor(e){this.handlerType="script",this._app=e,this._scripts={},this._cache={}}static _push(e){gm.legacy&&mm._types.length>0?console.assert("Script Ordering Error. Contact support@playcanvas.com"):mm._types.push(e)}load(e,t){"string"==typeof e&&(e={load:e,original:e});const s=this;gm.app=this._app,this._loadScript(e.load,((e,i,n)=>{if(e)t(e);else if(gm.legacy){let e=null;mm._types.length&&(e=mm._types.pop()),e?this._scripts[i]=e:e=null,t(null,e,n)}else{const e={};for(let t=0;t<mm._types.length;t++)e[mm._types[t].name]=mm._types[t];mm._types.length=0,t(null,e,n),delete s._loader._cache[i+"script"]}}))}open(e,t){return t}patch(e,t){}_loadScript(e,t){const s=document.head,i=document.createElement("script");this._cache[e]=i,i.async=!1,i.addEventListener("error",(function(e){t(`Script: ${e.target.src} failed to load`)}),!1);let n=!1;i.onload=i.onreadystatechange=function(){n||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(n=!0,t(null,e,i))},i.src=e,s.appendChild(i)}}mm._types=[];let fm=!1,_m=!1;const gm={app:null,create:function(e,t){if(!fm)return;const s=t(gm.app);s._pcScriptName=e,mm._push(s),this.fire("created",e,t)},attribute:function(e,t,s,i){},createLoadingScreen:function(e){if(_m)return;_m=!0;e(zc())}};Object.defineProperty(gm,"legacy",{get:function(){return fm},set:function(e){fm=e}}),A.attach(gm);class ym extends C{constructor(e){super(),this._loader=e,this._assets=[],this._cache={},this._names={},this._tags=new pm("_id"),this._urls={},this.prefix=null}list(e){return e=e||{},this._assets.filter((t=>{let s=!0;return void 0!==e.preload&&(s=t.preload===e.preload),s}))}add(e){const t=this._assets.push(e)-1;let s;this._cache[e.id]=t,this._names[e.name]||(this._names[e.name]=[]),this._names[e.name].push(t),e.file&&(s=e.file.url,this._urls[s]=t),e.registry=this,this._tags.addItem(e),e.tags.on("add",this._onTagAdd,this),e.tags.on("remove",this._onTagRemove,this),this.fire("add",e),this.fire("add:"+e.id,e),s&&this.fire("add:url:"+s,e),e.preload&&this.load(e)}remove(e){const t=this._cache[e.id],s=e.file?e.file.url:null;if(void 0!==t){this._assets.splice(t,1),delete this._cache[e.id],this._names={},this._urls=[];for(let e=0,t=this._assets.length;e<t;e++){const t=this._assets[e];this._cache[t.id]=e,this._names[t.name]||(this._names[t.name]=[]),this._names[t.name].push(e),t.file&&(this._urls[t.file.url]=e)}return this._tags.removeItem(e),e.tags.off("add",this._onTagAdd,this),e.tags.off("remove",this._onTagRemove,this),e.fire("remove",e),this.fire("remove",e),this.fire("remove:"+e.id,e),s&&this.fire("remove:url:"+s,e),!0}return!1}get(e){const t=this._cache[e];return this._assets[t]}getByUrl(e){const t=this._urls[e];return this._assets[t]}load(e){if(e.loading||e.loaded)return;const t=e.file,s=s=>{s instanceof Array?e.resources=s:e.resource=s,this._loader.patch(e,this),this.fire("load",e),this.fire("load:"+e.id,e),t&&t.url&&this.fire("load:url:"+t.url,e),e.fire("load",e)},i=(t,i,n)=>{if(e.loaded=!0,e.loading=!1,t)this.fire("error",t,e),this.fire("error:"+e.id,t,e),e.fire("error",t,e);else{if(!gm.legacy&&"script"===e.type){const t=this._loader.getHandler("script");t._cache[e.id]&&t._cache[e.id].parentNode===document.head&&document.head.removeChild(t._cache[e.id]),t._cache[e.id]=n}s(i)}};if(t||"cubemap"===e.type)this.fire("load:start",e),this.fire("load:"+e.id+":start",e),e.loading=!0,this._loader.load(e.getFileUrl(),e.type,i,e);else{const t=this._loader.open(e.type,e.data);e.loaded=!0,s(t)}}loadFromUrl(e,t,s){this.loadFromUrlAndFilename(e,null,t,s)}loadFromUrlAndFilename(e,t,s,i){const n=E.getBasename(t||e),a={filename:t||n,url:e};let r=this.getByUrl(e);if(r){if(r.loaded)return void i(r.loadFromUrlError||null,r)}else r=new um(n,s,a),this.add(r);const o=e=>{e.once("load",(e=>{"material"===s?this._loadTextures(e,((t,s)=>{i(t,e)})):i(null,e)})),e.once("error",(t=>{t&&(this.loadFromUrlError=t),i(t,e)})),this.load(e)};r.resource?i(null,r):"model"===s?this._loadModel(r,o):o(r)}_loadModel(e,t){const s=e.getFileUrl(),i=E.getExtension(s);if(".json"===i||".glb"===i){const n=E.getDirectory(s),a=E.getBasename(s),r=E.join(n,a.replace(i,".mapping.json"));this._loader.load(r,"json",((s,i)=>{s?(e.data={mapping:[]},t(e)):this._loadMaterials(e,i,((s,n)=>{e.data=i,t(e)}))}))}else t(e)}_loadMaterials(e,t,s){const i=[];let n=0;const a=(e,t)=>{this._loadTextures(t,((e,a)=>{i.push(t),i.length===n&&s(null,i)}))};for(let s=0;s<t.mapping.length;s++){const i=t.mapping[s].path;if(i){n++;const t=e.getAbsoluteUrl(i);this.loadFromUrl(t,"material",a)}}0===n&&s(null,i)}_loadTextures(e,t){const s=[];let i=0;const n=e.data;if("path"!==n.mappingFormat)return void t(null,s);const a=(e,n)=>{e&&console.error(e),s.push(n),s.length===i&&t(null,s)},r=Il;for(let t=0;t<r.length;t++){const s=n[r[t]];if(s&&"string"==typeof s){i++;const t=e.getAbsoluteUrl(s);this.loadFromUrl(t,"texture",a)}}0===i&&t(null,s)}findAll(e,t){const s=this._names[e];if(s){const e=s.map((e=>this._assets[e]));return t?e.filter((e=>e.type===t)):e}return[]}_onTagAdd(e,t){this._tags.add(e,t)}_onTagRemove(e,t){this._tags.remove(e,t)}findByTag(){return this._tags.find(arguments)}filter(e){return this._assets.filter((t=>e(t)))}find(e,t){const s=this.findAll(e,t);return s.length>0?s[0]:null}}class vm{constructor(e){this._assets=e,this._bundleAssets={},this._assetsInBundles={},this._urlsInBundles={},this._fileRequests={},this._assets.on("add",this._onAssetAdded,this),this._assets.on("remove",this._onAssetRemoved,this)}_onAssetAdded(e){if("bundle"===e.type){this._bundleAssets[e.id]=e,this._registerBundleEventListeners(e.id);for(let t=0,s=e.data.assets.length;t<s;t++)this._indexAssetInBundle(e.data.assets[t],e)}else this._assetsInBundles[e.id]&&this._indexAssetFileUrls(e)}_registerBundleEventListeners(e){this._assets.on("load:"+e,this._onBundleLoaded,this),this._assets.on("error:"+e,this._onBundleError,this)}_unregisterBundleEventListeners(e){this._assets.off("load:"+e,this._onBundleLoaded,this),this._assets.off("error:"+e,this._onBundleError,this)}_indexAssetInBundle(e,t){if(this._assetsInBundles[e]){const s=this._assetsInBundles[e];-1===s.indexOf(t)&&s.push(t)}else this._assetsInBundles[e]=[t];const s=this._assets.get(e);s&&this._indexAssetFileUrls(s)}_indexAssetFileUrls(e){const t=this._getAssetFileUrls(e);if(t)for(let s=0,i=t.length;s<i;s++){const i=t[s];this._urlsInBundles[i]=this._assetsInBundles[e.id]}}_getAssetFileUrls(e){let t=e.getFileUrl();if(!t)return null;t=this._normalizeUrl(t);const s=[t];if("font"===e.type){const i=e.data.info.maps.length;for(let e=1;e<i;e++)s.push(t.replace(".png",e+".png"))}return s}_normalizeUrl(e){return e&&e.split("?")[0]}_onAssetRemoved(e){if("bundle"===e.type){delete this._bundleAssets[e.id],this._unregisterBundleEventListeners(e.id);for(const t in this._assetsInBundles){const s=this._assetsInBundles[t],i=s.indexOf(e);if(-1!==i&&(s.splice(i,1),!s.length)){delete this._assetsInBundles[t];for(const e in this._urlsInBundles)this._urlsInBundles[e]===s&&delete this._urlsInBundles[e]}}this._onBundleError(`Bundle ${e.id} was removed`,e)}else if(this._assetsInBundles[e.id]){delete this._assetsInBundles[e.id];const t=this._getAssetFileUrls(e);for(let e=0,s=t.length;e<s;e++)delete this._urlsInBundles[t[e]]}}_onBundleLoaded(e){e.resource?requestAnimationFrame((()=>{if(this._fileRequests)for(const t in this._fileRequests){const s=this._urlsInBundles[t];if(!s||-1===s.indexOf(e))continue;const i=decodeURIComponent(t);let n=null;e.resource.hasBlobUrl(i)||(n=`Bundle ${e.id} does not contain URL ${t}`);const a=this._fileRequests[t];for(let t=0,s=a.length;t<s;t++)n?a[t](n):a[t](null,e.resource.getBlobUrl(i));delete this._fileRequests[t]}})):this._onBundleError(`Bundle ${e.id} failed to load`,e)}_onBundleError(e,t){for(const t in this._fileRequests){if(!this._findLoadedOrLoadingBundleForUrl(t)){const s=this._fileRequests[t];for(let t=0,i=s.length;t<i;t++)s[t](e);delete this._fileRequests[t]}}}_findLoadedOrLoadingBundleForUrl(e){const t=this._urlsInBundles[e];if(!t)return null;const s=t.length;for(let e=0;e<s;e++)if(t[e].loaded&&t[e].resource)return t[e];for(let e=0;e<s;e++)if(t[e].loading)return t[e];return null}listBundlesForAsset(e){return this._assetsInBundles[e.id]||null}list(){const e=[];for(const t in this._bundleAssets)e.push(this._bundleAssets[t]);return e}hasUrl(e){return!!this._urlsInBundles[e]}canLoadUrl(e){return!!this._findLoadedOrLoadingBundleForUrl(e)}loadUrl(e,t){const s=this._findLoadedOrLoadingBundleForUrl(e);if(s)if(s.loaded){const i=decodeURIComponent(e);if(!s.resource.hasBlobUrl(i))return void t(`Bundle ${s.id} does not contain URL ${e}`);t(null,s.resource.getBlobUrl(i))}else this._fileRequests.hasOwnProperty(e)?this._fileRequests[e].push(t):this._fileRequests[e]=[t];else t(`URL ${e} not found in any bundles`)}destroy(){this._assets.off("add",this._onAssetAdded,this),this._assets.off("remove",this._onAssetRemoved,this);for(const e in this._bundleAssets)this._unregisterBundleEventListeners(e);this._assets=null,this._bundleAssets=null,this._assetsInBundles=null,this._urlsInBundles=null,this._fileRequests=null}}const xm=["x","y","z","w"],bm=[void 0,void 0,ve,ge,xe];function Sm(e,t,s,i){switch(t.type){case"boolean":return!!s;case"number":if("number"==typeof s)return s;if("string"==typeof s){const e=parseInt(s,10);return isNaN(e)?null:e}return"boolean"==typeof s?0+s:null;case"json":{const i={};if(Array.isArray(t.schema)){s&&"object"==typeof s||(s={});for(let n=0;n<t.schema.length;n++){const a=t.schema[n];if(a.name)if(a.array){i[a.name]=[];const t=Array.isArray(s[a.name])?s[a.name]:[];for(let s=0;s<t.length;s++)i[a.name].push(Sm(e,a,t[s]))}else{const t=s.hasOwnProperty(a.name)?s[a.name]:a.default;i[a.name]=Sm(e,a,t)}}}return i}case"asset":return s instanceof um?s:"number"==typeof s?e.assets.get(s)||null:"string"==typeof s&&e.assets.get(parseInt(s,10))||null;case"entity":return s instanceof kh?s:"string"==typeof s?e.getEntityFromIndex(s):null;case"rgb":case"rgba":if(s instanceof pe)return i instanceof pe?(i.copy(s),i):s.clone();if(s instanceof Array&&s.length>=3&&s.length<=4){for(let e=0;e<s.length;e++)if("number"!=typeof s[e])return null;return i||(i=new pe),i.r=s[0],i.g=s[1],i.b=s[2],i.a=3===s.length?1:s[3],i}return"string"==typeof s&&/#([0-9abcdef]{2}){3,4}/i.test(s)?(i||(i=new pe),i.fromString(s),i):null;case"vec2":case"vec3":case"vec4":{const e=parseInt(t.type.slice(3),10),n=bm[e];if(s instanceof n)return i instanceof n?(i.copy(s),i):s.clone();if(s instanceof Array&&s.length===e){for(let e=0;e<s.length;e++)if("number"!=typeof s[e])return null;i||(i=new n);for(let t=0;t<e;t++)i[xm[t]]=s[t];return i}return null}case"curve":if(s){let e;if(s instanceof fe||s instanceof _e)e=s.clone();else{e=new(s.keys[0]instanceof Array?_e:fe)(s.keys),e.type=s.type}return e}}return s}class wm{constructor(e){this.scriptType=e,this.index={}}add(e,t){this.index[e]||wm.reservedNames.has(e)||(this.index[e]=t,Object.defineProperty(this.scriptType.prototype,e,{get:function(){return this.__attributes[e]},set:function(s){const i="attr",n="attr:"+e,a=this.__attributes[e];let r=a;if(a&&"json"!==t.type&&a.clone&&(this._callbacks.attr||this._callbacks[n])&&(r=a.clone()),t.array){if(this.__attributes[e]=[],s)for(let i=0,n=s.length;i<n;i++)this.__attributes[e].push(Sm(this.app,t,s[i],a?a[i]:null))}else this.__attributes[e]=Sm(this.app,t,s,a);this.fire(i,e,this.__attributes[e],r),this.fire(n,this.__attributes[e],r)}}))}remove(e){return!!this.index[e]&&(delete this.index[e],delete this.scriptType.prototype[e],!0)}has(e){return!!this.index[e]}get(e){return this.index[e]||null}}wm.reservedNames=new Set(["app","entity","enabled","_enabled","_enabledOld","_destroyed","__attributes","__attributesRaw","__scriptType","__executionOrder","_callbacks","has","get","on","off","fire","once","hasEvent"]);class Tm extends C{constructor(e,t){super(),this.system=void 0,this.entity=void 0,this.system=e,this.entity=t,this.system.schema&&!this._accessorsBuilt&&this.buildAccessors(this.system.schema),this.on("set",(function(e,t,s){this.fire("set_"+e,e,t,s)})),this.on("set_enabled",this.onSetEnabled,this)}static _buildAccessors(e,t){t.forEach((function(t){const s="object"==typeof t?t.name:t;Object.defineProperty(e,s,{get:function(){return this.data[s]},set:function(e){const t=this.data,i=t[s];t[s]=e,this.fire("set",s,i,e)},configurable:!0})})),e._accessorsBuilt=!0}buildAccessors(e){Tm._buildAccessors(this,e)}onSetEnabled(e,t,s){t!==s&&this.entity.enabled&&(s?this.onEnable():this.onDisable())}onEnable(){}onDisable(){}onPostStateChange(){}get data(){const e=this.system.store[this.entity.getGuid()];return e?e.data:null}}class Mm extends Tm{constructor(e,t){super(e,t),this._scripts=[],this._updateList=new K({sortBy:"__executionOrder"}),this._postUpdateList=new K({sortBy:"__executionOrder"}),this._scriptsIndex={},this._destroyedScripts=[],this._destroyed=!1,this._scriptsData=null,this._oldState=!0,this._enabled=!0,this._beingEnabled=!1,this._isLoopingThroughScripts=!1,this._executionOrder=-1,this.on("set_enabled",this._onSetEnabled,this)}set scripts(e){this._scriptsData=e;for(const t in e){if(!e.hasOwnProperty(t))continue;const s=this._scriptsIndex[t];if(s){if("boolean"==typeof e[t].enabled&&(s.enabled=!!e[t].enabled),"object"==typeof e[t].attributes)for(const i in e[t].attributes)if(!wm.reservedNames.has(i)){if(!s.__attributes.hasOwnProperty(i)){const e=this.system.app.scripts.get(t);e&&e.attributes.add(i,{})}s[i]=e[t].attributes[i]}}else console.log(this.order)}}get scripts(){return this._scripts}set enabled(e){const t=this._enabled;this._enabled=e,this.fire("set","enabled",t,e)}get enabled(){return this._enabled}onEnable(){this._beingEnabled=!0,this._checkState(),this.entity._beingEnabled||this.onPostStateChange(),this._beingEnabled=!1}onDisable(){this._checkState()}onPostStateChange(){const e=this._beginLooping();for(let e=0,t=this.scripts.length;e<t;e++){const t=this.scripts[e];t._initialized&&!t._postInitialized&&t.enabled&&(t._postInitialized=!0,t.postInitialize&&this._scriptMethod(t,Mm.scriptMethods.postInitialize))}this._endLooping(e)}_beginLooping(){const e=this._isLoopingThroughScripts;return this._isLoopingThroughScripts=!0,e}_endLooping(e){this._isLoopingThroughScripts=e,this._isLoopingThroughScripts||this._removeDestroyedScripts()}_onSetEnabled(e,t,s){this._beingEnabled=!0,this._checkState(),this._beingEnabled=!1}_checkState(){const e=this.enabled&&this.entity.enabled;if(e===this._oldState)return;this._oldState=e,this.fire(e?"enable":"disable"),this.fire("state",e),e?this.system._addComponentToEnabled(this):this.system._removeComponentFromEnabled(this);const t=this._beginLooping();for(let e=0,t=this.scripts.length;e<t;e++){const t=this.scripts[e];t.enabled=t._enabled}this._endLooping(t)}_onBeforeRemove(){this.fire("remove");const e=this._beginLooping();for(let e=0;e<this.scripts.length;e++){const t=this.scripts[e];t&&this.destroy(t.__scriptType.__name)}this._endLooping(e)}_removeDestroyedScripts(){const e=this._destroyedScripts.length;if(e){for(let t=0;t<e;t++){const e=this._destroyedScripts[t];this._removeScriptInstance(e)}this._destroyedScripts.length=0,this._resetExecutionOrder(0,this._scripts.length)}}_onInitializeAttributes(){for(let e=0,t=this.scripts.length;e<t;e++)this.scripts[e].__initializeAttributes()}_scriptMethod(e,t,s){e[t](s)}_onInitialize(){const e=this._scripts,t=this._beginLooping();for(let t=0,s=e.length;t<s;t++){const s=e[t];!s._initialized&&s.enabled&&(s._initialized=!0,s.initialize&&this._scriptMethod(s,Mm.scriptMethods.initialize))}this._endLooping(t)}_onPostInitialize(){this.onPostStateChange()}_onUpdate(e){const t=this._updateList;if(!t.length)return;const s=this._beginLooping();for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){const s=t.items[t.loopIndex];s.enabled&&this._scriptMethod(s,Mm.scriptMethods.update,e)}this._endLooping(s)}_onPostUpdate(e){const t=this._postUpdateList;if(!t.length)return;const s=this._beginLooping();for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){const s=t.items[t.loopIndex];s.enabled&&this._scriptMethod(s,Mm.scriptMethods.postUpdate,e)}this._endLooping(s)}_insertScriptInstance(e,t,s){-1===t?(this._scripts.push(e),e.__executionOrder=s,e.update&&this._updateList.append(e),e.postUpdate&&this._postUpdateList.append(e)):(this._scripts.splice(t,0,e),e.__executionOrder=t,this._resetExecutionOrder(t+1,s+1),e.update&&this._updateList.insert(e),e.postUpdate&&this._postUpdateList.insert(e))}_removeScriptInstance(e){const t=this._scripts.indexOf(e);return-1===t||(this._scripts.splice(t,1),e.update&&this._updateList.remove(e),e.postUpdate&&this._postUpdateList.remove(e)),t}_resetExecutionOrder(e,t){for(let s=e;s<t;s++)this._scripts[s].__executionOrder=s}_resolveEntityScriptAttribute(e,t,s,i,n,a){if(e.array){const e=s.length;if(!e)return;const r=s.slice();for(let t=0;t<e;t++){const e=r[t]instanceof $m?r[t].getGuid():r[t];a[e]&&(r[t]=i?a[e].getGuid():a[e])}n[t]=r}else{if(s instanceof $m)s=s.getGuid();else if("string"!=typeof s)return;a[s]&&(n[t]=a[s])}}has(e){if("string"==typeof e)return!!this._scriptsIndex[e];if(!e)return!1;const t=e,s=t.__name,i=this._scriptsIndex[s];return(i&&i.instance)instanceof t}get(e){if("string"==typeof e){const t=this._scriptsIndex[e];return t?t.instance:null}if(!e)return null;const t=e,s=t.__name,i=this._scriptsIndex[s],n=i&&i.instance;return n instanceof t?n:null}create(e,t={}){const s=this;let i=e,n=e;if("string"==typeof i?i=this.system.app.scripts.get(i):i&&(n=i.__name),i){if(!this._scriptsIndex[n]||!this._scriptsIndex[n].instance){const e=new i({app:this.system.app,entity:this.entity,enabled:!t.hasOwnProperty("enabled")||t.enabled,attributes:t.attributes}),a=this._scripts.length;let r=-1;return"number"==typeof t.ind&&-1!==t.ind&&a>t.ind&&(r=t.ind),this._insertScriptInstance(e,r,a),this._scriptsIndex[n]={instance:e,onSwap:function(){s.swap(n)}},this[n]=e,t.preloading||e.__initializeAttributes(),this.fire("create",n,e),this.fire("create:"+n,e),this.system.app.scripts.on("swap:"+n,this._scriptsIndex[n].onSwap),t.preloading||(e.enabled&&!e._initialized&&(e._initialized=!0,e.initialize&&this._scriptMethod(e,Mm.scriptMethods.initialize)),e.enabled&&!e._postInitialized&&(e._postInitialized=!0,e.postInitialize&&this._scriptMethod(e,Mm.scriptMethods.postInitialize))),e}}else this._scriptsIndex[n]={awaiting:!0,ind:this._scripts.length};return null}destroy(e){let t=e,s=e;"string"==typeof s?s=this.system.app.scripts.get(s):s&&(t=s.__name);const i=this._scriptsIndex[t];if(delete this._scriptsIndex[t],!i)return!1;const n=i.instance;if(n&&!n._destroyed)if(n.enabled=!1,n._destroyed=!0,this._isLoopingThroughScripts)this._destroyedScripts.push(n);else{const e=this._removeScriptInstance(n);e>=0&&this._resetExecutionOrder(e,this._scripts.length)}return this.system.app.scripts.off("swap:"+t,i.onSwap),delete this[t],this.fire("destroy",t,n||null),this.fire("destroy:"+t,n||null),n&&n.fire("destroy"),!0}swap(e){let t=e,s=e;"string"==typeof s?s=this.system.app.scripts.get(s):s&&(t=s.__name);const i=this._scriptsIndex[t];if(!i||!i.instance)return!1;const n=i.instance,a=this._scripts.indexOf(n),r=new s({app:this.system.app,entity:this.entity,enabled:n.enabled,attributes:n.__attributes});return!!r.swap&&(r.__initializeAttributes(),this._scripts[a]=r,this._scriptsIndex[t].instance=r,this[t]=r,r.__executionOrder=a,n.update&&this._updateList.remove(n),n.postUpdate&&this._postUpdateList.remove(n),r.update&&this._updateList.insert(r),r.postUpdate&&this._postUpdateList.insert(r),this._scriptMethod(r,Mm.scriptMethods.swap,n),this.fire("swap",t,r),this.fire("swap:"+t,r),!0)}resolveDuplicatedEntityReferenceProperties(e,t){const s=this.entity.script;for(const i in e._scriptsIndex){const n=this.system.app.scripts.get(i);if(!n)continue;const a=e._scriptsIndex[i];if(!a||!a.instance)continue;const r=s[i].__attributesRaw,o=s[i].__attributes;if(!r&&!o)continue;const h=!!r,l=a.instance.__attributes;for(const e in l){if(!l[e])continue;const s=n.attributes.get(e);if(s)if("entity"===s.type)this._resolveEntityScriptAttribute(s,e,l[e],h,r||o,t);else if("json"===s.type&&Array.isArray(s.schema)){const i=l[e],n=r?r[e]:o[e];for(let e=0;e<s.schema.length;e++){const a=s.schema[e];if("entity"===a.type)if(s.array)for(let e=0;e<i.length;e++)this._resolveEntityScriptAttribute(a,a.name,i[e][a.name],h,n[e],t);else this._resolveEntityScriptAttribute(a,a.name,i[a.name],h,n,t)}}}}}move(e,t){const s=this._scripts.length;if(t>=s||t<0)return!1;let i=e,n=e;"string"!=typeof n?n=e.__name:i=null;const a=this._scriptsIndex[n];if(!a||!a.instance)return!1;const r=a.instance;if(i&&!(r instanceof i))return!1;const o=this._scripts.indexOf(r);return-1!==o&&o!==t&&(this._scripts.splice(t,0,this._scripts.splice(o,1)[0]),this._resetExecutionOrder(0,s),this._updateList.sort(),this._postUpdateList.sort(),this.fire("move",n,r,t,o),this.fire("move:"+n,r,t,o),!0)}}Mm.scriptMethods={initialize:"initialize",postInitialize:"postInitialize",update:"update",postUpdate:"postUpdate",swap:"swap"};const Cm=new RegExp("^\\s*function(?:\\s|\\s*\\/\\*.*\\*\\/\\s*)+([^\\(\\s\\/]*)\\s*");class Am extends C{constructor(e){super(),this.app=void 0,this.entity=void 0,this._enabled=void 0,this._enabledOld=void 0,this._initialized=void 0,this._postInitialized=void 0,this.__destroyed=void 0,this.__attributes=void 0,this.__attributesRaw=void 0,this.__scriptType=void 0,this.__executionOrder=void 0,this.initScriptType(e)}set enabled(e){this._enabled=!!e,this.enabled!==this._enabledOld&&(this._enabledOld=this.enabled,this.fire(this.enabled?"enable":"disable"),this.fire("state",this.enabled),!this._initialized&&this.enabled&&(this._initialized=!0,this.__initializeAttributes(!0),this.initialize&&this.entity.script._scriptMethod(this,Mm.scriptMethods.initialize)),this._initialized&&!this._postInitialized&&this.enabled&&!this.entity.script._beingEnabled&&(this._postInitialized=!0,this.postInitialize&&this.entity.script._scriptMethod(this,Mm.scriptMethods.postInitialize)))}get enabled(){return this._enabled&&!this._destroyed&&this.entity.script.enabled&&this.entity.enabled}initScriptType(e){const t=this.constructor;this.app=e.app,this.entity=e.entity,this._enabled="boolean"!=typeof e.enabled||e.enabled,this._enabledOld=this.enabled,this.__destroyed=!1,this.__attributes={},this.__attributesRaw=e.attributes||{},this.__scriptType=t,this.__executionOrder=-1}static __getScriptName(e){if("function"!=typeof e)return;if("name"in Function.prototype)return e.name;if(e===Function||e===Function.prototype.constructor)return"Function";const t=(""+e).match(Cm);return t?t[1]:void 0}static get scriptName(){return this.__name}static get attributes(){return this.hasOwnProperty("__attributes")||(this.__attributes=new wm(this)),this.__attributes}__initializeAttributes(e){if(e||this.__attributesRaw){for(const e in this.__scriptType.attributes.index)this.__attributesRaw&&this.__attributesRaw.hasOwnProperty(e)?this[e]=this.__attributesRaw[e]:this.__attributes.hasOwnProperty(e)||(this.__scriptType.attributes.index[e].hasOwnProperty("default")?this[e]=this.__scriptType.attributes.index[e].default:this[e]=null);this.__attributesRaw=null}}static extend(e){for(const t in e)e.hasOwnProperty(t)&&(this.prototype[t]=e[t])}}Am.__name=null;class Pm extends C{constructor(e){super(),this.app=e,this._scripts={},this._list=[]}destroy(){this.app=null,this.off()}add(e){const t=e.__name;return this._scripts.hasOwnProperty(t)?(setTimeout((()=>{if(e.prototype.swap){const s=this._scripts[t],i=this._list.indexOf(s);this._list[i]=e,this._scripts[t]=e,this.fire("swap",t,e),this.fire("swap:"+t,e)}else console.warn(`script registry already has '${t}' script, define 'swap' method for new script type to enable code hot swapping`)})),!1):(this._scripts[t]=e,this._list.push(e),this.fire("add",t,e),this.fire("add:"+t,e),setTimeout((()=>{if(!this._scripts.hasOwnProperty(t))return;if(!this.app||!this.app.systems||!this.app.systems.script)return;const e=this.app.systems.script._components;let s;const i=[],n=[];for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++){const n=e.items[e.loopIndex];if(n._scriptsIndex[t]&&n._scriptsIndex[t].awaiting){n._scriptsData&&n._scriptsData[t]&&(s=n._scriptsData[t].attributes);const e=n.create(t,{preloading:!0,ind:n._scriptsIndex[t].ind,attributes:s});e&&i.push(e)}}for(let e=0;e<i.length;e++)i[e].__initializeAttributes();for(let e=0;e<i.length;e++)i[e].enabled&&(i[e]._initialized=!0,n.push(i[e]),i[e].initialize&&i[e].initialize());for(let e=0;e<n.length;e++)n[e].enabled&&!n[e]._postInitialized&&(n[e]._postInitialized=!0,n[e].postInitialize&&n[e].postInitialize())})),!0)}remove(e){let t=e,s=e;if("string"!=typeof s?s=t.__name:t=this.get(s),this.get(s)!==t)return!1;delete this._scripts[s];const i=this._list.indexOf(t);return this._list.splice(i,1),this.fire("remove",s,t),this.fire("remove:"+s,t),!0}get(e){return this._scripts[e]||null}has(e){if("string"==typeof e)return this._scripts.hasOwnProperty(e);if(!e)return!1;const t=e.__name;return this._scripts[t]===e}list(){return this._list}}class Em{_validate(e){if(!e.header)throw new Error('pc.I18n#addData: Missing "header" field');if(!e.header.version)throw new Error('pc.I18n#addData: Missing "header.version" field');if(1!==e.header.version)throw new Error('pc.I18n#addData: Invalid "header.version" field');if(!e.data)throw new Error('pc.I18n#addData: Missing "data" field');if(!Array.isArray(e.data))throw new Error('pc.I18n#addData: "data" field must be an array');for(let t=0,s=e.data.length;t<s;t++){const s=e.data[t];if(!s.info)throw new Error(`pc.I18n#addData: missing "data[${t}].info" field`);if(!s.info.locale)throw new Error(`pc.I18n#addData: missing "data[${t}].info.locale" field`);if("string"!=typeof s.info.locale)throw new Error(`pc.I18n#addData: "data[${t}].info.locale" must be a string`);if(!s.messages)throw new Error(`pc.I18n#addData: missing "data[${t}].messages" field`)}}parse(e){return e.data}}class Rm extends C{constructor(e){super(),this.locale="en-US",this._translations={},this._availableLangs={},this._app=e,this._assets=[],this._parser=new Em}set assets(e){const t={};for(let s=0,i=e.length;s<i;s++){t[e[s]instanceof um?e[s].id:e[s]]=!0}let s=this._assets.length;for(;s--;){const e=this._assets[s];if(!t[e]){this._app.assets.off("add:"+e,this._onAssetAdd,this);const t=this._app.assets.get(e);t&&this._onAssetRemove(t),this._assets.splice(s,1)}}for(const e in t){const t=parseInt(e,10);if(-1!==this._assets.indexOf(t))continue;this._assets.push(t);const s=this._app.assets.get(t);s?this._onAssetAdd(s):this._app.assets.once("add:"+t,this._onAssetAdd,this)}}get assets(){return this._assets}set locale(e){if(this._locale===e)return;let t=Wp(e);if("in"===t&&(t="id",e=function(e,t){const s=e.indexOf("-");return-1!==s?t+e.substring(s):t}(e,t),this._locale===e))return;const s=this._locale;this._locale=e,this._lang=t,this._pluralFn=qp(this._lang),this.fire("set:locale",e,s)}get locale(){return this._locale}static findAvailableLocale(e,t){return Hp(e,t)}findAvailableLocale(e){if(this._translations[e])return e;const t=Wp(e);return this._findFallbackLocale(e,t)}getText(e,t){let s,i=e;t||(t=this._locale,s=this._lang);let n=this._translations[t];return n||(s||(s=Wp(t)),t=this._findFallbackLocale(t,s),n=this._translations[t]),n&&n.hasOwnProperty(e)&&(i=n[e],Array.isArray(i)&&(i=i[0]),null==i&&(i=e)),i}getPluralText(e,t,s){let i,n,a=e;s?(i=Wp(s),n=qp(i)):(s=this._locale,i=this._lang,n=this._pluralFn);let r=this._translations[s];if(r||(i=Wp(s=this._findFallbackLocale(s,i)),n=qp(i),r=this._translations[s]),r&&r[e]&&n){const s=n(t);a=r[e][s],null==a&&(a=e)}return a}addData(e){let t;try{t=this._parser.parse(e)}catch(e){return void console.error(e)}for(let e=0,s=t.length;e<s;e++){const s=t[e],i=s.info.locale,n=s.messages;if(!this._translations[i]){this._translations[i]={};const e=Wp(i);this._availableLangs[e]||(this._availableLangs[e]=i)}Object.assign(this._translations[i],n),this.fire("data:add",i,n)}}removeData(e){let t;try{t=this._parser.parse(e)}catch(e){return void console.error(e)}for(let e=0,s=t.length;e<s;e++){const s=t[e],i=s.info.locale,n=this._translations[i];if(!n)continue;const a=s.messages;for(const e in a)delete n[e];0===Object.keys(n).length&&(delete this._translations[i],delete this._availableLangs[Wp(i)]),this.fire("data:remove",i,a)}}destroy(){this._translations=null,this._availableLangs=null,this._assets=null,this._parser=null,this.off()}_findFallbackLocale(e,t){let s=Vp[e];return s&&this._translations[s]?s:(s=Vp[t],s&&this._translations[s]?s:(s=this._availableLangs[t],s&&this._translations[s]?s:"en-US"))}_onAssetAdd(e){e.on("load",this._onAssetLoad,this),e.on("change",this._onAssetChange,this),e.on("remove",this._onAssetRemove,this),e.on("unload",this._onAssetUnload,this),e.resource&&this._onAssetLoad(e)}_onAssetLoad(e){this.addData(e.resource)}_onAssetChange(e){e.resource&&this.addData(e.resource)}_onAssetRemove(e){e.off("load",this._onAssetLoad,this),e.off("change",this._onAssetChange,this),e.off("remove",this._onAssetRemove,this),e.off("unload",this._onAssetUnload,this),e.resource&&this.removeData(e.resource),this._app.assets.once("add:"+e.id,this._onAssetAdd,this)}_onAssetUnload(e){e.resource&&this.removeData(e.resource)}}class Lm extends C{constructor(){super(),this.anim=void 0,this.animation=void 0,this.audiolistener=void 0,this.audiosource=void 0,this.button=void 0,this.camera=void 0,this.collision=void 0,this.element=void 0,this.joint=void 0,this.layoutchild=void 0,this.layoutgroup=void 0,this.light=void 0,this.model=void 0,this.particlesystem=void 0,this.render=void 0,this.rigidbody=void 0,this.screen=void 0,this.script=void 0,this.scrollbar=void 0,this.scrollview=void 0,this.sound=void 0,this.sprite=void 0,this.zone=void 0,this.list=[]}add(e){const t=e.id;if(this[t])throw new Error(`ComponentSystem name '${t}' already registered or not allowed`);this[t]=e,this.list.push(e)}remove(e){const t=e.id;if(!this[t])throw new Error(`No ComponentSystem named '${t}' registered`);delete this[t];const s=this.list.indexOf(this[t]);-1!==s&&this.list.splice(s,1)}destroy(){this.off();for(let e=0;e<this.list.length;e++)this.list[e].destroy()}}class Im{constructor(e){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,lightClustersTime:0,lightClusters:0,_timeToCountFrames:0,_fpsAccum:0},this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0},this.misc={renderTargetCreationTime:0},this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0},this.shaders=e._shaderStats,this.vram=e._vram,Object.defineProperty(this.vram,"totalUsed",{get:function(){return this.tex+this.vb+this.ib}}),Object.defineProperty(this.vram,"geom",{get:function(){return this.vb+this.ib}})}get scene(){return zc().scene._stats}get lightmapper(){var e;return null==(e=zc().lightmapper)?void 0:e.stats}get batcher(){const e=zc()._batcher;return e?e._stats:null}}class Dm{constructor(e,t){this.name=e,this.url=t,this.data=null,this._loading=!1,this._onLoadedCallbacks=[]}get loaded(){return!!this.data}get loading(){return this._loading}}class Om{constructor(e){this._app=e,this._list=[],this._index={},this._urlIndex={}}destroy(){this._app=null}list(){return this._list}add(e,t){if(this._index.hasOwnProperty(e))return!1;const s=new Dm(e,t),i=this._list.push(s);return this._index[s.name]=i-1,this._urlIndex[s.url]=i-1,!0}find(e){return this._index.hasOwnProperty(e)?this._list[this._index[e]]:null}findByUrl(e){return this._urlIndex.hasOwnProperty(e)?this._list[this._urlIndex[e]]:null}remove(e){if(this._index.hasOwnProperty(e)){const t=this._index[e];let s=this._list[t];delete this._urlIndex[s.url],delete this._index[e],this._list.splice(t,1);for(let e=0;e<this._list.length;e++)s=this._list[e],this._index[s.name]=e,this._urlIndex[s.url]=e}}_loadSceneData(e,t,s){let i=e;if(e instanceof Dm?i=e.url:(e=this.findByUrl(i))||(e=new Dm("Untitled",i)),!e.url)return void s("URL or SceneRegistryItem is null when loading a scene");if(e.loaded)return void s(null,e);const n=this._app.loader.getHandler("hierarchy");this._app.assets&&this._app.assets.prefix&&!jp.test(i)&&(i=E.join(this._app.assets.prefix,i)),e._onLoadedCallbacks.push(s),e._loading||n.load(i,(function(s,i){e.data=i,e._loading=!1;for(let t=0;t<e._onLoadedCallbacks.length;t++)e._onLoadedCallbacks[t](s,e);t||(e.data=null),e._onLoadedCallbacks.length=0})),e._loading=!0}loadSceneData(e,t){this._loadSceneData(e,!0,t)}unloadSceneData(e){"string"==typeof e&&(e=this.findByUrl(e)),e&&(e.data=null)}loadSceneHierarchy(e,t){const s=this,i=this._app.loader.getHandler("hierarchy");this._loadSceneData(e,!1,(function(e,n){if(e)return void(t&&t(e));const a=n.url,r=n.data;s._app._preloadScripts(r,(function(){s._app.systems.script.preloading=!0;const n=i.open(a,r);s._app.systems.script.preloading=!1,s._app.loader.clearCache(a,"hierarchy"),s._app.root.addChild(n),s._app.systems.fire("initialize",n),s._app.systems.fire("postInitialize",n),s._app.systems.fire("postPostInitialize",n),t&&t(e,n)}))}))}loadSceneSettings(e,t){const s=this;this._loadSceneData(e,!1,(function(e,i){e?t&&t(e):(s._app.applySceneSettings(i.data.settings),t&&t(null))}))}loadScene(e,t){const s=this,i=this._app.loader.getHandler("scene");this._app.assets&&this._app.assets.prefix&&!jp.test(e)&&(e=E.join(this._app.assets.prefix,e)),i.load(e,(function(n,a){if(n)t&&t(n);else{const n=function(){s._app.systems.script.preloading=!0;const n=i.open(e,a),r=s.findByUrl(e);r&&!r.loaded&&(r.data=a),s._app.systems.script.preloading=!1,s._app.loader.clearCache(e,"scene"),s._app.loader.patch({resource:n,type:"scene"},s._app.assets),s._app.root.addChild(n.root),s._app.systems.rigidbody&&"undefined"!=typeof Ammo&&s._app.systems.rigidbody.gravity.set(n._gravity.x,n._gravity.y,n._gravity.z),t&&t(null,n)};s._app._preloadScripts(a,n)}}))}}const Fm=["uSceneDepthMap","uDepthMap"],km=["uSceneColorMap","texture_grabPass"];class Bm{constructor(e){this.application=e,this.device=e.graphicsDevice,this.layer=null,this.colorFormat=this.device.defaultFramebufferAlpha?7:6,this.device.webgl2?this.initWebGl2():this.initWebGl1()}setupUniform(e,t,s){(t?Fm:km).forEach((t=>e.scope.resolve(t).setValue(s)))}allocateTexture(e,t,s,i,n,a){return new fh(e,{name:s,format:i,width:t?t.colorBuffer.width:e.width,height:t?t.colorBuffer.height:e.height,mipmaps:a,minFilter:n?0:a?5:1,magFilter:n?0:1,addressU:1,addressV:1})}resizeCondition(e,t,s){const i=(null==t?void 0:t.width)||s.width,n=(null==t?void 0:t.height)||s.height;return!e||i!==e.width||n!==e.height}allocateRenderTarget(e,t,s,i,n,a,r){const o=r?Fm:km,h=this.allocateTexture(s,t,o[0],i,n,a);return e?(e.destroyFrameBuffers(),n?e._depthBuffer=h:e._colorBuffer=h):e=new Jl({name:"renderTargetSceneGrab",colorBuffer:n?null:h,depthBuffer:n?h:null,depth:!n,stencil:s.supportsStencil,autoResolve:!1}),e}releaseRenderTarget(e){e&&(e.destroyTextureBuffers(),e.destroy())}initWebGl2(){const e=this.application,t=this;this.layer=new Ku({enabled:!1,name:"Depth",id:1,onDisable:function(){t.releaseRenderTarget(this.depthRenderTarget),this.depthRenderTarget=null,t.releaseRenderTarget(this.colorRenderTarget),this.colorRenderTarget=null},onPreRenderOpaque:function(s){const i=e.graphicsDevice,n=this.cameras[s];if(n.renderSceneColorMap){var a;t.resizeCondition(this.colorRenderTarget,null==(a=n.renderTarget)?void 0:a.colorBuffer,i)&&(t.releaseRenderTarget(this.colorRenderTarget),this.colorRenderTarget=t.allocateRenderTarget(this.colorRenderTarget,n.renderTarget,i,this.colorFormat,!1,!0,!1)),i.copyRenderTarget(i.renderTarget,this.colorRenderTarget,!0,!1),i.activeTexture(i.maxCombinedTextures-1);const e=this.colorRenderTarget.colorBuffer;i.bindTexture(e),i.gl.generateMipmap(e.impl._glTarget),t.setupUniform(i,!1,e)}var r;n.renderSceneDepthMap&&(t.resizeCondition(this.depthRenderTarget,null==(r=n.renderTarget)?void 0:r.depthBuffer,i)&&(t.releaseRenderTarget(this.depthRenderTarget),this.depthRenderTarget=t.allocateRenderTarget(this.depthRenderTarget,n.renderTarget,i,17,!0,!1,!0)),i.copyRenderTarget(i.renderTarget,this.depthRenderTarget,!1,!0),t.setupUniform(i,!0,this.depthRenderTarget.depthBuffer))},onPostRenderOpaque:function(e){}})}initWebGl1(){const e=this.application,t=this;this.layer=new Ku({enabled:!1,name:"Depth",id:1,shaderPass:2,onEnable:function(){this.depthRenderTarget=new Jl({name:"depthRenderTarget-webgl1",depth:!0,stencil:e.graphicsDevice.supportsStencil,autoResolve:!1,graphicsDevice:e.graphicsDevice}),this.renderTarget=this.depthRenderTarget},onDisable:function(){this.depthRenderTarget.destroyTextureBuffers(),this.renderTarget=null,t.releaseRenderTarget(this.colorRenderTarget),this.colorRenderTarget=null},onPostCull:function(s){const i=e.graphicsDevice,n=this.cameras[s];if(n.renderSceneDepthMap){var a;t.resizeCondition(this.depthRenderTarget,null==(a=n.renderTarget)?void 0:a.depthBuffer,i)&&(this.depthRenderTarget.destroyTextureBuffers(),this.depthRenderTarget=t.allocateRenderTarget(this.depthRenderTarget,n.renderTarget,i,7,!1,!1,!0));const r=this.instances.visibleOpaque[s],o=r.list,h=e.scene.layers,l=h.subLayerEnabled,c=h.subLayerList,d=e.scene.layers.getLayerById(0).renderTarget,u=this.cameras[s];let p=0;const m=h.layerList;for(let e=0;e<m.length;e++){const t=m[e];if(t===this)break;if(t.renderTarget!==d||!t.enabled||!l[e])continue;const s=t.cameras.indexOf(u);if(s<0)continue;let i=c[e]?t.instances.visibleTransparent[s]:t.instances.visibleOpaque[s];const n=i.length;i=i.list;for(let e=0;e<n;e++){const t=i[e];t.material&&t.material.depthWrite&&!t._noDepthDrawGl1&&(o[p]=t,p++)}}r.length=p}},onPreRenderOpaque:function(s){const i=e.graphicsDevice,n=this.cameras[s];if(n.renderSceneColorMap){var a;t.resizeCondition(this.colorRenderTarget,null==(a=n.renderTarget)?void 0:a.colorBuffer,i)&&(t.releaseRenderTarget(this.colorRenderTarget),this.colorRenderTarget=t.allocateRenderTarget(this.colorRenderTarget,n.renderTarget,i,this.colorFormat,!1,!1,!1));const e=this.colorRenderTarget._colorBuffer;e.impl._glTexture||e.impl.initialize(i,e),i.bindTexture(e);const s=i.gl;s.copyTexImage2D(s.TEXTURE_2D,0,e.impl._glFormat,0,0,e.width,e.height,0),e._needsUpload=!1,e._needsMipmapsUpload=!1,t.setupUniform(i,!1,e)}n.renderSceneDepthMap&&t.setupUniform(i,!0,this.depthRenderTarget.colorBuffer)},onDrawCall:function(){e.graphicsDevice.setColorWrite(!0,!0,!0,!0)},onPostRenderOpaque:function(e){if(this.cameras[e].renderSceneDepthMap){this.instances.visibleOpaque[e].length=0}}})}patch(e){e.onEnable=this.layer.onEnable,e.onDisable=this.layer.onDisable,e.onPreRenderOpaque=this.layer.onPreRenderOpaque,e.onPostRenderOpaque=this.layer.onPostRenderOpaque,e.shaderPass=this.layer.shaderPass,e.onPostCull=this.layer.onPostCull,e.onDrawCall=this.layer.onDrawCall}}const zm="NONE",Um="FILL_WINDOW",Vm="KEEP_ASPECT",Nm="AUTO",Gm="FIXED";class Wm{constructor(e){this.length=e,this.count=0}inc(){this.count++}done(){return this.count===this.length}}let Hm=null;class Xm extends C{constructor(e){super(),Xm._applications[e.id]=this,Uc(this),Hm=this,this._destroyRequested=!1,this._inFrameUpdate=!1,this._time=0,this.timeScale=1,this.maxDeltaTime=.1,this.frame=0,this.autoRender=!0,this.renderNextFrame=!1,this.useLegacyScriptAttributeCloning=gm.legacy,this._librariesLoaded=!1,this._fillMode="KEEP_ASPECT",this._resolutionMode="FIXED",this._allowResize=!0,this.context=this}init(e){const t=e.graphicsDevice;this.graphicsDevice=t,this._initDefaultMaterial(),this.stats=new Im(t),this._soundManager=e.soundManager,this.loader=new Up(this),jh.init(t),this._entityIndex={},this.scene=new Ip(t),this._registerSceneImmediate(this.scene),this.root=new $m,this.root._enabledInHierarchy=!0,this.assets=new ym(this.loader),e.assetPrefix&&(this.assets.prefix=e.assetPrefix),this.bundles=new vm(this.assets),this.enableBundles="undefined"!=typeof TextDecoder,this.scriptsOrder=e.scriptsOrder||[],this.scripts=new Pm(this),this.i18n=new Rm(this),this.scenes=new Om(this);const s=this;this.defaultLayerWorld=new Ku({name:"World",id:0}),this.sceneGrab=new Bm(this),this.defaultLayerDepth=this.sceneGrab.layer,this.defaultLayerSkybox=new Ku({enabled:!0,name:"Skybox",id:2,opaqueSortMode:0}),this.defaultLayerUi=new Ku({enabled:!0,name:"UI",id:4,transparentSortMode:1,passThrough:!1}),this.defaultLayerImmediate=new Ku({enabled:!0,name:"Immediate",id:3,opaqueSortMode:0,passThrough:!0});const i=new np("default");i.pushOpaque(this.defaultLayerWorld),i.pushOpaque(this.defaultLayerDepth),i.pushOpaque(this.defaultLayerSkybox),i.pushTransparent(this.defaultLayerWorld),i.pushOpaque(this.defaultLayerImmediate),i.pushTransparent(this.defaultLayerImmediate),i.pushTransparent(this.defaultLayerUi),this.scene.layers=i,this.scene.on("set:layers",(function(e,t){const i=t.layerList;let n;for(let e=0;e<i.length;e++)switch(n=i[e],n.id){case 1:s.sceneGrab.patch(n);break;case 4:n.passThrough=s.defaultLayerUi.passThrough;break;case 3:n.passThrough=s.defaultLayerImmediate.passThrough}})),wp.createPlaceholder(t),this.renderer=new Vu(t),this.renderer.scene=this.scene,this.frameGraph=new xp,this.lightmapper=null,e.lightmapper&&(this.lightmapper=new e.lightmapper(t,this.root,this.scene,this.renderer,this.assets),this.once("prerender",this._firstBake,this)),this._batcher=null,e.batchManager&&(this._batcher=new e.batchManager(t,this.root,this.scene),this.once("prerender",this._firstBatch,this)),this.keyboard=e.keyboard||null,this.mouse=e.mouse||null,this.touch=e.touch||null,this.gamepads=e.gamepads||null,this.elementInput=e.elementInput||null,this.elementInput&&(this.elementInput.app=this),this.xr=e.xr?new e.xr(this):null,this.elementInput&&this.elementInput.attachSelectEvents(),this._inTools=!1,this._skyboxAsset=null,this._scriptPrefix=e.scriptPrefix||"",this.enableBundles&&this.loader.addHandler("bundle",new zp(this)),e.resourceHandlers.forEach((e=>{const t=new e(this);this.loader.addHandler(t.handlerType,t)})),this.systems=new Lm,e.componentSystems.forEach((e=>{this.systems.add(new e(this))})),this._visibilityChangeHandler=this.onVisibilityChange.bind(this),"undefined"!=typeof document&&(void 0!==document.hidden?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.mozHidden?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.msHidden?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.webkitHidden&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1))),this.tick=jm(this)}static getApplication(e){return e?Xm._applications[e]:zc()}_initDefaultMaterial(){const e=new zl;e.name="Default Material",e.shadingModel=1,function(e,t){wl.get(e,(()=>t))}(this.graphicsDevice,e)}get soundManager(){return this._soundManager}get batcher(){return this._batcher}get fillMode(){return this._fillMode}get resolutionMode(){return this._resolutionMode}configure(e,t){re.get(e,((e,s)=>{if(e)return void t(e);const i=s.application_properties,n=s.scenes,a=s.assets;this._parseApplicationProperties(i,(e=>{this._parseScenes(n),this._parseAssets(a),t(e||null)}))}))}preload(e){this.fire("preload:start");const t=this.assets.list({preload:!0}),s=new Wm(t.length);let i=!1;const n=()=>{this.graphicsDevice&&!i&&s.done()&&(i=!0,this.fire("preload:end"),e())},a=t.length;if(s.length){const e=e=>{s.inc(),this.fire("preload:progress",s.count/a),s.done()&&n()},i=(e,t)=>{s.inc(),this.fire("preload:progress",s.count/a),s.done()&&n()};for(let r=0;r<t.length;r++)t[r].loaded?(s.inc(),this.fire("preload:progress",s.count/a),s.done()&&n()):(t[r].once("load",e),t[r].once("error",i),this.assets.load(t[r]))}else n()}_preloadScripts(e,t){if(!gm.legacy)return void t();this.systems.script.preloading=!0;const s=this._getScriptReferences(e),i=s.length,n=new Wm(i),a=/^http(s)?:\/\//;if(i){const e=(e,s)=>{e&&console.error(e),n.inc(),n.done()&&(this.systems.script.preloading=!1,t())};for(let t=0;t<i;t++){let i=s[t];!a.test(i.toLowerCase())&&this._scriptPrefix&&(i=E.join(this._scriptPrefix,s[t])),this.loader.load(i,"script",e)}}else this.systems.script.preloading=!1,t()}_handleAreaLightDataProperty(e){const t=this.assets.get(e);t?this.setAreaLightLuts(t):this.assets.once("add:"+e,this.setAreaLightLuts,this)}_parseApplicationProperties(e,t){if("number"==typeof e.maxAssetRetries&&e.maxAssetRetries>0&&this.loader.enableRetry(e.maxAssetRetries),e.useDevicePixelRatio||(e.useDevicePixelRatio=e.use_device_pixel_ratio),e.resolutionMode||(e.resolutionMode=e.resolution_mode),e.fillMode||(e.fillMode=e.fill_mode),this._width=e.width,this._height=e.height,e.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio),this.setCanvasResolution(e.resolutionMode,this._width,this._height),this.setCanvasFillMode(e.fillMode,this._width,this._height),e.layers&&e.layerOrder){const t=new np("application"),s={};for(const t in e.layers){const i=e.layers[t];i.id=parseInt(t,10),i.enabled=1!==i.id,s[t]=new Ku(i)}for(let i=0,n=e.layerOrder.length;i<n;i++){const n=e.layerOrder[i],a=s[n.layer];a&&(n.transparent?t.pushTransparent(a):t.pushOpaque(a),t.subLayerEnabled[i]=n.enabled)}this.scene.layers=t}if(e.batchGroups){const t=this.batcher;if(t)for(let s=0,i=e.batchGroups.length;s<i;s++){const i=e.batchGroups[s];t.addGroup(i.name,i.dynamic,i.maxAabbSize,i.id,i.layers)}}e.i18nAssets&&(this.i18n.assets=e.i18nAssets),e.areaLightDataAsset&&this._handleAreaLightDataProperty(e.areaLightDataAsset),this._loadLibraries(e.libraries,t)}_loadLibraries(e,t){const s=e.length;let i=s;const n=/^http(s)?:\/\//;if(s){const a=(e,s)=>{i--,e?t(e):0===i&&(this.onLibrariesLoaded(),t(null))};for(let t=0;t<s;++t){let s=e[t];!n.test(s.toLowerCase())&&this._scriptPrefix&&(s=E.join(this._scriptPrefix,s)),this.loader.load(s,"script",a)}}else this.onLibrariesLoaded(),t(null)}_parseScenes(e){if(e)for(let t=0;t<e.length;t++)this.scenes.add(e[t].name,e[t].url)}_parseAssets(e){const t=[],s={},i={};if(gm.legacy){if(this.enableBundles)for(const s in e)"bundle"===e[s].type&&(i[s]=!0,t.push(e[s]));for(const s in e)i[s]||t.push(e[s])}else{for(let i=0;i<this.scriptsOrder.length;i++){const n=this.scriptsOrder[i];e[n]&&(s[n]=!0,t.push(e[n]))}if(this.enableBundles)for(const s in e)"bundle"===e[s].type&&(i[s]=!0,t.push(e[s]));for(const n in e)s[n]||i[n]||t.push(e[n])}for(let e=0;e<t.length;e++){const s=t[e],i=new um(s.name,s.type,s.file,s.data);if(i.id=parseInt(s.id,10),i.preload=!!s.preload&&s.preload,i.loaded="script"===s.type&&s.data&&s.data.loadingType>0,i.tags.add(s.tags),s.i18n)for(const e in s.i18n)i.addLocalizedAssetId(e,s.i18n[e]);this.assets.add(i)}}_getScriptReferences(e){let t=[];e.settings.priority_scripts&&(t=e.settings.priority_scripts);const s=[],i={};for(let e=0;e<t.length;e++)s.push(t[e]),i[t[e]]=!0;const n=e.entities;for(const e in n){if(!n[e].components.script)continue;const t=n[e].components.script.scripts;for(let e=0;e<t.length;e++)i[t[e].url]||(s.push(t[e].url),i[t[e].url]=!0)}return s}start(){this.frame=0,this.fire("start",{timestamp:Q(),target:this}),this._librariesLoaded||this.onLibrariesLoaded(),this.systems.fire("initialize",this.root),this.fire("initialize"),this.systems.fire("postInitialize",this.root),this.systems.fire("postPostInitialize",this.root),this.fire("postinitialize"),this.tick()}inputUpdate(e){this.controller&&this.controller.update(e),this.mouse&&this.mouse.update(),this.keyboard&&this.keyboard.update(),this.gamepads&&this.gamepads.update()}update(e){this.frame++,this.graphicsDevice.updateClientRect(),gm.legacy&&this.systems.fire("fixedUpdate",1/60),this.systems.fire(this._inTools?"toolsUpdate":"update",e),this.systems.fire("animationUpdate",e),this.systems.fire("postUpdate",e),this.fire("update",e),this.inputUpdate(e)}render(){this.fire("prerender"),this.root.syncHierarchy(),this._batcher&&this._batcher.updateAll(),this.renderComposition(this.scene.layers),this.fire("postrender")}renderComposition(e){this.renderer.buildFrameGraph(this.frameGraph,e),this.frameGraph.render()}_fillFrameStatsBasic(e,t,s){const i=this.stats.frame;i.dt=t,i.ms=s,e>i._timeToCountFrames?(i.fps=i._fpsAccum,i._fpsAccum=0,i._timeToCountFrames=e+1e3):i._fpsAccum++,this.stats.drawCalls.total=this.graphicsDevice._drawCallsPerFrame,this.graphicsDevice._drawCallsPerFrame=0}_fillFrameStats(){let e=this.stats.frame;e.cameras=this.renderer._camerasRendered,e.materials=this.renderer._materialSwitches,e.shaders=this.graphicsDevice._shaderSwitchesPerFrame,e.shadowMapUpdates=this.renderer._shadowMapUpdates,e.shadowMapTime=this.renderer._shadowMapTime,e.depthMapTime=this.renderer._depthMapTime,e.forwardTime=this.renderer._forwardTime;const t=this.graphicsDevice._primsPerFrame;e.triangles=t[4]/3+Math.max(t[5]-2,0)+Math.max(t[6]-2,0),e.cullTime=this.renderer._cullTime,e.sortTime=this.renderer._sortTime,e.skinTime=this.renderer._skinTime,e.morphTime=this.renderer._morphTime,e.lightClusters=this.renderer._lightClusters,e.lightClustersTime=this.renderer._lightClustersTime,e.otherPrimitives=0;for(let s=0;s<t.length;s++)s<4&&(e.otherPrimitives+=t[s]),t[s]=0;this.renderer._camerasRendered=0,this.renderer._materialSwitches=0,this.renderer._shadowMapUpdates=0,this.graphicsDevice._shaderSwitchesPerFrame=0,this.renderer._cullTime=0,this.renderer._layerCompositionUpdateTime=0,this.renderer._lightClustersTime=0,this.renderer._sortTime=0,this.renderer._skinTime=0,this.renderer._morphTime=0,this.renderer._shadowMapTime=0,this.renderer._depthMapTime=0,this.renderer._forwardTime=0,e=this.stats.drawCalls,e.forward=this.renderer._forwardDrawCalls,e.culled=this.renderer._numDrawCallsCulled,e.depth=0,e.shadow=this.renderer._shadowDrawCalls,e.skinned=this.renderer._skinDrawCalls,e.immediate=0,e.instanced=0,e.removedByInstancing=0,e.misc=e.total-(e.forward+e.shadow),this.renderer._depthDrawCalls=0,this.renderer._shadowDrawCalls=0,this.renderer._forwardDrawCalls=0,this.renderer._numDrawCallsCulled=0,this.renderer._skinDrawCalls=0,this.renderer._immediateRendered=0,this.renderer._instancedDrawCalls=0,this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime,e=this.stats.particles,e.updatesPerFrame=e._updatesPerFrame,e.frameTime=e._frameTime,e._updatesPerFrame=0,e._frameTime=0}setCanvasFillMode(e,t,s){this._fillMode=e,this.resizeCanvas(t,s)}setCanvasResolution(e,t,s){this._resolutionMode=e,"AUTO"===e&&void 0===t&&(t=this.graphicsDevice.canvas.clientWidth,s=this.graphicsDevice.canvas.clientHeight),this.graphicsDevice.resizeCanvas(t,s)}isHidden(){return document[this._hiddenAttr]}onVisibilityChange(){this.isHidden()?this._soundManager&&this._soundManager.suspend():this._soundManager&&this._soundManager.resume()}resizeCanvas(e,t){if(!this._allowResize)return;if(this.xr&&this.xr.session)return;const s=window.innerWidth,i=window.innerHeight;if("KEEP_ASPECT"===this._fillMode){const n=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;n>s/i?t=(e=s)/n:e=(t=i)*n}else"FILL_WINDOW"===this._fillMode&&(e=s,t=i);return this.graphicsDevice.canvas.style.width=e+"px",this.graphicsDevice.canvas.style.height=t+"px",this.updateCanvasSize(),{width:e,height:t}}updateCanvasSize(){var e;if(this._allowResize&&(null==(e=this.xr)||!e.active)&&"AUTO"===this._resolutionMode){const e=this.graphicsDevice.canvas;this.graphicsDevice.resizeCanvas(e.clientWidth,e.clientHeight)}}onLibrariesLoaded(){this._librariesLoaded=!0,this.systems.rigidbody&&this.systems.rigidbody.onLibraryLoaded()}applySceneSettings(e){let t;if(this.systems.rigidbody&&"undefined"!=typeof Ammo){const t=e.physics.gravity;this.systems.rigidbody.gravity.set(t[0],t[1],t[2])}this.scene.applySettings(e),e.render.hasOwnProperty("skybox")&&(e.render.skybox?(t=this.assets.get(e.render.skybox),t?this.setSkybox(t):this.assets.once("add:"+e.render.skybox,this.setSkybox,this)):this.setSkybox(null))}setAreaLightLuts(e){if(e){const t=this.graphicsDevice;e.ready((e=>{wp.set(t,e.resource)})),this.assets.load(e)}}setSkybox(e){if(e!==this._skyboxAsset){const t=()=>{this.setSkybox(null)},s=()=>{this.scene.setSkybox(this._skyboxAsset?this._skyboxAsset.resources:null)};this._skyboxAsset&&(this.assets.off("load:"+this._skyboxAsset.id,s,this),this.assets.off("remove:"+this._skyboxAsset.id,t,this),this._skyboxAsset.off("change",s,this)),this._skyboxAsset=e,this._skyboxAsset&&(this.assets.on("load:"+this._skyboxAsset.id,s,this),this.assets.once("remove:"+this._skyboxAsset.id,t,this),this._skyboxAsset.on("change",s,this),0!==this.scene.skyboxMip||this._skyboxAsset.loadFaces||(this._skyboxAsset.loadFaces=!0),this.assets.load(this._skyboxAsset)),s()}}_firstBake(){var e;null==(e=this.lightmapper)||e.bake(null,this.scene.lightmapMode)}_firstBatch(){var e;null==(e=this.batcher)||e.generate()}_processTimestamp(e){return e}drawLine(e,t,s,i,n){this.scene.drawLine(e,t,s,i,n)}drawLines(e,t,s=!0,i=this.scene.defaultDrawLayer){this.scene.drawLines(e,t,s,i)}drawLineArrays(e,t,s=!0,i=this.scene.defaultDrawLayer){this.scene.drawLineArrays(e,t,s,i)}drawWireSphere(e,t,s=pe.WHITE,i=20,n=!0,a=this.scene.defaultDrawLayer){this.scene.immediate.drawWireSphere(e,t,s,i,n,a)}drawWireAlignedBox(e,t,s=pe.WHITE,i=!0,n=this.scene.defaultDrawLayer){this.scene.immediate.drawWireAlignedBox(e,t,s,i,n)}drawMeshInstance(e,t=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(null,null,null,e,t)}drawMesh(e,t,s,i=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(t,s,e,null,i)}drawQuad(e,t,s=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(t,e,this.scene.immediate.getQuadMesh(),null,s)}drawTexture(e,t,s,i,n,a,r=this.scene.defaultDrawLayer){const o=new Ce;o.setTRS(new ge(e,t,0),Ae.IDENTITY,new ge(s,i,0)),a||((a=new Al).setParameter("colorMap",n),a.shader=this.scene.immediate.getTextureShader(),a.update()),this.drawQuad(o,a,r)}drawDepthTexture(e,t,s,i,n=this.scene.defaultDrawLayer){const a=new Al;a.shader=this.scene.immediate.getDepthTextureShader(),a.update(),this.drawTexture(e,t,s,i,null,a,n)}destroy(){var e;if(this._inFrameUpdate)return void(this._destroyRequested=!0);const t=this.graphicsDevice.canvas.id;this.off("librariesloaded"),"undefined"!=typeof document&&(document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1)),this._visibilityChangeHandler=null,this.root.destroy(),this.root=null,this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null),this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null),this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null),this.elementInput&&(this.elementInput.detach(),this.elementInput=null),this.controller&&(this.controller=null),this.systems.destroy(),this.scene.layers&&this.scene.layers.destroy();const s=this.assets.list();for(let e=0;e<s.length;e++)s[e].unload(),s[e].off();this.assets.off(),this.bundles.destroy(),this.bundles=null,this.i18n.destroy(),this.i18n=null;for(const e in this.loader.getHandler("script")._cache){const t=this.loader.getHandler("script")._cache[e],s=t.parentNode;s&&s.removeChild(t)}this.loader.getHandler("script")._cache={},this.loader.destroy(),this.loader=null,this.scene.destroy(),this.scene=null,this.systems=null,this.context=null,this.scripts.destroy(),this.scripts=null,this.scenes.destroy(),this.scenes=null,null==(e=this.lightmapper)||e.destroy(),this.lightmapper=null,this._batcher&&(this._batcher.destroy(),this._batcher=null),this._entityIndex={},this.defaultLayerDepth.onPreRenderOpaque=null,this.defaultLayerDepth.onPostRenderOpaque=null,this.defaultLayerDepth.onDisable=null,this.defaultLayerDepth.onEnable=null,this.defaultLayerDepth=null,this.defaultLayerWorld=null,null==this||this.xr.end(),null==this||this.xr.destroy(),this.renderer.destroy(),this.renderer=null,this.graphicsDevice.destroy(),this.graphicsDevice=null,this.tick=null,this.off(),this._soundManager&&(this._soundManager.destroy(),this._soundManager=null),gm.app=null,Xm._applications[t]=null,zc()===this&&Uc(null)}getEntityFromIndex(e){return this._entityIndex[e]}_registerSceneImmediate(e){this.on("postrender",e.immediate.onPostRender,e.immediate)}}Xm._applications={};const qm={},jm=function(e){const t=e;let s;return function(e,i){var n;if(!t.graphicsDevice)return;Uc(t),s&&(window.cancelAnimationFrame(s),s=null),Hm=t;const a=t._processTimestamp(e)||Q(),r=a-(t._time||a);let o=r/1e3;if(o=ne.clamp(o,0,t.maxDeltaTime),o*=t.timeScale,t._time=a,s=null!=(n=t.xr)&&n.session?t.xr.session.requestAnimationFrame(t.tick):N.browser?window.requestAnimationFrame(t.tick):null,!t.graphicsDevice.contextLost){var h;if(t._fillFrameStatsBasic(a,o,r),t._inFrameUpdate=!0,t.fire("frameupdate",r),i)null==(h=t.xr)||h.update(i),t.graphicsDevice.defaultFramebuffer=i.session.renderState.baseLayer.framebuffer;else t.graphicsDevice.defaultFramebuffer=null;t.update(o),t.fire("framerender"),(t.autoRender||t.renderNextFrame)&&(t.updateCanvasSize(),t.render(),t.renderNextFrame=!1),qm.timestamp=Q(),qm.target=t,t.fire("frameend",qm),t._inFrameUpdate=!1,t._destroyRequested&&t.destroy()}}},Ym=[];class $m extends kh{constructor(e,t){if(super(e),this.anim=void 0,this.animation=void 0,this.audiolistener=void 0,this.button=void 0,this.camera=void 0,this.collision=void 0,this.element=void 0,this.layoutchild=void 0,this.layoutgroup=void 0,this.light=void 0,this.model=void 0,this.particlesystem=void 0,this.render=void 0,this.rigidbody=void 0,this.screen=void 0,this.script=void 0,this.scrollbar=void 0,this.scrollview=void 0,this.sound=void 0,this.sprite=void 0,this.c={},this._app=void 0,this._destroying=!1,this._guid=null,this._template=!1,e instanceof Xm&&(t=e),!t&&!(t=Xm.getApplication()))throw new Error("Couldn't find current application");this._app=t}addComponent(e,t){const s=this._app.systems[e];return s?this.c[e]?null:s.addComponent(this,t):null}removeComponent(e){const t=this._app.systems[e];t&&this.c[e]&&t.removeComponent(this)}findComponent(e){const t=this.findOne((function(t){return t.c&&t.c[e]}));return t&&t.c[e]}findComponents(e){return this.find((function(t){return t.c&&t.c[e]})).map((function(t){return t.c[e]}))}getGuid(){return this._guid||this.setGuid(P.create()),this._guid}setGuid(e){const t=this._app._entityIndex;this._guid&&delete t[this._guid],this._guid=e,t[this._guid]=this}_notifyHierarchyStateChanged(e,t){let s=!1;e===this&&0===Ym.length&&(s=!0),e._beingEnabled=!0,e._onHierarchyStateChanged(t),e._onHierarchyStatePostChanged&&Ym.push(e);const i=e._children;for(let e=0,s=i.length;e<s;e++)i[e]._enabled&&this._notifyHierarchyStateChanged(i[e],t);if(e._beingEnabled=!1,s){for(let e=0;e<Ym.length;e++)Ym[e]._onHierarchyStatePostChanged();Ym.length=0}}_onHierarchyStateChanged(e){super._onHierarchyStateChanged(e);const t=this.c;for(const s in t)if(t.hasOwnProperty(s)){const i=t[s];i.enabled&&(e?i.onEnable():i.onDisable())}}_onHierarchyStatePostChanged(){const e=this.c;for(const t in e)e.hasOwnProperty(t)&&e[t].onPostStateChange()}findByGuid(e){if(this._guid===e)return this;const t=this._app._entityIndex[e];return t&&(t===this||t.isDescendantOf(this))?t:null}destroy(){this._destroying=!0;for(const e in this.c)this.c[e].enabled=!1;for(const e in this.c)this.c[e].system.removeComponent(this);this._parent&&this._parent.removeChild(this);const e=this._children;for(;e.length;){const t=e.pop();t._parent=null,t instanceof $m&&t.destroy()}this.fire("destroy",this),this.off(),this._guid&&delete this._app._entityIndex[this._guid],this._destroying=!1}clone(){const e={},t=this._cloneRecursively(e);return e[this.getGuid()]=t,Km(this,this,t,e),t}_cloneRecursively(e){const t=new this.constructor(this._app);super._cloneInternal(t);for(const e in this.c){this.c[e].system.cloneComponent(this,t)}for(let s=0;s<this._children.length;s++){const i=this._children[s];if(i instanceof $m){const s=i._cloneRecursively(e);t.addChild(s),e[i.getGuid()]=s}}return t}}function Km(e,t,s,i){if(t instanceof $m){const n=t.c;for(const t in n){const a=n[t],r=a.system.getPropertiesOfType("entity");for(let n=0,o=r.length;n<o;n++){const o=r[n].name,h=a[o];if(!!e.findByGuid(h)){const e=i[h].getGuid();e&&(s.c[t][o]=e)}}}n.script&&!s._app.useLegacyScriptAttributeCloning&&s.script.resolveDuplicatedEntityReferenceProperties(n.script,i),n.render&&s.render.resolveDuplicatedEntityReferenceProperties(n.render,i),n.anim&&s.anim.resolveDuplicatedEntityReferenceProperties(n.anim,i);const a=t.children.filter((function(e){return e instanceof $m})),r=s.children.filter((function(e){return e instanceof $m}));for(let t=0,s=a.length;t<s;t++)Km(e,a[t],r[t],i)}}const Zm=new ge;class Qm extends gp{constructor(e){const t=new $m("AmbientLight");t.addComponent("light",{type:"directional",affectDynamic:!0,affectLightmapped:!1,bake:!0,bakeNumSamples:e.ambientBakeNumSamples,castShadows:!0,normalOffsetBias:.05,shadowBias:.2,shadowDistance:1,shadowResolution:2048,shadowType:0,color:pe.WHITE,intensity:1,bakeDir:!1}),super(e,t.light.light)}get numVirtualLights(){return this.light.bakeNumSamples}prepareVirtualLight(e,t){tl(Zm,e,t,0,this.scene.ambientBakeSpherePart),this.light._node.lookAt(Zm.mulScalar(-1)),this.light._node.rotateLocal(90,0,0);const s=this.scene.gammaCorrection?2.2:1,i=2*Math.PI*this.scene.ambientBakeSpherePart,n=Math.pow(i,s);this.light.intensity=Math.pow(n/t,1/s)}}class Jm{constructor(e,t=null){this.node=e,this.component=e.render||e.model,t=t||this.component.meshInstances,this.store(),this.meshInstances=t,this.bounds=null,this.renderTargets=[]}store(){this.castShadows=this.component.castShadows}restore(){this.component.castShadows=this.castShadows}}class ef{constructor(e){this.device=e,this.shaderDilate=eh(e,Bo.fullscreenQuadVS,fp.dilatePS,"lmDilate"),this.constantTexSource=e.scope.resolve("source"),this.constantPixelOffset=e.scope.resolve("pixelOffset"),this.pixelOffset=new Float32Array(2),this.shaderDenoise=null,this.sigmas=null,this.constantSigmas=null,this.kernel=null}setSourceTexture(e){this.constantTexSource.setValue(e)}prepare(e,t){this.pixelOffset[0]=1/e,this.pixelOffset[1]=1/t,this.constantPixelOffset.setValue(this.pixelOffset)}prepareDenoise(e,t){this.shaderDenoise||(this.shaderDenoise=eh(this.device,Bo.fullscreenQuadVS,fp.bilateralDeNoisePS,"lmBilateralDeNoise"),this.sigmas=new Float32Array(2),this.constantSigmas=this.device.scope.resolve("sigmas"),this.constantKernel=this.device.scope.resolve("kernel[0]"),this.bZnorm=this.device.scope.resolve("bZnorm")),this.sigmas[0]=e,this.sigmas[1]=t,this.constantSigmas.setValue(this.sigmas),this.evaluateDenoiseUniforms(e,t)}evaluateDenoiseUniforms(e,t){function s(e,t){return.39894*Math.exp(-.5*e*e/(t*t))/t}this.kernel=this.kernel||new Float32Array(15);const i=this.kernel,n=Math.floor(7);for(let t=0;t<=n;++t){const a=s(t,e);i[n+t]=a,i[n-t]=a}this.constantKernel.setValue(this.kernel);const a=1/s(0,t);this.bZnorm.setValue(a)}}const tf=new ge;class sf{constructor(e,t,s,i,n){this.device=e,this.root=t,this.scene=s,this.renderer=i,this.assets=n,this.shadowMapCache=i._shadowRenderer.shadowMapCache,this._tempSet=new Set,this._initCalled=!1,this.passMaterials=[],this.ambientAOMaterial=null,this.fog="",this.ambientLight=new pe,this.renderTargets=new Map,this.stats={renderPasses:0,lightmapCount:0,totalRenderTime:0,forwardTime:0,fboTime:0,shadowMapTime:0,compileTime:0,shadersLinked:0}}destroy(){pd.decRef(this.blackTex),this.blackTex=null,pd.destroy(),this.device=null,this.root=null,this.scene=null,this.renderer=null,this.assets=null}initBake(e){if(!this._initCalled){this._initCalled=!0,this.lightmapFilters=new ef(e),this.constantBakeDir=e.scope.resolve("bakeDir"),this.materials=[],this.blackTex=new fh(this.device,{width:4,height:4,format:7,type:"rgbm",name:"lightmapBlack"}),pd.incRef(this.blackTex);const t=new xh;t.clearColor.set(0,0,0,0),t.clearColorBuffer=!0,t.clearDepthBuffer=!1,t.clearStencilBuffer=!1,t.frustumCulling=!1,t.projection=1,t.aspectRatio=1,t.node=new kh,this.camera=t}if(this.scene.clusteredLightingEnabled){const t=new mp(e.supportsAreaLights,e.maxTextureSize,(()=>{}));this.lightingParams=t;const s=this.scene.lighting;t.shadowsEnabled=s.shadowsEnabled,t.shadowAtlasResolution=s.shadowAtlasResolution,t.cookiesEnabled=s.cookiesEnabled,t.cookieAtlasResolution=s.cookieAtlasResolution,t.areaLightsEnabled=s.areaLightsEnabled,t.cells=new ge(3,3,3),t.maxLightsPerCell=4,this.worldClusters=new kd(e),this.worldClusters.name="ClusterLightmapper"}}finishBake(e){function t(e){pd.decRef(e.colorBuffer),e.destroy()}this.materials=[],this.renderTargets.forEach((e=>{t(e)})),this.renderTargets.clear(),e.forEach((e=>{e.renderTargets.forEach((e=>{t(e)})),e.renderTargets.length=0})),this.ambientAOMaterial=null,this.worldClusters&&(this.worldClusters.destroy(),this.worldClusters=null)}createMaterialForPass(e,t,s,i){const n=new zl;if(n.name=`lmMaterial-pass:${s}-ambient:${i}`,n.chunks.APIVersion="1.55",n.chunks.transformVS="#define UV1LAYOUT\n"+Bo.transformVS,0===s){let e=fp.bakeLmEndPS;i?e=`\n                    dDiffuseLight = ((dDiffuseLight - 0.5) * max(${t.ambientBakeOcclusionContrast.toFixed(1)} + 1.0, 0.0)) + 0.5;\n                    dDiffuseLight += vec3(${t.ambientBakeOcclusionBrightness.toFixed(1)});\n                    dDiffuseLight = saturate(dDiffuseLight);\n                    dDiffuseLight *= dAmbientLight;\n                `+e:(n.ambient=new pe(0,0,0),n.ambientTint=!0),n.chunks.endPS=e,n.lightMap=this.blackTex}else n.chunks.basePS=Bo.basePS+"\nuniform sampler2D texture_dirLightMap;\nuniform float bakeDir;\n",n.chunks.endPS=fp.bakeDirLmEndPS;return n.chunks.outputAlphaPS="\n",n.chunks.outputAlphaOpaquePS="\n",n.chunks.outputAlphaPremulPS="\n",n.cull=0,n.forceUv1=!0,n.update(),n}createMaterials(e,t,s){for(let i=0;i<s;i++)this.passMaterials[i]||(this.passMaterials[i]=this.createMaterialForPass(e,t,i,!1));this.ambientAOMaterial||(this.ambientAOMaterial=this.createMaterialForPass(e,t,0,!0),this.ambientAOMaterial.onUpdateShader=function(e){return e.lightMapWithoutAmbient=!0,e.separateAmbient=!0,e})}createTexture(e,t,s){return new fh(this.device,{width:e,height:e,format:7,mipmaps:!1,type:t,minFilter:0,magFilter:0,addressU:1,addressV:1,name:s})}collectModels(e,t,s){var i,n,a;if(!e.enabled)return;let r;if(null!=(i=e.model)&&i.model&&null!=(n=e.model)&&n.enabled&&(s&&s.push(new Jm(e)),e.model.lightmapped&&t&&(r=e.model.model.meshInstances)),null!=(a=e.render)&&a.enabled&&(s&&s.push(new Jm(e)),e.render.lightmapped&&t&&(r=e.render.meshInstances)),r){let s=!0;for(let e=0;e<r.length;e++)if(!r[e].mesh.vertexBuffer.format.hasUv1){s=!1;break}if(s){const s=[];for(let i=0;i<r.length;i++){const n=r[i].mesh;this._tempSet.has(n)?t.push(new Jm(e,[r[i]])):s.push(r[i]),this._tempSet.add(n)}this._tempSet.clear(),s.length>0&&t.push(new Jm(e,s))}}for(let i=0;i<e._children.length;i++)this.collectModels(e._children[i],t,s)}prepareShadowCasters(e){const t=[];for(let s=0;s<e.length;s++){const i=e[s].component;if(i.castShadows=i.castShadowsLightmap,i.castShadowsLightmap){const i=e[s].meshInstances;for(let e=0;e<i.length;e++)i[e].visibleThisFrame=!0,t.push(i[e])}}return t}updateTransforms(e){for(let t=0;t<e.length;t++){const s=e[t].meshInstances;for(let e=0;e<s.length;e++)s[e].node.getWorldTransform()}}calculateLightmapSize(e){let t;const s=this.scene.lightmapSizeMultiplier||16,i=tf;let n,a;e.model?(a=e.model.lightmapSizeMultiplier,e.model.asset?(t=this.assets.get(e.model.asset).data,t.area&&(n=t.area)):e.model._area&&(t=e.model,t._area&&(n=t._area))):e.render&&(a=e.render.lightmapSizeMultiplier,"asset"!==e.render.type&&e.render._area&&(t=e.render,t._area&&(n=t._area)));const r={x:1,y:1,z:1,uv:1};n&&(r.x=n.x,r.y=n.y,r.z=n.z,r.uv=n.uv);const o=a||1;r.x*=o,r.y*=o,r.z*=o;const h=e.render||e.model,l=this.computeNodeBounds(h.meshInstances);i.copy(l.halfExtents);let c=r.x*i.y*i.z+r.y*i.x*i.z+r.z*i.x*i.y;c/=r.uv,c=Math.sqrt(c);return Math.min(ne.nextPowerOfTwo(c*s),this.scene.lightmapMaxResolution||2048)}setLightmapping(e,t,s,i){for(let n=0;n<e.length;n++){const a=e[n],r=a.meshInstances;for(let e=0;e<r.length;e++){const n=r[e];if(n.setLightmapped(t),t){i&&(n._shaderDefs|=i),n.mask=2;for(let e=0;e<s;e++){const t=a.renderTargets[e].colorBuffer;t.minFilter=1,t.magFilter=1,n.setRealtimeLightmap(xd.lightmapParamNames[e],t)}}}}}bake(e,t=1){const s=this.device,i=Q();this.scene._updateSky(s),this.stats.renderPasses=0,this.stats.shadowMapTime=0,this.stats.forwardTime=0;const n=s._shaderStats.linked,a=s._renderTargetCreationTime,r=s._shaderStats.compileTime,o=[],h=[];if(e){for(let t=0;t<e.length;t++)this.collectModels(e[t],o,null);this.collectModels(this.root,null,h)}else this.collectModels(this.root,o,h);if(o.length>0){const e=1===t?2:1;this.setLightmapping(o,!1,e),this.initBake(s),this.bakeInternal(e,o,h);let i=64;1===t&&(i|=128),this.scene.ambientBake&&(i|=8192),this.setLightmapping(o,!0,e,i),this.finishBake(o)}const l=Q();this.stats.totalRenderTime=l-i,this.stats.shadersLinked=s._shaderStats.linked-n,this.stats.compileTime=s._shaderStats.compileTime-r,this.stats.fboTime=s._renderTargetCreationTime-a,this.stats.lightmapCount=o.length}allocateTextures(e,t){for(let s=0;s<e.length;s++){const i=e[s],n=this.calculateLightmapSize(i.node);for(let e=0;e<t;e++){const t=this.createTexture(n,"default","lightmapper_lightmap_"+s);pd.incRef(t),i.renderTargets[e]=new Jl({colorBuffer:t,depth:!1})}if(!this.renderTargets.has(n)){const e=this.createTexture(n,"default","lightmapper_temp_lightmap_"+n);pd.incRef(e),this.renderTargets.set(n,new Jl({colorBuffer:e,depth:!1}))}}}prepareLightsToBake(e,t,s){if(this.scene.ambientBake){const e=new Qm(this.scene);s.push(e)}const i=e._lights;for(let e=0;e<i.length;e++){const n=i[e],a=new vp(this.scene,n);t.push(a),n.enabled&&0!=(4&n.mask)&&(n.isStatic=!1,n.mask=4294967295,n.shadowUpdateMode=0===n.type?2:1,s.push(a))}s.sort()}restoreLights(e){for(let t=0;t<e.length;t++)e[t].restore()}setupScene(){this.revertStatic=!1,this.scene._needsStaticPrepare&&(this.scene._needsStaticPrepare=!1,this.revertStatic=!0),this.fog=this.scene.fog,this.ambientLight.copy(this.scene.ambientLight),this.scene.fog="none",this.scene.ambientBake||this.scene.ambientLight.set(0,0,0),this.renderer.setSceneConstants()}restoreScene(){this.scene.fog=this.fog,this.scene.ambientLight.copy(this.ambientLight),this.revertStatic&&(this.scene._needsStaticPrepare=!0)}computeNodeBounds(e){const t=new De;if(e.length>0){t.copy(e[0].aabb);for(let s=1;s<e.length;s++)t.add(e[s].aabb)}return t}computeNodesBounds(e){for(let t=0;t<e.length;t++){const s=e[t].meshInstances;e[t].bounds=this.computeNodeBounds(s)}}computeBounds(e){const t=new De;for(let s=0;s<e.length;s++){t.copy(e[0].aabb);for(let s=1;s<e.length;s++)t.add(e[s].aabb)}return t}backupMaterials(e){for(let t=0;t<e.length;t++)this.materials[t]=e[t].material}restoreMaterials(e){for(let t=0;t<e.length;t++)e[t].material=this.materials[t]}lightCameraPrepare(e,t){const s=t.light;let i;if(2===s.type){i=s.getRenderData(null,0).shadowCamera,i._node.setPosition(s._node.getPosition()),i._node.setRotation(s._node.getRotation()),i._node.rotateLocal(-90,0,0),i.projection=0,i.nearClip=s.attenuationEnd/1e3,i.farClip=s.attenuationEnd,i.aspectRatio=1,i.fov=2*s._outerConeAngle,this.renderer.updateCameraFrustum(i)}return i}lightCameraPrepareAndCull(e,t,s,i){const n=e.light;let a=!0;if(0===n.type){tf.copy(i.center),tf.y+=i.halfExtents.y,this.camera.node.setPosition(tf),this.camera.node.setEulerAngles(-90,0,0),this.camera.nearClip=0,this.camera.farClip=2*i.halfExtents.y;const e=Math.max(i.halfExtents.x,i.halfExtents.z);this.camera.orthoHeight=e}else e.lightBounds.intersects(t.bounds)||(a=!1);if(2===n.type){let e=!1;const i=t.meshInstances;for(let t=0;t<i.length;t++)if(i[t]._isVisible(s)){e=!0;break}e||(a=!1)}return a}setupLightArray(e,t){e[0].length=0,e[1].length=0,e[2].length=0,e[t.type][0]=t,t.visibleThisFrame=!0}renderShadowMap(e,t,s,i){const n=i.light;return!e&&n.castShadows&&(n.shadowMap||this.scene.clusteredLightingEnabled||(n.shadowMap=this.shadowMapCache.get(this.device,n)),0===n.type?this.renderer._shadowRenderer.cullDirectional(n,t,this.camera):this.renderer._shadowRenderer.cullLocal(n,t),this.renderer.renderShadows(s[n.type],this.camera)),!0}postprocessTextures(e,t,s){const i=this.lightmapFilters.shaderDilate,n=this.scene.lightmapFilterEnabled;n&&this.lightmapFilters.prepareDenoise(this.scene.lightmapFilterRange,this.scene.lightmapFilterSmoothness);for(let a=0;a<t.length;a++){const r=t[a];for(let t=0;t<s;t++){const s=r.renderTargets[t],a=s.colorBuffer,o=this.renderTargets.get(a.width),h=o.colorBuffer;this.lightmapFilters.prepare(a.width,a.height);for(let r=0;r<1;r++){this.lightmapFilters.setSourceTexture(a);bo(e,o,n&&0===t&&0===r?this.lightmapFilters.shaderDenoise:i),this.lightmapFilters.setSourceTexture(h),bo(e,s,i)}}}}bakeInternal(e,t,s){const i=this.scene,n=this.device,a=i.clusteredLightingEnabled;this.createMaterials(n,i,e),this.setupScene(),i.layers._update(),this.computeNodesBounds(t),this.allocateTextures(t,e);const r=[],o=[];this.prepareLightsToBake(i.layers,r,o),this.updateTransforms(s);const h=this.prepareShadowCasters(s);this.renderer.updateCpuSkinMatrices(h),this.renderer.gpuUpdate(h);const l=this.computeBounds(h);let c,d,u,p;for(c=0;c<t.length;c++){for(u=t[c].meshInstances,d=0;d<u.length;d++)p=u[d],p.setLightmapped(!1),p.mask=4,p.setRealtimeLightmap(xd.lightmapParamNames[0],p.material.lightMap?p.material.lightMap:this.blackTex),p.setRealtimeLightmap(xd.lightmapParamNames[1],this.blackTex)}for(d=0;d<o.length;d++)o[d].light.enabled=!1;const m=[[],[],[]];let f,_,g=!1;for(c=0;c<o.length;c++){const s=o[c],r=s instanceof Qm;let y=s.numVirtualLights;e>1&&y>1&&s.light.bakeDir&&(y=1);for(let o=0;o<y;o++){y>1&&s.prepareVirtualLight(o,y),s.startBake();let c=!1;const v=this.lightCameraPrepare(n,s);for(_=0;_<t.length;_++){const x=t[_];u=x.meshInstances;if(this.lightCameraPrepareAndCull(s,x,v,l)){if(this.setupLightArray(m,s.light),a&&this.renderer.lightTextureAtlas.update(m[2],m[1],this.lightingParams),c=this.renderShadowMap(c,h,m,s),a){const e=m[2].concat(m[1]);this.worldClusters.update(e,this.scene.gammaCorrection,this.lightingParams)}for(this.backupMaterials(u),f=0;f<e&&!(f>0&&o>0)&&!(r&&f>0);f++){const e=x.renderTargets[f],t=x.renderTargets[f].colorBuffer.width,h=this.renderTargets.get(t),l=h.colorBuffer;0===f?g=i.updateShaders:g&&(i.updateShaders=!0);let c=this.passMaterials[f];if(r){o+1===y&&0===f&&(c=this.ambientAOMaterial)}for(d=0;d<u.length;d++)u[d].material=c;for(this.renderer.updateShaders(u),this.renderer.setCamera(this.camera,h,!0),1===f&&this.constantBakeDir.setValue(s.light.bakeDir?1:0),a&&this.worldClusters.activate(this.renderer.lightTextureAtlas),this.renderer._forwardTime=0,this.renderer._shadowMapTime=0,this.renderer.renderForward(this.camera,u,u.length,m,1),n.updateEnd(),x.renderTargets[f]=h,this.renderTargets.set(t,e),d=0;d<u.length;d++)p=u[d],p.setRealtimeLightmap(xd.lightmapParamNames[f],l),p._shaderDefs|=64}this.restoreMaterials(u)}}s.endBake(this.shadowMapCache)}}for(this.postprocessTextures(n,t,e),_=0;_<s.length;_++)s[_].restore();this.restoreLights(r),this.restoreScene(),a||this.shadowMapCache.clear()}}class nf extends kc{constructor(e,t){super(),this.device=t||zc().graphicsDevice,this._targets=e,this.device.supportsMorphTargetTexturesCore&&(this.device.extTextureHalfFloat&&this.device.textureHalfFloatRenderable?this._renderTextureFormat=nf.FORMAT_HALF_FLOAT:this.device.extTextureFloat&&this.device.textureFloatRenderable&&(this._renderTextureFormat=nf.FORMAT_FLOAT),this.device.extTextureHalfFloat&&this.device.textureHalfFloatUpdatable?this._textureFormat=nf.FORMAT_HALF_FLOAT:this.device.extTextureFloat&&(this._textureFormat=nf.FORMAT_FLOAT),void 0!==this._renderTextureFormat&&void 0!==this._textureFormat&&(this._useTextureMorph=!0)),this._init(),this._updateMorphFlags(),this._calculateAabb()}get morphPositions(){return this._morphPositions}get morphNormals(){return this._morphNormals}get maxActiveTargets(){return this._useTextureMorph?this._targets.length:this._morphPositions&&this._morphNormals?4:8}get useTextureMorph(){return this._useTextureMorph}_init(){if(this._useTextureMorph&&(this._useTextureMorph=this._initTextureBased()),!this._useTextureMorph)for(let e=0;e<this._targets.length;e++)this._targets[e]._initVertexBuffers(this.device);for(let e=0;e<this._targets.length;e++)this._targets[e]._postInit()}_initTextureBased(){const e=[],t=[];for(let s=0;s<this._targets.length;s++){const i=this._targets[s];i.options.deltaPositions&&(e.push(i.options.deltaPositions),t.push({target:i,name:"texturePositions"})),i.options.deltaNormals&&(e.push(i.options.deltaNormals),t.push({target:i,name:"textureNormals"}))}const s=[],i=[];let n=1;const a=e[0].length;for(let t=0;t<a;t+=3){let a=!1;for(let s=0;s<e.length;s++){const i=e[s];if(0!==i[t]||0!==i[t+1]||0!==i[t+2]){a=!0;break}}a?(s.push(n+.2),i.push(t/3),n++):s.push(.2)}const r=Math.min(this.device.maxTextureSize,4096);let o=Math.ceil(Math.sqrt(n));o=Math.min(o,r);const h=Math.ceil(n/o);if(h>r)return!1;this.morphTextureWidth=o,this.morphTextureHeight=h;let l=!1,c=3;const d=dh.float2Half;this._textureFormat===nf.FORMAT_HALF_FLOAT&&(l=!0,c=4);const u=this.morphTextureWidth*this.morphTextureHeight*c,p=l?new Uint16Array(u):new Float32Array(u);for(let s=0;s<e.length;s++){const n=e[s];for(let e=0;e<i.length;e++){const t=i[e];l?(p[e*c+c]=d(n[3*t]),p[e*c+c+1]=d(n[3*t+1]),p[e*c+c+2]=d(n[3*t+2])):(p[e*c+c]=n[3*t],p[e*c+c+1]=n[3*t+1],p[e*c+c+2]=n[3*t+2])}const a=t[s].target,r=this._textureFormat===nf.FORMAT_FLOAT?13:12;a._setTexture(t[s].name,this._createTexture("MorphTarget",r,p))}const m=[{semantic:"ATTR15",components:1,type:6}];return this.vertexBufferIds=new fo(this.device,new go(this.device,m),s.length,0,new Float32Array(s)),!0}destroy(){this.vertexBufferIds&&(this.vertexBufferIds.destroy(),this.vertexBufferIds=null);for(let e=0;e<this._targets.length;e++)this._targets[e].destroy();this._targets.length=0}get targets(){return this._targets}_updateMorphFlags(){this._morphPositions=!1,this._morphNormals=!1;for(let e=0;e<this._targets.length;e++){const t=this._targets[e];t.morphPositions&&(this._morphPositions=!0),t.morphNormals&&(this._morphNormals=!0)}}_calculateAabb(){const e=new ge,t=new ge;for(let s=0;s<this._targets.length;s++){const i=this._targets[s].aabb;e.min(i.getMin()),t.max(i.getMax())}this.aabb=new De,this.aabb.setMinMax(e,t)}_createTexture(e,t,s){const i=new fh(this.device,{width:this.morphTextureWidth,height:this.morphTextureHeight,format:t,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1,name:e});return s&&(i.lock().set(s),i.unlock()),i}}nf.FORMAT_FLOAT=0,nf.FORMAT_HALF_FLOAT=1;class af{constructor(e){this.morph=e,e.incRefCount(),this.device=e.device,this.meshInstance=null,this._weights=[],this._weightMap=new Map;for(let t=0;t<e._targets.length;t++){const s=e._targets[t];s.name&&this._weightMap.set(s.name,t),this.setWeight(t,s.defaultWeight)}if(this._activeTargets=[],e.useTextureMorph){this.shaderCache={},this.maxSubmitCount=this.device.maxTextures,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount);const t=(t,s)=>{const i=e._renderTextureFormat===nf.FORMAT_FLOAT?14:12;return this[s]=e._createTexture(t,i),new Jl({colorBuffer:this[s],depth:!1})};e.morphPositions&&(this.rtPositions=t("MorphRTPos","texturePositions")),e.morphNormals&&(this.rtNormals=t("MorphRTNrm","textureNormals")),this._textureParams=new Float32Array([e.morphTextureWidth,e.morphTextureHeight,1/e.morphTextureWidth,1/e.morphTextureHeight]);for(let e=0;e<this.maxSubmitCount;e++)this["morphBlendTex"+e]=this.device.scope.resolve("morphBlendTex"+e);this.morphFactor=this.device.scope.resolve("morphFactor[0]"),this.zeroTextures=!1}else this.maxSubmitCount=8,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount),this._shaderMorphWeightsA=new Float32Array(this._shaderMorphWeights.buffer,0,4),this._shaderMorphWeightsB=new Float32Array(this._shaderMorphWeights.buffer,16,4),this._activeVertexBuffers=new Array(this.maxSubmitCount)}destroy(){this.meshInstance=null,this.shader=null;const e=this.morph;e&&(this.morph=null,e.decRefCount(),e.refCount<1&&e.destroy()),this.rtPositions&&(this.rtPositions.destroy(),this.rtPositions=null),this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null),this.rtNormals&&(this.rtNormals.destroy(),this.rtNormals=null),this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)}clone(){return new af(this.morph)}_getWeightIndex(e){if("string"==typeof e){return this._weightMap.get(e)}return e}getWeight(e){const t=this._getWeightIndex(e);return this._weights[t]}setWeight(e,t){const s=this._getWeightIndex(e);this._weights[s]=t,this._dirty=!0}_getFragmentShader(e){let t="";e>0&&(t+="varying vec2 uv0;\nuniform highp float morphFactor["+e+"];\n");for(let s=0;s<e;s++)t+="uniform highp sampler2D morphBlendTex"+s+";\n";t+="void main (void) {\n    highp vec4 color = vec4(0, 0, 0, 1);\n";for(let s=0;s<e;s++)t+="    color.xyz += morphFactor["+s+"] * texture2D(morphBlendTex"+s+", uv0).xyz;\n";return t+="    gl_FragColor = color;\n}\n",t}_getShader(e){let t=this.shaderCache[e];if(!t){const s=this._getFragmentShader(e);t=eh(this.device,"\n    attribute vec2 vertex_position;\n    varying vec2 uv0;\n    void main(void) {\n        gl_Position = vec4(vertex_position, 0.5, 1.0);\n        uv0 = vertex_position.xy * 0.5 + 0.5;\n    }\n    ",s,"textureMorph"+e),this.shaderCache[e]=t}return t}_updateTextureRenderTarget(e,t){const s=this.device,i=(t,i)=>{this.morphFactor.setValue(this._shaderMorphWeights),s.setBlending(i),i&&(s.setBlendFunction(1,1),s.setBlendEquation(0));const n=this._getShader(t);bo(s,e,n,void 0,void 0,i)};let n=0,a=!1;const r=this._activeTargets.length;for(let e=0;e<r;e++){const s=this._activeTargets[e],r=s.target[t];r&&(this["morphBlendTex"+n].setValue(r),this._shaderMorphWeights[n]=s.weight,n++,n>=this.maxSubmitCount&&(i(n,a),n=0,a=!0))}(n>0||0===r&&!this.zeroTextures)&&i(n,a)}_updateTextureMorph(){this.device,(this._activeTargets.length>0||!this.zeroTextures)&&(this._updateTextureRenderTarget(this.rtPositions,"texturePositions"),this._updateTextureRenderTarget(this.rtNormals,"textureNormals"),this.zeroTextures=0===this._activeTargets.length)}_updateVertexMorph(){const e=this.maxSubmitCount;for(let t=0;t<e;t++)this._shaderMorphWeights[t]=0,this._activeVertexBuffers[t]=null;let t=0,s=this.morph.morphPositions?4:0;for(let e=0;e<this._activeTargets.length;e++){const i=this._activeTargets[e].target;i._vertexBufferPositions&&(this._activeVertexBuffers[t]=i._vertexBufferPositions,this._shaderMorphWeights[t]=this._activeTargets[e].weight,t++),i._vertexBufferNormals&&(this._activeVertexBuffers[s]=i._vertexBufferNormals,this._shaderMorphWeights[s]=this._activeTargets[e].weight,s++)}}update(){this._dirty=!1;const e=this.morph._targets;let t=0;for(let s=0;s<e.length;s++){const i=Math.abs(this.getWeight(s));if(i>1e-5){this._activeTargets.length<=t&&(this._activeTargets[t]={});const n=this._activeTargets[t++];n.absWeight=i,n.weight=this.getWeight(s),n.target=e[s]}}this._activeTargets.length=t;const s=this.morph.maxActiveTargets;this._activeTargets.length>s&&(this._activeTargets.sort((function(e,t){return e.absWeight<t.absWeight?1:t.absWeight<e.absWeight?-1:0})),this._activeTargets.length=s),this.morph.useTextureMorph?this._updateTextureMorph():this._updateVertexMorph()}}class rf{constructor(){this.graph=null,this.meshInstances=[],this.skinInstances=[],this.morphInstances=[],this.cameras=[],this.lights=[],this._shadersVersion=0,this._immutable=!1}getGraph(){return this.graph}setGraph(e){this.graph=e}getCameras(){return this.cameras}setCameras(e){this.cameras=e}getLights(){return this.lights}setLights(e){this.lights=e}getMaterials(){const e=[];for(let t=0;t<this.meshInstances.length;t++){const s=this.meshInstances[t];-1===e.indexOf(s.material)&&e.push(s.material)}return e}clone(){const e=[],t=[],s=function s(i){const n=i.clone();e.push(i),t.push(n);for(let e=0;e<i._children.length;e++)n.addChild(s(i._children[e]));return n}(this.graph),i=[],n=[],a=[];for(let e=0;e<this.skinInstances.length;e++){const t=this.skinInstances[e].skin,i=new hd(t),a=[];for(let e=0;e<t.boneNames.length;e++){const i=t.boneNames[e],n=s.findByName(i);a.push(n)}i.bones=a,n.push(i)}for(let e=0;e<this.morphInstances.length;e++){const t=this.morphInstances[e].morph,s=new af(t);a.push(s)}for(let s=0;s<this.meshInstances.length;s++){const r=this.meshInstances[s],o=e.indexOf(r.node),h=new xd(r.mesh,r.material,t[o]);if(r.skinInstance){const e=this.skinInstances.indexOf(r.skinInstance);h.skinInstance=n[e]}if(r.morphInstance){const e=this.morphInstances.indexOf(r.morphInstance);h.morphInstance=a[e]}i.push(h)}const r=new rf;return r.graph=s,r.meshInstances=i,r.skinInstances=n,r.morphInstances=a,r.getGraph().syncHierarchy(),r}destroy(){const e=this.meshInstances;for(let t=0;t<e.length;t++)e[t].destroy();this.meshInstances.length=0}generateWireframe(){xd._prepareRenderStyleForArray(this.meshInstances,1)}}class of{constructor(e){2===arguments.length&&(e=arguments[1]),this.options=e,this._name=e.name,this._defaultWeight=e.defaultWeight||0,this.aabb=e.aabb,this.aabb||(this.aabb=new De,e.deltaPositions&&this.aabb.compute(e.deltaPositions)),this.deltaPositions=e.deltaPositions}get name(){return this._name}get defaultWeight(){return this._defaultWeight}get morphPositions(){return!!this._vertexBufferPositions||!!this.texturePositions}get morphNormals(){return!!this._vertexBufferNormals||!!this.textureNormals}_postInit(){this.options=null}_initVertexBuffers(e){const t=this.options;this._vertexBufferPositions=this._createVertexBuffer(e,t.deltaPositions,t.deltaPositionsType),this._vertexBufferNormals=this._createVertexBuffer(e,t.deltaNormals,t.deltaNormalsType),this._vertexBufferPositions&&(this.deltaPositions=this._vertexBufferPositions.lock())}_createVertexBuffer(e,t,s=6){if(t){return new fo(e,new go(e,[{semantic:"ATTR0",components:3,type:s}]),t.length/3,0,t)}return null}_setTexture(e,t){this[e]=t}destroy(){this._vertexBufferPositions&&(this._vertexBufferPositions.destroy(),this._vertexBufferPositions=null),this._vertexBufferNormals&&(this._vertexBufferNormals.destroy(),this._vertexBufferNormals=null),this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null),this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)}}const hf={generateKey:function(e){let t="particle";for(const s in e)e.hasOwnProperty(s)&&(t+=e[s]);return t},_animTex:function(e){let t="";return t+=e.animTexLoop?Bo.particleAnimFrameLoopVS:Bo.particleAnimFrameClampVS,t+=Bo.particleAnimTexVS,t},createShaderDefinition:function(e,t){let s="",i=Wo(e)+"\n";i+="#define PARTICLE\n",e.webgl2&&(s+="#define GL2\n",i+="#define GL2\n"),s+="#define VERTEXSHADER\n",t.mesh&&(s+="#define USE_MESH\n"),t.localSpace&&(s+="#define LOCAL_SPACE\n"),t.screenSpace&&(s+="#define SCREEN_SPACE\n"),t.animTex&&(s+="\nuniform vec2 animTexTilesParams;\n"),t.animTex&&(s+="\nuniform vec4 animTexParams;\n"),t.animTex&&(s+="\nuniform vec2 animTexIndexParams;\n"),2===t.normal&&(s+="\nvarying mat3 ParticleMat;\n"),1===t.normal&&(s+="\nvarying vec3 Normal;\n"),t.soft&&(s+="\nvarying float vDepth;\n");const n=t.customFace?Bo.particle_customFaceVS:Bo.particle_billboardVS;t.useCpu?(t.soft>0&&(s+=Bo.screenDepthPS),s+=Bo.particle_cpuVS,t.localSpace&&(s+=Bo.particle_localShiftVS),t.animTex&&(s+=this._animTex(t)),t.alignToMotion&&(s+=Bo.particle_pointAlongVS),s+=t.mesh?Bo.particle_meshVS:n,1===t.normal&&(s+=Bo.particle_normalVS),2===t.normal&&(s+=Bo.particle_TBNVS),t.stretch>0&&(s+=Bo.particle_stretchVS),s+=Bo.particle_cpu_endVS,t.soft>0&&(s+=Bo.particle_softVS)):(s+=Bo.particle_initVS,s+=t.pack8?Bo.particleInputRgba8PS:Bo.particleInputFloatPS,t.soft>0&&(s+=Bo.screenDepthPS),s+=Bo.particleVS,t.localSpace&&(s+=Bo.particle_localShiftVS),t.animTex&&(s+=this._animTex(t)),t.wrap&&(s+=Bo.particle_wrapVS),t.alignToMotion&&(s+=Bo.particle_pointAlongVS),s+=t.mesh?Bo.particle_meshVS:n,1===t.normal&&(s+=Bo.particle_normalVS),2===t.normal&&(s+=Bo.particle_TBNVS),t.stretch>0&&(s+=Bo.particle_stretchVS),s+=Bo.particle_endVS,t.soft>0&&(s+=Bo.particle_softVS)),s+="}\n",t.normal>0&&(1===t.normal?i+="\nvarying vec3 Normal;\n":2===t.normal&&(i+="\nvarying mat3 ParticleMat;\n"),i+="\nuniform vec3 lightCube[6];\n"),t.soft&&(i+="\nvarying float vDepth;\n"),0===t.normal&&"none"===t.fog&&(t.srgb=!1),i+=Bo.decodePS,i+=Uo(t.gamma),i+=Vo(t.toneMap),"linear"===t.fog?i+=Bo.fogLinearPS:"exp"===t.fog?i+=Bo.fogExpPS:"exp2"===t.fog?i+=Bo.fogExp2PS:i+=Bo.fogNonePS,2===t.normal&&(i+="\nuniform sampler2D normalMap;\n"),t.soft>0&&(i+=Bo.screenDepthPS),i+=Bo.particlePS,t.soft>0&&(i+=Bo.particle_softPS),1===t.normal&&(i+="\nvec3 normal = Normal;\n"),2===t.normal&&(i+=Bo.particle_normalMapPS),t.normal>0&&(i+=t.halflambert?Bo.particle_halflambertPS:Bo.particle_lambertPS),t.normal>0&&(i+=Bo.particle_lightingPS),2===t.blend?i+=Bo.particle_blendNormalPS:1===t.blend?i+=Bo.particle_blendAddPS:5===t.blend&&(i+=Bo.particle_blendMultiplyPS),i+=Bo.particle_endPS;return{attributes:Qo(s),vshader:s,fshader:i}}};let lf,cf=1;const df=new Ce,uf=new Ce,pf=new ge,mf=new ge,ff=new ge,_f=new ge,gf=new ge,yf=new ge,vf=new ge,xf=new ge,bf=new ge,Sf=new ge,wf=new ge,Tf=new ge,Mf=new ge;function Cf(e){return e-Math.floor(e)}function Af(e){return Math.max(Math.min(e,1),0)}function Pf(e,t){return e-t*Math.floor(e/t)}function Ef(e){let t=Cf(e),s=Cf(255*e);return t-=s/255,s-=s/255,[t,s]}class Rf{constructor(e){this._emitter=e}calcSpawnPosition(e,t,s,i,n){const a=this._emitter,r=Math.random(),o=Math.random(),h=Math.random(),l=Math.random();if(a.useCpu&&(e[4*n+0+2*a.numParticlesPot*4]=r,e[4*n+1+2*a.numParticlesPot*4]=o,e[4*n+2+2*a.numParticlesPot*4]=h),mf.x=r-.5,mf.y=o-.5,mf.z=h-.5,0===a.emitterShape){const e=Math.max(Math.abs(mf.x),Math.max(Math.abs(mf.y),Math.abs(mf.z))),n=e+(.5-e)*s[0],r=e+(.5-e)*s[1],o=e+(.5-e)*s[2];mf.x=n*(e===Math.abs(mf.x)?Math.sign(mf.x):2*mf.x),mf.y=r*(e===Math.abs(mf.y)?Math.sign(mf.y):2*mf.y),mf.z=o*(e===Math.abs(mf.z)?Math.sign(mf.z):2*mf.z),a.localSpace?pf.copy(t.transformPoint(mf)):pf.copy(i).add(t.transformPoint(mf))}else{mf.normalize();const e=0===a.emitterRadius?0:a.emitterRadiusInner/a.emitterRadius,t=l*(1-e)+e;a.localSpace?pf.copy(mf.mulScalar(t*a.emitterRadius)):pf.copy(i).add(mf.mulScalar(t*a.emitterRadius))}let c=-ne.lerp(a.rate,a.rate2,r)*n;if(a.pack8){const t=(pf.x-a.worldBounds.center.x)/a.worldBoundsSize.x+.5,s=(pf.y-a.worldBounds.center.y)/a.worldBoundsSize.y+.5,i=(pf.z-a.worldBounds.center.z)/a.worldBoundsSize.z+.5;let o=ne.lerp(a.startAngle*ne.DEG_TO_RAD,a.startAngle2*ne.DEG_TO_RAD,r);o=o%(2*Math.PI)/(2*Math.PI);const h=Ef(t);e[4*n]=h[0],e[4*n+1]=h[1];const l=Ef(s);e[4*n+2]=l[0],e[4*n+3]=l[1];const d=Ef(i);e[4*n+0+4*a.numParticlesPot]=d[0],e[4*n+1+4*a.numParticlesPot]=d[1];const u=Ef(o);e[4*n+2+4*a.numParticlesPot]=u[0],e[4*n+3+4*a.numParticlesPot]=u[1];const p=1;e[4*n+3+4*a.numParticlesPot*2]=p;const m=Math.max(a.lifetime,(a.numParticles-1)*Math.max(a.rate,a.rate2));c=(c+m)/(m+(a.lifetime+1));const f=function(e){let t=Cf(e),s=Cf(255*e),i=Cf(65025*e),n=Cf(160581375*e);return t-=s/255,s-=i/255,i-=n/255,n-=n/255,[t,s,i,n]}(c);e[4*n+0+4*a.numParticlesPot*3]=f[0],e[4*n+1+4*a.numParticlesPot*3]=f[1],e[4*n+2+4*a.numParticlesPot*3]=f[2],e[4*n+3+4*a.numParticlesPot*3]=f[3]}else e[4*n]=pf.x,e[4*n+1]=pf.y,e[4*n+2]=pf.z,e[4*n+3]=ne.lerp(a.startAngle*ne.DEG_TO_RAD,a.startAngle2*ne.DEG_TO_RAD,r),e[4*n+3+4*a.numParticlesPot]=c}update(e,t,s,i,n,a,r,o){let h,l,c;const d=this._emitter;if(d.meshInstance.node){const e=d.meshInstance.node.worldTransform;for(let t=0;t<12;t++)df.data[t]=e.data[t];uf.copy(df),uf.invert(),lf=d.meshInstance.node.localScale,cf=Math.max(Math.max(lf.x,lf.y),lf.z)}a=null===d.meshInstance.node||d.localSpace?ge.ZERO:d.meshInstance.node.getPosition();const u=d.camera?d.camera._node.getPosition():ge.ZERO,p=d.useMesh?17:15;let m,f,_,g,y,v,x,b,S;const w=d.precision-1;for(let t=0;t<d.numParticles;t++){const T=Math.floor(d.vbCPU[t*d.numParticleVerts*(d.useMesh?6:4)+3]),M=s[4*T+0+2*d.numParticlesPot*4];ff.x=M,ff.y=s[4*T+1+2*d.numParticlesPot*4],ff.z=s[4*T+2+2*d.numParticlesPot*4];const C=d.rate+(d.rate2-d.rate)*M,A=d.lifetime;let P=s[4*T+3+4*d.numParticlesPot]+r;const E=Af(P/A);let R=0,L=0;const I=0;(P-r<=0||P>=A)&&this.calcSpawnPosition(s,i,n,a,T);let D=P>0&&P<A;D&&(c=E*w,m=Math.floor(c),f=Math.ceil(c),c%=1,h=d.qRotSpeed[m],l=d.qRotSpeed[f],_=h+(l-h)*c,h=d.qRotSpeed2[m],l=d.qRotSpeed2[f],g=h+(l-h)*c,h=d.qScale[m],l=d.qScale[f],R=h+(l-h)*c,h=d.qScale2[m],l=d.qScale2[f],y=h+(l-h)*c,h=d.qAlpha[m],l=d.qAlpha[f],v=h+(l-h)*c,h=d.qAlpha2[m],l=d.qAlpha2[f],x=h+(l-h)*c,h=d.qRadialSpeed[m],l=d.qRadialSpeed[f],b=h+(l-h)*c,h=d.qRadialSpeed2[m],l=d.qRadialSpeed2[f],S=h+(l-h)*c,b+=100*M%1*(S-b),_f.x=s[4*T],_f.y=s[4*T+1],_f.z=s[4*T+2],d.localSpace?bf.copy(_f):bf.copy(_f).sub(a),bf.normalize().mulScalar(b),m*=3,f*=3,h=d.qLocalVelocity[m],l=d.qLocalVelocity[f],yf.x=h+(l-h)*c,h=d.qLocalVelocity[m+1],l=d.qLocalVelocity[f+1],yf.y=h+(l-h)*c,h=d.qLocalVelocity[m+2],l=d.qLocalVelocity[f+2],yf.z=h+(l-h)*c,h=d.qLocalVelocity2[m],l=d.qLocalVelocity2[f],xf.x=h+(l-h)*c,h=d.qLocalVelocity2[m+1],l=d.qLocalVelocity2[f+1],xf.y=h+(l-h)*c,h=d.qLocalVelocity2[m+2],l=d.qLocalVelocity2[f+2],xf.z=h+(l-h)*c,h=d.qVelocity[m],l=d.qVelocity[f],gf.x=h+(l-h)*c,h=d.qVelocity[m+1],l=d.qVelocity[f+1],gf.y=h+(l-h)*c,h=d.qVelocity[m+2],l=d.qVelocity[f+2],gf.z=h+(l-h)*c,h=d.qVelocity2[m],l=d.qVelocity2[f],vf.x=h+(l-h)*c,h=d.qVelocity2[m+1],l=d.qVelocity2[f+1],vf.y=h+(l-h)*c,h=d.qVelocity2[m+2],l=d.qVelocity2[f+2],vf.z=h+(l-h)*c,yf.x+=(xf.x-yf.x)*ff.x,yf.y+=(xf.y-yf.y)*ff.y,yf.z+=(xf.z-yf.z)*ff.z,d.initialVelocity>0&&(1===d.emitterShape?(mf.copy(ff).mulScalar(2).sub(ge.ONE).normalize(),yf.add(mf.mulScalar(d.initialVelocity))):yf.add(ge.FORWARD.mulScalar(d.initialVelocity))),gf.x+=(vf.x-gf.x)*ff.x,gf.y+=(vf.y-gf.y)*ff.y,gf.z+=(vf.z-gf.z)*ff.z,_+=(g-_)*ff.y,R=(R+1e4*M%1*(y-R))*cf,L=1e3*M%1*(x-v),d.meshInstance.node&&(d.localSpace?(yf.x/=lf.x,yf.y/=lf.y,yf.z/=lf.z):df.transformPoint(yf,yf)),d.localSpace?(uf.transformPoint(gf,gf),yf.add(gf).add(bf)):(yf.add(gf.mul(lf)),yf.add(bf.mul(lf))),Tf.copy(yf),Sf.copy(_f).add(yf.mulScalar(r)),wf.copy(Sf),s[4*T]=wf.x,s[4*T+1]=wf.y,s[4*T+2]=wf.z,s[4*T+3]+=_*r,d.wrap&&d.wrapBounds&&(d.localSpace||wf.sub(a),wf.x=Pf(wf.x,d.wrapBounds.x)-.5*d.wrapBounds.x,wf.y=Pf(wf.y,d.wrapBounds.y)-.5*d.wrapBounds.y,wf.z=Pf(wf.z,d.wrapBounds.z)-.5*d.wrapBounds.z,d.localSpace||wf.add(a)),d.sort>0&&(1===d.sort?(Mf.copy(wf).sub(u),d.particleDistance[T]=-(Mf.x*Mf.x+Mf.y*Mf.y+Mf.z*Mf.z)):2===d.sort?d.particleDistance[T]=P:3===d.sort&&(d.particleDistance[T]=-P))),o?P<0&&(s[4*T+3+2*d.numParticlesPot*4]=-1):(P>=A&&(P-=Math.max(A,(d.numParticles-1)*C),s[4*T+3+2*d.numParticlesPot*4]=d.loop?1:-1),P<0&&d.loop&&(s[4*T+3+2*d.numParticlesPot*4]=1)),s[4*T+3+2*d.numParticlesPot*4]<0&&(D=!1),s[4*T+3+4*d.numParticlesPot]=P;for(let i=0;i<d.numParticleVerts;i++){const n=(t*d.numParticleVerts+i)*(d.useMesh?6:4);let a=d.vbCPU[n],r=d.vbCPU[n+1],o=d.vbCPU[n+2];D||(a=r=o=0);const h=t*d.numParticleVerts*p+i*p;e[h]=wf.x,e[h+1]=wf.y,e[h+2]=wf.z,e[h+3]=E,e[h+4]=d.alignToMotion?I:s[4*T+3],e[h+5]=R,e[h+6]=L,e[h+7]=Tf.x,e[h+8]=a,e[h+9]=r,e[h+10]=o,e[h+11]=Tf.y,e[h+12]=T,e[h+13]=Tf.z,e[h+14]=d.vbCPU[n+3],d.useMesh&&(e[h+15]=d.vbCPU[n+4],e[h+16]=d.vbCPU[n+5])}}if(d.sort>0&&d.camera){const e=d.useMesh?6:4,s=d.particleDistance;for(let i=0;i<d.numParticles;i++)t[i][0]=i,t[i][1]=s[Math.floor(d.vbCPU[i*d.numParticleVerts*e+3])];d.vbOld.set(d.vbCPU),t.sort((function(e,t){return e[1]-t[1]}));for(let s=0;s<d.numParticles;s++){const i=t[s][0]*d.numParticleVerts*e,n=s*d.numParticleVerts*e;for(let t=0;t<d.numParticleVerts*e;t++)d.vbCPU[n+t]=d.vbOld[i+t]}}}}const Lf=new ye,If=new ye,Df=new ye;class Of{constructor(e,t){this._emitter=e,this.frameRandomUniform=new Float32Array(3),this.emitterPosUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),this.worldBoundsMulUniform=new Float32Array(3),this.worldBoundsAddUniform=new Float32Array(3),this.inBoundsSizeUniform=new Float32Array(3),this.inBoundsCenterUniform=new Float32Array(3),this.constantParticleTexIN=t.scope.resolve("particleTexIN"),this.constantParticleTexOUT=t.scope.resolve("particleTexOUT"),this.constantEmitterPos=t.scope.resolve("emitterPos"),this.constantEmitterScale=t.scope.resolve("emitterScale"),this.constantSpawnBounds=t.scope.resolve("spawnBounds"),this.constantSpawnPosInnerRatio=t.scope.resolve("spawnPosInnerRatio"),this.constantSpawnBoundsSphere=t.scope.resolve("spawnBoundsSphere"),this.constantSpawnBoundsSphereInnerRatio=t.scope.resolve("spawnBoundsSphereInnerRatio"),this.constantInitialVelocity=t.scope.resolve("initialVelocity"),this.constantFrameRandom=t.scope.resolve("frameRandom"),this.constantDelta=t.scope.resolve("delta"),this.constantRate=t.scope.resolve("rate"),this.constantRateDiv=t.scope.resolve("rateDiv"),this.constantLifetime=t.scope.resolve("lifetime"),this.constantGraphSampleSize=t.scope.resolve("graphSampleSize"),this.constantGraphNumSamples=t.scope.resolve("graphNumSamples"),this.constantInternalTex0=t.scope.resolve("internalTex0"),this.constantInternalTex1=t.scope.resolve("internalTex1"),this.constantInternalTex2=t.scope.resolve("internalTex2"),this.constantInternalTex3=t.scope.resolve("internalTex3"),this.constantEmitterMatrix=t.scope.resolve("emitterMatrix"),this.constantEmitterMatrixInv=t.scope.resolve("emitterMatrixInv"),this.constantNumParticles=t.scope.resolve("numParticles"),this.constantNumParticlesPot=t.scope.resolve("numParticlesPot"),this.constantLocalVelocityDivMult=t.scope.resolve("localVelocityDivMult"),this.constantVelocityDivMult=t.scope.resolve("velocityDivMult"),this.constantRotSpeedDivMult=t.scope.resolve("rotSpeedDivMult"),this.constantSeed=t.scope.resolve("seed"),this.constantStartAngle=t.scope.resolve("startAngle"),this.constantStartAngle2=t.scope.resolve("startAngle2"),this.constantOutBoundsMul=t.scope.resolve("outBoundsMul"),this.constantOutBoundsAdd=t.scope.resolve("outBoundsAdd"),this.constantInBoundsSize=t.scope.resolve("inBoundsSize"),this.constantInBoundsCenter=t.scope.resolve("inBoundsCenter"),this.constantMaxVel=t.scope.resolve("maxVel"),this.constantFaceTangent=t.scope.resolve("faceTangent"),this.constantFaceBinorm=t.scope.resolve("faceBinorm")}_setInputBounds(){this.inBoundsSizeUniform[0]=this._emitter.prevWorldBoundsSize.x,this.inBoundsSizeUniform[1]=this._emitter.prevWorldBoundsSize.y,this.inBoundsSizeUniform[2]=this._emitter.prevWorldBoundsSize.z,this.constantInBoundsSize.setValue(this.inBoundsSizeUniform),this.inBoundsCenterUniform[0]=this._emitter.prevWorldBoundsCenter.x,this.inBoundsCenterUniform[1]=this._emitter.prevWorldBoundsCenter.y,this.inBoundsCenterUniform[2]=this._emitter.prevWorldBoundsCenter.z,this.constantInBoundsCenter.setValue(this.inBoundsCenterUniform)}randomize(){this.frameRandomUniform[0]=Math.random(),this.frameRandomUniform[1]=Math.random(),this.frameRandomUniform[2]=Math.random()}update(e,t,s,i,n){const a=this._emitter;e.setBlending(!1),e.setColorWrite(!0,!0,!0,!0),e.setCullMode(0),e.setDepthTest(!1),e.setDepthWrite(!1),this.randomize(),this.constantGraphSampleSize.setValue(1/a.precision),this.constantGraphNumSamples.setValue(a.precision),this.constantNumParticles.setValue(a.numParticles),this.constantNumParticlesPot.setValue(a.numParticlesPot),this.constantInternalTex0.setValue(a.internalTex0),this.constantInternalTex1.setValue(a.internalTex1),this.constantInternalTex2.setValue(a.internalTex2),this.constantInternalTex3.setValue(a.internalTex3);const r=a.meshInstance.node,o=null===r?ge.ONE:r.localScale;if(a.pack8){this.worldBoundsMulUniform[0]=a.worldBoundsMul.x,this.worldBoundsMulUniform[1]=a.worldBoundsMul.y,this.worldBoundsMulUniform[2]=a.worldBoundsMul.z,this.constantOutBoundsMul.setValue(this.worldBoundsMulUniform),this.worldBoundsAddUniform[0]=a.worldBoundsAdd.x,this.worldBoundsAddUniform[1]=a.worldBoundsAdd.y,this.worldBoundsAddUniform[2]=a.worldBoundsAdd.z,this.constantOutBoundsAdd.setValue(this.worldBoundsAddUniform),this._setInputBounds();let e=a.maxVel*Math.max(Math.max(o.x,o.y),o.z);e=Math.max(e,1),this.constantMaxVel.setValue(e)}const h=null===r||a.localSpace?ge.ZERO:r.getPosition(),l=null===r?Ce.IDENTITY:r.getWorldTransform();0===a.emitterShape?(Lf.setFromMat4(t),this.constantSpawnBounds.setValue(Lf.data),this.constantSpawnPosInnerRatio.setValue(s)):(this.constantSpawnBoundsSphere.setValue(a.emitterRadius),this.constantSpawnBoundsSphereInnerRatio.setValue(0===a.emitterRadius?0:a.emitterRadiusInner/a.emitterRadius)),this.constantInitialVelocity.setValue(a.initialVelocity),If.setFromMat4(l),l.invertTo3x3(Df),this.emitterPosUniform[0]=h.x,this.emitterPosUniform[1]=h.y,this.emitterPosUniform[2]=h.z,this.constantEmitterPos.setValue(this.emitterPosUniform),this.constantFrameRandom.setValue(this.frameRandomUniform),this.constantDelta.setValue(i),this.constantRate.setValue(a.rate),this.constantRateDiv.setValue(a.rate2-a.rate),this.constantStartAngle.setValue(a.startAngle*ne.DEG_TO_RAD),this.constantStartAngle2.setValue(a.startAngle2*ne.DEG_TO_RAD),this.constantSeed.setValue(a.seed),this.constantLifetime.setValue(a.lifetime),this.emitterScaleUniform[0]=o.x,this.emitterScaleUniform[1]=o.y,this.emitterScaleUniform[2]=o.z,this.constantEmitterScale.setValue(this.emitterScaleUniform),this.constantEmitterMatrix.setValue(If.data),this.constantEmitterMatrixInv.setValue(Df.data),this.constantLocalVelocityDivMult.setValue(a.localVelocityUMax),this.constantVelocityDivMult.setValue(a.velocityUMax),this.constantRotSpeedDivMult.setValue(a.rotSpeedUMax[0]);let c=a.swapTex?a.particleTexOUT:a.particleTexIN;c=a.beenReset?a.particleTexStart:c;const d=a.swapTex?a.particleTexIN:a.particleTexOUT;this.constantParticleTexIN.setValue(c),bo(e,a.swapTex?a.rtParticleTexIN:a.rtParticleTexOUT,n?a.shaderParticleUpdateOnStop:a.loop?a.shaderParticleUpdateRespawn:a.shaderParticleUpdateNoRespawn),a.material.setParameter("particleTexOUT",c),a.material.setParameter("particleTexIN",d),a.beenReset=!1,a.swapTex=!a.swapTex,e.setDepthTest(!0),e.setDepthWrite(!0),a.prevWorldBoundsSize.copy(a.worldBoundsSize),a.prevWorldBoundsCenter.copy(a.worldBounds.center),a.pack8&&this._setInputBounds()}}const Ff=[[-1,-1],[1,-1],[1,1],[-1,1]];function kf(e,t,s,i,n=14,a,r){let o=0;r&&7===n&&(o=1);const h=new fh(e,{width:t,height:s,format:n,cubemap:!1,mipmaps:!1,minFilter:o,magFilter:o,addressU:1,addressV:1,name:"ParticleSystemTexture"}),l=h.lock();if(7===n){const e=new Uint8Array(i.length);for(let t=0;t<i.length;t++)e[t]=i[t]*a*255;i=e}return l.set(i),h.unlock(),h}function Bf(e){return Math.max(Math.min(e,1),0)}const zf=new fe([0,0,1,0]),Uf=new fe([0,1,1,1]),Vf=new _e([0,0,1,0],[0,0,1,0],[0,0,1,0]),Nf=new _e([0,1,1,1],[0,1,1,1],[0,1,1,1]);let Gf=2;const Wf=new Float32Array(3),Hf=new Ce,Xf=new ge,qf=new ge,jf=new ge;let Yf,$f;function Kf(e,t){void 0!==$f[e]&&null!==$f[e]?Yf[e]=$f[e]:Yf[e]=t}function Zf(e,t,s){return(255*e<<16|255*t<<8|255*s)/(1<<24)}function Qf(e,t){const s=e.length/3,i=new Array(4*s);for(let n=0;n<s;n++)i[4*n]=e[3*n],i[4*n+1]=e[3*n+1],i[4*n+2]=e[3*n+2],i[4*n+3]=Zf(t[3*n],t[3*n+1],t[3*n+2]);return i}function Jf(e,t){const s=t.length,i=e.length/s;for(let n=0;n<i;n++)for(let i=0;i<s;i++){const a=Math.abs(e[n*s+i]);t[i]=Math.max(t[i],a)}}function e_(e,t,s){const i=function(e,t){const s=new Float32Array(e.length);for(let i=0;i<e.length;i++)s[i]=e[i]-t[i];return s}(t,e);return Jf(i,s),function(e,t){const s=t.length,i=e.length/s;for(let n=0;n<i;n++)for(let i=0;i<s;i++)e[n*s+i]/=0===t[i]?1:t[i],e[n*s+i]*=.5,e[n*s+i]+=.5}(i,s),i}const t_=new yo;class s_{constructor(e,t){this.graphicsDevice=e;const s=e;this.precision=32,this._addTimeTime=0,Yf=this,$f=t,Kf("numParticles",1),this.numParticles>e.maxTextureSize&&(this.numParticles=e.maxTextureSize),Kf("rate",1),Kf("rate2",this.rate),Kf("lifetime",50),Kf("emitterExtents",new ge(0,0,0)),Kf("emitterExtentsInner",new ge(0,0,0)),Kf("emitterRadius",0),Kf("emitterRadiusInner",0),Kf("emitterShape",0),Kf("initialVelocity",1),Kf("wrap",!1),Kf("localSpace",!1),Kf("screenSpace",!1),Kf("wrapBounds",null),Kf("colorMap",this.defaultParamTexture),Kf("normalMap",null),Kf("loop",!0),Kf("preWarm",!1),Kf("sort",0),Kf("mode",0),Kf("scene",null),Kf("lighting",!1),Kf("halfLambert",!1),Kf("intensity",1),Kf("stretch",0),Kf("alignToMotion",!1),Kf("depthSoftening",0),Kf("mesh",null),Kf("particleNormal",new ge(0,1,0)),Kf("orientation",0),Kf("depthWrite",!1),Kf("noFog",!1),Kf("blendType",2),Kf("node",null),Kf("startAngle",0),Kf("startAngle2",this.startAngle),Kf("animTilesX",1),Kf("animTilesY",1),Kf("animStartFrame",0),Kf("animNumFrames",1),Kf("animNumAnimations",1),Kf("animIndex",0),Kf("randomizeAnimIndex",!1),Kf("animSpeed",1),Kf("animLoop",!0),this._gpuUpdater=new Of(this,s),this._cpuUpdater=new Rf(this),this.constantLightCube=s.scope.resolve("lightCube[0]"),this.emitterPosUniform=new Float32Array(3),this.wrapBoundsUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),Kf("colorGraph",Nf),Kf("colorGraph2",this.colorGraph),Kf("scaleGraph",Uf),Kf("scaleGraph2",this.scaleGraph),Kf("alphaGraph",Uf),Kf("alphaGraph2",this.alphaGraph),Kf("localVelocityGraph",Vf),Kf("localVelocityGraph2",this.localVelocityGraph),Kf("velocityGraph",Vf),Kf("velocityGraph2",this.velocityGraph),Kf("rotationSpeedGraph",zf),Kf("rotationSpeedGraph2",this.rotationSpeedGraph),Kf("radialSpeedGraph",zf),Kf("radialSpeedGraph2",this.radialSpeedGraph),this.lightCube=new Float32Array(18),this.lightCubeDir=new Array(6),this.lightCubeDir[0]=new ge(-1,0,0),this.lightCubeDir[1]=new ge(1,0,0),this.lightCubeDir[2]=new ge(0,-1,0),this.lightCubeDir[3]=new ge(0,1,0),this.lightCubeDir[4]=new ge(0,0,-1),this.lightCubeDir[5]=new ge(0,0,1),this.animTilesParams=new Float32Array(2),this.animParams=new Float32Array(4),this.animIndexParams=new Float32Array(2),this.internalTex0=null,this.internalTex1=null,this.internalTex2=null,this.colorParam=null,this.vbToSort=null,this.vbOld=null,this.particleDistance=null,this.camera=null,this.swapTex=!1,this.useMesh=!0,this.useCpu=!e.supportsGpuParticles,this.pack8=!0,this.localBounds=new De,this.worldBoundsNoTrail=new De,this.worldBoundsTrail=[new De,new De],this.worldBounds=new De,this.worldBoundsSize=new ge,this.prevWorldBoundsSize=new ge,this.prevWorldBoundsCenter=new ge,this.prevEmitterExtents=this.emitterExtents,this.prevEmitterRadius=this.emitterRadius,this.worldBoundsMul=new ge,this.worldBoundsAdd=new ge,this.timeToSwitchBounds=0,this.shaderParticleUpdateRespawn=null,this.shaderParticleUpdateNoRespawn=null,this.shaderParticleUpdateOnStop=null,this.numParticleVerts=0,this.numParticleIndices=0,this.material=null,this.meshInstance=null,this.drawOrder=0,this.seed=Math.random(),this.fixedTimeStep=1/60,this.maxSubSteps=10,this.simTime=0,this.simTimeTotal=0,this.beenReset=!1,this._layer=null,this.rebuild()}get defaultParamTexture(){return t_.get(this.graphicsDevice,(()=>{const e=16,t=new Float32Array(1024);for(let s=0;s<e;s++)for(let i=0;i<e;i++){const n=i+1-8.5,a=s+1-8.5,r=Bf(1-Bf(Math.sqrt(n*n+a*a)/e)-.5),o=s*e+i;t[4*o]=1,t[4*o+1]=1,t[4*o+2]=1,t[4*o+3]=r}const s=kf(this.graphicsDevice,e,e,t,7,1,!0);return s.minFilter=1,s.magFilter=1,s}))}onChangeCamera(){this.regenShader(),this.resetMaterial()}calculateBoundsMad(){this.worldBoundsMul.x=1/this.worldBoundsSize.x,this.worldBoundsMul.y=1/this.worldBoundsSize.y,this.worldBoundsMul.z=1/this.worldBoundsSize.z,this.worldBoundsAdd.copy(this.worldBounds.center).mul(this.worldBoundsMul).mulScalar(-1),this.worldBoundsAdd.x+=.5,this.worldBoundsAdd.y+=.5,this.worldBoundsAdd.z+=.5}calculateWorldBounds(){if(!this.node)return;if(this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),!this.useCpu){let e=!1;e=0===this.emitterShape?!this.emitterExtents.equals(this.prevEmitterExtents):!(this.emitterRadius===this.prevEmitterRadius),e&&this.calculateLocalBounds()}const e=this.node.getWorldTransform();this.localSpace?this.worldBoundsNoTrail.copy(this.localBounds):this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,e),this.worldBoundsTrail[0].add(this.worldBoundsNoTrail),this.worldBoundsTrail[1].add(this.worldBoundsNoTrail);const t=this.simTimeTotal;t>=this.timeToSwitchBounds&&(this.worldBoundsTrail[0].copy(this.worldBoundsTrail[1]),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.timeToSwitchBounds=t+this.lifetime),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.localSpace?(this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,e),this.meshInstance.mesh.aabb.setFromTransformedAabb(this.worldBounds,e)):(this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance.mesh.aabb.copy(this.worldBounds)),this.meshInstance._aabbVer=1-this.meshInstance._aabbVer,this.pack8&&this.calculateBoundsMad()}resetWorldBounds(){this.node&&(this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,this.localSpace?Ce.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBoundsNoTrail),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.simTimeTotal=0,this.timeToSwitchBounds=0)}calculateLocalBounds(){let e=Number.MAX_VALUE,t=Number.MAX_VALUE,s=Number.MAX_VALUE,i=-Number.MAX_VALUE,n=-Number.MAX_VALUE,a=-Number.MAX_VALUE,r=0,o=0;const h=this.lifetime/this.precision,l=[this.qVelocity,this.qVelocity2],c=[this.qLocalVelocity,this.qLocalVelocity2],d=[0,0],u=[0,0],p=[0,0],m=[0,0],f=[0,0];let _,g,y;for(let v=0;v<this.precision+1;v++){const x=Math.min(v,this.precision-1);for(let r=0;r<2;r++)_=c[r][3*x+0]*h+d[r],g=c[r][3*x+1]*h+u[r],y=c[r][3*x+2]*h+p[r],e=Math.min(_,e),t=Math.min(g,t),s=Math.min(y,s),i=Math.max(_,i),n=Math.max(g,n),a=Math.max(y,a),d[r]=_,u[r]=g,p[r]=y;for(let e=0;e<2;e++)f[e]+=h*Math.sqrt(l[e][3*x+0]*l[e][3*x+0]+l[e][3*x+1]*l[e][3*x+1]+l[e][3*x+2]*l[e][3*x+2]);m[0]+=this.qRadialSpeed[x]*h,m[1]+=this.qRadialSpeed2[x]*h,r=Math.max(r,Math.max(Math.abs(m[0]),Math.abs(m[1]))),o=Math.max(o,this.qScale[x])}0===this.emitterShape?(_=.5*this.emitterExtents.x,g=.5*this.emitterExtents.y,y=.5*this.emitterExtents.z):(_=this.emitterRadius,g=this.emitterRadius,y=this.emitterRadius);const v=Math.max(f[0],f[1]);qf.x=e-o-_-r-v,qf.y=t-o-g-r-v,qf.z=s-o-y-r-v,jf.x=i+o+_+r+v,jf.y=n+o+g+r+v,jf.z=a+o+y+r+v,this.localBounds.setMinMax(qf,jf)}rebuild(){const e=this.graphicsDevice;if(null===this.colorMap&&(this.colorMap=this.defaultParamTexture),this.spawnBounds=0===this.emitterShape?this.emitterExtents:this.emitterRadius,this.useCpu=this.useCpu||this.sort>0||e.maxVertexTextures<=1||e.fragmentUniformsCount<64||e.forceCpuParticles||!e.extTextureFloat,this._destroyResources(),this.pack8=(this.pack8||!e.textureFloatRenderable)&&!this.useCpu,Gf=this.useCpu||this.pack8?4:2,this.useMesh=!1,this.mesh){this.numParticles*this.mesh.vertexBuffer.numVertices>65535||(this.useMesh=!0)}this.numParticlesPot=ne.nextPowerOfTwo(this.numParticles),this.rebuildGraphs(),this.calculateLocalBounds(),this.resetWorldBounds(),this.node&&(this.worldBounds.setFromTransformedAabb(this.localBounds,this.localSpace?Ce.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBounds),this.worldBoundsTrail[1].copy(this.worldBounds),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.pack8&&this.calculateBoundsMad()),this.vbToSort=new Array(this.numParticles);for(let e=0;e<this.numParticles;e++)this.vbToSort[e]=[0,0];this.particleDistance=new Float32Array(this.numParticles),this._gpuUpdater.randomize(),this.particleTex=new Float32Array(this.numParticlesPot*Gf*4);const t=null===this.node||this.localSpace?ge.ZERO:this.node.getPosition();0===this.emitterShape&&(null===this.node||this.localSpace?Hf.setTRS(ge.ZERO,Ae.IDENTITY,this.spawnBounds):Hf.setTRS(ge.ZERO,this.node.getRotation(),Xf.copy(this.spawnBounds).mul(this.node.localScale)),Wf[0]=0!==this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,Wf[1]=0!==this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,Wf[2]=0!==this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0);for(let e=0;e<this.numParticles;e++)this._cpuUpdater.calcSpawnPosition(this.particleTex,Hf,Wf,t,e),this.useCpu&&(this.particleTex[4*e+3+2*this.numParticlesPot*4]=1);this.particleTexStart=new Float32Array(this.numParticlesPot*Gf*4);for(let e=0;e<this.particleTexStart.length;e++)this.particleTexStart[e]=this.particleTex[e];this.useCpu||(this.pack8?(this.particleTexIN=kf(e,this.numParticlesPot,Gf,this.particleTex,7,1,!1),this.particleTexOUT=kf(e,this.numParticlesPot,Gf,this.particleTex,7,1,!1),this.particleTexStart=kf(e,this.numParticlesPot,Gf,this.particleTexStart,7,1,!1)):(this.particleTexIN=kf(e,this.numParticlesPot,Gf,this.particleTex),this.particleTexOUT=kf(e,this.numParticlesPot,Gf,this.particleTex),this.particleTexStart=kf(e,this.numParticlesPot,Gf,this.particleTexStart)),this.rtParticleTexIN=new Jl({colorBuffer:this.particleTexIN,depth:!1}),this.rtParticleTexOUT=new Jl({colorBuffer:this.particleTexOUT,depth:!1}),this.swapTex=!1);const s=(this.localSpace?"#define LOCAL_SPACE\n":"")+Bo.particleUpdaterInitPS+(this.pack8?Bo.particleInputRgba8PS+Bo.particleOutputRgba8PS:Bo.particleInputFloatPS+Bo.particleOutputFloatPS)+(0===this.emitterShape?Bo.particleUpdaterAABBPS:Bo.particleUpdaterSpherePS)+Bo.particleUpdaterStartPS,i=s+Bo.particleUpdaterRespawnPS+Bo.particleUpdaterEndPS,n=s+Bo.particleUpdaterNoRespawnPS+Bo.particleUpdaterEndPS,a=s+Bo.particleUpdaterOnStopPS+Bo.particleUpdaterEndPS,r=this.emitterShape+""+this.pack8+this.localSpace;this.shaderParticleUpdateRespawn=eh(e,Bo.fullscreenQuadVS,i,"fsQuad0"+r),this.shaderParticleUpdateNoRespawn=eh(e,Bo.fullscreenQuadVS,n,"fsQuad1"+r),this.shaderParticleUpdateOnStop=eh(e,Bo.fullscreenQuadVS,a,"fsQuad2"+r),this.numParticleVerts=this.useMesh?this.mesh.vertexBuffer.numVertices:4,this.numParticleIndices=this.useMesh?this.mesh.indexBuffer[0].numIndices:6,this._allocate(this.numParticles);const o=new Wc(e);o.vertexBuffer=this.vertexBuffer,o.indexBuffer[0]=this.indexBuffer,o.primitive[0].type=4,o.primitive[0].base=0,o.primitive[0].count=this.numParticles*this.numParticleIndices,o.primitive[0].indexed=!0,this.material=new Al,this.material.name=this.node.name,this.material.cull=0,this.material.alphaWrite=!1,this.material.blend=!0,this.material.blendType=this.blendType,this.material.depthWrite=this.depthWrite,this.material.emitter=this,this.regenShader(),this.resetMaterial();const h=!this.meshInstance||this.meshInstance.visible;this.meshInstance=new xd(o,this.material,this.node),this.meshInstance.pick=!1,this.meshInstance.updateKey(),this.meshInstance.cull=!0,this.meshInstance._noDepthDrawGl1=!0,this.localSpace?this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,this.node.getWorldTransform()):this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance._updateAabb=!1,this.meshInstance.visible=h,this._initializeTextures(),this.resetTime(),this.addTime(0,!1),this.preWarm&&this.prewarm(this.lifetime)}_isAnimated(){return this.animNumFrames>=1&&(this.animTilesX>1||this.animTilesY>1)&&(this.colorMap&&this.colorMap!==this.defaultParamTexture||this.normalMap)}rebuildGraphs(){const e=this.precision,t=this.graphicsDevice;this.qLocalVelocity=this.localVelocityGraph.quantize(e),this.qVelocity=this.velocityGraph.quantize(e),this.qColor=this.colorGraph.quantizeClamped(e,0,1),this.qRotSpeed=this.rotationSpeedGraph.quantize(e),this.qScale=this.scaleGraph.quantize(e),this.qAlpha=this.alphaGraph.quantize(e),this.qRadialSpeed=this.radialSpeedGraph.quantize(e),this.qLocalVelocity2=this.localVelocityGraph2.quantize(e),this.qVelocity2=this.velocityGraph2.quantize(e),this.qColor2=this.colorGraph2.quantizeClamped(e,0,1),this.qRotSpeed2=this.rotationSpeedGraph2.quantize(e),this.qScale2=this.scaleGraph2.quantize(e),this.qAlpha2=this.alphaGraph2.quantize(e),this.qRadialSpeed2=this.radialSpeedGraph2.quantize(e);for(let t=0;t<e;t++)this.qRotSpeed[t]*=ne.DEG_TO_RAD,this.qRotSpeed2[t]*=ne.DEG_TO_RAD;if(this.localVelocityUMax=new Float32Array(3),this.velocityUMax=new Float32Array(3),this.colorUMax=new Float32Array(3),this.rotSpeedUMax=[0],this.scaleUMax=[0],this.alphaUMax=[0],this.radialSpeedUMax=[0],this.qLocalVelocityDiv=e_(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax),this.qVelocityDiv=e_(this.qVelocity,this.qVelocity2,this.velocityUMax),this.qColorDiv=e_(this.qColor,this.qColor2,this.colorUMax),this.qRotSpeedDiv=e_(this.qRotSpeed,this.qRotSpeed2,this.rotSpeedUMax),this.qScaleDiv=e_(this.qScale,this.qScale2,this.scaleUMax),this.qAlphaDiv=e_(this.qAlpha,this.qAlpha2,this.alphaUMax),this.qRadialSpeedDiv=e_(this.qRadialSpeed,this.qRadialSpeed2,this.radialSpeedUMax),this.pack8){const e=[0,0,0];Jf(this.qVelocity,e);const t=[0,0,0];Jf(this.qVelocity2,t);const s=[0,0,0];Jf(this.qLocalVelocity,s);const i=[0,0,0];Jf(this.qLocalVelocity2,i);const n=[0];Jf(this.qRadialSpeed,n);const a=[0];Jf(this.qRadialSpeed2,a);let r=Math.max(e[0],t[0]);r=Math.max(r,e[1]),r=Math.max(r,t[1]),r=Math.max(r,e[2]),r=Math.max(r,t[2]);let o=Math.max(s[0],i[0]);o=Math.max(o,s[1]),o=Math.max(o,i[1]),o=Math.max(o,s[2]),o=Math.max(o,i[2]);const h=Math.max(n[0],a[0]);this.maxVel=r+o+h}this.useCpu||(this.internalTex0=kf(t,e,1,Qf(this.qLocalVelocity,this.qLocalVelocityDiv)),this.internalTex1=kf(t,e,1,Qf(this.qVelocity,this.qVelocityDiv)),this.internalTex2=kf(t,e,1,function(e,t,s,i,n){const a=new Array(4*e.length);for(let r=0;r<e.length;r++)a[4*r]=e[r],a[4*r+1]=t[r],a[4*r+2]=0,a[4*r+3]=Zf(s[r],i[r],n[r]);return a}(this.qRotSpeed,this.qScale,this.qScaleDiv,this.qRotSpeedDiv,this.qAlphaDiv)),this.internalTex3=kf(t,e,1,function(e,t){const s=new Array(4*e.length);for(let i=0;i<e.length;i++)s[4*i]=e[i],s[4*i+1]=t[i],s[4*i+2]=0,s[4*i+3]=0;return s}(this.qRadialSpeed,this.qRadialSpeedDiv))),this.colorParam=kf(t,e,1,function(e,t){const s=new Array(4*t.length);for(let i=0;i<t.length;i++)s[4*i]=e[3*i],s[4*i+1]=e[3*i+1],s[4*i+2]=e[3*i+2],s[4*i+3]=t[i];return s}(this.qColor,this.qAlpha),7,1,!0)}_initializeTextures(){this.colorMap&&(this.material.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&this.material.setParameter("normalMap",this.normalMap))}regenShader(){const e=this.graphicsDevice.getProgramLibrary();this.graphicsDevice.programLib.register("particle",hf);const t=null!==this.normalMap;this.normalOption=0,this.lighting&&(this.normalOption=t?2:1),this.material.getShaderVariant=function(t,s,i,n,a,r,o,h){this.emitter.scene&&this.emitter.camera!==this.emitter.scene._activeCamera&&(this.emitter.camera=this.emitter.scene._activeCamera,this.emitter.onChangeCamera());const l=this.emitter.inTools;return e.getProgram("particle",{useCpu:this.emitter.useCpu,normal:this.emitter.normalOption,halflambert:this.emitter.halfLambert,stretch:this.emitter.stretch,alignToMotion:this.emitter.alignToMotion,soft:this.emitter.depthSoftening,mesh:this.emitter.useMesh,gamma:this.emitter.scene?this.emitter.scene.gammaCorrection:0,toneMap:this.emitter.scene?this.emitter.scene.toneMapping:0,fog:this.emitter.scene&&!this.emitter.noFog?this.emitter.scene.fog:"none",wrap:this.emitter.wrap&&this.emitter.wrapBounds,localSpace:this.emitter.localSpace,screenSpace:!l&&this.emitter.screenSpace,blend:this.blendType,animTex:this.emitter._isAnimated(),animTexLoop:this.emitter.animLoop,pack8:this.emitter.pack8,customFace:0!==this.emitter.orientation})},this.material.shader=this.material.getShaderVariant()}resetMaterial(){const e=this.material;e.setParameter("stretch",this.stretch),this._isAnimated()&&(e.setParameter("animTexTilesParams",this.animTilesParams),e.setParameter("animTexParams",this.animParams),e.setParameter("animTexIndexParams",this.animIndexParams)),e.setParameter("colorMult",this.intensity),this.useCpu||(e.setParameter("internalTex0",this.internalTex0),e.setParameter("internalTex1",this.internalTex1),e.setParameter("internalTex2",this.internalTex2),e.setParameter("internalTex3",this.internalTex3)),e.setParameter("colorParam",this.colorParam),e.setParameter("numParticles",this.numParticles),e.setParameter("numParticlesPot",this.numParticlesPot),e.setParameter("lifetime",this.lifetime),e.setParameter("rate",this.rate),e.setParameter("rateDiv",this.rate2-this.rate),e.setParameter("seed",this.seed),e.setParameter("scaleDivMult",this.scaleUMax[0]),e.setParameter("alphaDivMult",this.alphaUMax[0]),e.setParameter("radialSpeedDivMult",this.radialSpeedUMax[0]),e.setParameter("graphNumSamples",this.precision),e.setParameter("graphSampleSize",1/this.precision),e.setParameter("emitterScale",new Float32Array([1,1,1])),this.pack8&&(this._gpuUpdater._setInputBounds(),e.setParameter("inBoundsSize",this._gpuUpdater.inBoundsSizeUniform),e.setParameter("inBoundsCenter",this._gpuUpdater.inBoundsCenterUniform),e.setParameter("maxVel",this.maxVel)),this.wrap&&this.wrapBounds&&(this.wrapBoundsUniform[0]=this.wrapBounds.x,this.wrapBoundsUniform[1]=this.wrapBounds.y,this.wrapBoundsUniform[2]=this.wrapBounds.z,e.setParameter("wrapBounds",this.wrapBoundsUniform)),this.colorMap&&e.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&e.setParameter("normalMap",this.normalMap),this.depthSoftening>0&&e.setParameter("softening",1/(this.depthSoftening*this.depthSoftening*100)),this.stretch>0&&(e.cull=0),this._compParticleFaceParams()}_compParticleFaceParams(){let e,t;if(0===this.orientation)e=new Float32Array([1,0,0]),t=new Float32Array([0,0,1]);else{let s;if(1===this.orientation)s=this.particleNormal.normalize();else{s=(null===this.node?Ce.IDENTITY:this.node.getWorldTransform()).transformVector(this.particleNormal).normalize()}const i=new ge(1,0,0);1===Math.abs(i.dot(s))&&i.set(0,0,1);const n=(new ge).cross(s,i).normalize();i.cross(n,s).normalize(),e=new Float32Array([i.x,i.y,i.z]),t=new Float32Array([n.x,n.y,n.z])}this.material.setParameter("faceTangent",e),this.material.setParameter("faceBinorm",t)}_allocate(e){const t=e*this.numParticleVerts,s=e*this.numParticleIndices;if(void 0===this.vertexBuffer||this.vertexBuffer.getNumVertices()!==t){if(this.useCpu){const e=[{semantic:"ATTR0",components:4,type:6},{semantic:"ATTR1",components:4,type:6},{semantic:"ATTR2",components:4,type:6},{semantic:"ATTR3",components:1,type:6},{semantic:"ATTR4",components:this.useMesh?4:2,type:6}],i=new go(this.graphicsDevice,e);this.vertexBuffer=new fo(this.graphicsDevice,i,t,1),this.indexBuffer=new nc(this.graphicsDevice,1,s)}else{const e=[{semantic:"ATTR0",components:4,type:6}];this.useMesh&&e.push({semantic:"ATTR1",components:2,type:6});const i=new go(this.graphicsDevice,e);this.vertexBuffer=new fo(this.graphicsDevice,i,t,1),this.indexBuffer=new nc(this.graphicsDevice,1,s)}const i=new Float32Array(this.vertexBuffer.lock());let n,a,r;if(this.useMesh){n=new Float32Array(this.mesh.vertexBuffer.lock()),a=n.length/this.mesh.vertexBuffer.numVertices;for(let e=0;e<this.mesh.vertexBuffer.format.elements.length;e++)if("TEXCOORD0"===this.mesh.vertexBuffer.format.elements[e].name){r=this.mesh.vertexBuffer.format.elements[e].offset/4;break}}for(let e=0;e<t;e++){const t=Math.floor(e/this.numParticleVerts);if(this.useMesh){const s=e%this.numParticleVerts;i[6*e]=n[s*a],i[6*e+1]=n[s*a+1],i[6*e+2]=n[s*a+2],i[6*e+3]=t,i[6*e+4]=n[s*a+r+0],i[6*e+5]=1-n[s*a+r+1]}else{const s=e%4;i[4*e]=Ff[s][0],i[4*e+1]=Ff[s][1],i[4*e+2]=0,i[4*e+3]=t}}this.useCpu&&(this.vbCPU=new Float32Array(i),this.vbOld=new Float32Array(this.vbCPU.length)),this.vertexBuffer.unlock(),this.useMesh&&this.mesh.vertexBuffer.unlock();let o=0;const h=new Uint16Array(this.indexBuffer.lock());this.useMesh&&(n=new Uint16Array(this.mesh.indexBuffer[0].lock()));for(let t=0;t<e;t++)if(this.useMesh)for(let e=0;e<this.numParticleIndices;e++)h[t*this.numParticleIndices+e]=n[e]+t*this.numParticleVerts;else{const e=4*t;h[o++]=e,h[o++]=e+1,h[o++]=e+2,h[o++]=e,h[o++]=e+2,h[o++]=e+3}this.indexBuffer.unlock(),this.useMesh&&this.mesh.indexBuffer[0].unlock()}}reset(){if(this.beenReset=!0,this.seed=Math.random(),this.material.setParameter("seed",this.seed),this.useCpu)for(let e=0;e<this.particleTexStart.length;e++)this.particleTex[e]=this.particleTexStart[e];else this._initializeTextures();this.resetWorldBounds(),this.resetTime();const e=this.loop;this.loop=!0,this.addTime(0,!1),this.loop=e,this.preWarm&&this.prewarm(this.lifetime)}prewarm(e){const t=e/this.lifetime,s=Math.min(Math.floor(t*this.precision),this.precision),i=e/s;for(let e=0;e<s;e++)this.addTime(i,!1)}resetTime(){this.endTime=function(e){const t=Math.max(e.rate,e.rate2)*e.numParticles+e.lifetime;return Date.now()+1e3*t}(this)}finishFrame(){this.useCpu&&this.vertexBuffer.unlock()}addTime(e,t){const s=this.graphicsDevice;if(this.simTimeTotal+=e,this.calculateWorldBounds(),this._isAnimated()){const e=this.animTilesParams;e[0]=1/this.animTilesX,e[1]=1/this.animTilesY;const t=this.animParams;t[0]=this.animStartFrame,t[1]=this.animNumFrames*this.animSpeed,t[2]=this.animNumFrames-1,t[3]=this.animNumAnimations-1;const s=this.animIndexParams;s[0]=this.animIndex,s[1]=this.randomizeAnimIndex}let i;this.scene&&this.camera!==this.scene._activeCamera&&(this.camera=this.scene._activeCamera,this.onChangeCamera()),0===this.emitterShape&&(Wf[0]=0!==this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,Wf[1]=0!==this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,Wf[2]=0!==this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0,null===this.meshInstance.node?Hf.setTRS(ge.ZERO,Ae.IDENTITY,this.emitterExtents):Hf.setTRS(ge.ZERO,this.meshInstance.node.getRotation(),Xf.copy(this.emitterExtents).mul(this.meshInstance.node.localScale)));const n=null===this.meshInstance.node?ge.ONE:this.meshInstance.node.localScale;if(this.emitterScaleUniform[0]=n.x,this.emitterScaleUniform[1]=n.y,this.emitterScaleUniform[2]=n.z,this.material.setParameter("emitterScale",this.emitterScaleUniform),this.localSpace&&this.meshInstance.node&&(i=this.meshInstance.node.getPosition(),this.emitterPosUniform[0]=i.x,this.emitterPosUniform[1]=i.y,this.emitterPosUniform[2]=i.z,this.material.setParameter("emitterPos",this.emitterPosUniform)),this._compParticleFaceParams(),this.useCpu){const s=new Float32Array(this.vertexBuffer.lock());this._cpuUpdater.update(s,this.vbToSort,this.particleTex,Hf,Wf,i,e,t)}else this._gpuUpdater.update(s,Hf,Wf,e,t);this.loop||Date.now()>this.endTime&&(this.onFinished&&this.onFinished(),this.meshInstance.visible=!1),this.meshInstance&&(this.meshInstance.drawOrder=this.drawOrder)}_destroyResources(){this.particleTexIN&&(this.particleTexIN.destroy(),this.particleTexIN=null),this.particleTexOUT&&(this.particleTexOUT.destroy(),this.particleTexOUT=null),this.particleTexStart&&this.particleTexStart.destroy&&(this.particleTexStart.destroy(),this.particleTexStart=null),this.rtParticleTexIN&&(this.rtParticleTexIN.destroy(),this.rtParticleTexIN=null),this.rtParticleTexOUT&&(this.rtParticleTexOUT.destroy(),this.rtParticleTexOUT=null),this.internalTex0&&(this.internalTex0.destroy(),this.internalTex0=null),this.internalTex1&&(this.internalTex1.destroy(),this.internalTex1=null),this.internalTex2&&(this.internalTex2.destroy(),this.internalTex2=null),this.internalTex3&&(this.internalTex3.destroy(),this.internalTex3=null),this.colorParam&&(this.colorParam.destroy(),this.colorParam=null),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=void 0),this.indexBuffer&&(this.indexBuffer.destroy(),this.indexBuffer=void 0),this.material&&(this.material.destroy(),this.material=null)}destroy(){this.camera=null,this._destroyResources()}}const i_=new Set,n_={depth:1,flags:2};class a_{constructor(e,t,s){e instanceof Kl&&(e=zc()),this.app=e,this.device=e.graphicsDevice,this.pickColor=new Float32Array(4),this.pickColor[3]=1,this.mapping=[],this.cameraEntity=null,this.layer=null,this.layerComp=null,this.initLayerComposition(),this._renderTarget=null;const i=this.device;this.clearDepthCommand=new vd(0,0,(function(){i.clear(n_)})),this.width=0,this.height=0,this.resize(t,s)}getSelection(e,t,s,i){const n=this.device;if("object"==typeof e){const n=e;e=n.x,t=n.y,s=n.width,i=n.height}else t=this.renderTarget.height-(t+(i||1));e=Math.floor(e),t=Math.floor(t),s=Math.floor(Math.max(s||1,1)),i=Math.floor(Math.max(i||1,1));const a=n.renderTarget;n.setRenderTarget(this.renderTarget),n.updateBegin();const r=new Uint8Array(4*s*i);n.readPixels(e,t,s,i,r),n.updateEnd(),n.setRenderTarget(a);const o=this.mapping;for(let e=0;e<s*i;e++){const t=r[4*e+0]<<16|r[4*e+1]<<8|r[4*e+2];16777215!==t&&i_.add(o[t])}const h=[];return i_.forEach((e=>h.push(e))),i_.clear(),h}allocateRenderTarget(){const e=new fh(this.device,{format:7,width:this.width,height:this.height,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1,name:"pick"});this.renderTarget=new Jl({colorBuffer:e,depth:!0})}releaseRenderTarget(){this.cameraEntity.camera.renderTarget=null,this._renderTarget&&(this._renderTarget.destroyTextureBuffers(),this._renderTarget.destroy(),this._renderTarget=null)}initLayerComposition(){const e=this.device,t=this,s=e.scope.resolve("uColor");this.cameraEntity=new $m,this.cameraEntity.addComponent("camera"),this.layer=new Ku({name:"Picker",shaderPass:3,opaqueSortMode:0,onDrawCall:function(i,n){t.pickColor[0]=(n>>16&255)/255,t.pickColor[1]=(n>>8&255)/255,t.pickColor[2]=(255&n)/255,s.setValue(t.pickColor),e.setBlending(!1),t.mapping[n]=i}}),this.layer.addCamera(this.cameraEntity.camera),this.layerComp=new np("picker"),this.layerComp.pushOpaque(this.layer)}prepare(e,t,s){e instanceof xh&&(e=e.node.camera),s instanceof Ku&&(s=[s]),this.layer.clearMeshInstances();const i=this.layer.opaqueMeshInstances,n=t.layers.layerList,a=t.layers.subLayerEnabled,r=t.layers.subLayerList;for(let t=0;t<n.length;t++){const o=n[t];if(!(s&&s.indexOf(o)<0)&&(o.enabled&&a[t])){if(o.cameras.indexOf(e)>=0){o._clearDepthBuffer&&i.push(this.clearDepthCommand);const e=r[t]?o.instances.transparentMeshInstances:o.instances.opaqueMeshInstances;for(let t=0;t<e.length;t++){const s=e[t];s.pick&&i.push(s)}}}}this.renderTarget&&this.width===this.renderTarget.width&&this.height===this.renderTarget.height||(this.releaseRenderTarget(),this.allocateRenderTarget()),this.updateCamera(e),this.mapping.length=0,this.app.renderComposition(this.layerComp)}updateCamera(e){this.cameraEntity.copy(e.entity),this.cameraEntity.name="PickerCamera";const t=this.cameraEntity.camera;t.copy(e),t.clearColorBuffer=!0,t.clearDepthBuffer=!0,t.clearStencilBuffer=!0,t.clearColor=pe.WHITE,t.renderTarget=this.renderTarget,this.layer.clearCameras(),this.layer.addCamera(t),t.layers=[this.layer.id]}resize(e,t){this.width=Math.floor(e),this.height=Math.floor(t)}}class r_{constructor(e,t,s){this.device=e,this.inverseBindPose=t,this.boneNames=s}}const o_=[0,0,1,0,0,1,0,0,1,0,0,1],h_=[0,1,3,2,3,1];class l_ extends C{constructor(e,t){super(),this._device=e,this._pixelsPerUnit=t&&void 0!==t.pixelsPerUnit?t.pixelsPerUnit:1,this._renderMode=t&&void 0!==t.renderMode?t.renderMode:0,this._atlas=t&&void 0!==t.atlas?t.atlas:null,this._frameKeys=t&&void 0!==t.frameKeys?t.frameKeys:null,this._meshes=[],this._updatingProperties=!1,this._meshesDirty=!1,this._atlas&&this._frameKeys&&this._createMeshes()}set frameKeys(e){this._frameKeys=e,this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:frameKeys",e)}get frameKeys(){return this._frameKeys}set atlas(e){e!==this._atlas&&(this._atlas&&(this._atlas.off("set:frames",this._onSetFrames,this),this._atlas.off("set:frame",this._onFrameChanged,this),this._atlas.off("remove:frame",this._onFrameRemoved,this)),this._atlas=e,this._atlas&&this._frameKeys&&(this._atlas.on("set:frames",this._onSetFrames,this),this._atlas.on("set:frame",this._onFrameChanged,this),this._atlas.on("remove:frame",this._onFrameRemoved,this),this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:atlas",e))}get atlas(){return this._atlas}set pixelsPerUnit(e){this._pixelsPerUnit!==e&&(this._pixelsPerUnit=e,this.fire("set:pixelsPerUnit",e),this._atlas&&this._frameKeys&&0===this.renderMode&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()))}get pixelsPerUnit(){return this._pixelsPerUnit}set renderMode(e){if(this._renderMode===e)return;const t=this._renderMode;this._renderMode=e,this.fire("set:renderMode",e),0!==t&&0!==e||this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes())}get renderMode(){return this._renderMode}get meshes(){return this._meshes}_createMeshes(){const e=this._meshes.length;for(let t=0;t<e;t++){const e=this._meshes[t];e&&e.destroy()}const t=this._frameKeys.length;this._meshes=new Array(t);const s=1===this.renderMode||2===this._renderMode?this._create9SliceMesh:this._createSimpleMesh;for(let e=0;e<t;e++){const t=this._atlas.frames[this._frameKeys[e]];this._meshes[e]=t?s.call(this,t):null}this.fire("set:meshes")}_createSimpleMesh(e){const t=e.rect,s=this._atlas.texture.width,i=this._atlas.texture.height,n=t.z/this._pixelsPerUnit,a=t.w/this._pixelsPerUnit,r=e.pivot.x,o=e.pivot.y,h=[-r*n,-o*a,0,(1-r)*n,-o*a,0,(1-r)*n,(1-o)*a,0,-r*n,(1-o)*a,0],l=t.x/s,c=1-t.y/i,d=(t.x+t.z)/s,u=1-(t.y+t.w)/i,p=[l,c,d,c,d,u,l,u];return jc(this._device,h,{uvs:p,normals:o_,indices:h_})}_create9SliceMesh(){const e=ve.ONE,t=[],s=[],i=[],n=[];let a=0;for(let r=0;r<=3;r++){const o=0===r||3===r?0:1;for(let h=0;h<=3;h++){const l=-e.x+2*e.x*(r<=1?0:3)/3,c=0,d=-(-e.y+2*e.y*(h<=1?0:3)/3),u=0===h||3===h?0:1;t.push(-l,c,d),s.push(0,1,0),i.push(o,u),r<3&&h<3&&(n.push(a+3+1,a+1,a),n.push(a+3+1,a+3+2,a+1)),a++}}const r={normals:s,uvs:i,indices:n};return jc(this._device,t,r)}_onSetFrames(e){this._updatingProperties?this._meshesDirty=!0:this._createMeshes()}_onFrameChanged(e,t){const s=this._frameKeys.indexOf(e);s<0||(t?0===this.renderMode&&(this._meshes[s]=this._createSimpleMesh(t)):this._meshes[s]=null,this.fire("set:meshes"))}_onFrameRemoved(e){const t=this._frameKeys.indexOf(e);t<0||(this._meshes[t]=null,this.fire("set:meshes"))}startUpdate(){this._updatingProperties=!0,this._meshesDirty=!1}endUpdate(){this._updatingProperties=!1,this._meshesDirty&&this._atlas&&this._frameKeys&&this._createMeshes(),this._meshesDirty=!1}destroy(){for(const e of this._meshes)e&&e.destroy();this._meshes.length=0}}class c_{constructor(e){this.func=void 0===e.func?7:e.func,this.ref=e.ref||0,this.readMask=void 0===e.readMask?255:e.readMask,this.writeMask=void 0===e.writeMask?255:e.writeMask,this.fail=e.fail||0,this.zfail=e.zfail||0,this.zpass=e.zpass||0}clone(){return new c_({func:this.func,ref:this.ref,readMask:this.readMask,writeMask:this.writeMask,fail:this.fail,zfail:this.zfail,zpass:this.zpass})}}class d_ extends C{constructor(){super(),this._texture=null,this._frames=null}set texture(e){this._texture=e,this.fire("set:texture",e)}get texture(){return this._texture}set frames(e){this._frames=e,this.fire("set:frames",e)}get frames(){return this._frames}setFrame(e,t){let s=this._frames[e];s?(s.rect.copy(t.rect),s.pivot.copy(t.pivot),s.border.copy(t.border)):(s={rect:t.rect.clone(),pivot:t.pivot.clone(),border:t.border.clone()},this._frames[e]=s),this.fire("set:frame",e.toString(),s)}removeFrame(e){const t=this._frames[e];t&&(delete this._frames[e],this.fire("remove:frame",e.toString(),t))}destroy(){this._texture&&this._texture.destroy()}}class u_{constructor(e,t,s,i){this.time=e,this.position=t,this.rotation=s,this.scale=i}}class p_{constructor(){this._name="",this._keys=[]}}class m_{constructor(){this.name="",this.duration=0,this._nodes=[],this._nodeDict={}}getNode(e){return this._nodeDict[e]}addNode(e){this._nodes.push(e),this._nodeDict[e._name]=e}get nodes(){return this._nodes}}class f_{constructor(){this._written=!1,this._name="",this._keyFrames=[],this._quat=new Ae,this._pos=new ge,this._scale=new ge,this._targetNode=null}getTarget(){return this._targetNode}setTarget(e){this._targetNode=e}}class __{constructor(e){this.looping=!0,this._animation=null,this._time=0,this._interpolatedKeys=[],this._interpolatedKeyDict={},this._currKeyIndices={},this.graph=null;const t=e=>{const s=new f_;s._name=e.name,this._interpolatedKeys.push(s),this._interpolatedKeyDict[e.name]=s,this._currKeyIndices[e.name]=0;for(let s=0;s<e._children.length;s++)t(e._children[s])};t(e)}set animation(e){this._animation=e,this.currentTime=0}get animation(){return this._animation}set currentTime(e){this._time=e;const t=this._interpolatedKeys.length;for(let e=0;e<t;e++){const t=this._interpolatedKeys[e]._name;this._currKeyIndices[t]=0}this.addTime(0),this.updateGraph()}get currentTime(){return this._time}get numNodes(){return this._interpolatedKeys.length}addTime(e){if(null!==this._animation){const t=this._animation._nodes,s=this._animation.duration;if(this._time===s&&!this.looping)return;if(this._time+=e,this._time>s){this._time=this.looping?0:s;for(let e=0;e<t.length;e++){const s=t[e]._name;this._currKeyIndices[s]=0}}else if(this._time<0){this._time=this.looping?s:0;for(let e=0;e<t.length;e++){const s=t[e],i=s._name;this._currKeyIndices[i]=s._keys.length-2}}const i=e>=0?1:-1;for(let e=0;e<t.length;e++){const s=t[e],n=s._name,a=s._keys,r=this._interpolatedKeyDict[n];if(void 0===r)continue;let o=!1;if(1!==a.length)for(let e=this._currKeyIndices[n];e<a.length-1&&e>=0;e+=i){const t=a[e],s=a[e+1];if(t.time<=this._time&&s.time>=this._time){const i=(this._time-t.time)/(s.time-t.time);r._pos.lerp(t.position,s.position,i),r._quat.slerp(t.rotation,s.rotation,i),r._scale.lerp(t.scale,s.scale,i),r._written=!0,this._currKeyIndices[n]=e,o=!0;break}}(1===a.length||!o&&0===this._time&&this.looping)&&(r._pos.copy(a[0].position),r._quat.copy(a[0].rotation),r._scale.copy(a[0].scale),r._written=!0)}}}blend(e,t,s){const i=this._interpolatedKeys.length;for(let n=0;n<i;n++){const i=e._interpolatedKeys[n],a=t._interpolatedKeys[n],r=this._interpolatedKeys[n];i._written&&a._written?(r._quat.slerp(i._quat,t._interpolatedKeys[n]._quat,s),r._pos.lerp(i._pos,t._interpolatedKeys[n]._pos,s),r._scale.lerp(i._scale,a._scale,s),r._written=!0):i._written?(r._quat.copy(i._quat),r._pos.copy(i._pos),r._scale.copy(i._scale),r._written=!0):a._written&&(r._quat.copy(a._quat),r._pos.copy(a._pos),r._scale.copy(a._scale),r._written=!0)}}setGraph(e){if(this.graph=e,e)for(let t=0;t<this._interpolatedKeys.length;t++){const s=this._interpolatedKeys[t],i=e.findByName(s._name);this._interpolatedKeys[t].setTarget(i)}else for(let e=0;e<this._interpolatedKeys.length;e++)this._interpolatedKeys[e].setTarget(null)}updateGraph(){if(this.graph)for(let e=0;e<this._interpolatedKeys.length;e++){const t=this._interpolatedKeys[e];if(t._written){const e=t.getTarget();e.localPosition.copy(t._pos),e.localRotation.copy(t._quat),e.localScale.copy(t._scale),e._dirtyLocal||e._dirtifyLocal(),t._written=!1}}}}const g_=0,y_=1,v_=2;class x_{static joinPath(e,t){t=t||".";return e.map((function(e){return e.replace(/\\/g,"\\\\").replace(new RegExp("\\"+t,"g"),"\\"+t)})).join(t)}static splitPath(e,t){t=t||".";const s=[];let i="",n=0;for(;n<e.length;){let a=e[n++];"\\"===a&&n<e.length?(a=e[n++],i+="\\"===a||a===t?a:"\\"+a):a===t?(s.push(i),i=""):i+=a}return i.length>0&&s.push(i),s}static encode(e,t,s){return`${Array.isArray(e)?e.join("/"):e}/${t}/${Array.isArray(s)?s.join("/"):s}`}resolve(e){return null}unresolve(e){}update(e){}}function b_(){return b_=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i])}return e},b_.apply(this,arguments)}class S_{constructor(){this._left=1/0,this._right=-1/0,this._len=0,this._recip=0,this._p0=0,this._p1=0,this._t=0,this._hermite={valid:!1,p0:0,m0:0,p1:0,m1:0}}update(e,t){if(e<this._left||e>=this._right){const s=t.length;if(s)if(e<t[0])this._left=-1/0,this._right=t[0],this._len=0,this._recip=0,this._p0=this._p1=0;else if(e>=t[s-1])this._left=t[s-1],this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=s-1;else{const s=this._findKey(e,t);this._left=t[s],this._right=t[s+1],this._len=this._right-this._left;const i=1/this._len;this._recip=isFinite(i)?i:0,this._p0=s,this._p1=s+1}else this._left=-1/0,this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=0}this._t=0===this._recip?0:(e-this._left)*this._recip,this._hermite.valid=!1}_findKey(e,t){let s=0;for(;e>=t[s+1];)s++;return s}eval(e,t,s){const i=s._data,n=s._components,a=this._p0*n;if(0===t)for(let t=0;t<n;++t)e[t]=i[a+t];else{const s=this._t,r=this._p1*n;switch(t){case 1:for(let t=0;t<n;++t)e[t]=ne.lerp(i[a+t],i[r+t],s);break;case 2:{const t=this._hermite;if(!t.valid){const e=s*s,i=s+s,n=1-s,a=n*n;t.valid=!0,t.p0=(1+i)*a,t.m0=s*a,t.p1=e*(3-i),t.m1=e*(s-1)}const a=(3*this._p0+1)*n,r=(3*this._p0+2)*n,o=(3*this._p1+1)*n,h=(3*this._p1+0)*n;for(let s=0;s<n;++s)e[s]=t.p0*i[a+s]+t.m0*i[r+s]*this._len+t.p1*i[o+s]+t.m1*i[h+s]*this._len;break}}}}}class w_{constructor(e){this._name=e.name+"Snapshot",this._time=-1,this._cache=[],this._results=[];for(let t=0;t<e._inputs.length;++t)this._cache[t]=new S_;const t=e._curves,s=e._outputs;for(let e=0;e<t.length;++e){const i=s[t[e]._output],n=[];for(let e=0;e<i._components;++e)n[e]=0;this._results[e]=n}}}class T_{constructor(e,t,s,i,n,a){for(this._name=e.name,this._track=e,this._snapshot=new w_(e),this._playing=i,this._time=t,this._speed=s,this._loop=n,this._blendWeight=1,this._blendOrder=0,this._eventHandler=a,this._eventCursor=0;this._track.events[this._eventCursor]&&this._track.events[this._eventCursor].time<this.time;)this._eventCursor++}set name(e){this._name=e}get name(){return this._name}get track(){return this._track}get snapshot(){return this._snapshot}set time(e){this._time=e}get time(){return this._time}set speed(e){this._speed=e}get speed(){return this._speed}set loop(e){this._loop=e}get loop(){return this._loop}set blendWeight(e){this._blendWeight=e}get blendWeight(){return this._blendWeight}set blendOrder(e){this._blendOrder=e}get blendOrder(){return this._blendOrder}set eventCursor(e){this._eventCursor=e}get eventCursor(){return this._eventCursor}activeEventsForFrame(e,t){let s;for(0===e&&(this.eventCursor=0),t>this.track.duration&&(s=t-this.track.duration,t=this.track.duration);this.track.events[this.eventCursor]&&this.track.events[this.eventCursor].time>=e&&(t===this.track.duration?this.track.events[this.eventCursor].time<=t:this.track.events[this.eventCursor].time<t);){const e=this.track.events[this.eventCursor];this._eventHandler.fire(e.name,b_({track:this.track},e)),this.eventCursor++}Number.isFinite(s)&&this.activeEventsForFrame(0,s)}_update(e){if(this._playing){let t=this._time;const s=this._track.duration,i=this._speed,n=this._loop;this._track.events.length>0&&s>0&&this.activeEventsForFrame(t,t+i*e),t+=i*e,i>=0?t>s&&(n?t=t%s||0:(t=this._track.duration,this.pause())):t<0&&(n?t=s+(t%s||0):(t=0,this.pause())),this._time=t}this._time!==this._snapshot._time&&this._track.eval(this._time,this._snapshot)}play(){this._playing=!0,this._time=0}stop(){this._playing=!1,this._time=0}pause(){this._playing=!1}resume(){this._playing=!0}reset(){this._time=0}}class M_{constructor(e,t,s,i){this._paths=e,this._input=t,this._output=s,this._interpolation=i}get paths(){return this._paths}get input(){return this._input}get output(){return this._output}get interpolation(){return this._interpolation}}class C_{constructor(e,t){this._components=e,this._data=t}get components(){return this._components}get data(){return this._data}}const A_="NONE",P_="PREV_STATE",E_="NEXT_STATE",R_="PREV_STATE_NEXT_STATE",L_="NEXT_STATE_PREV_STATE",I_="GREATER_THAN",D_="LESS_THAN",O_="GREATER_THAN_EQUAL_TO",F_="LESS_THAN_EQUAL_TO",k_="EQUAL_TO",B_="NOT_EQUAL_TO",z_="INTEGER",U_="FLOAT",V_="BOOLEAN",N_="TRIGGER",G_="1D",W_="2D_DIRECTIONAL",H_="2D_CARTESIAN",X_="DIRECT",q_="START",j_="END",Y_="ANY",$_=["START","END","ANY"],K_="OVERWRITE",Z_="ADDITIVE";class Q_{constructor(e,t){this._component=e,this.mask=new Int8Array(e.layers.length),this.weights=new Float32Array(e.layers.length),this.totalWeight=0,this.counter=0,this.layerCounter=0,this.valueType=t,this.dirty=!0,this.value=t===Q_.TYPE_QUAT?[0,0,0,1]:[0,0,0],this.baseValue=null,this.setter=null}get _normalizeWeights(){return this._component.normalizeWeights}getWeight(e){return this.dirty&&this.updateWeights(),this._normalizeWeights&&0===this.totalWeight||!this.mask[e]?0:this._normalizeWeights?this.weights[e]/this.totalWeight:ne.clamp(this.weights[e],0,1)}_layerBlendType(e){return this._component.layers[e].blendType}setMask(e,t){this.mask[e]=t,this._normalizeWeights&&("OVERWRITE"===this._component.layers[e].blendType&&(this.mask=this.mask.fill(0,0,e)),this.dirty=!0)}updateWeights(){this.totalWeight=0;for(let e=0;e<this.weights.length;e++)this.weights[e]=this._component.layers[e].weight,this.totalWeight+=this.mask[e]*this.weights[e];this.dirty=!1}updateValue(e,t){if(0===this.counter&&(J_._set(this.value,Q_.IDENTITY_QUAT_ARR,this.valueType),this._normalizeWeights||J_._blend(this.value,this.baseValue,1,this.valueType)),this.mask[e]&&0!==this.getWeight(e)){if("ADDITIVE"!==this._layerBlendType(e)||this._normalizeWeights)J_._blend(this.value,t,this.getWeight(e),this.valueType);else if(this.valueType===Q_.TYPE_QUAT){const s=Q_.q1.set(this.value[0],this.value[1],this.value[2],this.value[3]),i=Q_.q2.set(this.baseValue[0],this.baseValue[1],this.baseValue[2],this.baseValue[3]),n=Q_.q3.set(t[0],t[1],t[2],t[3]),a=i.invert().mul(n);a.slerp(Ae.IDENTITY,a,this.getWeight(e)),s.mul(a),Q_.quatArr[0]=s.x,Q_.quatArr[1]=s.y,Q_.quatArr[2]=s.z,Q_.quatArr[3]=s.w,J_._set(this.value,Q_.quatArr,this.valueType)}else Q_.vecArr[0]=t[0]-this.baseValue[0],Q_.vecArr[1]=t[1]-this.baseValue[1],Q_.vecArr[2]=t[2]-this.baseValue[2],J_._blend(this.value,Q_.vecArr,this.getWeight(e),this.valueType,!0);this.setter&&this.setter(this.value)}}unbind(){this.setter&&this.setter(this.baseValue)}}Q_.TYPE_QUAT="quaternion",Q_.TYPE_VEC3="vector3",Q_.q1=new Ae,Q_.q2=new Ae,Q_.q3=new Ae,Q_.quatArr=[0,0,0,1],Q_.vecArr=[0,0,0],Q_.IDENTITY_QUAT_ARR=[0,0,0,1];class J_{constructor(e){this._binder=e,this._clips=[],this._inputs=[],this._outputs=[],this._targets={}}get clips(){return this._clips}static _dot(e,t){const s=e.length;let i=0;for(let n=0;n<s;++n)i+=e[n]*t[n];return i}static _normalize(e){let t=J_._dot(e,e);if(t>0){t=1/Math.sqrt(t);const s=e.length;for(let i=0;i<s;++i)e[i]*=t}}static _set(e,t,s){const i=e.length;if("quaternion"===s){let s=J_._dot(t,t);s>0&&(s=1/Math.sqrt(s));for(let n=0;n<i;++n)e[n]=t[n]*s}else for(let s=0;s<i;++s)e[s]=t[s]}static _blendVec(e,t,s,i){const n=i?1:1-s,a=e.length;for(let i=0;i<a;++i)e[i]=e[i]*n+t[i]*s}static _blendQuat(e,t,s,i){const n=e.length,a=i?1:1-s;J_._dot(e,t)<0&&(s=-s);for(let i=0;i<n;++i)e[i]=e[i]*a+t[i]*s;i||J_._normalize(e)}static _blend(e,t,s,i,n){"quaternion"===i?J_._blendQuat(e,t,s,n):J_._blendVec(e,t,s,n)}static _stableSort(e,t){const s=e.length;for(let i=0;i<s-1;++i)for(let n=i+1;n<s;++n)if(t(e[n],e[i])){const t=e[i];e[i]=e[n],e[n]=t}}addClip(e){const t=this._targets,s=this._binder,i=e.track.curves,n=e.snapshot,a=[],r=[];for(let e=0;e<i.length;++e){const o=i[e].paths;for(let i=0;i<o.length;++i){const h=o[i],l=s.resolve(h);let c=t[l&&l.targetPath||null];if(!c&&l){c={target:l,value:[],curves:0,blendCounter:0};for(let e=0;e<c.target.components;++e)c.value.push(0);if(t[l.targetPath]=c,s.animComponent){if(!s.animComponent.targets[l.targetPath]){let e;e="localRotation"===l.targetPath.substring(l.targetPath.length-13)?Q_.TYPE_QUAT:Q_.TYPE_VEC3,s.animComponent.targets[l.targetPath]=new Q_(s.animComponent,e)}s.animComponent.targets[l.targetPath].layerCounter++,s.animComponent.targets[l.targetPath].setMask(s.layerIndex,1)}}c&&(c.curves++,a.push(n._results[e]),r.push(c))}}this._clips.push(e),this._inputs.push(a),this._outputs.push(r)}removeClip(e){const t=this._targets,s=this._binder,i=this._clips,n=i[e].track.curves;for(let e=0;e<n.length;++e){const i=n[e].paths;for(let e=0;e<i.length;++e){const n=i[e],a=this._binder.resolve(n);a&&(a.curves--,0===a.curves&&(s.unresolve(n),delete t[a.targetPath],s.animComponent&&s.animComponent.targets[a.targetPath].layerCounter--))}}i.splice(e,1),this._inputs.splice(e,1),this._outputs.splice(e,1)}removeClips(){for(;this._clips.length>0;)this.removeClip(0)}findClip(e){const t=this._clips;for(let s=0;s<t.length;++s){const i=t[s];if(i.name===e)return i}return null}rebind(){this._binder.rebind(),this._targets={};const e=[...this.clips];this.removeClips(),e.forEach((e=>{this.addClip(e)}))}assignMask(e){return this._binder.assignMask(e)}update(e){const t=this._clips,s=t.map((function(e,t){return t}));J_._stableSort(s,(function(e,s){return t[e].blendOrder<t[s].blendOrder}));for(let i=0;i<s.length;++i){const n=s[i],a=t[n],r=this._inputs[n],o=this._outputs[n],h=a.blendWeight;let l,c,d;if(h>0&&a._update(e),h>=1)for(let e=0;e<r.length;++e)l=r[e],c=o[e],d=c.value,J_._set(d,l,c.target.type),c.blendCounter++;else if(h>0)for(let e=0;e<r.length;++e)l=r[e],c=o[e],d=c.value,0===c.blendCounter?J_._set(d,l,c.target.type):J_._blend(d,l,h,c.target.type),c.blendCounter++}const i=this._targets,n=this._binder;for(const e in i)if(i.hasOwnProperty(e)){const t=i[e];if(n.animComponent&&t.target.isTransform){const s=n.animComponent.targets[e];s.counter===s.layerCounter&&(s.counter=0),s.path||(s.path=e,s.baseValue=t.target.get(),s.setter=t.target.set),s.updateValue(n.layerIndex,t.value),s.counter++}else t.target.set(t.value);t.blendCounter=0}n.update(e)}}class eg{constructor(e,t,s,i){e.set?(this._set=e.set,this._get=e.get):this._set=e,this._type=t,this._components=s,this._targetPath=i,this._isTransform="localRotation"===this._targetPath.substring(this._targetPath.length-13)||"localPosition"===this._targetPath.substring(this._targetPath.length-13)||"localScale"===this._targetPath.substring(this._targetPath.length-10)}get set(){return this._set}get get(){return this._get}get type(){return this._type}get components(){return this._components}get targetPath(){return this._targetPath}get isTransform(){return this._isTransform}}class tg{constructor(e){this._events=[...e],this._events.sort(((e,t)=>e.time-t.time))}get events(){return this._events}}class sg{constructor(e,t,s,i,n,a=new tg([])){this._name=e,this._duration=t,this._inputs=s,this._outputs=i,this._curves=n,this._animEvents=a}get name(){return this._name}get duration(){return this._duration}get inputs(){return this._inputs}get outputs(){return this._outputs}get curves(){return this._curves}set events(e){this._animEvents=e}get events(){return this._animEvents.events}eval(e,t){t._time=e;const s=this._inputs,i=this._outputs,n=this._curves,a=t._cache,r=t._results;for(let t=0;t<s.length;++t)a[t].update(e,s[t]._data);for(let e=0;e<n.length;++e){const t=n[e],s=i[t._output],o=r[e];a[t._input].eval(o,t._interpolation,s)}}}class ig{constructor(e){if(this._isPathInMask=(e,t)=>{const s=this._mask[e];return!!s&&!!(s.children||t&&!1!==s.value)},this.graph=e,!e)return;this._mask=null;const t={};!function e(s){t[s.name]=s;for(let t=0;t<s.children.length;++t)e(s.children[t])}(e),this.nodes=t,this.targetCache={};const s=function(e){let t,s=e;for(;s&&!(s instanceof $m);)s=s.parent;return s&&(s.render?t=s.render.meshInstances:s.model&&(t=s.model.meshInstances)),t};this.nodeCounts={},this.activeNodes=[],this.handlers={localPosition:function(e){const t=e.localPosition;return ig.createAnimTarget((function(e){t.set(...e)}),"vector",3,e,"localPosition")},localRotation:function(e){const t=e.localRotation;return ig.createAnimTarget((function(e){t.set(...e)}),"quaternion",4,e,"localRotation")},localScale:function(e){const t=e.localScale;return ig.createAnimTarget((function(e){t.set(...e)}),"vector",3,e,"localScale")},weight:function(e,t){t=0===t.indexOf("name.")?t.replace("name.",""):Number(t);const i=s(e);if(i)for(let s=0;s<i.length;++s)if(i[s].node.name===e.name&&i[s].morphInstance){const n=i[s].morphInstance,a=e=>{n.setWeight(t,e[0])};return ig.createAnimTarget(a,"number",1,e,`weight.${t}`)}return null},materialTexture:(e,t)=>{const i=s(e);if(i){let s;for(let t=0;t<i.length;++t)if(i[t].node.name===e.name){s=i[t];break}if(s){const i=e=>{const i=this.animComponent.system.app.assets.get(e[0]);i&&i.resource&&"texture"===i.type&&(s.material[t]=i.resource,s.material.update())};return ig.createAnimTarget(i,"vector",1,e,"materialTexture","material")}}return null}}}_isPathActive(e){if(!this._mask)return!0;const t=[e.entityPath[0],this.graph.name];for(let s=0;s<t.length;++s){let i=t[s];if(this._isPathInMask(i,1===e.entityPath.length))return!0;for(let t=1;t<e.entityPath.length;t++)if(i+="/"+e.entityPath[t],this._isPathInMask(i,t===e.entityPath.length-1))return!0}return!1}findNode(e){if(!this._isPathActive(e))return null;let t;return this.graph&&(t=this.graph.findByPath(e.entityPath),t||(t=this.graph.findByPath(e.entityPath.slice(1)))),t||(t=this.nodes[e.entityPath[e.entityPath.length-1]||""]),t}static createAnimTarget(e,t,s,i,n,a){const r=x_.encode(i.path,a||"entity",n);return new eg(e,t,s,r)}resolve(e){const t=x_.encode(e.entityPath,e.component,e.propertyPath);let s=this.targetCache[t];if(s)return s;const i=this.findNode(e);if(!i)return null;const n=this.handlers[e.propertyPath];return n?(s=n(i),s?(this.targetCache[t]=s,this.nodeCounts[i.path]?this.nodeCounts[i.path]++:(this.activeNodes.push(i),this.nodeCounts[i.path]=1),s):null):null}unresolve(e){if("graph"!==e.component)return;const t=this.nodes[e.entityPath[e.entityPath.length-1]||""];if(this.nodeCounts[t.path]--,0===this.nodeCounts[t.path]){const e=this.activeNodes,s=e.indexOf(t.node),i=e.length;s<i-1&&(e[s]=e[i-1]),e.pop()}}update(e){const t=this.activeNodes;for(let e=0;e<t.length;++e)t[e]._dirtifyLocal()}assignMask(e){return e!==this._mask&&(this._mask=e,!0)}}class ng{constructor(e,t,s,i,n=1){this._state=e,this._parent=t,this._name=s,Array.isArray(i)?(this._point=new ve(i[0],i[1]),this._pointLength=this._point.length()):(this._point=i,this._pointLength=i),this._speed=n,this._weightedSpeed=1,this._weight=1,this._animTrack=null}get parent(){return this._parent}get name(){return this._name}get path(){return this._parent?this._parent.path+"."+this._name:this._name}get point(){return this._point}get pointLength(){return this._pointLength}set weight(e){this._weight=e}get weight(){return this._parent?this._parent.weight*this._weight:this._weight}get normalizedWeight(){const e=this._state.totalWeight;return 0===e?0:this.weight/e}get speed(){return this._weightedSpeed*this._speed}get absoluteSpeed(){return Math.abs(this._speed)}set weightedSpeed(e){this._weightedSpeed=e}get weightedSpeed(){return this._weightedSpeed}set animTrack(e){this._animTrack=e}get animTrack(){return this._animTrack}}class ag extends ng{constructor(e,t,s,i,n,a,r,o,h){super(e,t,s,i),this._parameters=n,this._parameterValues=new Array(n.length),this._children=[],this._findParameter=h,this._syncAnimations=!1!==r,this._pointCache={};for(let t=0;t<a.length;t++){const i=a[t];i.children?this._children.push(o(i.type,this,null,s,1,i.parameter?[i.parameter]:i.parameters,i.children,o,h)):this._children.push(new ng(e,this,i.name,i.point,i.speed))}}get weight(){return this.calculateWeights(),this._parent?this._parent.weight*this._weight:this._weight}get syncAnimations(){return this._syncAnimations}getChild(e){for(let t=0;t<this._children.length;t++)if(this._children[t].name===e)return this._children[t];return null}updateParameterValues(){let e=!0;for(let t=0;t<this._parameterValues.length;t++){const s=this._findParameter(this._parameters[t]).value;this._parameterValues[t]!==s&&(this._parameterValues[t]=s,e=!1)}return e}getNodeWeightedDuration(e){return this._children[e].animTrack.duration/this._children[e].speedMultiplier*this._children[e].weight}getNodeCount(){let e=0;for(let t=0;t<this._children.length;t++){this._children[t].constructor===ag?e+=this._children[t].getNodeCount():e++}return e}}class rg extends ag{constructor(e,t,s,i,n,a,r,o,h){a.sort(((e,t)=>e.point-t.point)),super(e,t,s,i,n,a,r,o,h)}calculateWeights(){if(this.updateParameterValues())return;let e=0;this._children[0].weight=0;for(let t=0;t<this._children.length;t++){const s=this._children[t];if(t!==this._children.length-1){const e=this._children[t+1];if(s.point===e.point)s.weight=.5,e.weight=.5;else if(ne.between(this._parameterValues[0],s.point,e.point,!0)){const t=Math.abs(s.point-e.point),i=(t-Math.abs(s.point-this._parameterValues[0]))/t;s.weight=i,e.weight=1-i}else e.weight=0}this._syncAnimations&&(e+=s.animTrack.duration/s.absoluteSpeed*s.weight)}if(this._syncAnimations)for(let t=0;t<this._children.length;t++){const s=this._children[t];s.weightedSpeed=s.animTrack.duration/s.absoluteSpeed/e}}}class og extends ag{pointDistanceCache(e,t){const s=`${e}${t}`;return this._pointCache[s]||(this._pointCache[s]=this._children[t].point.clone().sub(this._children[e].point)),this._pointCache[s]}calculateWeights(){if(this.updateParameterValues())return;let e,t;og._p.set(...this._parameterValues),e=0,t=0;for(let s=0;s<this._children.length;s++){const i=this._children[s],n=i.point;og._pip.set(og._p.x,og._p.y).sub(n);let a=Number.MAX_VALUE;for(let e=0;e<this._children.length;e++){if(s===e)continue;const t=this.pointDistanceCache(s,e),i=ne.clamp(1-og._pip.dot(t)/t.lengthSq(),0,1);i<a&&(a=i)}i.weight=a,e+=a,this._syncAnimations&&(t+=i.animTrack.duration/i.absoluteSpeed*i.weight)}for(let s=0;s<this._children.length;s++){const i=this._children[s];i.weight=i._weight/e,this._syncAnimations&&(i.weightedSpeed=i.animTrack.duration/i.absoluteSpeed/t)}}}og._p=new ve,og._pip=new ve;class hg extends ag{pointCache(e,t){const s=`${e}${t}`;return this._pointCache[s]||(this._pointCache[s]=new ve((this._children[t].pointLength-this._children[e].pointLength)/((this._children[t].pointLength+this._children[e].pointLength)/2),2*ve.angleRad(this._children[e].point,this._children[t].point))),this._pointCache[s]}calculateWeights(){if(this.updateParameterValues())return;let e,t;hg._p.set(...this._parameterValues);const s=hg._p.length();e=0,t=0;for(let i=0;i<this._children.length;i++){const n=this._children[i],a=n.point,r=n.pointLength;let o=Number.MAX_VALUE;for(let e=0;e<this._children.length;e++){if(i===e)continue;const t=this.pointCache(i,e),n=this._children[e].pointLength;hg._pip.set((s-r)/((n+r)/2),2*ve.angleRad(a,hg._p));const h=ne.clamp(1-Math.abs(hg._pip.dot(t)/t.lengthSq()),0,1);h<o&&(o=h)}n.weight=o,e+=o,this._syncAnimations&&(t+=n.animTrack.duration/n.absoluteSpeed*n.weight)}for(let s=0;s<this._children.length;s++){const i=this._children[s];if(i.weight=i._weight/e,this._syncAnimations){const s=i.animTrack.duration/t*e;i.weightedSpeed=i.absoluteSpeed*s}}}}hg._p=new ve,hg._pip=new ve;class lg extends ag{calculateWeights(){if(this.updateParameterValues())return;let e=0,t=0;for(let s=0;s<this._children.length;s++)if(e+=Math.max(this._parameterValues[s],0),this._syncAnimations){const e=this._children[s];t+=e.animTrack.duration/e.absoluteSpeed*e.weight}for(let s=0;s<this._children.length;s++){const i=this._children[s],n=Math.max(this._parameterValues[s],0);e?(i.weight=n/e,this._syncAnimations&&(i.weightedSpeed=i.animTrack.duration/i.absoluteSpeed/t)):(i.weight=0,this._syncAnimations&&(i.weightedSpeed=0))}}}class cg{constructor(e,t,s,i,n){this._controller=e,this._name=t,this._animations={},this._animationList=[],this._speed=s||1,this._loop=void 0===i||i;const a=this._controller.findParameter.bind(this._controller);this._blendTree=n?this._createTree(n.type,this,null,t,1,n.parameter?[n.parameter]:n.parameters,n.children,n.syncAnimations,this._createTree,a):new ng(this,null,t,1,s)}_createTree(e,t,s,i,n,a,r,o,h,l){switch(e){case"1D":return new rg(t,s,i,n,a,r,o,h,l);case"2D_CARTESIAN":return new og(t,s,i,n,a,r,o,h,l);case"2D_DIRECTIONAL":return new hg(t,s,i,n,a,r,o,h,l);case"DIRECT":return new lg(t,s,i,n,a,r,o,h,l)}}_getNodeFromPath(e){let t=this._blendTree;for(let s=1;s<e.length;s++)t=t.getChild(e[s]);return t}addAnimation(e,t){const s=e.join("."),i=this._animationList.findIndex((function(e){return e.path===s}));if(i>=0)this._animationList[i].animTrack=t;else{const s=this._getNodeFromPath(e);s.animTrack=t,this._animationList.push(s)}}get name(){return this._name}set animations(e){this._animationList=e}get animations(){return this._animationList}set speed(e){this._speed=e}get speed(){return this._speed}set loop(e){this._loop=e}get loop(){return this._loop}get nodeCount(){return this._blendTree&&this._blendTree.constructor!==ng?this._blendTree.getNodeCount():1}get playable(){return-1!==$_.indexOf(this.name)||this.animations.length===this.nodeCount}get looping(){if(this.animations.length>0){const e=this.name+"."+this.animations[0].animTrack.name,t=this._controller.animEvaluator.findClip(e);if(t)return t.loop}return!1}get totalWeight(){let e=0;for(let t=0;t<this.animations.length;t++)e+=this.animations[t].weight;return e}get timelineDuration(){let e=0;for(let t=0;t<this.animations.length;t++){const s=this.animations[t];s.animTrack.duration>e&&(e=s.animTrack.duration)}return e}}class dg{constructor({from:e,to:t,time:s=0,priority:i=0,conditions:n=[],exitTime:a=null,transitionOffset:r=null,interruptionSource:o="NONE"}){this._from=e,this._to=t,this._time=s,this._priority=i,this._conditions=n,this._exitTime=a,this._transitionOffset=r,this._interruptionSource=o}get from(){return this._from}set to(e){this._to=e}get to(){return this._to}get time(){return this._time}get priority(){return this._priority}get conditions(){return this._conditions}get exitTime(){return this._exitTime}get transitionOffset(){return this._transitionOffset}get interruptionSource(){return this._interruptionSource}get hasExitTime(){return!!this.exitTime}}class ug{constructor(e,t,s,i,n,a,r){this._animEvaluator=e,this._states={},this._stateNames=[],this._eventHandler=a,this._consumedTriggers=r;for(let e=0;e<t.length;e++)this._states[t[e].name]=new cg(this,t[e].name,t[e].speed,t[e].loop,t[e].blendTree),this._stateNames.push(t[e].name);this._transitions=s.map((e=>new dg(b_({},e)))),this._findTransitionsFromStateCache={},this._findTransitionsBetweenStatesCache={},this._parameters=i,this._previousStateName=null,this._activeStateName="START",this._playing=!1,this._activate=n,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._transitionInterruptionSource="NONE",this._transitionPreviousStates=[],this._timeInState=0,this._timeInStateBefore=0}get animEvaluator(){return this._animEvaluator}set activeState(e){this._activeStateName=e}get activeState(){return this._findState(this._activeStateName)}get activeStateName(){return this._activeStateName}get activeStateAnimations(){return this.activeState.animations}set previousState(e){this._previousStateName=e}get previousState(){return this._findState(this._previousStateName)}get previousStateName(){return this._previousStateName}get playable(){let e=!0;for(let t=0;t<this._stateNames.length;t++)this._states[this._stateNames[t]].playable||(e=!1);return e}set playing(e){this._playing=e}get playing(){return this._playing}get activeStateProgress(){return this._getActiveStateProgressForTime(this._timeInState)}get activeStateDuration(){if("START"===this.activeStateName||"END"===this.activeStateName)return 0;let e=0;for(let t=0;t<this.activeStateAnimations.length;t++){const s=this._animEvaluator.findClip(this.activeStateAnimations[t].name);s&&(e=Math.max(e,s.track.duration))}return e}set activeStateCurrentTime(e){this._timeInStateBefore=e,this._timeInState=e;for(let t=0;t<this.activeStateAnimations.length;t++){const s=this.animEvaluator.findClip(this.activeStateAnimations[t].name);s&&(s.time=e)}}get activeStateCurrentTime(){return this._timeInState}get transitioning(){return this._isTransitioning}get transitionProgress(){return this._currTransitionTime/this._totalTransitionTime}get states(){return this._stateNames}assignMask(e){return this._animEvaluator.assignMask(e)}_findState(e){return this._states[e]}_getActiveStateProgressForTime(e){if("START"===this.activeStateName||"END"===this.activeStateName||"ANY"===this.activeStateName)return 1;const t=this._animEvaluator.findClip(this.activeStateAnimations[0].name);return t?e/t.track.duration:null}_findTransitionsFromState(e){let t=this._findTransitionsFromStateCache[e];return t||(t=this._transitions.filter((function(t){return t.from===e})),Ju(t),this._findTransitionsFromStateCache[e]=t),t}_findTransitionsBetweenStates(e,t){let s=this._findTransitionsBetweenStatesCache[e+"->"+t];return s||(s=this._transitions.filter((function(s){return s.from===e&&s.to===t})),Ju(s),this._findTransitionsBetweenStatesCache[e+"->"+t]=s),s}_transitionHasConditionsMet(e){const t=e.conditions;for(let e=0;e<t.length;e++){const s=t[e],i=this.findParameter(s.parameterName);switch(s.predicate){case"GREATER_THAN":if(!(i.value>s.value))return!1;break;case"LESS_THAN":if(!(i.value<s.value))return!1;break;case"GREATER_THAN_EQUAL_TO":if(!(i.value>=s.value))return!1;break;case"LESS_THAN_EQUAL_TO":if(!(i.value<=s.value))return!1;break;case"EQUAL_TO":if(i.value!==s.value)return!1;break;case"NOT_EQUAL_TO":if(i.value===s.value)return!1}}return!0}_findTransition(e,t){let s=[];if(e&&t)s=s.concat(this._findTransitionsBetweenStates(e,t));else if(this._isTransitioning)switch(this._transitionInterruptionSource){case"PREV_STATE":s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState("ANY"));break;case"NEXT_STATE":s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState("ANY"));break;case"PREV_STATE_NEXT_STATE":s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState("ANY"));break;case"NEXT_STATE_PREV_STATE":s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState("ANY"))}else s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState("ANY"));if(s=s.filter((e=>{if(e.to===this.activeStateName)return!1;if(e.hasExitTime){let t=this._getActiveStateProgressForTime(this._timeInStateBefore),s=this._getActiveStateProgressForTime(this._timeInState);if(e.exitTime<1&&this.activeState.loop&&(t-=Math.floor(t),s-=Math.floor(s)),!(e.exitTime>t&&e.exitTime<=s))return null}return this._transitionHasConditionsMet(e)})),s.length>0){const e=s[0];if("END"===e.to){const t=this._findTransitionsFromState("START")[0];e.to=t.to}return e}return null}updateStateFromTransition(e){let t,s,i;this.previousState=e.from?this.activeStateName:null,this.activeState=e.to;for(let t=0;t<e.conditions.length;t++){const s=e.conditions[t];"TRIGGER"===this.findParameter(s.parameterName).type&&this._consumedTriggers.add(s.parameterName)}if(this.previousState){this._isTransitioning||(this._transitionPreviousStates=[]),this._transitionPreviousStates.push({name:this._previousStateName,weight:1});const e=Math.min(0!==this._totalTransitionTime?this._currTransitionTime/this._totalTransitionTime:1,1);for(let n=0;n<this._transitionPreviousStates.length;n++){this._isTransitioning?n!==this._transitionPreviousStates.length-1?this._transitionPreviousStates[n].weight*=1-e:this._transitionPreviousStates[n].weight=e:this._transitionPreviousStates[n].weight=1,t=this._findState(this._transitionPreviousStates[n].name);for(let e=0;e<t.animations.length;e++)s=t.animations[e],i=this._animEvaluator.findClip(s.name+".previous."+n),i||(i=this._animEvaluator.findClip(s.name),i.name=s.name+".previous."+n),n!==this._transitionPreviousStates.length-1&&i.pause()}}this._isTransitioning=!0,this._totalTransitionTime=e.time,this._currTransitionTime=0,this._transitionInterruptionSource=e.interruptionSource;const n=this.activeState,a=e.transitionOffset&&e.transitionOffset>0&&e.transitionOffset<1;let r=0,o=0;if(a){const t=n.timelineDuration*e.transitionOffset;r=t,o=t}this._timeInState=r,this._timeInStateBefore=o;for(let t=0;t<n.animations.length;t++){if(i=this._animEvaluator.findClip(n.animations[t].name),i)i.reset();else{const e=Number.isFinite(n.animations[t].speed)?n.animations[t].speed:n.speed;i=new T_(n.animations[t].animTrack,this._timeInState,e,!0,n.loop,this._eventHandler),i.name=n.animations[t].name,this._animEvaluator.addClip(i)}if(e.time>0?i.blendWeight=0:i.blendWeight=n.animations[t].normalizedWeight,i.play(),a)i.time=n.timelineDuration*e.transitionOffset;else{const e=n.speed>=0?0:this.activeStateDuration;i.time=e}}}_transitionToState(e){if(!this._findState(e))return;let t=this._findTransition(this._activeStateName,e);t||(this._animEvaluator.removeClips(),t=new dg({from:null,to:e})),this.updateStateFromTransition(t)}assignAnimation(e,t,s,i){const n=e.split(".");let a=this._findState(n[0]);a||(a=new cg(this,n[0],1),this._states[n[0]]=a,this._stateNames.push(n[0])),a.addAnimation(n,t),void 0!==s&&(a.speed=s),void 0!==i&&(a.loop=i),!this._playing&&this._activate&&this.playable&&this.play()}removeNodeAnimations(e){if(-1!==$_.indexOf(e))return!1;const t=this._findState(e);return!!t&&(t.animations=[],!0)}play(e){e&&this._transitionToState(e),this._playing=!0}pause(){this._playing=!1}reset(){this._previousStateName=null,this._activeStateName="START",this._playing=!1,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._timeInState=0,this._timeInStateBefore=0,this._animEvaluator.removeClips()}rebind(){this._animEvaluator.rebind()}update(e){if(!this._playing)return;let t,s,i;this._timeInStateBefore=this._timeInState,this._timeInState+=e;const n=this._findTransition(this._activeStateName);if(n&&this.updateStateFromTransition(n),this._isTransitioning)if(this._currTransitionTime+=e,this._currTransitionTime<=this._totalTransitionTime){const e=0!==this._totalTransitionTime?this._currTransitionTime/this._totalTransitionTime:1;for(let n=0;n<this._transitionPreviousStates.length;n++){t=this._findState(this._transitionPreviousStates[n].name);const a=this._transitionPreviousStates[n].weight;for(let r=0;r<t.animations.length;r++)s=t.animations[r],i=this._animEvaluator.findClip(s.name+".previous."+n),i&&(i.blendWeight=(1-e)*s.normalizedWeight*a)}t=this.activeState;for(let i=0;i<t.animations.length;i++)s=t.animations[i],this._animEvaluator.findClip(s.name).blendWeight=e*s.normalizedWeight}else{this._isTransitioning=!1;const e=this.activeStateAnimations.length,n=this._animEvaluator.clips.length;for(let t=0;t<n-e;t++)this._animEvaluator.removeClip(0);this._transitionPreviousStates=[],t=this.activeState;for(let e=0;e<t.animations.length;e++)s=t.animations[e],i=this._animEvaluator.findClip(s.name),i&&(i.blendWeight=s.normalizedWeight)}else if(this.activeState._blendTree.constructor!==ng){t=this.activeState;for(let e=0;e<t.animations.length;e++)s=t.animations[e],i=this._animEvaluator.findClip(s.name),i&&(i.blendWeight=s.normalizedWeight,s.parent.syncAnimations&&(i.speed=s.speed))}this._animEvaluator.update(e)}findParameter(e){return this._parameters[e]}}class pg{constructor(e){if(this._layers=[],this._parameters={},Array.isArray(e.layers))this._layers=e.layers;else for(const t in e.layers){const s=e.layers[t],i={name:s.name,blendType:s.blendType,weight:s.weight,states:[],transitions:[]};for(let t=0;t<s.states.length;t++)i.states.push(e.states[s.states[t]]);for(let t=0;t<s.transitions.length;t++){const n=e.transitions[s.transitions[t]];if(n.conditions&&!Array.isArray(n.conditions)){const e=Object.keys(n.conditions),t=[];for(let s=0;s<e.length;s++){const i=n.conditions[e[s]];i.parameterName&&t.push(i)}n.conditions=t}Number.isInteger(n.from)&&(n.from=e.states[n.from].name),Number.isInteger(n.to)&&(n.to=e.states[n.to].name),i.transitions.push(n)}this._layers.push(i)}for(const t in e.parameters){const s=e.parameters[t];this._parameters[s.name]={type:s.type,value:s.value}}}get parameters(){return Object.assign({},this._parameters)}get layers(){return this._layers}}const mg="msdf",fg="bitmap";class _g{constructor(e,t){this.type=t&&t.type||"msdf",this.em=1,this.textures=e,this.intensity=0,this._data=null,this.data=t}set data(e){if(this._data=e,e&&(void 0!==this._data.intensity&&(this.intensity=this._data.intensity),this._data.info||(this._data.info={}),(!this._data.version||this._data.version<2)&&(this._data.info.maps=[{width:this._data.info.width,height:this._data.info.height}],this._data.chars)))for(const e in this._data.chars)this._data.chars[e].map=0}get data(){return this._data}}class gg extends C{constructor(e,t={}){super(),this.type="bitmap",this.app=e,this.intensity=0,this.fontWeight=t.fontWeight||"normal",this.fontSize=parseInt(t.fontSize,10),this.glyphSize=this.fontSize,this.fontName=t.fontName||"Arial",this.color=t.color||new pe(1,1,1),this.padding=t.padding||0;const s=t.width>4096?4096:t.width||512,i=t.height>4096?4096:t.height||512,n=document.createElement("canvas");n.height=i,n.width=s;const a=new fh(this.app.graphicsDevice,{name:"font",format:7,minFilter:5,magFilter:1,addressU:1,addressV:1,mipmaps:!0});a.setSource(n),this.textures=[a],this.chars="",this.data={}}createTextures(e){const t=this._normalizeCharsSet(e);if(t.length===this.chars.length){for(let e=0;e<t.length;e++)if(t[e]!==this.chars[e])return void this._renderAtlas(t)}else this._renderAtlas(t)}updateTextures(e){const t=this._normalizeCharsSet(e),s=[];for(let e=0;e<t.length;e++){const i=t[e];this.data.chars[i]||s.push(i)}s.length>0&&this._renderAtlas(this.chars.concat(s))}destroy(){for(let e=0;e<this.textures.length;e++)this.textures[e].destroy();this.chars=null,this.color=null,this.data=null,this.fontName=null,this.fontSize=null,this.glyphSize=null,this.intensity=null,this.textures=null,this.type=null,this.fontWeight=null}_getAndClearContext(e,t){const s=e.width,i=e.height,n=e.getContext("2d",{alpha:!0});return n.clearRect(0,0,s,i),n.fillStyle=t,n.fillRect(0,0,s,i),n}_colorToRgbString(e,t){let s;const i=Math.round(255*e.r),n=Math.round(255*e.g),a=Math.round(255*e.b);return s=t?`rgba(${i}, ${n}, ${a}, ${e.a})`:`rgb(${i}, ${n}, ${a})`,s}renderCharacter(e,t,s,i,n){e.fillStyle=n,e.fillText(t,s,i)}_renderAtlas(e){this.chars=e;let t=1,s=this.textures[t-1].getSource();const i=s.width,n=s.height,a=this._colorToRgbString(this.color,!1),r=this.color.a;this.color.a=1/255;const o=this._colorToRgbString(this.color,!0);this.color.a=r;const h="center",l="alphabetic";let c=this._getAndClearContext(s,o);c.font=this.fontWeight+" "+this.fontSize.toString()+"px "+this.fontName,c.textAlign=h,c.textBaseline=l,this.data=this._createJson(this.chars,this.fontName,i,n);const d=X.getSymbols(this.chars.join("")),u=this.textures.length;let p=0,m=0;const f={};for(let e=0;e<d.length;e++){const t=d[e];f[t]=this._getTextMetrics(t),p=Math.max(p,f[t].height),m=Math.max(m,f[t].descent)}this.glyphSize=Math.max(this.glyphSize,p);const _=this.glyphSize+2*this.padding,g=this.glyphSize+2*this.padding,y=this.glyphSize/2+this.padding,v=g-m-this.padding;let x=0,b=0;for(let e=0;e<d.length;e++){const r=d[e],p=X.getCodePoint(d[e]);let S=this.fontSize;c.font=this.fontWeight+" "+S.toString()+"px "+this.fontName,c.textAlign=h,c.textBaseline=l;let w=c.measureText(r).width;w>S&&(S=this.fontSize*this.fontSize/w,c.font=this.fontWeight+" "+S.toString()+"px "+this.fontName,w=this.fontSize),this.renderCharacter(c,r,x+y,b+v,a);const T=this.padding+(this.glyphSize-w)/2,M=-this.padding+f[r].descent-m,C=w;if(this._addChar(this.data,r,p,x,b,_,g,T,M,C,t-1,i,n),x+=_,x+_>i&&(x=0,b+=g,b+g>n))if(this.textures[t-1].upload(),t++,b=0,t>u){s=document.createElement("canvas"),s.height=n,s.width=i,c=this._getAndClearContext(s,o);const e=new fh(this.app.graphicsDevice,{format:7,mipmaps:!0,name:"font-atlas"});e.setSource(s),e.minFilter=5,e.magFilter=1,e.addressU=1,e.addressV=1,this.textures.push(e)}else s=this.textures[t-1].getSource(),c=this._getAndClearContext(s,o)}if(this.textures[t-1].upload(),t<u){for(let e=t;e<u;e++)this.textures[e].destroy();this.textures.splice(t)}this.fire("render")}_createJson(e,t,s,i){return{version:3,intensity:this.intensity,info:{face:t,width:s,height:i,maps:[{width:s,height:i}]},chars:{}}}_addChar(e,t,s,i,n,a,r,o,h,l,c,d,u){e.info.maps.length<c+1&&e.info.maps.push({width:d,height:u});const p=this.fontSize/32;e.chars[t]={id:s,letter:t,x:i,y:n,width:a,height:r,xadvance:l/p,xoffset:o/p,yoffset:(h+this.padding)/p,scale:p,range:1,map:c,bounds:[0,0,a/p,r/p]}}_normalizeCharsSet(e){const t=this.app.systems.element.getUnicodeConverter();t&&(e=t(e));const s={},i=X.getSymbols(e);for(let e=0;e<i.length;e++){const t=i[e];s[t]||(s[t]=t)}return Object.keys(s).sort()}_getTextMetrics(e){const t=document.createElement("span");t.id="content-span",t.innerHTML=e;const s=document.createElement("div");s.id="content-block",s.style.display="inline-block",s.style.width="1px",s.style.height="0px";const i=document.createElement("div");i.appendChild(t),i.appendChild(s),i.style.font=this.fontSize+"px "+this.fontName;document.body.appendChild(i);let n=-1,a=-1,r=-1;try{s.style["vertical-align"]="baseline",n=s.offsetTop-t.offsetTop,s.style["vertical-align"]="bottom",r=s.offsetTop-t.offsetTop,a=r-n}finally{document.body.removeChild(i)}return{ascent:n,descent:a,height:r}}}const yg="linear",vg="inverse",xg="exponential";function bg(){return!("undefined"==typeof AudioContext&&"undefined"==typeof webkitAudioContext)}class Sg{constructor(e,t,s={}){if(this.volume=void 0===s.volume?1:s.volume,this.loop=void 0!==s.loop&&s.loop,this.pitch=void 0===s.pitch?1:s.pitch,this.sound=t,this.paused=!1,this.suspended=!1,this.manager=e,this.source=null,bg()){this.startTime=0,this.startOffset=0;const t=e.context;this.gain=t.createGain()}else t.audio&&(this.source=t.audio.cloneNode(!1),this.source.pause())}getVolume(){return this.volume}getLoop(){return this.loop}setLoop(e){this.loop=e,this.source&&(this.source.loop=e)}getPitch(){return this.pitch}onManagerVolumeChange(){this.setVolume(this.getVolume())}onManagerSuspend(){this.isPlaying()&&!this.suspended&&(this.suspended=!0,this.pause())}onManagerResume(){this.suspended&&(this.suspended=!1,this.unpause())}play(){if(this.source)throw new Error("Call stop() before calling play()");this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend())}pause(){this.source&&(this.paused=!0,this.startOffset+=this.manager.context.currentTime-this.startTime,this.source.stop(0),this.source=null)}unpause(){!this.source&&this.paused?(this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.paused=!1)):console.warn("Call pause() before unpausing.")}stop(){this.source&&(this.source.stop(0),this.source=null),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)}setVolume(e){e=ne.clamp(e,0,1),this.volume=e,this.gain&&(this.gain.gain.value=e*this.manager.volume)}setPitch(e){this.pitch=e,this.source&&(this.source.playbackRate.value=e)}isPlaying(){return!this.paused&&this.source.playbackState===this.source.PLAYING_STATE}getDuration(){return this.source?this.source.buffer.duration:0}_createSource(){const e=this.manager.context;this.sound.buffer&&(this.source=e.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.gain),this.gain.connect(e.destination),this.loop||(this.source.onended=this.pause.bind(this)))}}bg()||Object.assign(Sg.prototype,{play:function(){this.source&&(this.paused=!1,this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.source.play()),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.source.pause())},unpause:function(){this.source&&(this.paused=!1,this.source.play())},stop:function(){this.source&&this.source.pause(),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)},setVolume:function(e){e=ne.clamp(e,0,1),this.volume=e,this.source&&(this.source.volume=e*this.manager.volume)},setPitch:function(e){this.pitch=e,this.source&&(this.source.playbackRate=e)},getDuration:function(){return this.source&&!isNaN(this.source.duration)?this.source.duration:0},isPlaying:function(){return!this.source.paused}});class wg extends Sg{constructor(e,t,s){super(e,t,s),this.position=new ge,this.velocity=new ge,bg()?this.panner=e.context.createPanner():(this.maxDistance=1e4,this.minDistance=1,this.rollOffFactor=1,this.distanceModel="inverse")}getPosition(){return this.position}setPosition(e){this.position.copy(e);const t=this.panner;"positionX"in t?(t.positionX.value=e.x,t.positionY.value=e.y,t.positionZ.value=e.z):t.setPosition&&t.setPosition(e.x,e.y,e.z)}getVelocity(){return this.velocity}setVelocity(e){this.velocity.copy(e)}getMaxDistance(){return this.panner.maxDistance}setMaxDistance(e){this.panner.maxDistance=e}getMinDistance(){return this.panner.refDistance}setMinDistance(e){this.panner.refDistance=e}getRollOffFactor(){return this.panner.rolloffFactor}setRollOffFactor(e){this.panner.rolloffFactor=e}getDistanceModel(){return this.panner.distanceModel}setDistanceModel(e){this.panner.distanceModel=e}_createSource(){const e=this.manager.context;this.source=e.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.panner),this.panner.connect(this.gain),this.gain.connect(e.destination),this.loop||(this.source.onended=this.pause.bind(this))}}if(!bg()){let e=new ge;const t=function(t,s,i,n,a,r){e=e.sub2(t,s);const o=e.length();if(o<i)return 1;if(o>n)return 0;let h=0;return"linear"===r?h=1-a*(o-i)/(n-i):"inverse"===r?h=i/(i+a*(o-i)):"exponential"===r&&(h=Math.pow(o/i,-a)),ne.clamp(h,0,1)};Object.assign(wg.prototype,{setPosition:function(e){if(this.position.copy(e),this.source){const e=this.manager.listener.getPosition(),s=t(e,this.position,this.minDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),i=this.getVolume();this.source.volume=i*s}},getMaxDistance:function(){return this.maxDistance},setMaxDistance:function(e){this.maxDistance=e},getMinDistance:function(){return this.minDistance},setMinDistance:function(e){this.minDistance=e},getRollOffFactor:function(){return this.rollOffFactor},setRollOffFactor:function(e){this.rollOffFactor=e},getDistanceModel:function(){return this.distanceModel},setDistanceModel:function(e){this.distanceModel=e}})}class Tg{constructor(e){this._manager=e,this.position=new ge,this.velocity=new ge,this.orientation=new Ce}getPosition(){return this.position}setPosition(e){this.position.copy(e);const t=this.listener;t&&("positionX"in t?(t.positionX.value=e.x,t.positionY.value=e.y,t.positionZ.value=e.z):t.setPosition&&t.setPosition(e.x,e.y,e.z))}getVelocity(){return this.velocity}setVelocity(e){}setOrientation(e){this.orientation.copy(e);const t=this.listener;if(t){const s=e.data;"forwardX"in t?(t.forwardX.value=-s[8],t.forwardY.value=-s[9],t.forwardZ.value=-s[10],t.upX.value=s[4],t.upY.value=s[5],t.upZ.value=s[6]):t.setOrientation&&t.setOrientation(-s[8],-s[9],-s[10],s[4],s[5],s[6])}}getOrientation(){return this.orientation}get listener(){const e=this._manager.context;return e?e.listener:null}}const Mg=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","pointerup","touchend","keydown","keyup"];class Cg extends C{constructor(e){super(),this._context=null,this._forceWebAudioApi=e.forceWebAudioApi,this._resumeContextCallback=null,this._selfSuspended=!1,this._unlocked=!1,this._unlocking=!1,!bg()&&this._forceWebAudioApi,this.listener=new Tg(this),this._volume=1}set volume(e){e=ne.clamp(e,0,1),this._volume=e,this.fire("volumechange",e)}get volume(){return this._volume}get suspended(){return!this._context||!this._unlocked||"running"!==this._context.state}get context(){if(!this._context&&(bg()||this._forceWebAudioApi)&&("undefined"!=typeof AudioContext?this._context=new AudioContext:"undefined"!=typeof webkitAudioContext&&(this._context=new webkitAudioContext),this._context)){this._unlocked="running"===this._context.state,this._unlocked||this._addContextUnlockListeners();const e=this;this._context.onstatechange=function(){e._unlocked&&!e._selfSuspended&&"running"!==e._context.state&&e._context.resume().then((()=>{}),(e=>{})).catch((e=>{}))}}return this._context}suspend(){this._selfSuspended=!0,this.suspended||this.fire("suspend")}resume(){this._selfSuspended=!1,this._context&&(this._unlocked||this._unlocking)&&("interrupted"===this._context.state?this._context.resume().then((()=>{this.fire("resume")}),(e=>{})).catch((e=>{})):this.fire("resume"))}destroy(){this._removeUserInputListeners(),this.fire("destroy"),this._context&&this._context.close&&(this._context.close(),this._context=null)}playSound(e,t={}){let s=null;return Sg&&(s=new Sg(this,e,t),s.play()),s}playSound3d(e,t,s={}){let i=null;return wg&&(i=new wg(this,e,s),i.setPosition(t),s.volume&&i.setVolume(s.volume),s.loop&&i.setLoop(s.loop),s.maxDistance&&i.setMaxDistance(s.maxDistance),s.minDistance&&i.setMinDistance(s.minDistance),s.rollOffFactor&&i.setRollOffFactor(s.rollOffFactor),s.distanceModel&&i.setDistanceModel(s.distanceModel),i.play()),i}_addContextUnlockListeners(){this._unlocking=!1,this._resumeContextCallback||(this._resumeContextCallback=()=>{if(!this._context||this._unlocked||this._unlocking)return;this._unlocking=!0,this.resume();const e=this._context.createBuffer(1,1,this._context.sampleRate),t=this._context.createBufferSource();t.buffer=e,t.connect(this._context.destination),t.start(0),t.onended=e=>{t.disconnect(0),this._unlocked=!0,this._unlocking=!1,this._removeUserInputListeners()}}),Mg.forEach((e=>{window.addEventListener(e,this._resumeContextCallback,!1)}))}_removeUserInputListeners(){this._resumeContextCallback&&(Mg.forEach((e=>{window.removeEventListener(e,this._resumeContextCallback,!1)})),this._resumeContextCallback=null)}}class Ag{constructor(e){this.audio=void 0,this.buffer=void 0,e instanceof Audio?this.audio=e:this.buffer=e}get duration(){let e=0;return this.buffer?e=this.buffer.duration:this.audio&&(e=this.audio.duration),e||0}}function Pg(e,t){return e%t||0}class Eg extends C{constructor(e,t,s){super(),this.source=null,this._manager=e,this._volume=void 0!==s.volume?ne.clamp(Number(s.volume)||0,0,1):1,this._pitch=void 0!==s.pitch?Math.max(.01,Number(s.pitch)||0):1,this._loop=!(void 0===s.loop||!s.loop),this._sound=t,this._state=2,this._suspended=!1,this._suspendEndEvent=0,this._suspendInstanceEvents=!1,this._playWhenLoaded=!0,this._startTime=Math.max(0,Number(s.startTime)||0),this._duration=Math.max(0,Number(s.duration)||0),this._startOffset=null,this._onPlayCallback=s.onPlay,this._onPauseCallback=s.onPause,this._onResumeCallback=s.onResume,this._onStopCallback=s.onStop,this._onEndCallback=s.onEnd,bg()?(this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._inputNode=null,this._connectorNode=null,this._firstNode=null,this._lastNode=null,this._waitingContextSuspension=!1,this._initializeNodes(),this._endedHandler=this._onEnded.bind(this)):(this._isReady=!1,this._loadedMetadataHandler=this._onLoadedMetadata.bind(this),this._timeUpdateHandler=this._onTimeUpdate.bind(this),this._endedHandler=this._onEnded.bind(this),this._createSource())}set currentTime(e){if(!(e<0))if(0===this._state){const t=this._suspendInstanceEvents;this._suspendInstanceEvents=!0,this.stop(),this._startOffset=e,this.play(),this._suspendInstanceEvents=t}else this._startOffset=e,this._currentTime=e}get currentTime(){return null!==this._startOffset?this._startOffset:1===this._state?this._currentTime:2!==this._state&&this.source?(this._updateCurrentTime(),this._currentTime):0}set duration(e){this._duration=Math.max(0,Number(e)||0);const t=0===this._state;this.stop(),t&&this.play()}get duration(){return this._sound?this._duration?Pg(this._duration,this._sound.duration):this._sound.duration:0}get isPaused(){return 1===this._state}get isPlaying(){return 0===this._state}get isStopped(){return 2===this._state}get isSuspended(){return this._suspended}set loop(e){this._loop=!!e,this.source&&(this.source.loop=this._loop)}get loop(){return this._loop}set pitch(e){this._currentOffset=this.currentTime,this._startedAt=this._manager.context.currentTime,this._pitch=Math.max(Number(e)||0,.01),this.source&&(this.source.playbackRate.value=this._pitch)}get pitch(){return this._pitch}set sound(e){this._sound=e,2!==this._state?this.stop():this._createSource()}get sound(){return this._sound}set startTime(e){this._startTime=Math.max(0,Number(e)||0);const t=0===this._state;this.stop(),t&&this.play()}get startTime(){return this._startTime}set volume(e){e=ne.clamp(e,0,1),this._volume=e,this.gain&&(this.gain.gain.value=e*this._manager.volume)}get volume(){return this._volume}_onPlay(){this.fire("play"),this._onPlayCallback&&this._onPlayCallback(this)}_onPause(){this.fire("pause"),this._onPauseCallback&&this._onPauseCallback(this)}_onResume(){this.fire("resume"),this._onResumeCallback&&this._onResumeCallback(this)}_onStop(){this.fire("stop"),this._onStopCallback&&this._onStopCallback(this)}_onEnded(){this._suspendEndEvent>0?this._suspendEndEvent--:(this.fire("end"),this._onEndCallback&&this._onEndCallback(this),this.stop())}_onManagerVolumeChange(){this.volume=this._volume}_onManagerSuspend(){0!==this._state||this._suspended||(this._suspended=!0,this.pause())}_onManagerResume(){this._suspended&&(this._suspended=!1,this.resume())}_initializeNodes(){this.gain=this._manager.context.createGain(),this._inputNode=this.gain,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)}play(){return 2!==this._state&&this.stop(),this._state=0,this._playWhenLoaded=!1,!this._waitingContextSuspension&&(this._manager.suspended?(this._manager.once("resume",this._playAudioImmediate,this),this._waitingContextSuspension=!0,!1):(this._playAudioImmediate(),!0))}_playAudioImmediate(){if(this._waitingContextSuspension=!1,0!==this._state)return;this.source||this._createSource();let e=Pg(this._startOffset,this.duration);e=Pg(this._startTime+e,this._sound.duration),this._startOffset=null,this._duration?this.source.start(0,e,this._duration):this.source.start(0,e),this._startedAt=this._manager.context.currentTime,this._currentTime=0,this._currentOffset=e,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._suspendInstanceEvents||this._onPlay()}pause(){return this._playWhenLoaded=!1,0===this._state&&(this._state=1,this._waitingContextSuspension||(this._updateCurrentTime(),this._suspendEndEvent++,this.source.stop(0),this.source=null,this._startOffset=null,this._suspendInstanceEvents||this._onPause()),!0)}resume(){if(1!==this._state)return!1;if(this._state=0,this._waitingContextSuspension)return!0;this.source||this._createSource();let e=this.currentTime;return null!==this._startOffset&&(e=Pg(this._startOffset,this.duration),e=Pg(this._startTime+e,this._sound.duration),this._startOffset=null),this._duration?this.source.start(0,e,this._duration):this.source.start(0,e),this._startedAt=this._manager.context.currentTime,this._currentOffset=e,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._playWhenLoaded=!1,this._suspendInstanceEvents||this._onResume(),!0}stop(){if(this._playWhenLoaded=!1,2===this._state)return!1;const e=0===this._state;return this._state=2,this._waitingContextSuspension||(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._startOffset=null,this._suspendEndEvent++,e&&this.source&&this.source.stop(0),this.source=null,this._suspendInstanceEvents||this._onStop()),!0}setExternalNodes(e,t){if(!e)return void console.error("The firstNode must be a valid Audio Node");t||(t=e);const s=this._manager.context.destination;this._firstNode!==e&&(this._firstNode?this._connectorNode.disconnect(this._firstNode):this._connectorNode.disconnect(s),this._firstNode=e,this._connectorNode.connect(e)),this._lastNode!==t&&(this._lastNode&&this._lastNode.disconnect(s),this._lastNode=t,this._lastNode.connect(s))}clearExternalNodes(){const e=this._manager.context.destination;this._firstNode&&(this._connectorNode.disconnect(this._firstNode),this._firstNode=null),this._lastNode&&(this._lastNode.disconnect(e),this._lastNode=null),this._connectorNode.connect(e)}getExternalNodes(){return[this._firstNode,this._lastNode]}_createSource(){if(!this._sound)return null;const e=this._manager.context;return this._sound.buffer&&(this.source=e.createBufferSource(),this.source.buffer=this._sound.buffer,this.source.connect(this._inputNode),this.source.onended=this._endedHandler,this.source.loopStart=Pg(this._startTime,this.source.buffer.duration),this._duration&&(this.source.loopEnd=Math.max(this.source.loopStart,Pg(this._startTime+this._duration,this.source.buffer.duration)))),this.source}_updateCurrentTime(){this._currentTime=Pg((this._manager.context.currentTime-this._startedAt)*this._pitch+this._currentOffset,this.duration)}_onManagerDestroy(){this.source&&0===this._state&&(this.source.stop(0),this.source=null)}}bg()||(Object.assign(Eg.prototype,{play:function(){return 2!==this._state&&this.stop(),!(!this.source&&!this._createSource())&&(this.volume=this._volume,this.pitch=this._pitch,this.loop=this._loop,this.source.play(),this._state=0,this._playWhenLoaded=!1,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),!0)},pause:function(){return!(!this.source||0!==this._state)&&(this._suspendEndEvent++,this.source.pause(),this._playWhenLoaded=!1,this._state=1,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),!0)},resume:function(){return!(!this.source||1!==this._state)&&(this._state=0,this._playWhenLoaded=!1,this.source.paused&&(this.source.play(),this._suspendInstanceEvents||this._onResume()),!0)},stop:function(){return!(!this.source||2===this._state)&&(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._suspendEndEvent++,this.source.pause(),this._playWhenLoaded=!1,this._state=2,this._startOffset=null,this._suspendInstanceEvents||this._onStop(),!0)},setExternalNodes:function(){},clearExternalNodes:function(){},getExternalNodes:function(){return[null,null]},_onLoadedMetadata:function(){this.source.removeEventListener("loadedmetadata",this._loadedMetadataHandler),this._isReady=!0;let e=Pg(this._startOffset,this.duration);e=Pg(this._startTime+e,this._sound.duration),this._startOffset=null,this.source.currentTime=e},_createSource:function(){return this._sound&&this._sound.audio&&(this._isReady=!1,this.source=this._sound.audio.cloneNode(!0),this.source.addEventListener("loadedmetadata",this._loadedMetadataHandler),this.source.addEventListener("timeupdate",this._timeUpdateHandler),this.source.onended=this._endedHandler),this.source},_onTimeUpdate:function(){this._duration&&this.source.currentTime>Pg(this._startTime+this._duration,this.source.duration)&&(this.loop?this.source.currentTime=Pg(this._startTime,this.source.duration):(this.source.removeEventListener("timeupdate",this._timeUpdateHandler),this.source.pause(),this._onEnded()))},_onManagerDestroy:function(){this.source&&this.source.pause()}}),Object.defineProperty(Eg.prototype,"volume",{get:function(){return this._volume},set:function(e){e=ne.clamp(e,0,1),this._volume=e,this.source&&(this.source.volume=e*this._manager.volume)}}),Object.defineProperty(Eg.prototype,"pitch",{get:function(){return this._pitch},set:function(e){this._pitch=Math.max(Number(e)||0,.01),this.source&&(this.source.playbackRate=this._pitch)}}),Object.defineProperty(Eg.prototype,"sound",{get:function(){return this._sound},set:function(e){this.stop(),this._sound=e}}),Object.defineProperty(Eg.prototype,"currentTime",{get:function(){return null!==this._startOffset?this._startOffset:2!==this._state&&this.source?this.source.currentTime-this._startTime:0},set:function(e){e<0||(this._startOffset=e,this.source&&this._isReady&&(this.source.currentTime=Pg(this._startTime+Pg(e,this.duration),this._sound.duration),this._startOffset=null))}}));class Rg extends Eg{constructor(e,t,s={}){super(e,t,s),this._position=new ge,this._velocity=new ge,s.position&&(this.position=s.position),this.maxDistance=void 0!==s.maxDistance?Number(s.maxDistance):1e4,this.refDistance=void 0!==s.refDistance?Number(s.refDistance):1,this.rollOffFactor=void 0!==s.rollOffFactor?Number(s.rollOffFactor):1,this.distanceModel=void 0!==s.distanceModel?s.distanceModel:"linear"}_initializeNodes(){this.gain=this._manager.context.createGain(),this.panner=this._manager.context.createPanner(),this.panner.connect(this.gain),this._inputNode=this.panner,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)}set position(e){this._position.copy(e);const t=this.panner;"positionX"in t?(t.positionX.value=e.x,t.positionY.value=e.y,t.positionZ.value=e.z):t.setPosition&&t.setPosition(e.x,e.y,e.z)}get position(){return this._position}set velocity(e){this._velocity.copy(e)}get velocity(){return this._velocity}set maxDistance(e){this.panner.maxDistance=e}get maxDistance(){return this.panner.maxDistance}set refDistance(e){this.panner.refDistance=e}get refDistance(){return this.panner.refDistance}set rollOffFactor(e){this.panner.rolloffFactor=e}get rollOffFactor(){return this.panner.rolloffFactor}set distanceModel(e){this.panner.distanceModel=e}get distanceModel(){return this.panner.distanceModel}}if(!bg()){let e=new ge;const t=function(t,s,i,n,a,r){e=e.sub2(t,s);const o=e.length();if(o<i)return 1;if(o>n)return 0;let h=0;return"linear"===r?h=1-a*(o-i)/(n-i):"inverse"===r?h=i/(i+a*(o-i)):"exponential"===r&&(h=Math.pow(o/i,-a)),ne.clamp(h,0,1)};Object.defineProperty(Rg.prototype,"position",{get:function(){return this._position},set:function(e){if(this._position.copy(e),this.source){const e=this._manager.listener.getPosition(),s=t(e,this._position,this.refDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),i=this.volume;this.source.volume=i*s*this._manager.volume}}}),Object.defineProperty(Rg.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(e){this._maxDistance=e}}),Object.defineProperty(Rg.prototype,"refDistance",{get:function(){return this._refDistance},set:function(e){this._refDistance=e}}),Object.defineProperty(Rg.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(e){this._rollOffFactor=e}}),Object.defineProperty(Rg.prototype,"distanceModel",{get:function(){return this._distanceModel},set:function(e){this._distanceModel=e}})}function Lg(){const e=0,t=1,s=2,i=3,n=8,a=9,r=10,o=11,h=12,l=13,c=14,d=16,u={astc:r,dxt:s,etc1:e,etc2:e,pvr:n,atc:o,none:c},p={astc:r,dxt:i,etc1:d,etc2:t,pvr:a,atc:h,none:d},m=21,f=22,_=23,g=8,y=10,v=26,x=27,b=28,S=29,w=30,T=7,M=3,C=5,A=(u,p)=>{switch(u){case e:return p.formats.etc1?m:f;case t:return _;case s:return g;case i:return y;case n:return v;case a:return x;case r:return b;case o:return S;case h:return w;case l:return T;case c:return M;case d:return C}},P=e=>{const t=function(e,t){const s=e*(2/255)-1,i=t*(2/255)-1,n=Math.sqrt(1-Math.min(1,s*s+i*i));return Math.max(0,Math.min(255,Math.floor(.5*(n+1)*255)))};for(let s=0;s<e.length;s+=4){const i=e[s+3],n=e[s+1];e[s+0]=i,e[s+2]=t(i,n),e[s+3]=255}return e},E=e=>{const t=new Uint16Array(e.length/4);for(let s=0;s<e.length;s+=4){const i=e[s+0],n=e[s+1],a=e[s+2];t[s/4]=(248&i)<<8|(252&n)<<3|a>>3}return t},R=()=>"undefined"!=typeof performance?performance.now():0;let L,I,D;const O=(e,t,s)=>{if(s){if(e.formats.astc)return"astc"}else if(t){if(e.formats.etc2)return"etc2"}else if(e.formats.etc1||e.formats.etc2)return"etc1";return(t=>{for(let s=0;s<t.length;++s){const i=t[s];if(e.formats[i])return i}return"none"})(t?D:I)},F=(l,c,d,u)=>{switch(d){case e:case t:return!0;case s:case i:return 0==(3&l)&&0==(3&c);case n:case a:return((e,t)=>0==(e&e-1)&&0==(t&t-1))(l,c)&&(l===c||u);case r:case o:case h:return!0}},k=(e,t,s)=>s.isKTX2?((e,t,s)=>{if(!L.KTX2File)throw new Error("Basis transcoder module does not include support for KTX2.");const i=R(),n=new L.KTX2File(new Uint8Array(t)),a=n.getWidth(),r=n.getHeight(),o=n.getLevels(),h=!!n.getHasAlpha(),m=n.isUASTC&&n.isUASTC();if(!a||!r||!o)throw n.close(),n.delete(),new Error(`Invalid image dimensions url=${e} width=${a} height=${r} levels=${o}`);const f=O(s.deviceDetails,h,m),_=!!s.isGGGR&&"pvr"===f;let g,y;if(_?g=l:(g=h?p[f]:u[f],F(a,r,g,s.deviceDetails.webgl2)||(g=h?l:c)),!n.startTranscoding())throw n.close(),n.delete(),new Error("Failed to start transcoding url="+e);const v=[];for(let t=0;t<o;++t){const s=n.getImageTranscodedSizeInBytes(t,0,0,g),i=new Uint8Array(s);if(!n.transcodeImage(i,t,0,0,g,0,-1,-1))throw n.close(),n.delete(),new Error("Failed to transcode image url="+e);const a=g===c||g===d;v.push(a?new Uint16Array(i.buffer):i)}if(n.close(),n.delete(),_)for(g=c,y=0;y<v.length;++y)v[y]=E(P(v[y]));return{format:A(g,s.deviceDetails),width:a,height:r,levels:v,cubemap:!1,transcodeTime:R()-i,url:e,unswizzledGGGR:_}})(e,t,s):((e,t,s)=>{const i=R(),n=new L.BasisFile(new Uint8Array(t)),a=n.getImageWidth(0,0),r=n.getImageHeight(0,0),o=n.getNumImages(),h=n.getNumLevels(0),m=!!n.getHasAlpha(),f=n.isUASTC&&n.isUASTC();if(!(a&&r&&o&&h))throw n.close(),n.delete(),new Error(`Invalid image dimensions url=${e} width=${a} height=${r} images=${o} levels=${h}`);const _=O(s.deviceDetails,m,f),g=!!s.isGGGR&&"pvr"===_;let y,v;if(g?y=l:(y=m?p[_]:u[_],F(a,r,y,s.deviceDetails.webgl2)||(y=m?l:c)),!n.startTranscoding())throw n.close(),n.delete(),new Error("Failed to start transcoding url="+e);const x=[];for(let t=0;t<h;++t){const s=n.getImageTranscodedSizeInBytes(0,t,y),i=new Uint8Array(s);if(!n.transcodeImage(i,0,t,y,0,0))throw n.close(),n.delete(),new Error("Failed to transcode image url="+e);const a=y===c||y===d;x.push(a?new Uint16Array(i.buffer):i)}if(n.close(),n.delete(),g)for(y=c,v=0;v<x.length;++v)x[v]=E(P(x[v]));return{format:A(y,s.deviceDetails),width:a,height:r,levels:x,cubemap:!1,transcodeTime:R()-i,url:e,unswizzledGGGR:g}})(e,t,s),B=(e,t,s)=>{try{const i=k(e,t,s);i.levels=i.levels.map((e=>e.buffer)),self.postMessage({url:e,data:i},i.levels)}catch(t){self.postMessage({url:e,err:t},null)}},z=[];self.onmessage=e=>{const t=e.data;switch(t.type){case"init":((e,t)=>{self.importScripts(e.basisUrl),self.BASIS(e.module?{instantiateWasm:(t,s)=>(WebAssembly.instantiate(e.module,t).then((e=>{s(e)})).catch((e=>{console.error("instantiate failed + "+e)})),{})}:null).then((s=>{s.initializeBasis(),L=s,I=e.rgbPriority,D=e.rgbaPriority,t(null)}))})(t.config,(()=>{for(let e=0;e<z.length;++e)B(z[e].url,z[e].data,z[e].options);z.length=0}));break;case"transcode":L?B(t.url,t.data,t.options):z.push(t)}}}const Ig=e=>({astc:!!e.extCompressedTextureASTC,atc:!!e.extCompressedTextureATC,dxt:!!e.extCompressedTextureS3TC,etc1:!!e.extCompressedTextureETC1,etc2:!!e.extCompressedTextureETC,pvr:!!e.extCompressedTexturePVRTC});class Dg{constructor(e,t,s){this.queue=e,this.worker=new Worker(t.workerUrl),this.worker.addEventListener("message",(e=>{const t=e.data;this.queue.handleResponse(t.url,t.err,t.data),this.eager||this.queue.enqueueClient(this)})),this.worker.postMessage({type:"init",config:t}),this.eager=s}run(e){const t=[];e.data instanceof ArrayBuffer&&t.push(e.data),this.worker.postMessage({type:"transcode",url:e.url,format:e.format,data:e.data,options:e.options},t),this.eager&&this.queue.enqueueClient(this)}}const Og=["etc1","etc2","astc","dxt","pvr","atc"],Fg=["astc","dxt","etc2","pvr","atc"],kg=new class{constructor(){this.callbacks={},this.queue=[],this.clients=[]}enqueueJob(e,t,s,i){if(this.callbacks.hasOwnProperty(e))this.callbacks[e].push(s);else{this.callbacks[e]=[s];const n={url:e,data:t,options:i};this.clients.length>0?this.clients.shift().run(n):this.queue.push(n)}}enqueueClient(e){this.queue.length>0?e.run(this.queue.shift()):this.clients.push(e)}handleResponse(e,t,s){const i=this.callbacks[e];if(t)for(let e=0;e<i.length;++e)i[e](t);else{3===s.format||5===s.format?s.levels=s.levels.map((function(e){return new Uint16Array(e)})):s.levels=s.levels.map((function(e){return new Uint8Array(e)}));for(let e=0;e<i.length;++e)i[e](null,s)}delete this.callbacks[e]}};let Bg=null,zg=!1;function Ug(e){if(!zg){if(e){if(e.lazyInit)return void(Bg=e)}else e=Bg||{};if(!e.glueUrl||!e.wasmUrl||!e.fallbackUrl){const t=((window.config?window.config.wasmModules:window.PRELOAD_MODULES)||[]).find((function(e){return"BASIS"===e.moduleName}));if(t){const s=window.ASSET_PREFIX||"";e.glueUrl||(e.glueUrl=s+t.glueUrl),e.wasmUrl||(e.wasmUrl=s+t.wasmUrl),e.fallbackUrl||(e.fallbackUrl=s+t.fallbackUrl)}}if(e.glueUrl||e.wasmUrl||e.fallbackUrl){zg=!0;const t=Math.max(1,Math.min(16,e.numWorkers||1)),s=1===e.numWorkers||!e.hasOwnProperty("eagerWorkers")||e.eagerWorkers;e.rgbPriority=e.rgbPriority||Og,e.rgbaPriority=e.rgbaPriority||Fg,e.maxRetries=e.hasOwnProperty("maxRetries")?e.maxRetries:5,((e,t)=>{const s=()=>{const e="("+Lg.toString()+")()\n\n";return new Blob([e],{type:"application/javascript"})},i=(i,n)=>{t(null,{workerUrl:URL.createObjectURL(s()),basisUrl:URL.createObjectURL(i),module:n,rgbPriority:e.rgbPriority,rgbaPriority:e.rgbaPriority})},n={responseType:"blob",retry:e.maxRetries>0,maxRetries:e.maxRetries};if(e.glueUrl&&e.wasmUrl&&(()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){}return!1})()){let s=null,a=null;re.get(e.glueUrl,n,((e,n)=>{e?t(e):a?i(n,a):s=n}));const r=fetch(e.wasmUrl),o=()=>{r.then((e=>e.arrayBuffer())).then((e=>WebAssembly.compile(e))).then((e=>{s?i(s,e):a=e})).catch((e=>{t(e,null)}))};WebAssembly.compileStreaming?WebAssembly.compileStreaming(r).then((e=>{s?i(s,e):a=e})).catch((e=>{o()})):o()}else re.get(e.fallbackUrl,n,((e,s)=>{e?t(e,null):i(s,null)}))})(e,((e,i)=>{if(e)console.error(`failed to initialize basis worker: ${e}`);else for(let e=0;e<t;++e)kg.enqueueClient(new Dg(kg,i,s))}))}}}let Vg=null;function Ng(e,t,s,i,n){return Ug(),Vg||(Vg={webgl2:e.webgl2,formats:Ig(e)}),kg.enqueueJob(t,s,i,{deviceDetails:Vg,isGGGR:!(null==n||!n.isGGGR),isKTX2:!(null==n||!n.isKTX2)}),zg}class Gg{constructor(e){this.handlerType="animclip",this.maxRetries=0}load(e,t){"string"==typeof e&&(e={load:e,original:e});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(s.responseType=ae.ResponseType.JSON),re.get(e.load,s,(function(s,i){s?t(`Error loading animation clip resource: ${e.original} [${s}]`):t(null,i)}))}open(e,t){const s=t.name,i=t.duration,n=t.inputs.map((function(e){return new C_(1,e)})),a=t.outputs.map((function(e){return new C_(e.components,e.data)})),r=t.curves.map((function(e){return new M_([e.path],e.inputIndex,e.outputIndex,e.interpolation)}));return new sg(s,i,n,a,r)}patch(e,t){}}class Wg{constructor(e){this.handlerType="animstategraph",this.maxRetries=0}load(e,t){"string"==typeof e&&(e={load:e,original:e});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(s.responseType=ae.ResponseType.JSON),re.get(e.load,s,(function(s,i){s?t(`Error loading animation state graph resource: ${e.original} [${s}]`):t(null,i)}))}open(e,t){return new pg(t)}patch(e,t){}}class Hg extends C{constructor(){super(),this._meshes=null}set meshes(e){this.decRefMeshes(),this._meshes=e,this.incRefMeshes(),this.fire("set:meshes",e)}get meshes(){return this._meshes}destroy(){this.meshes=null}decRefMeshes(){if(this._meshes){const e=this._meshes.length;for(let t=0;t<e;t++){const e=this._meshes[t];e&&(e.decRefCount(),e.refCount<1&&(e.destroy(),this._meshes[t]=null))}}}incRefMeshes(){if(this._meshes){const e=this._meshes.length;for(let t=0;t<e;t++)this._meshes[t]&&this._meshes[t].incRefCount()}}}class Xg extends kc{constructor(e,t){super(),this.skin=e,this.skinInstance=t}}class qg{static createCachedSkinInstance(e,t,s){let i=qg.getCachedSkinInstance(e,t);return i||(i=new hd(e),i.resolve(t,s),qg.addCachedSkinInstance(e,t,i)),i}static getCachedSkinInstance(e,t){let s=null;const i=qg._skinInstanceCache.get(t);if(i){const t=i.find((t=>t.skin===e));t&&(t.incRefCount(),s=t.skinInstance)}return s}static addCachedSkinInstance(e,t,s){let i=qg._skinInstanceCache.get(t);i||(i=[],qg._skinInstanceCache.set(t,i));let n=i.find((t=>t.skin===e));n||(n=new Xg(e,s),i.push(n)),n.incRefCount()}static removeCachedSkinInstance(e){if(e){const t=e.rootBone;if(t){const s=qg._skinInstanceCache.get(t);if(s){const i=s.findIndex((t=>t.skinInstance===e));if(i>=0){const n=s[i];n.decRefCount(),0===n.refCount&&(s.splice(i,1),s.length||qg._skinInstanceCache.delete(t),e&&(e.destroy(),n.skinInstance=null))}}}}}}qg._skinInstanceCache=new Map;class jg{constructor(e,t,s,i){const n=function(e,i,n){const a=jg.createAsset(t.name,e,i,n);return s.add(a),a},a=[];for(let t=0;t<e.renders.length;++t)a.push(n("render",e.renders[t],t));const r=[];for(let t=0;t<e.materials.length;++t)r.push(n("material",e.materials[t],t));const o=[];for(let t=0;t<e.animations.length;++t)o.push(n("animation",e.animations[t],t));this.data=e,this._model=null,this._assetName=t.name,this._assets=s,this._defaultMaterial=i,this.renders=a,this.materials=r,this.textures=e.textures,this.animations=o}get model(){if(!this._model){const e=jg.createModel(this.data,this._defaultMaterial),t=jg.createAsset(this._assetName,"model",e,0);this._assets.add(t),this._model=t}return this._model}static createAsset(e,t,s,i){const n=new um(e+"/"+t+"/"+i,t,{url:""});return n.resource=s,n.loaded=!0,n}instantiateModelEntity(e){const t=new $m;return t.addComponent("model",Object.assign({type:"asset",asset:this.model},e)),t}instantiateRenderEntity(e){const t=this._defaultMaterial,s=[],i=function(e,i,n,a,r,o,h){const l=r[n.id],c=void 0===l?t:a[l],d=new xd(n,c);return n.morph&&(d.morphInstance=new af(n.morph)),h.hasOwnProperty("skin")&&s.push({meshInstance:d,rootBone:e,entity:i}),d},n=(t,s,a)=>{const r=new $m;s._cloneInternal(r),t||(t=r);let o=null,h=null;for(let e=0;e<a.nodes.length;e++){if(a.nodes[e]===s){const s=a.gltf.nodes[e];if(s.hasOwnProperty("mesh")){const e=a.renders[s.mesh].meshes;h=this.renders[s.mesh];for(var l=0;l<e.length;l++){const n=e[l];if(n){const e=i(t,r,n,a.materials,a.meshDefaultMaterials,a.skins,s);o||(o=[]),o.push(e)}}}if(a.lights){const e=a.lights.get(s);e&&r.addChild(e.clone())}if(a.cameras){const e=a.cameras.get(s);e&&e.camera.system.cloneComponent(e,r)}}}o&&(r.addComponent("render",Object.assign({type:"asset",meshInstances:o,rootBone:t},e)),r.render.assignAsset(h));const c=s.children;for(let e=0;e<c.length;e++){const s=n(t,c[e],a);r.addChild(s)}return r},a=[];for(const e of this.data.scenes)a.push(n(null,e,this.data));return s.forEach((e=>{e.meshInstance.skinInstance=qg.createCachedSkinInstance(e.meshInstance.mesh.skin,e.rootBone,e.entity)})),jg.createSceneHierarchy(a,"Entity")}getMaterialVariants(){return this.data.variants?Object.keys(this.data.variants):[]}applyMaterialVariant(e,t){const s=t?this.data.variants[t]:null;if(void 0===s)return;const i=e.findComponents("render");for(let e=0;e<i.length;e++){const t=i[e];this._applyMaterialVariant(s,t.meshInstances)}}applyMaterialVariantInstances(e,t){const s=t?this.data.variants[t]:null;void 0!==s&&this._applyMaterialVariant(s,e)}_applyMaterialVariant(e,t){t.forEach((t=>{if(null===e)t.material=this._defaultMaterial;else{const s=this.data.meshVariants[t.mesh.id];s&&(t.material=this.data.materials[s[e]])}}))}static createSceneHierarchy(e,t){let s=null;if(1===e.length)s=e[0];else{s=new t("SceneGroup");for(const t of e)s.addChild(t)}return s}static createModel(e,t){const s=function(s,i,n,a,r,o,h){const l=e.meshDefaultMaterials[i.id],c=void 0===l?t:r[l],d=new xd(i,c,o);if(i.morph){const e=new af(i.morph);d.morphInstance=e,s.morphInstances.push(e)}if(h.hasOwnProperty("skin")){const e=h.skin,t=n[e];i.skin=t;const r=a[e];d.skinInstance=r,s.skinInstances.push(r)}s.meshInstances.push(d)},i=new rf,n=[];for(const t of e.skins){const e=new hd(t);e.bones=t.bones,n.push(e)}i.graph=jg.createSceneHierarchy(e.scenes,"GraphNode");for(let t=0;t<e.nodes.length;t++){const r=e.nodes[t];if(r.root===i.graph){const o=e.gltf.nodes[t];if(o.hasOwnProperty("mesh")){const t=e.renders[o.mesh].meshes;for(var a=0;a<t.length;a++){const h=t[a];h&&s(i,h,e.skins,n,e.materials,r,o)}}}}return i}destroy(){const e=this._assets,t=function(t){e.remove(t),t.unload()},s=function(e){e.forEach((function(e){t(e)}))};this.animations&&(s(this.animations),this.animations=null),this.textures&&(s(this.textures),this.textures=null),this.materials&&(s(this.materials),this.materials=null),this.renders&&(s(this.renders),this.renders=null),this._model&&(t(this._model),this._model=null),this.data=null,this.assets=null}}let Yg=null;const $g=()=>"undefined"!=typeof window&&window.DracoDecoderModule;class Kg{constructor(e){this.gltf=e,this.nodes=null,this.scenes=null,this.animations=null,this.textures=null,this.materials=null,this.variants=null,this.meshVariants=null,this.meshDefaultMaterials=null,this.renders=null,this.skins=null,this.lights=null,this.cameras=null}destroy(){this.renders&&this.renders.forEach((e=>{e.meshes=null}))}}const Zg=function(e){return/^data:.*,.*$/i.test(e)},Qg=function(e){switch(e){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":default:return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}},Jg=function(e){switch(e){case 5120:default:return 0;case 5121:return 1;case 5122:return 2;case 5123:return 3;case 5124:return 4;case 5125:return 5;case 5126:return 6}},ey=function(e){switch(e){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:return 0}},ty={POSITION:"POSITION",NORMAL:"NORMAL",TANGENT:"TANGENT",COLOR_0:"COLOR",JOINTS_0:"BLENDINDICES",WEIGHTS_0:"BLENDWEIGHT",TEXCOORD_0:"TEXCOORD0",TEXCOORD_1:"TEXCOORD1",TEXCOORD_2:"TEXCOORD2",TEXCOORD_3:"TEXCOORD3",TEXCOORD_4:"TEXCOORD4",TEXCOORD_5:"TEXCOORD5",TEXCOORD_6:"TEXCOORD6",TEXCOORD_7:"TEXCOORD7"},sy=function(e,t,s){const i=(e=>{switch(e){case 0:return e=>Math.max(e/127,-1);case 1:return e=>e/255;case 2:return e=>Math.max(e/32767,-1);case 3:return e=>e/65535;default:return e=>e}})(s),n=t.length;for(let s=0;s<n;++s)e[s]=i(t[s]);return e},iy=function e(t,s,i=!1){const n=Qg(t.type),a=function(e){switch(e){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:return null}}(t.componentType);if(!a)return null;const r=s[t.bufferView];let o;if(t.sparse){const i=t.sparse,r={count:i.count,type:"SCALAR"},h=e(Object.assign(r,i.indices),s,!0),l={count:i.count,type:t.scalar,componentType:t.componentType},c=e(Object.assign(l,i.values),s,!0);if(t.hasOwnProperty("bufferView")){o=e({bufferView:t.bufferView,byteOffset:t.byteOffset,componentType:t.componentType,count:t.count,type:t.type},s,!0).slice()}else o=new a(t.count*n);for(let e=0;e<i.count;++e){const t=h[e];for(let s=0;s<n;++s)o[t*n+s]=c[e*n+s]}}else if(i&&r.hasOwnProperty("byteStride")){const e=n*a.BYTES_PER_ELEMENT,s=new ArrayBuffer(t.count*e),i=new Uint8Array(s);let h=0;for(let s=0;s<t.count;++s){let n=(t.byteOffset||0)+s*r.byteStride;for(let t=0;t<e;++t)i[h++]=r[n++]}o=new a(s)}else o=new a(r.buffer,r.byteOffset+(t.byteOffset||0),t.count*n);return o},ny=function(e,t){const s=iy(e,t,!0);if(s instanceof Float32Array||!e.normalized)return s;const i=new Float32Array(s.length);return sy(i,s,Jg(e.componentType)),i},ay=function(e){let t=e.min,s=e.max;if(!t||!s)return null;if(e.normalized){const i=Jg(e.componentType);t=sy([],t,i),s=sy([],s,i)}return new De(new ge(.5*(s[0]+t[0]),.5*(s[1]+t[1]),.5*(s[2]+t[2])),new ge(.5*(s[0]-t[0]),.5*(s[1]-t[1]),.5*(s[2]-t[2])))},ry=function(e,t){const s=e.POSITION;if(!s||3!==s.components)return;let i;if(s.size!==s.stride){const e=s.stride/ao[s.type],t=new no[s.type](s.buffer,s.offset,s.count*e);i=new no[s.type](3*s.count);for(let n=0;n<s.count;++n)i[3*n+0]=t[n*e+0],i[3*n+1]=t[n*e+1],i[3*n+2]=t[n*e+2]}else i=new no[s.type](s.buffer,s.offset,3*s.count);const n=s.count;t||(t=function(e){const t=new Uint16Array(e);for(let s=0;s<e;s++)t[s]=s;return t}(n));const a=Xc(i,t),r=new Float32Array(a.length);r.set(a),e.NORMAL={buffer:r.buffer,size:12,offset:0,stride:12,count:n,components:3,type:6}},oy=function(e){const t=new um(e.name+"_clone",e.type,e.file,e.data,e.options);return t.loaded=!0,t.resource=function(e){const t=new fh(e.device,e);return t._levels=function(e){const t=[];for(let s=0;s<e._levels.length;++s){let i=[];if(e.cubemap)for(let t=0;t<6;++t)i.push(e._levels[s][t]);else i=e._levels[s];t.push(i)}return t}(e),t}(e.resource),e.registry.add(t),t},hy=function(e,t,s){const i=t.POSITION;if(!i)return null;const n=i.count,a=[];for(const e in t)t.hasOwnProperty(e)&&a.push({semantic:e,components:t[e].components,type:t[e].type,normalize:!!t[e].normalize});const r=["POSITION","NORMAL","TANGENT","COLOR","BLENDINDICES","BLENDWEIGHT","TEXCOORD0","TEXCOORD1"];let o,h,l,c,d,u;a.sort((function(e,t){const s=r.indexOf(e.semantic),i=r.indexOf(t.semantic);return s<i?-1:i<s?1:0}));const p=new go(e,a);let m=!0;for(o=0;o<p.elements.length;++o)if(d=p.elements[o],c=t[d.name],u=c.offset-i.offset,c.buffer!==i.buffer||c.stride!==d.stride||c.size!==d.size||u!==d.offset){m=!1;break}const f=new fo(e,p,n,0),_=f.lock(),g=new Uint32Array(_);let y;if(m)y=new Uint32Array(i.buffer,i.offset,n*f.format.size/4),g.set(y);else{let e,s;for(o=0;o<f.format.elements.length;++o){d=f.format.elements[o],e=d.stride/4,c=t[d.name],s=c.stride/4,y=new Uint32Array(c.buffer,c.offset,(c.count-1)*s+(c.size+3)/4);let i=0,a=d.offset/4;const r=Math.floor((c.size+3)/4);for(h=0;h<n;++h){for(l=0;l<r;++l)g[a+l]=y[i+l];i+=s,a+=e}}}return s&&function(e){let t,s;const i=[],n=[],a=[];for(t=0;t<e.format.elements.length;++t){const s=e.format.elements[t];if("TEXCOORD0"===s.name||"TEXCOORD1"===s.name)switch(s.dataType){case 6:i.push({offset:s.offset/4+1,stride:s.stride/4});break;case 3:n.push({offset:s.offset/2+1,stride:s.stride/2});break;case 1:a.push({offset:s.offset+1,stride:s.stride})}}const r=function(i,n,a){const r=new n(e.storage);for(t=0;t<i.length;++t){let n=i[t].offset;const o=i[t].stride;for(s=0;s<e.numVertices;++s)r[n]=a-r[n],n+=o}};i.length>0&&r(i,Float32Array,1),n.length>0&&r(n,Uint16Array,65535),a.length>0&&r(a,Uint8Array,255)}(f),f.unlock(),f},ly=new Ce,cy=new ge,dy=function(e,t,s,i,n,a,r,o,h){const l=[];return t.primitives.forEach((function(c){let d,u,p,m=null,f=!0;if(c.hasOwnProperty("extensions")){const t=c.extensions;if(t.hasOwnProperty("KHR_draco_mesh_compression")){const s=Yg||$g();if(s){const r=t.KHR_draco_mesh_compression;if(r.hasOwnProperty("attributes")){const t=i[r.bufferView],o=new s.DecoderBuffer;o.Init(t,t.length);const h=new s.Decoder,l=h.GetEncodedGeometryType(o);let c,_;switch(l){case s.POINT_CLOUD:d=0,c=new s.PointCloud,_=h.DecodeBufferToPointCloud(o,c);break;case s.TRIANGULAR_MESH:d=4,c=new s.Mesh,_=h.DecodeBufferToMesh(o,c);case s.INVALID_GEOMETRY_TYPE:}if(!_||!_.ok()||0===c.ptr)return void n("Failed to decode draco compressed asset: "+(_?_.error_msg():"Mesh asset - invalid draco compressed geometry type: "+l));const g=c.num_faces();if(l===s.TRIANGULAR_MESH){const e=c.num_points()>65535;p=3*g;const t=p*(e?4:2),i=s._malloc(t);e?(h.GetTrianglesUInt32Array(c,t,i),m=new Uint32Array(s.HEAPU32.buffer,i,p).slice()):(h.GetTrianglesUInt16Array(c,t,i),m=new Uint16Array(s.HEAPU16.buffer,i,p).slice()),s._free(i)}u=function(e,t,s,i,n,a,r){const o=t.num_points(),h=function(e,s){const a=i.GetAttributeByUniqueId(t,e),r=o*a.num_components();let h,l,c,d;switch(a.data_type()){case n.DT_UINT8:d=1,c=1,h=n._malloc(r*c),i.GetAttributeDataArrayForAllPoints(t,a,n.DT_UINT8,r*c,h),l=new Uint8Array(n.HEAPU8.buffer,h,r).slice();break;case n.DT_UINT16:d=3,c=2,h=n._malloc(r*c),i.GetAttributeDataArrayForAllPoints(t,a,n.DT_UINT16,r*c,h),l=new Uint16Array(n.HEAPU16.buffer,h,r).slice();break;case n.DT_FLOAT32:default:d=6,c=4,h=n._malloc(r*c),i.GetAttributeDataArrayForAllPoints(t,a,n.DT_FLOAT32,r*c,h),l=new Float32Array(n.HEAPF32.buffer,h,r).slice()}return n._free(h),{values:l,numComponents:a.num_components(),componentSizeInBytes:c,storageType:d,normalized:"COLOR"===s&&1===d||a.normalized()}},l={},c=s.attributes;for(const e in c)if(c.hasOwnProperty(e)&&ty.hasOwnProperty(e)){const t=ty[e],s=h(c[e],t),i=s.numComponents*s.componentSizeInBytes;l[t]={values:s.values,buffer:s.values.buffer,size:i,offset:0,stride:i,count:o,components:s.numComponents,type:s.storageType,normalize:s.normalized}}return l.hasOwnProperty("NORMAL")||ry(l,a),hy(e,l,r)}(e,c,r,h,s,m,a),s.destroy(c),s.destroy(h),s.destroy(o),f=!1}}}}u||(m=c.hasOwnProperty("indices")?iy(s[c.indices],i,!0):null,u=function(e,t,s,i,n,a,r){const o={},h=[];for(const e in t)t.hasOwnProperty(e)&&ty.hasOwnProperty(e)&&(o[e]=t[e],h.push(e+":"+t[e]));h.sort();const l=h.join();let c=r[l];if(!c){const h={};for(const e in o){const s=i[t[e]],a=iy(s,n),r=n[s.bufferView],o=ty[e],l=Qg(s.type)*ey(s.componentType),c=r.hasOwnProperty("byteStride")?r.byteStride:l;h[o]={buffer:a.buffer,size:l,offset:a.byteOffset,stride:c,count:s.count,components:Qg(s.type),type:Jg(s.componentType),normalize:s.normalized}}h.hasOwnProperty("NORMAL")||ry(h,s),c=hy(e,h,a),r[l]=c}return c}(e,c.attributes,m,s,i,a,r),d=function(e){if(!e.hasOwnProperty("mode"))return 4;switch(e.mode){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 3;case 4:default:return 4;case 5:return 5;case 6:return 6}}(c));let _=null;if(u){if(_=new Wc(e),_.vertexBuffer=u,_.primitive[0].type=d,_.primitive[0].base=0,_.primitive[0].indexed=null!==m,null!==m){let t;t=m instanceof Uint8Array?0:m instanceof Uint16Array?1:2,2!==t||e.extUintElement||(t=1,m=new Uint16Array(m));const s=new nc(e,t,m.length,0,m);_.indexBuffer[0]=s,_.primitive[0].count=m.length}else _.primitive[0].count=u.numVertices;if(c.hasOwnProperty("extensions")&&c.extensions.hasOwnProperty("KHR_materials_variants")){const e=c.extensions.KHR_materials_variants,t={};e.mappings.forEach((e=>{e.variants.forEach((s=>{t[s]=e.material}))})),o[_.id]=t}h[_.id]=c.material;let n=s[c.attributes.POSITION];if(_.aabb=ay(n),f&&c.hasOwnProperty("targets")){const a=[];c.targets.forEach((function(e,r){const o={};e.hasOwnProperty("POSITION")&&(n=s[e.POSITION],o.deltaPositions=ny(n,i),o.deltaPositionsType=6,o.aabb=ay(n)),e.hasOwnProperty("NORMAL")&&(n=s[e.NORMAL],o.deltaNormals=ny(n,i),o.deltaNormalsType=6),t.hasOwnProperty("extras")&&t.extras.hasOwnProperty("targetNames")?o.name=t.extras.targetNames[r]:o.name=r.toString(10),t.hasOwnProperty("weights")&&(o.defaultWeight=t.weights[r]),a.push(new of(o))})),_.morph=new nf(a,e)}}l.push(_)})),l},uy=function(e,t,s){var i;let n;const a=e.texCoord;if(a)for(n=0;n<s.length;++n)t[s[n]+"MapUv"]=a;const r=[0,0],o=[1,1],h=null==(i=e.extensions)?void 0:i.KHR_texture_transform;if(h){const e=h.offset||r,i=h.scale||o,a=h.rotation?-h.rotation*ne.RAD_TO_DEG:0,l=new ve(i[0],i[1]),c=new ve(e[0],1-i[1]-e[1]);for(n=0;n<s.length;++n)t[`${s[n]}MapTiling`]=l,t[`${s[n]}MapOffset`]=c,t[`${s[n]}MapRotation`]=a}},py=function(e,t,s){let i,n;if(e.hasOwnProperty("diffuseFactor")?(i=e.diffuseFactor,t.diffuse.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2)),t.opacity=i[3]):(t.diffuse.set(1,1,1),t.opacity=1),e.hasOwnProperty("diffuseTexture")){const i=e.diffuseTexture;n=s[i.index],t.diffuseMap=n,t.diffuseMapChannel="rgb",t.opacityMap=n,t.opacityMapChannel="a",uy(i,t,["diffuse","opacity"])}if(t.useMetalness=!1,e.hasOwnProperty("specularFactor")?(i=e.specularFactor,t.specular.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2))):t.specular.set(1,1,1),e.hasOwnProperty("glossinessFactor")?t.shininess=100*e.glossinessFactor:t.shininess=100,e.hasOwnProperty("specularGlossinessTexture")){const i=e.specularGlossinessTexture;t.specularEncoding="srgb",t.specularMap=t.glossMap=s[i.index],t.specularMapChannel="rgb",t.glossMapChannel="a",uy(i,t,["gloss","metalness"])}},my=function(e,t,s){if(e.hasOwnProperty("clearcoatFactor")?t.clearCoat=.25*e.clearcoatFactor:t.clearCoat=0,e.hasOwnProperty("clearcoatTexture")){const i=e.clearcoatTexture;t.clearCoatMap=s[i.index],t.clearCoatMapChannel="r",uy(i,t,["clearCoat"])}if(e.hasOwnProperty("clearcoatRoughnessFactor")?t.clearCoatGlossiness=e.clearcoatRoughnessFactor:t.clearCoatGlossiness=0,e.hasOwnProperty("clearcoatRoughnessTexture")){const i=e.clearcoatRoughnessTexture;t.clearCoatGlossMap=s[i.index],t.clearCoatGlossMapChannel="g",uy(i,t,["clearCoatGloss"])}if(e.hasOwnProperty("clearcoatNormalTexture")){const i=e.clearcoatNormalTexture;t.clearCoatNormalMap=s[i.index],uy(i,t,["clearCoatNormal"]),i.hasOwnProperty("scale")&&(t.clearCoatBumpiness=i.scale)}t.chunks.clearCoatGlossPS="\n        #ifdef MAPFLOAT\n        uniform float material_clearCoatGlossiness;\n        #endif\n        \n        #ifdef MAPTEXTURE\n        uniform sampler2D texture_clearCoatGlossMap;\n        #endif\n        \n        void getClearCoatGlossiness() {\n            ccGlossiness = 1.0;\n        \n        #ifdef MAPFLOAT\n            ccGlossiness *= material_clearCoatGlossiness;\n        #endif\n        \n        #ifdef MAPTEXTURE\n            ccGlossiness *= texture2DBias(texture_clearCoatGlossMap, $UV, textureBias).$CH;\n        #endif\n        \n        #ifdef MAPVERTEX\n            ccGlossiness *= saturate(vVertexColor.$VC);\n        #endif\n        \n            ccGlossiness = 1.0 - ccGlossiness;\n        \n            ccGlossiness += 0.0000001;\n        }\n        "},fy=function(e,t,s){t.useLighting=!1,t.emissive.copy(t.diffuse),t.emissiveTint=t.diffuseTint,t.emissiveMap=t.diffuseMap,t.emissiveMapUv=t.diffuseMapUv,t.emissiveMapTiling.copy(t.diffuseMapTiling),t.emissiveMapOffset.copy(t.diffuseMapOffset),t.emissiveMapRotation=t.diffuseMapRotation,t.emissiveMapChannel=t.diffuseMapChannel,t.emissiveVertexColor=t.diffuseVertexColor,t.emissiveVertexColorChannel=t.diffuseVertexColorChannel,t.diffuse.set(0,0,0),t.diffuseTint=!1,t.diffuseMap=null,t.diffuseVertexColor=!1},_y=function(e,t,s){if(t.useMetalnessSpecularColor=!0,e.hasOwnProperty("specularColorTexture")&&(t.specularEncoding="srgb",t.specularMap=s[e.specularColorTexture.index],t.specularMapChannel="rgb",uy(e.specularColorTexture,t,["specular"])),e.hasOwnProperty("specularColorFactor")){const s=e.specularColorFactor;t.specular.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))}else t.specular.set(1,1,1);e.hasOwnProperty("specularFactor")?t.specularityFactor=e.specularFactor:t.specularityFactor=1,e.hasOwnProperty("specularTexture")&&(t.specularityFactorMapChannel="a",t.specularityFactorMap=s[e.specularTexture.index],uy(e.specularTexture,t,["specularityFactor"]))},gy=function(e,t,s){e.hasOwnProperty("ior")&&(t.refractionIndex=1/e.ior)},yy=function(e,t,s){t.blendType=2,t.useDynamicRefraction=!0,e.hasOwnProperty("transmissionFactor")&&(t.refraction=e.transmissionFactor),e.hasOwnProperty("transmissionTexture")&&(t.refractionMapChannel="r",t.refractionMap=s[e.transmissionTexture.index],uy(e.transmissionTexture,t,["refraction"]))},vy=function(e,t,s){if(t.useSheen=!0,e.hasOwnProperty("sheenColorFactor")){const s=e.sheenColorFactor;t.sheen.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))}else t.sheen.set(1,1,1);e.hasOwnProperty("sheenColorTexture")&&(t.sheenMap=s[e.sheenColorTexture.index],uy(e.sheenColorTexture,t,["sheen"])),e.hasOwnProperty("sheenRoughnessFactor")?t.sheenGlossiness=e.sheenRoughnessFactor:t.sheenGlossiness=0,e.hasOwnProperty("sheenRoughnessTexture")&&(t.sheenGlossinessMap=s[e.sheenRoughnessTexture.index],t.sheenGlossinessMapChannel="a",uy(e.sheenRoughnessTexture,t,["sheenGlossiness"]));t.chunks.sheenGlossPS="\n    #ifdef MAPFLOAT\n    uniform float material_sheenGlossiness;\n    #endif\n\n    #ifdef MAPTEXTURE\n    uniform sampler2D texture_sheenGlossinessMap;\n    #endif\n\n    void getSheenGlossiness() {\n        float sheenGlossiness = 1.0;\n\n        #ifdef MAPFLOAT\n        sheenGlossiness *= material_sheenGlossiness;\n        #endif\n\n        #ifdef MAPTEXTURE\n        sheenGlossiness *= texture2DBias(texture_sheenGlossinessMap, $UV, textureBias).$CH;\n        #endif\n\n        #ifdef MAPVERTEX\n        sheenGlossiness *= saturate(vVertexColor.$VC);\n        #endif\n\n        sheenGlossiness = 1.0 - sheenGlossiness;\n        sheenGlossiness += 0.0000001;\n        sGlossiness = sheenGlossiness;\n    }\n    "},xy=function(e,t,s){if(t.blendType=2,t.useDynamicRefraction=!0,e.hasOwnProperty("thicknessFactor")&&(t.thickness=e.thicknessFactor),e.hasOwnProperty("thicknessTexture")&&(t.thicknessMap=s[e.thicknessTexture.index],uy(e.thicknessTexture,t,["thickness"])),e.hasOwnProperty("attenuationDistance")&&(t.attenuationDistance=e.attenuationDistance),e.hasOwnProperty("attenuationColor")){const s=e.attenuationColor;t.attenuation.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))}},by=function(e,t,s){e.hasOwnProperty("emissiveStrength")&&(t.emissiveIntensity=e.emissiveStrength)},Sy=function(e,t,s){const i=new zl;let n,a;if(i.occludeSpecular=1,i.diffuseTint=!0,i.diffuseVertexColor=!0,i.specularTint=!0,i.specularVertexColor=!0,e.hasOwnProperty("name")&&(i.name=e.name),e.hasOwnProperty("pbrMetallicRoughness")){const s=e.pbrMetallicRoughness;if(s.hasOwnProperty("baseColorFactor")?(n=s.baseColorFactor,i.diffuse.set(Math.pow(n[0],1/2.2),Math.pow(n[1],1/2.2),Math.pow(n[2],1/2.2)),i.opacity=n[3]):(i.diffuse.set(1,1,1),i.opacity=1),s.hasOwnProperty("baseColorTexture")){const e=s.baseColorTexture;a=t[e.index],i.diffuseMap=a,i.diffuseMapChannel="rgb",i.opacityMap=a,i.opacityMapChannel="a",uy(e,i,["diffuse","opacity"])}if(i.useMetalness=!0,i.specular.set(1,1,1),s.hasOwnProperty("metallicFactor")?i.metalness=s.metallicFactor:i.metalness=1,s.hasOwnProperty("roughnessFactor")?i.shininess=100*s.roughnessFactor:i.shininess=100,s.hasOwnProperty("metallicRoughnessTexture")){const e=s.metallicRoughnessTexture;i.metalnessMap=i.glossMap=t[e.index],i.metalnessMapChannel="b",i.glossMapChannel="g",uy(e,i,["gloss","metalness"])}i.chunks.glossPS="\n        #ifdef MAPFLOAT\n        uniform float material_shininess;\n        #endif\n        \n        #ifdef MAPTEXTURE\n        uniform sampler2D texture_glossMap;\n        #endif\n        \n        void getGlossiness() {\n            dGlossiness = 1.0;\n        \n        #ifdef MAPFLOAT\n            dGlossiness *= material_shininess;\n        #endif\n        \n        #ifdef MAPTEXTURE\n            dGlossiness *= texture2DBias(texture_glossMap, $UV, textureBias).$CH;\n        #endif\n        \n        #ifdef MAPVERTEX\n            dGlossiness *= saturate(vVertexColor.$VC);\n        #endif\n        \n            dGlossiness = 1.0 - dGlossiness;\n        \n            dGlossiness += 0.0000001;\n        }\n        "}if(e.hasOwnProperty("normalTexture")){const s=e.normalTexture;i.normalMap=t[s.index],uy(s,i,["normal"]),s.hasOwnProperty("scale")&&(i.bumpiness=s.scale)}if(e.hasOwnProperty("occlusionTexture")){const s=e.occlusionTexture;i.aoMap=t[s.index],i.aoMapChannel="r",uy(s,i,["ao"])}if(e.hasOwnProperty("emissiveFactor")?(n=e.emissiveFactor,i.emissive.set(Math.pow(n[0],1/2.2),Math.pow(n[1],1/2.2),Math.pow(n[2],1/2.2)),i.emissiveTint=!0):(i.emissive.set(0,0,0),i.emissiveTint=!1),e.hasOwnProperty("emissiveTexture")){const s=e.emissiveTexture;i.emissiveMap=t[s.index],uy(s,i,["emissive"])}if(e.hasOwnProperty("alphaMode"))switch(e.alphaMode){case"MASK":i.blendType=3,e.hasOwnProperty("alphaCutoff")?i.alphaTest=e.alphaCutoff:i.alphaTest=.5;break;case"BLEND":i.blendType=2,i.depthWrite=!1;break;default:i.blendType=3}else i.blendType=3;e.hasOwnProperty("doubleSided")?(i.twoSidedLighting=e.doubleSided,i.cull=e.doubleSided?0:1):(i.twoSidedLighting=!1,i.cull=1);const r={KHR_materials_clearcoat:my,KHR_materials_emissive_strength:by,KHR_materials_ior:gy,KHR_materials_pbrSpecularGlossiness:py,KHR_materials_sheen:vy,KHR_materials_specular:_y,KHR_materials_transmission:yy,KHR_materials_unlit:fy,KHR_materials_volume:xy};if(e.hasOwnProperty("extensions"))for(const s in e.extensions){const n=r[s];void 0!==n&&n(e.extensions[s],i,t)}return i.update(),i},wy=function(e,t){const s=new kh;if(e.hasOwnProperty("name")&&e.name.length>0?s.name=e.name:s.name="node_"+t,e.hasOwnProperty("matrix")&&(ly.data.set(e.matrix),ly.getTranslation(cy),s.setLocalPosition(cy),ly.getEulerAngles(cy),s.setLocalEulerAngles(cy),ly.getScale(cy),s.setLocalScale(cy)),e.hasOwnProperty("rotation")){const t=e.rotation;s.setLocalRotation(t[0],t[1],t[2],t[3])}if(e.hasOwnProperty("translation")){const t=e.translation;s.setLocalPosition(t[0],t[1],t[2])}if(e.hasOwnProperty("scale")){const t=e.scale;s.setLocalScale(t[0],t[1],t[2])}return s},Ty=function(e,t){const s="orthographic"===e.type?1:0,i=1===s?e.orthographic:e.perspective,n={enabled:!1,projection:s,nearClip:i.znear,aspectRatioMode:0};i.zfar&&(n.farClip=i.zfar),1===s?(n.orthoHeight=.5*i.ymag,i.ymag&&(n.aspectRatioMode=1,n.aspectRatio=i.xmag/i.ymag)):(n.fov=i.yfov*ne.RAD_TO_DEG,i.aspectRatio&&(n.aspectRatioMode=1,n.aspectRatio=i.aspectRatio));const a=new $m(e.name);return a.addComponent("camera",n),a},My=function(e,t){const s={enabled:!1,type:"point"===e.type?"omni":e.type,color:e.hasOwnProperty("color")?new pe(e.color):pe.WHITE,range:e.hasOwnProperty("range")?e.range:9999,falloffMode:1,intensity:e.hasOwnProperty("intensity")?ne.clamp(e.intensity,0,2):1};e.hasOwnProperty("spot")&&(s.innerConeAngle=e.spot.hasOwnProperty("innerConeAngle")?e.spot.innerConeAngle*ne.RAD_TO_DEG:0,s.outerConeAngle=e.spot.hasOwnProperty("outerConeAngle")?e.spot.outerConeAngle*ne.RAD_TO_DEG:Math.PI/4);const i=new $m(t.name);return i.rotateLocal(90,0,0),i.addComponent("light",s),i},Cy=function(e,t,s,i){if(!t.hasOwnProperty("skins")||0===t.skins.length)return[];const n=new Map;return t.skins.map((function(a){return function(e,t,s,i,n,a){let r,o,h;const l=t.joints,c=l.length,d=[];if(t.hasOwnProperty("inverseBindMatrices")){const e=t.inverseBindMatrices,n=iy(s[e],i,!0),a=[];for(r=0;r<c;r++){for(o=0;o<16;o++)a[o]=n[16*r+o];h=new Ce,h.set(a),d.push(h)}}else for(r=0;r<c;r++)h=new Ce,d.push(h);const u=[];for(r=0;r<c;r++)u[r]=n[l[r]].name;const p=u.join("#");let m=a.get(p);return m||(m=new r_(e,d,u),a.set(p,m)),m}(e,a,t.accessors,i,s,n)}))},Ay=function(e,t,s,i){if(!e.hasOwnProperty("animations")||0===e.animations.length)return[];const n=i&&i.animation&&i.animation.preprocess,a=i&&i.animation&&i.animation.postprocess;return e.animations.map((function(i,r){n&&n(i);const o=function(e,t,s,i,n,a){const r=function(e){return new C_(Qg(e.type),ny(e,i))},o={STEP:0,LINEAR:1,CUBICSPLINE:2},h={},l={},c={};let d,u=1;for(d=0;d<e.samplers.length;++d){const t=e.samplers[d];h.hasOwnProperty(t.input)||(h[t.input]=r(s[t.input])),l.hasOwnProperty(t.output)||(l[t.output]=r(s[t.output]));const i=t.hasOwnProperty("interpolation")&&o.hasOwnProperty(t.interpolation)?o[t.interpolation]:1,n={paths:[],input:t.input,output:t.output,interpolation:i};c[d]=n}const p=[],m={translation:"localPosition",rotation:"localRotation",scale:"localScale"},f=e=>{const t=[];for(;e;)t.unshift(e.name),e=e.parent;return t},_=(e,t)=>{if(!a)return t;for(let s=0;s<a.length;s++){const i=a[s];if(i.name===e&&i.hasOwnProperty("extras")&&i.extras.hasOwnProperty("targetNames")&&i.extras.targetNames[t])return`name.${i.extras.targetNames[t]}`}return t},g=(e,t,s)=>{if(!l[e.output])return;const i=l[e.output].data.length/h[e.input].data.length,n=l[e.output].data.length/i;for(let a=0;a<i;a++){const r=new Float32Array(n);for(let t=0;t<n;t++)r[t]=l[e.output].data[t*i+a];const o=new C_(1,r);l[-u]=o;const h={paths:[{entityPath:s,component:"graph",propertyPath:[`weight.${_(t.name,a)}`]}],input:e.input,output:-u,interpolation:e.interpolation};u++,c[`morphCurve-${d}-${a}`]=h}};for(d=0;d<e.channels.length;++d){const t=e.channels[d],s=t.target,i=c[t.sampler],a=n[s.node],r=f(a);s.path.startsWith("weights")?(g(i,a,r),delete c[t.sampler],delete l[i.output]):i.paths.push({entityPath:r,component:"graph",propertyPath:[m[s.path]]})}const y=[],v=[],x=[];for(const e in h)y.push(h[e]),h[e]=y.length-1;for(const e in l)v.push(l[e]),l[e]=v.length-1;for(const e in c){const t=c[e];x.push(new M_(t.paths,h[t.input],l[t.output],t.interpolation)),"localRotation"===t.paths[0].propertyPath[0]&&2!==t.interpolation&&p.push(x[x.length-1].output)}p.sort();let b,S=null;for(d=0;d<p.length;++d){const e=p[d];if(0===d||e!==S){if(b=v[e],4===b.components){const e=b.data,t=e.length-4;for(let s=0;s<t;s+=4)e[s+0]*e[s+4]+e[s+1]*e[s+5]+e[s+2]*e[s+6]+e[s+3]*e[s+7]<0&&(e[s+4]*=-1,e[s+5]*=-1,e[s+6]*=-1,e[s+7]*=-1)}S=e}}let w=0;for(d=0;d<y.length;d++)b=y[d]._data,w=Math.max(w,0===b.length?0:b[b.length-1]);return new sg(e.hasOwnProperty("name")?e.name:"animation_"+t,w,y,v,x)}(i,r,e.accessors,s,t,e.meshes);return a&&a(i,o),o}))},Py=function(e,t,s,i,n,a){const r=n&&n.global&&n.global.preprocess,o=n&&n.global&&n.global.postprocess;r&&r(t);const h=t.asset&&"PlayCanvas"===t.asset.generator,l=function(e,t){if(!e.hasOwnProperty("nodes")||0===e.nodes.length)return[];const s=t&&t.node&&t.node.preprocess,i=t&&t.node&&t.node.process||wy,n=t&&t.node&&t.node.postprocess,a=e.nodes.map((function(e,t){s&&s(e);const a=i(e,t);return n&&n(e,a),a}));for(let t=0;t<e.nodes.length;++t){const s=e.nodes[t];if(s.hasOwnProperty("children")){const e=a[t],i={};for(let t=0;t<s.children.length;++t){const n=a[s.children[t]];n.parent||(i.hasOwnProperty(n.name)?n.name+=i[n.name]++:i[n.name]=1,e.addChild(n))}}}return a}(t,n),c=function(e,t){var s;const i=[],n=e.scenes.length;if(1===n&&1===(null==(s=e.scenes[0].nodes)?void 0:s.length)){const s=e.scenes[0].nodes[0];i.push(t[s])}else for(let s=0;s<n;s++){const n=e.scenes[s];if(n.nodes){const e=new kh(n.name);for(let s=0;s<n.nodes.length;s++){const i=t[n.nodes[s]];e.addChild(i)}i.push(e)}}return i}(t,l),d=function(e,t,s){let i=null;if(e.hasOwnProperty("nodes")&&e.hasOwnProperty("extensions")&&e.extensions.hasOwnProperty("KHR_lights_punctual")&&e.extensions.KHR_lights_punctual.hasOwnProperty("lights")){const n=e.extensions.KHR_lights_punctual.lights;if(n.length){const a=s&&s.light&&s.light.preprocess,r=s&&s.light&&s.light.process||My,o=s&&s.light&&s.light.postprocess;e.nodes.forEach((function(e,s){if(e.hasOwnProperty("extensions")&&e.extensions.hasOwnProperty("KHR_lights_punctual")&&e.extensions.KHR_lights_punctual.hasOwnProperty("light")){const h=e.extensions.KHR_lights_punctual.light,l=n[h];if(l){a&&a(l);const n=r(l,t[s]);o&&o(l,n),n&&(i||(i=new Map),i.set(e,n))}}}))}}return i}(t,l,n),u=function(e,t,s){let i=null;if(e.hasOwnProperty("nodes")&&e.hasOwnProperty("cameras")&&e.cameras.length>0){const n=s&&s.camera&&s.camera.preprocess,a=s&&s.camera&&s.camera.process||Ty,r=s&&s.camera&&s.camera.postprocess;e.nodes.forEach((function(s,o){if(s.hasOwnProperty("camera")){const h=e.cameras[s.camera];if(h){n&&n(h);const e=a(h,t[o]);r&&r(h,e),e&&(i||(i=new Map),i.set(s,e))}}}))}return i}(t,l,n),p=Ay(t,l,s,n),m=function(e,t,s,i){if(!e.hasOwnProperty("materials")||0===e.materials.length)return[];const n=s&&s.material&&s.material.preprocess,a=s&&s.material&&s.material.process||Sy,r=s&&s.material&&s.material.postprocess;return e.materials.map((function(e){n&&n(e);const s=a(e,t,i);return r&&r(e,s),s}))}(t,i.map((function(e){return e.resource})),n,h),f=function(e){if(!e.hasOwnProperty("extensions")||!e.extensions.hasOwnProperty("KHR_materials_variants"))return null;const t=e.extensions.KHR_materials_variants.variants,s={};for(let e=0;e<t.length;e++)s[t[e].name]=e;return s}(t),_={},g={},y=function(e,t,s,i,n,a,r){if(!t.hasOwnProperty("meshes")||0===t.meshes.length||!t.hasOwnProperty("accessors")||0===t.accessors.length||!t.hasOwnProperty("bufferViews")||0===t.bufferViews.length)return[];const o={};return t.meshes.map((function(h){return dy(e,h,t.accessors,s,i,n,o,a,r)}))}(e,t,s,a,h,_,g),v=Cy(e,t,l,s),x=[];for(let e=0;e<y.length;e++)x[e]=new Hg,x[e].meshes=y[e];!function(e,t,s){e.nodes.forEach((e=>{e.hasOwnProperty("mesh")&&e.hasOwnProperty("skin")&&t[e.mesh].meshes.forEach((t=>{t.skin=s[e.skin]}))}))}(t,x,v);const b=new Kg(t);b.nodes=l,b.scenes=c,b.animations=p,b.textures=i,b.materials=m,b.variants=f,b.meshVariants=_,b.meshDefaultMaterials=g,b.renders=x,b.skins=v,b.lights=d,b.cameras=u,o&&o(t,b),a(null,b)};let Ey=0;const Ry=function(e,t,s,i,n,a,r){const o=a&&a.image&&a.image.preprocess,h=a&&a.image&&a.image.processAsync||function(e,t){t(null,null)},l=a&&a.image&&a.image.postprocess,c=function(t){l&&l(e,t),r(null,t)},d={"image/png":"png","image/jpeg":"jpg","image/basis":"basis","image/ktx":"ktx","image/ktx2":"ktx2","image/vnd-ms.dds":"dds"},u=function(t,s,i,a){const o=(e.name||"gltf-texture")+"-"+Ey++,h={url:t||o};if(s&&(h.contents=s.slice(0).buffer),i){const e=d[i];e&&(h.filename=h.url+"."+e)}const l=new um(o,"texture",h,null,a);l.on("load",c),l.on("error",r),n.add(l),n.load(l)};o&&o(e),h(e,(function(n,a){var o;n?r(n):a?c(a):e.hasOwnProperty("uri")?Zg(e.uri)?u(e.uri,null,(o=e.uri).substring(o.indexOf(":")+1,o.indexOf(";")),null):u(E.join(i,e.uri),null,null,{crossOrigin:"anonymous"}):e.hasOwnProperty("bufferView")&&e.hasOwnProperty("mimeType")?u(null,s[e.bufferView],e.mimeType,null):r("Invalid image found in gltf (neither uri or bufferView found). index="+t)}))},Ly=function(e,t){const s=JSON.parse(function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);let t="";for(let s=0;s<e.length;s++)t+=String.fromCharCode(e[s]);return decodeURIComponent(escape(t))}(e));if(s.asset&&s.asset.version&&parseFloat(s.asset.version)<2)return void t(`Invalid gltf version. Expected version 2.0 or above but found version '${s.asset.version}'.`);const i=(null==s?void 0:s.extensionsRequired)||[];Yg||$g()||-1===i.indexOf("KHR_draco_mesh_compression")?t(null,s):Y.getInstance("DracoDecoderModule",(e=>{Yg=e,t(null,s)}))},Iy=function(e,t,s){e&&e.toLowerCase().endsWith(".glb")?function(e,t){const s=e instanceof ArrayBuffer?new DataView(e):new DataView(e.buffer,e.byteOffset,e.byteLength),i=s.getUint32(0,!0),n=s.getUint32(4,!0),a=s.getUint32(8,!0);if(1179937895!==i)return void t("Invalid magic number found in glb header. Expected 0x46546C67, found 0x"+i.toString(16));if(2!==n)return void t("Invalid version number found in glb header. Expected 2, found "+n);if(a<=0||a>s.byteLength)return void t("Invalid length found in glb header. Found "+a);const r=[];let o=12;for(;o<a;){const e=s.getUint32(o,!0);if(o+e+8>s.byteLength)throw new Error("Invalid chunk length found in glb. Found "+e);const t=s.getUint32(o+4,!0),i=new Uint8Array(s.buffer,s.byteOffset+o+8,e);r.push({length:e,type:t,data:i}),o+=e+8}1===r.length||2===r.length?1313821514===r[0].type?r.length>1&&5130562!==r[1].type?t("Invalid chunk type found in glb file. Expected 0x004E4942, found 0x"+r[1].type.toString(16)):t(null,{gltfChunk:r[0].data,binaryChunk:2===r.length?r[1].data:null}):t("Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x"+r[0].type.toString(16)):t("Invalid number of chunks found in glb file.")}(t,s):s(null,{gltfChunk:t,binaryChunk:null})},Dy=function(e,t,s,i){const n=[],a=s&&s.bufferView&&s.bufferView.preprocess,r=s&&s.bufferView&&s.bufferView.processAsync||function(e,t,s){s(null,null)},o=s&&s.bufferView&&s.bufferView.postprocess;let h=e.bufferViews?e.bufferViews.length:0;if(!h)return void i(null,null);const l=function(t,s){const a=e.bufferViews[t];a.hasOwnProperty("byteStride")&&(s.byteStride=a.byteStride),n[t]=s,o&&o(a,s),0==--h&&i(null,n)};for(let s=0;s<e.bufferViews.length;++s){const n=e.bufferViews[s];a&&a(n),r(n,t,function(e,s,n,a){if(n)i(n);else if(a)l(e,a);else{const i=t[s.buffer],n=new Uint8Array(i.buffer,i.byteOffset+(s.byteOffset||0),s.byteLength);l(e,n)}}.bind(null,s,n))}};class Oy{static parseAsync(e,t,s,i,n,a,r){Iy(e,s,(function(e,s){e?r(e):Ly(s.gltfChunk,(function(e,o){e?r(e):function(e,t,s,i,n){const a=[];if(!e.buffers||0===e.buffers.length)return void n(null,a);const r=i&&i.buffer&&i.buffer.preprocess,o=i&&i.buffer&&i.buffer.processAsync||function(e,t){t(null,null)},h=i&&i.buffer&&i.buffer.postprocess;let l=e.buffers.length;const c=function(t,s){a[t]=s,h&&h(e.buffers[t],s),0==--l&&n(null,a)};for(let i=0;i<e.buffers.length;++i){const a=e.buffers[i];r&&r(a),o(a,function(e,i,a,r){if(a)n(a);else if(r)c(e,new Uint8Array(r));else if(i.hasOwnProperty("uri"))if(Zg(i.uri)){const t=atob(i.uri.split(",")[1]),s=new Uint8Array(t.length);for(let e=0;e<t.length;e++)s[e]=t.charCodeAt(e);c(e,s)}else re.get(E.join(s,i.uri),{cache:!0,responseType:"arraybuffer",retry:!1},function(e,t,s){t?n(t):c(e,new Uint8Array(s))}.bind(null,e));else c(e,t)}.bind(null,i,a))}}(o,s.binaryChunk,t,a,(function(e,s){e?r(e):Dy(o,s,a,(function(e,s){e?r(e):function(e,t,s,i,n,a){if(!e.hasOwnProperty("images")||0===e.images.length||!e.hasOwnProperty("textures")||0===e.textures.length)return void a(null,[]);const r=n&&n.texture&&n.texture.preprocess,o=n&&n.texture&&n.texture.processAsync||function(e,t,s){s(null,null)},h=n&&n.texture&&n.texture.postprocess,l=[],c=[];let d=e.textures.length;const u=function(t,s){if(c[s]||(c[s]=[]),c[s].push(t),0==--d){const t=[];c.forEach((function(s,i){s.forEach((function(s,n){const a=0===n?l[i]:oy(l[i]);!function(e,t){const s=function(e,t){switch(e){case 9728:return 0;case 9729:return 1;case 9984:return 2;case 9985:return 4;case 9986:return 3;case 9987:return 5;default:return t}},i=function(e,t){switch(e){case 33071:return 1;case 33648:return 2;case 10497:return 0;default:return t}};e&&(t=t||{},e.minFilter=s(t.minFilter,5),e.magFilter=s(t.magFilter,1),e.addressU=i(t.wrapS,0),e.addressV=i(t.wrapT,0))}(a.resource,(e.samplers||[])[e.textures[s].sampler]),t[s]=a,h&&h(e.textures[s],a)}))})),a(null,t)}};for(let h=0;h<e.textures.length;++h){const c=e.textures[h];r&&r(c),o(c,e.images,function(r,o,h,c){var d,p;if(h)a(h);else if(null==c&&void 0===(c=null==o||null==(d=o.extensions)||null==(p=d.KHR_texture_basisu)?void 0:p.source)&&(c=o.source),l[c])u(r,c);else{const o=e.images[c];Ry(o,r,t,s,i,n,(function(e,t){e?a(e):(l[c]=t,u(r,c))}))}}.bind(null,h,c))}}(o,s,t,n,a,(function(e,t){e?r(e):Py(i,o,s,t,a,r)}))}))}))}))}))}static parse(e,t,s,i){let n=null;return i=i||{},Iy(e,t,(function(e,t){e?console.error(e):Ly(t.gltfChunk,(function(e,a){e?console.error(e):Dy(a,[t.binaryChunk],i,(function(e,t){e?console.error(e):Py(s,a,t,[],i,(function(e,t){e?console.error(e):n=t}))}))}))})),n}constructor(e,t,s){this._device=e,this._assets=t,this._defaultMaterial=Sy({name:"defaultGlbMaterial"},[]),this.maxRetries=s}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}load(e,t,s){um.fetchArrayBuffer(e.load,((i,n)=>{i?t(i):Oy.parseAsync(this._getUrlWithoutParams(e.original),E.extractPath(e.load),n,this._device,s.registry,s.options,((e,i)=>{e?t(e):t(null,new jg(i,s,this._assets,this._defaultMaterial))}))}),s,this.maxRetries)}open(e,t,s){return t}patch(e,t){}}class Fy{constructor(e){this.handlerType="animation",this.maxRetries=0}load(e,t){"string"==typeof e&&(e={load:e,original:e});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};(e.load.startsWith("blob:")||e.load.startsWith("data:"))&&(".glb"===E.getExtension(e.original).toLowerCase()?s.responseType=ae.ResponseType.ARRAY_BUFFER:s.responseType=ae.ResponseType.JSON),re.get(e.load,s,(function(s,i){s?t(`Error loading animation resource: ${e.original} [${s}]`):t(null,i)}))}open(e,t,s){if(".glb"===E.getExtension(e).toLowerCase()){const e=Oy.parse("filename.glb",t,null);if(e){var i;const t=e.animations;if(null!=s&&null!=(i=s.data)&&i.events)for(let e=0;e<t.length;e++)t[e].events=new tg(Object.values(s.data.events));return e.destroy(),t}return null}return this["_parseAnimationV"+t.animation.version](t)}patch(e,t){}_parseAnimationV3(e){const t=e.animation,s=new m_;s.name=t.name,s.duration=t.duration;for(let e=0;e<t.nodes.length;e++){const i=new p_,n=t.nodes[e];i._name=n.name;for(let e=0;e<n.keys.length;e++){const t=n.keys[e],s=t.time,a=t.pos,r=t.rot,o=t.scale,h=new ge(a[0],a[1],a[2]),l=(new Ae).setFromEulerAngles(r[0],r[1],r[2]),c=new ge(o[0],o[1],o[2]),d=new u_(s,h,l,c);i._keys.push(d)}s.addNode(i)}return s}_parseAnimationV4(e){const t=e.animation,s=new m_;s.name=t.name,s.duration=t.duration;for(let e=0;e<t.nodes.length;e++){const i=new p_,n=t.nodes[e];i._name=n.name;const a=n.defaults.p,r=n.defaults.r,o=n.defaults.s;for(let e=0;e<n.keys.length;e++){const t=n.keys[e],s=t.t,h=a||t.p,l=r||t.r,c=o||t.s,d=new ge(h[0],h[1],h[2]),u=(new Ae).setFromEulerAngles(l[0],l[1],l[2]),p=new ge(c[0],c[1],c[2]),m=new u_(s,d,u,p);i._keys.push(m)}s.addNode(i)}return s}}const ky=function(){if("undefined"==typeof window)return!1;const e=window.navigator.userAgent,t=e.indexOf("MSIE ");if(t>0)return parseInt(e.substring(t+5,e.indexOf(".",t)),10);if(e.indexOf("Trident/")>0){const t=e.indexOf("rv:");return parseInt(e.substring(t+3,e.indexOf(".",t)),10)}return!1}(),By=[".ogg",".mp3",".wav",".mp4a",".m4a",".mp4",".aac",".opus"];class zy{constructor(e){this.handlerType="audio",this.manager=e.soundManager,this.maxRetries=0}_isSupported(e){const t=E.getExtension(e);return By.indexOf(t)>-1}load(e,t){"string"==typeof e&&(e={load:e,original:e});const s=function(e){t(null,new Ag(e))},i=function(s){let i="Error loading audio url: "+e.original;s&&(i+=": "+(s.message||s)),console.warn(i),t(i)};if(this._createSound){if(!this._isSupported(e.original))return void i(`Audio format for ${e.original} not supported`);this._createSound(e.load,s,i)}else i(null)}open(e,t){return t}patch(e,t){}_createSound(e,t,s){if(bg()){const i=this.manager;if(!i.context)return void s("Audio manager has no audio context");const n={retry:this.maxRetries>0,maxRetries:this.maxRetries};(e.startsWith("blob:")||e.startsWith("data:"))&&(n.responseType=ae.ResponseType.ARRAY_BUFFER),re.get(e,n,(function(e,n){e?s(e):i.context.decodeAudioData(n,t,s)}))}else{let i=null;try{i=new Audio}catch(e){return void s("No support for Audio element")}ky&&document.body.appendChild(i);const n=function e(){i.removeEventListener("canplaythrough",e),ky&&document.body.removeChild(i),t(i)};i.onerror=function(){i.onerror=null,ky&&document.body.removeChild(i),s()},i.addEventListener("canplaythrough",n),i.src=e}}}class Uy{constructor(e){this.handlerType="binary",this.maxRetries=0}load(e,t){"string"==typeof e&&(e={load:e,original:e}),re.get(e.load,{responseType:ae.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(s,i){s?t(`Error loading binary resource: ${e.original} [${s}]`):t(null,i)}))}open(e,t){return t}patch(e,t){}}class Vy{instantiateModelEntity(e){return null}instantiateRenderEntity(e){return null}getMaterialVariants(){return null}applyMaterialVariant(e,t){}applyMaterialVariantInstances(e,t){}}class Ny{constructor(e){this.handlerType="container",this.glbParser=new Oy(e.graphicsDevice,e.assets,0),this.parsers={}}set maxRetries(e){this.glbParser.maxRetries=e;for(const t in this.parsers)this.parsers.hasOwnProperty(t)&&(this.parsers[t].maxRetries=e)}get maxRetries(){return this.glbParser.maxRetries}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}_getParser(e){const t=e?E.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".",""):null;return this.parsers[t]||this.glbParser}load(e,t,s){"string"==typeof e&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,s)}open(e,t,s){return this._getParser(e).open(e,t,s)}patch(e,t){}}class Gy{constructor(e){this.handlerType="css",this.maxRetries=0}load(e,t){"string"==typeof e&&(e={load:e,original:e}),re.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(s,i){s?t(`Error loading css resource: ${e.original} [${s}]`):t(null,i)}))}open(e,t){return t}patch(e,t){}}function Wy(e){const t=document.createElement("style");return t.type="text/css",t.styleSheet?t.styleSheet.cssText=e:t.appendChild(document.createTextNode(e)),t}class Hy{constructor(e){this.handlerType="cubemap",this._device=e.graphicsDevice,this._registry=e.assets,this._loader=e.loader}load(e,t,s){this.loadAssets(s,t)}open(e,t,s){return s?s.resource:null}patch(e,t){this.loadAssets(e,(function(s,i){s&&(t.fire("error",e),t.fire("error:"+e.id,s,e),e.fire("error",e))}))}getAssetIds(e){const t=[];if(t[0]=e.file,(e.loadFaces||!e.file)&&e.data&&e.data.textures)for(let s=0;s<6;++s)t[s+1]=e.data.textures[s];else t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=null;return t}compareAssetIds(e,t){return e&&t?parseInt(e,10)===e||"string"==typeof e?e===t:e.url===t.url:null!==e==(null!==t)}update(e,t,s){const i=e.data||{},n=e._handlerState.assets,a=e._resources;let r,o,h;const l=[null,null,null,null,null,null,null],c=function(){return i.hasOwnProperty("type")?i.type:i.hasOwnProperty("rgbm")?i.rgbm?"rgbm":"default":null};if(e.loaded&&s[0]===n[0])l[1]=a[1]||null,l[2]=a[2]||null,l[3]=a[3]||null,l[4]=a[4]||null,l[5]=a[5]||null,l[6]=a[6]||null;else if(s[0])for(r=s[0].resource,h=0;h<6;++h)l[h+1]=new fh(this._device,{name:e.name+"_prelitCubemap"+(r.width>>h),cubemap:!0,type:c()||r.type,width:r.width>>h,height:r.height>>h,format:r.format,levels:[r._levels[h]],fixCubemapSeams:!0,addressU:1,addressV:1,mipmaps:0===h});const d=s.slice(1);if(e.loaded&&this.cmpArrays(d,n.slice(1)))l[0]=a[0]||null;else if(-1===d.indexOf(null)){const t=d.map((function(e){return e.resource})),n=[];for(o=0;o<t[0]._levels.length;++o)n.push(t.map((function(e){return e._levels[o]})));const a=t[0].format,r=new fh(this._device,{name:e.name+"_faces",cubemap:!0,type:c()||t[0].type,width:t[0].width,height:t[0].height,format:6===a?7:a,levels:n,minFilter:i.hasOwnProperty("minFilter")?i.minFilter:t[0].minFilter,magFilter:i.hasOwnProperty("magFilter")?i.magFilter:t[0].magFilter,anisotropy:i.hasOwnProperty("anisotropy")?i.anisotropy:1,addressU:1,addressV:1,fixCubemapSeams:!!s[0]});l[0]=r}if(!this.cmpArrays(l,a))for(e.resources=l,e._handlerState.assetIds=t,e._handlerState.assets=s,h=0;h<a.length;++h)null!==a[h]&&-1===l.indexOf(a[h])&&a[h].destroy();for(h=0;h<n.length;++h)null!==n[h]&&-1===s.indexOf(n[h])&&n[h].unload()}cmpArrays(e,t){if(e.length!==t.length)return!1;for(let s=0;s<e.length;++s)if(e[s]!==t[s])return!1;return!0}resolveId(e){const t=parseInt(e,10);return t===e||t.toString()===e?t:e}loadAssets(e,t){e.hasOwnProperty("_handlerState")||(e._handlerState={assetIds:[null,null,null,null,null,null,null],assets:[null,null,null,null,null,null,null]});const s=this,i=s.getAssetIds(e),n=[null,null,null,null,null,null,null],a=e._handlerState.assetIds,r=e._handlerState.assets,o=s._registry;let h=7;const l=function(a,r){n[a]=r,h--,0===h&&(s.update(e,i,n),t(null,e.resources))},c=function(e,s,i){t(s)},d=function(e,t){t.loaded?l(e,t):(o.once("load:"+t.id,l.bind(s,e)),o.once("error:"+t.id,c.bind(s,e)),t.loading||o.load(t))};let u;for(let t=0;t<7;++t){const n=this.resolveId(i[t]);if(n)if(s.compareAssetIds(n,a[t]))l(t,r[t]);else if(parseInt(n,10)===n)u=o.get(n),u?d(t,u):setTimeout(function(e,t){const s=o.get(t);s?d(e,s):c(0,"failed to find dependent cubemap asset="+t)}.bind(null,t,n));else{const i="string"==typeof n?{url:n,filename:n}:n;u=new um(e.name+"_part_"+t,"texture",i),o.add(u),o.once("load:"+u.id,l.bind(s,t)),o.once("error:"+u.id,c.bind(s,t)),o.load(u)}else l(t,null)}}}class Xy{constructor(){this.handlerType="folder"}load(e,t){t(null,null)}open(e,t){return t}}function qy(e){return e.version<3&&(e.version<2&&(e.info.maps=e.info.maps||[{width:e.info.width,height:e.info.height}]),e.chars=Object.keys(e.chars||{}).reduce((function(t,s){const i=e.chars[s],n=void 0!==i.letter?i.letter:X.fromCodePoint(s);return e.version<2&&(i.map=i.map||0),t[n]=i,t}),{}),e.version=3),e}class jy{constructor(e){this.handlerType="font",this._loader=e.loader,this.maxRetries=0}load(e,t,s){"string"==typeof e&&(e={load:e,original:e});const i=this;".json"===E.getExtension(e.original)?re.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(s,n){if(s)t(`Error loading font resource: ${e.original} [${s}]`);else{const s=qy(n);i._loadTextures(e.load.replace(".json",".png"),s,(function(e,i){if(e)return t(e);t(null,{data:s,textures:i})}))}})):(s&&s.data&&(s.data=qy(s.data)),this._loadTextures(e.load,s&&s.data,t))}_loadTextures(e,t,s){const i=t.info.maps.length;let n=0,a=null;const r=new Array(i),o=this._loader,h=function(t){const h=function(e,o){if(!a){if(e)return a=e,s(e);o.upload(),r[t]=o,n++,n===i&&s(null,r)}};0===t?o.load(e,"texture",h):o.load(e.replace(".png",t+".png"),"texture",h)};for(let e=0;e<i;e++)h(e)}open(e,t,s){let i;return i=t.textures?new _g(t.textures,t.data):new _g(t,null),i}patch(e,t){const s=e.resource;!s.data&&e.data?s.data=e.data:!e.data&&s.data&&(e.data=s.data),e.data&&(e.data=qy(e.data))}}const Yy=function(e,t,s){const i=s.singleVecs;let n,a;const r=t.___1;r||(n=s.tripleVecs,a=t.___2);let o=r?r[0]:n[a];e.setLocalPosition(i[o],i[o+1],i[o+2]),o=r?r[1]:n[a+1],e.setLocalEulerAngles(i[o],i[o+1],i[o+2]),o=r?r[2]:n[a+2],e.setLocalScale(i[o],i[o+1],i[o+2])},$y=function(e,t){const s=e.charCodeAt(0)-t.fieldFirstCode;return t.fieldArray[s]},Ky=function(e,t){let s=0;for(let i=0;i<e.length;i++)s=s*t.fieldCodeBase+e.charCodeAt(i)-t.fieldFirstCode;return t.fieldArray[s]};class Zy{constructor(e,t){this._node=e,this._data=t}run(){const e=Object.prototype.toString.call(this._node);return"[object Object]"===e?this._handleMap():"[object Array]"===e?this._handleArray():this._result=this._node,this._result}_handleMap(){this._result={};Object.keys(this._node).forEach(this._handleKey,this)}_handleKey(e){let t=e;const s=e.length;1===s?t=$y(e,this._data):2===s&&(t=Ky(e,this._data)),this._result[t]=new Zy(this._node[e],this._data).run()}_handleArray(){this._result=[],this._node.forEach(this._handleArElt,this)}_handleArElt(e){const t=new Zy(e,this._data).run();this._result.push(t)}}class Qy{constructor(e,t){this._app=e,this._isTemplate=t}parse(e){const t={};let s=null;const i=e.compressedFormat;i&&!e.entDecompressed&&(e.entDecompressed=!0,e.entities=new Zy(e.entities,i).run());for(const n in e.entities){const a=e.entities[n],r=this._createEntity(a,i);t[n]=r,null===a.parent&&(s=r)}for(const s in e.entities){const i=t[s],n=e.entities[s].children,a=n.length;for(let e=0;e<a;e++){const s=t[n[e]];s&&i.addChild(s)}}return this._openComponentData(s,e.entities),s}_createEntity(e,t){const s=new $m(e.name,this._app);if(s.setGuid(e.resource_id),this._setPosRotScale(s,e,t),s._enabled=void 0===e.enabled||e.enabled,this._isTemplate?s._template=!0:s._enabledInHierarchy=s._enabled,s.template=e.template,e.tags)for(let t=0;t<e.tags.length;t++)s.tags.add(e.tags[t]);return e.labels&&e.labels.forEach((function(e){s.addLabel(e)})),s}_setPosRotScale(e,t,s){if(s)Yy(e,t,s);else{const s=t.position,i=t.rotation,n=t.scale;e.setLocalPosition(s[0],s[1],s[2]),e.setLocalEulerAngles(i[0],i[1],i[2]),e.setLocalScale(n[0],n[1],n[2])}}_openComponentData(e,t){const s=this._app.systems.list;let i=s.length;const n=t[e.getGuid()];for(let t=0;t<i;t++){const i=s[t],a=n.components[i.id];a&&i.addComponent(e,a)}i=n.children.length;const a=e._children;for(let e=0;e<i;e++)a[e]=this._openComponentData(a[e],t);return e}}const Jy=function(e,t,s){"string"==typeof e&&(e={load:e,original:e}),re.get(e.load,{retry:t>0,maxRetries:t},(function(t,i){if(t){let i="Error while loading scene JSON "+e.original;t.message?(i+=": "+t.message,t.stack&&(i+="\n"+t.stack)):i+=": "+t,s(i)}else s(t,i)}))};class ev{constructor(e){this.handlerType="hierarchy",this._app=e,this.maxRetries=0}load(e,t){Jy(e,this.maxRetries,t)}open(e,t){this._app.systems.script.preloading=!0;const s=new Qy(this._app,!1).parse(t);return this._app.systems.script.preloading=!1,s}}class tv{constructor(e){this.handlerType="html",this.maxRetries=0}load(e,t){"string"==typeof e&&(e={load:e,original:e}),re.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(s,i){s?t(`Error loading html resource: ${e.original} [${s}]`):t(null,i)}))}open(e,t){return t}patch(e,t){}}class sv{constructor(e){this.handlerType="json",this.maxRetries=0}load(e,t){"string"==typeof e&&(e={load:e,original:e});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(s.responseType=ae.ResponseType.JSON),re.get(e.load,s,(function(s,i){s?t(`Error loading JSON resource: ${e.original} [${s}]`):t(null,i)}))}open(e,t){return t}patch(e,t){}}class iv{constructor(){this.removeInvalid=!0,this.valid=!0,this.enumValidators={occludeSpecular:this._createEnumValidator([0,1,2]),cull:this._createEnumValidator([0,1,2,3]),blendType:this._createEnumValidator([0,1,2,3,4,5,6,7,8,9,10]),depthFunc:this._createEnumValidator([0,1,2,3,4,5,6,7]),shadingModel:this._createEnumValidator([0,1])}}setInvalid(e,t){this.valid=!1,this.removeInvalid&&delete t[e]}validate(e){const t=Ll,s=Ol,i="path"===e.mappingFormat;for(const n in e){const a=t[n];if(a)if(a.startsWith("enum")){const t=a.split(":")[1];this.enumValidators[t]&&(this.enumValidators[t](e[n])||this.setInvalid(n,e))}else if("number"===a)"number"!=typeof e[n]&&this.setInvalid(n,e);else if("boolean"===a)"boolean"!=typeof e[n]&&this.setInvalid(n,e);else if("string"===a)"string"!=typeof e[n]&&this.setInvalid(n,e);else if("vec2"===a)e[n]instanceof Array&&2===e[n].length||this.setInvalid(n,e);else if("rgb"===a)e[n]instanceof Array&&3===e[n].length||this.setInvalid(n,e);else if("texture"===a)i?"string"!=typeof e[n]&&null!==e[n]&&(e[n]instanceof fh||this.setInvalid(n,e)):"number"!=typeof e[n]&&null!==e[n]&&(e[n]instanceof fh||this.setInvalid(n,e));else if("boundingbox"===a)e[n].center&&e[n].center instanceof Array&&3===e[n].center.length||this.setInvalid(n,e),e[n].halfExtents&&e[n].halfExtents instanceof Array&&3===e[n].halfExtents.length||this.setInvalid(n,e);else if("cubemap"===a)"number"!=typeof e[n]&&null!==e[n]&&void 0!==e[n]&&(e[n]instanceof fh&&e[n].cubemap||this.setInvalid(n,e));else if("chunks"===a){const t=Object.keys(e[n]);for(let s=0;s<t.length;s++)"string"!=typeof e[n][t[s]]&&this.setInvalid(t[s],e[n])}else console.error("Unknown material type: "+a);else s[n]?delete e[n]:this.valid=!1}return e.validated=!0,this.valid}_createEnumValidator(e){return function(t){return e.indexOf(t)>=0}}}class nv{constructor(){this._validator=null}parse(e){const t=this.migrate(e),s=this._validate(t),i=new zl;return this.initialize(i,s),i}initialize(e,t){t.validated||(t=this._validate(t)),t.chunks&&(e.chunks=b_({},t.chunks));for(const s in t){const i=Ll[s],n=t[s];if("vec2"===i)e[s]=new ve(n[0],n[1]);else if("rgb"===i)e[s]=new pe(n[0],n[1],n[2]);else if("texture"===i)n instanceof fh?e[s]=n:e[s]instanceof fh&&"number"==typeof n&&n>0||(e[s]=null);else if("cubemap"===i)n instanceof fh?e[s]=n:e[s]instanceof fh&&"number"==typeof n&&n>0||(e[s]=null),"cubeMap"!==s||n||(e.prefilteredCubemaps=null);else if("boundingbox"===i){const t=new ge(n.center[0],n.center[1],n.center[2]),i=new ge(n.halfExtents[0],n.halfExtents[1],n.halfExtents[2]);e[s]=new De(t,i)}else e[s]=t[s]}e.update()}migrate(e){let t;void 0===e.shadingModel&&("blinn"===e.shader?e.shadingModel=1:e.shadingModel=0),e.shader&&delete e.shader,e.mapping_format&&(e.mappingFormat=e.mapping_format,delete e.mapping_format);const s=[["bumpMapFactor","bumpiness"],["aoUvSet","aoMapUv"],["aoMapVertexColor","aoVertexColor"],["diffuseMapVertexColor","diffuseVertexColor"],["emissiveMapVertexColor","emissiveVertexColor"],["specularMapVertexColor","specularVertexColor"],["metalnessMapVertexColor","metalnessVertexColor"],["opacityMapVertexColor","opacityVertexColor"],["glossMapVertexColor","glossVertexColor"],["lightMapVertexColor","lightVertexColor"],["diffuseMapTint","diffuseTint"],["specularMapTint","specularTint"],["emissiveMapTint","emissiveTint"],["metalnessMapTint","metalnessTint"]];for(t=0;t<s.length;t++){const i=s[t][0],n=s[t][1];void 0!==e[i]&&void 0===e[n]&&(e[n]=e[i],delete e[i])}const i=["fresnelFactor","shadowSampleType"];for(t=0;t<i.length;t++){const s=i[t];e.hasOwnProperty(s)&&delete e[s]}return e}_validate(e){return e.validated||(this._validator||(this._validator=new iv),this._validator.validate(e)),e}}class av{constructor(e,t,s,i,n){this.propertyName=e,this.parent=t,this._scope=n,this._registry=s,this.id=null,this.url=null,this.asset=null,this._onAssetLoad=i.load,this._onAssetAdd=i.add,this._onAssetRemove=i.remove,this._onAssetUnload=i.unload}set id(e){if(this.url)throw Error("Can't set id and url");this._unbind(),this._id=e,this.asset=this._registry.get(this._id),this._bind()}get id(){return this._id}set url(e){if(this.id)throw Error("Can't set id and url");this._unbind(),this._url=e,this.asset=this._registry.getByUrl(this._url),this._bind()}get url(){return this._url}_bind(){this.id&&(this._onAssetLoad&&this._registry.on("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.once("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.on("remove:"+this.id,this._onRemove,this),this._onAssetUnload&&this._registry.on("unload:"+this.id,this._onUnload,this)),this.url&&(this._onAssetLoad&&this._registry.on("load:url:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.once("add:url:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.on("remove:url:"+this.url,this._onRemove,this))}_unbind(){this.id&&(this._onAssetLoad&&this._registry.off("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.id,this._onRemove,this),this._onAssetUnload&&this._registry.off("unload:"+this.id,this._onUnload,this)),this.url&&(this._onAssetLoad&&this._registry.off("load:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.url,this._onRemove,this))}_onLoad(e){this._onAssetLoad.call(this._scope,this.propertyName,this.parent,e)}_onAdd(e){this.asset=e,this._onAssetAdd.call(this._scope,this.propertyName,this.parent,e)}_onRemove(e){this._onAssetRemove.call(this._scope,this.propertyName,this.parent,e),this.asset=null}_onUnload(e){this._onAssetUnload.call(this._scope,this.propertyName,this.parent,e)}}const rv={aoMap:"white",diffuseMap:"gray",specularMap:"gray",specularityFactorMap:"white",metalnessMap:"black",glossMap:"gray",sheenMap:"black",sheenGlossinessMap:"gray",clearCoatMap:"black",clearCoatGlossMap:"gray",clearCoatNormalMap:"normal",refractionMap:"white",emissiveMap:"gray",normalMap:"normal",heightMap:"gray",opacityMap:"gray",sphereMap:"gray",lightMap:"white"};class ov{constructor(e){this.handlerType="material",this._assets=e.assets,this._device=e.graphicsDevice,this._placeholderTextures=null,this._parser=new nv,this.maxRetries=0}load(e,t){"string"==typeof e&&(e={load:e,original:e}),re.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(s,i){s?t&&t(`Error loading material: ${e.original} [${s}]`):t&&(i._engine=!0,t(null,i))}))}open(e,t){const s=this._parser.parse(t);return t._engine&&(s._data=t,delete t._engine),s}_createPlaceholders(){this._placeholderTextures={};const e={white:[255,255,255,255],gray:[128,128,128,255],black:[0,0,0,255],normal:[128,128,255,255]};for(const t in e){if(!e.hasOwnProperty(t))continue;this._placeholderTextures[t]=new fh(this._device,{width:2,height:2,format:7,name:"material_placeholder"});const s=this._placeholderTextures[t].lock();for(let i=0;i<4;i++)for(let n=0;n<4;n++)s[4*i+n]=e[t][n];this._placeholderTextures[t].unlock()}}patch(e,t){e.resource._data&&(e._data=e.resource._data,delete e.resource._data),e.data.name=e.name,e.resource.name=e.name,this._bindAndAssignAssets(e,t),e.off("unload",this._onAssetUnload,this),e.on("unload",this._onAssetUnload,this)}_onAssetUnload(e){delete e.data.parameters,delete e.data.chunks,delete e.data.name}_assignTexture(e,t,s){t.resource[e]=s}_getPlaceholderTexture(e){this._placeholderTextures||this._createPlaceholders();const t=rv[e];return this._placeholderTextures[t]}_assignPlaceholderTexture(e,t){t.resource[e]=this._getPlaceholderTexture(e)}_onTextureLoad(e,t,s){this._assignTexture(e,t,s.resource),t.resource.update()}_onTextureAdd(e,t,s){this._assets.load(s)}_onTextureRemoveOrUnload(e,t,s){const i=t.resource;i&&t.resource[e]===s.resource&&(this._assignPlaceholderTexture(e,t),i.update())}_assignCubemap(e,t,s){t.resource[e]=s[0],"cubeMap"===e&&(t.resource.prefilteredCubemaps=s.slice(1))}_onCubemapLoad(e,t,s){this._assignCubemap(e,t,s.resources),this._parser.initialize(t.resource,t.data)}_onCubemapAdd(e,t,s){0===t.data.shadingModel&&(t.loadFaces=!0),this._assets.load(s)}_onCubemapRemoveOrUnload(e,t,s){const i=t.resource;t.data.prefilteredCubeMap128===s.resources[1]&&(this._assignCubemap(e,t,[null,null,null,null,null,null,null]),i.update())}_bindAndAssignAssets(e,t){const s=this._parser.migrate(e.data),i=e.resource,n="path"===s.mappingFormat,a=Il;let r,o,h;for(r=0;r<a.length;r++){o=a[r],h=i._assetReferences[o];const l=s[o],c=i[o],d=c===this._getPlaceholderTexture(o),u=s.validated;!l||c&&u&&!d?h&&(n?h.url=null:h.id=null):(h||(h=new av(o,e,t,{load:this._onTextureLoad,add:this._onTextureAdd,remove:this._onTextureRemoveOrUnload,unload:this._onTextureRemoveOrUnload},this),i._assetReferences[o]=h),n?h.url=e.getAbsoluteUrl(l):h.id=l,h.asset&&(h.asset.resource?this._assignTexture(o,e,h.asset.resource):this._assignPlaceholderTexture(o,e),t.load(h.asset)))}const l=Dl;for(r=0;r<l.length;r++)o=l[r],h=i._assetReferences[o],s[o]&&!e.data.prefilteredCubeMap128&&(h||(h=new av(o,e,t,{load:this._onCubemapLoad,add:this._onCubemapAdd,remove:this._onCubemapRemoveOrUnload,unload:this._onCubemapRemoveOrUnload},this),i._assetReferences[o]=h),n?h.url=s[o]:h.id=s[o],h.asset&&(h.asset.loaded&&this._assignCubemap(o,e,h.asset.resources),t.load(h.asset)));this._parser.initialize(i,s)}}class hv{constructor(e,t){this._device=e,this._defaultMaterial=t}parse(e){const t=Oy.parse("filename.glb",e,this._device);if(t){const e=jg.createModel(t,this._defaultMaterial);return t.destroy(),e}return null}}class lv{constructor(){this.index=0,this.boneIndices=[0,0,0,0]}}class cv{constructor(){this.partition=0,this.vertexStart=0,this.vertexCount=0,this.indexStart=0,this.indexCount=0,this.boneIndices=[],this.vertices=[],this.indices=[],this.indexMap={},this.originalMesh=null}addVertex(e,t,s){let i=-1;if(void 0!==this.indexMap[t])i=this.indexMap[t],this.indices.push(i);else{for(let i=0;i<4;i++){if(0===s.blendWeight.data[4*t+i])continue;const n=s.blendIndices.data[4*e.index+i];e.boneIndices[i]=this.getBoneRemap(n)}i=this.vertices.length,this.indices.push(i),this.vertices.push(e),this.indexMap[t]=i}}addPrimitive(e,t,s,i){const n=[];let a=0;const r=e.length;for(let t=0;t<r;t++){const i=e[t].index;for(let e=0;e<4;e++)if(s.blendWeight.data[4*i+e]>0){const t=s.blendIndices.data[4*i+e];let r=!0;for(let e=0;e<a;e++)if(n[e]===t){r=!1;break}if(r){n[a]=t;a+=-1===this.getBoneRemap(t)?1:0}}}if(this.boneIndices.length+a>i)return!1;for(let e=0;e<a;e++)this.boneIndices.push(n[e]);for(let i=0;i<r;i++)this.addVertex(e[i],t[i],s);return!0}getBoneRemap(e){for(let t=0;t<this.boneIndices.length;t++)if(this.boneIndices[t]===e)return t;return-1}}function dv(e,t,s){let i,n,a,r;!function(e){const t=e.vertices,s=e.skins,i=e.meshes,n=e.meshInstances;for(let e=0;e<i.length;e++)i[e].vertices=t[i[e].vertices],void 0!==i[e].skin&&(i[e].skin=s[i[e].skin]);for(let e=0;e<n.length;e++)n[e].mesh=i[n[e].mesh]}(e);const o=e.vertices,h=e.skins;let l;const c=e.meshes,d=e.meshInstances,u=function(e){const t=new lv;return t.index=e,t};for(i=h.length-1;i>=0;i--)if(h[i].boneNames.length>s){const e=h.splice(i,1)[0],p=[];for(n=0;n<c.length;n++)c[n].skin===e&&p.push(c[n]);for(n=0;n<p.length;n++)r=c.indexOf(p[n]),-1!==r&&c.splice(r,1);if(0===p.length)throw new Error("partitionSkin: There should be at least one mesh that references a skin");const m=p[0].vertices;for(n=1;n<p.length;n++)if(p[n].vertices!==m)throw new Error("partitionSkin: All meshes that share a skin should also share the same vertex buffer");let f;const _=[],g=[],y=[];let v=0;for(n=0;n<p.length;n++){l=p[n];const e=l.indices;for(let t=l.base;t<l.base+l.count;){r=e[t++],g[0]=u(r),y[0]=r,r=e[t++],g[1]=u(r),y[1]=r,r=e[t++],g[2]=u(r),y[2]=r;let i=!1;for(let e=v;e<_.length;e++)if(f=_[e],f.addPrimitive(g,y,m,s)){i=!0;break}i||(f=new cv,f.originalMesh=l,f.addPrimitive(g,y,m,s),_.push(f))}v=_.length}const x=[],b=[];for(n=0;n<_.length;n++)if(f=_[n],f.vertices.length&&f.indices.length){const e=x.length,t=f.vertices.length,s=b.length,i=f.indices.length;let a,r;for(f.partition=n,f.vertexStart=e,f.vertexCount=t,f.indexStart=s,f.indexCount=i,a=0,r=e;a<t;)x[r++]=f.vertices[a++];for(a=0,r=s;a<i;)b[r++]=f.indices[a++]+e}const S=[];for(n=0;n<_.length;n++){f=_[n];const t=[],s=[];for(a=0;a<f.boneIndices.length;a++)t.push(e.inverseBindMatrices[f.boneIndices[a]]),s.push(e.boneNames[f.boneIndices[a]]);const i={inverseBindMatrices:t,boneNames:s};S.push(i),h.push(i)}let w,T,M,C;const A={};for(T in m)A[T]={components:m[T].components,data:[],type:m[T].type};for(T in m)if("blendIndices"===T){const e=A[T].data;for(n=0;n<x.length;n++){const t=x[n].boneIndices;e.push(t[0],t[1],t[2],t[3])}}else for(w=m[T],M=w.data,C=w.components,n=0;n<x.length;n++)for(r=x[n].index,a=0;a<C;a++)A[T].data.push(M[r*C+a]);for(o[o.indexOf(m)]=A,n=0;n<_.length;n++)for(f=_[n],l={aabb:{min:[0,0,0],max:[0,0,0]},vertices:A,skin:S[n],indices:b.splice(0,f.indexCount),type:"triangles",base:0,count:f.indexCount},c.push(l),a=d.length-1;a>=0;a--)d[a].mesh===f.originalMesh&&(d.push({mesh:l,node:d[a].node}),t&&t.push({material:t[a].material,path:t[a].path}));for(n=0;n<_.length;n++)for(f=_[n],a=d.length-1;a>=0;a--)d[a].mesh===f.originalMesh&&(d.splice(a,1),t&&t.splice(a,1))}!function(e){const t=e.vertices,s=e.skins,i=e.meshes,n=e.meshInstances;for(let e=0;e<i.length;e++)i[e].vertices=t.indexOf(i[e].vertices),void 0!==i[e].skin&&(i[e].skin=s.indexOf(i[e].skin));for(let e=0;e<n.length;e++)n[e].mesh=i.indexOf(n[e].mesh)}(e)}const uv={points:0,lines:1,lineloop:2,linestrip:3,triangles:4,trianglestrip:5,trianglefan:6},pv={int8:0,uint8:1,int16:2,uint16:3,int32:4,uint32:5,float32:6};class mv{constructor(e,t){this._device=e,this._defaultMaterial=t}parse(e){const t=e.model;if(!t)return null;if(t.version<=1)return null;const s=this._parseNodes(e),i=this._parseSkins(e,s),n=this._parseVertexBuffers(e),a=this._parseIndexBuffers(e,n),r=this._parseMorphs(e,s,n),o=this._parseMeshes(e,i.skins,r.morphs,n,a.buffer,a.data),h=this._parseMeshInstances(e,s,o,i.skins,i.instances,r.morphs,r.instances),l=new rf;return l.graph=s[0],l.meshInstances=h,l.skinInstances=i.instances,l.morphInstances=r.instances,l.getGraph().syncHierarchy(),l}_parseNodes(e){const t=e.model,s=[];let i;for(i=0;i<t.nodes.length;i++){const e=t.nodes[i],n=new kh(e.name);n.setLocalPosition(e.position[0],e.position[1],e.position[2]),n.setLocalEulerAngles(e.rotation[0],e.rotation[1],e.rotation[2]),n.setLocalScale(e.scale[0],e.scale[1],e.scale[2]),n.scaleCompensation=!!e.scaleCompensation,s.push(n)}for(i=1;i<t.parents.length;i++)s[t.parents[i]].addChild(s[i]);return s}_parseSkins(e,t){const s=e.model,i=[],n=[];let a,r;if(!this._device.supportsBoneTextures&&s.skins.length>0){dv(s,null,this._device.getBoneLimit())}for(a=0;a<s.skins.length;a++){const e=s.skins[a],o=[];for(r=0;r<e.inverseBindMatrices.length;r++){const t=e.inverseBindMatrices[r];o[r]=(new Ce).set(t)}const h=new r_(this._device,o,e.boneNames);i.push(h);const l=new hd(h),c=[];for(r=0;r<h.boneNames.length;r++){const e=h.boneNames[r],s=t[0].findByName(e);c.push(s)}l.bones=c,n.push(l)}return{skins:i,instances:n}}_getMorphVertexCount(e,t,s){for(let i=0;i<e.meshes.length;i++){const n=e.meshes[i];if(n.morph===t){return s[n.vertices].numVertices}}}_parseMorphs(e,t,s){const i=e.model,n=[],a=[];let r,o,h,l,c,d;if(i.morphs){const e=function(e,t,s){const i=new Float32Array(3*s);for(let s=0;s<t.length;s++){const n=3*t[s];i[n]=e[3*s],i[n+1]=e[3*s+1],i[n+2]=e[3*s+2]}return i};for(r=0;r<i.morphs.length;r++){for(l=i.morphs[r].targets,d=[],h=this._getMorphVertexCount(i,r,s),o=0;o<l.length;o++){const t=l[o].aabb,s=t.min,i=t.max,n=new De(new ge(.5*(i[0]+s[0]),.5*(i[1]+s[1]),.5*(i[2]+s[2])),new ge(.5*(i[0]-s[0]),.5*(i[1]-s[1]),.5*(i[2]-s[2]))),a=l[o].indices;let r=l[o].deltaPositions,u=l[o].deltaNormals;a&&(r=e(r,a,h),u=e(u,a,h)),c=new of({deltaPositions:r,deltaNormals:u,name:l[o].name,aabb:n}),d.push(c)}const t=new nf(d,this._device);n.push(t);const u=new af(t);a.push(u)}}return{morphs:n,instances:a}}_parseVertexBuffers(e){const t=e.model,s=[],i={position:"POSITION",normal:"NORMAL",tangent:"TANGENT",blendWeight:"BLENDWEIGHT",blendIndices:"BLENDINDICES",color:"COLOR",texCoord0:"TEXCOORD0",texCoord1:"TEXCOORD1",texCoord2:"TEXCOORD2",texCoord3:"TEXCOORD3",texCoord4:"TEXCOORD4",texCoord5:"TEXCOORD5",texCoord6:"TEXCOORD6",texCoord7:"TEXCOORD7"};for(let e=0;e<t.vertices.length;e++){const n=t.vertices[e],a=[];for(const e in n){const t=n[e];a.push({semantic:i[e],components:t.components,type:pv[t.type],normalize:"COLOR"===i[e]})}const r=new go(this._device,a),o=n.position.data.length/n.position.components,h=new fo(this._device,r,o),l=new vc(h);for(let e=0;e<o;e++){for(const t in n){const s=n[t];switch(s.components){case 1:l.element[i[t]].set(s.data[e]);break;case 2:l.element[i[t]].set(s.data[2*e],1-s.data[2*e+1]);break;case 3:l.element[i[t]].set(s.data[3*e],s.data[3*e+1],s.data[3*e+2]);break;case 4:l.element[i[t]].set(s.data[4*e],s.data[4*e+1],s.data[4*e+2],s.data[4*e+3])}}l.next()}l.end(),s.push(h)}return s}_parseIndexBuffers(e,t){const s=e.model;let i,n=null,a=null,r=0;for(i=0;i<s.meshes.length;i++){const e=s.meshes[i];void 0!==e.indices&&(r+=e.indices.length)}let o=0;for(i=0;i<t.length;i++)o=Math.max(o,t[i].numVertices);return r>0&&(o>65535&&this._device.extUintElement?(n=new nc(this._device,2,r),a=new Uint32Array(n.lock())):(n=new nc(this._device,1,r),a=new Uint16Array(n.lock()))),{buffer:n,data:a}}_parseMeshes(e,t,s,i,n,a){const r=e.model,o=[];let h=0;for(let e=0;e<r.meshes.length;e++){const l=r.meshes[e],c=l.aabb,d=c.min,u=c.max,p=new De(new ge(.5*(u[0]+d[0]),.5*(u[1]+d[1]),.5*(u[2]+d[2])),new ge(.5*(u[0]-d[0]),.5*(u[1]-d[1]),.5*(u[2]-d[2]))),m=void 0!==l.indices,f=new Wc(this._device);f.vertexBuffer=i[l.vertices],f.indexBuffer[0]=m?n:null,f.primitive[0].type=uv[l.type],f.primitive[0].base=m?l.base+h:l.base,f.primitive[0].count=l.count,f.primitive[0].indexed=m,f.skin=void 0!==l.skin?t[l.skin]:null,f.morph=void 0!==l.morph?s[l.morph]:null,f.aabb=p,m&&(a.set(l.indices,h),h+=l.indices.length),o.push(f)}return null!==n&&n.unlock(),o}_parseMeshInstances(e,t,s,i,n,a,r){const o=e.model,h=[];let l;for(l=0;l<o.meshInstances.length;l++){const e=o.meshInstances[l],c=t[e.node],d=s[e.mesh],u=new xd(d,this._defaultMaterial,c);if(d.skin){const e=i.indexOf(d.skin);u.skinInstance=n[e]}if(d.morph){const e=a.indexOf(d.morph);u.morphInstance=r[e]}h.push(u)}return h}}class fv{constructor(e){this.handlerType="model",this._device=e.graphicsDevice,this._parsers=[],this._defaultMaterial=Tl(this._device),this.maxRetries=0,this.addParser(new mv(this._device,this._defaultMaterial),(function(e,t){return".json"===E.getExtension(e)})),this.addParser(new hv(this._device,this._defaultMaterial),(function(e,t){return".glb"===E.getExtension(e)}))}load(e,t){"string"==typeof e&&(e={load:e,original:e});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};(e.load.startsWith("blob:")||e.load.startsWith("data:"))&&(".glb"===E.getExtension(e.original).toLowerCase()?s.responseType=ae.ResponseType.ARRAY_BUFFER:s.responseType=ae.ResponseType.JSON),re.get(e.load,s,(function(s,i){t&&(s?t(`Error loading model: ${e.original} [${s}]`):t(null,i))}))}open(e,t){for(let s=0;s<this._parsers.length;s++){const i=this._parsers[s];if(i.decider(e,t))return i.parser.parse(t)}return null}patch(e,t){if(!e.resource)return;const s=e.data,i=this;e.resource.meshInstances.forEach((function(n,a){if(s.mapping){const r=function e(s){s.resource?n.material=s.resource:(s.once("load",e),t.load(s)),s.once("remove",(function(e){n.material===e.resource&&(n.material=i._defaultMaterial)}))};if(!s.mapping[a])return void(n.material=i._defaultMaterial);const o=s.mapping[a].material,h=s.mapping[a].path;let l;if(void 0!==o)o?(l=t.get(o),l?r(l):t.once("add:"+o,r)):n.material=i._defaultMaterial;else if(h){const i=e.getAbsoluteUrl(s.mapping[a].path);l=t.getByUrl(i),l?r(l):t.once("add:url:"+i,r)}}}))}addParser(e,t){this._parsers.push({parser:e,decider:t})}}function _v(e){const t=this;if(!t.resource)return;const s=e.resource,i=s.renders&&s.renders[t.data.renderIndex];i&&(t.resource.meshes=i.resource.meshes)}function gv(e){const t=this;t.registry.off("load:"+e.id,_v,t),t.registry.on("load:"+e.id,_v,t),t.registry.off("remove:"+e.id,yv,t),t.registry.once("remove:"+e.id,yv,t),e.resource?_v.call(t,e):t.registry.load(e)}function yv(e){const t=this;t.registry.off("load:"+e.id,_v,t),t.resource&&t.resource.destroy()}class vv{constructor(e){this.handlerType="render",this._registry=e.assets}load(e,t,s){}open(e,t){return new Hg}patch(e,t){if(!e.data.containerAsset)return;const s=t.get(e.data.containerAsset);s?gv.call(e,s):t.once("add:"+e.data.containerAsset,gv,e)}}class xv{load(e,t,s){throw new Error("not implemented")}open(e,t,s){throw new Error("not implemented")}patch(e,t){}}class bv{constructor(e){this.handlerType="scene",this._app=e,this.maxRetries=0}load(e,t){Jy(e,this.maxRetries,t)}open(e,t){this._app.systems.script.preloading=!0;const s=new Qy(this._app,!1).parse(t),i=this._app.scene;return i.root=s,this._app.applySceneSettings(t.settings),this._app.systems.script.preloading=!1,i}patch(e,t){}}class Sv{constructor(e){this._app=e,this.maxRetries=0}load(e,t){Jy(e,this.maxRetries,t)}open(e,t){return t.settings}}class wv{constructor(e){this.handlerType="shader",this.maxRetries=0}load(e,t){"string"==typeof e&&(e={load:e,original:e}),re.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(s,i){s?t(`Error loading shader resource: ${e.original} [${s}]`):t(null,i)}))}open(e,t){return t}patch(e,t){}}function Tv(e){const t=this;t.resource&&(t.resource.atlas=e.resource)}function Mv(e){this.registry.load(e)}class Cv{constructor(e){this.handlerType="sprite",this._assets=e.assets,this._device=e.graphicsDevice,this.maxRetries=0}load(e,t){"string"==typeof e&&(e={load:e,original:e}),".json"===E.getExtension(e.original)&&re.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(e,s){e?t(e):t(null,s)}))}open(e,t){const s=new l_(this._device);return e&&(s.__data=t),s}patch(e,t){const s=e.resource;if(s.__data&&(e.data.pixelsPerUnit=s.__data.pixelsPerUnit,e.data.renderMode=s.__data.renderMode,e.data.frameKeys=s.__data.frameKeys,s.__data.textureAtlasAsset)){const i=t.getByUrl(s.__data.textureAtlasAsset);i?e.data.textureAtlasAsset=i.id:console.warn("Could not find textureatlas with url: "+s.__data.textureAtlasAsset)}s.startUpdate(),s.renderMode=e.data.renderMode,s.pixelsPerUnit=e.data.pixelsPerUnit,s.frameKeys=e.data.frameKeys,this._updateAtlas(e),s.endUpdate(),e.off("change",this._onAssetChange,this),e.on("change",this._onAssetChange,this)}_updateAtlas(e){const t=e.resource;if(!e.data.textureAtlasAsset)return void(t.atlas=null);this._assets.off("load:"+e.data.textureAtlasAsset,Tv,e),this._assets.on("load:"+e.data.textureAtlasAsset,Tv,e);const s=this._assets.get(e.data.textureAtlasAsset);s&&s.resource?t.atlas=s.resource:s?this._assets.load(s):(this._assets.off("add:"+e.data.textureAtlasAsset,Mv,e),this._assets.on("add:"+e.data.textureAtlasAsset,Mv,e))}_onAssetChange(e,t,s,i){"data"===t&&s&&s.textureAtlasAsset&&i&&s.textureAtlasAsset!==i.textureAtlasAsset&&(this._assets.off("load:"+i.textureAtlasAsset,Tv,e),this._assets.off("add:"+i.textureAtlasAsset,Mv,e))}}class Av{constructor(e,t){this._app=e,this._data=t,this._templateRoot=null}instantiate(){return this._templateRoot||this._parseTemplate(),this._templateRoot.clone()}_parseTemplate(){const e=new Qy(this._app,!0);this._templateRoot=e.parse(this._data)}}class Pv{constructor(e){this.handlerType="template",this._app=e,this.maxRetries=0}load(e,t){"string"==typeof e&&(e={load:e,original:e});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};re.get(e.load,s,(function(s,i){s?t("Error requesting template: "+e.original):t(s,i)}))}open(e,t){return new Av(this._app,t)}}class Ev{constructor(e){this.handlerType="text",this.maxRetries=0}load(e,t){"string"==typeof e&&(e={load:e,original:e}),re.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(s,i){s?t(`Error loading text resource: ${e.original} [${s}]`):t(null,i)}))}open(e,t){return t}patch(e,t){}}class Rv{constructor(e,t){this.device=t,this.maxRetries=0}load(e,t,s){const i=this.device;um.fetchArrayBuffer(e.load,((n,a)=>{n?t(n):(n=>{var a,r,o;Ng(i,e.load,n,t,{isGGGR:0!=(8&(null==s||null==(a=s.file)||null==(r=a.variants)||null==(o=r.basis)?void 0:o.opt))})||t(`Basis module not found. Asset '${s.name}' basis texture variant will not be loaded.`)})(a)}),s,this.maxRetries)}open(e,t,s){const i=new fh(s,{name:e,addressU:t.cubemap?1:0,addressV:t.cubemap?1:0,width:t.width,height:t.height,format:t.format,cubemap:t.cubemap,levels:t.levels});return i.upload(),i}}class Lv{constructor(e){var t,s,i;this.crossOrigin=e.prefix?"anonymous":null,this.maxRetries=0;const n="webgpu"===(null==e||null==(t=e._loader)||null==(s=t._app)||null==(i=s.graphicsDevice)?void 0:i.deviceType);this.useImageBitmap=n}load(e,t,s){var i;const n=!(null==s||null==(i=s.file)||!i.contents);n&&(e={load:URL.createObjectURL(new Blob([s.file.contents])),original:e.original});const a=(s,i)=>{n&&URL.revokeObjectURL(e.load),t(s,i)};let r;s&&s.options&&s.options.hasOwnProperty("crossOrigin")?r=s.options.crossOrigin:jp.test(e.load)&&(r=this.crossOrigin),this.useImageBitmap?this._loadImageBitmap(e.load,e.original,r,a):this._loadImage(e.load,e.original,r,a)}open(e,t,s){const i=E.getExtension(e).toLowerCase(),n=".jpg"===i||".jpeg"===i?6:7,a=new fh(s,{name:e,width:t.width,height:t.height,format:n});return a.setSource(t),a}_loadImage(e,t,s,i){const n=new Image;s&&(n.crossOrigin=s);let a=0;const r=this.maxRetries;let o;n.onload=function(){i(null,n)},n.onerror=function(){if(!o)if(r>0&&++a<=r){const s=100*Math.pow(2,a);console.log(`Error loading Texture from: '${t}' - Retrying in ${s}ms...`);const i=e.indexOf("?")>=0?"&":"?";o=setTimeout((function(){n.src=e+i+"retry="+Date.now(),o=null}),s)}else i(`Error loading Texture from: '${t}'`)},n.src=e}_loadImageBitmap(e,t,s,i){const n={cache:!0,responseType:"blob",retry:this.maxRetries>0,maxRetries:this.maxRetries};re.get(e,n,(function(e,t){e?i(e):createImageBitmap(t,{premultiplyAlpha:"none"}).then((e=>i(null,e))).catch((e=>i(e)))}))}}const Iv=[1481919403,3140563232,169478669],Dv={33776:8,33778:9,33779:10,36196:21,37492:22,37496:23,35840:26,35841:24,35842:27,35843:25,32849:6,32856:7,35905:19,35907:20,35898:18,34843:11,34842:12};class Ov{constructor(e){this.maxRetries=0}load(e,t,s){um.fetchArrayBuffer(e.load,t,s,this.maxRetries)}open(e,t,s){const i=this.parse(t);if(!i)return null;const n=new fh(s,{name:e,addressU:i.cubemap?1:0,addressV:i.cubemap?1:0,width:i.width,height:i.height,format:i.format,cubemap:i.cubemap,levels:i.levels});return n.upload(),n}parse(e){const t=new Uint32Array(e);if(Iv[0]!==t[0]||Iv[1]!==t[1]||Iv[2]!==t[2])return null;const s={endianness:t[3],glType:t[4],glTypeSize:t[5],glFormat:t[6],glInternalFormat:t[7],glBaseInternalFormat:t[8],pixelWidth:t[9],pixelHeight:t[10],pixelDepth:t[11],numberOfArrayElements:t[12],numberOfFaces:t[13],numberOfMipmapLevels:t[14],bytesOfKeyValueData:t[15]};if(s.pixelDepth>1)return null;if(0!==s.numberOfArrayElements)return null;const i=Dv[s.glInternalFormat];if(void 0===i)return null;let n=16+s.bytesOfKeyValueData/4;const a=s.numberOfFaces>1,r=[];for(let c=0;c<(s.numberOfMipmapLevels||1);c++){const s=t[n++];a&&r.push([]);const d=a?r[c]:r;for(let t=0;t<(a?6:1);++t)d.push((o=e,h=4*n,l=s,18===i?new Uint32Array(o,h,l/4):new Uint8Array(o,h,l))),n+=s+3>>2}var o,h,l;return{format:i,width:s.pixelWidth,height:s.pixelHeight,levels:r,cubemap:a}}}const Fv=166;class kv{constructor(e,t){this.maxRetries=0,this.device=t}load(e,t,s){um.fetchArrayBuffer(e.load,((i,n)=>{i?t(i,n):this.parse(n,e,t,s)}),s,this.maxRetries)}open(e,t,s){const i=new fh(s,{name:e,addressU:t.cubemap?1:0,addressV:t.cubemap?1:0,width:t.width,height:t.height,format:t.format,cubemap:t.cubemap,levels:t.levels});return i.upload(),i}parse(e,t,s,i){const n=new $(e),a=[n.readU32be(),n.readU32be(),n.readU32be()];if(2873840728!==a[0]||540160187!==a[1]||218765834!==a[2])return null;const r={vkFormat:n.readU32(),typeSize:n.readU32(),pixelWidth:n.readU32(),pixelHeight:n.readU32(),pixelDepth:n.readU32(),layerCount:n.readU32(),faceCount:n.readU32(),levelCount:n.readU32(),supercompressionScheme:n.readU32()},o={dfdByteOffset:n.readU32(),dfdByteLength:n.readU32(),kvdByteOffset:n.readU32(),kvdByteLength:n.readU32(),sgdByteOffset:n.readU64(),sgdByteLength:n.readU64()},h=[];for(let e=0;e<Math.max(1,r.levelCount);++e)h.push({byteOffset:n.readU64(),byteLength:n.readU64(),uncompressedByteLength:n.readU64()});if(n.readU32()!==o.kvdByteOffset-o.dfdByteOffset)return null;n.skip(8);const l=n.readU8();if(n.skip(o.dfdByteLength-9),n.skip(o.kvdByteLength),1===r.supercompressionScheme||l===Fv){var c,d,u;Ng(this.device,t.load,e,s,{isGGGR:0!=(8&(null==i||null==(c=i.file)||null==(d=c.variants)||null==(u=d.basis)?void 0:u.opt)),isKTX2:!0})||s('Basis module not found. Asset "'+i.name+'" basis texture variant will not be loaded.')}else s("unsupported KTX2 pixel format")}}class Bv{constructor(e){this.maxRetries=0}load(e,t,s){um.fetchArrayBuffer(e.load,t,s,this.maxRetries)}open(e,t,s){const i=new Uint32Array(t,0,32),n=i[4],a=i[3],r=Math.max(i[7],1),o=4===i[20],h=i[21],l=i[22],c=65024===i[28],d=827611204,u=825438800,p=825439312;let m,f=!1,_=!1,g=!1,y=!1,v=null,x=1;if(o?h===d?(v=8,f=!0):894720068===h?(v=10,f=!0):113===h?(v=12,x=2):116===h?(v=14,x=4):826496069===h?(v=21,f=!0,_=!0):h===u||825504336===h?(v=h===u?24:25,f=!0,g=!0):h!==p&&825504848!==h||(v=h===p?26:27,f=!0,y=!0):32===l&&(v=7),!v)return m=new fh(s,{width:4,height:4,format:6,name:"dds-legacy-empty"}),m;m=new fh(s,{name:e,addressU:c?1:0,addressV:c?1:0,width:n,height:a,format:v,cubemap:c,mipmaps:r>1});let b=128;const S=c?6:1;let w;const T=h===d?8:16;let M,C,A;for(let e=0;e<S;e++){let s=n,i=a;for(let n=0;n<r;n++){f?_?w=Math.floor((s+3)/4)*Math.floor((i+3)/4)*8:g?w=Math.max(s,16)*Math.max(i,8)/4:y?w=Math.max(s,8)*Math.max(i,8)/2:(M=Math.floor((s+4-1)/4),C=Math.floor((i+4-1)/4),A=M*C,w=A*T):w=s*i*4;const a=14===v?new Float32Array(t,b,w):12===v?new Uint16Array(t,b,w):new Uint8Array(t,b,w);c?(m._levels[n]||(m._levels[n]=[]),m._levels[n][e]=a):m._levels[n]=a,b+=w*x,s=Math.max(.5*s,1),i=Math.max(.5*i,1)}}return m.upload(),m}}class zv{constructor(e){this.maxRetries=0}load(e,t,s){um.fetchArrayBuffer(e.load,t,s,this.maxRetries)}open(e,t,s){const i=this.parse(t);if(!i)return null;const n=new fh(s,{name:e,addressU:0,addressV:1,minFilter:0,magFilter:0,width:i.width,height:i.height,levels:i.levels,format:7,type:"rgbe",mipmaps:!1});return n.upload(),n}parse(e){const t=new $(e);if(!t.readLine().startsWith("#?RADIANCE"))return null;const s={};for(;;){const e=t.readLine();if(0===e.length)break;{const t=e.split("=");2===t.length&&(s[t[0]]=t[1])}}if(!s.hasOwnProperty("FORMAT"))return null;const i=t.readLine().split(" ");if(4!==i.length)return null;const n=parseInt(i[1],10),a=parseInt(i[3],10),r=this._readPixels(t,a,n,"-Y"===i[0]);return r?{width:a,height:n,levels:[r]}:null}_readPixels(e,t,s,i){if(t<8||t>32767)return this._readPixelsFlat(e,t,s);const n=[0,0,0,0];if(e.readArray(n),2!==n[0]||2!==n[1]||0!=(128&n[2]))return e.skip(-4),this._readPixelsFlat(e,t,s);const a=new ArrayBuffer(t*s*4),r=new Uint8Array(a);let o,h,l,c,d,u,p=i?0:4*t*(s-1);for(h=0;h<s;++h){if(h&&e.readArray(n),(n[2]<<8)+n[3]!==t)return null;for(c=0;c<4;++c)for(o=0;o<t;)if(d=e.readU8(),d>128){if(d-=128,o+d>t)return null;for(u=e.readU8(),l=0;l<d;++l)r[p+c+4*o++]=u}else{if(0===d||o+d>t)return null;for(l=0;l<d;++l)r[p+c+4*o++]=e.readU8()}p+=4*t*(i?1:-1)}return r}_readPixelsFlat(e,t,s){return e.remainingBytes===t*s*4?new Uint8Array(e.arraybuffer,e.offset):null}}const Uv={repeat:0,clamp:1,mirror:2},Vv={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},Nv={default:"default",rgbm:"rgbm",rgbe:"rgbe",rgbp:"rgbp",swizzleGGGR:"swizzleGGGR"};class Gv{load(e,t,s){throw new Error("not implemented")}open(e,t,s){throw new Error("not implemented")}}class Wv{constructor(e){this.handlerType="texture";const t=e.assets,s=e.graphicsDevice;this._device=s,this._assets=t,this._loader=e.loader,this.imgParser=new Lv(t),this.parsers={dds:new Bv(t),ktx:new Ov(t),ktx2:new kv(t,s),basis:new Rv(t,s),hdr:new zv(t)}}set crossOrigin(e){this.imgParser.crossOrigin=e}get crossOrigin(){return this.imgParser.crossOrigin}set maxRetries(e){this.imgParser.maxRetries=e;for(const t in this.parsers)this.parsers.hasOwnProperty(t)&&(this.parsers[t].maxRetries=e)}get maxRetries(){return this.imgParser.maxRetries}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}_getParser(e){const t=E.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".","");return this.parsers[t]||this.imgParser}load(e,t,s){"string"==typeof e&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,s)}open(e,t,s){if(!e)return;let i=this._getParser(e).open(e,t,this._device);return null===i?i=new fh(this._device,{width:4,height:4,format:6}):(!function(e){const t=Math.log2(Math.max(e._width,e._height))+1;if(7!==e._format&&14!==e._format||e._volume||e._compressed||1===e._levels.length||e._levels.length===t||(s=e._cubemap?e._levels[0][0]:e._levels[0])instanceof HTMLCanvasElement||s instanceof HTMLImageElement||s instanceof HTMLVideoElement)return;var s;const i=function(e,t,s){const i=Math.max(1,e>>1),n=Math.max(1,t>>1),a=new s.constructor(i*n*4),r=Math.floor(e/i),o=Math.floor(t/n),h=r*o;for(let t=0;t<n;++t)for(let n=0;n<i;++n)for(let l=0;l<4;++l){let c=0;for(let i=0;i<o;++i)for(let a=0;a<r;++a)c+=s[4*(n*r+a+(t*o+i)*e)+l];a[4*(n+t*i)+l]=c/h}return a};for(let s=e._levels.length;s<t;++s){const t=Math.max(1,e._width>>s-1),n=Math.max(1,e._height>>s-1);if(e._cubemap){const a=[];for(let r=0;r<6;++r)a.push(i(t,n,e._levels[s-1][r]));e._levels.push(a)}else e._levels.push(i(t,n,e._levels[s-1]))}e._levelsUpdated=e._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0]}(i),t.unswizzledGGGR&&(s.file.variants.basis.opt&=-9)),i}patch(e,t){const s=e.resource;if(!s)return;e.name&&e.name.length>0&&(s.name=e.name);const i=e.data;i.hasOwnProperty("minfilter")&&(s.minFilter=Vv[i.minfilter]),i.hasOwnProperty("magfilter")&&(s.magFilter=Vv[i.magfilter]),s.cubemap||(i.hasOwnProperty("addressu")&&(s.addressU=Uv[i.addressu]),i.hasOwnProperty("addressv")&&(s.addressV=Uv[i.addressv])),i.hasOwnProperty("mipmaps")&&(s.mipmaps=i.mipmaps),i.hasOwnProperty("anisotropy")&&(s.anisotropy=i.anisotropy),i.hasOwnProperty("flipY")&&(s.flipY=!!i.flipY),i.hasOwnProperty("type")?s.type=Nv[i.type]:i.hasOwnProperty("rgbm")&&i.rgbm?s.type="rgbm":e.file&&0!=(8&e.file.opt)&&(s.type="swizzleGGGR")}}const Hv={repeat:0,clamp:1,mirror:2},Xv={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},qv=/^data\.frames\.(\d+)$/;class jv{constructor(e){this.handlerType="textureatlas",this._loader=e.loader,this.maxRetries=0}load(e,t){"string"==typeof e&&(e={load:e,original:e});const s=this,i=this._loader.getHandler("texture");if(".json"!==E.getExtension(e.original))return i.load(e,t);re.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(i,n){if(i)t(i);else{const i=e.original.replace(".json",".png");s._loader.load(i,"texture",(function(e,s){e?t(e):t(null,{data:n,texture:s})}))}}))}open(e,t){const s=new d_;if(t.texture&&t.data)s.texture=t.texture,s.__data=t.data;else{const i=this._loader.getHandler("texture").open(e,t);if(!i)return null;s.texture=i}return s}patch(e,t){if(!e.resource)return;e.resource.__data&&(void 0!==e.resource.__data.minfilter&&(e.data.minfilter=e.resource.__data.minfilter),void 0!==e.resource.__data.magfilter&&(e.data.magfilter=e.resource.__data.magfilter),void 0!==e.resource.__data.addressu&&(e.data.addressu=e.resource.__data.addressu),void 0!==e.resource.__data.addressv&&(e.data.addressv=e.resource.__data.addressv),void 0!==e.resource.__data.mipmaps&&(e.data.mipmaps=e.resource.__data.mipmaps),void 0!==e.resource.__data.anisotropy&&(e.data.anisotropy=e.resource.__data.anisotropy),void 0!==e.resource.__data.rgbm&&(e.data.rgbm=!!e.resource.__data.rgbm),e.data.frames=e.resource.__data.frames,delete e.resource.__data);const s=e.resource.texture;if(s&&(s.name=e.name,e.data.hasOwnProperty("minfilter")&&s.minFilter!==Xv[e.data.minfilter]&&(s.minFilter=Xv[e.data.minfilter]),e.data.hasOwnProperty("magfilter")&&s.magFilter!==Xv[e.data.magfilter]&&(s.magFilter=Xv[e.data.magfilter]),e.data.hasOwnProperty("addressu")&&s.addressU!==Hv[e.data.addressu]&&(s.addressU=Hv[e.data.addressu]),e.data.hasOwnProperty("addressv")&&s.addressV!==Hv[e.data.addressv]&&(s.addressV=Hv[e.data.addressv]),e.data.hasOwnProperty("mipmaps")&&s.mipmaps!==e.data.mipmaps&&(s.mipmaps=e.data.mipmaps),e.data.hasOwnProperty("anisotropy")&&s.anisotropy!==e.data.anisotropy&&(s.anisotropy=e.data.anisotropy),e.data.hasOwnProperty("rgbm"))){const t=e.data.rgbm?"rgbm":"default";s.type!==t&&(s.type=t)}e.resource.texture=s;const i={};for(const t in e.data.frames){const s=e.data.frames[t];i[t]={rect:new xe(s.rect),pivot:new ve(s.pivot),border:new xe(s.border)}}e.resource.frames=i,e.off("change",this._onAssetChange,this),e.on("change",this._onAssetChange,this)}_onAssetChange(e,t,s){let i;if("data"===t||"data.frames"===t){const t={};for(const e in s.frames)i=s.frames[e],t[e]={rect:new xe(i.rect),pivot:new ve(i.pivot),border:new xe(i.border)};e.resource.frames=t}else{const n=t.match(qv);if(n){const t=n[1];s?(e.resource.frames[t]?(i=e.resource.frames[t],i.rect.set(s.rect[0],s.rect[1],s.rect[2],s.rect[3]),i.pivot.set(s.pivot[0],s.pivot[1]),i.border.set(s.border[0],s.border[1],s.border[2],s.border[3])):e.resource.frames[t]={rect:new xe(s.rect),pivot:new ve(s.pivot),border:new xe(s.border)},e.resource.fire("set:frame",t,e.resource.frames[t])):e.resource.frames[t]&&(delete e.resource.frames[t],e.resource.fire("remove:frame",t))}}}}class Yv extends C{constructor(e,t){super(),this._assets=new Set,this._loadingAssets=new Set,this._waitingAssets=new Set,this._registry=t,this._loading=!1,this._loaded=!1,this._failed=[],e.forEach((e=>{if(e instanceof um)e.registry||(e.registry=t),this._assets.add(e);else{const s=t.get(e);s?this._assets.add(s):this._waitForAsset(e)}}))}destroy(){const e=this;this._registry.off("load",this._onLoad),this._registry.off("error",this._onError),this._waitingAssets.forEach((function(t){e._registry.off("add:"+t,this._onAddAsset)})),this.off("progress"),this.off("load")}_assetHasDependencies(e){var t;return"model"===e.type&&(null==(t=e.file)?void 0:t.url)&&e.file.url&&e.file.url.match(/.json$/g)}load(e,t){if(this._loading)return;this._loading=!0,this._callback=e,this._scope=t,this._registry.on("load",this._onLoad,this),this._registry.on("error",this._onError,this);let s=!1;this._assets.forEach((e=>{e.loaded||(s=!0,this._assetHasDependencies(e)&&this._registry.loadFromUrl(e.file.url,e.type,((t,s)=>{t?this._onError(t,e):this._onLoad(e)})),this._loadingAssets.add(e),this._registry.add(e))})),this._loadingAssets.forEach((e=>{this._assetHasDependencies(e)||this._registry.load(e)})),s||0!==this._waitingAssets.size||this._loadingComplete()}ready(e,t=this){this._loaded?e.call(t,Array.from(this._assets)):this.once("load",(function(s){e.call(t,s)}))}_loadingComplete(){this._loaded||(this._loaded=!0,this._registry.off("load",this._onLoad,this),this._registry.off("error",this._onError,this),this._failed.length?(this._callback&&this._callback.call(this._scope,"Failed to load some assets",this._failed),this.fire("error",this._failed)):(this._callback&&this._callback.call(this._scope),this.fire("load",Array.from(this._assets))))}_onLoad(e){this._loadingAssets.has(e)&&(this.fire("progress",e),this._loadingAssets.delete(e)),0===this._loadingAssets.size&&setTimeout((()=>{this._loadingComplete(this._failed)}),0)}_onError(e,t){this._loadingAssets.has(t)&&(this._failed.push(t),this._loadingAssets.delete(t)),0===this._loadingAssets.size&&setTimeout((()=>{this._loadingComplete(this._failed)}),0)}_onAddAsset(e){this._waitingAssets.delete(e),this._assets.add(e),e.loaded||(this._loadingAssets.add(e),this._registry.load(e))}_waitForAsset(e){this._waitingAssets.add(e),this._registry.once("add:"+e,this._onAddAsset,this)}}class $v extends C{constructor(e){super(),this._app=e,e.i18n.on("set:locale",this._onSetLocale,this),this._autoLoad=!1,this._disableLocalization=!1,this._defaultAsset=null,this._localizedAsset=null}set defaultAsset(e){const t=e instanceof um?e.id:e;this._defaultAsset!==t&&(this._defaultAsset&&this._unbindDefaultAsset(),this._defaultAsset=t,this._defaultAsset&&this._bindDefaultAsset(),this._onSetLocale(this._app.i18n.locale))}get defaultAsset(){return this._defaultAsset}set localizedAsset(e){const t=e instanceof um?e.id:e;if(this._localizedAsset!==t&&(this._localizedAsset&&(this._app.assets.off("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this),this._unbindLocalizedAsset(),this._localizedAsset=null),this._localizedAsset=t,this._localizedAsset)){this._app.assets.get(this._localizedAsset)?this._bindLocalizedAsset():this._app.assets.once("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this)}}get localizedAsset(){return this._localizedAsset}set autoLoad(e){this._autoLoad!==e&&(this._autoLoad=e,this._autoLoad&&this._localizedAsset&&(this._unbindLocalizedAsset(),this._bindLocalizedAsset()))}get autoLoad(){return this._autoLoad}set disableLocalization(e){this._disableLocalization!==e&&(this._disableLocalization=e,this._onSetLocale(this._app.i18n.locale))}get disableLocalization(){return this._disableLocalization}_bindDefaultAsset(){const e=this._app.assets.get(this._defaultAsset);e?this._onDefaultAssetAdd(e):this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this)}_unbindDefaultAsset(){if(!this._defaultAsset)return;this._app.assets.off("add:"+this._defaultAsset,this._onDefaultAssetAdd,this);const e=this._app.assets.get(this._defaultAsset);e&&(e.off("add:localized",this._onLocaleAdd,this),e.off("remove:localized",this._onLocaleRemove,this),e.off("remove",this._onDefaultAssetRemove,this))}_onDefaultAssetAdd(e){this._defaultAsset===e.id&&(e.on("add:localized",this._onLocaleAdd,this),e.on("remove:localized",this._onLocaleRemove,this),e.once("remove",this._onDefaultAssetRemove,this))}_onDefaultAssetRemove(e){this._defaultAsset===e.id&&(e.off("add:localized",this._onLocaleAdd,this),e.off("remove:localized",this._onLocaleAdd,this),this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this))}_bindLocalizedAsset(){if(!this._autoLoad)return;const e=this._app.assets.get(this._localizedAsset);e&&(e.on("load",this._onLocalizedAssetLoad,this),e.on("change",this._onLocalizedAssetChange,this),e.on("remove",this._onLocalizedAssetRemove,this),e.resource?this._onLocalizedAssetLoad(e):this._app.assets.load(e))}_unbindLocalizedAsset(){const e=this._app.assets.get(this._localizedAsset);e&&(e.off("load",this._onLocalizedAssetLoad,this),e.off("change",this._onLocalizedAssetChange,this),e.off("remove",this._onLocalizedAssetRemove,this))}_onLocalizedAssetAdd(e){this._localizedAsset===e.id&&this._bindLocalizedAsset()}_onLocalizedAssetLoad(e){this.fire("load",e)}_onLocalizedAssetChange(e,t,s,i){this.fire("change",e,t,s,i)}_onLocalizedAssetRemove(e){this._localizedAsset===e.id&&(this.localizedAsset=this._defaultAsset),this.fire("remove",e)}_onLocaleAdd(e,t){this._app.i18n.locale===e&&this._onSetLocale(e)}_onLocaleRemove(e,t){this._app.i18n.locale===e&&this._onSetLocale(e)}_onSetLocale(e){if(!this._defaultAsset)return void(this.localizedAsset=null);const t=this._app.assets.get(this._defaultAsset);if(!t||this._disableLocalization)return void(this.localizedAsset=this._defaultAsset);const s=t.getLocalizedAssetId(e);this.localizedAsset=s||this._defaultAsset}destroy(){this.defaultAsset=null,this._app.i18n.off("set:locale",this._onSetLocale,this),this.off()}}const Kv=new Set(["system","entity","create","destroy","swap","move","scripts","_scripts","_scriptsIndex","_scriptsData","enabled","_oldState","onEnable","onDisable","onPostStateChange","_onSetEnabled","_checkState","_onBeforeRemove","_onInitializeAttributes","_onInitialize","_onPostInitialize","_onUpdate","_onPostUpdate","_callbacks","has","get","on","off","fire","once","hasEvent"]);function Zv(e,t){if(gm.legacy)return null;if(Kv.has(e))throw new Error(`script name: '${e}' is reserved, please change script name`);const s=function(e){C.prototype.initEventHandler.call(this),Am.prototype.initScriptType.call(this,e)};return(s.prototype=Object.create(Am.prototype)).constructor=s,s.extend=Am.extend,s.attributes=new wm(s),Jv(s,e,t),s}const Qv={};function Jv(e,t,s){if(e.legacy)return;if("function"!=typeof e)throw new Error(`script class: '${e}' must be a constructor function (i.e. class).`);if(!(e.prototype instanceof Am))throw new Error(`script class: '${Am.__getScriptName(e)}' does not extend pc.ScriptType.`);if(t=t||e.__name||Am.__getScriptName(e),Kv.has(t))throw new Error(`script name: '${t}' is reserved, please change script name`);e.__name=t;(s?s.scripts:Xm.getApplication().scripts).add(e),mm._push(e)}wm.reservedNames.forEach(((e,t,s)=>{Qv[e]=1})),Zv.reservedAttributes=Qv;const ex="mouse",tx="keyboard",sx="gamepad",ix="mousex",nx="mousey",ax="padlx",rx="padly",ox="padrx",hx="padry",lx="key",cx="keydown",dx="keyup",ux="mousedown",px="mousemove",mx="mouseup",fx="mousewheel",_x="touchstart",gx="touchend",yx="touchmove",vx="touchcancel",xx="select",bx="selectstart",Sx="selectend",wx=8,Tx=9,Mx=13,Cx=13,Ax=16,Px=17,Ex=18,Rx=19,Lx=20,Ix=27,Dx=32,Ox=33,Fx=34,kx=35,Bx=36,zx=37,Ux=38,Vx=39,Nx=40,Gx=44,Wx=45,Hx=46,Xx=48,qx=49,jx=50,Yx=51,$x=52,Kx=53,Zx=54,Qx=55,Jx=56,eb=57,tb=59,sb=61,ib=65,nb=66,ab=67,rb=68,ob=69,hb=70,lb=71,cb=72,db=73,ub=74,pb=75,mb=76,fb=77,_b=78,gb=79,yb=80,vb=81,xb=82,bb=83,Sb=84,wb=85,Tb=86,Mb=87,Cb=88,Ab=89,Pb=90,Eb=91,Rb=93,Lb=96,Ib=97,Db=98,Ob=99,Fb=100,kb=101,Bb=102,zb=103,Ub=104,Vb=105,Nb=106,Gb=107,Wb=108,Hb=109,Xb=110,qb=111,jb=112,Yb=113,$b=114,Kb=115,Zb=116,Qb=117,Jb=118,eS=119,tS=120,sS=121,iS=122,nS=123,aS=188,rS=190,oS=191,hS=219,lS=220,cS=221,dS=224,uS=-1,pS=0,mS=1,fS=2,_S=0,gS=1,yS=2,vS=3,xS=0,bS=1,SS=2,wS=3,TS=4,MS=5,CS=6,AS=7,PS=8,ES=9,RS=10,LS=11,IS=12,DS=13,OS=14,FS=15,kS=16,BS=0,zS=1,US=2,VS=3;class NS{constructor(e,t){t?(this.key=t.keyCode,this.element=t.target,this.event=t):(this.key=null,this.element=null,this.event=null)}}const GS=new NS;function WS(e){return GS.key=e.keyCode,GS.element=e.target,GS.event=e,GS}function HS(e){return"string"==typeof e?e.toUpperCase().charCodeAt(0):e}const XS={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"};class qS extends C{constructor(e,t={}){super(),this._element=null,this._keyDownHandler=this._handleKeyDown.bind(this),this._keyUpHandler=this._handleKeyUp.bind(this),this._keyPressHandler=this._handleKeyPress.bind(this),this._visibilityChangeHandler=this._handleVisibilityChange.bind(this),this._windowBlurHandler=this._handleWindowBlur.bind(this),this._keymap={},this._lastmap={},e&&this.attach(e),this.preventDefault=t.preventDefault||!1,this.stopPropagation=t.stopPropagation||!1}attach(e){this._element&&this.detach(),this._element=e,this._element.addEventListener("keydown",this._keyDownHandler,!1),this._element.addEventListener("keypress",this._keyPressHandler,!1),this._element.addEventListener("keyup",this._keyUpHandler,!1),document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.addEventListener("blur",this._windowBlurHandler,!1)}detach(){this._element&&(this._element.removeEventListener("keydown",this._keyDownHandler),this._element.removeEventListener("keypress",this._keyPressHandler),this._element.removeEventListener("keyup",this._keyUpHandler),this._element=null,document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.removeEventListener("blur",this._windowBlurHandler,!1))}toKeyIdentifier(e){e=HS(e);const t=XS[e.toString()];if(t)return t;let s=e.toString(16).toUpperCase();const i=s.length;for(let e=0;e<4-i;e++)s="0"+s;return"U+"+s}_handleKeyDown(e){const t=e.keyCode||e.charCode;if(void 0===t)return;const s=this.toKeyIdentifier(t);this._keymap[s]=!0,this.fire("keydown",WS(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation()}_handleKeyUp(e){const t=e.keyCode||e.charCode;if(void 0===t)return;const s=this.toKeyIdentifier(t);delete this._keymap[s],this.fire("keyup",WS(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation()}_handleKeyPress(e){this.fire("keypress",WS(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation()}_handleVisibilityChange(){"hidden"===document.visibilityState&&this._handleWindowBlur()}_handleWindowBlur(){this._keymap={},this._lastmap={}}update(){for(const e in this._lastmap)delete this._lastmap[e];for(const e in this._keymap)this._keymap.hasOwnProperty(e)&&(this._lastmap[e]=this._keymap[e])}isPressed(e){const t=HS(e),s=this.toKeyIdentifier(t);return!!this._keymap[s]}wasPressed(e){const t=HS(e),s=this.toKeyIdentifier(t);return!!this._keymap[s]&&!this._lastmap[s]}wasReleased(e){const t=HS(e),s=this.toKeyIdentifier(t);return!this._keymap[s]&&!!this._lastmap[s]}}function jS(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)}class YS{constructor(e,t){let s={x:0,y:0};if(t){if(t instanceof YS)throw Error("Expected MouseEvent");s=e._getTargetCoords(t)}else t={};if(s)this.x=s.x,this.y=s.y;else{if(!jS())return;this.x=0,this.y=0}this.wheelDelta=0,"wheel"===t.type&&(t.deltaY>0?this.wheelDelta=1:t.deltaY<0&&(this.wheelDelta=-1)),jS()?(this.dx=t.movementX||t.webkitMovementX||t.mozMovementX||0,this.dy=t.movementY||t.webkitMovementY||t.mozMovementY||0):(this.dx=this.x-e._lastX,this.dy=this.y-e._lastY),"mousedown"===t.type||"mouseup"===t.type?this.button=t.button:this.button=-1,this.buttons=e._buttons.slice(0),this.element=t.target,this.ctrlKey=t.ctrlKey||!1,this.altKey=t.altKey||!1,this.shiftKey=t.shiftKey||!1,this.metaKey=t.metaKey||!1,this.event=t}}class $S extends C{constructor(e){super(),this._lastX=0,this._lastY=0,this._buttons=[!1,!1,!1],this._lastbuttons=[!1,!1,!1],this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._contextMenuHandler=e=>{e.preventDefault()},this._target=null,this._attached=!1,this.attach(e)}static isPointerLocked(){return jS()}attach(e){if(this._target=e,this._attached)return;this._attached=!0;const t=!!N.passiveEvents&&{passive:!1};window.addEventListener("mouseup",this._upHandler,t),window.addEventListener("mousedown",this._downHandler,t),window.addEventListener("mousemove",this._moveHandler,t),window.addEventListener("wheel",this._wheelHandler,t)}detach(){if(!this._attached)return;this._attached=!1,this._target=null;const e=!!N.passiveEvents&&{passive:!1};window.removeEventListener("mouseup",this._upHandler,e),window.removeEventListener("mousedown",this._downHandler,e),window.removeEventListener("mousemove",this._moveHandler,e),window.removeEventListener("wheel",this._wheelHandler,e)}disableContextMenu(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler)}enableContextMenu(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)}enablePointerLock(e,t){if(!document.body.requestPointerLock)return void(t&&t());const s=()=>{e(),document.removeEventListener("pointerlockchange",s)},i=()=>{t(),document.removeEventListener("pointerlockerror",i)};e&&document.addEventListener("pointerlockchange",s,!1),t&&document.addEventListener("pointerlockerror",i,!1),document.body.requestPointerLock()}disablePointerLock(e){if(!document.exitPointerLock)return;const t=()=>{e(),document.removeEventListener("pointerlockchange",t)};e&&document.addEventListener("pointerlockchange",t,!1),document.exitPointerLock()}update(){this._lastbuttons[0]=this._buttons[0],this._lastbuttons[1]=this._buttons[1],this._lastbuttons[2]=this._buttons[2]}isPressed(e){return this._buttons[e]}wasPressed(e){return this._buttons[e]&&!this._lastbuttons[e]}wasReleased(e){return!this._buttons[e]&&this._lastbuttons[e]}_handleUp(e){this._buttons[e.button]=!1;const t=new YS(this,e);t.event&&this.fire("mouseup",t)}_handleDown(e){this._buttons[e.button]=!0;const t=new YS(this,e);t.event&&this.fire("mousedown",t)}_handleMove(e){const t=new YS(this,e);t.event&&(this.fire("mousemove",t),this._lastX=t.x,this._lastY=t.y)}_handleWheel(e){const t=new YS(this,e);t.event&&this.fire("mousewheel",t)}_getTargetCoords(e){const t=this._target.getBoundingClientRect(),s=Math.floor(t.left),i=Math.floor(t.top);return e.clientX<s||e.clientX>=s+this._target.clientWidth||e.clientY<i||e.clientY>=i+this._target.clientHeight?null:{x:e.clientX-s,y:e.clientY-i}}}class KS{constructor(e,t={}){this._keyboard=t.keyboard||null,this._mouse=t.mouse||null,this._gamepads=t.gamepads||null,this._element=null,this._actions={},this._axes={},this._axesValues={},e&&this.attach(e)}attach(e){this._element=e,this._keyboard&&this._keyboard.attach(e),this._mouse&&this._mouse.attach(e)}detach(){this._keyboard&&this._keyboard.detach(),this._mouse&&this._mouse.detach(),this._element=null}disableContextMenu(){this._mouse||this._enableMouse(),this._mouse.disableContextMenu()}enableContextMenu(){this._mouse||this._enableMouse(),this._mouse.enableContextMenu()}update(e){this._keyboard&&this._keyboard.update(),this._mouse&&this._mouse.update(),this._gamepads&&this._gamepads.update(),this._axesValues={};for(const e in this._axes)this._axesValues[e]=[]}appendAction(e,t){this._actions[e]=this._actions[e]||[],this._actions[e].push(t)}registerKeys(e,t){if(this._keyboard||this._enableKeyboard(),this._actions[e])throw new Error(`Action: ${e} already registered`);if(void 0===t)throw new Error("Invalid button");t.length||(t=[t]),this.appendAction(e,{type:"keyboard",keys:t})}registerMouse(e,t){if(this._mouse||this._enableMouse(),void 0===t)throw new Error("Invalid button");this.appendAction(e,{type:"mouse",button:t})}registerPadButton(e,t,s){if(void 0===s)throw new Error("Invalid button");this.appendAction(e,{type:"gamepad",button:s,pad:t})}registerAxis(e){const t=e.name;this._axes[t]||(this._axes[t]=[]);const s=this._axes[t].push(t);(e=e||{}).pad=e.pad||0;const i=function(i,n,a,r){switch(n){case"mousex":i._mouse.on("mousemove",(function(e){i._axesValues[t][s]=e.dx/10}));break;case"mousey":i._mouse.on("mousemove",(function(e){i._axesValues[t][s]=e.dy/10}));break;case"key":i._axes[t].push((function(){return i._keyboard.isPressed(r)?a:0}));break;case"padrx":i._axes[t].push((function(){return i._gamepads.getAxis(e.pad,2)}));break;case"padry":i._axes[t].push((function(){return i._gamepads.getAxis(e.pad,3)}));break;case"padlx":i._axes[t].push((function(){return i._gamepads.getAxis(e.pad,0)}));break;case"padly":i._axes[t].push((function(){return i._gamepads.getAxis(e.pad,1)}));break;default:throw new Error("Unknown axis")}};i(this,e.positive,1,e.positiveKey),(e.negativeKey||e.negative!==e.positive)&&i(this,e.negative,-1,e.negativeKey)}isPressed(e){if(!this._actions[e])return!1;const t=this._actions[e].length;for(let s=0;s<t;++s){const t=this._actions[e][s];switch(t.type){case"keyboard":if(this._keyboard){const e=t.keys.length;for(let s=0;s<e;s++)if(this._keyboard.isPressed(t.keys[s]))return!0}break;case"mouse":if(this._mouse&&this._mouse.isPressed(t.button))return!0;break;case"gamepad":if(this._gamepads&&this._gamepads.isPressed(t.pad,t.button))return!0}}return!1}wasPressed(e){if(!this._actions[e])return!1;const t=this._actions[e].length;for(let s=0;s<t;++s){const t=this._actions[e][s];switch(t.type){case"keyboard":if(this._keyboard){const e=t.keys.length;for(let s=0;s<e;s++)if(this._keyboard.wasPressed(t.keys[s]))return!0}break;case"mouse":if(this._mouse&&this._mouse.wasPressed(t.button))return!0;break;case"gamepad":if(this._gamepads&&this._gamepads.wasPressed(t.pad,t.button))return!0}}return!1}getAxis(e){let t=0;if(this._axes[e]){const s=this._axes[e].length;for(let i=0;i<s;i++)if("function"===w(this._axes[e][i])){const s=this._axes[e][i]();Math.abs(s)>Math.abs(t)&&(t=s)}else this._axesValues[e]&&Math.abs(this._axesValues[e][i])>Math.abs(t)&&(t=this._axesValues[e][i])}return t}_enableMouse(){if(this._mouse=new $S,!this._element)throw new Error("Controller must be attached to an Element");this._mouse.attach(this._element)}_enableKeyboard(){if(this._keyboard=new qS,!this._element)throw new Error("Controller must be attached to an Element");this._keyboard.attach(this._element)}}let ZS,QS;const JS=new ge,ew=new ge,tw=new vi,sw=new vi,iw=new vi;tw.end=new ge,sw.end=new ge,iw.end=new ge;const nw=new ge,aw=new ge,rw=new ge,ow=new ge,hw=new ge,lw=new ge,cw=new ge,dw=new ge,uw=new ge,pw=new ge,mw=new ge,fw=new ge,_w=new ge,gw=new ge,yw=new ge,vw=new ge,xw=new ge,bw=new ge,Sw=new ge,ww=new ge,Tw=new xe;function Mw(e,t,s){return mw.cross(e,t).dot(s)}class Cw{constructor(e,t,s){this.event=e,this.element=t,this.camera=s,this._stopPropagation=!1}stopPropagation(){this._stopPropagation=!0,this.event&&(this.event.stopImmediatePropagation(),this.event.stopPropagation())}}class Aw extends Cw{constructor(e,t,s,i,n,a,r){super(e,t,s),this.x=i,this.y=n,this.ctrlKey=e.ctrlKey||!1,this.altKey=e.altKey||!1,this.shiftKey=e.shiftKey||!1,this.metaKey=e.metaKey||!1,this.button=e.button,$S.isPointerLocked()?(this.dx=e.movementX||e.webkitMovementX||e.mozMovementX||0,this.dy=e.movementY||e.webkitMovementY||e.mozMovementY||0):(this.dx=i-a,this.dy=n-r),this.wheelDelta=0,"wheel"===e.type&&(e.deltaY>0?this.wheelDelta=1:e.deltaY<0&&(this.wheelDelta=-1))}}class Pw extends Cw{constructor(e,t,s,i,n,a){super(e,t,s),this.touches=e.touches,this.changedTouches=e.changedTouches,this.x=i,this.y=n,this.touch=a}}class Ew extends Cw{constructor(e,t,s,i){super(e,t,s),this.inputSource=i}}class Rw{constructor(e,t){this._app=null,this._attached=!1,this._target=null,this._enabled=!0,this._lastX=0,this._lastY=0,this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._touchstartHandler=this._handleTouchStart.bind(this),this._touchendHandler=this._handleTouchEnd.bind(this),this._touchcancelHandler=this._touchendHandler,this._touchmoveHandler=this._handleTouchMove.bind(this),this._sortHandler=this._sortElements.bind(this),this._elements=[],this._hoveredElement=null,this._pressedElement=null,this._touchedElements={},this._touchesForWhichTouchLeaveHasFired={},this._selectedElements={},this._selectedPressedElements={},this._useMouse=!t||!1!==t.useMouse,this._useTouch=!t||!1!==t.useTouch,this._useXr=!t||!1!==t.useXr,this._selectEventsAttached=!1,N.touch&&(this._clickedEntities={}),this.attach(e)}set enabled(e){this._enabled=e}get enabled(){return this._enabled}set app(e){this._app=e}get app(){return this._app||zc()}attach(e){this._attached&&(this._attached=!1,this.detach()),this._target=e,this._attached=!0;const t=!!N.passiveEvents&&{passive:!0};this._useMouse&&(window.addEventListener("mouseup",this._upHandler,t),window.addEventListener("mousedown",this._downHandler,t),window.addEventListener("mousemove",this._moveHandler,t),window.addEventListener("wheel",this._wheelHandler,t)),this._useTouch&&N.touch&&(this._target.addEventListener("touchstart",this._touchstartHandler,t),this._target.addEventListener("touchend",this._touchendHandler,!1),this._target.addEventListener("touchmove",this._touchmoveHandler,!1),this._target.addEventListener("touchcancel",this._touchcancelHandler,!1)),this.attachSelectEvents()}attachSelectEvents(){!this._selectEventsAttached&&this._useXr&&this.app&&this.app.xr&&this.app.xr.supported&&(this._clickedEntities||(this._clickedEntities={}),this._selectEventsAttached=!0,this.app.xr.on("start",this._onXrStart,this))}detach(){if(!this._attached)return;this._attached=!1;const e=!!N.passiveEvents&&{passive:!0};this._useMouse&&(window.removeEventListener("mouseup",this._upHandler,e),window.removeEventListener("mousedown",this._downHandler,e),window.removeEventListener("mousemove",this._moveHandler,e),window.removeEventListener("wheel",this._wheelHandler,e)),this._useTouch&&(this._target.removeEventListener("touchstart",this._touchstartHandler,e),this._target.removeEventListener("touchend",this._touchendHandler,!1),this._target.removeEventListener("touchmove",this._touchmoveHandler,!1),this._target.removeEventListener("touchcancel",this._touchcancelHandler,!1)),this._selectEventsAttached&&(this._selectEventsAttached=!1,this.app.xr.off("start",this._onXrStart,this),this.app.xr.off("end",this._onXrEnd,this),this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)),this._target=null}addElement(e){-1===this._elements.indexOf(e)&&this._elements.push(e)}removeElement(e){const t=this._elements.indexOf(e);-1!==t&&this._elements.splice(t,1)}_handleUp(e){this._enabled&&($S.isPointerLocked()||(this._calcMouseCoords(e),this._onElementMouseEvent("mouseup",e)))}_handleDown(e){this._enabled&&($S.isPointerLocked()||(this._calcMouseCoords(e),this._onElementMouseEvent("mousedown",e)))}_handleMove(e){this._enabled&&(this._calcMouseCoords(e),this._onElementMouseEvent("mousemove",e),this._lastX=ZS,this._lastY=QS)}_handleWheel(e){this._enabled&&(this._calcMouseCoords(e),this._onElementMouseEvent("mousewheel",e))}_determineTouchedElements(e){const t={},s=this.app.systems.camera.cameras;for(let i=s.length-1;i>=0;i--){const n=s[i];let a=0;const r=e.changedTouches.length;for(let s=0;s<r;s++){if(t[e.changedTouches[s].identifier]){a++;continue}const i=this._calcTouchCoords(e.changedTouches[s]),r=this._getTargetElement(n,i.x,i.y);r&&(a++,t[e.changedTouches[s].identifier]={element:r,camera:n,x:i.x,y:i.y})}if(a===r)break}return t}_handleTouchStart(e){if(!this._enabled)return;const t=this._determineTouchedElements(e);for(let s=0,i=e.changedTouches.length;s<i;s++){const i=e.changedTouches[s],n=t[i.identifier],a=this._touchedElements[i.identifier];!n||a&&n.element===a.element||(this._fireEvent(e.type,new Pw(e,n.element,n.camera,n.x,n.y,i)),this._touchesForWhichTouchLeaveHasFired[i.identifier]=!1)}for(const e in t)this._touchedElements[e]=t[e]}_handleTouchEnd(e){if(!this._enabled)return;const t=this.app.systems.camera.cameras;for(const e in this._clickedEntities)delete this._clickedEntities[e];for(let s=0,i=e.changedTouches.length;s<i;s++){const i=e.changedTouches[s],n=this._touchedElements[i.identifier];if(!n)continue;const a=n.element,r=n.camera,o=n.x,h=n.y;delete this._touchedElements[i.identifier],delete this._touchesForWhichTouchLeaveHasFired[i.identifier],this._fireEvent(e.type,new Pw(e,a,r,o,h,i));const l=this._calcTouchCoords(i);for(let s=t.length-1;s>=0;s--){this._getTargetElement(t[s],l.x,l.y)===a&&(this._clickedEntities[a.entity.getGuid()]||(this._fireEvent("click",new Pw(e,a,r,o,h,i)),this._clickedEntities[a.entity.getGuid()]=!0))}}}_handleTouchMove(e){if(e.preventDefault(),!this._enabled)return;const t=this._determineTouchedElements(e);for(let s=0,i=e.changedTouches.length;s<i;s++){const i=e.changedTouches[s],n=t[i.identifier],a=this._touchedElements[i.identifier];if(a){const t=this._calcTouchCoords(i);n&&n.element===a.element||this._touchesForWhichTouchLeaveHasFired[i.identifier]||(this._fireEvent("touchleave",new Pw(e,a.element,a.camera,t.x,t.y,i)),this._touchesForWhichTouchLeaveHasFired[i.identifier]=!0),this._fireEvent("touchmove",new Pw(e,a.element,a.camera,t.x,t.y,i))}}}_onElementMouseEvent(e,t){let s=null;const i=this._hoveredElement;this._hoveredElement=null;const n=this.app.systems.camera.cameras;let a;for(let e=n.length-1;e>=0&&(a=n[e],s=this._getTargetElement(a,ZS,QS),!s);e--);this._hoveredElement=s,"mousemove"!==e&&"mouseup"!==e||!this._pressedElement?s&&(this._fireEvent(e,new Aw(t,s,a,ZS,QS,this._lastX,this._lastY)),"mousedown"===e&&(this._pressedElement=s)):this._fireEvent(e,new Aw(t,this._pressedElement,a,ZS,QS,this._lastX,this._lastY)),i!==this._hoveredElement&&(i&&this._fireEvent("mouseleave",new Aw(t,i,a,ZS,QS,this._lastX,this._lastY)),this._hoveredElement&&this._fireEvent("mouseenter",new Aw(t,this._hoveredElement,a,ZS,QS,this._lastX,this._lastY))),"mouseup"===e&&this._pressedElement&&(this._pressedElement===this._hoveredElement?(this._pressedElement=null,this._clickedEntities&&this._clickedEntities[this._hoveredElement.entity.getGuid()]||this._fireEvent("click",new Aw(t,this._hoveredElement,a,ZS,QS,this._lastX,this._lastY))):this._pressedElement=null)}_onXrStart(){this.app.xr.on("end",this._onXrEnd,this),this.app.xr.on("update",this._onXrUpdate,this),this.app.xr.input.on("selectstart",this._onSelectStart,this),this.app.xr.input.on("selectend",this._onSelectEnd,this),this.app.xr.input.on("remove",this._onXrInputRemove,this)}_onXrEnd(){this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)}_onXrUpdate(){if(!this._enabled)return;const e=this.app.xr.input.inputSources;for(let t=0;t<e.length;t++)this._onElementSelectEvent("selectmove",e[t],null)}_onXrInputRemove(e){const t=this._selectedElements[e.id];t&&(e._elementEntity=null,this._fireEvent("selectleave",new Ew(null,t,null,e))),delete this._selectedElements[e.id],delete this._selectedPressedElements[e.id]}_onSelectStart(e,t){this._enabled&&this._onElementSelectEvent("selectstart",e,t)}_onSelectEnd(e,t){this._enabled&&this._onElementSelectEvent("selectend",e,t)}_onElementSelectEvent(e,t,s){let i;const n=this._selectedElements[t.id];let a;const r=this.app.systems.camera.cameras;let o;if(t.elementInput){iw.set(t.getOrigin(),t.getDirection());for(let e=r.length-1;e>=0&&(o=r[e],i=this._getTargetElementByRay(iw,o),!i);e--);}t._elementEntity=i||null,i?(this._selectedElements[t.id]=i,a=i):delete this._selectedElements[t.id],n!==a&&(n&&this._fireEvent("selectleave",new Ew(s,n,o,t)),a&&this._fireEvent("selectenter",new Ew(s,a,o,t))),"selectstart"===e&&(this._selectedPressedElements[t.id]=a,a&&this._fireEvent("selectstart",new Ew(s,a,o,t)));const h=this._selectedPressedElements[t.id];!t.elementInput&&h&&(delete this._selectedPressedElements[t.id],n&&this._fireEvent("selectend",new Ew(s,n,o,t))),"selectend"===e&&t.elementInput&&(delete this._selectedPressedElements[t.id],n&&this._fireEvent("selectend",new Ew(s,n,o,t)),h&&h===n&&this._fireEvent("click",new Ew(s,h,o,t)))}_fireEvent(e,t){let s=t.element;for(;s.fire(e,t),!t._stopPropagation&&s.entity.parent&&(s=s.entity.parent.element,s););}_calcMouseCoords(e){const t=this._target.getBoundingClientRect(),s=Math.floor(t.left),i=Math.floor(t.top);ZS=e.clientX-s,QS=e.clientY-i}_calcTouchCoords(e){let t=0,s=0,i=e.target;for(;!(i instanceof HTMLElement);)i=i.parentNode;let n=i;do{t+=n.offsetLeft-n.scrollLeft,s+=n.offsetTop-n.scrollTop,n=n.offsetParent}while(n);return{x:e.pageX-t,y:e.pageY-s}}_sortElements(e,t){const s=this.app.scene.layers.sortTransparentLayers(e.layers,t.layers);return 0!==s?s:e.screen&&!t.screen?-1:!e.screen&&t.screen?1:e.screen||t.screen?e.screen.screen.screenSpace&&!t.screen.screen.screenSpace?-1:t.screen.screen.screenSpace&&!e.screen.screen.screenSpace?1:t.drawOrder-e.drawOrder:0}_getTargetElement(e,t,s){let i,n,a=null,r=1/0;this._elements.sort(this._sortHandler);for(let o=0,h=this._elements.length;o<h;o++){const h=this._elements[o];if(h.layers.some((t=>e.layersSet.has(t))))if(h.screen&&h.screen.screen.screenSpace){if(void 0===i&&(i=this._calculateRayScreen(t,s,e,tw)?tw:null),!i)continue;if(this._checkElement(i,h,!0)>=0){a=h;break}}else{if(void 0===n&&(n=this._calculateRay3d(t,s,e,sw)?sw:null),!n)continue;const i=this._checkElement(n,h,!1);if(i>=0&&(i<r&&(a=h,r=i),h.screen)){a=h;break}}}return a}_getTargetElementByRay(e,t){let s=null;tw.origin.copy(e.origin),tw.direction.copy(e.direction),tw.end.copy(tw.direction).mulScalar(2*t.farClip).add(tw.origin),this._elements.sort(this._sortHandler);for(let e=0,i=this._elements.length;e<i;e++){const i=this._elements[e];if(i.layers.some((e=>t.layersSet.has(e)))&&((!i.screen||!i.screen.screen.screenSpace)&&this._checkElement(tw,i,!1)>=0)){s=i;break}}return s}_buildHitCorners(e,t,s,i,n){let a=t;if(e.entity&&e.entity.button){const t=e.entity.button.hitPadding||Tw;_w.copy(e.entity.up),gw.copy(_w).mulScalar(-1),vw.copy(e.entity.right),yw.copy(vw).mulScalar(-1),_w.mulScalar(t.w*i),gw.mulScalar(t.y*i),vw.mulScalar(t.z*s),yw.mulScalar(t.x*s),xw.copy(a[0]).add(gw).add(yw),bw.copy(a[1]).add(gw).add(vw),Sw.copy(a[2]).add(_w).add(vw),ww.copy(a[3]).add(_w).add(yw),a=[xw,bw,Sw,ww]}if(s<0){const e=a[2].x,t=a[0].x;a[0].x=e,a[1].x=t,a[2].x=t,a[3].x=e}if(i<0){const e=a[2].y,t=a[0].y;a[0].y=e,a[1].y=e,a[2].y=t,a[3].y=t}if(n<0){const e=a[2].x,t=a[2].y,s=a[2].z;a[2].x=a[0].x,a[2].y=a[0].y,a[2].z=a[0].z,a[0].x=e,a[0].y=t,a[0].z=s}return a}_calculateScaleToScreen(e){let t=e.entity;const s=e.screen.screen.scale;for(fw.set(s,s,s);t&&!t.screen;)fw.mul(t.getLocalScale()),t=t.parent;return fw}_calculateScaleToWorld(e){let t=e.entity;for(fw.set(1,1,1);t;)fw.mul(t.getLocalScale()),t=t.parent;return fw}_calculateRayScreen(e,t,s,i){const n=this.app.graphicsDevice.width,a=this.app.graphicsDevice.height,r=s.rect.z*n,o=s.rect.w*a,h=s.rect.x*n,l=h+r,c=(1-s.rect.y)*a,d=c-o;let u=e*n/this._target.clientWidth,p=t*a/this._target.clientHeight;return u>=h&&u<=l&&p<=c&&p>=d&&(u=n*(u-h)/r,p=a*(p-d)/o,p=a-p,i.origin.set(u,p,1),i.direction.set(0,0,-1),i.end.copy(i.direction).mulScalar(2).add(i.origin),!0)}_calculateRay3d(e,t,s,i){const n=this._target.clientWidth,a=this._target.clientHeight,r=s.rect.z*n,o=s.rect.w*a,h=s.rect.x*n,l=h+r,c=(1-s.rect.y)*a,d=c-o;let u=e,p=t;return e>=h&&e<=l&&t<=c&&p>=d&&(u=n*(u-h)/r,p=a*(p-d)/o,s.screenToWorld(u,p,s.nearClip,JS),s.screenToWorld(u,p,s.farClip,ew),i.origin.copy(JS),i.direction.set(0,0,-1),i.end.copy(ew),!0)}_checkElement(e,t,s){if(t.maskedBy&&this._checkElement(e,t.maskedBy.element,s)<0)return-1;let i;i=s?this._calculateScaleToScreen(t):this._calculateScaleToWorld(t);const n=this._buildHitCorners(t,s?t.screenCorners:t.worldCorners,i.x,i.y,i.z);return function(e,t,s){nw.sub2(t,e),aw.sub2(s[0],e),rw.sub2(s[1],e),ow.sub2(s[2],e),lw.cross(ow,nw);let i,n,a=aw.dot(lw);if(a>=0){if(i=-rw.dot(lw),i<0)return-1;if(n=Mw(nw,rw,aw),n<0)return-1;const e=1/(i+a+n);cw.copy(s[0]).mulScalar(i*e),dw.copy(s[1]).mulScalar(a*e),uw.copy(s[2]).mulScalar(n*e),pw.copy(cw).add(dw).add(uw)}else{if(hw.sub2(s[3],e),i=hw.dot(lw),i<0)return-1;if(n=Mw(nw,aw,hw),n<0)return-1;a=-a;const t=1/(i+a+n);cw.copy(s[0]).mulScalar(i*t),dw.copy(s[3]).mulScalar(a*t),uw.copy(s[2]).mulScalar(n*t),pw.copy(cw).add(dw).add(uw)}return nw.sub2(s[0],s[2]).lengthSq()<1e-8||nw.sub2(s[1],s[3]).lengthSq()<1e-8?-1:pw.sub(e).lengthSq()}(e.origin,e.end,n)}}const Lw={DEFAULT:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_3","PAD_FACE_4","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_UP","PAD_DOWN","PAD_LEFT","PAD_RIGHT","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]},PS3:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_4","PAD_FACE_3","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_UP","PAD_DOWN","PAD_LEFT","PAD_RIGHT","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]}},Iw={"Product: 0268":"PS3"};class Dw{constructor(){this.gamepadsSupported=!!navigator.getGamepads||!!navigator.webkitGetGamepads,this.current=[],this.previous=[],this.deadZone=.25}update(){for(let e=0,t=this.current.length;e<t;e++){const t=this.current[e].pad.buttons,s=t.length;for(let i=0;i<s;i++)void 0===this.previous[e]&&(this.previous[e]=[]),this.previous[e][i]=t[i].pressed}this.poll(this.current)}poll(e=[]){if(e.length>0&&(e.length=0),this.gamepadsSupported){const t=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads();for(let s=0,i=t.length;s<i;s++)t[s]&&e.push({map:this.getMap(t[s]),pad:t[s]})}return e}getMap(e){for(const t in Iw)if(e.id.indexOf(t)>=0)return Lw[Iw[t]];return Lw.DEFAULT}isPressed(e,t){if(!this.current[e])return!1;const s=this.current[e].map.buttons[t];return this.current[e].pad.buttons[pc[s]].pressed}wasPressed(e,t){if(!this.current[e])return!1;const s=this.current[e].map.buttons[t],i=pc[s];return this.current[e].pad.buttons[i].pressed&&!(this.previous[e]&&this.previous[e][i])}wasReleased(e,t){if(!this.current[e])return!1;const s=this.current[e].map.buttons[t],i=pc[s];return!this.current[e].pad.buttons[i].pressed&&this.previous[e]&&this.previous[e][i]}getAxis(e,t){if(!this.current[e])return 0;const s=this.current[e].map.axes[t];let i=this.current[e].pad.axes[pc[s]];return Math.abs(i)<this.deadZone&&(i=0),i}}function Ow(e){let t=0,s=0,i=e.target;for(;!(i instanceof HTMLElement);)i=i.parentNode;let n=i;do{t+=n.offsetLeft-n.scrollLeft,s+=n.offsetTop-n.scrollTop,n=n.offsetParent}while(n);return{x:e.pageX-t,y:e.pageY-s}}class Fw{constructor(e){const t=Ow(e);this.id=e.identifier,this.x=t.x,this.y=t.y,this.target=e.target,this.touch=e}}class kw{constructor(e,t){if(this.element=t.target,this.event=t,this.touches=[],this.changedTouches=[],t){for(let e=0,s=t.touches.length;e<s;e++)this.touches.push(new Fw(t.touches[e]));for(let e=0,s=t.changedTouches.length;e<s;e++)this.changedTouches.push(new Fw(t.changedTouches[e]))}}getTouchById(e,t){for(let s=0,i=t.length;s<i;s++)if(t[s].id===e)return t[s];return null}}class Bw extends C{constructor(e){super(),this._element=null,this._startHandler=this._handleTouchStart.bind(this),this._endHandler=this._handleTouchEnd.bind(this),this._moveHandler=this._handleTouchMove.bind(this),this._cancelHandler=this._handleTouchCancel.bind(this),this.attach(e)}attach(e){this._element&&this.detach(),this._element=e,this._element.addEventListener("touchstart",this._startHandler,!1),this._element.addEventListener("touchend",this._endHandler,!1),this._element.addEventListener("touchmove",this._moveHandler,!1),this._element.addEventListener("touchcancel",this._cancelHandler,!1)}detach(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1)),this._element=null}_handleTouchStart(e){this.fire("touchstart",new kw(this,e))}_handleTouchEnd(e){this.fire("touchend",new kw(this,e))}_handleTouchMove(e){e.preventDefault(),this.fire("touchmove",new kw(this,e))}_handleTouchCancel(e){this.fire("touchcancel",new kw(this,e))}}class zw{constructor(){this.elementInput=void 0,this.keyboard=void 0,this.mouse=void 0,this.touch=void 0,this.gamepads=void 0,this.scriptPrefix=void 0,this.assetPrefix=void 0,this.scriptsOrder=void 0,this.soundManager=void 0,this.graphicsDevice=void 0,this.lightmapper=void 0,this.batchManager=void 0,this.xr=void 0,this.componentSystems=[],this.resourceHandlers=[]}}class Uw extends C{constructor(e){super(),this.app=e,this.store={},this.schema=[]}addComponent(e,t={}){const s=new this.ComponentType(this,e),i=new this.DataType;return this.store[e.getGuid()]={entity:e,data:i},e[this.id]=s,e.c[this.id]=s,this.initializeComponentData(s,t,[]),this.fire("add",e,s),s}removeComponent(e){const t=this.store[e.getGuid()],s=e.c[this.id];this.fire("beforeremove",e,s),delete this.store[e.getGuid()],e[this.id]=void 0,delete e.c[this.id],this.fire("remove",e,t.data)}cloneComponent(e,t){const s=this.store[e.getGuid()];return this.addComponent(t,s.data)}initializeComponentData(e,t={},s){for(let i=0,n=s.length;i<n;i++){const n=s[i];let a,r;"object"==typeof n?(a=n.name,r=n.type):(a=n,r=void 0);let o=t[a];void 0!==o?(void 0!==r&&(o=Vw(o,r)),e[a]=o):e[a]=e.data[a]}e.enabled&&e.entity.enabled&&e.onEnable()}getPropertiesOfType(e){const t=[];return(this.schema||[]).forEach((function(s){s&&"object"==typeof s&&s.type===e&&t.push(s)})),t}destroy(){this.off()}}function Vw(e,t){if(!e)return e;switch(t){case"rgb":return e instanceof pe?e.clone():new pe(e[0],e[1],e[2]);case"rgba":return e instanceof pe?e.clone():new pe(e[0],e[1],e[2],e[3]);case"vec2":return e instanceof ve?e.clone():new ve(e[0],e[1]);case"vec3":return e instanceof ge?e.clone():new ge(e[0],e[1],e[2]);case"vec4":return e instanceof xe?e.clone():new xe(e[0],e[1],e[2],e[3]);case"boolean":case"number":case"string":case"entity":return e;default:throw new Error("Could not convert unhandled type: "+t)}}class Nw extends Tm{constructor(e,t){super(e,t),this._animations={},this._assets=[],this._loop=!0,this.animEvaluator=null,this.model=null,this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animationsIndex={},this.prevAnim=null,this.currAnim=null,this.blend=0,this.blending=!1,this.blendSpeed=0,this.activate=!0,this.speed=1}set animations(e){this._animations=e,this.onSetAnimations()}get animations(){return this._animations}set assets(e){const t=this._assets;if(t&&t.length)for(let e=0;e<t.length;e++)if(t[e]){const s=this.system.app.assets.get(t[e]);if(s){s.off("change",this.onAssetChanged,this),s.off("remove",this.onAssetRemoved,this);const e=this.animationsIndex[s.id];this.currAnim===e&&this._stopCurrentAnimation(),delete this.animations[e],delete this.animationsIndex[s.id]}}this._assets=e;const s=e.map((e=>e instanceof um?e.id:e));this.loadAnimationAssets(s)}get assets(){return this._assets}set currentTime(e){if(this.skeleton&&(this.skeleton.currentTime=e,this.skeleton.addTime(0),this.skeleton.updateGraph()),this.animEvaluator){const t=this.animEvaluator.clips;for(let s=0;s<t.length;++s)t[s].time=e}}get currentTime(){if(this.skeleton)return this.skeleton._time;if(this.animEvaluator){const e=this.animEvaluator.clips;if(e.length>0)return e[e.length-1].time}return 0}get duration(){return this.animations[this.currAnim].duration}set loop(e){if(this._loop=e,this.skeleton&&(this.skeleton.looping=e),this.animEvaluator)for(let t=0;t<this.animEvaluator.clips.length;++t)this.animEvaluator.clips[t].loop=e}get loop(){return this._loop}play(e,t=0){if(this.enabled&&this.entity.enabled&&this.animations[e]){if(this.prevAnim=this.currAnim,this.currAnim=e,this.model){this.skeleton||this.animEvaluator||this._createAnimationController();const e=this.animations[this.prevAnim],s=this.animations[this.currAnim];if(this.blending=t>0&&!!this.prevAnim,this.blending&&(this.blend=0,this.blendSpeed=1/t),this.skeleton&&(this.blending?(this.fromSkel.animation=e,this.fromSkel.addTime(this.skeleton._time),this.toSkel.animation=s):this.skeleton.animation=s),this.animEvaluator){const e=this.animEvaluator;if(this.blending)for(;e.clips.length>1;)e.removeClip(0);else this.animEvaluator.removeClips();const t=new T_(this.animations[this.currAnim],0,1,!0,this.loop);t.name=this.currAnim,t.blendWeight=this.blending?0:1,t.reset(),this.animEvaluator.addClip(t)}}this.playing=!0}}getAnimation(e){return this.animations[e]}setModel(e){e!==this.model&&(this._resetAnimationController(),this.model=e,this.animations&&this.currAnim&&this.animations[this.currAnim]&&this.play(this.currAnim))}onSetAnimations(){const e=this.entity.model;if(e){const t=e.model;t&&t!==this.model&&this.setModel(t)}if(!this.currAnim&&this.activate&&this.enabled&&this.entity.enabled){const e=Object.keys(this._animations);e.length>0&&this.play(e[0])}}_resetAnimationController(){this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animEvaluator=null}_createAnimationController(){const e=this.model,t=this.animations;let s=!1,i=!1;for(const e in t)if(t.hasOwnProperty(e)){t[e].constructor===sg?i=!0:s=!0}const n=e.getGraph();s?(this.fromSkel=new __(n),this.toSkel=new __(n),this.skeleton=new __(n),this.skeleton.looping=this.loop,this.skeleton.setGraph(n)):i&&(this.animEvaluator=new J_(new ig(this.entity)))}loadAnimationAssets(e){if(!e||!e.length)return;const t=this.system.app.assets,s=e=>{if(e.resources.length>1)for(let t=0;t<e.resources.length;t++)this.animations[e.resources[t].name]=e.resources[t],this.animationsIndex[e.id]=e.resources[t].name;else this.animations[e.name]=e.resource,this.animationsIndex[e.id]=e.name;this.animations=this.animations},i=e=>{e.off("change",this.onAssetChanged,this),e.on("change",this.onAssetChanged,this),e.off("remove",this.onAssetRemoved,this),e.on("remove",this.onAssetRemoved,this),e.resource?s(e):(e.once("load",s,this),this.enabled&&this.entity.enabled&&t.load(e))};for(let s=0,n=e.length;s<n;s++){const n=t.get(e[s]);n?i(n):t.on("add:"+e[s],i)}}onAssetChanged(e,t,s,i){if("resource"===t||"resources"===t)if("resources"===t&&s&&0===s.length&&(s=null),s){let t=!1;if(s.length>1){if(i&&i.length>1)for(let e=0;e<i.length;e++)delete this.animations[i[e].name];else delete this.animations[e.name];t=!1;for(let e=0;e<s.length;e++)this.animations[s[e].name]=s[e],t||this.currAnim!==s[e].name||this.playing&&this.enabled&&this.entity.enabled&&(t=!0,this.play(s[e].name));t||(this._stopCurrentAnimation(),this.onSetAnimations())}else{if(i&&i.length>1)for(let e=0;e<i.length;e++)delete this.animations[i[e].name];this.animations[e.name]=s[0]||s,t=!1,this.currAnim===e.name&&this.playing&&this.enabled&&this.entity.enabled&&(t=!0,this.play(e.name)),t||(this._stopCurrentAnimation(),this.onSetAnimations())}this.animationsIndex[e.id]=e.name}else{if(i.length>1)for(let e=0;e<i.length;e++)delete this.animations[i[e].name],this.currAnim===i[e].name&&this._stopCurrentAnimation();else delete this.animations[e.name],this.currAnim===e.name&&this._stopCurrentAnimation();delete this.animationsIndex[e.id]}}onAssetRemoved(e){if(e.off("remove",this.onAssetRemoved,this),this.animations){if(e.resources.length>1)for(let t=0;t<e.resources.length;t++)delete this.animations[e.resources[t].name],this.currAnim===e.resources[t].name&&this._stopCurrentAnimation();else delete this.animations[e.name],this.currAnim===e.name&&this._stopCurrentAnimation();delete this.animationsIndex[e.id]}}_stopCurrentAnimation(){if(this.currAnim=null,this.playing=!1,this.skeleton&&(this.skeleton.currentTime=0,this.skeleton.animation=null),this.animEvaluator){for(let e=0;e<this.animEvaluator.clips.length;++e)this.animEvaluator.clips[e].stop();this.animEvaluator.update(0),this.animEvaluator.removeClips()}}onEnable(){super.onEnable();const e=this.assets,t=this.system.app.assets;if(e)for(let s=0,i=e.length;s<i;s++){let i=e[s];i instanceof um||(i=t.get(i)),i&&!i.resource&&t.load(i)}if(this.activate&&!this.currAnim){const e=Object.keys(this.animations);e.length>0&&this.play(e[0])}}onBeforeRemove(){for(let e=0;e<this.assets.length;e++){let t=this.assets[e];"number"==typeof t&&(t=this.system.app.assets.get(t)),t&&(t.off("change",this.onAssetChanged,this),t.off("remove",this.onAssetRemoved,this))}this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animEvaluator=null}update(e){if(this.blending&&(this.blend+=e*this.blendSpeed,this.blend>=1&&(this.blend=1)),this.playing){const t=this.skeleton;if(null!==t&&null!==this.model){if(this.blending)t.blend(this.fromSkel,this.toSkel,this.blend);else{const s=e*this.speed;t.addTime(s),(this.speed>0&&t._time===t.animation.duration&&!this.loop||this.speed<0&&0===t._time&&!this.loop)&&(this.playing=!1)}this.blending&&1===this.blend&&(t.animation=this.toSkel.animation),t.updateGraph()}}const t=this.animEvaluator;if(t){for(let e=0;e<t.clips.length;++e){const s=t.clips[e];s.speed=this.speed,this.playing?s.resume():s.pause()}this.blending&&t.clips.length>1&&(t.clips[1].blendWeight=this.blend),t.update(e)}this.blending&&1===this.blend&&(this.blending=!1)}}class Gw{constructor(){this.enabled=!0}}const Ww=["enabled"];class Hw extends Uw{constructor(e){super(e),this.id="animation",this.ComponentType=Nw,this.DataType=Gw,this.schema=Ww,this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(e,t,s){for(const s in t)t.hasOwnProperty(s)&&(e[s]=t[s]);super.initializeComponentData(e,t,Ww)}cloneComponent(e,t){this.addComponent(t,{}),t.animation.assets=e.animation.assets.slice(),t.animation.speed=e.animation.speed,t.animation.loop=e.animation.loop,t.animation.activate=e.animation.activate,t.animation.enabled=e.animation.enabled;const s={},i=e.animation.animations;for(const e in i)i.hasOwnProperty(e)&&(s[e]=i[e]);t.animation.animations=s;const n={},a=e.animation.animationsIndex;for(const e in a)a.hasOwnProperty(e)&&(n[e]=a[e]);return t.animation.animationsIndex=n,t.animation}onBeforeRemove(e,t){t.onBeforeRemove()}onUpdate(e){const t=this.store;for(const s in t)if(t.hasOwnProperty(s)){const i=t[s];i.data.enabled&&i.entity.enabled&&i.entity.animation.update(e)}}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}Tm._buildAccessors(Nw.prototype,Ww);const Xw=new ve,qw=new ge,jw=new xe,Yw=new pe,$w=new Ae;class Kw extends ig{constructor(e,t,s,i,n){super(t),this.animComponent=e,this._mask=i,this.layerName=s,this.layerIndex=n}static _packFloat(e){return e[0]}static _packBoolean(e){return!!e[0]}static _packVec2(e){return Xw.x=e[0],Xw.y=e[1],Xw}static _packVec3(e){return qw.x=e[0],qw.y=e[1],qw.z=e[2],qw}static _packVec4(e){return jw.x=e[0],jw.y=e[1],jw.z=e[2],jw.w=e[3],jw}static _packColor(e){return Yw.r=e[0],Yw.g=e[1],Yw.b=e[2],Yw.a=e[3],Yw}static _packQuat(e){return $w.x=e[0],$w.y=e[1],$w.z=e[2],$w.w=e[3],$w}resolve(e){const t=x_.encode(e.entityPath,e.component,e.propertyPath);let s,i,n,a=this.targetCache[t];if(a)return a;switch(e.component){case"entity":s=this._getEntityFromHierarchy(e.entityPath),n=x_.encode(s.path,"entity",e.propertyPath),i=s;break;case"graph":if(i=this.findNode(e),!i)return null;n=x_.encode(i.path,"graph",e.propertyPath);break;default:if(s=this._getEntityFromHierarchy(e.entityPath),i=s.findComponent(e.component),!i)return null;n=x_.encode(s.path,e.component,e.propertyPath)}return a=this._createAnimTargetForProperty(i,e.propertyPath,n),this.targetCache[t]=a,a}update(e){const t=this.activeNodes;if(t)for(let e=0;e<t.length;e++)t[e]._dirtifyLocal()}_getEntityFromHierarchy(e){if(!this.animComponent.entity.name===e[0])return null;const t=this.animComponent.entity;return 1===e.length?t:t._parent.findByPath(e)}_resolvePath(e,t,s){const i=t.length-(s?0:1);for(let s=0;s<i;s++)e=e[t[s]];return e}_setter(e,t,s){const i=this._resolvePath(e,t),n=t[t.length-1],a="set"+n.substring(0,1).toUpperCase()+n.substring(1);if(i[a]){let e=i["get"+n.substring(0,1).toUpperCase()+n.substring(1)].bind(i)();e=[e.x,e.y,e.z,e.w];const t=i[a].bind(i);return{set:e=>{t(s(e))},get:()=>e}}const r=i[n];if("object"==typeof r&&r.hasOwnProperty("copy"))return function(e){r.copy(s(e))};if(-1!==[ve,ge,xe,pe,Ae].indexOf(i.constructor)&&t.length>1){const a=t.length>2?this._resolvePath(e,t.slice(0,-1)):e,r=t[t.length-2];return function(e){i[n]=s(e),a[r]=i}}return function(e){i[n]=s(e)}}_createAnimTargetForProperty(e,t,s){if(this.handlers&&t[0].startsWith("weight."))return this.handlers.weight(e,t[0].replace("weight.",""));if(this.handlers&&"material"===t[0]&&2===t.length){const s=t[1];if(s.endsWith("Map"))return this.handlers.materialTexture(e,s)}const i=this._resolvePath(e,t,!0);if(void 0===i)return null;let n,a,r;if("number"==typeof i)n=this._setter(e,t,Kw._packFloat),a="vector",r=1;else if("boolean"==typeof i)n=this._setter(e,t,Kw._packBoolean),a="vector",r=1;else if("object"==typeof i)switch(i.constructor){case ve:n=this._setter(e,t,Kw._packVec2),a="vector",r=2;break;case ge:n=this._setter(e,t,Kw._packVec3),a="vector",r=3;break;case xe:n=this._setter(e,t,Kw._packVec4),a="vector",r=4;break;case pe:n=this._setter(e,t,Kw._packColor),a="vector",r=4;break;case Ae:n=this._setter(e,t,Kw._packQuat),a="quaternion",r=4;break;default:return null}return-1!==t.indexOf("material")?new eg((function(t){n(t),e.material.update()}),a,r,s):new eg(n,a,r,s)}rebind(){this.targetCache={},this.animComponent.rootBone?this.graph=this.animComponent.rootBone:this.graph=this.animComponent.entity;const e={};!function t(s){e[s.name]=s;for(let e=0;e<s.children.length;++e)t(s.children[e])}(this.graph),this.nodes=e}}class Zw{constructor(e,t,s,i=1,n="OVERWRITE",a=!0){this._name=e,this._controller=t,this._component=s,this._weight=i,this._blendType=n,this._normalizedWeight=a,this._mask=null,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0}get name(){return this._name}set playing(e){this._controller.playing=e}get playing(){return this._controller.playing}get playable(){return this._controller.playable}get activeState(){return this._controller.activeStateName}get previousState(){return this._controller.previousStateName}get activeStateProgress(){return this._controller.activeStateProgress}get activeStateDuration(){return this._controller.activeStateDuration}set activeStateCurrentTime(e){const t=this._controller,s=t.playing;t.playing=!0,t.activeStateCurrentTime=e,s||t.update(0),t.playing=s}get activeStateCurrentTime(){return this._controller.activeStateCurrentTime}get transitioning(){return this._controller.transitioning}get transitionProgress(){return this.transitioning?this._controller.transitionProgress:null}get states(){return this._controller.states}set weight(e){this._weight=e,this._component.dirtifyTargets()}get weight(){return this._weight}set blendType(e){e!==this._blendType&&(this._blendType=e,this._controller.normalizeWeights&&this._component.rebind())}get blendType(){return this._blendType}set mask(e){this._controller.assignMask(e)&&this._component.rebind(),this._mask=e}get mask(){return this._mask}play(e){this._controller.play(e)}pause(){this._controller.pause()}reset(){this._controller.reset()}rebind(){this._controller.rebind()}update(e){this._blendTime&&(this._blendTimeElapsed<this._blendTime?(this.weight=ne.lerp(this._startingWeight,this._targetWeight,this._blendTimeElapsed/this._blendTime),this._blendTimeElapsed+=e):(this.weight=this._targetWeight,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0)),this._controller.update(e)}blendToWeight(e,t){this._startingWeight=this.weight,this._targetWeight=e,this._blendTime=Math.max(0,t),this._blendTimeElapsed=0}assignMask(e){this._controller.assignMask(e)&&this._component.rebind(),this._mask=e}assignAnimation(e,t,s,i){t.constructor===sg&&(this._controller.assignAnimation(e,t,s,i),0===this._controller._transitions.length&&this._controller._transitions.push(new dg({from:"START",to:e})),this._component.activate&&this._component.playable&&(this._component.playing=!0))}removeNodeAnimations(e){this._controller.removeNodeAnimations(e)&&(this._component.playing=!1)}getAnimationAsset(e){return this._component.animationAssets[`${this.name}:${e}`]}transition(e,t=0,s=null){this._controller.updateStateFromTransition(new dg({from:this._controller.activeStateName,to:e,time:t,transitionOffset:s}))}}class Qw extends Tm{constructor(e,t){super(e,t),this._stateGraphAsset=null,this._animationAssets={},this._speed=1,this._activate=!0,this._playing=!1,this._rootBone=null,this._stateGraph=null,this._layers=[],this._layerIndices={},this._parameters={},this._targets={},this._consumedTriggers=new Set,this._normalizeWeights=!1}set stateGraphAsset(e){if(null===e)return void this.removeStateGraph();if(this._stateGraphAsset){this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this)}let t,s;e instanceof um?(t=e.id,s=this.system.app.assets.get(t),s||(this.system.app.assets.add(e),s=this.system.app.assets.get(t))):(t=e,s=this.system.app.assets.get(t)),s&&this._stateGraphAsset!==t&&(s.resource?(this._stateGraph=s.resource,this.loadStateGraph(this._stateGraph),s.on("change",this._onStateGraphAssetChangeEvent,this)):(s.once("load",(e=>{this._stateGraph=e.resource,this.loadStateGraph(this._stateGraph)})),s.on("change",this._onStateGraphAssetChangeEvent,this),this.system.app.assets.load(s)),this._stateGraphAsset=t)}get stateGraphAsset(){return this._stateGraphAsset}set normalizeWeights(e){this._normalizeWeights=e,this.unbind()}get normalizeWeights(){return this._normalizeWeights}set animationAssets(e){this._animationAssets=e,this.loadAnimationAssets()}get animationAssets(){return this._animationAssets}set speed(e){this._speed=e}get speed(){return this._speed}set activate(e){this._activate=e}get activate(){return this._activate}set playing(e){this._playing=e}get playing(){return this._playing}set rootBone(e){if("string"==typeof e){const t=this.entity.root.findByGuid(e);this._rootBone=t}else this._rootBone=e instanceof $m?e:null;this.rebind()}get rootBone(){return this._rootBone}set stateGraph(e){this._stateGraph=e}get stateGraph(){return this._stateGraph}get layers(){return this._layers}set layerIndices(e){this._layerIndices=e}get layerIndices(){return this._layerIndices}set parameters(e){this._parameters=e}get parameters(){return this._parameters}set targets(e){this._targets=e}get targets(){return this._targets}get playable(){for(let e=0;e<this._layers.length;e++)if(!this._layers[e].playable)return!1;return!0}get baseLayer(){return this._layers.length>0?this._layers[0]:null}_onStateGraphAssetChangeEvent(e){const t=this.animationAssets,s=this.layers.map((e=>e.mask));this.removeStateGraph(),this._stateGraph=new pg(e._data),this.loadStateGraph(this._stateGraph),this.animationAssets=t,this.loadAnimationAssets(),this.layers.forEach(((e,t)=>{e.mask=s[t]})),this.rebind()}dirtifyTargets(){const e=Object.values(this._targets);for(let t=0;t<e.length;t++)e[t].dirty=!0}_addLayer({name:e,states:t,transitions:s,weight:i,mask:n,blendType:a}){let r;r=this.rootBone?this.rootBone:this.entity;const o=this._layers.length,h=new Kw(this,r,e,n,o),l=new J_(h),c=new ug(l,t,s,this._parameters,this._activate,this,this._consumedTriggers);return this._layers.push(new Zw(e,c,this,i,a)),this._layerIndices[e]=o,this._layers[o]}addLayer(e,t,s,i){const n=this.findAnimationLayer(e);if(n)return n;return this._addLayer({name:e,states:[{name:"START",speed:1}],transitions:[],weight:t,mask:s,blendType:i})}loadStateGraph(e){this._stateGraph=e,this._parameters={};const t=Object.keys(e.parameters);for(let s=0;s<t.length;s++){const i=t[s];this._parameters[i]={type:e.parameters[i].type,value:e.parameters[i].value}}this._layers=[];for(let t=0;t<e.layers.length;t++){const s=e.layers[t];this._addLayer.bind(this)(b_({},s))}this.setupAnimationAssets()}setupAnimationAssets(){for(let e=0;e<this._layers.length;e++){const t=this._layers[e],s=t.name;for(let e=0;e<t.states.length;e++){const i=t.states[e];if(-1===$_.indexOf(i)){const e=s+":"+i;this._animationAssets[e]||(this._animationAssets[e]={asset:null})}}}this.loadAnimationAssets()}loadAnimationAssets(){for(let e=0;e<this._layers.length;e++){const t=this._layers[e];for(let e=0;e<t.states.length;e++){const s=t.states[e];if(-1!==$_.indexOf(s))continue;const i=this._animationAssets[t.name+":"+s];if(!i||!i.asset){this.removeNodeAnimations(s,t.name);continue}const n=i.asset,a=this.system.app.assets.get(n);a&&(a.resource?this.onAnimationAssetLoaded(t.name,s,a):(a.once("load",function(e,t){return function(s){this.onAnimationAssetLoaded(e,t,s)}.bind(this)}.bind(this)(t.name,s)),this.system.app.assets.load(a)))}}}onAnimationAssetLoaded(e,t,s){this.findAnimationLayer(e).assignAnimation(t,s.resource)}removeStateGraph(){this._stateGraph=null,this._stateGraphAsset=null,this._animationAssets={},this._layers=[],this._layerIndices={},this._parameters={},this._playing=!1,this.unbind(),this._targets={}}reset(){this._parameters=Object.assign({},this._stateGraph.parameters);for(let e=0;e<this._layers.length;e++){const t=this._layers[e].playing;this._layers[e].reset(),this._layers[e].playing=t}}unbind(){this._normalizeWeights||Object.keys(this._targets).forEach((e=>{this._targets[e].unbind()}))}rebind(){this._targets={};for(let e=0;e<this._layers.length;e++)this._layers[e].rebind()}findAnimationLayer(e){const t=this._layerIndices[e];return this._layers[t]||null}addAnimationState(e,t,s=1,i=!0,n="Base"){this._stateGraph||this.loadStateGraph(new pg({layers:[{name:n,states:[{name:"START",speed:1},{name:e,speed:s,loop:i,defaultState:!0}],transitions:[{from:"START",to:e}]}],parameters:{}}));const a=this.findAnimationLayer(n);var r;a?a.assignAnimation(e,t,s,i):null==(r=this.addLayer(n))||r.assignAnimation(e,t,s,i)}assignAnimation(e,t,s,i=1,n=!0){if(!this._stateGraph&&-1===e.indexOf("."))return this.loadStateGraph(new pg({layers:[{name:"Base",states:[{name:"START",speed:1},{name:e,speed:i,loop:n,defaultState:!0}],transitions:[{from:"START",to:e}]}],parameters:{}})),void this.baseLayer.assignAnimation(e,t);const a=s?this.findAnimationLayer(s):this.baseLayer;a&&a.assignAnimation(e,t,i,n)}removeNodeAnimations(e,t){const s=t?this.findAnimationLayer(t):this.baseLayer;s&&s.removeNodeAnimations(e)}getParameterValue(e,t){const s=this._parameters[e];if(s&&s.type===t)return s.value}setParameterValue(e,t,s){const i=this._parameters[e];i&&i.type===t&&(i.value=s)}getFloat(e){return this.getParameterValue(e,"FLOAT")}setFloat(e,t){this.setParameterValue(e,"FLOAT",t)}getInteger(e){return this.getParameterValue(e,"INTEGER")}setInteger(e,t){"number"==typeof t&&t%1==0&&this.setParameterValue(e,"INTEGER",t)}getBoolean(e){return this.getParameterValue(e,"BOOLEAN")}setBoolean(e,t){this.setParameterValue(e,"BOOLEAN",!!t)}getTrigger(e){return this.getParameterValue(e,"TRIGGER")}setTrigger(e,t=!1){this.setParameterValue(e,"TRIGGER",!0),t&&this._consumedTriggers.add(e)}resetTrigger(e){this.setParameterValue(e,"TRIGGER",!1)}onBeforeRemove(){if(Number.isFinite(this._stateGraphAsset)){this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this)}}update(e){for(let t=0;t<this.layers.length;t++)this.layers[t].update(e*this.speed);this._consumedTriggers.forEach((e=>{this.parameters[e].value=!1})),this._consumedTriggers.clear()}resolveDuplicatedEntityReferenceProperties(e,t){e.rootBone&&t[e.rootBone.getGuid()]?this.rootBone=t[e.rootBone.getGuid()]:this.rebind()}}class Jw{constructor(){this.enabled=!0}}const eT=["enabled"];class tT extends Uw{constructor(e){super(e),this.id="anim",this.ComponentType=Qw,this.DataType=Jw,this.schema=eT,this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("animationUpdate",this.onAnimationUpdate,this)}initializeComponentData(e,t,s){super.initializeComponentData(e,t,eT);const i=["animationAssets","stateGraph","layers","masks"];Object.keys(t).forEach((s=>{i.includes(s)||(e[s]=t[s])})),t.stateGraph&&(e.stateGraph=t.stateGraph,e.loadStateGraph(e.stateGraph)),t.layers?t.layers.forEach(((t,s)=>{t._controller.states.forEach((i=>{t._controller._states[i]._animationList.forEach((t=>{e.layers[s].assignAnimation(t.name,t.animTrack)}))}))})):t.animationAssets&&(e.animationAssets=Object.assign(e.animationAssets,t.animationAssets)),t.masks&&Object.keys(t.masks).forEach((s=>{if(e.layers[s]){const i=t.masks[s].mask,n={};Object.keys(i).forEach((e=>{n[decodeURI(e)]=i[e]})),e.layers[s].mask=n}}))}onAnimationUpdate(e){const t=this.store;for(const s in t)if(t.hasOwnProperty(s)){const i=t[s].entity.anim;i.data.enabled&&i.entity.enabled&&i.playing&&i.update(e)}}cloneComponent(e,t){let s;e.anim.rootBone&&e.anim.rootBone!==e||(s={},e.anim.layers.forEach(((e,i)=>{if(e.mask){const n={};Object.keys(e.mask).forEach((s=>{const i=s.split("/");i.shift();const a=[t.name,...i].join("/");n[a]=e.mask[s]})),s[i]={mask:n}}})));const i={stateGraphAsset:e.anim.stateGraphAsset,animationAssets:e.anim.animationAssets,speed:e.anim.speed,activate:e.anim.activate,playing:e.anim.playing,rootBone:e.anim.rootBone,stateGraph:e.anim.stateGraph,layers:e.anim.layers,layerIndices:e.anim.layerIndices,parameters:e.anim.parameters,normalizeWeights:e.anim.normalizeWeights,masks:s};return this.addComponent(t,i)}onBeforeRemove(e,t){t.onBeforeRemove()}destroy(){super.destroy(),this.app.systems.off("animationUpdate",this.onAnimationUpdate,this)}}Tm._buildAccessors(Qw.prototype,eT);class sT extends Tm{constructor(e,t){super(e,t)}setCurrentListener(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;const e=this.system.current.getPosition();this.system.manager.listener.setPosition(e)}}onEnable(){this.setCurrentListener()}onDisable(){this.system.current===this.entity&&(this.system.current=null)}}class iT{constructor(){this.enabled=!0}}const nT=["enabled"];class aT extends Uw{constructor(e){super(e),this.id="audiolistener",this.ComponentType=sT,this.DataType=iT,this.schema=nT,this.manager=e.soundManager,this.current=null,this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(e,t,s){s=["enabled"],super.initializeComponentData(e,t,s)}onUpdate(e){if(this.current){const e=this.current.getPosition();this.manager.listener.setPosition(e);const t=this.current.getWorldTransform();this.manager.listener.setOrientation(t)}}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}Tm._buildAccessors(sT.prototype,nT);class rT extends Tm{constructor(e,t){super(e,t),this.on("set_assets",this.onSetAssets,this),this.on("set_loop",this.onSetLoop,this),this.on("set_volume",this.onSetVolume,this),this.on("set_pitch",this.onSetPitch,this),this.on("set_minDistance",this.onSetMinDistance,this),this.on("set_maxDistance",this.onSetMaxDistance,this),this.on("set_rollOffFactor",this.onSetRollOffFactor,this),this.on("set_distanceModel",this.onSetDistanceModel,this),this.on("set_3d",this.onSet3d,this)}play(e){if(!this.enabled||!this.entity.enabled)return;let t;this.channel&&this.stop();const s=this.data;if(s.sources[e])if(s["3d"]){const i=this.entity.getPosition();t=this.system.manager.playSound3d(s.sources[e],i,s),s.currentSource=e,s.channel=t}else t=this.system.manager.playSound(s.sources[e],s),s.currentSource=e,s.channel=t}pause(){this.channel&&this.channel.pause()}unpause(){this.channel&&this.channel.paused&&this.channel.unpause()}stop(){this.channel&&(this.channel.stop(),this.channel=null)}onSetAssets(e,t,s){const i=[],n=s.length;if(t&&t.length)for(let e=0;e<t.length;e++)if(t[e]){const s=this.system.app.assets.get(t[e]);s&&(s.off("change",this.onAssetChanged,this),s.off("remove",this.onAssetRemoved,this),this.currentSource===s.name&&this.stop())}if(n)for(let e=0;e<n;e++)t.indexOf(s[e])<0&&(s[e]instanceof um?i.push(s[e].id):i.push(s[e]));!this.system._inTools&&i.length&&this.loadAudioSourceAssets(i)}onAssetChanged(e,t,s,i){if("resource"===t){this.data.sources&&(this.data.sources[e.name]=s,this.data.currentSource===e.name&&this.channel&&(this.channel.paused?(this.play(e.name),this.pause()):this.play(e.name)))}}onAssetRemoved(e){e.off("remove",this.onAssetRemoved,this),this.data.sources[e.name]&&(delete this.data.sources[e.name],this.data.currentSource===e.name&&(this.stop(),this.data.currentSource=null))}onSetLoop(e,t,s){t!==s&&this.channel&&this.channel.setLoop(s)}onSetVolume(e,t,s){t!==s&&this.channel&&this.channel.setVolume(s)}onSetPitch(e,t,s){t!==s&&this.channel&&this.channel.setPitch(s)}onSetMaxDistance(e,t,s){t!==s&&this.channel instanceof wg&&this.channel.setMaxDistance(s)}onSetMinDistance(e,t,s){t!==s&&this.channel instanceof wg&&this.channel.setMinDistance(s)}onSetRollOffFactor(e,t,s){t!==s&&this.channel instanceof wg&&this.channel.setRollOffFactor(s)}onSetDistanceModel(e,t,s){t!==s&&this.channel instanceof wg&&this.channel.setDistanceModel(s)}onSet3d(e,t,s){if(t!==s&&this.system.initialized&&this.currentSource){let e=!1,t=!1;this.channel&&(e=this.channel.paused,t=this.channel.suspended),this.play(this.currentSource),this.channel&&(this.channel.paused=e,this.channel.suspended=t)}}onEnable(){const e=this.data.assets;if(e){const t=this.system.app.assets;for(let s=0,i=e.length;s<i;s++){let i=e[s];i instanceof um||(i=t.get(i)),i&&!i.resource&&t.load(i)}}this.system.initialized&&(this.data.activate&&!this.channel?this.play(this.currentSource):this.unpause())}onDisable(){this.pause()}loadAudioSourceAssets(e){const t=e.map((e=>this.system.app.assets.get(e))),s={};let i=null,n=t.length;const a=e=>{n--},r=()=>{this.data.sources=s,this.data.currentSource=i,this.enabled&&this.activate&&i&&this.onEnable()};t.forEach(((t,o)=>{t?(i=i||t.name,t.off("change",this.onAssetChanged,this),t.on("change",this.onAssetChanged,this),t.off("remove",this.onAssetRemoved,this),t.on("remove",this.onAssetRemoved,this),t.off("error",a,this),t.on("error",a,this),t.ready((e=>{s[e.name]=e.resource,n--,0===n&&r()})),!t.resource&&this.enabled&&this.entity.enabled&&this.system.app.assets.load(t)):(n--,0===n&&r(),this.system.app.assets.on("add:"+e[o],(e=>{e.ready((e=>{this.data.sources[e.name]=e.resource})),e.resource||this.system.app.assets.load(e)})))}))}}class oT{constructor(){this.enabled=!0,this.assets=[],this.activate=!0,this.volume=1,this.pitch=1,this.loop=!1,this["3d"]=!0,this.minDistance=1,this.maxDistance=1e4,this.rollOffFactor=1,this.distanceModel="inverse",this.paused=!0,this.sources={},this.currentSource=null,this.channel=null}}const hT=["enabled","assets","volume","pitch","loop","activate","3d","minDistance","maxDistance","rollOffFactor","distanceModel","sources","currentSource","channel"];class lT extends Uw{constructor(e){super(e),this.id="audiosource",this.ComponentType=rT,this.DataType=oT,this.schema=hT,this.manager=e.soundManager,this.initialized=!1,this.app.systems.on("initialize",this.onInitialize,this),this.app.systems.on("update",this.onUpdate,this),this.on("remove",this.onRemove,this)}initializeComponentData(e,t,s){s=["activate","volume","pitch","loop","3d","minDistance","maxDistance","rollOffFactor","distanceModel","enabled","assets"],super.initializeComponentData(e,t,s),e.paused=!(e.enabled&&e.activate)}onInitialize(e){e.audiosource&&e.enabled&&e.audiosource.enabled&&e.audiosource.activate&&e.audiosource.play(e.audiosource.currentSource);const t=e._children;for(let e=0,s=t.length;e<s;e++)t[e]instanceof $m&&this.onInitialize(t[e]);this.initialized=!0}onUpdate(e){const t=this.store;for(const e in t)if(t.hasOwnProperty(e)){const s=t[e],i=s.entity,n=s.data;if(n.enabled&&i.enabled&&n.channel instanceof wg){const e=i.getPosition();n.channel.setPosition(e)}}}onRemove(e,t){t.channel&&(t.channel.stop(),t.channel=null)}setVolume(e){this.manager.setVolume(e)}destroy(){super.destroy(),this.app.systems.off("initialize",this.onInitialize,this),this.app.systems.off("update",this.onUpdate,this)}}Tm._buildAccessors(rT.prototype,hT);class cT extends C{constructor(e,t,s){if(super(),!(e&&e instanceof Tm))throw new Error("The parentComponent argument is required and must be a Component");if(!t||"string"!=typeof t)throw new Error("The propertyName argument is required and must be a string");if(s&&"object"!=typeof s)throw new Error("If provided, the eventConfig argument must be an object");this._parentComponent=e,this._entityPropertyName=t,this._entity=null,this._app=e.system.app,this._configureEventListeners(s||{},{"entity#destroy":this._onEntityDestroy}),this._toggleLifecycleListeners("on")}_configureEventListeners(e,t){const s=this._parseEventListenerConfig(e,"external",this._parentComponent),i=this._parseEventListenerConfig(t,"internal",this);this._eventListenerConfigs=s.concat(i),this._listenerStatusFlags={},this._gainListeners={},this._loseListeners={}}_parseEventListenerConfig(e,t,s){return Object.keys(e).map((function(i,n){const a=i.split("#"),r=a[0],o=a[1],h=e[i];if(2!==a.length||"string"!=typeof r||0===r.length||"string"!=typeof o||0===o.length)throw new Error("Invalid event listener description: `"+i+"`");if("function"!=typeof h)throw new Error("Invalid or missing callback for event listener `"+i+"`");return{id:t+"_"+n+"_"+i,sourceName:r,eventName:o,callback:h,scope:s}}),this)}_toggleLifecycleListeners(e){this._parentComponent[e]("set_"+this._entityPropertyName,this._onSetEntity,this),this._parentComponent.system[e]("beforeremove",this._onParentComponentRemove,this),this._app.systems[e]("postPostInitialize",this._updateEntityReference,this),this._app[e]("tools:sceneloaded",this._onSceneLoaded,this);const t=[];for(let e=0;e<this._eventListenerConfigs.length;++e){const s=this._eventListenerConfigs[e],i=this._app.systems[s.sourceName];i&&(-1===t.indexOf(i)&&t.push(i),i&&"gain"===s.eventName&&(this._gainListeners[s.sourceName]=s),i&&"lose"===s.eventName&&(this._loseListeners[s.sourceName]=s))}for(let s=0;s<t.length;++s)t[s][e]("add",this._onComponentAdd,this),t[s][e]("beforeremove",this._onComponentRemove,this)}_onSetEntity(e,t,s){if(s instanceof $m)this._updateEntityReference();else{if(null!=s&&"string"!=typeof s)return void console.warn("Entity field `"+this._entityPropertyName+"` was set to unexpected type '"+typeof s+"'");t!==s&&this._updateEntityReference()}}onParentComponentEnable(){this._entity||this._updateEntityReference()}_onSceneLoaded(){this._updateEntityReference()}_updateEntityReference(){let e,t=this._parentComponent.data[this._entityPropertyName];if(t instanceof $m)e=t,t=e.getGuid(),this._parentComponent.data[this._entityPropertyName]=t;else{const s=this._parentComponent.system.app.root;e=this._parentComponent.entity.isDescendantOf(s)&&t?s.findByGuid(t):null}this._entity!==e&&(this._entity&&this._onBeforeEntityChange(),this._entity=e,this._entity&&this._onAfterEntityChange(),this.fire("set:entity",this._entity))}_onBeforeEntityChange(){this._toggleEntityListeners("off"),this._callAllGainOrLoseListeners(this._loseListeners)}_onAfterEntityChange(){this._toggleEntityListeners("on"),this._callAllGainOrLoseListeners(this._gainListeners)}_onComponentAdd(e,t){const s=t.system.id;e===this._entity&&(this._callGainOrLoseListener(s,this._gainListeners),this._toggleComponentListeners("on",s))}_onComponentRemove(e,t){const s=t.system.id;e===this._entity&&(this._callGainOrLoseListener(s,this._loseListeners),this._toggleComponentListeners("off",s,!0))}_callAllGainOrLoseListeners(e){for(const t in this._entity.c)this._callGainOrLoseListener(t,e)}_callGainOrLoseListener(e,t){if(this._entity.c.hasOwnProperty(e)&&t[e]){const s=t[e];s.callback.call(s.scope)}}_toggleEntityListeners(e,t){if(this._entity)for(let s=0;s<this._eventListenerConfigs.length;++s)this._safeToggleListener(e,this._eventListenerConfigs[s],t)}_toggleComponentListeners(e,t,s){for(let i=0;i<this._eventListenerConfigs.length;++i){const n=this._eventListenerConfigs[i];n.sourceName===t&&this._safeToggleListener(e,n,s)}}_safeToggleListener(e,t,s){const i="on"===e;if(i&&this._listenerStatusFlags[t.id])return;const n=this._getEventSource(t.sourceName,s);n&&(n[e](t.eventName,t.callback,t.scope),this._listenerStatusFlags[t.id]=i)}_getEventSource(e,t){if("entity"===e)return this._entity;const s=this._entity[e];return s||(t||console.warn("Entity has no component with name "+e),null)}_onEntityDestroy(e){this._entity===e&&(this._toggleEntityListeners("off",!0),this._entity=null)}_onParentComponentRemove(e,t){t===this._parentComponent&&(this._toggleLifecycleListeners("off"),this._toggleEntityListeners("off",!0))}hasComponent(e){return!(!this._entity||!this._entity.c)&&!!this._entity.c[e]}get entity(){return this._entity}}const dT=0,uT=1,pT="group",mT="image",fT="text",_T="stretch",gT="contain",yT="cover",vT="DEFAULT",xT="HOVER",bT="PRESSED",ST="INACTIVE",wT={};wT[vT]="_defaultTint",wT[xT]="hoverTint",wT[bT]="pressedTint",wT[ST]="inactiveTint";const TT={};TT[vT]="_defaultSpriteAsset",TT[xT]="hoverSpriteAsset",TT[bT]="pressedSpriteAsset",TT[ST]="inactiveSpriteAsset";const MT={};MT[vT]="_defaultSpriteFrame",MT[xT]="hoverSpriteFrame",MT[bT]="pressedSpriteFrame",MT[ST]="inactiveSpriteFrame";class CT extends Tm{constructor(e,t){super(e,t),this._visualState=vT,this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._defaultTint=new pe(1,1,1,1),this._defaultSpriteAsset=null,this._defaultSpriteFrame=0,this._imageReference=new cT(this,"imageEntity",{"element#gain":this._onImageElementGain,"element#lose":this._onImageElementLose,"element#set:color":this._onSetColor,"element#set:opacity":this._onSetOpacity,"element#set:spriteAsset":this._onSetSpriteAsset,"element#set:spriteFrame":this._onSetSpriteFrame}),this._toggleLifecycleListeners("on",e)}_toggleLifecycleListeners(e,t){this[e]("set_active",this._onSetActive,this),this[e]("set_transitionMode",this._onSetTransitionMode,this),this[e]("set_hoverTint",this._onSetTransitionValue,this),this[e]("set_pressedTint",this._onSetTransitionValue,this),this[e]("set_inactiveTint",this._onSetTransitionValue,this),this[e]("set_hoverSpriteAsset",this._onSetTransitionValue,this),this[e]("set_hoverSpriteFrame",this._onSetTransitionValue,this),this[e]("set_pressedSpriteAsset",this._onSetTransitionValue,this),this[e]("set_pressedSpriteFrame",this._onSetTransitionValue,this),this[e]("set_inactiveSpriteAsset",this._onSetTransitionValue,this),this[e]("set_inactiveSpriteFrame",this._onSetTransitionValue,this),t.app.systems.element[e]("add",this._onElementComponentAdd,this),t.app.systems.element[e]("beforeremove",this._onElementComponentRemove,this)}_onSetActive(e,t,s){t!==s&&this._updateVisualState()}_onSetTransitionMode(e,t,s){t!==s&&(this._cancelTween(),this._resetToDefaultVisualState(t),this._forceReapplyVisualState())}_onSetTransitionValue(e,t,s){t!==s&&this._forceReapplyVisualState()}_onElementComponentRemove(e){this.entity===e&&this._toggleHitElementListeners("off")}_onElementComponentAdd(e){this.entity===e&&this._toggleHitElementListeners("on")}_onImageElementLose(){this._cancelTween(),this._resetToDefaultVisualState(this.transitionMode)}_onImageElementGain(){this._storeDefaultVisualState(),this._forceReapplyVisualState()}_toggleHitElementListeners(e){if(this.entity.element){const t="on"===e;if(t&&this._hasHitElementListeners)return;this.entity.element[e]("mouseenter",this._onMouseEnter,this),this.entity.element[e]("mouseleave",this._onMouseLeave,this),this.entity.element[e]("mousedown",this._onMouseDown,this),this.entity.element[e]("mouseup",this._onMouseUp,this),this.entity.element[e]("touchstart",this._onTouchStart,this),this.entity.element[e]("touchend",this._onTouchEnd,this),this.entity.element[e]("touchleave",this._onTouchLeave,this),this.entity.element[e]("touchcancel",this._onTouchCancel,this),this.entity.element[e]("selectstart",this._onSelectStart,this),this.entity.element[e]("selectend",this._onSelectEnd,this),this.entity.element[e]("selectenter",this._onSelectEnter,this),this.entity.element[e]("selectleave",this._onSelectLeave,this),this.entity.element[e]("click",this._onClick,this),this._hasHitElementListeners=t}}_storeDefaultVisualState(){if(this._imageReference.hasComponent("element")){const e=this._imageReference.entity.element;"group"!==e.type&&(this._storeDefaultColor(e.color),this._storeDefaultOpacity(e.opacity),this._storeDefaultSpriteAsset(e.spriteAsset),this._storeDefaultSpriteFrame(e.spriteFrame))}}_storeDefaultColor(e){this._defaultTint.r=e.r,this._defaultTint.g=e.g,this._defaultTint.b=e.b}_storeDefaultOpacity(e){this._defaultTint.a=e}_storeDefaultSpriteAsset(e){this._defaultSpriteAsset=e}_storeDefaultSpriteFrame(e){this._defaultSpriteFrame=e}_onSetColor(e){this._isApplyingTint||(this._storeDefaultColor(e),this._forceReapplyVisualState())}_onSetOpacity(e){this._isApplyingTint||(this._storeDefaultOpacity(e),this._forceReapplyVisualState())}_onSetSpriteAsset(e){this._isApplyingSprite||(this._storeDefaultSpriteAsset(e),this._forceReapplyVisualState())}_onSetSpriteFrame(e){this._isApplyingSprite||(this._storeDefaultSpriteFrame(e),this._forceReapplyVisualState())}_onMouseEnter(e){this._isHovering=!0,this._updateVisualState(),this._fireIfActive("mouseenter",e)}_onMouseLeave(e){this._isHovering=!1,this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseleave",e)}_onMouseDown(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("mousedown",e)}_onMouseUp(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseup",e)}_onTouchStart(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("touchstart",e)}_onTouchEnd(e){e.event.preventDefault(),this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchend",e)}_onTouchLeave(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchleave",e)}_onTouchCancel(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchcancel",e)}_onSelectStart(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("selectstart",e)}_onSelectEnd(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("selectend",e)}_onSelectEnter(e){this._hoveringCounter++,1===this._hoveringCounter&&(this._isHovering=!0,this._updateVisualState()),this._fireIfActive("selectenter",e)}_onSelectLeave(e){this._hoveringCounter--,0===this._hoveringCounter&&(this._isHovering=!1,this._isPressed=!1,this._updateVisualState()),this._fireIfActive("selectleave",e)}_onClick(e){this._fireIfActive("click",e)}_fireIfActive(e,t){this.data.active&&this.fire(e,t)}_updateVisualState(e){const t=this._visualState,s=this._determineVisualState();if((t!==s||e)&&this.enabled)switch(this._visualState=s,t===xT&&this._fireIfActive("hoverend"),t===bT&&this._fireIfActive("pressedend"),s===xT&&this._fireIfActive("hoverstart"),s===bT&&this._fireIfActive("pressedstart"),this.transitionMode){case 0:{const e=this[wT[this._visualState]];this._applyTint(e);break}case 1:{const e=TT[this._visualState],t=MT[this._visualState],s=this[e],i=this[t];this._applySprite(s,i);break}}}_forceReapplyVisualState(){this._updateVisualState(!0)}_resetToDefaultVisualState(e){if(this._imageReference.hasComponent("element"))switch(e){case 0:this._cancelTween(),this._applyTintImmediately(this._defaultTint);break;case 1:this._applySprite(this._defaultSpriteAsset,this._defaultSpriteFrame)}}_determineVisualState(){return this.active?this._isPressed?bT:this._isHovering?xT:vT:ST}_applySprite(e,t){t=t||0,this._imageReference.hasComponent("element")&&(this._isApplyingSprite=!0,this._imageReference.entity.element.spriteAsset!==e&&(this._imageReference.entity.element.spriteAsset=e),this._imageReference.entity.element.spriteFrame!==t&&(this._imageReference.entity.element.spriteFrame=t),this._isApplyingSprite=!1)}_applyTint(e){this._cancelTween(),0===this.fadeDuration?this._applyTintImmediately(e):this._applyTintWithTween(e)}_applyTintImmediately(e){if(!e||!this._imageReference.hasComponent("element")||"group"===this._imageReference.entity.element.type)return;const t=AT(e);this._isApplyingTint=!0,t.equals(this._imageReference.entity.element.color)||(this._imageReference.entity.element.color=t),this._imageReference.entity.element.opacity!==e.a&&(this._imageReference.entity.element.opacity=e.a),this._isApplyingTint=!1}_applyTintWithTween(e){if(!e||!this._imageReference.hasComponent("element")||"group"===this._imageReference.entity.element.type)return;const t=AT(e),s=this._imageReference.entity.element.color,i=this._imageReference.entity.element.opacity;t.equals(s)&&e.a===i||(this._tweenInfo={startTime:Q(),from:new pe(s.r,s.g,s.b,i),to:e.clone(),lerpColor:new pe})}_updateTintTween(){const e=Q()-this._tweenInfo.startTime;let t=0===this.fadeDuration?1:e/this.fadeDuration;if(t=ne.clamp(t,0,1),Math.abs(t-1)>1e-5){const e=this._tweenInfo.lerpColor;e.lerp(this._tweenInfo.from,this._tweenInfo.to,t),this._applyTintImmediately(new pe(e.r,e.g,e.b,e.a))}else this._applyTintImmediately(this._tweenInfo.to),this._cancelTween()}_cancelTween(){delete this._tweenInfo}onUpdate(){this._tweenInfo&&this._updateTintTween()}onEnable(){this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._imageReference.onParentComponentEnable(),this._toggleHitElementListeners("on"),this._forceReapplyVisualState()}onDisable(){this._toggleHitElementListeners("off"),this._resetToDefaultVisualState(this.transitionMode)}onRemove(){this._toggleLifecycleListeners("off",this.system),this.onDisable()}}function AT(e){return new pe(e.r,e.g,e.b)}class PT{constructor(){this.enabled=!0,this.active=!0,this.imageEntity=null,this.hitPadding=new xe,this.transitionMode=0,this.hoverTint=new pe(.75,.75,.75),this.pressedTint=new pe(.5,.5,.5),this.inactiveTint=new pe(.25,.25,.25),this.fadeDuration=0,this.hoverSpriteAsset=null,this.hoverSpriteFrame=0,this.pressedSpriteAsset=null,this.pressedSpriteFrame=0,this.inactiveSpriteAsset=null,this.inactiveSpriteFrame=0}}const ET=["enabled","active",{name:"imageEntity",type:"entity"},{name:"hitPadding",type:"vec4"},"transitionMode",{name:"hoverTint",type:"rgba"},{name:"pressedTint",type:"rgba"},{name:"inactiveTint",type:"rgba"},"fadeDuration","hoverSpriteAsset","hoverSpriteFrame","pressedSpriteAsset","pressedSpriteFrame","inactiveSpriteAsset","inactiveSpriteFrame"];class RT extends Uw{constructor(e){super(e),this.id="button",this.ComponentType=CT,this.DataType=PT,this.schema=ET,this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(e,t,s){super.initializeComponentData(e,t,ET)}onUpdate(e){const t=this.store;for(const e in t){const s=t[e].entity,i=s.button;i.enabled&&s.enabled&&i.onUpdate()}}_onRemoveComponent(e,t){t.onRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}Tm._buildAccessors(CT.prototype,ET);class LT extends Tm{constructor(e,t){super(e,t),this._compoundParent=null,this.entity.on("insert",this._onInsert,this),this.on("set_type",this.onSetType,this),this.on("set_halfExtents",this.onSetHalfExtents,this),this.on("set_radius",this.onSetRadius,this),this.on("set_height",this.onSetHeight,this),this.on("set_axis",this.onSetAxis,this),this.on("set_asset",this.onSetAsset,this),this.on("set_renderAsset",this.onSetRenderAsset,this),this.on("set_model",this.onSetModel,this),this.on("set_render",this.onSetRender,this)}onSetType(e,t,s){t!==s&&this.system.changeType(this,t,s)}onSetHalfExtents(e,t,s){const i=this.data.type;this.data.initialized&&"box"===i&&this.system.recreatePhysicalShapes(this)}onSetRadius(e,t,s){const i=this.data.type;!this.data.initialized||"sphere"!==i&&"capsule"!==i&&"cylinder"!==i&&"cone"!==i||this.system.recreatePhysicalShapes(this)}onSetHeight(e,t,s){const i=this.data.type;!this.data.initialized||"capsule"!==i&&"cylinder"!==i&&"cone"!==i||this.system.recreatePhysicalShapes(this)}onSetAxis(e,t,s){const i=this.data.type;!this.data.initialized||"capsule"!==i&&"cylinder"!==i&&"cone"!==i||this.system.recreatePhysicalShapes(this)}onSetAsset(e,t,s){const i=this.system.app.assets;if(t){const e=i.get(t);e&&e.off("remove",this.onAssetRemoved,this)}if(s){s instanceof um&&(this.data.asset=s.id);const e=i.get(this.data.asset);e&&(e.off("remove",this.onAssetRemoved,this),e.on("remove",this.onAssetRemoved,this))}this.data.initialized&&"mesh"===this.data.type&&(s||(this.data.model=null),this.system.recreatePhysicalShapes(this))}onSetRenderAsset(e,t,s){const i=this.system.app.assets;if(t){const e=i.get(t);e&&e.off("remove",this.onRenderAssetRemoved,this)}if(s){s instanceof um&&(this.data.renderAsset=s.id);const e=i.get(this.data.renderAsset);e&&(e.off("remove",this.onRenderAssetRemoved,this),e.on("remove",this.onRenderAssetRemoved,this))}this.data.initialized&&"mesh"===this.data.type&&(s||(this.data.render=null),this.system.recreatePhysicalShapes(this))}onSetModel(e,t,s){this.data.initialized&&"mesh"===this.data.type&&this.system.implementations.mesh.doRecreatePhysicalShape(this)}onSetRender(e,t,s){this.onSetModel(e,t,s)}onAssetRemoved(e){e.off("remove",this.onAssetRemoved,this),this.data.asset===e.id&&(this.asset=null)}onRenderAssetRemoved(e){e.off("remove",this.onRenderAssetRemoved,this),this.data.renderAsset===e.id&&(this.renderAsset=null)}_getCompoundChildShapeIndex(e){const t=this.data.shape,s=t.getNumChildShapes();for(let i=0;i<s;i++){if(t.getChildShape(i).ptr===e.ptr)return i}return null}_onInsert(e){if("undefined"!=typeof Ammo)if(this._compoundParent)this.system.recreatePhysicalShapes(this);else if(!this.entity.rigidbody){let e=this.entity.parent;for(;e;){if(e.collision&&"compound"===e.collision.type){0===e.collision.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(e.collision):this.system.recreatePhysicalShapes(this);break}e=e.parent}}}_updateCompound(){const e=this.entity;if(e._dirtyWorld){let t=e._dirtyLocal,s=e;for(;s&&!t&&(!s.collision||s.collision!==this._compoundParent);)s._dirtyLocal&&(t=!0),s=s.parent;if(t){e.forEach(this.system.implementations.compound._updateEachDescendantTransform,e);const t=this._compoundParent.entity.rigidbody;t&&t.activate()}}}onEnable(){if("mesh"===this.data.type&&(this.data.asset||this.data.renderAsset)&&this.data.initialized){const e=this.system.app.assets.get(this.data.asset||this.data.renderAsset);if(e&&(!e.resource||!this.data.shape))return void this.system.recreatePhysicalShapes(this)}if(this.entity.rigidbody)this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation();else if(this._compoundParent&&this!==this._compoundParent)if(0===this._compoundParent.shape.getNumChildShapes())this.system.recreatePhysicalShapes(this._compoundParent);else{const e=this.system._getNodeTransform(this.entity,this._compoundParent.entity);this._compoundParent.shape.addChildShape(e,this.data.shape),Ammo.destroy(e),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()}else this.entity.trigger&&this.entity.trigger.enable()}onDisable(){this.entity.rigidbody?this.entity.rigidbody.disableSimulation():this._compoundParent&&this!==this._compoundParent?this._compoundParent.entity._destroying||(this.system._removeCompoundChild(this._compoundParent,this.data.shape),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()):this.entity.trigger&&this.entity.trigger.disable()}onBeforeRemove(){this.asset&&(this.asset=null),this.renderAsset&&(this.renderAsset=null),this.entity.off("insert",this._onInsert,this),this.off()}}class IT{constructor(){this.enabled=!0,this.type="box",this.halfExtents=new ge(.5,.5,.5),this.radius=.5,this.axis=1,this.height=2,this.asset=null,this.renderAsset=null,this.shape=null,this.model=null,this.render=null,this.initialized=!1}}const DT="static",OT="dynamic",FT="kinematic",kT=1,BT=2,zT=4,UT=1,VT=2,NT=3,GT=4,WT=5,HT=0,XT=1,qT=1,jT=2,YT=4,$T=8,KT=16,ZT=32,QT=64,JT=128,eM=256,tM=512,sM=1024,iM=2048,nM=4096,aM=8192,rM=16384,oM=0,hM=65535,lM=2,cM=65533,dM=65529;let uM,pM,mM;class fM{constructor(e,t,s){this.entity=t.entity,this.component=t,this.app=e,"undefined"==typeof Ammo||uM||(uM=new Ammo.btVector3,pM=new Ammo.btQuaternion,mM=new Ammo.btTransform),this.initialize(s)}initialize(e){const t=this.entity,s=e.shape;if(s&&"undefined"!=typeof Ammo){t.trigger&&t.trigger.destroy();const e=1,i=t.getPosition(),n=t.getRotation();uM.setValue(i.x,i.y,i.z),pM.setValue(n.x,n.y,n.z,n.w),mM.setOrigin(uM),mM.setRotation(pM);const a=this.app.systems.rigidbody.createBody(e,s,mM);a.setRestitution(0),a.setFriction(0),a.setDamping(0,0),uM.setValue(0,0,0),a.setLinearFactor(uM),a.setAngularFactor(uM),a.setCollisionFlags(4|a.getCollisionFlags()),a.entity=t,this.body=a,this.component.enabled&&t.enabled&&this.enable()}}destroy(){const e=this.body;e&&(this.disable(),this.app.systems.rigidbody.destroyBody(e))}_getEntityTransform(e){const t=this.entity.getPosition(),s=this.entity.getRotation();uM.setValue(t.x,t.y,t.z),pM.setValue(s.x,s.y,s.z,s.w),e.setOrigin(uM),e.setRotation(pM)}updateTransform(){this._getEntityTransform(mM);const e=this.body;e.setWorldTransform(mM),e.activate()}enable(){const e=this.body;if(!e)return;const t=this.app.systems;t.rigidbody.addBody(e,16,65517),t.rigidbody._triggers.push(this),e.forceActivationState(1),this.updateTransform()}disable(){const e=this.body;if(!e)return;const t=this.app.systems,s=t.rigidbody._triggers.indexOf(this);s>-1&&t.rigidbody._triggers.splice(s,1),t.rigidbody.removeBody(e),e.forceActivationState(5)}}const _M=new Ce,gM=new ge,yM=new Ae,vM=new kh,xM=["enabled","type","halfExtents","radius","axis","height","asset","renderAsset","shape","model","render"];class bM{constructor(e){this.system=e}beforeInitialize(e,t){t.shape=null,t.model=new rf,t.model.graph=new kh}afterInitialize(e,t){this.recreatePhysicalShapes(e),e.data.initialized=!0}reset(e,t){this.beforeInitialize(e,t),this.afterInitialize(e,t)}recreatePhysicalShapes(e){const t=e.entity,s=e.data;if("undefined"!=typeof Ammo){t.trigger&&(t.trigger.destroy(),delete t.trigger),s.shape&&(e._compoundParent&&(this.system._removeCompoundChild(e._compoundParent,s.shape),e._compoundParent.entity.rigidbody&&e._compoundParent.entity.rigidbody.activate()),Ammo.destroy(s.shape),s.shape=null),s.shape=this.createPhysicalShape(e.entity,s);const i=!e._compoundParent;if("compound"!==s.type||e._compoundParent&&e!==e._compoundParent){if("compound"!==s.type&&(e._compoundParent&&e===e._compoundParent&&t.forEach(this.system.implementations.compound._updateEachDescendant,e),!e.rigidbody)){e._compoundParent=null;let s=t.parent;for(;s;){if(s.collision&&"compound"===s.collision.type){e._compoundParent=s.collision;break}s=s.parent}}}else e._compoundParent=e,t.forEach(this._addEachDescendant,e);e._compoundParent&&e!==e._compoundParent&&(i&&0===e._compoundParent.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(e._compoundParent):(this.system.updateCompoundChildTransform(t),e._compoundParent.entity.rigidbody&&e._compoundParent.entity.rigidbody.activate())),t.rigidbody?(t.rigidbody.disableSimulation(),t.rigidbody.createBody(),t.enabled&&t.rigidbody.enabled&&t.rigidbody.enableSimulation()):e._compoundParent||(t.trigger?t.trigger.initialize(s):t.trigger=new fM(this.system.app,e,s))}}createPhysicalShape(e,t){}updateTransform(e,t,s,i){e.entity.trigger&&e.entity.trigger.updateTransform()}beforeRemove(e,t){t.data.shape&&(t._compoundParent&&!t._compoundParent.entity._destroying&&(this.system._removeCompoundChild(t._compoundParent,t.data.shape),t._compoundParent.entity.rigidbody&&t._compoundParent.entity.rigidbody.activate()),t._compoundParent=null,Ammo.destroy(t.data.shape),t.data.shape=null)}remove(e,t){e.rigidbody&&e.rigidbody.body&&e.rigidbody.disableSimulation(),e.trigger&&(e.trigger.destroy(),delete e.trigger)}clone(e,t){const s=this.system.store[e.getGuid()],i={enabled:s.data.enabled,type:s.data.type,halfExtents:[s.data.halfExtents.x,s.data.halfExtents.y,s.data.halfExtents.z],radius:s.data.radius,axis:s.data.axis,height:s.data.height,asset:s.data.asset,renderAsset:s.data.renderAsset,model:s.data.model,render:s.data.render};return this.system.addComponent(t,i)}}class SM extends bM{createPhysicalShape(e,t){if("undefined"!=typeof Ammo){const e=t.halfExtents,s=new Ammo.btVector3(e?e.x:.5,e?e.y:.5,e?e.z:.5),i=new Ammo.btBoxShape(s);return Ammo.destroy(s),i}}}class wM extends bM{createPhysicalShape(e,t){if("undefined"!=typeof Ammo)return new Ammo.btSphereShape(t.radius)}}class TM extends bM{createPhysicalShape(e,t){const s=void 0!==t.axis?t.axis:1,i=t.radius||.5,n=Math.max((t.height||2)-2*i,0);let a=null;if("undefined"!=typeof Ammo)switch(s){case 0:a=new Ammo.btCapsuleShapeX(i,n);break;case 1:a=new Ammo.btCapsuleShape(i,n);break;case 2:a=new Ammo.btCapsuleShapeZ(i,n)}return a}}class MM extends bM{createPhysicalShape(e,t){const s=void 0!==t.axis?t.axis:1,i=void 0!==t.radius?t.radius:.5,n=void 0!==t.height?t.height:1;let a=null,r=null;if("undefined"!=typeof Ammo)switch(s){case 0:a=new Ammo.btVector3(.5*n,i,i),r=new Ammo.btCylinderShapeX(a);break;case 1:a=new Ammo.btVector3(i,.5*n,i),r=new Ammo.btCylinderShape(a);break;case 2:a=new Ammo.btVector3(i,i,.5*n),r=new Ammo.btCylinderShapeZ(a)}return a&&Ammo.destroy(a),r}}class CM extends bM{createPhysicalShape(e,t){const s=void 0!==t.axis?t.axis:1,i=void 0!==t.radius?t.radius:.5,n=void 0!==t.height?t.height:1;let a=null;if("undefined"!=typeof Ammo)switch(s){case 0:a=new Ammo.btConeShapeX(i,n);break;case 1:a=new Ammo.btConeShape(i,n);break;case 2:a=new Ammo.btConeShapeZ(i,n)}return a}}class AM extends bM{beforeInitialize(e,t){}createAmmoMesh(e,t,s){let i;if(this.system._triMeshCache[e.id])i=this.system._triMeshCache[e.id];else{const t=e.vertexBuffer,s=t.getFormat();let n,a;for(let e=0;e<s.elements.length;e++){const i=s.elements[e];if("POSITION"===i.name){a=new Float32Array(t.lock(),i.offset),n=i.stride/4;break}}const r=[];e.getIndices(r);const o=e.primitive[0].count/3,h=new Ammo.btVector3,l=new Ammo.btVector3,c=new Ammo.btVector3;let d,u,p;const m=e.primitive[0].base;i=new Ammo.btTriangleMesh,this.system._triMeshCache[e.id]=i;for(let e=0;e<o;e++)d=r[m+3*e]*n,u=r[m+3*e+1]*n,p=r[m+3*e+2]*n,h.setValue(a[d],a[d+1],a[d+2]),l.setValue(a[u],a[u+1],a[u+2]),c.setValue(a[p],a[p+1],a[p+2]),i.addTriangle(h,l,c,!0);Ammo.destroy(h),Ammo.destroy(l),Ammo.destroy(c)}const n=new Ammo.btBvhTriangleMeshShape(i,!0),a=this.system._getNodeScaling(t);n.setLocalScaling(a),Ammo.destroy(a);const r=this.system._getNodeTransform(t);s.addChildShape(r,n),Ammo.destroy(r)}createPhysicalShape(e,t){if("undefined"!=typeof Ammo&&(t.model||t.render)){const s=new Ammo.btCompoundShape;if(t.model){const e=t.model.meshInstances;for(let t=0;t<e.length;t++)this.createAmmoMesh(e[t].mesh,e[t].node,s)}else if(t.render){const e=t.render.meshes;for(let t=0;t<e.length;t++)this.createAmmoMesh(e[t],vM,s)}const i=e.getWorldTransform().getScale(),n=new Ammo.btVector3(i.x,i.y,i.z);return s.setLocalScaling(n),Ammo.destroy(n),s}}recreatePhysicalShapes(e){const t=e.data;(t.renderAsset||t.asset)&&e.enabled&&e.entity.enabled?this.loadAsset(e,t.renderAsset||t.asset,t.renderAsset?"render":"model"):this.doRecreatePhysicalShape(e)}loadAsset(e,t,s){const i=e.data,n=this.system.app.assets,a=n.get(t);a?(a.ready((t=>{i[s]=t.resource,this.doRecreatePhysicalShape(e)})),n.load(a)):n.once("add:"+t,(t=>{t.ready((t=>{i[s]=t.resource,this.doRecreatePhysicalShape(e)})),n.load(t)}))}doRecreatePhysicalShape(e){const t=e.entity,s=e.data;s.model||s.render?(this.destroyShape(s),s.shape=this.createPhysicalShape(t,s),t.rigidbody?(t.rigidbody.disableSimulation(),t.rigidbody.createBody(),t.enabled&&t.rigidbody.enabled&&t.rigidbody.enableSimulation()):t.trigger?t.trigger.initialize(s):t.trigger=new fM(this.system.app,e,s)):(this.beforeRemove(t,e),this.remove(t,s))}updateTransform(e,t,s,i){if(e.shape){const t=e.entity.getWorldTransform().getScale(),s=e.shape.getLocalScaling();t.x===s.x()&&t.y===s.y()&&t.z===s.z()||this.doRecreatePhysicalShape(e)}super.updateTransform(e,t,s,i)}destroyShape(e){if(!e.shape)return;const t=e.shape.getNumChildShapes();for(let s=0;s<t;s++){const t=e.shape.getChildShape(s);Ammo.destroy(t)}Ammo.destroy(e.shape),e.shape=null}remove(e,t){this.destroyShape(t),super.remove(e,t)}}class PM extends bM{createPhysicalShape(e,t){if("undefined"!=typeof Ammo)return new Ammo.btCompoundShape}_addEachDescendant(e){e.collision&&!e.rigidbody&&(e.collision._compoundParent=this,e!==this.entity&&e.collision.system.recreatePhysicalShapes(e.collision))}_updateEachDescendant(e){e.collision&&e.collision._compoundParent===this&&(e.collision._compoundParent=null,e===this.entity||e.rigidbody||e.collision.system.recreatePhysicalShapes(e.collision))}_updateEachDescendantTransform(e){e.collision&&e.collision._compoundParent===this.collision._compoundParent&&this.collision.system.updateCompoundChildTransform(e)}}class EM extends Uw{constructor(e){super(e),this.id="collision",this.ComponentType=LT,this.DataType=IT,this.schema=xM,this.implementations={},this._triMeshCache={},this.on("beforeremove",this.onBeforeRemove,this),this.on("remove",this.onRemove,this)}initializeComponentData(e,t,s){const i={};for(let e=0,n=(s=["type","halfExtents","radius","axis","height","shape","model","asset","render","renderAsset","enabled"]).length;e<n;e++){const n=s[e];i[n]=t[n]}let n;t.hasOwnProperty("asset")?(n=s.indexOf("model"),-1!==n&&s.splice(n,1),n=s.indexOf("render"),-1!==n&&s.splice(n,1)):t.hasOwnProperty("model")&&(n=s.indexOf("asset"),-1!==n&&s.splice(n,1)),i.type||(i.type=e.data.type),e.data.type=i.type,i.halfExtents&&Array.isArray(i.halfExtents)&&(i.halfExtents=new ge(i.halfExtents[0],i.halfExtents[1],i.halfExtents[2]));const a=this._createImplementation(i.type);a.beforeInitialize(e,i),super.initializeComponentData(e,i,s),a.afterInitialize(e,i)}_createImplementation(e){if(void 0===this.implementations[e]){let t;switch(e){case"box":t=new SM(this);break;case"sphere":t=new wM(this);break;case"capsule":t=new TM(this);break;case"cylinder":t=new MM(this);break;case"cone":t=new CM(this);break;case"mesh":t=new AM(this);break;case"compound":t=new PM(this)}this.implementations[e]=t}return this.implementations[e]}_getImplementation(e){return this.implementations[e.collision.data.type]}cloneComponent(e,t){return this._getImplementation(e).clone(e,t)}onBeforeRemove(e,t){this.implementations[t.data.type].beforeRemove(e,t),t.onBeforeRemove()}onRemove(e,t){this.implementations[t.type].remove(e,t)}updateCompoundChildTransform(e){if(this._removeCompoundChild(e.collision._compoundParent,e.collision.data.shape),e.enabled&&e.collision.enabled){const t=this._getNodeTransform(e,e.collision._compoundParent.entity);e.collision._compoundParent.shape.addChildShape(t,e.collision.data.shape),Ammo.destroy(t)}}_removeCompoundChild(e,t){if(e.shape.removeChildShape)e.shape.removeChildShape(t);else{const s=e._getCompoundChildShapeIndex(t);null!==s&&e.shape.removeChildShapeByIndex(s)}}onTransformChanged(e,t,s,i){this.implementations[e.data.type].updateTransform(e,t,s,i)}changeType(e,t,s){this.implementations[t].beforeRemove(e.entity,e),this.implementations[t].remove(e.entity,e.data),this._createImplementation(s).reset(e,e.data)}recreatePhysicalShapes(e){this.implementations[e.data.type].recreatePhysicalShapes(e)}_calculateNodeRelativeTransform(e,t){if(e===t){const t=e.getWorldTransform().getScale();_M.setScale(t.x,t.y,t.z)}else this._calculateNodeRelativeTransform(e.parent,t),_M.mul(e.getLocalTransform())}_getNodeScaling(e){const t=e.getWorldTransform().getScale();return new Ammo.btVector3(t.x,t.y,t.z)}_getNodeTransform(e,t){let s,i;t?(this._calculateNodeRelativeTransform(e,t),s=gM,i=yM,_M.getTranslation(s),i.setFromMat4(_M)):(s=e.getPosition(),i=e.getRotation());const n=new Ammo.btTransform;n.setIdentity();const a=n.getOrigin();a.setValue(s.x,s.y,s.z);const r=new Ammo.btQuaternion;return r.setValue(i.x,i.y,i.z,i.w),n.setRotation(r),Ammo.destroy(r),Ammo.destroy(a),n}destroy(){for(const e in this._triMeshCache)Ammo.destroy(this._triMeshCache[e]);this._triMeshCache=null,super.destroy()}}Tm._buildAccessors(LT.prototype,xM);class RM{constructor(e,t,s){this._entity=e,this._element=e.element,this.model=new rf,this.node=new kh,this.model.graph=this.node,this.mesh=t,this.meshInstance=new xd(this.mesh,s,this.node),this.meshInstance.name="ImageElement: "+e.name,this.meshInstance.castShadow=!1,this.meshInstance.receiveShadow=!1,this._meshDirty=!1,this.model.meshInstances.push(this.meshInstance),this._entity.addChild(this.model.graph),this.model._entity=this._entity,this.unmaskMeshInstance=null}destroy(){this.setMaterial(null),this._element.removeModelFromLayers(this.model),this.model.destroy(),this.model=null,this.node=null,this.mesh=null,this.meshInstance=null,this._entity=null,this._element=null}setMesh(e){this.meshInstance&&(this.mesh=e,this.meshInstance.mesh=e,this.meshInstance.visible=!!e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.mesh=e),this.forceUpdateAabb())}setMask(e){if(this.meshInstance){if(e){this.unmaskMeshInstance=new xd(this.mesh,this.meshInstance.material,this.node),this.unmaskMeshInstance.name="Unmask: "+this._entity.name,this.unmaskMeshInstance.castShadow=!1,this.unmaskMeshInstance.receiveShadow=!1,this.unmaskMeshInstance.pick=!1,this.model.meshInstances.push(this.unmaskMeshInstance);for(const e in this.meshInstance.parameters)this.unmaskMeshInstance.setParameter(e,this.meshInstance.parameters[e].data)}else{const e=this.model.meshInstances.indexOf(this.unmaskMeshInstance);e>=0&&this.model.meshInstances.splice(e,1),this.unmaskMeshInstance=null}this._entity.enabled&&this._element.enabled&&(this._element.removeModelFromLayers(this.model),this._element.addModelToLayers(this.model))}}setMaterial(e){this.meshInstance&&(this.meshInstance.material=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.material=e))}setParameter(e,t){this.meshInstance&&(this.meshInstance.setParameter(e,t),this.unmaskMeshInstance&&this.unmaskMeshInstance.setParameter(e,t))}deleteParameter(e){this.meshInstance&&(this.meshInstance.deleteParameter(e),this.unmaskMeshInstance&&this.unmaskMeshInstance.deleteParameter(e))}setUnmaskDrawOrder(){if(!this.meshInstance)return;const e=function e(t){let s;const i=t.children,n=i.length;if(n){for(let e=0;e<n;e++)i[e].element&&(s=i[e]);if(!s)return null;const t=e(s);return t||s}return null};if(this.unmaskMeshInstance){const t=e(this._entity);t&&t.element?this.unmaskMeshInstance.drawOrder=t.element.drawOrder+t.element.getMaskOffset():this.unmaskMeshInstance.drawOrder=this.meshInstance.drawOrder+this._element.getMaskOffset()}}setDrawOrder(e){this.meshInstance&&(this.meshInstance.drawOrder=e)}setCull(e){if(!this.meshInstance)return;const t=this._element;let s=null;e&&t._isScreenSpace()&&(s=function(e){return t.isVisibleForCamera(e)}),this.meshInstance.cull=e,this.meshInstance.isVisibleFunc=s,this.unmaskMeshInstance&&(this.unmaskMeshInstance.cull=e,this.unmaskMeshInstance.isVisibleFunc=s)}setScreenSpace(e){this.meshInstance&&(this.meshInstance.screenSpace=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.screenSpace=e))}setLayer(e){this.meshInstance&&(this.meshInstance.layer=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.layer=e))}forceUpdateAabb(e){this.meshInstance&&(this.meshInstance._aabbVer=-1,this.unmaskMeshInstance&&(this.unmaskMeshInstance._aabbVer=-1))}setAabbFunc(e){this.meshInstance&&(this.meshInstance._updateAabbFunc=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance._updateAabbFunc=e))}}class LM{constructor(e){this._element=e,this._entity=e.entity,this._system=e.system,this._textureAsset=null,this._texture=null,this._materialAsset=null,this._material=null,this._spriteAsset=null,this._sprite=null,this._spriteFrame=0,this._pixelsPerUnit=null,this._targetAspectRatio=-1,this._rect=new xe(0,0,1,1),this._mask=!1,this._maskRef=0,this._outerScale=new ve,this._outerScaleUniform=new Float32Array(2),this._innerOffset=new xe,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new xe,this._atlasRectUniform=new Float32Array(4),this._defaultMesh=this._createMesh(),this._renderable=new RM(this._entity,this._defaultMesh,this._material),this._color=new pe(1,1,1,1),this._colorUniform=new Float32Array([1,1,1]),this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",1),this._updateAabbFunc=this._updateAabb.bind(this),this._onScreenChange(this._element.screen),this._element.on("resize",this._onParentResizeOrPivotChange,this),this._element.on("set:pivot",this._onParentResizeOrPivotChange,this),this._element.on("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.on("set:screen",this._onScreenChange,this),this._element.on("set:draworder",this._onDrawOrderChange,this),this._element.on("screen:set:resolution",this._onResolutionChange,this)}destroy(){this.textureAsset=null,this.spriteAsset=null,this.materialAsset=null,this._renderable.setMesh(this._defaultMesh),this._renderable.destroy(),this._defaultMesh=null,this._element.off("resize",this._onParentResizeOrPivotChange,this),this._element.off("set:pivot",this._onParentResizeOrPivotChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("screen:set:resolution",this._onResolutionChange,this)}_onResolutionChange(e){}_onParentResizeOrPivotChange(){this._renderable.mesh&&this._updateMesh(this._renderable.mesh)}_onScreenSpaceChange(e){this._updateMaterial(e)}_onScreenChange(e,t){e?this._updateMaterial(e.screen.screenSpace):this._updateMaterial(!1)}_onDrawOrderChange(e){this._renderable.setDrawOrder(e),this.mask&&this._element.screen&&this._element.screen.screen.once("syncdraworder",(function(){this._renderable.setUnmaskDrawOrder()}),this)}_hasUserMaterial(){return!!this._materialAsset||!!this._material&&-1===this._system.defaultImageMaterials.indexOf(this._material)}_use9Slicing(){return this.sprite&&(1===this.sprite.renderMode||2===this.sprite.renderMode)}_updateMaterial(e){const t=!!this._mask,s=!(!this.sprite||1!==this.sprite.renderMode),i=!(!this.sprite||2!==this.sprite.renderMode);this._hasUserMaterial()||(this._material=this._system.getImageElementMaterial(e,t,s,i)),this._renderable&&(this._renderable.setCull(!this._element._isScreenSpace()||this._element._isScreenCulled()),this._renderable.setMaterial(this._material),this._renderable.setScreenSpace(e),this._renderable.setLayer(e?0:15))}_createMesh(){const e=this._element,t=e.calculatedWidth,s=e.calculatedHeight,i=this._rect,n=new ArrayBuffer(128),a=new Float32Array(n);a[5]=1,a[6]=i.x,a[7]=1-i.y,a[8]=t,a[13]=1,a[14]=i.x+i.z,a[15]=1-i.y,a[16]=t,a[17]=s,a[21]=1,a[22]=i.x+i.z,a[23]=1-(i.y+i.w),a[25]=s,a[29]=1,a[30]=i.x,a[31]=1-(i.y+i.w);const r=[{semantic:"POSITION",components:3,type:6},{semantic:"NORMAL",components:3,type:6},{semantic:"TEXCOORD0",components:2,type:6}],o=this._system.app.graphicsDevice,h=new go(o,r),l=new fo(o,h,4,0,n),c=new Wc(o);return c.vertexBuffer=l,c.primitive[0].type=6,c.primitive[0].base=0,c.primitive[0].count=4,c.primitive[0].indexed=!1,c.aabb.setMinMax(ge.ZERO,new ge(t,s,0)),this._updateMesh(c),c}_updateMesh(e){const t=this._element;let s=t.calculatedWidth,i=t.calculatedHeight;if("stretch"!==t.fitMode&&this._targetAspectRatio>0){const e=t.calculatedWidth/t.calculatedHeight;"contain"===t.fitMode&&e>this._targetAspectRatio||"cover"===t.fitMode&&e<this._targetAspectRatio?s=t.calculatedHeight*this._targetAspectRatio:i=t.calculatedWidth/this._targetAspectRatio}const n=t._isScreenSpace();if(this._updateMaterial(n),this._renderable&&this._renderable.forceUpdateAabb(),!this.sprite||1!==this.sprite.renderMode&&2!==this.sprite.renderMode){const n=e.vertexBuffer,a=new Float32Array(n.lock()),r=t.pivot.x,o=t.pivot.y;a[0]=0-r*s,a[1]=0-o*i,a[8]=s-r*s,a[9]=0-o*i,a[16]=s-r*s,a[17]=i-o*i,a[24]=0-r*s,a[25]=i-o*i;let h=1,l=1,c=this._rect;if(this._sprite&&this._sprite.frameKeys[this._spriteFrame]&&this._sprite.atlas){const e=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];e&&(c=e.rect,h=this._sprite.atlas.texture.width,l=this._sprite.atlas.texture.height)}a[6]=c.x/h,a[7]=1-c.y/l,a[14]=(c.x+c.z)/h,a[15]=1-c.y/l,a[22]=(c.x+c.z)/h,a[23]=1-(c.y+c.w)/l,a[30]=c.x/h,a[31]=1-(c.y+c.w)/l,n.unlock();const d=new ge(0-r*s,0-o*i,0),u=new ge(s-r*s,i-o*i,0);e.aabb.setMinMax(d,u),this._renderable&&(this._renderable.node.setLocalScale(1,1,1),this._renderable.node.setLocalPosition(0,0,0),this._renderable.setAabbFunc(null))}else{const e=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]],n=2/e.rect.z,a=2/e.rect.w;this._innerOffset.set(e.border.x*n,e.border.y*a,e.border.z*n,e.border.w*a);const r=this.sprite.atlas.texture;this._atlasRect.set(e.rect.x/r.width,e.rect.y/r.height,e.rect.z/r.width,e.rect.w/r.height);const o=null!==this._pixelsPerUnit?this._pixelsPerUnit:this.sprite.pixelsPerUnit,h=e.rect.z/o,l=e.rect.w/o;this._outerScale.set(Math.max(s,this._innerOffset.x*h),Math.max(i,this._innerOffset.y*l));let c=h,d=l;this._outerScale.x/=h,this._outerScale.y/=l,c*=ne.clamp(s/(this._innerOffset.x*h),1e-4,1),d*=ne.clamp(i/(this._innerOffset.y*l),1e-4,1),this._renderable&&(this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._renderable.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._renderable.setParameter("atlasRect",this._atlasRectUniform),this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._renderable.setParameter("outerScale",this._outerScaleUniform),this._renderable.setAabbFunc(this._updateAabbFunc),this._renderable.node.setLocalScale(c,d,1),this._renderable.node.setLocalPosition((.5-t.pivot.x)*s,(.5-t.pivot.y)*i,0))}this._meshDirty=!1}_updateSprite(){let e=!1,t=null;if(this._targetAspectRatio=-1,this._sprite&&this._sprite.atlas){t=this._sprite.meshes[this.spriteFrame],e=1===this._sprite.renderMode||2===this._sprite.renderMode;const s=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];(null==s?void 0:s.rect.w)>0&&(this._targetAspectRatio=s.rect.z/s.rect.w)}this.mesh=e?t:this._defaultMesh,this.refreshMesh()}refreshMesh(){this.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this.mesh))}_updateAabb(e){return e.center.set(0,0,0),e.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001),e.setFromTransformedAabb(e,this._renderable.node.getWorldTransform()),e}_toggleMask(){this._element._dirtifyMask();const e=this._element._isScreenSpace();this._updateMaterial(e),this._renderable.setMask(!!this._mask)}_onMaterialLoad(e){this.material=e.resource}_onMaterialAdded(e){this._system.app.assets.off("add:"+e.id,this._onMaterialAdded,this),this._materialAsset===e.id&&this._bindMaterialAsset(e)}_bindMaterialAsset(e){this._entity.enabled&&(e.on("load",this._onMaterialLoad,this),e.on("change",this._onMaterialChange,this),e.on("remove",this._onMaterialRemove,this),e.resource?this._onMaterialLoad(e):this._system.app.assets.load(e))}_unbindMaterialAsset(e){e.off("load",this._onMaterialLoad,this),e.off("change",this._onMaterialChange,this),e.off("remove",this._onMaterialRemove,this)}_onMaterialChange(){}_onMaterialRemove(){}_onTextureAdded(e){this._system.app.assets.off("add:"+e.id,this._onTextureAdded,this),this._textureAsset===e.id&&this._bindTextureAsset(e)}_bindTextureAsset(e){this._entity.enabled&&(e.on("load",this._onTextureLoad,this),e.on("change",this._onTextureChange,this),e.on("remove",this._onTextureRemove,this),e.resource?this._onTextureLoad(e):this._system.app.assets.load(e))}_unbindTextureAsset(e){e.off("load",this._onTextureLoad,this),e.off("change",this._onTextureChange,this),e.off("remove",this._onTextureRemove,this)}_onTextureLoad(e){this.texture=e.resource}_onTextureChange(e){}_onTextureRemove(e){}_onSpriteAssetAdded(e){this._system.app.assets.off("add:"+e.id,this._onSpriteAssetAdded,this),this._spriteAsset===e.id&&this._bindSpriteAsset(e)}_bindSpriteAsset(e){this._entity.enabled&&(e.on("load",this._onSpriteAssetLoad,this),e.on("change",this._onSpriteAssetChange,this),e.on("remove",this._onSpriteAssetRemove,this),e.resource?this._onSpriteAssetLoad(e):this._system.app.assets.load(e))}_unbindSpriteAsset(e){e.off("load",this._onSpriteAssetLoad,this),e.off("change",this._onSpriteAssetChange,this),e.off("remove",this._onSpriteAssetRemove,this),e.data.textureAtlasAsset&&this._system.app.assets.off("load:"+e.data.textureAtlasAsset,this._onTextureAtlasLoad,this)}_onSpriteAssetLoad(e){if(e&&e.resource)if(e.resource.atlas)this.sprite=e.resource;else{const t=e.data.textureAtlasAsset;if(t){const e=this._system.app.assets;e.off("load:"+t,this._onTextureAtlasLoad,this),e.once("load:"+t,this._onTextureAtlasLoad,this)}}else this.sprite=null}_onSpriteAssetChange(e){this._onSpriteAssetLoad(e)}_onSpriteAssetRemove(e){}_bindSprite(e){e.on("set:meshes",this._onSpriteMeshesChange,this),e.on("set:pixelsPerUnit",this._onSpritePpuChange,this),e.on("set:atlas",this._onAtlasTextureChange,this),e.atlas&&e.atlas.on("set:texture",this._onAtlasTextureChange,this)}_unbindSprite(e){e.off("set:meshes",this._onSpriteMeshesChange,this),e.off("set:pixelsPerUnit",this._onSpritePpuChange,this),e.off("set:atlas",this._onAtlasTextureChange,this),e.atlas&&e.atlas.off("set:texture",this._onAtlasTextureChange,this)}_onSpriteMeshesChange(){this._sprite&&(this._spriteFrame=ne.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()}_onSpritePpuChange(){0!==this.sprite.renderMode&&null===this._pixelsPerUnit&&this._updateSprite()}_onAtlasTextureChange(){this.sprite&&this.sprite.atlas&&this.sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))}_onTextureAtlasLoad(e){const t=this._spriteAsset;t instanceof um?this._onSpriteAssetLoad(t):this._onSpriteAssetLoad(this._system.app.assets.get(t))}onEnable(){if(this._materialAsset){const e=this._system.app.assets.get(this._materialAsset);e&&e.resource!==this._material&&this._bindMaterialAsset(e)}if(this._textureAsset){const e=this._system.app.assets.get(this._textureAsset);e&&e.resource!==this._texture&&this._bindTextureAsset(e)}if(this._spriteAsset){const e=this._system.app.assets.get(this._spriteAsset);e&&e.resource!==this._sprite&&this._bindSpriteAsset(e)}this._element.addModelToLayers(this._renderable.model)}onDisable(){this._element.removeModelFromLayers(this._renderable.model)}_setStencil(e){this._renderable.meshInstance.stencilFront=e,this._renderable.meshInstance.stencilBack=e;let t=0;if(this._element.maskedBy&&(t=this._element.maskedBy.element._image._maskRef),this._renderable.unmaskMeshInstance){const e=new c_({ref:t+1,func:2,zpass:5});this._renderable.unmaskMeshInstance.stencilFront=e,this._renderable.unmaskMeshInstance.stencilBack=e}}set color(e){const t=e.r,s=e.g,i=e.b;this._color.r===t&&this._color.g===s&&this._color.b===i||(this._color.r=t,this._color.g=s,this._color.b=i,this._colorUniform[0]=t,this._colorUniform[1]=s,this._colorUniform[2]=i,this._renderable.setParameter("material_emissive",this._colorUniform)),this._element&&this._element.fire("set:color",this._color)}get color(){return this._color}set opacity(e){e!==this._color.a&&(this._color.a=e,this._renderable.setParameter("material_opacity",e)),this._element&&this._element.fire("set:opacity",e)}get opacity(){return this._color.a}set rect(e){let t,s,i,n;e instanceof xe?(t=e.x,s=e.y,i=e.z,n=e.w):(t=e[0],s=e[1],i=e[2],n=e[3]),t===this._rect.x&&s===this._rect.y&&i===this._rect.z&&n===this._rect.w||(this._rect.set(t,s,i,n),this._renderable.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this._renderable.mesh)))}get rect(){return this._rect}set material(e){if(this._material!==e){if(!e){const t=this._element._isScreenSpace();e=this.mask?t?this._system.defaultScreenSpaceImageMaskMaterial:this._system.defaultImageMaskMaterial:t?this._system.defaultScreenSpaceImageMaterial:this._system.defaultImageMaterial}this._material=e,e&&(this._renderable.setMaterial(e),this._hasUserMaterial()?(this._renderable.deleteParameter("material_opacity"),this._renderable.deleteParameter("material_emissive")):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a)))}}get material(){return this._material}set materialAsset(e){const t=this._system.app.assets;let s=e;if(e instanceof um&&(s=e.id),this._materialAsset!==s){if(this._materialAsset){t.off("add:"+this._materialAsset,this._onMaterialAdded,this);const e=t.get(this._materialAsset);e&&(e.off("load",this._onMaterialLoad,this),e.off("change",this._onMaterialChange,this),e.off("remove",this._onMaterialRemove,this))}if(this._materialAsset=s,this._materialAsset){const e=t.get(this._materialAsset);e?this._bindMaterialAsset(e):(this.material=null,t.on("add:"+this._materialAsset,this._onMaterialAdded,this))}else this.material=null}}get materialAsset(){return this._materialAsset}set texture(e){if(this._texture!==e){if(this._textureAsset){const t=this._system.app.assets.get(this._textureAsset);t&&t.resource!==e&&(this.textureAsset=null)}if(this._texture=e,e){this._spriteAsset&&(this.spriteAsset=null),this._renderable.setParameter("texture_emissiveMap",this._texture),this._renderable.setParameter("texture_opacityMap",this._texture),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a);const e=this._texture.width/this._texture.height;e!==this._targetAspectRatio&&(this._targetAspectRatio=e,"stretch"!==this._element.fitMode&&this.refreshMesh())}else this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"),this._targetAspectRatio=-1,"stretch"!==this._element.fitMode&&this.refreshMesh()}}get texture(){return this._texture}set textureAsset(e){const t=this._system.app.assets;let s=e;if(e instanceof um&&(s=e.id),this._textureAsset!==s){if(this._textureAsset){t.off("add:"+this._textureAsset,this._onTextureAdded,this);const e=t.get(this._textureAsset);e&&(e.off("load",this._onTextureLoad,this),e.off("change",this._onTextureChange,this),e.off("remove",this._onTextureRemove,this))}if(this._textureAsset=s,this._textureAsset){const e=t.get(this._textureAsset);e?this._bindTextureAsset(e):(this.texture=null,t.on("add:"+this._textureAsset,this._onTextureAdded,this))}else this.texture=null}}get textureAsset(){return this._textureAsset}set spriteAsset(e){const t=this._system.app.assets;let s=e;if(e instanceof um&&(s=e.id),this._spriteAsset!==s){if(this._spriteAsset){t.off("add:"+this._spriteAsset,this._onSpriteAssetAdded,this);const e=t.get(this._spriteAsset);e&&this._unbindSpriteAsset(e)}if(this._spriteAsset=s,this._spriteAsset){const e=t.get(this._spriteAsset);e?this._bindSpriteAsset(e):(this.sprite=null,t.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this))}else this.sprite=null}this._element&&this._element.fire("set:spriteAsset",s)}get spriteAsset(){return this._spriteAsset}set sprite(e){if(this._sprite!==e){if(this._sprite&&this._unbindSprite(this._sprite),this._spriteAsset){const t=this._system.app.assets.get(this._spriteAsset);t&&t.resource!==e&&(this.spriteAsset=null)}this._sprite=e,this._sprite&&(this._bindSprite(this._sprite),this._textureAsset&&(this.textureAsset=null)),this._sprite&&this._sprite.atlas&&this._sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap")),this._sprite&&(this._spriteFrame=ne.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()}}get sprite(){return this._sprite}set spriteFrame(e){const t=this._spriteFrame;this._sprite?this._spriteFrame=ne.clamp(e,0,this._sprite.frameKeys.length-1):this._spriteFrame=e,this._spriteFrame!==t&&this._updateSprite(),this._element&&this._element.fire("set:spriteFrame",e)}get spriteFrame(){return this._spriteFrame}set mesh(e){this._renderable.setMesh(e),this._defaultMesh===e?this._renderable.setAabbFunc(null):this._renderable.setAabbFunc(this._updateAabbFunc)}get mesh(){return this._renderable.mesh}set mask(e){this._mask!==e&&(this._mask=e,this._toggleMask())}get mask(){return this._mask}set pixelsPerUnit(e){this._pixelsPerUnit!==e&&(this._pixelsPerUnit=e,!this._sprite||1!==this._sprite.renderMode&&2!==this._sprite.renderMode||this._updateSprite())}get pixelsPerUnit(){return this._pixelsPerUnit}get aabb(){return this._renderable.meshInstance?this._renderable.meshInstance.aabb:null}}const IM=/[A-Z|a-z|0-9|_|-|/]/;class DM{constructor(e){this._symbols=e,this._index=0,this._last=0,this._cur=this._symbols.length>0?this._symbols[0]:null,this._buf=[],this._mode="text",this._error=null}read(){let e=this._read();for(;8===e;)e=this._read();return 0!==e&&1!==e&&(this._last=this._index),e}buf(){return this._buf}last(){return this._last}error(){return this._error}debugPrint(){const e=["EOF","ERROR","TEXT","OPEN_BRACKET","CLOSE_BRACKET","EQUALS","STRING","IDENTIFIER","WHITESPACE"];let t=this.read(),s="";for(;s+=(s.length>0?"\n":"")+e[t]+" '"+this.buf().join("")+"'",0!==t&&1!==t;)t=this.read();return s}_read(){return this._buf=[],this._eof()?0:"text"===this._mode?this._text():this._tag()}_text(){for(;;)switch(this._cur){case null:return this._buf.length>0?2:0;case"[":return this._mode="tag",this._buf.length>0?2:this._tag();case"\\":if(this._next(),"["===this._cur)this._store();else this._output("\\");break;default:this._store()}}_tag(){switch(this._cur){case null:return this._error="unexpected end of input reading tag",1;case"[":return this._store(),3;case"]":return this._store(),this._mode="text",4;case"=":return this._store(),5;case" ":case"\t":case"\n":case"\r":case"\v":case"\f":return this._whitespace();case'"':return this._string();default:return this._isIdentifierSymbol(this._cur)?this._identifier():(this._error="unrecognized character",1)}}_whitespace(){for(this._store();-1!==" \t\n\r\v\f".indexOf(this._cur);)this._store();return 8}_string(){for(this._next();;)switch(this._cur){case null:return this._error="unexpected end of input reading string",1;case'"':return this._next(),6;default:this._store()}}_identifier(){for(this._store();null!==this._cur&&this._isIdentifierSymbol(this._cur);)this._store();return 7}_isIdentifierSymbol(e){return 1===e.length&&null!==e.match(IM)}_eof(){return null===this._cur}_next(){return this._eof()||(this._index++,this._cur=this._index<this._symbols.length?this._symbols[this._index]:null),this._cur}_store(){return this._buf.push(this._cur),this._next()}_output(e){this._buf.push(e)}}class OM{constructor(e){this._scanner=new DM(e),this._error=null}parse(e,t){for(;;){switch(this._scanner.read()){case 0:return!0;case 1:default:return!1;case 2:Array.prototype.push.apply(e,this._scanner.buf());break;case 3:if(!this._parseTag(e,t))return!1}}}error(){return"Error evaluating markup at #"+this._scanner.last().toString()+" ("+(this._scanner.error()||this._error)+")"}_parseTag(e,t){let s=this._scanner.read();if(7!==s)return this._error="expected identifier",!1;const i=this._scanner.buf().join("");if("/"===i[0]){for(let n=t.length-1;n>=0;--n)if(i==="/"+t[n].name&&null===t[n].end)return t[n].end=e.length,s=this._scanner.read(),4===s||(this._error="expected close bracket",!1);return this._error="failed to find matching tag",!1}const n={name:i,value:null,attributes:{},start:e.length,end:null};if(s=this._scanner.read(),5===s){if(s=this._scanner.read(),6!==s)return this._error="expected string",!1;n.value=this._scanner.buf().join(""),s=this._scanner.read()}for(;;){switch(s){case 4:return t.push(n),!0;case 7:{const e=this._scanner.buf().join("");if(s=this._scanner.read(),5!==s)return this._error="expected equals",!1;if(s=this._scanner.read(),6!==s)return this._error="expected string",!1;const t=this._scanner.buf().join("");n.attributes[e]=t;break}default:return this._error="expected close bracket or identifier",!1}s=this._scanner.read()}}}function FM(e,t){for(const s in t){if(!t.hasOwnProperty(s))continue;const i=t[s];i instanceof Object?(e.hasOwnProperty(s)||(e[s]={}),FM(e[s],t[s])):e[s]=i}}function kM(e){if(0===e.length)return null;const t={};for(let s=0;s<e.length;++s){const i=e[s],n={};n[i.name]={value:i.value,attributes:i.attributes},FM(t,n)}return t}function BM(e){const t=new OM(e),s=[],i=[];if(!t.parse(s,i))return console.warn(t.error()),{symbols:e,tags:null};const n=i.find((function(e){return null===e.end}));if(n)return console.warn(`Markup error: found unclosed tag='${n.name}'`),{symbols:e,tags:null};const a=function(e,t){if(0===e.length)return null;const s={};for(let t=0;t<e.length;++t){const i=e[t];s.hasOwnProperty(i.start)?null===s[i.start].open?s[i.start].open=[i]:s[i.start].open.push(i):s[i.start]={open:[i],close:null},s.hasOwnProperty(i.end)?null===s[i.end].close?s[i.end].close=[i]:s[i.end].close.push(i):s[i.end]={open:null,close:[i]}}let i=[];function n(e){i=i.filter((function(t){return void 0===e.find((function(e){return e===t}))}))}function a(e){for(let t=0;t<e.length;++t)i.push(e[t])}const r=Object.keys(s).sort((function(e,t){return e-t})),o=[];for(let e=0;e<r.length;++e){const t=s[r[e]];null!==t.close&&n(t.close),null!==t.open&&a(t.open),o.push({start:r[e],tags:kM(i)})}const h=[];let l=null;for(let e=0;e<o.length;++e){const t=o[e];for(;h.length<t.start;)h.push(l?l.tags:null);l=t}for(;h.length<t;)h.push(null);return h}(i,s.length);return{symbols:s,tags:a}}class zM{constructor(){this.count=0,this.quad=0,this.lines={},this.positions=[],this.normals=[],this.uvs=[],this.colors=[],this.indices=[],this.outlines=[],this.shadows=[],this.meshInstance=null}}function UM(e,t){const s=new Wc(e);return s.setPositions(t.positions),s.setNormals(t.normals),s.setColors32(t.colors),s.setUvs(0,t.uvs),s.setIndices(t.indices),s.setVertexStream("ATTR8",t.outlines,3,void 0,6,!1),s.setVertexStream("ATTR9",t.shadows,3,void 0,6,!1),s.update(),s}const VM=/^[\r\n]$/,NM=/^[ \t]$/,GM=/^[ \t\-]|[\u200b]$/,WM=/^[a-z0-9]$/i,HM=/^[\u1100-\u11ff]|[\u3000-\u9fff]|[\ua960-\ua97f]|[\uac00-\ud7ff]$/,XM=/^[]$/,qM=["","","","","","","","","","","","",""],jM={width:0,height:0,xadvance:0,xoffset:0,yoffset:0},YM=new pe,$M=new ve;class KM{constructor(e){this._element=e,this._system=e.system,this._entity=e.entity,this._text="",this._symbols=[],this._colorPalette=[],this._outlinePalette=[],this._shadowPalette=[],this._symbolColors=null,this._symbolOutlineParams=null,this._symbolShadowParams=null,this._i18nKey=null,this._fontAsset=new $v(this._system.app),this._fontAsset.disableLocalization=!0,this._fontAsset.on("load",this._onFontLoad,this),this._fontAsset.on("change",this._onFontChange,this),this._fontAsset.on("remove",this._onFontRemove,this),this._font=null,this._color=new pe(1,1,1,1),this._colorUniform=new Float32Array(3),this._spacing=1,this._fontSize=32,this._fontMinY=0,this._fontMaxY=0,this._originalFontSize=32,this._maxFontSize=32,this._minFontSize=8,this._autoFitWidth=!1,this._autoFitHeight=!1,this._maxLines=-1,this._lineHeight=32,this._scaledLineHeight=32,this._wrapLines=!1,this._drawOrder=0,this._alignment=new ve(.5,.5),this._autoWidth=!0,this._autoHeight=!0,this.width=0,this.height=0,this._node=new kh,this._model=new rf,this._model.graph=this._node,this._entity.addChild(this._node),this._meshInfo=[],this._material=null,this._aabbDirty=!0,this._aabb=new De,this._noResize=!1,this._currentMaterialType=null,this._maskedMaterialSrc=null,this._rtlReorder=!1,this._unicodeConverter=!1,this._rtl=!1,this._outlineColor=new pe(0,0,0,1),this._outlineColorUniform=new Float32Array(4),this._outlineThicknessScale=.2,this._outlineThickness=0,this._shadowColor=new pe(0,0,0,1),this._shadowColorUniform=new Float32Array(4),this._shadowOffsetScale=.005,this._shadowOffset=new ve(0,0),this._shadowOffsetUniform=new Float32Array(2),this._enableMarkup=!1,this._onScreenChange(this._element.screen),e.on("resize",this._onParentResize,this),e.on("set:screen",this._onScreenChange,this),e.on("screen:set:screenspace",this._onScreenSpaceChange,this),e.on("set:draworder",this._onDrawOrderChange,this),e.on("set:pivot",this._onPivotChange,this),this._system.app.i18n.on("set:locale",this._onLocaleSet,this),this._system.app.i18n.on("data:add",this._onLocalizationData,this),this._system.app.i18n.on("data:remove",this._onLocalizationData,this),this._rangeStart=0,this._rangeEnd=0}destroy(){this._setMaterial(null),this._model&&(this._element.removeModelFromLayers(this._model),this._model.destroy(),this._model=null),this._fontAsset.destroy(),this.font=null,this._element.off("resize",this._onParentResize,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("set:pivot",this._onPivotChange,this),this._system.app.i18n.off("set:locale",this._onLocaleSet,this),this._system.app.i18n.off("data:add",this._onLocalizationData,this),this._system.app.i18n.off("data:remove",this._onLocalizationData,this)}_onParentResize(e,t){this._noResize||this._font&&this._updateText()}_onScreenChange(e){e?this._updateMaterial(e.screen.screenSpace):this._updateMaterial(!1)}_onScreenSpaceChange(e){this._updateMaterial(e)}_onDrawOrderChange(e){if(this._drawOrder=e,this._model)for(let t=0,s=this._model.meshInstances.length;t<s;t++)this._model.meshInstances[t].drawOrder=e}_onPivotChange(e){this._font&&this._updateText()}_onLocaleSet(e){if(this._i18nKey){if(this.fontAsset){const e=this._system.app.assets.get(this.fontAsset);e&&e.resource&&e.resource===this._font||(this.font=null)}this._resetLocalizedText()}}_onLocalizationData(e,t){this._i18nKey&&t[this._i18nKey]&&this._resetLocalizedText()}_resetLocalizedText(){this._setText(this._system.app.i18n.getText(this._i18nKey))}_setText(e){if(this.unicodeConverter){const t=this._system.getUnicodeConverter();t?e=t(e):console.warn("Element created with unicodeConverter option but no unicodeConverter function registered")}this._text!==e&&(this._font&&this._updateText(e),this._text=e)}_updateText(e){let t;if(void 0===e&&(e=this._text),this._symbols=X.getSymbols(e.normalize?e.normalize("NFC"):e),0===this._symbols.length&&(this._symbols=[" "]),this._enableMarkup){const e=class{static evaluate(e){return BM(e)}}.evaluate(this._symbols);this._symbols=e.symbols,t=e.tags||[]}if(this._rtlReorder){const e=this._system.app.systems.element.getRtlReorder();if(e){const s=e(this._symbols);this._rtl=s.rtl,this._symbols=s.mapping.map((function(e){return this._symbols[e]}),this),t&&(t=s.mapping.map((function(e){return t[e]})))}else console.warn("Element created with rtlReorder option but no rtlReorder function registered")}else this._rtl=!1;const s=(e,t)=>`${e.toString(!0).toLowerCase()}:${t.toFixed(2)}`,i=(e,t)=>`${e.toString(!0).toLowerCase()}:${t.x.toFixed(2)}:${t.y.toFixed(2)}`;if(t){const e={},n={},a={};this._colorPalette=[Math.round(255*this._color.r),Math.round(255*this._color.g),Math.round(255*this._color.b)],this._outlinePalette=[Math.round(255*this._outlineColor.r),Math.round(255*this._outlineColor.g),Math.round(255*this._outlineColor.b),Math.round(255*this._outlineColor.a),Math.round(255*this._outlineThickness)],this._shadowPalette=[Math.round(255*this._shadowColor.r),Math.round(255*this._shadowColor.g),Math.round(255*this._shadowColor.b),Math.round(255*this._shadowColor.a),Math.round(127*this._shadowOffset.x),Math.round(127*this._shadowOffset.y)],this._symbolColors=[],this._symbolOutlineParams=[],this._symbolShadowParams=[],e[this._color.toString(!1).toLowerCase()]=0,n[s(this._outlineColor,this._outlineThickness)]=0,a[i(this._shadowColor,this._shadowOffset)]=0;for(let r=0,o=this._symbols.length;r<o;++r){const o=t[r];let h=0;if(o&&o.color&&o.color.value){const t=o.color.value;if(7===t.length&&"#"===t[0]){const s=t.substring(1).toLowerCase();e.hasOwnProperty(s)?h=e[s]:/^([0-9a-f]{2}){3}$/.test(s)&&(h=this._colorPalette.length/3,e[s]=h,this._colorPalette.push(parseInt(s.substring(0,2),16)),this._colorPalette.push(parseInt(s.substring(2,4),16)),this._colorPalette.push(parseInt(s.substring(4,6),16)))}}this._symbolColors.push(h);let l=0;if(o&&o.outline&&(o.outline.attributes.color||o.outline.attributes.thickness)){let e=o.outline.attributes.color?YM.fromString(o.outline.attributes.color):this._outlineColor,t=Number(o.outline.attributes.thickness);(Number.isNaN(e.r)||Number.isNaN(e.g)||Number.isNaN(e.b)||Number.isNaN(e.a))&&(e=this._outlineColor),Number.isNaN(t)&&(t=this._outlineThickness);const i=s(e,t);n.hasOwnProperty(i)?l=n[i]:(l=this._outlinePalette.length/5,n[i]=l,this._outlinePalette.push(Math.round(255*e.r),Math.round(255*e.g),Math.round(255*e.b),Math.round(255*e.a),Math.round(255*t)))}this._symbolOutlineParams.push(l);let c=0;if(o&&o.shadow&&(o.shadow.attributes.color||o.shadow.attributes.offset||o.shadow.attributes.offsetX||o.shadow.attributes.offsetY)){let e=o.shadow.attributes.color?YM.fromString(o.shadow.attributes.color):this._shadowColor;const t=Number(o.shadow.attributes.offset),s=Number(o.shadow.attributes.offsetX),n=Number(o.shadow.attributes.offsetY);(Number.isNaN(e.r)||Number.isNaN(e.g)||Number.isNaN(e.b)||Number.isNaN(e.a))&&(e=this._shadowColor);const r=$M.set(Number.isNaN(s)?Number.isNaN(t)?this._shadowOffset.x:t:s,Number.isNaN(n)?Number.isNaN(t)?this._shadowOffset.y:t:n),h=i(e,r);a.hasOwnProperty(h)?c=a[h]:(c=this._shadowPalette.length/6,a[h]=c,this._shadowPalette.push(Math.round(255*e.r),Math.round(255*e.g),Math.round(255*e.b),Math.round(255*e.a),Math.round(127*r.x),Math.round(127*r.y)))}this._symbolShadowParams.push(c)}}else this._colorPalette=[],this._symbolColors=null,this._symbolOutlineParams=null,this._symbolShadowParams=null;this._updateMaterialEmissive(),this._updateMaterialOutline(),this._updateMaterialShadow();const n=this._calculateCharsPerTexture();let a=!1;const r=this._element,o=r._isScreenSpace(),h=r._isScreenCulled(),l=function(e){return r.isVisibleForCamera(e)};for(let e=0,t=this._meshInfo.length;e<t;e++){const t=n[e]||0,s=this._meshInfo[e];if(s.count!==t){if(a||(r.removeModelFromLayers(this._model),a=!0),s.count=t,s.positions.length=s.normals.length=3*t*4,s.indices.length=3*t*2,s.uvs.length=2*t*4,s.colors.length=4*t*4,s.outlines.length=4*t*3,s.shadows.length=4*t*3,s.meshInstance&&this._removeMeshInstance(s.meshInstance),0===t){s.meshInstance=null;continue}for(let e=0;e<t;e++)s.indices[3*e*2+0]=4*e,s.indices[3*e*2+1]=4*e+1,s.indices[3*e*2+2]=4*e+3,s.indices[3*e*2+3]=4*e+2,s.indices[3*e*2+4]=4*e+3,s.indices[3*e*2+5]=4*e+1,s.normals[4*e*3+0]=0,s.normals[4*e*3+1]=0,s.normals[4*e*3+2]=-1,s.normals[4*e*3+3]=0,s.normals[4*e*3+4]=0,s.normals[4*e*3+5]=-1,s.normals[4*e*3+6]=0,s.normals[4*e*3+7]=0,s.normals[4*e*3+8]=-1,s.normals[4*e*3+9]=0,s.normals[4*e*3+10]=0,s.normals[4*e*3+11]=-1;const i=UM(this._system.app.graphicsDevice,s),n=new xd(i,this._material,this._node);if(n.name="Text Element: "+this._entity.name,n.castShadow=!1,n.receiveShadow=!1,n.cull=!o,n.screenSpace=o,n.drawOrder=this._drawOrder,h&&(n.cull=!0,n.isVisibleFunc=l),this._setTextureParams(n,this._font.textures[e]),n.setParameter("material_emissive",this._colorUniform),n.setParameter("material_opacity",this._color.a),n.setParameter("font_sdfIntensity",this._font.intensity),n.setParameter("font_pxrange",this._getPxRange(this._font)),n.setParameter("font_textureWidth",this._font.data.info.maps[e].width),n.setParameter("outline_color",this._outlineColorUniform),n.setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness),n.setParameter("shadow_color",this._shadowColorUniform),this._symbolShadowParams)this._shadowOffsetUniform[0]=0,this._shadowOffsetUniform[1]=0;else{const t=-this._font.data.info.maps[e].width/this._font.data.info.maps[e].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=t*this._shadowOffsetScale*this._shadowOffset.y}n.setParameter("shadow_offset",this._shadowOffsetUniform),s.meshInstance=n,this._model.meshInstances.push(n)}}this._element.maskedBy&&this._element._setMaskedBy(this._element.maskedBy),a&&this._element.enabled&&this._entity.enabled&&this._element.addModelToLayers(this._model),this._updateMeshes(),this._rangeStart=0,this._rangeEnd=this._symbols.length,this._updateRenderRange()}_removeMeshInstance(e){e.destroy();const t=this._model.meshInstances.indexOf(e);-1!==t&&this._model.meshInstances.splice(t,1)}_setMaterial(e){if(this._material=e,this._model)for(let t=0,s=this._model.meshInstances.length;t<s;t++){this._model.meshInstances[t].material=e}}_updateMaterial(e){const t=this._element,s=t._isScreenCulled(),i=function(e){return t.isVisibleForCamera(e)},n=this._font&&"msdf"===this._font.type;if(this._material=this._system.getTextElementMaterial(e,n,this._enableMarkup),this._model)for(let t=0,n=this._model.meshInstances.length;t<n;t++){const n=this._model.meshInstances[t];n.cull=!e,n.material=this._material,n.screenSpace=e,s?(n.cull=!0,n.isVisibleFunc=i):n.isVisibleFunc=null}}_updateMaterialEmissive(){this._symbolColors?(this._colorUniform[0]=1,this._colorUniform[1]=1,this._colorUniform[2]=1):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b)}_updateMaterialOutline(){this._symbolOutlineParams?(this._outlineColorUniform[0]=0,this._outlineColorUniform[1]=0,this._outlineColorUniform[2]=0,this._outlineColorUniform[3]=1):(this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a)}_updateMaterialShadow(){this._symbolOutlineParams?(this._shadowColorUniform[0]=0,this._shadowColorUniform[1]=0,this._shadowColorUniform[2]=0,this._shadowColorUniform[3]=0):(this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=this._shadowColor.a)}_isWordBoundary(e){return GM.test(e)}_isValidNextChar(e){return null!==e&&!XM.test(e)}_isNextCJKBoundary(e,t){return HM.test(e)&&(GM.test(t)||WM.test(t))}_isNextCJKWholeWord(e){return HM.test(e)}_updateMeshes(){const e=this._font.data,t=this,s=Math.min(this._minFontSize,this._maxFontSize),i=this._maxFontSize,n=this._shouldAutoFit();n&&(this._fontSize=this._maxFontSize);const a=this._symbols.length;let r=0,o=0,h=0,l=0,c=1,d=0,u=0,p=0,m=0,f=0,_=0;const g=Math.abs(this._element.anchor.x-this._element.anchor.z)>=1e-4;let y=this._element.calculatedWidth;(this.autoWidth&&!g||!this._wrapLines)&&(y=Number.POSITIVE_INFINITY);let v,x,b,S,w=0,T=0;function M(e,s,i){t._lineWidths.push(Math.abs(i));const n=p>s?s+1:p,a=p>s?p+1:s,h=e.slice(n,a);if(_){let e=h.length;for(;e--&&_>0;)VM.test(h[e])&&(h.splice(e,1),_--)}t._lineContents.push(h.join("")),r=0,o-=t._scaledLineHeight,c++,m=0,f=0,_=0,d=0,p=s}let C=!0;for(;C;){C=!1,this._scaledLineHeight=n?this._lineHeight*this._fontSize/(this._maxFontSize||1e-4):this._lineHeight,this.width=0,this.height=0,this._lineWidths=[],this._lineContents=[],r=0,o=0,h=0,l=0,c=1,d=0,u=0,p=0,m=0,f=0,_=0;const t=this._fontSize/32;w=this._fontMinY*t,T=this._fontMaxY*t;for(let e=0;e<this._meshInfo.length;e++)this._meshInfo[e].quad=0,this._meshInfo[e].lines={};let g=255,A=255,P=255,E=65535,R=65535,L=0,I=65535,D=65535,O=32639;for(let n=0;n<a;n++){v=this._symbols[n],S=n+1>=a?null:this._symbols[n+1];if(VM.test(v)){_++,(!this._wrapLines||this._maxLines<0||c<this._maxLines)&&(M(this._symbols,n,l),u=n+1,p=n+1);continue}let F,k,B=0,z=0,U=0,V=1;if(x=e.chars[v],!x)if(-1!==qM.indexOf(v))x=jM;else if(e.chars[" "])x=e.chars[" "];else for(const t in e.chars){x=e.chars[t];break}if(x){let e=0;if(f>0){const t=this._font.data.kerning;if(t){const s=t[X.getCodePoint(this._symbols[n-1])||0];s&&(e=s[X.getCodePoint(this._symbols[n])||0]||0)}}F=x.scale||1,k=(x.width+x.height)/2,V=t*k/F,U=(x.xadvance+e)*t,B=(x.xoffset-e)*t,z=x.yoffset*t}else console.error(`Couldn't substitute missing character: '${v}'`);const N=NM.test(v),G=x&&x.map||0,W=-this._font.data.info.maps[G].width/this._font.data.info.maps[G].height,H=this._meshInfo[G],q=r+this._spacing*U;if(q>y&&f>0&&!N&&(this._maxLines<0||c<this._maxLines)){if(0!==m){const t=Math.max(n-u,0);if(this._meshInfo.length<=1)H.lines[c-1]-=t,H.quad-=t;else{const t=n;for(let s=u;s<t;s++){const t=this._symbols[s],i=e.chars[t],n=this._meshInfo[i&&i.map||0];n.lines[c-1]-=1,n.quad-=1}}n-=t+1,M(this._symbols,u,d);continue}u=n,M(this._symbols,n,l)}b=H.quad,H.lines[c-1]=b;let j=r-B,Y=j+V;const $=o-z,K=$+V;if(this._rtl){const e=V-B-this._spacing*U-B;j-=e,Y-=e}let Z;if(H.positions[4*b*3+0]=j,H.positions[4*b*3+1]=$,H.positions[4*b*3+2]=h,H.positions[4*b*3+3]=Y,H.positions[4*b*3+4]=$,H.positions[4*b*3+5]=h,H.positions[4*b*3+6]=Y,H.positions[4*b*3+7]=K,H.positions[4*b*3+8]=h,H.positions[4*b*3+9]=j,H.positions[4*b*3+10]=K,H.positions[4*b*3+11]=h,this.width=Math.max(this.width,q),this._shouldAutoFitWidth()&&this.width>this._element.calculatedWidth&&(Z=Math.floor(this._element.fontSize*this._element.calculatedWidth/(this.width||1e-4)),Z=ne.clamp(Z,s,i),Z!==this._element.fontSize)){this._fontSize=Z,C=!0;break}if(this.height=Math.max(this.height,T-(o+w)),this._shouldAutoFitHeight()&&this.height>this._element.calculatedHeight&&(Z=ne.clamp(this._fontSize-1,s,i),Z!==this._element.fontSize)){this._fontSize=Z,C=!0;break}r+=this._spacing*U,N||(l=r),(this._isWordBoundary(v)||this._isValidNextChar(S)&&(this._isNextCJKBoundary(v,S)||this._isNextCJKWholeWord(S)))&&(m++,d=l,u=n+1),f++;const Q=this._getUv(v);if(H.uvs[4*b*2+0]=Q[0],H.uvs[4*b*2+1]=1-Q[1],H.uvs[4*b*2+2]=Q[2],H.uvs[4*b*2+3]=1-Q[1],H.uvs[4*b*2+4]=Q[2],H.uvs[4*b*2+5]=1-Q[3],H.uvs[4*b*2+6]=Q[0],H.uvs[4*b*2+7]=1-Q[3],this._symbolColors){const e=3*this._symbolColors[n];g=this._colorPalette[e],A=this._colorPalette[e+1],P=this._colorPalette[e+2]}if(H.colors[4*b*4+0]=g,H.colors[4*b*4+1]=A,H.colors[4*b*4+2]=P,H.colors[4*b*4+3]=255,H.colors[4*b*4+4]=g,H.colors[4*b*4+5]=A,H.colors[4*b*4+6]=P,H.colors[4*b*4+7]=255,H.colors[4*b*4+8]=g,H.colors[4*b*4+9]=A,H.colors[4*b*4+10]=P,H.colors[4*b*4+11]=255,H.colors[4*b*4+12]=g,H.colors[4*b*4+13]=A,H.colors[4*b*4+14]=P,H.colors[4*b*4+15]=255,this._symbolOutlineParams){const e=5*this._symbolOutlineParams[n];E=this._outlinePalette[e]+256*this._outlinePalette[e+1],R=this._outlinePalette[e+2]+256*this._outlinePalette[e+3],L=this._outlinePalette[e+4]}if(H.outlines[4*b*3+0]=E,H.outlines[4*b*3+1]=R,H.outlines[4*b*3+2]=L,H.outlines[4*b*3+3]=E,H.outlines[4*b*3+4]=R,H.outlines[4*b*3+5]=L,H.outlines[4*b*3+6]=E,H.outlines[4*b*3+7]=R,H.outlines[4*b*3+8]=L,H.outlines[4*b*3+9]=E,H.outlines[4*b*3+10]=R,H.outlines[4*b*3+11]=L,this._symbolShadowParams){const e=6*this._symbolShadowParams[n];I=this._shadowPalette[e]+256*this._shadowPalette[e+1],D=this._shadowPalette[e+2]+256*this._shadowPalette[e+3],O=this._shadowPalette[e+4]+127+256*Math.round(W*this._shadowPalette[e+5]+127)}H.shadows[4*b*3+0]=I,H.shadows[4*b*3+1]=D,H.shadows[4*b*3+2]=O,H.shadows[4*b*3+3]=I,H.shadows[4*b*3+4]=D,H.shadows[4*b*3+5]=O,H.shadows[4*b*3+6]=I,H.shadows[4*b*3+7]=D,H.shadows[4*b*3+8]=O,H.shadows[4*b*3+9]=I,H.shadows[4*b*3+10]=D,H.shadows[4*b*3+11]=O,H.quad++}C||p<a&&M(this._symbols,a,r)}this._noResize=!0,this.autoWidth=this._autoWidth,this.autoHeight=this._autoHeight,this._noResize=!1;const A=this._element.pivot.x,P=this._element.pivot.y,E=this._alignment.x,R=this._alignment.y;for(let e=0;e<this._meshInfo.length;e++){if(0===this._meshInfo[e].count)continue;let t=0;for(const s in this._meshInfo[e].lines){const i=this._meshInfo[e].lines[s],n=this._lineWidths[parseInt(s,10)],a=-A*this._element.calculatedWidth+E*(this._element.calculatedWidth-n)*(this._rtl?-1:1),r=(1-P)*this._element.calculatedHeight-T-(1-R)*(this._element.calculatedHeight-this.height);for(let s=t;s<=i;s++)this._meshInfo[e].positions[4*s*3]+=a,this._meshInfo[e].positions[4*s*3+3]+=a,this._meshInfo[e].positions[4*s*3+6]+=a,this._meshInfo[e].positions[4*s*3+9]+=a,this._meshInfo[e].positions[4*s*3+1]+=r,this._meshInfo[e].positions[4*s*3+4]+=r,this._meshInfo[e].positions[4*s*3+7]+=r,this._meshInfo[e].positions[4*s*3+10]+=r;if(this._rtl)for(let s=t;s<=i;s++){const t=4*s*3;for(let s=0;s<4;++s)this._meshInfo[e].positions[t+3*s]=this._element.calculatedWidth-this._meshInfo[e].positions[t+3*s]+2*a;const i=this._meshInfo[e].positions[t+3],n=this._meshInfo[e].positions[t+6];this._meshInfo[e].positions[t+3]=this._meshInfo[e].positions[t+0],this._meshInfo[e].positions[t+6]=this._meshInfo[e].positions[t+9],this._meshInfo[e].positions[t+0]=i,this._meshInfo[e].positions[t+9]=n}t=i+1}const s=4*this._meshInfo[e].count,i=4*this._meshInfo[e].quad,n=new vc(this._meshInfo[e].meshInstance.mesh.vertexBuffer);for(let t=0;t<s;t++)t>=i?(n.element.POSITION.set(0,0,0),n.element.TEXCOORD0.set(0,0),n.element.COLOR.set(0,0,0,0),n.element.ATTR8.set(0,0,0,0),n.element.ATTR9.set(0,0,0,0)):(n.element.POSITION.set(this._meshInfo[e].positions[3*t+0],this._meshInfo[e].positions[3*t+1],this._meshInfo[e].positions[3*t+2]),n.element.TEXCOORD0.set(this._meshInfo[e].uvs[2*t+0],this._meshInfo[e].uvs[2*t+1]),n.element.COLOR.set(this._meshInfo[e].colors[4*t+0],this._meshInfo[e].colors[4*t+1],this._meshInfo[e].colors[4*t+2],this._meshInfo[e].colors[4*t+3]),n.element.ATTR8.set(this._meshInfo[e].outlines[3*t+0],this._meshInfo[e].outlines[3*t+1],this._meshInfo[e].outlines[3*t+2]),n.element.ATTR9.set(this._meshInfo[e].shadows[3*t+0],this._meshInfo[e].shadows[3*t+1],this._meshInfo[e].shadows[3*t+2])),n.next();n.end(),this._meshInfo[e].meshInstance.mesh.aabb.compute(this._meshInfo[e].positions),this._meshInfo[e].meshInstance._aabbVer=-1}this._aabbDirty=!0}_onFontRender(){this.font=this._font}_onFontLoad(e){this.font!==e.resource&&(this.font=e.resource)}_onFontChange(e,t,s,i){if("data"===t){this._font.data=s;const e=this._font.data.info.maps.length;for(let t=0;t<e;t++){if(!this._meshInfo[t])continue;const e=this._meshInfo[t].meshInstance;e&&(e.setParameter("font_sdfIntensity",this._font.intensity),e.setParameter("font_pxrange",this._getPxRange(this._font)),e.setParameter("font_textureWidth",this._font.data.info.maps[t].width))}}}_onFontRemove(e){}_setTextureParams(e,t){this._font&&("msdf"===this._font.type?(e.deleteParameter("texture_emissiveMap"),e.deleteParameter("texture_opacityMap"),e.setParameter("texture_msdfMap",t)):"bitmap"===this._font.type&&(e.deleteParameter("texture_msdfMap"),e.setParameter("texture_emissiveMap",t),e.setParameter("texture_opacityMap",t)))}_getPxRange(e){const t=Object.keys(this._font.data.chars);for(let e=0;e<t.length;e++){const s=this._font.data.chars[t[e]];if(s.range)return(s.scale||1)*s.range}return 2}_getUv(e){const t=this._font.data;if(!t.chars[e]){const e=" ";return t.chars[e]?this._getUv(e):[0,0,0,0]}const s=t.chars[e].map,i=t.info.maps[s].width,n=t.info.maps[s].height,a=t.chars[e].x,r=t.chars[e].y,o=a,h=r,l=a+t.chars[e].width,c=r-t.chars[e].height,d=1-t.chars[e].height/n;return[o/i,d-h/n,l/i,d-c/n]}onEnable(){this._fontAsset.autoLoad=!0,this._model&&this._element.addModelToLayers(this._model)}onDisable(){this._fontAsset.autoLoad=!1,this._model&&this._element.removeModelFromLayers(this._model)}_setStencil(e){if(this._model){const t=this._model.meshInstances;for(let s=0;s<t.length;s++)t[s].stencilFront=e,t[s].stencilBack=e}}_shouldAutoFitWidth(){return this._autoFitWidth&&!this._autoWidth}_shouldAutoFitHeight(){return this._autoFitHeight&&!this._autoHeight}_shouldAutoFit(){return this._autoFitWidth&&!this._autoWidth||this._autoFitHeight&&!this._autoHeight}_calculateCharsPerTexture(e){const t={};void 0===e&&(e=this._symbols.length);for(let s=0,i=e;s<i;s++){const e=this._symbols[s];let i=this._font.data.chars[e];i||(i=this._font.data.chars[" "],i||(i=this._font.data.chars[Object.keys(this._font.data.chars)[0]]));const n=i.map;t[n]?t[n]++:t[n]=1}return t}_updateRenderRange(){const e=0===this._rangeStart?0:this._calculateCharsPerTexture(this._rangeStart),t=0===this._rangeEnd?0:this._calculateCharsPerTexture(this._rangeEnd);for(let s=0,i=this._meshInfo.length;s<i;s++){const i=e[s]||0,n=t[s]||0,a=this._meshInfo[s].meshInstance;if(a){const e=a.mesh;e&&(e.primitive[0].base=3*i*2,e.primitive[0].count=3*(n-i)*2)}}}set text(e){this._i18nKey=null;const t=null!=e&&e.toString()||"";this._setText(t)}get text(){return this._text}set key(e){const t=null!==e?e.toString():null;this._i18nKey!==t&&(this._i18nKey=t,t?(this._fontAsset.disableLocalization=!1,this._resetLocalizedText()):this._fontAsset.disableLocalization=!0)}get key(){return this._i18nKey}set color(e){const t=e.r,s=e.g,i=e.b;if((this._color.r!==t||this._color.g!==s||this._color.b!==i)&&(this._color.r=t,this._color.g=s,this._color.b=i,this._model)){if(this._symbolColors)this._font&&this._updateText();else{this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b;for(let e=0,t=this._model.meshInstances.length;e<t;e++){this._model.meshInstances[e].setParameter("material_emissive",this._colorUniform)}}this._element&&this._element.fire("set:color",this._color)}}get color(){return this._color}set opacity(e){if(this._color.a!==e&&(this._color.a=e,this._model))for(let t=0,s=this._model.meshInstances.length;t<s;t++){this._model.meshInstances[t].setParameter("material_opacity",e)}this._element&&this._element.fire("set:opacity",e)}get opacity(){return this._color.a}set lineHeight(e){const t=this._lineHeight;this._lineHeight=e,this._scaledLineHeight=e,t!==e&&this._font&&this._updateText()}get lineHeight(){return this._lineHeight}set wrapLines(e){const t=this._wrapLines;this._wrapLines=e,t!==e&&this._font&&this._updateText()}get wrapLines(){return this._wrapLines}get lines(){return this._lineContents}set spacing(e){const t=this._spacing;this._spacing=e,t!==e&&this._font&&this._updateText()}get spacing(){return this._spacing}set fontSize(e){const t=this._fontSize;this._fontSize=e,this._originalFontSize=e,t!==e&&this._font&&this._updateText()}get fontSize(){return this._fontSize}set fontAsset(e){this._fontAsset.defaultAsset=e}get fontAsset(){return this._fontAsset.localizedAsset}set font(e){let t;if(this._font&&(t=this._font.type,this._font.off&&this._font.off("render",this._onFontRender,this)),this._font=e,this._fontMinY=0,this._fontMaxY=0,!e)return;const s=this._font.data;for(const e in s.chars){const t=s.chars[e];t.bounds&&(this._fontMinY=Math.min(this._fontMinY,t.bounds[1]),this._fontMaxY=Math.max(this._fontMaxY,t.bounds[3]))}if(this._font.on&&this._font.on("render",this._onFontRender,this),this._fontAsset.localizedAsset){this._system.app.assets.get(this._fontAsset.localizedAsset).resource!==this._font&&(this._fontAsset.defaultAsset=null)}if(e.type!==t){const e=this._element._isScreenSpace();this._updateMaterial(e)}for(let e=0,t=this._font.textures.length;e<t;e++)if(this._meshInfo[e]){const t=this._meshInfo[e].meshInstance;t&&(t.setParameter("font_sdfIntensity",this._font.intensity),t.setParameter("font_pxrange",this._getPxRange(this._font)),t.setParameter("font_textureWidth",this._font.data.info.maps[e].width),this._setTextureParams(t,this._font.textures[e]))}else this._meshInfo[e]=new zM;let i=!1;for(let e=this._font.textures.length;e<this._meshInfo.length;e++)this._meshInfo[e].meshInstance&&(i||(this._element.removeModelFromLayers(this._model),i=!0),this._removeMeshInstance(this._meshInfo[e].meshInstance));this._meshInfo.length>this._font.textures.length&&(this._meshInfo.length=this._font.textures.length),this._updateText()}get font(){return this._font}set alignment(e){e instanceof ve?this._alignment.set(e.x,e.y):this._alignment.set(e[0],e[1]),this._font&&this._updateText()}get alignment(){return this._alignment}set autoWidth(e){const t=this._autoWidth;if(this._autoWidth=e,e&&Math.abs(this._element.anchor.x-this._element.anchor.z)<1e-4&&(this._element.width=this.width),t!==e){const e=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;e!==this._fontSize&&(this._fontSize=e,this._font&&this._updateText())}}get autoWidth(){return this._autoWidth}set autoHeight(e){const t=this._autoHeight;if(this._autoHeight=e,e&&Math.abs(this._element.anchor.y-this._element.anchor.w)<1e-4&&(this._element.height=this.height),t!==e){const e=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;e!==this._fontSize&&(this._fontSize=e,this._font&&this._updateText())}}get autoHeight(){return this._autoHeight}set rtlReorder(e){this._rtlReorder!==e&&(this._rtlReorder=e,this._font&&this._updateText())}get rtlReorder(){return this._rtlReorder}set unicodeConverter(e){this._unicodeConverter!==e&&(this._unicodeConverter=e,this._setText(this._text))}get unicodeConverter(){return this._unicodeConverter}get aabb(){if(this._aabbDirty){let e=!1;for(let t=0;t<this._meshInfo.length;t++)this._meshInfo[t].meshInstance&&(e?this._aabb.add(this._meshInfo[t].meshInstance.aabb):(this._aabb.copy(this._meshInfo[t].meshInstance.aabb),e=!0));this._aabbDirty=!1}return this._aabb}set outlineColor(e){const t=e instanceof pe?e.r:e[0],s=e instanceof pe?e.g:e[1],i=e instanceof pe?e.b:e[2],n=e instanceof pe?e.a:e[3];if((this._outlineColor.r!==t||this._outlineColor.g!==s||this._outlineColor.b!==i||this._outlineColor.a!==n)&&(this._outlineColor.r=t,this._outlineColor.g=s,this._outlineColor.b=i,this._outlineColor.a=n,this._model)){if(this._symbolOutlineParams)this._font&&this._updateText();else{this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a;for(let e=0,t=this._model.meshInstances.length;e<t;e++){this._model.meshInstances[e].setParameter("outline_color",this._outlineColorUniform)}}this._element&&this._element.fire("set:outline",this._color)}}get outlineColor(){return this._outlineColor}set outlineThickness(e){const t=this._outlineThickness;if(this._outlineThickness=e,t!==e&&this._font){if(!this._model)return;if(this._symbolOutlineParams)this._font&&this._updateText();else for(let e=0,t=this._model.meshInstances.length;e<t;e++){this._model.meshInstances[e].setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness)}}}get outlineThickness(){return this._outlineThickness}set shadowColor(e){const t=e instanceof pe?e.r:e[0],s=e instanceof pe?e.g:e[1],i=e instanceof pe?e.b:e[2],n=e instanceof pe?e.a:e[3];if((this._shadowColor.r!==t||this._shadowColor.g!==s||this._shadowColor.b!==i||this._shadowColor.a!==n)&&(this._shadowColor.r=t,this._shadowColor.g=s,this._shadowColor.b=i,this._shadowColor.a=n,this._model))if(this._symbolShadowParams)this._font&&this._updateText();else{this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=this._shadowColor.a;for(let e=0,t=this._model.meshInstances.length;e<t;e++){this._model.meshInstances[e].setParameter("shadow_color",this._shadowColorUniform)}}}get shadowColor(){return this._shadowColor}set shadowOffset(e){const t=e instanceof ve?e.x:e[0],s=e instanceof ve?e.y:e[1];if((this._shadowOffset.x!==t||this._shadowOffset.y!==s)&&(this._shadowOffset.set(t,s),this._font&&this._model))if(this._symbolShadowParams)this._updateText();else for(let e=0,t=this._model.meshInstances.length;e<t;e++){const t=-this._font.data.info.maps[e].width/this._font.data.info.maps[e].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=t*this._shadowOffsetScale*this._shadowOffset.y;this._model.meshInstances[e].setParameter("shadow_offset",this._shadowOffsetUniform)}}get shadowOffset(){return this._shadowOffset}set minFontSize(e){this._minFontSize!==e&&(this._minFontSize=e,this.font&&this._shouldAutoFit()&&this._updateText())}get minFontSize(){return this._minFontSize}set maxFontSize(e){this._maxFontSize!==e&&(this._maxFontSize=e,this.font&&this._shouldAutoFit()&&this._updateText())}get maxFontSize(){return this._maxFontSize}set autoFitWidth(e){this._autoFitWidth!==e&&(this._autoFitWidth=e,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}get autoFitWidth(){return this._autoFitWidth}set autoFitHeight(e){this._autoFitHeight!==e&&(this._autoFitHeight=e,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}get autoFitHeight(){return this._autoFitHeight}set maxLines(e){this._maxLines!==e&&(null===e&&-1===this._maxLines||(this._maxLines=null===e?-1:e,this.font&&this._wrapLines&&this._updateText()))}get maxLines(){return this._maxLines}set enableMarkup(e){if(e=!!e,this._enableMarkup===e)return;this._enableMarkup=e,this.font&&this._updateText();const t=this._element._isScreenSpace();this._updateMaterial(t)}get enableMarkup(){return this._enableMarkup}get symbols(){return this._symbols}get symbolColors(){return null===this._symbolColors?null:this._symbolColors.map((function(e){return this._colorPalette.slice(3*e,3*e+3)}),this)}get symbolOutlineParams(){return null===this._symbolOutlineParams?null:this._symbolOutlineParams.map((function(e){return this._outlinePalette.slice(5*e,5*e+5)}),this)}get symbolShadowParams(){return null===this._symbolShadowParams?null:this._symbolShadowParams.map((function(e){return this._shadowPalette.slice(6*e,6*e+6)}),this)}get rtl(){return this._rtl}set rangeStart(e){(e=Math.max(0,Math.min(e,this._symbols.length)))!==this._rangeStart&&(this._rangeStart=e,this._updateRenderRange())}get rangeStart(){return this._rangeStart}set rangeEnd(e){(e=Math.max(this._rangeStart,Math.min(e,this._symbols.length)))!==this._rangeEnd&&(this._rangeEnd=e,this._updateRenderRange())}get rangeEnd(){return this._rangeEnd}}const ZM=new ge,QM=new Ce,JM=new ge,eC=new ge,tC=new Ce,sC=new Ce,iC=new Ce,nC=new Ce;class aC extends Tm{constructor(e,t){super(e,t),this._beingInitialized=!1,this._anchor=new xe,this._localAnchor=new xe,this._pivot=new ve,this._width=this._calculatedWidth=32,this._height=this._calculatedHeight=32,this._margin=new xe(0,0,-32,-32),this._modelTransform=new Ce,this._screenToWorld=new Ce,this._anchorTransform=new Ce,this._anchorDirty=!0,this._parentWorldTransform=new Ce,this._screenTransform=new Ce,this._screenCorners=[new ge,new ge,new ge,new ge],this._canvasCorners=[new ve,new ve,new ve,new ve],this._worldCorners=[new ge,new ge,new ge,new ge],this._cornersDirty=!0,this._canvasCornersDirty=!0,this._worldCornersDirty=!0,this.entity.on("insert",this._onInsert,this),this._patch(),this.screen=null,this._type="group",this._image=null,this._text=null,this._group=null,this._drawOrder=0,this._fitMode="stretch",this._useInput=!1,this._layers=[4],this._addedModels=[],this._batchGroupId=-1,this._offsetReadAt=0,this._maskOffset=.5,this._maskedBy=null}get _absLeft(){return this._localAnchor.x+this._margin.x}get _absRight(){return this._localAnchor.z-this._margin.z}get _absTop(){return this._localAnchor.w-this._margin.w}get _absBottom(){return this._localAnchor.y+this._margin.y}get _hasSplitAnchorsX(){return Math.abs(this._anchor.x-this._anchor.z)>.001}get _hasSplitAnchorsY(){return Math.abs(this._anchor.y-this._anchor.w)>.001}get aabb(){return this._image?this._image.aabb:this._text?this._text.aabb:null}set anchor(e){e instanceof xe?this._anchor.set(e.x,e.y,e.z,e.w):this._anchor.set(e[0],e[1],e[2],e[3]),this.entity._parent||this.screen?this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY):this._calculateLocalAnchors(),this._anchorDirty=!0,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:anchor",this._anchor)}get anchor(){return this._anchor}set batchGroupId(e){if(this._batchGroupId!==e){var t,s;if(this.entity.enabled&&this._batchGroupId>=0)null==(t=this.system.app.batcher)||t.remove(rd.ELEMENT,this.batchGroupId,this.entity);if(this.entity.enabled&&e>=0)null==(s=this.system.app.batcher)||s.insert(rd.ELEMENT,e,this.entity);e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&(this._image&&this._image._renderable.model?this.addModelToLayers(this._image._renderable.model):this._text&&this._text._model&&this.addModelToLayers(this._text._model)),this._batchGroupId=e}}get batchGroupId(){return this._batchGroupId}set bottom(e){this._margin.y=e;const t=this.entity.getLocalPosition(),s=this._absTop,i=this._localAnchor.y+e;this._setHeight(s-i),t.y=e+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(t)}get bottom(){return this._margin.y}set calculatedWidth(e){this._setCalculatedWidth(e,!0)}get calculatedWidth(){return this._calculatedWidth}set calculatedHeight(e){this._setCalculatedHeight(e,!0)}get calculatedHeight(){return this._calculatedHeight}get canvasCorners(){if(!this._canvasCornersDirty||!this.screen||!this.screen.screen.screenSpace)return this._canvasCorners;const e=this.system.app.graphicsDevice,t=this.screenCorners,s=e.canvas.clientWidth/e.width,i=e.canvas.clientHeight/e.height;for(let n=0;n<4;n++)this._canvasCorners[n].set(t[n].x*s,(e.height-t[n].y)*i);return this._canvasCornersDirty=!1,this._canvasCorners}set drawOrder(e){let t=0;this.screen&&(t=this.screen.screen.priority),e>16777215&&(e=16777215),this._drawOrder=(t<<24)+e,this.fire("set:draworder",this._drawOrder)}get drawOrder(){return this._drawOrder}set height(e){this._height=e,this._hasSplitAnchorsY||this._setCalculatedHeight(e,!0),this.fire("set:height",this._height)}get height(){return this._height}set layers(e){if(this._addedModels.length)for(let e=0;e<this._layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this._layers[e]);if(t)for(let e=0;e<this._addedModels.length;e++)t.removeMeshInstances(this._addedModels[e].meshInstances)}if(this._layers=e,this.enabled&&this.entity.enabled&&this._addedModels.length)for(let e=0;e<this._layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this._layers[e]);if(t)for(let e=0;e<this._addedModels.length;e++)t.addMeshInstances(this._addedModels[e].meshInstances)}}get layers(){return this._layers}set left(e){this._margin.x=e;const t=this.entity.getLocalPosition(),s=this._absRight,i=this._localAnchor.x+e;this._setWidth(s-i),t.x=e+this._calculatedWidth*this._pivot.x,this.entity.setLocalPosition(t)}get left(){return this._margin.x}set margin(e){this._margin.copy(e),this._calculateSize(!0,!0),this.fire("set:margin",this._margin)}get margin(){return this._margin}get maskedBy(){return this._maskedBy}set pivot(e){const t=this._pivot.x,s=this._pivot.y;e instanceof ve?this._pivot.set(e.x,e.y):this._pivot.set(e[0],e[1]);const i=this._margin.x+this._margin.z,n=this._pivot.x-t;this._margin.x+=i*n,this._margin.z-=i*n;const a=this._margin.y+this._margin.w,r=this._pivot.y-s;this._margin.y+=a*r,this._margin.w-=a*r,this._anchorDirty=!0,this._cornersDirty=!0,this._worldCornersDirty=!0,this._calculateSize(!1,!1),this._flagChildrenAsDirty(),this.fire("set:pivot",this._pivot)}get pivot(){return this._pivot}set right(e){this._margin.z=e;const t=this.entity.getLocalPosition(),s=this._absLeft,i=this._localAnchor.z-e;this._setWidth(i-s),t.x=this._localAnchor.z-this._localAnchor.x-e-this._calculatedWidth*(1-this._pivot.x),this.entity.setLocalPosition(t)}get right(){return this._margin.z}get screenCorners(){if(!this._cornersDirty||!this.screen)return this._screenCorners;const e=this.entity.parent&&this.entity.parent.element&&this.entity.parent.element.screenCorners[0];this._screenCorners[0].set(this._absLeft,this._absBottom,0),this._screenCorners[1].set(this._absRight,this._absBottom,0),this._screenCorners[2].set(this._absRight,this._absTop,0),this._screenCorners[3].set(this._absLeft,this._absTop,0);const t=this.screen.screen.screenSpace;for(let s=0;s<4;s++)this._screenTransform.transformPoint(this._screenCorners[s],this._screenCorners[s]),t&&this._screenCorners[s].mulScalar(this.screen.screen.scale),e&&this._screenCorners[s].add(e);return this._cornersDirty=!1,this._canvasCornersDirty=!0,this._worldCornersDirty=!0,this._screenCorners}get textWidth(){return this._text?this._text.width:0}get textHeight(){return this._text?this._text.height:0}set top(e){this._margin.w=e;const t=this.entity.getLocalPosition(),s=this._absBottom,i=this._localAnchor.w-e;this._setHeight(i-s),t.y=this._localAnchor.w-this._localAnchor.y-e-this._calculatedHeight*(1-this._pivot.y),this.entity.setLocalPosition(t)}get top(){return this._margin.w}set type(e){e!==this._type&&(this._type=e,this._image&&(this._image.destroy(),this._image=null),this._text&&(this._text.destroy(),this._text=null),"image"===e?this._image=new LM(this):"text"===e&&(this._text=new KM(this)))}get type(){return this._type}set useInput(e){this._useInput!==e&&(this._useInput=e,this.system.app.elementInput?e?this.enabled&&this.entity.enabled&&this.system.app.elementInput.addElement(this):this.system.app.elementInput.removeElement(this):this._useInput,this.fire("set:useInput",e))}get useInput(){return this._useInput}set fitMode(e){this._fitMode=e,this._calculateSize(!0,!0),this._image&&this._image.refreshMesh()}get fitMode(){return this._fitMode}set width(e){this._width=e,this._hasSplitAnchorsX||this._setCalculatedWidth(e,!0),this.fire("set:width",this._width)}get width(){return this._width}get worldCorners(){if(!this._worldCornersDirty)return this._worldCorners;if(this.screen){const e=this.screenCorners;if(!this.screen.screen.screenSpace){tC.copy(this.screen.screen._screenMatrix),tC.data[13]=-tC.data[13],tC.mul2(this.screen.getWorldTransform(),tC);for(let t=0;t<4;t++)tC.transformPoint(e[t],this._worldCorners[t])}}else{const e=this.entity.getLocalPosition();tC.setTranslate(-e.x,-e.y,-e.z),sC.setTRS(ge.ZERO,this.entity.getLocalRotation(),this.entity.getLocalScale()),iC.setTranslate(e.x,e.y,e.z);const t=this.entity.parent?this.entity.parent:this.entity;nC.copy(t.getWorldTransform()),nC.mul(iC).mul(sC).mul(tC),JM.set(e.x-this.pivot.x*this.calculatedWidth,e.y-this.pivot.y*this.calculatedHeight,e.z),nC.transformPoint(JM,this._worldCorners[0]),JM.set(e.x+(1-this.pivot.x)*this.calculatedWidth,e.y-this.pivot.y*this.calculatedHeight,e.z),nC.transformPoint(JM,this._worldCorners[1]),JM.set(e.x+(1-this.pivot.x)*this.calculatedWidth,e.y+(1-this.pivot.y)*this.calculatedHeight,e.z),nC.transformPoint(JM,this._worldCorners[2]),JM.set(e.x-this.pivot.x*this.calculatedWidth,e.y+(1-this.pivot.y)*this.calculatedHeight,e.z),nC.transformPoint(JM,this._worldCorners[3])}return this._worldCornersDirty=!1,this._worldCorners}_patch(){this.entity._sync=this._sync,this.entity.setPosition=this._setPosition,this.entity.setLocalPosition=this._setLocalPosition}_unpatch(){this.entity._sync=$m.prototype._sync,this.entity.setPosition=$m.prototype.setPosition,this.entity.setLocalPosition=$m.prototype.setLocalPosition}_setPosition(e,t,s){if(!this.element.screen)return $m.prototype.setPosition.call(this,e,t,s);e instanceof ge?ZM.copy(e):ZM.set(e,t,s),this.getWorldTransform(),QM.copy(this.element._screenToWorld).invert(),QM.transformPoint(ZM,this.localPosition),this._dirtyLocal||this._dirtifyLocal()}_setLocalPosition(e,t,s){e instanceof ge?this.localPosition.copy(e):this.localPosition.set(e,t,s);const i=this.element,n=this.localPosition,a=i._pivot;i._margin.x=n.x-i._calculatedWidth*a.x,i._margin.z=i._localAnchor.z-i._localAnchor.x-i._calculatedWidth-i._margin.x,i._margin.y=n.y-i._calculatedHeight*a.y,i._margin.w=i._localAnchor.w-i._localAnchor.y-i._calculatedHeight-i._margin.y,this._dirtyLocal||this._dirtifyLocal()}_sync(){const e=this.element,t=e.screen;if(t){if(e._anchorDirty){let s=0,i=0,n=0,a=1;if(this._parent&&this._parent.element)s=this._parent.element.calculatedWidth,i=this._parent.element.calculatedHeight,n=this._parent.element.pivot.x,a=this._parent.element.pivot.y;else{const e=t.screen.resolution;s=e.x/t.screen.scale,i=e.y/t.screen.scale}e._anchorTransform.setTranslate(s*(e.anchor.x-n),-i*(a-e.anchor.y),0),e._anchorDirty=!1,e._calculateLocalAnchors()}e._sizeDirty&&e._calculateSize(!1,!1)}if(this._dirtyLocal){this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale);const t=this.localPosition,s=e._pivot;e._margin.x=t.x-e._calculatedWidth*s.x,e._margin.z=e._localAnchor.z-e._localAnchor.x-e._calculatedWidth-e._margin.x,e._margin.y=t.y-e._calculatedHeight*s.y,e._margin.w=e._localAnchor.w-e._localAnchor.y-e._calculatedHeight-e._margin.y,this._dirtyLocal=!1}if(!t)return this._dirtyWorld&&(e._cornersDirty=!0,e._canvasCornersDirty=!0,e._worldCornersDirty=!0),$m.prototype._sync.call(this);if(this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this._parent.element?e._screenToWorld.mul2(this._parent.element._modelTransform,e._anchorTransform):e._screenToWorld.copy(e._anchorTransform),e._modelTransform.mul2(e._screenToWorld,this.localTransform),t){e._screenToWorld.mul2(t.screen._screenMatrix,e._screenToWorld),t.screen.screenSpace||e._screenToWorld.mul2(t.worldTransform,e._screenToWorld),this.worldTransform.mul2(e._screenToWorld,this.localTransform);const s=e._parentWorldTransform;s.setIdentity();const i=this._parent;i&&i.element&&i!==t&&(tC.setTRS(ge.ZERO,i.getLocalRotation(),i.getLocalScale()),s.mul2(i.element._parentWorldTransform,tC));const n=JM;n.set(0,0,this.localPosition.z);const a=eC;a.set(e._absLeft+e._pivot.x*e.calculatedWidth,e._absBottom+e._pivot.y*e.calculatedHeight,0),tC.setTranslate(-a.x,-a.y,-a.z),sC.setTRS(n,this.getLocalRotation(),this.getLocalScale()),iC.setTranslate(a.x,a.y,a.z),e._screenTransform.mul2(e._parentWorldTransform,iC).mul(sC).mul(tC),e._cornersDirty=!0,e._canvasCornersDirty=!0,e._worldCornersDirty=!0}else this.worldTransform.copy(e._modelTransform);this._dirtyWorld=!1}}_onInsert(e){const t=this._parseUpToScreen();this.entity._dirtifyWorld(),this._updateScreen(t.screen),this._dirtifyMask()}_dirtifyMask(){let e=this.entity;for(;e;){const t=e.parent;if((null===t||t.screen)&&e.element){this.system._prerender&&this.system._prerender.length||(this.system._prerender=[],this.system.app.once("prerender",this._onPrerender,this));const t=this.system._prerender.indexOf(this.entity);t>=0&&this.system._prerender.splice(t,1);this.system._prerender.indexOf(e)<0&&this.system._prerender.push(e)}e=t}}_onPrerender(){for(let e=0;e<this.system._prerender.length;e++){const t=this.system._prerender[e];if(t.element){const e=1;t.element.syncMask(e)}}this.system._prerender.length=0}_bindScreen(e){e._bindElement(this)}_unbindScreen(e){e._unbindElement(this)}_updateScreen(e){this.screen&&this.screen!==e&&this._unbindScreen(this.screen.screen);const t=this.screen;this.screen=e,this.screen&&this._bindScreen(this.screen.screen),this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("set:screen",this.screen,t),this._anchorDirty=!0;const s=this.entity.children;for(let t=0,i=s.length;t<i;t++)s[t].element&&s[t].element._updateScreen(e);this.screen&&this.screen.screen.syncDrawOrder()}syncMask(e){const t=this._parseUpToScreen();this._updateMask(t.mask,e)}_setMaskedBy(e){const t=this._image||this._text;if(e){const s=e.element._image._maskRef,i=new c_({ref:s,func:2});t&&t._setStencil&&t._setStencil(i),this._maskedBy=e}else t&&t._setStencil&&t._setStencil(null),this._maskedBy=null}_updateMask(e,t){if(e){if(this._setMaskedBy(e),this.mask){const s=e.element._image._maskRef,i=new c_({ref:s,func:2,zpass:3});this._image._setStencil(i),this._image._maskRef=t,t++,e=this.entity}const s=this.entity.children;for(let i=0,n=s.length;i<n;i++)s[i].element&&s[i].element._updateMask(e,t);this.mask&&t--}else{if(this._setMaskedBy(null),this.mask){const s=new c_({ref:t,func:7,zpass:2});this._image._setStencil(s),this._image._maskRef=t,t++,e=this.entity}const s=this.entity.children;for(let i=0,n=s.length;i<n;i++)s[i].element&&s[i].element._updateMask(e,t);this.mask&&t--}}_parseUpToScreen(){const e={screen:null,mask:null};let t=this.entity._parent;for(;t&&!t.screen;)t.element&&t.element.mask&&(e.mask||(e.mask=t)),t=t.parent;return t&&t.screen&&(e.screen=t),e}_onScreenResize(e){this._anchorDirty=!0,this._cornersDirty=!0,this._worldCornersDirty=!0,this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("screen:set:resolution",e)}_onScreenSpaceChange(){this.fire("screen:set:screenspace",this.screen.screen.screenSpace)}_onScreenRemove(){this.screen&&(this.screen._destroying?this.screen=null:this._updateScreen(null))}_calculateLocalAnchors(){let e=1e3,t=1e3;const s=this.entity._parent;if(s&&s.element)e=s.element.calculatedWidth,t=s.element.calculatedHeight;else if(this.screen){const s=this.screen.screen.resolution,i=this.screen.screen.scale;e=s.x/i,t=s.y/i}this._localAnchor.set(this._anchor.x*e,this._anchor.y*t,this._anchor.z*e,this._anchor.w*t)}getOffsetPosition(e,t){const s=this.entity.getLocalPosition().clone();return s.x+=e,s.y+=t,this._screenToWorld.transformPoint(s,s),s}onLayersChanged(e,t){this.addModelToLayers(this._image?this._image._renderable.model:this._text._model),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||(this._image?e.addMeshInstances(this._image._renderable.model.meshInstances):this._text&&e.addMeshInstances(this._text._model.meshInstances))}onLayerRemoved(e){this.layers.indexOf(e.id)<0||(this._image?e.removeMeshInstances(this._image._renderable.model.meshInstances):this._text&&e.removeMeshInstances(this._text._model.meshInstances))}onEnable(){var e;(this._image&&this._image.onEnable(),this._text&&this._text.onEnable(),this._group&&this._group.onEnable(),this.useInput&&this.system.app.elementInput&&this.system.app.elementInput.addElement(this),this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this._batchGroupId>=0)&&(null==(e=this.system.app.batcher)||e.insert(rd.ELEMENT,this.batchGroupId,this.entity));this.fire("enableelement")}onDisable(){var e;(this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this._image&&this._image.onDisable(),this._text&&this._text.onDisable(),this._group&&this._group.onDisable(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this._batchGroupId>=0)&&(null==(e=this.system.app.batcher)||e.remove(rd.ELEMENT,this.batchGroupId,this.entity));this.fire("disableelement")}onRemove(){this.entity.off("insert",this._onInsert,this),this._unpatch(),this._image&&this._image.destroy(),this._text&&this._text.destroy(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this.screen&&this.screen.screen&&(this._unbindScreen(this.screen.screen),this.screen.screen.syncDrawOrder()),this.off()}_calculateSize(e,t){if(!this.entity._parent&&!this.screen)return;this._calculateLocalAnchors();const s=this._absRight-this._absLeft,i=this._absTop-this._absBottom;e?this._setWidth(s):this._setCalculatedWidth(s,!1),t?this._setHeight(i):this._setCalculatedHeight(i,!1);const n=this.entity.getLocalPosition();n.x=this._margin.x+this._calculatedWidth*this._pivot.x,n.y=this._margin.y+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(n),this._sizeDirty=!1}_setWidth(e){this._width=e,this._setCalculatedWidth(e,!1),this.fire("set:width",this._width)}_setHeight(e){this._height=e,this._setCalculatedHeight(e,!1),this.fire("set:height",this._height)}_setCalculatedWidth(e,t){if(!(Math.abs(e-this._calculatedWidth)<=1e-4)){if(this._calculatedWidth=e,this.entity._dirtifyLocal(),t){const e=this.entity.getLocalPosition(),t=this._pivot;this._margin.x=e.x-this._calculatedWidth*t.x,this._margin.z=this._localAnchor.z-this._localAnchor.x-this._calculatedWidth-this._margin.x}this._flagChildrenAsDirty(),this.fire("set:calculatedWidth",this._calculatedWidth),this.fire("resize",this._calculatedWidth,this._calculatedHeight)}}_setCalculatedHeight(e,t){if(!(Math.abs(e-this._calculatedHeight)<=1e-4)){if(this._calculatedHeight=e,this.entity._dirtifyLocal(),t){const e=this.entity.getLocalPosition(),t=this._pivot;this._margin.y=e.y-this._calculatedHeight*t.y,this._margin.w=this._localAnchor.w-this._localAnchor.y-this._calculatedHeight-this._margin.y}this._flagChildrenAsDirty(),this.fire("set:calculatedHeight",this._calculatedHeight),this.fire("resize",this._calculatedWidth,this._calculatedHeight)}}_flagChildrenAsDirty(){const e=this.entity._children;for(let t=0,s=e.length;t<s;t++)e[t].element&&(e[t].element._anchorDirty=!0,e[t].element._sizeDirty=!0)}addModelToLayers(e){this._addedModels.push(e);for(let t=0;t<this.layers.length;t++){const s=this.system.app.scene.layers.getLayerById(this.layers[t]);s&&s.addMeshInstances(e.meshInstances)}}removeModelFromLayers(e){const t=this._addedModels.indexOf(e);t>=0&&this._addedModels.splice(t,1);for(let t=0;t<this.layers.length;t++){const s=this.system.app.scene.layers.getLayerById(this.layers[t]);s&&s.removeMeshInstances(e.meshInstances)}}getMaskOffset(){const e=this.system.app.frame;this._offsetReadAt!==e&&(this._maskOffset=.5,this._offsetReadAt=e);const t=this._maskOffset;return this._maskOffset-=.001,t}isVisibleForCamera(e){let t,s,i,n;if(this.maskedBy){const e=this.maskedBy.element.screenCorners;t=Math.min(Math.min(e[0].x,e[1].x),Math.min(e[2].x,e[3].x)),s=Math.max(Math.max(e[0].x,e[1].x),Math.max(e[2].x,e[3].x)),n=Math.min(Math.min(e[0].y,e[1].y),Math.min(e[2].y,e[3].y)),i=Math.max(Math.max(e[0].y,e[1].y),Math.max(e[2].y,e[3].y))}else{const a=this.system.app.graphicsDevice.width,r=this.system.app.graphicsDevice.height,o=e._rect.z*a,h=e._rect.w*r;t=e._rect.x*a,s=t+o,i=(1-e._rect.y)*r,n=i-h}const a=this.screenCorners,r=Math.min(Math.min(a[0].x,a[1].x),Math.min(a[2].x,a[3].x)),o=Math.max(Math.max(a[0].x,a[1].x),Math.max(a[2].x,a[3].x)),h=Math.min(Math.min(a[0].y,a[1].y),Math.min(a[2].y,a[3].y)),l=Math.max(Math.max(a[0].y,a[1].y),Math.max(a[2].y,a[3].y));return!(o<t||r>s||h>i||l<n)}_isScreenSpace(){return!(!this.screen||!this.screen.screen)&&this.screen.screen.screenSpace}_isScreenCulled(){return!(!this.screen||!this.screen.screen)&&this.screen.screen.cull}_dirtyBatch(){var e;-1!==this.batchGroupId&&(null==(e=this.system.app.batcher)||e.markGroupDirty(this.batchGroupId))}}function rC(e){Object.defineProperty(aC.prototype,e,{get:function(){return this._text?this._text[e]:this._image?this._image[e]:null},set:function(t){this._text?(this._text[e]!==t&&this._dirtyBatch(),this._text[e]=t):this._image&&(this._image[e]!==t&&this._dirtyBatch(),this._image[e]=t)}})}rC("fontSize"),rC("minFontSize"),rC("maxFontSize"),rC("maxLines"),rC("autoFitWidth"),rC("autoFitHeight"),rC("color"),rC("font"),rC("fontAsset"),rC("spacing"),rC("lineHeight"),rC("wrapLines"),rC("lines"),rC("alignment"),rC("autoWidth"),rC("autoHeight"),rC("rtlReorder"),rC("unicodeConverter"),rC("text"),rC("key"),rC("texture"),rC("textureAsset"),rC("material"),rC("materialAsset"),rC("sprite"),rC("spriteAsset"),rC("spriteFrame"),rC("pixelsPerUnit"),rC("opacity"),rC("rect"),rC("mask"),rC("outlineColor"),rC("outlineThickness"),rC("shadowColor"),rC("shadowOffset"),rC("enableMarkup"),rC("rangeStart"),rC("rangeEnd");class oC{constructor(){this.enabled=!0}}const hC=["enabled"];class lC extends Uw{constructor(e){super(e),this.id="element",this.ComponentType=aC,this.DataType=oC,this.schema=hC,this._unicodeConverter=null,this._rtlReorder=null,this._defaultTexture=new fh(e.graphicsDevice,{width:1,height:1,format:7,name:"element-system"});const t=this._defaultTexture.lock(),s=new Uint8Array(4);s[0]=255,s[1]=255,s[2]=255,s[3]=255,t.set(s),this._defaultTexture.unlock(),this.defaultImageMaterial=null,this.defaultImage9SlicedMaterial=null,this.defaultImage9TiledMaterial=null,this.defaultImageMaskMaterial=null,this.defaultImage9SlicedMaskMaterial=null,this.defaultImage9TiledMaskMaterial=null,this.defaultScreenSpaceImageMaterial=null,this.defaultScreenSpaceImage9SlicedMaterial=null,this.defaultScreenSpaceImage9TiledMaterial=null,this.defaultScreenSpaceImageMask9SlicedMaterial=null,this.defaultScreenSpaceImageMask9TiledMaterial=null,this.defaultScreenSpaceImageMaskMaterial=null,this._defaultTextMaterials={},this.defaultImageMaterials=[],this.on("beforeremove",this.onRemoveComponent,this)}destroy(){super.destroy(),this._defaultTexture.destroy()}initializeComponentData(e,t,s){e._beingInitialized=!0,void 0!==t.anchor&&(t.anchor instanceof xe?e.anchor.copy(t.anchor):e.anchor.set(t.anchor[0],t.anchor[1],t.anchor[2],t.anchor[3])),void 0!==t.pivot&&(t.pivot instanceof ve?e.pivot.copy(t.pivot):e.pivot.set(t.pivot[0],t.pivot[1]));const i=Math.abs(e.anchor.x-e.anchor.z)>.001,n=Math.abs(e.anchor.y-e.anchor.w)>.001;let a,r=!1;void 0!==t.margin&&(t.margin instanceof xe?e.margin.copy(t.margin):e._margin.set(t.margin[0],t.margin[1],t.margin[2],t.margin[3]),r=!0),void 0!==t.left&&(e._margin.x=t.left,r=!0),void 0!==t.bottom&&(e._margin.y=t.bottom,r=!0),void 0!==t.right&&(e._margin.z=t.right,r=!0),void 0!==t.top&&(e._margin.w=t.top,r=!0),r&&(e.margin=e._margin);let o=!1;void 0===t.width||i?i&&(o=!0):e.width=t.width,void 0===t.height||n?n&&(o=!0):e.height=t.height,o&&(e.anchor=e.anchor),void 0!==t.enabled&&(e.enabled=t.enabled),void 0!==t.useInput&&(e.useInput=t.useInput),void 0!==t.fitMode&&(e.fitMode=t.fitMode),e.batchGroupId=void 0===t.batchGroupId||null===t.batchGroupId?-1:t.batchGroupId,t.layers&&Array.isArray(t.layers)&&(e.layers=t.layers.slice(0)),void 0!==t.type&&(e.type=t.type),"image"===e.type?(void 0!==t.rect&&(e.rect=t.rect),void 0!==t.color&&(a=t.color,a instanceof pe||(a=new pe(t.color[0],t.color[1],t.color[2])),e.color=a),void 0!==t.opacity&&(e.opacity=t.opacity),void 0!==t.textureAsset&&(e.textureAsset=t.textureAsset),t.texture&&(e.texture=t.texture),void 0!==t.spriteAsset&&(e.spriteAsset=t.spriteAsset),t.sprite&&(e.sprite=t.sprite),void 0!==t.spriteFrame&&(e.spriteFrame=t.spriteFrame),void 0!==t.pixelsPerUnit&&null!==t.pixelsPerUnit&&(e.pixelsPerUnit=t.pixelsPerUnit),void 0!==t.materialAsset&&(e.materialAsset=t.materialAsset),t.material&&(e.material=t.material),void 0!==t.mask&&(e.mask=t.mask)):"text"===e.type&&(void 0!==t.autoWidth&&(e.autoWidth=t.autoWidth),void 0!==t.autoHeight&&(e.autoHeight=t.autoHeight),void 0!==t.rtlReorder&&(e.rtlReorder=t.rtlReorder),void 0!==t.unicodeConverter&&(e.unicodeConverter=t.unicodeConverter),null!==t.text&&void 0!==t.text?e.text=t.text:null!==t.key&&void 0!==t.key&&(e.key=t.key),void 0!==t.color&&(a=t.color,a instanceof pe||(a=new pe(a[0],a[1],a[2])),e.color=a),void 0!==t.opacity&&(e.opacity=t.opacity),void 0!==t.spacing&&(e.spacing=t.spacing),void 0!==t.fontSize&&(e.fontSize=t.fontSize,t.lineHeight||(e.lineHeight=t.fontSize)),void 0!==t.lineHeight&&(e.lineHeight=t.lineHeight),void 0!==t.maxLines&&(e.maxLines=t.maxLines),void 0!==t.wrapLines&&(e.wrapLines=t.wrapLines),void 0!==t.minFontSize&&(e.minFontSize=t.minFontSize),void 0!==t.maxFontSize&&(e.maxFontSize=t.maxFontSize),t.autoFitWidth&&(e.autoFitWidth=t.autoFitWidth),t.autoFitHeight&&(e.autoFitHeight=t.autoFitHeight),void 0!==t.fontAsset&&(e.fontAsset=t.fontAsset),void 0!==t.font&&(e.font=t.font),void 0!==t.alignment&&(e.alignment=t.alignment),void 0!==t.outlineColor&&(e.outlineColor=t.outlineColor),void 0!==t.outlineThickness&&(e.outlineThickness=t.outlineThickness),void 0!==t.shadowColor&&(e.shadowColor=t.shadowColor),void 0!==t.shadowOffset&&(e.shadowOffset=t.shadowOffset),void 0!==t.enableMarkup&&(e.enableMarkup=t.enableMarkup));const h=e._parseUpToScreen();h.screen&&e._updateScreen(h.screen),super.initializeComponentData(e,t,s),e._beingInitialized=!1,"image"===e.type&&e._image._meshDirty&&e._image._updateMesh(e._image.mesh)}onRemoveComponent(e,t){t.onRemove()}cloneComponent(e,t){const s=e.element,i={enabled:s.enabled,width:s.width,height:s.height,anchor:s.anchor.clone(),pivot:s.pivot.clone(),margin:s.margin.clone(),alignment:s.alignment&&s.alignment.clone()||s.alignment,autoWidth:s.autoWidth,autoHeight:s.autoHeight,type:s.type,rect:s.rect&&s.rect.clone()||s.rect,rtlReorder:s.rtlReorder,unicodeConverter:s.unicodeConverter,materialAsset:s.materialAsset,material:s.material,color:s.color&&s.color.clone()||s.color,opacity:s.opacity,textureAsset:s.textureAsset,texture:s.texture,spriteAsset:s.spriteAsset,sprite:s.sprite,spriteFrame:s.spriteFrame,pixelsPerUnit:s.pixelsPerUnit,spacing:s.spacing,lineHeight:s.lineHeight,wrapLines:s.wrapLines,layers:s.layers,fontSize:s.fontSize,minFontSize:s.minFontSize,maxFontSize:s.maxFontSize,autoFitWidth:s.autoFitWidth,autoFitHeight:s.autoFitHeight,maxLines:s.maxLines,fontAsset:s.fontAsset,font:s.font,useInput:s.useInput,fitMode:s.fitMode,batchGroupId:s.batchGroupId,mask:s.mask,outlineColor:s.outlineColor&&s.outlineColor.clone()||s.outlineColor,outlineThickness:s.outlineThickness,shadowColor:s.shadowColor&&s.shadowColor.clone()||s.shadowColor,shadowOffset:s.shadowOffset&&s.shadowOffset.clone()||s.shadowOffset,enableMarkup:s.enableMarkup};return void 0!==s.key&&null!==s.key?i.key=s.key:i.text=s.text,this.addComponent(t,i)}getTextElementMaterial(e,t,s){const i=(e&&1)|(t&&2)|(s&&4);let n=this._defaultTextMaterials[i];if(n)return n;let a="TextMaterial";return n=new zl,t?(n.msdfMap=this._defaultTexture,n.msdfTextAttribute=s,n.emissive.set(1,1,1)):(a="Bitmap"+a,n.emissive.set(.5,.5,.5),n.emissiveMap=this._defaultTexture,n.emissiveTint=!0,n.opacityMap=this._defaultTexture,n.opacityMapChannel="a"),e&&(a="ScreenSpace"+a,n.depthTest=!1),n.name="default"+a,n.useLighting=!1,n.useGammaTonemap=!1,n.useFog=!1,n.useSkybox=!1,n.diffuse.set(0,0,0),n.opacity=.5,n.blendType=4,n.depthWrite=!1,n.emissiveVertexColor=!0,n.update(),this._defaultTextMaterials[i]=n,n}_createBaseImageMaterial(){const e=new zl;return e.diffuse.set(0,0,0),e.emissive.set(.5,.5,.5),e.emissiveMap=this._defaultTexture,e.emissiveTint=!0,e.opacityMap=this._defaultTexture,e.opacityMapChannel="a",e.opacityTint=!0,e.opacity=0,e.useLighting=!1,e.useGammaTonemap=!1,e.useFog=!1,e.useSkybox=!1,e.blendType=4,e.depthWrite=!1,e}getImageElementMaterial(e,t,s,i){return e?t?s?(this.defaultScreenSpaceImageMask9SlicedMaterial||(this.defaultScreenSpaceImageMask9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMask9SlicedMaterial.name="defaultScreenSpaceImageMask9SlicedMaterial",this.defaultScreenSpaceImageMask9SlicedMaterial.nineSlicedMode=1,this.defaultScreenSpaceImageMask9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9SlicedMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9SlicedMaterial)),this.defaultScreenSpaceImageMask9SlicedMaterial):i?(this.defaultScreenSpaceImageMask9TiledMaterial||(this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImage9TiledMaterial.clone(),this.defaultScreenSpaceImageMask9TiledMaterial.name="defaultScreenSpaceImageMask9TiledMaterial",this.defaultScreenSpaceImageMask9TiledMaterial.nineSlicedMode=2,this.defaultScreenSpaceImageMask9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9TiledMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9TiledMaterial)),this.defaultScreenSpaceImageMask9TiledMaterial):(this.defaultScreenSpaceImageMaskMaterial||(this.defaultScreenSpaceImageMaskMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaskMaterial.name="defaultScreenSpaceImageMaskMaterial",this.defaultScreenSpaceImageMaskMaterial.depthTest=!1,this.defaultScreenSpaceImageMaskMaterial.alphaTest=1,this.defaultScreenSpaceImageMaskMaterial.redWrite=!1,this.defaultScreenSpaceImageMaskMaterial.greenWrite=!1,this.defaultScreenSpaceImageMaskMaterial.blueWrite=!1,this.defaultScreenSpaceImageMaskMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaskMaterial)),this.defaultScreenSpaceImageMaskMaterial):s?(this.defaultScreenSpaceImage9SlicedMaterial||(this.defaultScreenSpaceImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9SlicedMaterial.name="defaultScreenSpaceImage9SlicedMaterial",this.defaultScreenSpaceImage9SlicedMaterial.nineSlicedMode=1,this.defaultScreenSpaceImage9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9SlicedMaterial)),this.defaultScreenSpaceImage9SlicedMaterial):i?(this.defaultScreenSpaceImage9TiledMaterial||(this.defaultScreenSpaceImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9TiledMaterial.name="defaultScreenSpaceImage9TiledMaterial",this.defaultScreenSpaceImage9TiledMaterial.nineSlicedMode=2,this.defaultScreenSpaceImage9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9TiledMaterial)),this.defaultScreenSpaceImage9TiledMaterial):(this.defaultScreenSpaceImageMaterial||(this.defaultScreenSpaceImageMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaterial.name="defaultScreenSpaceImageMaterial",this.defaultScreenSpaceImageMaterial.depthTest=!1,this.defaultScreenSpaceImageMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaterial)),this.defaultScreenSpaceImageMaterial):t?s?(this.defaultImage9SlicedMaskMaterial||(this.defaultImage9SlicedMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaskMaterial.name="defaultImage9SlicedMaskMaterial",this.defaultImage9SlicedMaskMaterial.nineSlicedMode=1,this.defaultImage9SlicedMaskMaterial.alphaTest=1,this.defaultImage9SlicedMaskMaterial.redWrite=!1,this.defaultImage9SlicedMaskMaterial.greenWrite=!1,this.defaultImage9SlicedMaskMaterial.blueWrite=!1,this.defaultImage9SlicedMaskMaterial.alphaWrite=!1,this.defaultImage9SlicedMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaskMaterial)),this.defaultImage9SlicedMaskMaterial):i?(this.defaultImage9TiledMaskMaterial||(this.defaultImage9TiledMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaskMaterial.name="defaultImage9TiledMaskMaterial",this.defaultImage9TiledMaskMaterial.nineSlicedMode=2,this.defaultImage9TiledMaskMaterial.alphaTest=1,this.defaultImage9TiledMaskMaterial.redWrite=!1,this.defaultImage9TiledMaskMaterial.greenWrite=!1,this.defaultImage9TiledMaskMaterial.blueWrite=!1,this.defaultImage9TiledMaskMaterial.alphaWrite=!1,this.defaultImage9TiledMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaskMaterial)),this.defaultImage9TiledMaskMaterial):(this.defaultImageMaskMaterial||(this.defaultImageMaskMaterial=this._createBaseImageMaterial(),this.defaultImageMaskMaterial.name="defaultImageMaskMaterial",this.defaultImageMaskMaterial.alphaTest=1,this.defaultImageMaskMaterial.redWrite=!1,this.defaultImageMaskMaterial.greenWrite=!1,this.defaultImageMaskMaterial.blueWrite=!1,this.defaultImageMaskMaterial.alphaWrite=!1,this.defaultImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaskMaterial)),this.defaultImageMaskMaterial):s?(this.defaultImage9SlicedMaterial||(this.defaultImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaterial.name="defaultImage9SlicedMaterial",this.defaultImage9SlicedMaterial.nineSlicedMode=1,this.defaultImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaterial)),this.defaultImage9SlicedMaterial):i?(this.defaultImage9TiledMaterial||(this.defaultImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaterial.name="defaultImage9TiledMaterial",this.defaultImage9TiledMaterial.nineSlicedMode=2,this.defaultImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaterial)),this.defaultImage9TiledMaterial):(this.defaultImageMaterial||(this.defaultImageMaterial=this._createBaseImageMaterial(),this.defaultImageMaterial.name="defaultImageMaterial",this.defaultImageMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaterial)),this.defaultImageMaterial)}registerUnicodeConverter(e){this._unicodeConverter=e}registerRtlReorder(e){this._rtlReorder=e}getUnicodeConverter(){return this._unicodeConverter}getRtlReorder(){return this._rtlReorder}}Tm._buildAccessors(aC.prototype,hC);const cC="free",dC="limited",uC="locked",pC=["angularDampingX","angularDampingY","angularDampingZ","angularEquilibriumX","angularEquilibriumY","angularEquilibriumZ","angularLimitsX","angularLimitsY","angularLimitsZ","angularMotionX","angularMotionY","angularMotionZ","angularSpringX","angularSpringY","angularSpringZ","angularStiffnessX","angularStiffnessY","angularStiffnessZ","breakForce","enableCollision","enabled","entityA","entityB","linearDampingX","linearDampingY","linearDampingZ","linearEquilibriumX","linearEquilibriumY","linearEquilibriumZ","linearLimitsX","linearLimitsY","linearLimitsZ","linearMotionX","linearMotionY","linearMotionZ","linearSpringX","linearSpringY","linearSpringZ","linearStiffnessX","linearStiffnessY","linearStiffnessZ"];class mC extends Tm{constructor(e,t){super(e,t),this._constraint=null,this._entityA=null,this._entityB=null,this._breakForce=34e37,this._enableCollision=!0,this._linearMotionX="locked",this._linearLimitsX=new ve(0,0),this._linearSpringX=!1,this._linearStiffnessX=0,this._linearDampingX=1,this._linearEquilibriumX=0,this._linearMotionY="locked",this._linearLimitsY=new ve(0,0),this._linearSpringY=!1,this._linearStiffnessY=0,this._linearDampingY=1,this._linearEquilibriumY=0,this._linearMotionZ="locked",this._linearLimitsZ=new ve(0,0),this._linearSpringZ=!1,this._linearStiffnessZ=0,this._linearDampingZ=1,this._linearEquilibriumZ=0,this._angularMotionX="locked",this._angularLimitsX=new ve(0,0),this._angularSpringX=!1,this._angularStiffnessX=0,this._angularDampingX=1,this._angularEquilibriumX=0,this._angularMotionY="locked",this._angularLimitsY=new ve(0,0),this._angularSpringY=!1,this._angularStiffnessY=0,this._angularDampingY=1,this._angularEquilibriumY=0,this._angularMotionZ="locked",this._angularLimitsZ=new ve(0,0),this._angularSpringZ=!1,this._angularEquilibriumZ=0,this._angularDampingZ=1,this._angularStiffnessZ=0,this.on("set_enabled",this._onSetEnabled,this)}set entityA(e){this._destroyConstraint(),this._entityA=e,this._createConstraint()}get entityA(){return this._entityA}set entityB(e){this._destroyConstraint(),this._entityB=e,this._createConstraint()}get entityB(){return this._entityB}set breakForce(e){this._constraint&&this._breakForce!==e&&(this._constraint.setBreakingImpulseThreshold(e),this._breakForce=e)}get breakForce(){return this._breakForce}set enableCollision(e){this._destroyConstraint(),this._enableCollision=e,this._createConstraint()}get enableCollision(){return this._enableCollision}set angularLimitsX(e){this._angularLimitsX.equals(e)||(this._angularLimitsX.copy(e),this._updateAngularLimits())}get angularLimitsX(){return this._angularLimitsX}set angularMotionX(e){this._angularMotionX!==e&&(this._angularMotionX=e,this._updateAngularLimits())}get angularMotionX(){return this._angularMotionX}set angularLimitsY(e){this._angularLimitsY.equals(e)||(this._angularLimitsY.copy(e),this._updateAngularLimits())}get angularLimitsY(){return this._angularLimitsY}set angularMotionY(e){this._angularMotionY!==e&&(this._angularMotionY=e,this._updateAngularLimits())}get angularMotionY(){return this._angularMotionY}set angularLimitsZ(e){this._angularLimitsZ.equals(e)||(this._angularLimitsZ.copy(e),this._updateAngularLimits())}get angularLimitsZ(){return this._angularLimitsZ}set angularMotionZ(e){this._angularMotionZ!==e&&(this._angularMotionZ=e,this._updateAngularLimits())}get angularMotionZ(){return this._angularMotionZ}set linearLimitsX(e){this._linearLimitsX.equals(e)||(this._linearLimitsX.copy(e),this._updateLinearLimits())}get linearLimitsX(){return this._linearLimitsX}set linearMotionX(e){this._linearMotionX!==e&&(this._linearMotionX=e,this._updateLinearLimits())}get linearMotionX(){return this._linearMotionX}set linearLimitsY(e){this._linearLimitsY.equals(e)||(this._linearLimitsY.copy(e),this._updateLinearLimits())}get linearLimitsY(){return this._linearLimitsY}set linearMotionY(e){this._linearMotionY!==e&&(this._linearMotionY=e,this._updateLinearLimits())}get linearMotionY(){return this._linearMotionY}set linearLimitsZ(e){this._linearLimitsZ.equals(e)||(this._linearLimitsZ.copy(e),this._updateLinearLimits())}get linearLimitsZ(){return this._linearLimitsZ}set linearMotionZ(e){this._linearMotionZ!==e&&(this._linearMotionZ=e,this._updateLinearLimits())}get linearMotionZ(){return this._linearMotionZ}_convertTransform(e,t){const s=e.getTranslation(),i=new Ae;i.setFromMat4(e);const n=new Ammo.btVector3(s.x,s.y,s.z),a=new Ammo.btQuaternion(i.x,i.y,i.z,i.w);t.setOrigin(n),t.setRotation(a),Ammo.destroy(n),Ammo.destroy(a)}_updateAngularLimits(){const e=this._constraint;if(e){let t,s,i,n,a,r;"limited"===this._angularMotionX?(t=this._angularLimitsX.x*ne.DEG_TO_RAD,n=this._angularLimitsX.y*ne.DEG_TO_RAD):"free"===this._angularMotionX?(t=1,n=0):t=n=0,"limited"===this._angularMotionY?(s=this._angularLimitsY.x*ne.DEG_TO_RAD,a=this._angularLimitsY.y*ne.DEG_TO_RAD):"free"===this._angularMotionY?(s=1,a=0):s=a=0,"limited"===this._angularMotionZ?(i=this._angularLimitsZ.x*ne.DEG_TO_RAD,r=this._angularLimitsZ.y*ne.DEG_TO_RAD):"free"===this._angularMotionZ?(i=1,r=0):i=r=0;const o=new Ammo.btVector3(t,s,i);e.setAngularLowerLimit(o),o.setValue(n,a,r),e.setAngularUpperLimit(o),Ammo.destroy(o)}}_updateLinearLimits(){const e=this._constraint;if(e){let t,s,i,n,a,r;"limited"===this._linearMotionX?(t=this._linearLimitsX.x,n=this._linearLimitsX.y):"free"===this._linearMotionX?(t=1,n=0):t=n=0,"limited"===this._linearMotionY?(s=this._linearLimitsY.x,a=this._linearLimitsY.y):"free"===this._linearMotionY?(s=1,a=0):s=a=0,"limited"===this._linearMotionZ?(i=this._linearLimitsZ.x,r=this._linearLimitsZ.y):"free"===this._linearMotionZ?(i=1,r=0):i=r=0;const o=new Ammo.btVector3(t,s,i);e.setLinearLowerLimit(o),o.setValue(n,a,r),e.setLinearUpperLimit(o),Ammo.destroy(o)}}_createConstraint(){if(this._entityA&&this._entityA.rigidbody){this._destroyConstraint();const e=new Ce,t=this._entityA.rigidbody.body;t.activate();const s=this.entity.getWorldTransform(),i=this._entityA.getWorldTransform().clone().invert();e.mul2(i,s);const n=new Ammo.btTransform;if(this._convertTransform(e,n),this._entityB&&this._entityB.rigidbody){const i=this._entityB.rigidbody.body;i.activate();const a=this._entityB.getWorldTransform().clone().invert();e.mul2(a,s);const r=new Ammo.btTransform;this._convertTransform(e,r),this._constraint=new Ammo.btGeneric6DofSpringConstraint(t,i,n,r,!this._enableCollision),Ammo.destroy(r)}else this._constraint=new Ammo.btGeneric6DofSpringConstraint(t,n,!this._enableCollision);Ammo.destroy(n);const a=["X","Y","Z","X","Y","Z"];for(let e=0;e<6;e++){const t=e<3?"_linear":"_angular";this._constraint.enableSpring(e,this[t+"Spring"+a[e]]),this._constraint.setDamping(e,this[t+"Damping"+a[e]]),this._constraint.setEquilibriumPoint(e,this[t+"Equilibrium"+a[e]]),this._constraint.setStiffness(e,this[t+"Stiffness"+a[e]])}this._constraint.setBreakingImpulseThreshold(this._breakForce),this._updateLinearLimits(),this._updateAngularLimits();this.system.app.systems.rigidbody.dynamicsWorld.addConstraint(this._constraint,!this._enableCollision)}}_destroyConstraint(){if(this._constraint){this.system.app.systems.rigidbody.dynamicsWorld.removeConstraint(this._constraint),Ammo.destroy(this._constraint),this._constraint=null}}initFromData(e){for(const t of pC)e.hasOwnProperty(t)&&(e[t]instanceof ve?this["_"+t].copy(e[t]):this["_"+t]=e[t]);this._createConstraint()}onEnable(){this._createConstraint()}onDisable(){this._destroyConstraint()}_onSetEnabled(e,t,s){}_onBeforeRemove(){this.fire("remove")}}const fC={Damping:"setDamping",Equilibrium:"setEquilibriumPoint",Spring:"enableSpring",Stiffness:"setStiffness"};["linear","angular"].forEach((e=>{["Damping","Equilibrium","Spring","Stiffness"].forEach((t=>{["X","Y","Z"].forEach((s=>{const i=e+t+s,n="_"+i;let a="linear"===e?0:3;"Y"===s&&(a+=1),"Z"===s&&(a+=2),Object.defineProperty(mC.prototype,i,{get:function(){return this[n]},set:function(e){this[n]!==e&&(this[n]=e,this._constraint[fC[t]](a,e))}})}))}))}));class _C{constructor(){this.enabled=!0}}const gC=["enabled"];class yC extends Uw{constructor(e){super(e),this.id="joint",this.app=e,this.ComponentType=mC,this.DataType=_C,this.schema=gC}initializeComponentData(e,t,s){e.initFromData(t)}}Tm._buildAccessors(mC.prototype,gC);class vC extends Tm{constructor(e,t){super(e,t),this._minWidth=0,this._minHeight=0,this._maxWidth=null,this._maxHeight=null,this._fitWidthProportion=0,this._fitHeightProportion=0,this._excludeFromLayout=!1}set minWidth(e){e!==this._minWidth&&(this._minWidth=e,this.fire("resize"))}get minWidth(){return this._minWidth}set minHeight(e){e!==this._minHeight&&(this._minHeight=e,this.fire("resize"))}get minHeight(){return this._minHeight}set maxWidth(e){e!==this._maxWidth&&(this._maxWidth=e,this.fire("resize"))}get maxWidth(){return this._maxWidth}set maxHeight(e){e!==this._maxHeight&&(this._maxHeight=e,this.fire("resize"))}get maxHeight(){return this._maxHeight}set fitWidthProportion(e){e!==this._fitWidthProportion&&(this._fitWidthProportion=e,this.fire("resize"))}get fitWidthProportion(){return this._fitWidthProportion}set fitHeightProportion(e){e!==this._fitHeightProportion&&(this._fitHeightProportion=e,this.fire("resize"))}get fitHeightProportion(){return this._fitHeightProportion}set excludeFromLayout(e){e!==this._excludeFromLayout&&(this._excludeFromLayout=e,this.fire("resize"))}get excludeFromLayout(){return this._excludeFromLayout}}class xC{constructor(){this.enabled=!0}}const bC=["enabled"];class SC extends Uw{constructor(e){super(e),this.id="layoutchild",this.ComponentType=vC,this.DataType=xC,this.schema=bC}initializeComponentData(e,t,s){void 0!==t.enabled&&(e.enabled=t.enabled),void 0!==t.minWidth&&(e.minWidth=t.minWidth),void 0!==t.minHeight&&(e.minHeight=t.minHeight),void 0!==t.maxWidth&&(e.maxWidth=t.maxWidth),void 0!==t.maxHeight&&(e.maxHeight=t.maxHeight),void 0!==t.fitWidthProportion&&(e.fitWidthProportion=t.fitWidthProportion),void 0!==t.fitHeightProportion&&(e.fitHeightProportion=t.fitHeightProportion),void 0!==t.excludeFromLayout&&(e.excludeFromLayout=t.excludeFromLayout),super.initializeComponentData(e,t,s)}cloneComponent(e,t){const s=e.layoutchild;return this.addComponent(t,{enabled:s.enabled,minWidth:s.minWidth,minHeight:s.minHeight,maxWidth:s.maxWidth,maxHeight:s.maxHeight,fitWidthProportion:s.fitWidthProportion,fitHeightProportion:s.fitHeightProportion,excludeFromLayout:s.excludeFromLayout})}}Tm._buildAccessors(vC.prototype,bC);const wC=0,TC=1,MC=2,CC=3,AC={0:{axis:"x",size:"width",calculatedSize:"calculatedWidth",minSize:"minWidth",maxSize:"maxWidth",fitting:"widthFitting",fittingProportion:"fitWidthProportion"},1:{axis:"y",size:"height",calculatedSize:"calculatedHeight",minSize:"minHeight",maxSize:"maxHeight",fitting:"heightFitting",fittingProportion:"fitHeightProportion"}},PC={0:1,1:0},EC={minWidth:0,minHeight:0,maxWidth:Number.POSITIVE_INFINITY,maxHeight:Number.POSITIVE_INFINITY,width:null,height:null,fitWidthProportion:0,fitHeightProportion:0},RC="NONE",LC="APPLY_STRETCHING",IC="APPLY_SHRINKING",DC=new ve;function OC(e){let t;const s=AC[e],i=AC[PC[e]];function n(e,t){return-t[s.size]*e.pivot[s.axis]}function a(e,t){return-t[i.size]*e.pivot[i.axis]}function r(e,t){return t[s.size]*(1-e.pivot[s.axis])}function o(e){const t=e.entity.layoutchild;return!t||!t.enabled||!t.excludeFromLayout}function h(e,t,s){switch(e){case 0:return RC;case 1:return t<s?LC:RC;case 2:return t>=s?IC:RC;case 3:return t<s?LC:IC;default:throw new Error(`Unrecognized fitting mode: ${e}`)}}function l(e,s){return _(e,s.size)+(e.length-1)*t.spacing[s.axis]}function c(e,t,s){const i=y(e,s.maxSize),n=g(e,s.fittingProportion),a=b(n,i);let r=DC[s.axis]-t;for(let t=0;t<e.length;++t){const o=i[t],h=u(o,r,n,a),l=e[o][s.size]+h,c=e[o][s.maxSize],d=Math.min(l,c);e[o][s.size]=d;r-=h-Math.max(l-d,0)}}function d(e,t,s){const i=y(e,s.minSize,!0),n=function(e){if(1===e.length)return[1];const t=[],s=e.length;for(let i=0;i<s;++i)t.push((1-e[i])/(s-1));return t}(g(e,s.fittingProportion)),a=b(n,i);let r=t-DC[s.axis];for(let t=0;t<e.length;++t){const o=i[t],h=u(o,r,n,a),l=e[o][s.size]-h,c=e[o][s.minSize],d=Math.max(l,c);e[o][s.size]=d;r-=h-Math.max(d-l,0)}}function u(e,t,s,i){const n=s[e],a=i[e];return Math.abs(n)<1e-5&&Math.abs(a)<1e-5?t:t*n/a}function p(e){const t=[];for(let s=0;s<e.length;++s){const i=e[s],n=Math.max(m(i,"minWidth"),0),a=Math.max(m(i,"minHeight"),0),r=Math.max(m(i,"maxWidth"),n),o=Math.max(m(i,"maxHeight"),a),h=f(m(i,"width"),n,r),l=f(m(i,"height"),a,o),c=m(i,"fitWidthProportion"),d=m(i,"fitHeightProportion");t.push({minWidth:n,minHeight:a,maxWidth:r,maxHeight:o,width:h,height:l,fitWidthProportion:c,fitHeightProportion:d})}return t}function m(e,t){const s=e.entity.layoutchild;return s&&s.enabled&&void 0!==s[t]&&null!==s[t]?s[t]:void 0!==e[t]?e[t]:EC[t]}function f(e,t,s){return Math.min(Math.max(e,t),s)}function _(e,t){return e.reduce((function(e,s){return e+s[t]}),0)}function g(e,t){const s=_(e,t),i=[],n=e.length;if(0===s)for(let e=0;e<n;++e)i.push(1/n);else for(let a=0;a<n;++a)i.push(e[a][t]/s);return i}function y(e,t,s){return e.forEach(v),e.slice().sort((function(e,i){return s?i[t]-e[t]:e[t]-i[t]})).map(x)}function v(e,t){e.index=t}function x(e){return e.index}function b(e,t){const s=[];s[t[e.length-1]]=e[t[e.length-1]];for(let i=e.length-2;i>=0;--i)s[t[i]]=s[t[i+1]]+e[t[i]];return s}return function(e,u){e=e.filter(o),t=u,DC.x=t.containerSize.x-t.padding.x-t.padding.z,DC.y=t.containerSize.y-t.padding.y-t.padding.w,function(e){for(let t=0;t<e.length;++t){const s=e[t],i=s.anchor;0===i.x&&0===i.y&&0===i.z&&0===i.w||(s.anchor=xe.ZERO)}}(e);const m=function(e){const s=0===t.orientation&&t.reverseX||1===t.orientation&&t.reverseY,i=0===t.orientation&&t.reverseY||1===t.orientation&&t.reverseX;if(s)for(let t=0;t<e.length;++t)s&&e[t].reverse();i&&e.reverse();return e}(function(e){if(!t.wrap)return[e];const i=[[]],n=p(e);let a=0;const r=2===t[s.fitting];for(let o=0;o<e.length;++o){i[i.length-1].length>0&&(a+=t.spacing[s.axis]);const h=n[o][s.size];a+=h,!r&&a>DC[s.axis]&&0!==i[i.length-1].length&&(a=h,i.push([])),i[i.length-1].push(e[o]),r&&a>DC[s.axis]&&o!==e.length-1&&(a=0,i.push([]))}return i}(e)),f=function(e,s){const n=[],a=[];for(let t=0;t<e.length;++t){const r=e[t];r.largestElement=null,r.largestSize={width:Number.NEGATIVE_INFINITY,height:Number.NEGATIVE_INFINITY};for(let e=0;e<r.length;++e){const n=s[t][e];n[i.size]>r.largestSize[i.size]&&(r.largestElement=r[e],r.largestSize=n)}n.push(r.largestElement),a.push(r.largestSize)}const r=l(a,i),o=h(t[i.fitting],r,DC[i.axis]);o===LC?c(a,r,i):o===IC&&d(a,r,i);for(let n=0;n<e.length;++n){const a=e[n];for(let r=0;r<a.length;++r){const o=s[n][r],l=o[i.size],c=1===e.length?DC[i.axis]:a.largestSize[i.size],d=h(t[i.fitting],l,c);d===LC?o[i.size]=Math.min(c,o[i.maxSize]):d===IC&&(o[i.size]=Math.max(c,o[i.minSize]))}}return s}(m,function(e){const i=[];for(let n=0;n<e.length;++n){const a=p(e[n]),r=l(a,s),o=h(t[s.fitting],r,DC[s.axis]);o===LC?c(a,r,s):o===IC&&d(a,r,s),i.push(a)}return i}(m)),_=function(e,o){const h={};h[s.axis]=0,h[i.axis]=0,e[s.size]=Number.NEGATIVE_INFINITY;const l=[];for(let c=0;c<e.length;++c){const d=e[c];if(0===d.length){l.push([]);continue}const u=[],p=o[c];for(let e=0;e<d.length;++e){const o=d[e],l=p[e];h[i.axis]-=a(o,l),h[s.axis]-=n(o,l),u[e]={},u[e][s.axis]=h[s.axis],u[e][i.axis]=h[i.axis],h[i.axis]+=a(o,l),h[s.axis]+=r(o,l)+t.spacing[s.axis]}d[s.size]=h[s.axis]-t.spacing[s.axis],d[i.size]=d.largestSize[i.size],e[s.size]=Math.max(e[s.size],d[s.size]),h[s.axis]=0,h[i.axis]+=d[i.size]+t.spacing[i.axis],l.push(u)}return e[i.size]=h[i.axis]-t.spacing[i.axis],l}(m,f);return function(e,n,a){const r=t.alignment[s.axis],o=t.alignment[i.axis],h=t.padding[s.axis],l=t.padding[i.axis];for(let c=0;c<e.length;++c){const d=e[c],u=n[c],p=a[c],m=(DC[s.axis]-d[s.size])*r+h,f=(DC[i.axis]-e[i.size])*o+l;for(let e=0;e<d.length;++e){const n=(d[i.size]-u[e][i.size])*t.alignment[i.axis];p[e][s.axis]+=m,p[e][i.axis]+=f+n}}}(m,f,_),function(e,n,a){for(let r=0;r<e.length;++r){const o=e[r],h=n[r],l=a[r];for(let e=0;e<o.length;++e){const n=o[e];n[s.calculatedSize]=h[e][s.size],n[i.calculatedSize]=h[e][i.size],0===t.orientation?n.entity.setLocalPosition(l[e][s.axis],l[e][i.axis],n.entity.getLocalPosition().z):n.entity.setLocalPosition(l[e][i.axis],l[e][s.axis],n.entity.getLocalPosition().z)}}}(m,f,_),function(e){const s=e.width,i=e.height,n=(DC.x-s)*t.alignment.x+t.padding.x,a=(DC.y-i)*t.alignment.y+t.padding.y;return{bounds:new xe(n,a,s,i)}}(m)}}const FC={};FC[0]=OC(0),FC[1]=OC(1);class kC{calculateLayout(e,t){const s=FC[t.orientation];if(s)return s(e,t);throw new Error("Unrecognized orientation value: "+t.orientation)}}function BC(e){return e.element}function zC(e){return e.enabled&&e.element&&e.element.enabled}class UC extends Tm{constructor(e,t){super(e,t),this._orientation=0,this._reverseX=!1,this._reverseY=!0,this._alignment=new ve(0,1),this._padding=new xe,this._spacing=new ve,this._widthFitting=0,this._heightFitting=0,this._wrap=!1,this._layoutCalculator=new kC,this._listenForReflowEvents(this.entity,"on"),this.entity.children.forEach((e=>{this._listenForReflowEvents(e,"on")})),this.entity.on("childinsert",this._onChildInsert,this),this.entity.on("childremove",this._onChildRemove,this),e.app.systems.element.on("add",this._onElementOrLayoutComponentAdd,this),e.app.systems.element.on("beforeremove",this._onElementOrLayoutComponentRemove,this),e.app.systems.layoutchild.on("add",this._onElementOrLayoutComponentAdd,this),e.app.systems.layoutchild.on("beforeremove",this._onElementOrLayoutComponentRemove,this)}set orientation(e){e!==this._orientation&&(this._orientation=e,this._scheduleReflow())}get orientation(){return this._orientation}set reverseX(e){e!==this._reverseX&&(this._reverseX=e,this._scheduleReflow())}get reverseX(){return this._reverseX}set reverseY(e){e!==this._reverseY&&(this._reverseY=e,this._scheduleReflow())}get reverseY(){return this._reverseY}set alignment(e){e.equals(this._alignment)||(this._alignment.copy(e),this._scheduleReflow())}get alignment(){return this._alignment}set padding(e){e.equals(this._padding)||(this._padding.copy(e),this._scheduleReflow())}get padding(){return this._padding}set spacing(e){e.equals(this._spacing)||(this._spacing.copy(e),this._scheduleReflow())}get spacing(){return this._spacing}set widthFitting(e){e!==this._widthFitting&&(this._widthFitting=e,this._scheduleReflow())}get widthFitting(){return this._widthFitting}set heightFitting(e){e!==this._heightFitting&&(this._heightFitting=e,this._scheduleReflow())}get heightFitting(){return this._heightFitting}set wrap(e){e!==this._wrap&&(this._wrap=e,this._scheduleReflow())}get wrap(){return this._wrap}_isSelfOrChild(e){return e===this.entity||-1!==this.entity.children.indexOf(e)}_listenForReflowEvents(e,t){e.element&&(e.element[t]("enableelement",this._scheduleReflow,this),e.element[t]("disableelement",this._scheduleReflow,this),e.element[t]("resize",this._scheduleReflow,this),e.element[t]("set:pivot",this._scheduleReflow,this)),e.layoutchild&&(e.layoutchild[t]("set_enabled",this._scheduleReflow,this),e.layoutchild[t]("resize",this._scheduleReflow,this))}_onElementOrLayoutComponentAdd(e){this._isSelfOrChild(e)&&(this._listenForReflowEvents(e,"on"),this._scheduleReflow())}_onElementOrLayoutComponentRemove(e){this._isSelfOrChild(e)&&(this._listenForReflowEvents(e,"off"),this._scheduleReflow())}_onChildInsert(e){this._listenForReflowEvents(e,"on"),this._scheduleReflow()}_onChildRemove(e){this._listenForReflowEvents(e,"off"),this._scheduleReflow()}_scheduleReflow(){this.enabled&&this.entity&&this.entity.enabled&&!this._isPerformingReflow&&this.system.scheduleReflow(this)}reflow(){const e=BC(this.entity),t=this.entity.children.filter(zC).map(BC);if(!e||0===t.length)return;const s=Math.max(e.calculatedWidth,0),i=Math.max(e.calculatedHeight,0),n={orientation:this._orientation,reverseX:this._reverseX,reverseY:this._reverseY,alignment:this._alignment,padding:this._padding,spacing:this._spacing,widthFitting:this._widthFitting,heightFitting:this._heightFitting,wrap:this._wrap,containerSize:new ve(s,i)};this._isPerformingReflow=!0;const a=this._layoutCalculator.calculateLayout(t,n);this._isPerformingReflow=!1,this.fire("reflow",a)}onEnable(){this._scheduleReflow()}onRemove(){this.entity.off("childinsert",this._onChildInsert,this),this.entity.off("childremove",this._onChildRemove,this),this._listenForReflowEvents(this.entity,"off"),this.entity.children.forEach((e=>{this._listenForReflowEvents(e,"off")})),this.system.app.systems.element.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.element.off("beforeremove",this._onElementOrLayoutComponentRemove,this),this.system.app.systems.layoutchild.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.layoutchild.off("beforeremove",this._onElementOrLayoutComponentRemove,this)}}class VC{constructor(){this.enabled=!0}}const NC=["enabled"];class GC extends Uw{constructor(e){super(e),this.id="layoutgroup",this.ComponentType=UC,this.DataType=VC,this.schema=NC,this._reflowQueue=[],this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("postUpdate",this._onPostUpdate,this)}initializeComponentData(e,t,s){void 0!==t.enabled&&(e.enabled=t.enabled),void 0!==t.orientation&&(e.orientation=t.orientation),void 0!==t.reverseX&&(e.reverseX=t.reverseX),void 0!==t.reverseY&&(e.reverseY=t.reverseY),void 0!==t.alignment&&(e.alignment=Array.isArray(t.alignment)?new ve(t.alignment):t.alignment),void 0!==t.padding&&(e.padding=Array.isArray(t.padding)?new xe(t.padding):t.padding),void 0!==t.spacing&&(e.spacing=Array.isArray(t.spacing)?new ve(t.spacing):t.spacing),void 0!==t.widthFitting&&(e.widthFitting=t.widthFitting),void 0!==t.heightFitting&&(e.heightFitting=t.heightFitting),void 0!==t.wrap&&(e.wrap=t.wrap),super.initializeComponentData(e,t,s)}cloneComponent(e,t){const s=e.layoutgroup;return this.addComponent(t,{enabled:s.enabled,orientation:s.orientation,reverseX:s.reverseX,reverseY:s.reverseY,alignment:s.alignment,padding:s.padding,spacing:s.spacing,widthFitting:s.widthFitting,heightFitting:s.heightFitting,wrap:s.wrap})}scheduleReflow(e){-1===this._reflowQueue.indexOf(e)&&this._reflowQueue.push(e)}_onPostUpdate(){this._processReflowQueue()}_processReflowQueue(){if(0===this._reflowQueue.length)return;let e=0;for(;this._reflowQueue.length>0;){const t=this._reflowQueue.slice();this._reflowQueue.length=0,t.sort((function(e,t){return e.entity.graphDepth-t.entity.graphDepth}));for(let e=0;e<t.length;++e)t[e].reflow();if(++e>=100){console.warn("Max reflow iterations limit reached, bailing.");break}}}_onRemoveComponent(e,t){t.onRemove()}destroy(){super.destroy(),this.app.systems.off("postUpdate",this._onPostUpdate,this)}}Tm._buildAccessors(UC.prototype,NC);class WC extends Tm{constructor(e,t){super(e,t),this._type="asset",this._asset=null,this._model=null,this._mapping={},this._castShadows=!0,this._receiveShadows=!0,this._materialAsset=null,this._material=void 0,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this._isStatic=!1,this._layers=[0],this._batchGroupId=-1,this._customAabb=null,this._area=null,this._materialEvents=null,this._clonedModel=!1,this._material=e.defaultMaterial,t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this)}set meshInstances(e){this._model&&(this._model.meshInstances=e)}get meshInstances(){return this._model?this._model.meshInstances:null}set customAabb(e){if(this._customAabb=e,this._model){const e=this._model.meshInstances;if(e)for(let t=0;t<e.length;t++)e[t].setCustomAabb(this._customAabb)}}get customAabb(){return this._customAabb}set type(e){if(this._type!==e)if(this._area=null,this._type=e,"asset"===e)null!==this._asset?this._bindModelAsset(this._asset):this.model=null;else{const t=sd(this.system.app.graphicsDevice,e);this._area=t.area;const s=t.mesh,i=new kh,n=new rf;n.graph=i,n.meshInstances=[new xd(s,this._material,i)],this.model=n,this._asset=null}}get type(){return this._type}set asset(e){const t=this.system.app.assets;let s=e;if(e instanceof um&&(s=e.id),this._asset!==s){if(this._asset){t.off("add:"+this._asset,this._onModelAssetAdded,this);const e=t.get(this._asset);e&&this._unbindModelAsset(e)}if(this._asset=s,this._asset){const e=t.get(this._asset);e?this._bindModelAsset(e):(this.model=null,t.on("add:"+this._asset,this._onModelAssetAdded,this))}else this.model=null}}get asset(){return this._asset}set model(e){if(this._model!==e&&(!e||!e._immutable)&&(this._model&&(this._model._immutable=!1,this.removeModelFromLayers(),this.entity.removeChild(this._model.getGraph()),delete this._model._entity,this._clonedModel&&(this._model.destroy(),this._clonedModel=!1)),this._model=e,this._model)){this._model._immutable=!0;const e=this._model.meshInstances;for(let t=0;t<e.length;t++)e[t].castShadow=this._castShadows,e[t].receiveShadow=this._receiveShadows,e[t].isStatic=this._isStatic,e[t].setCustomAabb(this._customAabb);this.lightmapped=this._lightmapped,this.entity.addChild(this._model.graph),this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._model._entity=this.entity,this.entity.animation&&this.entity.animation.setModel(this._model),this.entity.anim&&this.entity.anim.rebind(),"asset"===this.type?this.mapping=this._mapping:this._unsetMaterialEvents()}}get model(){return this._model}set lightmapped(e){if(e!==this._lightmapped&&(this._lightmapped=e,this._model)){const t=this._model.meshInstances;for(let s=0;s<t.length;s++)t[s].setLightmapped(e)}}get lightmapped(){return this._lightmapped}set castShadows(e){if(this._castShadows===e)return;const t=this._model;if(t){const s=this.layers,i=this.system.app.scene;if(this._castShadows&&!e)for(let e=0;e<s.length;e++){const s=this.system.app.scene.layers.getLayerById(this.layers[e]);s&&s.removeShadowCasters(t.meshInstances)}const n=t.meshInstances;for(let t=0;t<n.length;t++)n[t].castShadow=e;if(!this._castShadows&&e)for(let e=0;e<s.length;e++){const n=i.layers.getLayerById(s[e]);n&&n.addShadowCasters(t.meshInstances)}}this._castShadows=e}get castShadows(){return this._castShadows}set receiveShadows(e){if(this._receiveShadows!==e&&(this._receiveShadows=e,this._model)){const t=this._model.meshInstances;for(let s=0,i=t.length;s<i;s++)t[s].receiveShadow=e}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(e){this._castShadowsLightmap=e}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(e){this._lightmapSizeMultiplier=e}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set isStatic(e){if(this._isStatic!==e&&(this._isStatic=e,this._model)){const t=this._model.meshInstances;for(let s=0;s<t.length;s++){t[s].isStatic=e}}}get isStatic(){return this._isStatic}set layers(e){const t=this.system.app.scene.layers;if(this.meshInstances)for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.removeMeshInstances(this.meshInstances)}this._layers.length=0;for(let t=0;t<e.length;t++)this._layers[t]=e[t];if(this.enabled&&this.entity.enabled&&this.meshInstances)for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.addMeshInstances(this.meshInstances)}}get layers(){return this._layers}set batchGroupId(e){if(this._batchGroupId!==e){var t,s;if(this.entity.enabled&&this._batchGroupId>=0)null==(t=this.system.app.batcher)||t.remove(rd.MODEL,this.batchGroupId,this.entity);if(this.entity.enabled&&e>=0)null==(s=this.system.app.batcher)||s.insert(rd.MODEL,e,this.entity);e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._batchGroupId=e}}get batchGroupId(){return this._batchGroupId}set materialAsset(e){let t=e;e instanceof um&&(t=e.id);const s=this.system.app.assets;if(t!==this._materialAsset){if(this._materialAsset){s.off("add:"+this._materialAsset,this._onMaterialAssetAdd,this);const e=s.get(this._materialAsset);e&&this._unbindMaterialAsset(e)}if(this._materialAsset=t,this._materialAsset){const e=s.get(this._materialAsset);e?this._bindMaterialAsset(e):(this._setMaterial(this.system.defaultMaterial),s.on("add:"+this._materialAsset,this._onMaterialAssetAdd,this))}else this._setMaterial(this.system.defaultMaterial)}}get materialAsset(){return this._materialAsset}set material(e){this._material!==e&&(this.materialAsset=null,this._setMaterial(e))}get material(){return this._material}set mapping(e){if("asset"!==this._type)return;if(this._unsetMaterialEvents(),e||(e={}),this._mapping=e,!this._model)return;const t=this._model.meshInstances,s=this.asset?this.system.app.assets.get(this.asset):null,i=s?s.data.mapping:null;let n=null;for(let s=0,a=t.length;s<a;s++)if(void 0!==e[s])e[s]?(n=this.system.app.assets.get(e[s]),this._loadAndSetMeshInstanceMaterial(n,t[s],s)):t[s].material=this.system.defaultMaterial;else if(i)if(i[s]&&(i[s].material||i[s].path)){if(void 0!==i[s].material)n=this.system.app.assets.get(i[s].material);else if(void 0!==i[s].path){const e=this._getMaterialAssetUrl(i[s].path);e&&(n=this.system.app.assets.getByUrl(e))}this._loadAndSetMeshInstanceMaterial(n,t[s],s)}else t[s].material=this.system.defaultMaterial}get mapping(){return this._mapping}addModelToLayers(){const e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.addMeshInstances(this.meshInstances)}}removeModelFromLayers(){const e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.removeMeshInstances(this.meshInstances)}}onRemoveChild(){this._model&&this.removeModelFromLayers()}onInsertChild(){this._model&&this.enabled&&this.entity.enabled&&this.addModelToLayers()}onRemove(){this.asset=null,this.model=null,this.materialAsset=null,this._unsetMaterialEvents(),this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(e,t){this.addModelToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||e.addMeshInstances(this.meshInstances)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||e.removeMeshInstances(this.meshInstances)}_setMaterialEvent(e,t,s,i){const n=t+":"+s;this.system.app.assets.on(n,i,this),this._materialEvents||(this._materialEvents=[]),this._materialEvents[e]||(this._materialEvents[e]={}),this._materialEvents[e][n]={id:s,handler:i}}_unsetMaterialEvents(){const e=this.system.app.assets,t=this._materialEvents;if(t){for(let s=0,i=t.length;s<i;s++){if(!t[s])continue;const i=t[s];for(const t in i)e.off(t,i[t].handler,this)}this._materialEvents=null}}_getAssetByIdOrPath(e){let t=null;if(isNaN(parseInt(e,10))){if(this.asset){const s=this._getMaterialAssetUrl(e);s&&(t=this.system.app.assets.getByUrl(s))}}else t=this.system.app.assets.get(e);return t}_getMaterialAssetUrl(e){if(!this.asset)return null;const t=this.system.app.assets.get(this.asset);return t?t.getAbsoluteUrl(e):null}_loadAndSetMeshInstanceMaterial(e,t,s){const i=this.system.app.assets;e&&(e.resource?(t.material=e.resource,this._setMaterialEvent(s,"remove",e.id,(function(){t.material=this.system.defaultMaterial}))):(this._setMaterialEvent(s,"load",e.id,(function(i){t.material=i.resource,this._setMaterialEvent(s,"remove",e.id,(function(){t.material=this.system.defaultMaterial}))})),this.enabled&&this.entity.enabled&&i.load(e)))}onEnable(){const e=this.system.app,t=e.scene;t.on("set:layers",this.onLayersChanged,this),t.layers&&(t.layers.on("add",this.onLayerAdded,this),t.layers.on("remove",this.onLayerRemoved,this));const s="asset"===this._type;let i;if(this._model?this.addModelToLayers():s&&this._asset&&(i=e.assets.get(this._asset),i&&i.resource!==this._model&&this._bindModelAsset(i)),this._materialAsset&&(i=e.assets.get(this._materialAsset),i&&i.resource!==this._material&&this._bindMaterialAsset(i)),s&&this._mapping)for(const t in this._mapping)this._mapping[t]&&(i=this._getAssetByIdOrPath(this._mapping[t]),i&&!i.resource&&e.assets.load(i));var n;this._batchGroupId>=0&&(null==(n=e.batcher)||n.insert(rd.MODEL,this.batchGroupId,this.entity))}onDisable(){const e=this.system.app,t=e.scene;var s;(t.off("set:layers",this.onLayersChanged,this),t.layers&&(t.layers.off("add",this.onLayerAdded,this),t.layers.off("remove",this.onLayerRemoved,this)),this._batchGroupId>=0)&&(null==(s=e.batcher)||s.remove(rd.MODEL,this.batchGroupId,this.entity));this._model&&this.removeModelFromLayers()}hide(){if(this._model){const e=this._model.meshInstances;for(let t=0,s=e.length;t<s;t++)e[t].visible=!1}}show(){if(this._model){const e=this._model.meshInstances;for(let t=0,s=e.length;t<s;t++)e[t].visible=!0}}_bindMaterialAsset(e){if(e.on("load",this._onMaterialAssetLoad,this),e.on("unload",this._onMaterialAssetUnload,this),e.on("remove",this._onMaterialAssetRemove,this),e.on("change",this._onMaterialAssetChange,this),e.resource)this._onMaterialAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindMaterialAsset(e){e.off("load",this._onMaterialAssetLoad,this),e.off("unload",this._onMaterialAssetUnload,this),e.off("remove",this._onMaterialAssetRemove,this),e.off("change",this._onMaterialAssetChange,this)}_onMaterialAssetAdd(e){this.system.app.assets.off("add:"+e.id,this._onMaterialAssetAdd,this),this._materialAsset===e.id&&this._bindMaterialAsset(e)}_onMaterialAssetLoad(e){this._setMaterial(e.resource)}_onMaterialAssetUnload(e){this._setMaterial(this.system.defaultMaterial)}_onMaterialAssetRemove(e){this._onMaterialAssetUnload(e)}_onMaterialAssetChange(e){}_bindModelAsset(e){if(this._unbindModelAsset(e),e.on("load",this._onModelAssetLoad,this),e.on("unload",this._onModelAssetUnload,this),e.on("change",this._onModelAssetChange,this),e.on("remove",this._onModelAssetRemove,this),e.resource)this._onModelAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindModelAsset(e){e.off("load",this._onModelAssetLoad,this),e.off("unload",this._onModelAssetUnload,this),e.off("change",this._onModelAssetChange,this),e.off("remove",this._onModelAssetRemove,this)}_onModelAssetAdded(e){this.system.app.assets.off("add:"+e.id,this._onModelAssetAdded,this),e.id===this._asset&&this._bindModelAsset(e)}_onModelAssetLoad(e){this.model=e.resource.clone(),this._clonedModel=!0}_onModelAssetUnload(e){this.model=null}_onModelAssetChange(e,t,s,i){"data"===t&&(this.mapping=this._mapping)}_onModelAssetRemove(e){this.model=null}_setMaterial(e){if(this._material===e)return;this._material=e;const t=this._model;if(t&&"asset"!==this._type){const s=t.meshInstances;for(let t=0,i=s.length;t<i;t++)s[t].material=e}}}class HC{constructor(){this.enabled=!0}}const XC=["enabled"];class qC extends Uw{constructor(e){super(e),this.id="model",this.ComponentType=WC,this.DataType=HC,this.schema=XC,this.defaultMaterial=Tl(e.graphicsDevice),this.on("beforeremove",this.onRemove,this)}initializeComponentData(e,t,s){s=["material","materialAsset","asset","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","type","mapping","layers","isStatic","batchGroupId"],null!==t.batchGroupId&&void 0!==t.batchGroupId||(t.batchGroupId=-1),t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(let i=0;i<s.length;i++)t.hasOwnProperty(s[i])&&(e[s[i]]=t[s[i]]);t.aabbCenter&&t.aabbHalfExtents&&(e.customAabb=new De(new ge(t.aabbCenter),new ge(t.aabbHalfExtents))),super.initializeComponentData(e,t,["enabled"])}cloneComponent(e,t){const s={type:e.model.type,asset:e.model.asset,castShadows:e.model.castShadows,receiveShadows:e.model.receiveShadows,castShadowsLightmap:e.model.castShadowsLightmap,lightmapped:e.model.lightmapped,lightmapSizeMultiplier:e.model.lightmapSizeMultiplier,isStatic:e.model.isStatic,enabled:e.model.enabled,layers:e.model.layers,batchGroupId:e.model.batchGroupId,mapping:T({},e.model.mapping)};let i=e.model.materialAsset;i instanceof um||null==i||(i=this.app.assets.get(i));const n=e.model.material;n&&n!==this.defaultMaterial&&i&&n!==i.resource||(s.materialAsset=i);const a=this.addComponent(t,s);if(e.model.model&&"asset"===e.model.type&&!e.model.asset&&(a.model=e.model.model.clone(),a._clonedModel=!0),s.materialAsset||(a.material=n),e.model.model){const t=e.model.model.meshInstances,s=a.model.meshInstances;for(let e=0;e<t.length;e++)s[e].mask=t[e].mask,s[e].material=t[e].material,s[e].layer=t[e].layer,s[e].receiveShadow=t[e].receiveShadow}return e.model.customAabb&&(a.customAabb=e.model.customAabb.clone()),a}onRemove(e,t){t.onRemove()}}Tm._buildAccessors(WC.prototype,XC);const jC=["emitterExtents","emitterRadius","emitterExtentsInner","emitterRadiusInner","loop","initialVelocity","animSpeed","normalMap","particleNormal"],YC=["numParticles","lifetime","rate","rate2","startAngle","startAngle2","lighting","halfLambert","intensity","wrap","wrapBounds","depthWrite","noFog","sort","stretch","alignToMotion","preWarm","emitterShape","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animLoop","colorMap","localSpace","screenSpace","orientation"],$C=["scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","velocityGraph","velocityGraph2","localVelocityGraph","localVelocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2"],KC=["colorMapAsset","normalMapAsset","meshAsset","renderAsset"];let ZC;class QC extends Tm{constructor(e,t){super(e,t),this._requestedDepth=!1,this._drawOrder=0,this.on("set_colorMapAsset",this.onSetColorMapAsset,this),this.on("set_normalMapAsset",this.onSetNormalMapAsset,this),this.on("set_meshAsset",this.onSetMeshAsset,this),this.on("set_mesh",this.onSetMesh,this),this.on("set_renderAsset",this.onSetRenderAsset,this),this.on("set_loop",this.onSetLoop,this),this.on("set_blendType",this.onSetBlendType,this),this.on("set_depthSoftening",this.onSetDepthSoftening,this),this.on("set_layers",this.onSetLayers,this),jC.forEach((e=>{this.on(`set_${e}`,this.onSetSimpleProperty,this)})),YC.forEach((e=>{this.on(`set_${e}`,this.onSetComplexProperty,this)})),$C.forEach((e=>{this.on(`set_${e}`,this.onSetGraphProperty,this)}))}set drawOrder(e){this._drawOrder=e,this.emitter&&(this.emitter.drawOrder=e)}get drawOrder(){return this._drawOrder}addMeshInstanceToLayers(){if(this.emitter)for(let e=0;e<this.layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&(t.addMeshInstances([this.emitter.meshInstance]),this.emitter._layer=t)}}removeMeshInstanceFromLayers(){if(this.emitter)for(let e=0;e<this.layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&t.removeMeshInstances([this.emitter.meshInstance])}}onSetLayers(e,t,s){if(this.emitter){for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);s&&s.removeMeshInstances([this.emitter.meshInstance])}if(this.enabled&&this.entity.enabled)for(let e=0;e<s.length;e++){const t=this.system.app.scene.layers.getLayerById(s[e]);t&&t.addMeshInstances([this.emitter.meshInstance])}}}onLayersChanged(e,t){this.addMeshInstanceToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){if(!this.emitter)return;this.layers.indexOf(e.id)<0||e.addMeshInstances([this.emitter.meshInstance])}onLayerRemoved(e){if(!this.emitter)return;this.layers.indexOf(e.id)<0||e.removeMeshInstances([this.emitter.meshInstance])}_bindColorMapAsset(e){if(e.on("load",this._onColorMapAssetLoad,this),e.on("unload",this._onColorMapAssetUnload,this),e.on("remove",this._onColorMapAssetRemove,this),e.on("change",this._onColorMapAssetChange,this),e.resource)this._onColorMapAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindColorMapAsset(e){e.off("load",this._onColorMapAssetLoad,this),e.off("unload",this._onColorMapAssetUnload,this),e.off("remove",this._onColorMapAssetRemove,this),e.off("change",this._onColorMapAssetChange,this)}_onColorMapAssetLoad(e){this.colorMap=e.resource}_onColorMapAssetUnload(e){this.colorMap=null}_onColorMapAssetRemove(e){this._onColorMapAssetUnload(e)}_onColorMapAssetChange(e){}onSetColorMapAsset(e,t,s){const i=this.system.app.assets;if(t){const e=i.get(t);e&&this._unbindColorMapAsset(e)}if(s){s instanceof um&&(this.data.colorMapAsset=s.id,s=s.id);const e=i.get(s);e?this._bindColorMapAsset(e):i.once("add:"+s,(e=>{this._bindColorMapAsset(e)}))}else this.colorMap=null}_bindNormalMapAsset(e){if(e.on("load",this._onNormalMapAssetLoad,this),e.on("unload",this._onNormalMapAssetUnload,this),e.on("remove",this._onNormalMapAssetRemove,this),e.on("change",this._onNormalMapAssetChange,this),e.resource)this._onNormalMapAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindNormalMapAsset(e){e.off("load",this._onNormalMapAssetLoad,this),e.off("unload",this._onNormalMapAssetUnload,this),e.off("remove",this._onNormalMapAssetRemove,this),e.off("change",this._onNormalMapAssetChange,this)}_onNormalMapAssetLoad(e){this.normalMap=e.resource}_onNormalMapAssetUnload(e){this.normalMap=null}_onNormalMapAssetRemove(e){this._onNormalMapAssetUnload(e)}_onNormalMapAssetChange(e){}onSetNormalMapAsset(e,t,s){const i=this.system.app.assets;if(t){const e=i.get(t);e&&this._unbindNormalMapAsset(e)}if(s){s instanceof um&&(this.data.normalMapAsset=s.id,s=s.id);const e=i.get(s);e?this._bindNormalMapAsset(e):i.once("add:"+s,(e=>{this._bindNormalMapAsset(e)}))}else this.normalMap=null}_bindMeshAsset(e){if(e.on("load",this._onMeshAssetLoad,this),e.on("unload",this._onMeshAssetUnload,this),e.on("remove",this._onMeshAssetRemove,this),e.on("change",this._onMeshAssetChange,this),e.resource)this._onMeshAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindMeshAsset(e){e.off("load",this._onMeshAssetLoad,this),e.off("unload",this._onMeshAssetUnload,this),e.off("remove",this._onMeshAssetRemove,this),e.off("change",this._onMeshAssetChange,this)}_onMeshAssetLoad(e){this._onMeshChanged(e.resource)}_onMeshAssetUnload(e){this.mesh=null}_onMeshAssetRemove(e){this._onMeshAssetUnload(e)}_onMeshAssetChange(e){}onSetMeshAsset(e,t,s){const i=this.system.app.assets;if(t){const e=i.get(t);e&&this._unbindMeshAsset(e)}if(s){s instanceof um&&(this.data.meshAsset=s.id,s=s.id);const e=i.get(s);e&&this._bindMeshAsset(e)}else this._onMeshChanged(null)}onSetMesh(e,t,s){!s||s instanceof um||"number"==typeof s?this.meshAsset=s:this._onMeshChanged(s)}_onMeshChanged(e){!e||e instanceof Wc||(e=e.meshInstances[0]?e.meshInstances[0].mesh:null),this.data.mesh=e,this.emitter&&(this.emitter.mesh=e,this.emitter.resetMaterial(),this.rebuild())}onSetRenderAsset(e,t,s){const i=this.system.app.assets;if(t){const e=i.get(t);e&&this._unbindRenderAsset(e)}if(s){s instanceof um&&(this.data.renderAsset=s.id,s=s.id);const e=i.get(s);e&&this._bindRenderAsset(e)}else this._onRenderChanged(null)}_bindRenderAsset(e){if(e.on("load",this._onRenderAssetLoad,this),e.on("unload",this._onRenderAssetUnload,this),e.on("remove",this._onRenderAssetRemove,this),e.resource)this._onRenderAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindRenderAsset(e){e.off("load",this._onRenderAssetLoad,this),e.off("unload",this._onRenderAssetUnload,this),e.off("remove",this._onRenderAssetRemove,this),e.resource&&e.resource.off("set:meshes",this._onRenderSetMeshes,this)}_onRenderAssetLoad(e){this._onRenderChanged(e.resource)}_onRenderAssetUnload(e){this._onRenderChanged(null)}_onRenderAssetRemove(e){this._onRenderAssetUnload(e)}_onRenderChanged(e){e?(e.off("set:meshes",this._onRenderSetMeshes,this),e.on("set:meshes",this._onRenderSetMeshes,this),e.meshes&&this._onRenderSetMeshes(e.meshes)):this._onMeshChanged(null)}_onRenderSetMeshes(e){this._onMeshChanged(e&&e[0])}onSetLoop(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.resetTime())}onSetBlendType(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.material.blendType=s,this.emitter.resetMaterial(),this.rebuild())}_requestDepth(){this._requestedDepth||(ZC||(ZC=this.system.app.scene.layers.getLayerById(1)),ZC&&(ZC.incrementCounter(),this._requestedDepth=!0))}_releaseDepth(){this._requestedDepth&&ZC&&(ZC.decrementCounter(),this._requestedDepth=!1)}onSetDepthSoftening(e,t,s){t!==s&&(s?(this.enabled&&this.entity.enabled&&this._requestDepth(),this.emitter&&(this.emitter[e]=s)):(this.enabled&&this.entity.enabled&&this._releaseDepth(),this.emitter&&(this.emitter[e]=s)),this.emitter&&(this.reset(),this.emitter.resetMaterial(),this.rebuild()))}onSetSimpleProperty(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.resetMaterial())}onSetComplexProperty(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.resetMaterial(),this.rebuild(),this.reset())}onSetGraphProperty(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.rebuildGraphs(),this.emitter.resetMaterial())}onEnable(){const e=this.data;for(let t=0,s=KC.length;t<s;t++){let s=e[KC[t]];if(s){if(!(s instanceof um)){if(!(parseInt(s,10)>=0))continue;s=this.system.app.assets.get(s)}s&&!s.resource&&this.system.app.assets.load(s)}}if(!this.emitter){let t=e.mesh;t instanceof Wc||(t=null),this.emitter=new s_(this.system.app.graphicsDevice,{numParticles:e.numParticles,emitterExtents:e.emitterExtents,emitterExtentsInner:e.emitterExtentsInner,emitterRadius:e.emitterRadius,emitterRadiusInner:e.emitterRadiusInner,emitterShape:e.emitterShape,initialVelocity:e.initialVelocity,wrap:e.wrap,localSpace:e.localSpace,screenSpace:e.screenSpace,wrapBounds:e.wrapBounds,lifetime:e.lifetime,rate:e.rate,rate2:e.rate2,orientation:e.orientation,particleNormal:e.particleNormal,animTilesX:e.animTilesX,animTilesY:e.animTilesY,animStartFrame:e.animStartFrame,animNumFrames:e.animNumFrames,animNumAnimations:e.animNumAnimations,animIndex:e.animIndex,randomizeAnimIndex:e.randomizeAnimIndex,animSpeed:e.animSpeed,animLoop:e.animLoop,startAngle:e.startAngle,startAngle2:e.startAngle2,scaleGraph:e.scaleGraph,scaleGraph2:e.scaleGraph2,colorGraph:e.colorGraph,colorGraph2:e.colorGraph2,alphaGraph:e.alphaGraph,alphaGraph2:e.alphaGraph2,localVelocityGraph:e.localVelocityGraph,localVelocityGraph2:e.localVelocityGraph2,velocityGraph:e.velocityGraph,velocityGraph2:e.velocityGraph2,rotationSpeedGraph:e.rotationSpeedGraph,rotationSpeedGraph2:e.rotationSpeedGraph2,radialSpeedGraph:e.radialSpeedGraph,radialSpeedGraph2:e.radialSpeedGraph2,colorMap:e.colorMap,normalMap:e.normalMap,loop:e.loop,preWarm:e.preWarm,sort:e.sort,stretch:e.stretch,alignToMotion:e.alignToMotion,lighting:e.lighting,halfLambert:e.halfLambert,intensity:e.intensity,depthSoftening:e.depthSoftening,scene:this.system.app.scene,mesh:t,depthWrite:e.depthWrite,noFog:e.noFog,node:this.entity,blendType:e.blendType}),this.emitter.meshInstance.node=this.entity,this.emitter.drawOrder=this.drawOrder,e.autoPlay||(this.pause(),this.emitter.meshInstance.visible=!1)}this.emitter.colorMap&&this.addMeshInstanceToLayers(),this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&e.depthSoftening&&this._requestDepth()}onDisable(){this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.emitter&&(this.removeMeshInstanceFromLayers(),this.data.depthSoftening&&this._releaseDepth(),this.emitter.camera=null)}onBeforeRemove(){this.enabled&&(this.enabled=!1),this.emitter&&(this.emitter.destroy(),this.emitter=null);for(let e=0;e<KC.length;e++){const t=KC[e];this.data[t]&&(this[t]=null)}this.off()}reset(){this.emitter&&this.emitter.reset()}stop(){this.emitter&&(this.emitter.loop=!1,this.emitter.resetTime(),this.emitter.addTime(0,!0))}pause(){this.data.paused=!0}unpause(){this.data.paused=!1}play(){this.data.paused=!1,this.emitter&&(this.emitter.meshInstance.visible=!0,this.emitter.loop=this.data.loop,this.emitter.resetTime())}isPlaying(){return!this.data.paused&&(!(!this.emitter||!this.emitter.loop)||Date.now()<=this.emitter.endTime)}rebuild(){const e=this.enabled;this.enabled=!1,this.emitter&&(this.emitter.rebuild(),this.emitter.meshInstance.node=this.entity),this.enabled=e}}class JC{constructor(){this.numParticles=1,this.rate=1,this.rate2=null,this.startAngle=0,this.startAngle2=null,this.lifetime=50,this.emitterExtents=new ge,this.emitterExtentsInner=new ge,this.emitterRadius=0,this.emitterRadiusInner=0,this.emitterShape=0,this.initialVelocity=0,this.wrapBounds=new ge,this.localSpace=!1,this.screenSpace=!1,this.colorMap=null,this.colorMapAsset=null,this.normalMap=null,this.normalMapAsset=null,this.loop=!0,this.preWarm=!1,this.sort=0,this.mode=0,this.scene=null,this.lighting=!1,this.halfLambert=!1,this.intensity=1,this.stretch=0,this.alignToMotion=!1,this.depthSoftening=0,this.meshAsset=null,this.mesh=null,this.depthWrite=!1,this.noFog=!1,this.orientation=0,this.particleNormal=new ge(0,1,0),this.animTilesX=1,this.animTilesY=1,this.animStartFrame=0,this.animNumFrames=1,this.animNumAnimations=1,this.animIndex=0,this.randomizeAnimIndex=!1,this.animSpeed=1,this.animLoop=!0,this.scaleGraph=null,this.scaleGraph2=null,this.colorGraph=null,this.colorGraph2=null,this.alphaGraph=null,this.alphaGraph2=null,this.localVelocityGraph=null,this.localVelocityGraph2=null,this.velocityGraph=null,this.velocityGraph2=null,this.rotationSpeedGraph=null,this.rotationSpeedGraph2=null,this.radialSpeedGraph=null,this.radialSpeedGraph2=null,this.blendType=2,this.enabled=!0,this.paused=!1,this.autoPlay=!0,this.layers=[0]}}const eA=["enabled","autoPlay","numParticles","lifetime","rate","rate2","startAngle","startAngle2","loop","preWarm","lighting","halfLambert","intensity","depthWrite","noFog","depthSoftening","sort","blendType","stretch","alignToMotion","emitterShape","emitterExtents","emitterExtentsInner","emitterRadius","emitterRadiusInner","initialVelocity","wrap","wrapBounds","localSpace","screenSpace","colorMapAsset","normalMapAsset","mesh","meshAsset","renderAsset","orientation","particleNormal","localVelocityGraph","localVelocityGraph2","velocityGraph","velocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2","scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","colorMap","normalMap","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animSpeed","animLoop","layers"];class tA extends Uw{constructor(e){super(e),this.id="particlesystem",this.ComponentType=QC,this.DataType=JC,this.schema=eA,this.propertyTypes={emitterExtents:"vec3",emitterExtentsInner:"vec3",particleNormal:"vec3",wrapBounds:"vec3",localVelocityGraph:"curveset",localVelocityGraph2:"curveset",velocityGraph:"curveset",velocityGraph2:"curveset",colorGraph:"curveset",colorGraph2:"curveset",alphaGraph:"curve",alphaGraph2:"curve",rotationSpeedGraph:"curve",rotationSpeedGraph2:"curve",radialSpeedGraph:"curve",radialSpeedGraph2:"curve",scaleGraph:"curve",scaleGraph2:"curve"},this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(e,t,s){const i={};s=[];const n=this.propertyTypes;(t.mesh instanceof um||"number"==typeof t.mesh)&&(t.meshAsset=t.mesh,delete t.mesh);for(const e in t){if(t.hasOwnProperty(e)&&(s.push(e),i[e]=t[e]),"vec3"===n[e])Array.isArray(i[e])&&(i[e]=new ge(i[e][0],i[e][1],i[e][2]));else if("curve"===n[e]){if(!(i[e]instanceof fe)){const t=i[e].type;i[e]=new fe(i[e].keys),i[e].type=t}}else if("curveset"===n[e]&&!(i[e]instanceof _e)){const t=i[e].type;i[e]=new _e(i[e].keys),i[e].type=t}i.layers&&Array.isArray(i.layers)&&(i.layers=i.layers.slice(0))}super.initializeComponentData(e,i,s)}cloneComponent(e,t){const s=e.particlesystem.data,i=this.schema,n={};for(let e=0,t=i.length;e<t;e++){const t=i[e];let a=s[t];a instanceof ge||a instanceof fe||a instanceof _e?(a=a.clone(),n[t]=a):"layers"===t?n.layers=s.layers.slice(0):null!=a&&(n[t]=a)}return this.addComponent(t,n)}onUpdate(e){const t=this.store;let s;const i=this.app.stats.particles;for(const n in t)if(t.hasOwnProperty(n)){const a=t[n],r=a.entity,o=a.data;if(o.enabled&&r.enabled){const t=r.particlesystem.emitter;if(!t.meshInstance.visible)continue;if(t.lighting){const e=o.layers;let s;for(let i=0;i<e.length;i++){const n=this.app.scene.layers.getLayerById(e[i]);if(!n)continue;n._lightCube||(n._lightCube=new Float32Array(18)),s=n._lightCube;for(let e=0;e<6;e++)s[3*e]=this.app.scene.ambientLight.r,s[3*e+1]=this.app.scene.ambientLight.g,s[3*e+2]=this.app.scene.ambientLight.b;const a=n._splitLights[0];for(let e=0;e<a.length;e++)for(let i=0;i<6;i++){const n=Math.max(t.lightCubeDir[i].dot(a[e]._direction),0)*a[e]._intensity;s[3*i]+=a[e]._color.r*n,s[3*i+1]+=a[e]._color.g*n,s[3*i+2]+=a[e]._color.b*n}}t.constantLightCube.setValue(s)}if(!o.paused){if(t.simTime+=e,t.simTime>t.fixedTimeStep&&(s=Math.floor(t.simTime/t.fixedTimeStep),t.simTime-=s*t.fixedTimeStep),s){s=Math.min(s,t.maxSubSteps);for(let e=0;e<s;e++)t.addTime(t.fixedTimeStep,!1);i._updatesPerFrame+=s,i._frameTime+=t._addTimeTime,t._addTimeTime=0}t.finishFrame()}}}}onBeforeRemove(e,t){t.onBeforeRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}Tm._buildAccessors(QC.prototype,eA);class sA extends Tm{constructor(e,t){super(e,t),this._type="asset",this._castShadows=!0,this._receiveShadows=!0,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this._isStatic=!1,this._batchGroupId=-1,this._layers=[0],this._renderStyle=0,this._meshInstances=[],this._customAabb=null,this._area=null,this._assetReference=[],this._materialReferences=[],this._material=void 0,this._rootBone=void 0,this._rootBone=new cT(this,"rootBone"),this._rootBone.on("set:entity",this._onSetRootBone,this),this._assetReference=new av("asset",this,e.app.assets,{add:this._onRenderAssetAdded,load:this._onRenderAssetLoad,remove:this._onRenderAssetRemove,unload:this._onRenderAssetUnload},this),this._material=e.defaultMaterial,t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this)}set renderStyle(e){this._renderStyle!==e&&(this._renderStyle=e,xd._prepareRenderStyleForArray(this._meshInstances,e))}get renderStyle(){return this._renderStyle}set customAabb(e){this._customAabb=e;const t=this._meshInstances;if(t)for(let e=0;e<t.length;e++)t[e].setCustomAabb(this._customAabb)}get customAabb(){return this._customAabb}set type(e){if(this._type!==e&&(this._area=null,this._type=e,this.destroyMeshInstances(),"asset"!==e)){let t=this._material;t&&t!==this.system.defaultMaterial||(t=this._materialReferences[0]&&this._materialReferences[0].asset&&this._materialReferences[0].asset.resource);const s=sd(this.system.app.graphicsDevice,e);this._area=s.area,this.meshInstances=[new xd(s.mesh,t||this.system.defaultMaterial,this.entity)]}}get type(){return this._type}set meshInstances(e){if(this.destroyMeshInstances(),this._meshInstances=e,this._meshInstances){const e=this._meshInstances;for(let t=0;t<e.length;t++)e[t].node||(e[t].node=this.entity),e[t].castShadow=this._castShadows,e[t].receiveShadow=this._receiveShadows,e[t].isStatic=this._isStatic,e[t].renderStyle=this._renderStyle,e[t].setLightmapped(this._lightmapped),e[t].setCustomAabb(this._customAabb);this.enabled&&this.entity.enabled&&this.addToLayers()}}get meshInstances(){return this._meshInstances}set lightmapped(e){if(e!==this._lightmapped){this._lightmapped=e;const t=this._meshInstances;if(t)for(let s=0;s<t.length;s++)t[s].setLightmapped(e)}}get lightmapped(){return this._lightmapped}set castShadows(e){if(this._castShadows!==e){const t=this._meshInstances;if(t){const s=this.layers,i=this.system.app.scene;if(this._castShadows&&!e)for(let e=0;e<s.length;e++){const s=i.layers.getLayerById(this.layers[e]);s&&s.removeShadowCasters(t)}for(let s=0;s<t.length;s++)t[s].castShadow=e;if(!this._castShadows&&e)for(let e=0;e<s.length;e++){const n=i.layers.getLayerById(s[e]);n&&n.addShadowCasters(t)}}this._castShadows=e}}get castShadows(){return this._castShadows}set receiveShadows(e){if(this._receiveShadows!==e){this._receiveShadows=e;const t=this._meshInstances;if(t)for(let s=0;s<t.length;s++)t[s].receiveShadow=e}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(e){this._castShadowsLightmap=e}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(e){this._lightmapSizeMultiplier=e}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set isStatic(e){if(this._isStatic!==e){this._isStatic=e;const t=this._meshInstances;if(t)for(let s=0;s<t.length;s++)t[s].isStatic=e}}get isStatic(){return this._isStatic}set layers(e){const t=this.system.app.scene.layers;let s;if(this._meshInstances)for(let e=0;e<this._layers.length;e++)s=t.getLayerById(this._layers[e]),s&&s.removeMeshInstances(this._meshInstances);this._layers.length=0;for(let t=0;t<e.length;t++)this._layers[t]=e[t];if(this.enabled&&this.entity.enabled&&this._meshInstances)for(let e=0;e<this._layers.length;e++)s=t.getLayerById(this._layers[e]),s&&s.addMeshInstances(this._meshInstances)}get layers(){return this._layers}set batchGroupId(e){if(this._batchGroupId!==e){var t,s;if(this.entity.enabled&&this._batchGroupId>=0)null==(t=this.system.app.batcher)||t.remove(rd.RENDER,this.batchGroupId,this.entity);if(this.entity.enabled&&e>=0)null==(s=this.system.app.batcher)||s.insert(rd.RENDER,e,this.entity);e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addToLayers(),this._batchGroupId=e}}get batchGroupId(){return this._batchGroupId}set material(e){if(this._material!==e&&(this._material=e,this._meshInstances&&"asset"!==this._type))for(let t=0;t<this._meshInstances.length;t++)this._meshInstances[t].material=e}get material(){return this._material}set materialAssets(e=[]){if(this._materialReferences.length>e.length){for(let t=e.length;t<this._materialReferences.length;t++)this._materialReferences[t].id=null;this._materialReferences.length=e.length}for(let t=0;t<e.length;t++)if(this._materialReferences[t]||this._materialReferences.push(new av(t,this,this.system.app.assets,{add:this._onMaterialAdded,load:this._onMaterialLoad,remove:this._onMaterialRemove,unload:this._onMaterialUnload},this)),e[t]){const s=e[t]instanceof um?e[t].id:e[t];this._materialReferences[t].id!==s&&(this._materialReferences[t].id=s),this._materialReferences[t].asset&&this._onMaterialAdded(t,this,this._materialReferences[t].asset)}else this._materialReferences[t].id=null,this._meshInstances[t]&&(this._meshInstances[t].material=this.system.defaultMaterial)}get materialAssets(){return this._materialReferences.map((function(e){return e.id}))}set asset(e){const t=e instanceof um?e.id:e;this._assetReference.id!==t&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onRenderAssetRemove(),this._assetReference.id=t,this._assetReference.asset&&this._onRenderAssetAdded())}get asset(){return this._assetReference.id}assignAsset(e){const t=e instanceof um?e.id:e;this._assetReference.id=t}_onSetRootBone(e){e&&this._onRootBoneChanged()}_onRootBoneChanged(){this._clearSkinInstances(),this.enabled&&this.entity.enabled&&this._cloneSkinInstances()}destroyMeshInstances(){const e=this._meshInstances;if(e){this.removeFromLayers(),this._clearSkinInstances();for(let t=0;t<e.length;t++)e[t].destroy();this._meshInstances.length=0}}addToLayers(){const e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.addMeshInstances(this._meshInstances)}}removeFromLayers(){if(this._meshInstances&&this._meshInstances.length){const e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.removeMeshInstances(this._meshInstances)}}}onRemoveChild(){this.removeFromLayers()}onInsertChild(){this._meshInstances&&this.enabled&&this.entity.enabled&&this.addToLayers()}onRemove(){this.destroyMeshInstances(),this.asset=null,this.materialAsset=null,this._assetReference.id=null;for(let e=0;e<this._materialReferences.length;e++)this._materialReferences[e].id=null;this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(e,t){this.addToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||e.addMeshInstances(this._meshInstances)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||e.removeMeshInstances(this._meshInstances)}onEnable(){const e=this.system.app,t=e.scene;this._rootBone.onParentComponentEnable(),this._cloneSkinInstances(),t.on("set:layers",this.onLayersChanged,this),t.layers&&(t.layers.on("add",this.onLayerAdded,this),t.layers.on("remove",this.onLayerRemoved,this));const s="asset"===this._type;this._meshInstances&&this._meshInstances.length?this.addToLayers():s&&this.asset&&this._onRenderAssetAdded();for(let e=0;e<this._materialReferences.length;e++)this._materialReferences[e].asset&&this.system.app.assets.load(this._materialReferences[e].asset);var i;this._batchGroupId>=0&&(null==(i=e.batcher)||i.insert(rd.RENDER,this.batchGroupId,this.entity))}onDisable(){const e=this.system.app,t=e.scene;var s;(t.off("set:layers",this.onLayersChanged,this),t.layers&&(t.layers.off("add",this.onLayerAdded,this),t.layers.off("remove",this.onLayerRemoved,this)),this._batchGroupId>=0)&&(null==(s=e.batcher)||s.remove(rd.RENDER,this.batchGroupId,this.entity));this.removeFromLayers()}hide(){if(this._meshInstances)for(let e=0;e<this._meshInstances.length;e++)this._meshInstances[e].visible=!1}show(){if(this._meshInstances)for(let e=0;e<this._meshInstances.length;e++)this._meshInstances[e].visible=!0}_onRenderAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onRenderAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))}_onRenderAssetLoad(){if(this.destroyMeshInstances(),this._assetReference.asset){const e=this._assetReference.asset.resource;e.off("set:meshes",this._onSetMeshes,this),e.on("set:meshes",this._onSetMeshes,this),e.meshes&&this._onSetMeshes(e.meshes)}}_onSetMeshes(e){this._cloneMeshes(e)}_clearSkinInstances(){for(let e=0;e<this._meshInstances.length;e++){const t=this._meshInstances[e];qg.removeCachedSkinInstance(t.skinInstance),t.skinInstance=null}}_cloneSkinInstances(){if(this._meshInstances.length&&this._rootBone.entity instanceof kh)for(let e=0;e<this._meshInstances.length;e++){const t=this._meshInstances[e],s=t.mesh;s.skin&&!s.skinInstance&&(t.skinInstance=qg.createCachedSkinInstance(s.skin,this._rootBone.entity,this.entity))}}_cloneMeshes(e){if(e&&e.length){const t=[];for(let s=0;s<e.length;s++){const i=e[s],n=this._materialReferences[s]&&this._materialReferences[s].asset&&this._materialReferences[s].asset.resource,a=new xd(i,n||this.system.defaultMaterial,this.entity);t.push(a),i.morph&&(a.morphInstance=new af(i.morph))}this.meshInstances=t,this._cloneSkinInstances()}}_onRenderAssetUnload(){"asset"===this._type&&this.destroyMeshInstances()}_onRenderAssetRemove(){this._assetReference.asset&&this._assetReference.asset.resource&&this._assetReference.asset.resource.off("set:meshes",this._onSetMeshes,this),this._onRenderAssetUnload()}_onMaterialAdded(e,t,s){s.resource?this._onMaterialLoad(e,t,s):this.enabled&&this.entity.enabled&&this.system.app.assets.load(s)}_updateMainMaterial(e,t){0===e&&(this.material=t)}_onMaterialLoad(e,t,s){this._meshInstances[e]&&(this._meshInstances[e].material=s.resource),this._updateMainMaterial(e,s.resource)}_onMaterialRemove(e,t,s){this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial),this._updateMainMaterial(e,this.system.defaultMaterial)}_onMaterialUnload(e,t,s){this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial),this._updateMainMaterial(e,this.system.defaultMaterial)}resolveDuplicatedEntityReferenceProperties(e,t){e.rootBone&&t[e.rootBone]&&(this.rootBone=t[e.rootBone]),this._clearSkinInstances()}}class iA{constructor(){this.enabled=!0,this.rootBone=null}}const nA=[{name:"rootBone",type:"entity"},"enabled"],aA=["material","meshInstances","asset","materialAssets","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","renderStyle","type","layers","isStatic","batchGroupId"];class rA extends Uw{constructor(e){super(e),this.id="render",this.ComponentType=sA,this.DataType=iA,this.schema=nA,this.defaultMaterial=Tl(e.graphicsDevice),this.on("beforeremove",this.onRemove,this)}initializeComponentData(e,t,s){null!==t.batchGroupId&&void 0!==t.batchGroupId||(t.batchGroupId=-1),t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(let s=0;s<aA.length;s++)t.hasOwnProperty(aA[s])&&(e[aA[s]]=t[aA[s]]);t.aabbCenter&&t.aabbHalfExtents&&(e.customAabb=new De(new ge(t.aabbCenter),new ge(t.aabbHalfExtents))),super.initializeComponentData(e,t,nA)}cloneComponent(e,t){const s={};for(let t=0;t<aA.length;t++)s[aA[t]]=e.render[aA[t]];s.enabled=e.render.enabled,delete s.meshInstances;const i=this.addComponent(t,s),n=e.render.meshInstances,a=n.map((e=>e.mesh));i._onSetMeshes(a);for(let e=0;e<n.length;e++)i.meshInstances[e].material=n[e].material;return e.render.customAabb&&(i.customAabb=e.render.customAabb.clone()),i}onRemove(e,t){t.onRemove()}}Tm._buildAccessors(sA.prototype,nA);class oA{constructor(e,t){this._constructor=e,this._pool=[],this._count=0,this._resize(t)}_resize(e){if(e>this._pool.length)for(let t=this._pool.length;t<e;t++)this._pool[t]=new this._constructor}allocate(){return this._count>=this._pool.length&&this._resize(2*this._pool.length),this._pool[this._count++]}freeAll(){this._count=0}}let hA,lA,cA,dA,uA,pA,mA;class fA extends Tm{constructor(e,t){super(e,t),this._angularDamping=0,this._angularFactor=new ge(1,1,1),this._angularVelocity=new ge,this._body=null,this._friction=.5,this._group=2,this._linearDamping=0,this._linearFactor=new ge(1,1,1),this._linearVelocity=new ge,this._mask=65533,this._mass=1,this._restitution=0,this._rollingFriction=0,this._simulationEnabled=!1,this._type="static"}static onLibraryLoaded(){"undefined"!=typeof Ammo&&(hA=new Ammo.btTransform,lA=new Ammo.btVector3,cA=new Ammo.btVector3,dA=new Ammo.btQuaternion,uA=new Ammo.btVector3(0,0,0))}set angularDamping(e){this._angularDamping!==e&&(this._angularDamping=e,this._body&&this._body.setDamping(this._linearDamping,e))}get angularDamping(){return this._angularDamping}set angularFactor(e){this._angularFactor.equals(e)||(this._angularFactor.copy(e),this._body&&"dynamic"===this._type&&(lA.setValue(e.x,e.y,e.z),this._body.setAngularFactor(lA)))}get angularFactor(){return this._angularFactor}set angularVelocity(e){this._body&&"dynamic"===this._type&&(this._body.activate(),lA.setValue(e.x,e.y,e.z),this._body.setAngularVelocity(lA),this._angularVelocity.copy(e))}get angularVelocity(){if(this._body&&"dynamic"===this._type){const e=this._body.getAngularVelocity();this._angularVelocity.set(e.x(),e.y(),e.z())}return this._angularVelocity}set body(e){this._body!==e&&(this._body=e,e&&this._simulationEnabled&&e.activate())}get body(){return this._body}set friction(e){this._friction!==e&&(this._friction=e,this._body&&this._body.setFriction(e))}get friction(){return this._friction}set group(e){this._group!==e&&(this._group=e,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}get group(){return this._group}set linearDamping(e){this._linearDamping!==e&&(this._linearDamping=e,this._body&&this._body.setDamping(e,this._angularDamping))}get linearDamping(){return this._linearDamping}set linearFactor(e){this._linearFactor.equals(e)||(this._linearFactor.copy(e),this._body&&"dynamic"===this._type&&(lA.setValue(e.x,e.y,e.z),this._body.setLinearFactor(lA)))}get linearFactor(){return this._linearFactor}set linearVelocity(e){this._body&&"dynamic"===this._type&&(this._body.activate(),lA.setValue(e.x,e.y,e.z),this._body.setLinearVelocity(lA),this._linearVelocity.copy(e))}get linearVelocity(){if(this._body&&"dynamic"===this._type){const e=this._body.getLinearVelocity();this._linearVelocity.set(e.x(),e.y(),e.z())}return this._linearVelocity}set mask(e){this._mask!==e&&(this._mask=e,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}get mask(){return this._mask}set mass(e){if(this._mass!==e&&(this._mass=e,this._body&&"dynamic"===this._type)){const t=this.enabled&&this.entity.enabled;t&&this.disableSimulation(),this._body.getCollisionShape().calculateLocalInertia(e,lA),this._body.setMassProps(e,lA),this._body.updateInertiaTensor(),t&&this.enableSimulation()}}get mass(){return this._mass}set restitution(e){this._restitution!==e&&(this._restitution=e,this._body&&this._body.setRestitution(e))}get restitution(){return this._restitution}set rollingFriction(e){this._rollingFriction!==e&&(this._rollingFriction=e,this._body&&this._body.setRollingFriction(e))}get rollingFriction(){return this._rollingFriction}set type(e){if(this._type!==e){switch(this._type=e,this.disableSimulation(),e){case"dynamic":this._group=1,this._mask=65535;break;case"kinematic":this._group=4,this._mask=65535;break;default:this._group=2,this._mask=65533}this.createBody()}}get type(){return this._type}createBody(){const e=this.entity;let t;if(e.collision&&(t=e.collision.shape,e.trigger&&(e.trigger.destroy(),delete e.trigger)),t){this._body&&this.system.onRemove(e,this);const s="dynamic"===this._type?this._mass:0;this._getEntityTransform(hA);const i=this.system.createBody(s,t,hA);if(i.setRestitution(this._restitution),i.setFriction(this._friction),i.setRollingFriction(this._rollingFriction),i.setDamping(this._linearDamping,this._angularDamping),"dynamic"===this._type){const e=this._linearFactor;lA.setValue(e.x,e.y,e.z),i.setLinearFactor(lA);const t=this._angularFactor;lA.setValue(t.x,t.y,t.z),i.setAngularFactor(lA)}else"kinematic"===this._type&&(i.setCollisionFlags(2|i.getCollisionFlags()),i.setActivationState(4));i.entity=e,this.body=i,this.enabled&&e.enabled&&this.enableSimulation()}}isActive(){return!!this._body&&this._body.isActive()}activate(){this._body&&this._body.activate()}enableSimulation(){const e=this.entity;if(e.collision&&e.collision.enabled&&!this._simulationEnabled){const t=this._body;if(t){switch(this.system.addBody(t,this._group,this._mask),this._type){case"dynamic":this.system._dynamic.push(this),t.forceActivationState(1),this.syncEntityToBody();break;case"kinematic":this.system._kinematic.push(this),t.forceActivationState(4);break;case"static":t.forceActivationState(1),this.syncEntityToBody()}"compound"===e.collision.type&&this.system._compounds.push(e.collision),t.activate(),this._simulationEnabled=!0}}}disableSimulation(){const e=this._body;if(e&&this._simulationEnabled){const t=this.system;let s=t._compounds.indexOf(this.entity.collision);s>-1&&t._compounds.splice(s,1),s=t._dynamic.indexOf(this),s>-1&&t._dynamic.splice(s,1),s=t._kinematic.indexOf(this),s>-1&&t._kinematic.splice(s,1),t.removeBody(e),e.forceActivationState(5),this._simulationEnabled=!1}}applyForce(){let e,t,s,i,n,a;switch(arguments.length){case 1:e=arguments[0].x,t=arguments[0].y,s=arguments[0].z;break;case 2:e=arguments[0].x,t=arguments[0].y,s=arguments[0].z,i=arguments[1].x,n=arguments[1].y,a=arguments[1].z;break;case 3:e=arguments[0],t=arguments[1],s=arguments[2];break;case 6:e=arguments[0],t=arguments[1],s=arguments[2],i=arguments[3],n=arguments[4],a=arguments[5]}const r=this._body;r&&(r.activate(),lA.setValue(e,t,s),void 0!==i?(cA.setValue(i,n,a),r.applyForce(lA,cA)):r.applyForce(lA,uA))}applyTorque(){let e,t,s;switch(arguments.length){case 1:e=arguments[0].x,t=arguments[0].y,s=arguments[0].z;break;case 3:e=arguments[0],t=arguments[1],s=arguments[2];break;default:return}const i=this._body;i&&(i.activate(),lA.setValue(e,t,s),i.applyTorque(lA))}applyImpulse(){let e,t,s,i,n,a;switch(arguments.length){case 1:e=arguments[0].x,t=arguments[0].y,s=arguments[0].z;break;case 2:e=arguments[0].x,t=arguments[0].y,s=arguments[0].z,i=arguments[1].x,n=arguments[1].y,a=arguments[1].z;break;case 3:e=arguments[0],t=arguments[1],s=arguments[2];break;case 6:e=arguments[0],t=arguments[1],s=arguments[2],i=arguments[3],n=arguments[4],a=arguments[5];break;default:return}const r=this._body;r&&(r.activate(),lA.setValue(e,t,s),void 0!==i?(cA.setValue(i,n,a),r.applyImpulse(lA,cA)):r.applyImpulse(lA,uA))}applyTorqueImpulse(){let e,t,s;switch(arguments.length){case 1:e=arguments[0].x,t=arguments[0].y,s=arguments[0].z;break;case 3:e=arguments[0],t=arguments[1],s=arguments[2];break;default:return}const i=this._body;i&&(i.activate(),lA.setValue(e,t,s),i.applyTorqueImpulse(lA))}isStatic(){return"static"===this._type}isStaticOrKinematic(){return"static"===this._type||"kinematic"===this._type}isKinematic(){return"kinematic"===this._type}_getEntityTransform(e){const t=this.entity,s=t.getPosition(),i=t.getRotation();lA.setValue(s.x,s.y,s.z),dA.setValue(i.x,i.y,i.z,i.w),e.setOrigin(lA),e.setRotation(dA)}syncEntityToBody(){const e=this._body;if(e){if(this._getEntityTransform(hA),e.setWorldTransform(hA),"kinematic"===this._type){const t=e.getMotionState();t&&t.setWorldTransform(hA)}e.activate()}}_updateDynamic(){const e=this._body;if(e.isActive()){const t=e.getMotionState();if(t){t.getWorldTransform(hA);const e=hA.getOrigin(),s=hA.getRotation();this.entity.setPosition(e.x(),e.y(),e.z()),this.entity.setRotation(s.x(),s.y(),s.z(),s.w())}}}_updateKinematic(){const e=this._body.getMotionState();e&&(this._getEntityTransform(hA),e.setWorldTransform(hA))}teleport(){arguments.length<3?(arguments[0]&&this.entity.setPosition(arguments[0]),arguments[1]&&(arguments[1]instanceof Ae?this.entity.setRotation(arguments[1]):this.entity.setEulerAngles(arguments[1]))):(6===arguments.length&&this.entity.setEulerAngles(arguments[3],arguments[4],arguments[5]),this.entity.setPosition(arguments[0],arguments[1],arguments[2])),this.syncEntityToBody()}onEnable(){this._body||this.createBody(),this.enableSimulation()}onDisable(){this.disableSimulation()}}class _A{constructor(){this.enabled=!0}}class gA{constructor(e,t,s){this.entity=e,this.point=t,this.normal=s}}class yA{constructor(e,t,s){0===arguments.length?(this.a=null,this.b=null,this.impulse=0,this.localPointA=new ge,this.localPointB=new ge,this.pointA=new ge,this.pointB=new ge,this.normal=new ge):(this.a=e,this.b=t,this.impulse=s.impulse,this.localPointA=s.localPoint,this.localPointB=s.localPointOther,this.pointA=s.point,this.pointB=s.pointOther,this.normal=s.normal)}}class vA{constructor(e=new ge,t=new ge,s=new ge,i=new ge,n=new ge,a=0){this.localPoint=e,this.localPointOther=t,this.point=s,this.pointOther=i,this.normal=n,this.impulse=a}}class xA{constructor(e,t){this.other=e,this.contacts=t}}const bA=["enabled"];class SA extends Uw{constructor(e){super(e),this.maxSubSteps=10,this.fixedTimeStep=1/60,this.gravity=new ge(0,-9.81,0),this._dynamic=[],this._kinematic=[],this._triggers=[],this._compounds=[],this.id="rigidbody",this._stats=e.stats.frame,this.ComponentType=fA,this.DataType=_A,this.contactPointPool=null,this.contactResultPool=null,this.singleContactResultPool=null,this.schema=bA,this.collisions={},this.frameCollisions={},this.on("beforeremove",this.onBeforeRemove,this),this.on("remove",this.onRemove,this)}onLibraryLoaded(){if("undefined"!=typeof Ammo){if(this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration),this.overlappingPairCache=new Ammo.btDbvtBroadphase,this.solver=new Ammo.btSequentialImpulseConstraintSolver,this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration),this.dynamicsWorld.setInternalTickCallback){const e=Ammo.addFunction(this._checkForCollisions.bind(this),"vif");this.dynamicsWorld.setInternalTickCallback(e)}pA=new Ammo.btVector3,mA=new Ammo.btVector3,fA.onLibraryLoaded(),this.contactPointPool=new oA(vA,1),this.contactResultPool=new oA(xA,1),this.singleContactResultPool=new oA(yA,1),this.app.systems.on("update",this.onUpdate,this)}else this.app.systems.off("update",this.onUpdate,this)}initializeComponentData(e,t,s){const i=["mass","linearDamping","angularDamping","linearFactor","angularFactor","friction","rollingFriction","restitution","type","group","mask"];for(const s of i)if(t.hasOwnProperty(s)){const i=t[s];Array.isArray(i)?e[s]=new ge(i[0],i[1],i[2]):e[s]=i}super.initializeComponentData(e,t,["enabled"])}cloneComponent(e,t){const s=e.rigidbody,i={enabled:s.enabled,mass:s.mass,linearDamping:s.linearDamping,angularDamping:s.angularDamping,linearFactor:[s.linearFactor.x,s.linearFactor.y,s.linearFactor.z],angularFactor:[s.angularFactor.x,s.angularFactor.y,s.angularFactor.z],friction:s.friction,rollingFriction:s.rollingFriction,restitution:s.restitution,type:s.type,group:s.group,mask:s.mask};return this.addComponent(t,i)}onBeforeRemove(e,t){t.enabled&&(t.enabled=!1)}onRemove(e,t){const s=t.body;s&&(this.removeBody(s),this.destroyBody(s),t.body=null)}addBody(e,t,s){void 0!==t&&void 0!==s?this.dynamicsWorld.addRigidBody(e,t,s):this.dynamicsWorld.addRigidBody(e)}removeBody(e){this.dynamicsWorld.removeRigidBody(e)}createBody(e,t,s){const i=new Ammo.btVector3(0,0,0);0!==e&&t.calculateLocalInertia(e,i);const n=new Ammo.btDefaultMotionState(s),a=new Ammo.btRigidBodyConstructionInfo(e,n,t,i),r=new Ammo.btRigidBody(a);return Ammo.destroy(a),Ammo.destroy(i),r}destroyBody(e){const t=e.getMotionState();t&&Ammo.destroy(t),Ammo.destroy(e)}raycastFirst(e,t){let s=null;pA.setValue(e.x,e.y,e.z),mA.setValue(t.x,t.y,t.z);const i=new Ammo.ClosestRayResultCallback(pA,mA);if(this.dynamicsWorld.rayTest(pA,mA,i),i.hasHit()){const e=i.get_m_collisionObject(),t=Ammo.castObject(e,Ammo.btRigidBody);if(t){const e=i.get_m_hitPointWorld(),n=i.get_m_hitNormalWorld();if(s=new gA(t.entity,new ge(e.x(),e.y(),e.z()),new ge(n.x(),n.y(),n.z())),arguments.length>2){(0,arguments[2])(s)}}}return Ammo.destroy(i),s}raycastAll(e,t){const s=[];pA.setValue(e.x,e.y,e.z),mA.setValue(t.x,t.y,t.z);const i=new Ammo.AllHitsRayResultCallback(pA,mA);if(this.dynamicsWorld.rayTest(pA,mA,i),i.hasHit()){const e=i.get_m_collisionObjects(),t=i.get_m_hitPointWorld(),n=i.get_m_hitNormalWorld(),a=e.size();for(let i=0;i<a;i++){const a=Ammo.castObject(e.at(i),Ammo.btRigidBody);if(a){const e=t.at(i),r=n.at(i),o=new gA(a.entity,new ge(e.x(),e.y(),e.z()),new ge(r.x(),r.y(),r.z()));s.push(o)}}}return Ammo.destroy(i),s}_storeCollision(e,t){let s=!1;const i=e.getGuid();return this.collisions[i]=this.collisions[i]||{others:[],entity:e},this.collisions[i].others.indexOf(t)<0&&(this.collisions[i].others.push(t),s=!0),this.frameCollisions[i]=this.frameCollisions[i]||{others:[],entity:e},this.frameCollisions[i].others.push(t),s}_createContactPointFromAmmo(e){const t=e.get_m_localPointA(),s=e.get_m_localPointB(),i=e.getPositionWorldOnA(),n=e.getPositionWorldOnB(),a=e.get_m_normalWorldOnB(),r=this.contactPointPool.allocate();return r.localPoint.set(t.x(),t.y(),t.z()),r.localPointOther.set(s.x(),s.y(),s.z()),r.point.set(i.x(),i.y(),i.z()),r.pointOther.set(n.x(),n.y(),n.z()),r.normal.set(a.x(),a.y(),a.z()),r.impulse=e.getAppliedImpulse(),r}_createReverseContactPointFromAmmo(e){const t=e.get_m_localPointA(),s=e.get_m_localPointB(),i=e.getPositionWorldOnA(),n=e.getPositionWorldOnB(),a=e.get_m_normalWorldOnB(),r=this.contactPointPool.allocate();return r.localPointOther.set(t.x(),t.y(),t.z()),r.localPoint.set(s.x(),s.y(),s.z()),r.pointOther.set(i.x(),i.y(),i.z()),r.point.set(n.x(),n.y(),n.z()),r.normal.set(a.x(),a.y(),a.z()),r.impulse=e.getAppliedImpulse(),r}_createSingleContactResult(e,t,s){const i=this.singleContactResultPool.allocate();return i.a=e,i.b=t,i.localPointA=s.localPoint,i.localPointB=s.localPointOther,i.pointA=s.point,i.pointB=s.pointOther,i.normal=s.normal,i.impulse=s.impulse,i}_createContactResult(e,t){const s=this.contactResultPool.allocate();return s.other=e,s.contacts=t,s}_cleanOldCollisions(){for(const e in this.collisions)if(this.collisions.hasOwnProperty(e)){const t=this.frameCollisions[e],s=this.collisions[e],i=s.entity,n=i.collision,a=i.rigidbody,r=s.others;let o=r.length;for(;o--;){const e=r[o];(!t||t.others.indexOf(e)<0)&&(r.splice(o,1),i.trigger?(n&&n.fire("triggerleave",e),e.rigidbody&&e.rigidbody.fire("triggerleave",i)):e.trigger||(a&&a.fire("collisionend",e),n&&n.fire("collisionend",e)))}0===r.length&&delete this.collisions[e]}}_hasContactEvent(e){const t=e.collision;if(t&&(t.hasEvent("collisionstart")||t.hasEvent("collisionend")||t.hasEvent("contact")))return!0;const s=e.rigidbody;return s&&(s.hasEvent("collisionstart")||s.hasEvent("collisionend")||s.hasEvent("contact"))}_checkForCollisions(e,t){const s=Ammo.wrapPointer(e,Ammo.btDynamicsWorld).getDispatcher(),i=s.getNumManifolds();this.frameCollisions={};for(let e=0;e<i;e++){const t=s.getManifoldByIndexInternal(e),i=t.getBody0(),n=t.getBody1(),a=Ammo.castObject(i,Ammo.btRigidBody),r=Ammo.castObject(n,Ammo.btRigidBody),o=a.entity,h=r.entity;if(!o||!h)continue;const l=a.getCollisionFlags(),c=r.getCollisionFlags(),d=t.getNumContacts(),u=[],p=[];let m;if(d>0)if(4&l||4&c){const e=o.collision&&(o.collision.hasEvent("triggerenter")||o.collision.hasEvent("triggerleave")),t=h.collision&&(h.collision.hasEvent("triggerenter")||h.collision.hasEvent("triggerleave")),s=o.rigidbody&&(o.rigidbody.hasEvent("triggerenter")||o.rigidbody.hasEvent("triggerleave")),i=h.rigidbody&&(h.rigidbody.hasEvent("triggerenter")||h.rigidbody.hasEvent("triggerleave"));e&&(m=this._storeCollision(o,h),!m||4&c||o.collision.fire("triggerenter",h)),t&&(m=this._storeCollision(h,o),!m||4&l||h.collision.fire("triggerenter",o)),s&&(m||(m=this._storeCollision(h,o)),m&&o.rigidbody.fire("triggerenter",h)),i&&(m||(m=this._storeCollision(o,h)),m&&h.rigidbody.fire("triggerenter",o))}else{const e=this._hasContactEvent(o),s=this._hasContactEvent(h),i=this.hasEvent("contact");if(i||e||s){for(let n=0;n<d;n++){const a=t.getContactPoint(n),r=this._createContactPointFromAmmo(a);if(e||s){u.push(r);const e=this._createReverseContactPointFromAmmo(a);p.push(e)}if(i){const e=this._createSingleContactResult(o,h,r);this.fire("contact",e)}}if(e){const e=this._createContactResult(h,u);m=this._storeCollision(o,h),o.collision&&(o.collision.fire("contact",e),m&&o.collision.fire("collisionstart",e)),o.rigidbody&&(o.rigidbody.fire("contact",e),m&&o.rigidbody.fire("collisionstart",e))}if(s){const e=this._createContactResult(o,p);m=this._storeCollision(h,o),h.collision&&(h.collision.fire("contact",e),m&&h.collision.fire("collisionstart",e)),h.rigidbody&&(h.rigidbody.fire("contact",e),m&&h.rigidbody.fire("collisionstart",e))}}}}this._cleanOldCollisions(),this.contactPointPool.freeAll(),this.contactResultPool.freeAll(),this.singleContactResultPool.freeAll()}onUpdate(e){let t,s;const i=this.dynamicsWorld.getGravity();i.x()===this.gravity.x&&i.y()===this.gravity.y&&i.z()===this.gravity.z||(i.setValue(this.gravity.x,this.gravity.y,this.gravity.z),this.dynamicsWorld.setGravity(i));const n=this._triggers;for(t=0,s=n.length;t<s;t++)n[t].updateTransform();const a=this._compounds;for(t=0,s=a.length;t<s;t++)a[t]._updateCompound();const r=this._kinematic;for(t=0,s=r.length;t<s;t++)r[t]._updateKinematic();this.dynamicsWorld.stepSimulation(e,this.maxSubSteps,this.fixedTimeStep);const o=this._dynamic;for(t=0,s=o.length;t<s;t++)o[t]._updateDynamic();this.dynamicsWorld.setInternalTickCallback||this._checkForCollisions(Ammo.getPointer(this.dynamicsWorld),e)}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this),"undefined"!=typeof Ammo&&(Ammo.destroy(this.dynamicsWorld),Ammo.destroy(this.solver),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.dispatcher),Ammo.destroy(this.collisionConfiguration),this.dynamicsWorld=null,this.solver=null,this.overlappingPairCache=null,this.dispatcher=null,this.collisionConfiguration=null)}}Tm._buildAccessors(fA.prototype,bA);const wA="none",TA="blend",MA=new Ce;class CA extends Tm{constructor(e,t){super(e,t),this._resolution=new ve(640,320),this._referenceResolution=new ve(640,320),this._scaleMode="none",this.scale=1,this._scaleBlend=.5,this._priority=0,this._screenSpace=!1,this.cull=this._screenSpace,this._screenMatrix=new Ce,this._elements=new Set,e.app.graphicsDevice.on("resizecanvas",this._onResize,this)}syncDrawOrder(){this.system.queueDrawOrderSync(this.entity.getGuid(),this._processDrawOrderSync,this)}_recurseDrawOrderSync(e,t){if(!(e instanceof $m))return t;if(e.element){const i=e.element.drawOrder;var s;if(e.element.drawOrder=t++,e.element._batchGroupId>=0&&i!==e.element.drawOrder)null==(s=this.system.app.batcher)||s.markGroupDirty(e.element._batchGroupId)}e.particlesystem&&(e.particlesystem.drawOrder=t++);const i=e.children;for(let e=0;e<i.length;e++)t=this._recurseDrawOrderSync(i[e],t);return t}_processDrawOrderSync(){this._recurseDrawOrderSync(this.entity,1),this.fire("syncdraworder")}_calcProjectionMatrix(){const e=this._resolution.x/this.scale,t=this._resolution.y/this.scale,s=e,i=-t;this._screenMatrix.setOrtho(0,s,i,0,1,-1),this._screenSpace||(MA.setScale(.5*e,.5*t,1),this._screenMatrix.mul2(MA,this._screenMatrix))}_updateScale(){this.scale=this._calcScale(this._resolution,this.referenceResolution)}_calcScale(e,t){const s=Math.log2(e.x/t.x),i=Math.log2(e.y/t.y);return Math.pow(2,s*(1-this._scaleBlend)+i*this._scaleBlend)}_onResize(e,t){this._screenSpace&&(this._resolution.set(e,t),this.resolution=this._resolution)}_bindElement(e){this._elements.add(e)}_unbindElement(e){this._elements.delete(e)}onRemove(){this.system.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.fire("remove"),this._elements.forEach((e=>e._onScreenRemove())),this._elements.clear(),this.off()}set resolution(e){this._screenSpace?this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height):this._resolution.set(e.x,e.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:resolution",this._resolution),this._elements.forEach((e=>e._onScreenResize(this._resolution)))}get resolution(){return this._resolution}set referenceResolution(e){this._referenceResolution.set(e.x,e.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:referenceresolution",this._resolution),this._elements.forEach((e=>e._onScreenResize(this._resolution)))}get referenceResolution(){return"none"===this._scaleMode?this._resolution:this._referenceResolution}set screenSpace(e){this._screenSpace=e,this._screenSpace&&this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height),this.resolution=this._resolution,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:screenspace",this._screenSpace),this._elements.forEach((e=>e._onScreenSpaceChange()))}get screenSpace(){return this._screenSpace}set scaleMode(e){"none"!==e&&"blend"!==e&&(e="none"),this._screenSpace||"none"===e||(e="none"),this._scaleMode=e,this.resolution=this._resolution,this.fire("set:scalemode",this._scaleMode)}get scaleMode(){return this._scaleMode}set scaleBlend(e){this._scaleBlend=e,this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:scaleblend",this._scaleBlend),this._elements.forEach((e=>e._onScreenResize(this._resolution)))}get scaleBlend(){return this._scaleBlend}set priority(e){e>255&&(e=255),this._priority!==e&&(this._priority=e,this.syncDrawOrder())}get priority(){return this._priority}}class AA{constructor(){this.enabled=!0}}const PA=["enabled"];class EA extends Uw{constructor(e){super(e),this.id="screen",this.ComponentType=CA,this.DataType=AA,this.schema=PA,this.windowResolution=new ve,this._drawOrderSyncQueue=new q,this.app.graphicsDevice.on("resizecanvas",this._onResize,this),this.app.systems.on("update",this._onUpdate,this),this.on("beforeremove",this.onRemoveComponent,this)}initializeComponentData(e,t,s){void 0!==t.priority&&(e.priority=t.priority),void 0!==t.screenSpace&&(e.screenSpace=t.screenSpace),e.cull=e.screenSpace,void 0!==t.scaleMode&&(e.scaleMode=t.scaleMode),void 0!==t.scaleBlend&&(e.scaleBlend=t.scaleBlend),void 0!==t.resolution&&(t.resolution instanceof ve?e._resolution.copy(t.resolution):e._resolution.set(t.resolution[0],t.resolution[1]),e.resolution=e._resolution),void 0!==t.referenceResolution&&(t.referenceResolution instanceof ve?e._referenceResolution.copy(t.referenceResolution):e._referenceResolution.set(t.referenceResolution[0],t.referenceResolution[1]),e.referenceResolution=e._referenceResolution),e.syncDrawOrder(),super.initializeComponentData(e,t,s)}destroy(){super.destroy(),this.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.app.systems.off("update",this._onUpdate,this)}_onUpdate(e){const t=this.store;for(const s in t)t[s].entity.screen.update&&t[s].entity.screen.update(e)}_onResize(e,t){this.windowResolution.x=e,this.windowResolution.y=t}cloneComponent(e,t){const s=e.screen;return this.addComponent(t,{enabled:s.enabled,screenSpace:s.screenSpace,scaleMode:s.scaleMode,resolution:s.resolution.clone(),referenceResolution:s.referenceResolution.clone()})}onRemoveComponent(e,t){t.onRemove()}processDrawOrderSyncQueue(){const e=this._drawOrderSyncQueue.list();for(let t=0;t<e.length;t++){const s=e[t];s.callback.call(s.scope)}this._drawOrderSyncQueue.clear()}queueDrawOrderSync(e,t,s){this._drawOrderSyncQueue.list().length||this.app.once("prerender",this.processDrawOrderSyncQueue,this),this._drawOrderSyncQueue.has(e)||this._drawOrderSyncQueue.push(e,{callback:t,scope:s})}}Tm._buildAccessors(CA.prototype,PA);class RA extends Tm{constructor(e,t){super(e,t),this.on("set_scripts",this.onSetScripts,this)}send(e,t){const s=Array.prototype.slice.call(arguments,2),i=this.entity.script.instances;let n;if(i&&i[e]&&(n=i[e].instance[t],n))return n.apply(i[e].instance,s)}onEnable(){this.data.areScriptsLoaded&&!this.system.preloading&&(this.data.initialized?this.system._enableScriptComponent(this):this.system._initializeScriptComponent(this),this.data.postInitialized||this.system._postInitializeScriptComponent(this))}onDisable(){this.system._disableScriptComponent(this)}onSetScripts(e,t,s){if(!this.system._inTools||this.runInTools){if(this._updateScriptAttributes(t,s))return;this.enabled&&this.system._disableScriptComponent(this),this.system._destroyScriptComponent(this),this.data.areScriptsLoaded=!1;const e=s.map((function(e){return e.url}));if(this._loadFromCache(e))return;this._loadScripts(e)}}_updateScriptAttributes(e,t){let s=!0;if(e.length!==t.length)s=!1;else for(let i=0,n=t.length;i<n;i++)if(e[i].url!==t[i].url){s=!1;break}if(s)for(const e in this.instances)this.instances.hasOwnProperty(e)&&this.system._updateAccessors(this.entity,this.instances[e]);return s}_loadFromCache(e){const t=[],s=this.system.app._scriptPrefix||"",i=/^http(s)?:\/\//i;for(let n=0,a=e.length;n<a;n++){let a=e[n];i.test(a)||(a=E.join(s,a));const r=this.system.app.loader.getFromCache(a,"script");if(!r)return!1;t.push(r)}for(let s=0,i=t.length;s<i;s++){const i=t[s];if(!0!==i&&(i&&this.entity.script&&!this.entity.script.instances[i._pcScriptName])){const t=new i(this.entity);this.system._preRegisterInstance(this.entity,e[s],i._pcScriptName,t)}}return this.data&&(this.data.areScriptsLoaded=!0),this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)),!0}_loadScripts(e){let t=e.length;const s=this.system.app._scriptPrefix||"";e.forEach((e=>{let i=null,n=null;e.toLowerCase().startsWith("http://")||e.toLowerCase().startsWith("https://")?(n=e,i=e):(n=e,i=E.join(s,e)),this.system.app.loader.load(i,"script",((e,s)=>{if(t--,e)console.error(e);else if(s&&this.entity.script&&!this.entity.script.instances[s._pcScriptName]){const e=new s(this.entity);this.system._preRegisterInstance(this.entity,n,s._pcScriptName,e)}0===t&&(this.data.areScriptsLoaded=!0,this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)))}))}))}}class LA{constructor(){this.scripts=[],this.enabled=!0,this.instances={},this._instances={},this.runInTools=!1,this.attributes={},this.initialized=!1,this.postInitialized=!1,this.areScriptsLoaded=!1}}const IA=["enabled","scripts","instances","runInTools"];class DA extends Uw{constructor(e){super(e),this.id="script",this.ComponentType=RA,this.DataType=LA,this.schema=IA,this.preloading=!1,this.instancesWithUpdate=[],this.instancesWithFixedUpdate=[],this.instancesWithPostUpdate=[],this.instancesWithToolsUpdate=[],this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("initialize",this.onInitialize,this),this.app.systems.on("postInitialize",this.onPostInitialize,this),this.app.systems.on("update",this.onUpdate,this),this.app.systems.on("fixedUpdate",this.onFixedUpdate,this),this.app.systems.on("postUpdate",this.onPostUpdate,this),this.app.systems.on("toolsUpdate",this.onToolsUpdate,this)}initializeComponentData(e,t,s){s=["runInTools","enabled","scripts"],t.scripts&&t.scripts.length&&t.scripts.forEach((function(e){if(e.attributes&&Array.isArray(e.attributes)){const t={};for(let s=0;s<e.attributes.length;s++)t[e.attributes[s].name]=e.attributes[s];e.attributes=t}})),super.initializeComponentData(e,t,s)}cloneComponent(e,t){const s=this.store[e.getGuid()],i={runInTools:s.data.runInTools,scripts:[],enabled:s.data.enabled},n=s.data.scripts;for(let e=0,t=n.length;e<t;e++){const t=n[e].attributes;t&&delete n[e].attributes,i.scripts.push(T({},n[e])),t&&(i.scripts[e].attributes=this._cloneAttributes(t),n[e].attributes=t)}return this.addComponent(t,i)}onBeforeRemove(e,t){t.enabled&&this._disableScriptComponent(t),this._destroyScriptComponent(t)}onInitialize(e){if(this._registerInstances(e),e.enabled){e.script&&e.script.enabled&&this._initializeScriptComponent(e.script);const t=e._children;for(let e=0,s=t.length;e<s;e++)t[e]instanceof $m&&this.onInitialize(t[e])}}onPostInitialize(e){if(e.enabled){e.script&&e.script.enabled&&this._postInitializeScriptComponent(e.script);const t=e._children;for(let e=0,s=t.length;e<s;e++)t[e]instanceof $m&&this.onPostInitialize(t[e])}}_callInstancesMethod(e,t){const s=e.data.instances;for(const e in s)if(s.hasOwnProperty(e)){const i=s[e].instance;i[t]&&i[t]()}}_initializeScriptComponent(e){this._callInstancesMethod(e,"initialize"),e.data.initialized=!0,e.enabled&&e.entity.enabled&&this._enableScriptComponent(e)}_enableScriptComponent(e){this._callInstancesMethod(e,"onEnable")}_disableScriptComponent(e){this._callInstancesMethod(e,"onDisable")}_destroyScriptComponent(e){const t=e.data.instances;for(const s in t)if(t.hasOwnProperty(s)){const i=t[s].instance;if(i.destroy&&i.destroy(),i.update){const e=this.instancesWithUpdate.indexOf(i);e>=0&&this.instancesWithUpdate.splice(e,1)}if(i.fixedUpdate){const e=this.instancesWithFixedUpdate.indexOf(i);e>=0&&this.instancesWithFixedUpdate.splice(e,1)}if(i.postUpdate){const e=this.instancesWithPostUpdate.indexOf(i);e>=0&&this.instancesWithPostUpdate.splice(e,1)}if(i.toolsUpdate){const e=this.instancesWithToolsUpdate.indexOf(i);e>=0&&this.instancesWithToolsUpdate.splice(e,1)}e.instances[s].instance===e[s]&&delete e[s],delete e.instances[s]}}_postInitializeScriptComponent(e){this._callInstancesMethod(e,"postInitialize"),e.data.postInitialized=!0}_updateInstances(e,t,s){for(let i=0,n=t.length;i<n;i++){const n=t[i];n&&n.entity&&n.entity.enabled&&n.entity.script.enabled&&n[e](s)}}onUpdate(e){this._updateInstances("update",this.instancesWithUpdate,e)}onFixedUpdate(e){this._updateInstances("fixedUpdate",this.instancesWithFixedUpdate,e)}onPostUpdate(e){this._updateInstances("postUpdate",this.instancesWithPostUpdate,e)}onToolsUpdate(e){this._updateInstances("toolsUpdate",this.instancesWithToolsUpdate,e)}broadcast(e,t){const s=Array.prototype.slice.call(arguments,2),i=this.store;for(const n in i)if(i.hasOwnProperty(n)){const a=i[n].data;if(a.instances[e]){const i=a.instances[e].instance[t];i&&i.apply(a.instances[e].instance,s)}}}_preRegisterInstance(e,t,s,i){if(e.script){if(e.script.data._instances=e.script.data._instances||{},e.script.data._instances[s])throw Error(`Script name collision '${s}'. Scripts from '${t}' and '${e.script.data._instances[s].url}' {${e.getGuid()}}`);e.script.data._instances[s]={url:t,name:s,instance:i}}}_registerInstances(e){if(e.script&&e.script.data._instances){e.script.instances=e.script.data._instances;for(const t in e.script.instances){const s=e.script.instances[t],i=s.instance;if(A.attach(i),i.update&&this.instancesWithUpdate.push(i),i.fixedUpdate&&this.instancesWithFixedUpdate.push(i),i.postUpdate&&this.instancesWithPostUpdate.push(i),i.toolsUpdate&&this.instancesWithToolsUpdate.push(i),e.script.scripts&&this._createAccessors(e,s),e.script[t])throw Error(`Script with name '${t}' is already attached to Script Component`);e.script[t]=i}delete e.script.data._instances}const t=e._children;for(let e=0,s=t.length;e<s;e++)t[e]instanceof $m&&this._registerInstances(t[e])}_cloneAttributes(e){const t={};for(const s in e)if(e.hasOwnProperty(s))if("entity"!==e[s].type)t[s]=T({},e[s]);else{const i=e[s].value;delete e[s].value,t[s]=T({},e[s]),t[s].value=i,e[s].value=i}return t}_createAccessors(e,t){const s=e.script.scripts.length,i=t.url;for(let n=0;n<s;n++){const s=e.script.scripts[n];if(s.url===i){const i=s.attributes;if(s.name&&i){for(const e in i)i.hasOwnProperty(e)&&this._createAccessor(i[e],t);e.script.data.attributes[s.name]=this._cloneAttributes(i)}break}}}_createAccessor(e,t){const s=this;e={name:e.name,value:e.value,type:e.type},this._convertAttributeValue(e),Object.defineProperty(t.instance,e.name,{get:function(){return e.value},set:function(i){const n=e.value;e.value=i,s._convertAttributeValue(e),t.instance.fire("set",e.name,n,e.value)},configurable:!0})}_updateAccessors(e,t){const s=e.script.scripts.length,i=t.url;for(let n=0;n<s;n++){const s=e.script,a=s.scripts[n];if(a.url===i){const e=a.name,i=a.attributes;if(e){if(i)for(const e in i)i.hasOwnProperty(e)&&this._createAccessor(i[e],t);const n=s.data.attributes[e];if(n)for(const e in n){const s=n[e];e in i?i[e].value!==s.value&&t.instance.onAttributeChanged&&t.instance.onAttributeChanged(s.name,s.value,i[e].value):delete t.instance[s.name]}i?s.data.attributes[e]=this._cloneAttributes(i):delete s.data.attributes[e]}break}}}_convertAttributeValue(e){if("rgb"===e.type||"rgba"===e.type)Array.isArray(e.value)&&(e.value=3===e.value.length?new pe(e.value[0],e.value[1],e.value[2]):new pe(e.value[0],e.value[1],e.value[2],e.value[3]));else if("vec2"===e.type)Array.isArray(e.value)&&(e.value=new ve(e.value[0],e.value[1]));else if("vec3"===e.type||"vector"===e.type)Array.isArray(e.value)&&(e.value=new ge(e.value[0],e.value[1],e.value[2]));else if("vec4"===e.type)Array.isArray(e.value)&&(e.value=new xe(e.value[0],e.value[1],e.value[2],e.value[3]));else if("entity"===e.type)null!==e.value&&"string"==typeof e.value&&(e.value=this.app.root.findByGuid(e.value));else if("curve"===e.type||"colorcurve"===e.type){const t=e.value.keys[0]instanceof Array?_e:fe;e.value=new t(e.value.keys),e.value.type=e.value.type}}destroy(){super.destroy(),this.app.systems.off("initialize",this.onInitialize,this),this.app.systems.off("postInitialize",this.onPostInitialize,this),this.app.systems.off("update",this.onUpdate,this),this.app.systems.off("fixedUpdate",this.onFixedUpdate,this),this.app.systems.off("postUpdate",this.onPostUpdate,this),this.app.systems.off("toolsUpdate",this.onToolsUpdate,this)}}Tm._buildAccessors(RA.prototype,IA);const OA=new ve,FA=new ge,kA=new ge,BA=new ge,zA=new ge,UA=new ge,VA=new Ae,NA={x:"y",y:"x"};class GA extends C{constructor(e,t){if(super(),!(e&&e instanceof aC))throw new Error("Element was null or not an ElementComponent");if(t&&"x"!==t&&"y"!==t)throw new Error("Unrecognized axis: "+t);this._element=e,this._app=e.system.app,this._axis=t||null,this._enabled=!0,this._dragScale=new ge,this._dragStartMousePosition=new ge,this._dragStartHandlePosition=new ge,this._deltaMousePosition=new ge,this._deltaHandlePosition=new ge,this._isDragging=!1,this._toggleLifecycleListeners("on")}_toggleLifecycleListeners(e){this._element[e]("mousedown",this._onMouseDownOrTouchStart,this),this._element[e]("touchstart",this._onMouseDownOrTouchStart,this)}_toggleDragListeners(e){const t="on"===e;this._hasDragListeners&&t||(this._handleMouseUpOrTouchEnd||(this._handleMouseUpOrTouchEnd=this._onMouseUpOrTouchEnd.bind(this)),this._app.mouse&&(this._element[e]("mousemove",this._onMove,this),this._element[e]("mouseup",this._handleMouseUpOrTouchEnd,!1)),N.touch&&(this._element[e]("touchmove",this._onMove,this),this._element[e]("touchend",this._handleMouseUpOrTouchEnd,this),this._element[e]("touchcancel",this._handleMouseUpOrTouchEnd,this)),this._hasDragListeners=t)}_onMouseDownOrTouchStart(e){if(this._element&&!this._isDragging&&this.enabled){this._dragCamera=e.camera,this._calculateDragScale();const t=this._screenToLocal(e);t&&(this._toggleDragListeners("on"),this._isDragging=!0,this._dragStartMousePosition.copy(t),this._dragStartHandlePosition.copy(this._element.entity.getLocalPosition()),this.fire("drag:start"))}}_onMouseUpOrTouchEnd(){this._isDragging&&(this._isDragging=!1,this._toggleDragListeners("off"),this.fire("drag:end"))}_screenToLocal(e){this._determineInputPosition(e),this._chooseRayOriginAndDirection(),zA.copy(this._element.entity.getPosition()),UA.copy(this._element.entity.forward).mulScalar(-1);const t=UA.dot(BA);if(Math.abs(t)>0){const e=zA.sub(kA).dot(UA)/t,s=kA.add(BA.mulScalar(e));return VA.copy(this._element.entity.getRotation()).invert().transformVector(s,s),s.mul(this._dragScale),s}return null}_determineInputPosition(e){const t=this._app.graphicsDevice.maxPixelRatio;void 0!==e.x&&void 0!==e.y?(OA.x=e.x*t,OA.y=e.y*t):e.changedTouches?(OA.x=e.changedTouches[0].x*t,OA.y=e.changedTouches[0].y*t):console.warn("Could not determine position from input event")}_chooseRayOriginAndDirection(){this._element.screen&&this._element.screen.screen.screenSpace?(kA.set(OA.x,-OA.y,0),BA.set(0,0,-1)):(FA.copy(this._dragCamera.screenToWorld(OA.x,OA.y,1)),kA.copy(this._dragCamera.entity.getPosition()),BA.copy(FA).sub(kA).normalize())}_calculateDragScale(){let e=this._element.entity.parent;const t=this._element.screen&&this._element.screen.screen,s=t&&t.screenSpace,i=s?t.scale:1,n=this._dragScale;for(n.set(i,i,i);e&&(n.mul(e.getLocalScale()),e=e.parent,!s||!e.screen););n.x=1/n.x,n.y=1/n.y,n.z=1/n.z}_onMove(e){if(this._element&&this._isDragging&&this.enabled&&this._element.enabled&&this._element.entity.enabled){const t=this._screenToLocal(e);if(this._dragStartMousePosition&&t){if(this._deltaMousePosition.copy(t).sub(this._dragStartMousePosition),this._deltaHandlePosition.copy(this._dragStartHandlePosition).add(this._deltaMousePosition),this._axis){const e=this._element.entity.getLocalPosition(),t=NA[this._axis];this._deltaHandlePosition[t]=e[t]}this._element.entity.setLocalPosition(this._deltaHandlePosition),this.fire("drag:move",this._deltaHandlePosition)}}}destroy(){this._toggleLifecycleListeners("off"),this._toggleDragListeners("off")}set enabled(e){this._enabled=e}get enabled(){return this._enabled}get isDragging(){return this._isDragging}}const WA=0,HA=1,XA=2,qA=0,jA=1,YA=new ve;class $A extends Tm{constructor(e,t){super(e,t),this._viewportReference=new cT(this,"viewportEntity",{"element#gain":this._onViewportElementGain,"element#resize":this._onSetContentOrViewportSize}),this._contentReference=new cT(this,"contentEntity",{"element#gain":this._onContentElementGain,"element#lose":this._onContentElementLose,"element#resize":this._onSetContentOrViewportSize}),this._scrollbarUpdateFlags={},this._scrollbarReferences={},this._scrollbarReferences[0]=new cT(this,"horizontalScrollbarEntity",{"scrollbar#set:value":this._onSetHorizontalScrollbarValue,"scrollbar#gain":this._onHorizontalScrollbarGain}),this._scrollbarReferences[1]=new cT(this,"verticalScrollbarEntity",{"scrollbar#set:value":this._onSetVerticalScrollbarValue,"scrollbar#gain":this._onVerticalScrollbarGain}),this._prevContentSizes={},this._prevContentSizes[0]=null,this._prevContentSizes[1]=null,this._scroll=new ve,this._velocity=new ge,this._dragStartPosition=new ge,this._disabledContentInput=!1,this._disabledContentInputEntities=[],this._toggleLifecycleListeners("on",e),this._toggleElementListeners("on")}_toggleLifecycleListeners(e,t){this[e]("set_horizontal",this._onSetHorizontalScrollingEnabled,this),this[e]("set_vertical",this._onSetVerticalScrollingEnabled,this),t.app.systems.element[e]("add",this._onElementComponentAdd,this),t.app.systems.element[e]("beforeremove",this._onElementComponentRemove,this)}_toggleElementListeners(e){if(this.entity.element){if("on"===e&&this._hasElementListeners)return;this.entity.element[e]("resize",this._onSetContentOrViewportSize,this),this.entity.element[e]("mousewheel",this._onMouseWheel,this),this._hasElementListeners="on"===e}}_onElementComponentAdd(e){this.entity===e&&this._toggleElementListeners("on")}_onElementComponentRemove(e){this.entity===e&&this._toggleElementListeners("off")}_onViewportElementGain(){this._syncAll()}_onContentElementGain(){this._destroyDragHelper(),this._contentDragHelper=new GA(this._contentReference.entity.element),this._contentDragHelper.on("drag:start",this._onContentDragStart,this),this._contentDragHelper.on("drag:end",this._onContentDragEnd,this),this._contentDragHelper.on("drag:move",this._onContentDragMove,this),this._prevContentSizes[0]=null,this._prevContentSizes[1]=null,this._syncAll()}_onContentElementLose(){this._destroyDragHelper()}_onContentDragStart(){this._contentReference.entity&&this.enabled&&this.entity.enabled&&this._dragStartPosition.copy(this._contentReference.entity.getLocalPosition())}_onContentDragEnd(){this._prevContentDragPosition=null,this._enableContentInput()}_onContentDragMove(e){if(this._contentReference.entity&&this.enabled&&this.entity.enabled&&(this._wasDragged=!0,this._setScrollFromContentPosition(e),this._setVelocityFromContentPositionDelta(e),!this._disabledContentInput)){const t=e.x-this._dragStartPosition.x,s=e.y-this._dragStartPosition.y;(Math.abs(t)>this.dragThreshold||Math.abs(s)>this.dragThreshold)&&this._disableContentInput()}}_onSetContentOrViewportSize(){this._syncAll()}_onSetHorizontalScrollbarValue(e){!this._scrollbarUpdateFlags[0]&&this.enabled&&this.entity.enabled&&this._onSetScroll(e,null)}_onSetVerticalScrollbarValue(e){!this._scrollbarUpdateFlags[1]&&this.enabled&&this.entity.enabled&&this._onSetScroll(null,e)}_onSetHorizontalScrollingEnabled(){this._syncScrollbarEnabledState(0)}_onSetVerticalScrollingEnabled(){this._syncScrollbarEnabledState(1)}_onHorizontalScrollbarGain(){this._syncScrollbarEnabledState(0),this._syncScrollbarPosition(0)}_onVerticalScrollbarGain(){this._syncScrollbarEnabledState(1),this._syncScrollbarPosition(1)}_onSetScroll(e,t,s){!1!==s&&this._velocity.set(0,0,0);const i=this._updateAxis(e,"x",0),n=this._updateAxis(t,"y",1);(i||n)&&this.fire("set:scroll",this._scroll)}_updateAxis(e,t,s){const i=null!==e&&Math.abs(e-this._scroll[t])>1e-5;return(i||this._isDragging()||0===e)&&(this._scroll[t]=this._determineNewScrollValue(e,t,s),this._syncContentPosition(s),this._syncScrollbarPosition(s)),i}_determineNewScrollValue(e,t,s){if(!this._getScrollingEnabled(s))return this._scroll[t];switch(this.scrollMode){case 0:return ne.clamp(e,0,this._getMaxScrollValue(s));case 1:return this._setVelocityFromOvershoot(e,t,s),e;case 2:return e;default:return console.warn("Unhandled scroll mode:"+this.scrollMode),e}}_syncAll(){this._syncContentPosition(0),this._syncContentPosition(1),this._syncScrollbarPosition(0),this._syncScrollbarPosition(1),this._syncScrollbarEnabledState(0),this._syncScrollbarEnabledState(1)}_syncContentPosition(e){const t=this._getAxis(e),s=this._getSign(e),i=this._contentReference.entity;if(i){const n=this._prevContentSizes[e],a=this._getContentSize(e);if(null!==n&&Math.abs(n-a)>1e-4){const s=this._getMaxOffset(e,n),i=this._getMaxOffset(e,a);this._scroll[t]=0===i?1:ne.clamp(this._scroll[t]*s/i,0,1)}const r=this._scroll[t]*this._getMaxOffset(e),o=i.getLocalPosition();o[t]=r*s,i.setLocalPosition(o),this._prevContentSizes[e]=a}}_syncScrollbarPosition(e){const t=this._getAxis(e),s=this._scrollbarReferences[e].entity;s&&s.scrollbar&&(this._scrollbarUpdateFlags[e]=!0,s.scrollbar.value=this._scroll[t],s.scrollbar.handleSize=this._getScrollbarHandleSize(t,e),this._scrollbarUpdateFlags[e]=!1)}_syncScrollbarEnabledState(e){const t=this._scrollbarReferences[e].entity;if(t){const s=this._getScrollingEnabled(e),i=this._getScrollbarVisibility(e);switch(i){case 0:return void(t.enabled=s);case 1:return void(t.enabled=s&&this._contentIsLargerThanViewport(e));default:console.warn("Unhandled scrollbar visibility:"+i),t.enabled=s}}}_contentIsLargerThanViewport(e){return this._getContentSize(e)>this._getViewportSize(e)}_contentPositionToScrollValue(e){const t=this._getMaxOffset(0),s=this._getMaxOffset(1);return YA.x=0===t?0:e.x/t,YA.y=0===s?0:e.y/-s,YA}_getMaxOffset(e,t){t=void 0===t?this._getContentSize(e):t;const s=this._getViewportSize(e);return t<s?-this._getViewportSize(e):s-t}_getMaxScrollValue(e){return this._contentIsLargerThanViewport(e)?1:0}_getScrollbarHandleSize(e,t){const s=this._getViewportSize(t),i=this._getContentSize(t);if(Math.abs(i)<.001)return 1;const n=Math.min(s/i,1),a=this._toOvershoot(this._scroll[e],t);return 0===a?n:n/(1+Math.abs(a))}_getViewportSize(e){return this._getSize(e,this._viewportReference)}_getContentSize(e){return this._getSize(e,this._contentReference)}_getSize(e,t){return t.entity&&t.entity.element?t.entity.element[this._getCalculatedDimension(e)]:0}_getScrollingEnabled(e){return 0===e?this.horizontal:1===e?this.vertical:void 0}_getScrollbarVisibility(e){return 0===e?this.horizontalScrollbarVisibility:1===e?this.verticalScrollbarVisibility:void 0}_getSign(e){return 0===e?1:-1}_getAxis(e){return 0===e?"x":"y"}_getCalculatedDimension(e){return 0===e?"calculatedWidth":"calculatedHeight"}_destroyDragHelper(){this._contentDragHelper&&this._contentDragHelper.destroy()}onUpdate(){this._contentReference.entity&&(this._updateVelocity(),this._syncScrollbarEnabledState(0),this._syncScrollbarEnabledState(1))}_updateVelocity(){if(!this._isDragging()){if(1===this.scrollMode&&(this._hasOvershoot("x",0)&&this._setVelocityFromOvershoot(this.scroll.x,"x",0),this._hasOvershoot("y",1)&&this._setVelocityFromOvershoot(this.scroll.y,"y",1)),Math.abs(this._velocity.x)>1e-4||Math.abs(this._velocity.y)>1e-4){const e=this._contentReference.entity.getLocalPosition();e.x+=this._velocity.x,e.y+=this._velocity.y,this._contentReference.entity.setLocalPosition(e),this._setScrollFromContentPosition(e)}this._velocity.x*=1-this.friction,this._velocity.y*=1-this.friction}}_hasOvershoot(e,t){return Math.abs(this._toOvershoot(this.scroll[e],t))>.001}_toOvershoot(e,t){const s=this._getMaxScrollValue(t);return e<0?e:e>s?e-s:0}_setVelocityFromOvershoot(e,t,s){const i=this._toOvershoot(e,s)*this._getMaxOffset(s)*this._getSign(s);Math.abs(i)>0&&(this._velocity[t]=-i/(50*this.bounceAmount+1))}_setVelocityFromContentPositionDelta(e){this._prevContentDragPosition?(this._velocity.sub2(e,this._prevContentDragPosition),this._prevContentDragPosition.copy(e)):(this._velocity.set(0,0,0),this._prevContentDragPosition=e.clone())}_setScrollFromContentPosition(e){let t=this._contentPositionToScrollValue(e);this._isDragging()&&(t=this._applyScrollValueTension(t)),this._onSetScroll(t.x,t.y,!1)}_applyScrollValueTension(e){let t=this._getMaxScrollValue(0),s=this._toOvershoot(e.x,0);return s>0?e.x=t+1*Math.log10(1+s):s<0&&(e.x=-1*Math.log10(1-s)),t=this._getMaxScrollValue(1),s=this._toOvershoot(e.y,1),s>0?e.y=t+1*Math.log10(1+s):s<0&&(e.y=-1*Math.log10(1-s)),e}_isDragging(){return this._contentDragHelper&&this._contentDragHelper.isDragging}_setScrollbarComponentsEnabled(e){this._scrollbarReferences[0].hasComponent("scrollbar")&&(this._scrollbarReferences[0].entity.scrollbar.enabled=e),this._scrollbarReferences[1].hasComponent("scrollbar")&&(this._scrollbarReferences[1].entity.scrollbar.enabled=e)}_setContentDraggingEnabled(e){this._contentDragHelper&&(this._contentDragHelper.enabled=e)}_onMouseWheel(e){if(this.useMouseWheel){const t=e.event,s=t.deltaX/this._contentReference.entity.element.calculatedWidth*this.mouseWheelSensitivity.x,i=t.deltaY/this._contentReference.entity.element.calculatedHeight*this.mouseWheelSensitivity.y,n=ne.clamp(this._scroll.x+s,0,this._getMaxScrollValue(0)),a=ne.clamp(this._scroll.y+i,0,this._getMaxScrollValue(1));this.scroll=new ve(n,a)}}_enableContentInput(){for(;this._disabledContentInputEntities.length;){const e=this._disabledContentInputEntities.pop();e.element&&(e.element.useInput=!0)}this._disabledContentInput=!1}_disableContentInput(){const e=t=>{t.element&&t.element.useInput&&(this._disabledContentInputEntities.push(t),t.element.useInput=!1);const s=t.children;for(let t=0,i=s.length;t<i;t++)e(s[t])},t=this._contentReference.entity;if(t){const s=t.children;for(let t=0,i=s.length;t<i;t++)e(s[t])}this._disabledContentInput=!0}onEnable(){this._viewportReference.onParentComponentEnable(),this._contentReference.onParentComponentEnable(),this._scrollbarReferences[0].onParentComponentEnable(),this._scrollbarReferences[1].onParentComponentEnable(),this._setScrollbarComponentsEnabled(!0),this._setContentDraggingEnabled(!0),this._syncAll()}onDisable(){this._setScrollbarComponentsEnabled(!1),this._setContentDraggingEnabled(!1)}onRemove(){this._toggleLifecycleListeners("off",this.system),this._toggleElementListeners("off"),this._destroyDragHelper()}set scroll(e){this._onSetScroll(e.x,e.y)}get scroll(){return this._scroll}}class KA{constructor(){this.enabled=!0}}const ZA=[{name:"enabled",type:"boolean"},{name:"horizontal",type:"boolean"},{name:"vertical",type:"boolean"},{name:"scrollMode",type:"number"},{name:"bounceAmount",type:"number"},{name:"friction",type:"number"},{name:"dragThreshold",type:"number"},{name:"useMouseWheel",type:"boolean"},{name:"mouseWheelSensitivity",type:"vec2"},{name:"horizontalScrollbarVisibility",type:"number"},{name:"verticalScrollbarVisibility",type:"number"},{name:"viewportEntity",type:"entity"},{name:"contentEntity",type:"entity"},{name:"horizontalScrollbarEntity",type:"entity"},{name:"verticalScrollbarEntity",type:"entity"}];class QA extends Uw{constructor(e){super(e),this.id="scrollview",this.ComponentType=$A,this.DataType=KA,this.schema=ZA,this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(e,t,s){void 0===t.dragThreshold&&(t.dragThreshold=10),void 0===t.useMouseWheel&&(t.useMouseWheel=!0),void 0===t.mouseWheelSensitivity&&(t.mouseWheelSensitivity=new ve(1,1)),super.initializeComponentData(e,t,ZA)}onUpdate(e){const t=this.store;for(const e in t){const s=t[e].entity,i=s.scrollview;i.enabled&&s.enabled&&i.onUpdate()}}_onRemoveComponent(e,t){t.onRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}Tm._buildAccessors($A.prototype,ZA);class JA extends Tm{constructor(e,t){super(e,t),this._handleReference=new cT(this,"handleEntity",{"element#gain":this._onHandleElementGain,"element#lose":this._onHandleElementLose,"element#set:anchor":this._onSetHandleAlignment,"element#set:margin":this._onSetHandleAlignment,"element#set:pivot":this._onSetHandleAlignment}),this._toggleLifecycleListeners("on")}_toggleLifecycleListeners(e){this[e]("set_value",this._onSetValue,this),this[e]("set_handleSize",this._onSetHandleSize,this),this[e]("set_orientation",this._onSetOrientation,this)}_onHandleElementGain(){this._destroyDragHelper(),this._handleDragHelper=new GA(this._handleReference.entity.element,this._getAxis()),this._handleDragHelper.on("drag:move",this._onHandleDrag,this),this._updateHandlePositionAndSize()}_onHandleElementLose(){this._destroyDragHelper()}_onHandleDrag(e){this._handleReference.entity&&this.enabled&&this.entity.enabled&&(this.value=this._handlePositionToScrollValue(e[this._getAxis()]))}_onSetValue(e,t,s){Math.abs(s-t)>1e-5&&(this.data.value=ne.clamp(s,0,1),this._updateHandlePositionAndSize(),this.fire("set:value",this.data.value))}_onSetHandleSize(e,t,s){Math.abs(s-t)>1e-5&&(this.data.handleSize=ne.clamp(s,0,1),this._updateHandlePositionAndSize())}_onSetHandleAlignment(){this._updateHandlePositionAndSize()}_onSetOrientation(e,t,s){s!==t&&this._handleReference.hasComponent("element")&&(this._handleReference.entity.element[this._getOppositeDimension()]=0)}_updateHandlePositionAndSize(){const e=this._handleReference.entity,t=e&&e.element;if(e){const t=e.getLocalPosition();t[this._getAxis()]=this._getHandlePosition(),this._handleReference.entity.setLocalPosition(t)}t&&(t[this._getDimension()]=this._getHandleLength())}_handlePositionToScrollValue(e){return e*this._getSign()/this._getUsableTrackLength()}_scrollValueToHandlePosition(e){return e*this._getSign()*this._getUsableTrackLength()}_getUsableTrackLength(){return Math.max(this._getTrackLength()-this._getHandleLength(),.001)}_getTrackLength(){return this.entity.element?0===this.orientation?this.entity.element.calculatedWidth:this.entity.element.calculatedHeight:0}_getHandleLength(){return this._getTrackLength()*this.handleSize}_getHandlePosition(){return this._scrollValueToHandlePosition(this.value)}_getSign(){return 0===this.orientation?1:-1}_getAxis(){return 0===this.orientation?"x":"y"}_getDimension(){return 0===this.orientation?"width":"height"}_getOppositeDimension(){return 0===this.orientation?"height":"width"}_destroyDragHelper(){this._handleDragHelper&&this._handleDragHelper.destroy()}_setHandleDraggingEnabled(e){this._handleDragHelper&&(this._handleDragHelper.enabled=e)}onEnable(){this._handleReference.onParentComponentEnable(),this._setHandleDraggingEnabled(!0)}onDisable(){this._setHandleDraggingEnabled(!1)}onRemove(){this._destroyDragHelper(),this._toggleLifecycleListeners("off")}}class eP{constructor(){this.enabled=!0}}const tP=[{name:"enabled",type:"boolean"},{name:"orientation",type:"number"},{name:"value",type:"number"},{name:"handleSize",type:"number"},{name:"handleEntity",type:"entity"}];class sP extends Uw{constructor(e){super(e),this.id="scrollbar",this.ComponentType=JA,this.DataType=eP,this.schema=tP,this.on("beforeremove",this._onRemoveComponent,this)}initializeComponentData(e,t,s){super.initializeComponentData(e,t,tP)}_onRemoveComponent(e,t){t.onRemove()}}Tm._buildAccessors(JA.prototype,tP);const iP={volume:0,pitch:0,loop:!1,startTime:0,duration:0,position:new ge,maxDistance:0,refDistance:0,rollOffFactor:0,distanceModel:0,onPlay:null,onPause:null,onResume:null,onStop:null,onEnd:null};class nP extends C{constructor(e,t="Untitled",s={}){super(),this.name=void 0,this.instances=[],this._component=e,this._assets=e.system.app.assets,this._manager=e.system.manager,this.name=t,this._volume=void 0!==s.volume?ne.clamp(Number(s.volume)||0,0,1):1,this._pitch=void 0!==s.pitch?Math.max(.01,Number(s.pitch)||0):1,this._loop=!(void 0===s.loop||!s.loop),this._duration=s.duration>0?s.duration:null,this._startTime=Math.max(0,Number(s.startTime)||0),this._overlap=!!s.overlap,this._autoPlay=!!s.autoPlay,this._firstNode=null,this._lastNode=null,this._asset=s.asset,this._asset instanceof um&&(this._asset=this._asset.id),this._onInstancePlayHandler=this._onInstancePlay.bind(this),this._onInstancePauseHandler=this._onInstancePause.bind(this),this._onInstanceResumeHandler=this._onInstanceResume.bind(this),this._onInstanceStopHandler=this._onInstanceStop.bind(this),this._onInstanceEndHandler=this._onInstanceEnd.bind(this)}play(){if(this.overlap||this.stop(),!this.isLoaded&&!this._hasAsset())return;const e=this._createInstance();if(this.instances.push(e),this.isLoaded)e.play();else{const t=function(t){const s=e._playWhenLoaded;e.sound=t,s&&e.play()};this.off("load",t),this.once("load",t),this.load()}return e}pause(){let e=!1;const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].pause()&&(e=!0);return e}resume(){let e=!1;const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].resume()&&(e=!0);return e}stop(){let e=!1;const t=this.instances;let s=t.length;for(;s--;)t[s].stop(),e=!0;return t.length=0,e}load(){if(!this._hasAsset())return;const e=this._assets.get(this._asset);return e?(e.off("remove",this._onAssetRemoved,this),e.on("remove",this._onAssetRemoved,this),e.resource?void this.fire("load",e.resource):(e.off("load",this._onAssetLoad,this),e.once("load",this._onAssetLoad,this),void this._assets.load(e))):(this._assets.off("add:"+this._asset,this._onAssetAdd,this),void this._assets.once("add:"+this._asset,this._onAssetAdd,this))}setExternalNodes(e,t){if(e){if(t||(t=e),this._firstNode=e,this._lastNode=t,!this._overlap){const s=this.instances;for(let i=0,n=s.length;i<n;i++)s[i].setExternalNodes(e,t)}}else console.error("The firstNode must have a valid AudioNode")}clearExternalNodes(){if(this._firstNode=null,this._lastNode=null,!this._overlap){const e=this.instances;for(let t=0,s=e.length;t<s;t++)e[t].clearExternalNodes()}}getExternalNodes(){return[this._firstNode,this._lastNode]}_hasAsset(){return null!=this._asset}_createInstance(){let e=null;const t=this._component;let s=null;if(this._hasAsset()){const e=this._assets.get(this._asset);e&&(s=e.resource)}const i=iP;return i.volume=this._volume*t.volume,i.pitch=this._pitch*t.pitch,i.loop=this._loop,i.startTime=this._startTime,i.duration=this._duration,i.onPlay=this._onInstancePlayHandler,i.onPause=this._onInstancePauseHandler,i.onResume=this._onInstanceResumeHandler,i.onStop=this._onInstanceStopHandler,i.onEnd=this._onInstanceEndHandler,t.positional?(i.position.copy(t.entity.getPosition()),i.maxDistance=t.maxDistance,i.refDistance=t.refDistance,i.rollOffFactor=t.rollOffFactor,i.distanceModel=t.distanceModel,e=new Rg(this._manager,s,i)):e=new Eg(this._manager,s,i),this._firstNode&&e.setExternalNodes(this._firstNode,this._lastNode),e}_onInstancePlay(e){this.fire("play",e),this._component.fire("play",this,e)}_onInstancePause(e){this.fire("pause",e),this._component.fire("pause",this,e)}_onInstanceResume(e){this.fire("resume",e),this._component.fire("resume",this,e)}_onInstanceStop(e){const t=this.instances.indexOf(e);-1!==t&&this.instances.splice(t,1),this.fire("stop",e),this._component.fire("stop",this,e)}_onInstanceEnd(e){const t=this.instances.indexOf(e);-1!==t&&this.instances.splice(t,1),this.fire("end",e),this._component.fire("end",this,e)}_onAssetAdd(e){this.load()}_onAssetLoad(e){this.load()}_onAssetRemoved(e){e.off("remove",this._onAssetRemoved,this),this._assets.off("add:"+e.id,this._onAssetAdd,this),this.stop()}updatePosition(e){const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].position=e}set asset(e){const t=this._asset;if(t){this._assets.off("add:"+t,this._onAssetAdd,this);const e=this._assets.get(t);e&&e.off("remove",this._onAssetRemoved,this)}this._asset=e,this._asset instanceof um&&(this._asset=this._asset.id),this._hasAsset()&&this._component.enabled&&this._component.entity.enabled&&this.load()}get asset(){return this._asset}set autoPlay(e){this._autoPlay=!!e}get autoPlay(){return this._autoPlay}set duration(e){if(this._duration=Math.max(0,Number(e)||0)||null,!this._overlap){const e=this.instances;for(let t=0,s=e.length;t<s;t++)e[t].duration=this._duration}}get duration(){let e=0;if(this._hasAsset()){const t=this._assets.get(this._asset);e=null!=t&&t.resource?t.resource.duration:0}return null!=this._duration?this._duration%(e||1):e}get isLoaded(){if(this._hasAsset()){const e=this._assets.get(this._asset);if(e)return!!e.resource}return!1}get isPaused(){const e=this.instances,t=e.length;if(0===t)return!1;for(let s=0;s<t;s++)if(!e[s].isPaused)return!1;return!0}get isPlaying(){const e=this.instances;for(let t=0,s=e.length;t<s;t++)if(e[t].isPlaying)return!0;return!1}get isStopped(){const e=this.instances;for(let t=0,s=e.length;t<s;t++)if(!e[t].isStopped)return!1;return!0}set loop(e){this._loop=!!e;const t=this.instances;for(let e=0,s=t.length;e<s;e++)t[e].loop=this._loop}get loop(){return this._loop}set overlap(e){this._overlap=!!e}get overlap(){return this._overlap}set pitch(e){if(this._pitch=Math.max(Number(e)||0,.01),!this._overlap){const e=this.instances;for(let t=0,s=e.length;t<s;t++)e[t].pitch=this.pitch*this._component.pitch}}get pitch(){return this._pitch}set startTime(e){if(this._startTime=Math.max(0,Number(e)||0),!this._overlap){const e=this.instances;for(let t=0,s=e.length;t<s;t++)e[t].startTime=this._startTime}}get startTime(){return this._startTime}set volume(e){if(this._volume=ne.clamp(Number(e)||0,0,1),!this._overlap){const e=this.instances;for(let t=0,s=e.length;t<s;t++)e[t].volume=this._volume*this._component.volume}}get volume(){return this._volume}}class aP extends Tm{constructor(e,t){super(e,t),this._volume=1,this._pitch=1,this._positional=!0,this._refDistance=1,this._maxDistance=1e4,this._rollOffFactor=1,this._distanceModel="linear",this._slots={},this._playingBeforeDisable={}}_updateSoundInstances(e,t,s){const i=this._slots;for(const n in i){const a=i[n];if(!a.overlap){const i=a.instances;for(let n=0,r=i.length;n<r;n++)i[n][e]=s?a[e]*t:t}}}set distanceModel(e){this._distanceModel=e,this._updateSoundInstances("distanceModel",e,!1)}get distanceModel(){return this._distanceModel}set maxDistance(e){this._maxDistance=e,this._updateSoundInstances("maxDistance",e,!1)}get maxDistance(){return this._maxDistance}set refDistance(e){this._refDistance=e,this._updateSoundInstances("refDistance",e,!1)}get refDistance(){return this._refDistance}set rollOffFactor(e){this._rollOffFactor=e,this._updateSoundInstances("rollOffFactor",e,!1)}get rollOffFactor(){return this._rollOffFactor}set pitch(e){this._pitch=e,this._updateSoundInstances("pitch",e,!0)}get pitch(){return this._pitch}set volume(e){this._volume=e,this._updateSoundInstances("volume",e,!0)}get volume(){return this._volume}set positional(e){this._positional=e;const t=this._slots;for(const e in t){const s=t[e];if(!s.overlap){const e=s.instances;for(let t=e.length-1;t>=0;t--){const i=e[t].isPlaying||e[t].isSuspended,n=e[t].currentTime;i&&e[t].stop();const a=s._createInstance();i&&(a.play(),a.currentTime=n),e.push(a)}}}}get positional(){return this._positional}set slots(e){const t=this._slots;if(t)for(const e in t)t[e].stop();const s={};for(const t in e)e[t]instanceof nP?s[e[t].name]=e[t]:e[t].name&&(s[e[t].name]=new nP(this,e[t].name,e[t]));this._slots=s,this.enabled&&this.entity.enabled&&this.onEnable()}get slots(){return this._slots}onEnable(){if(this.system._inTools)return;const e=this._slots,t=this._playingBeforeDisable;for(const s in e){const i=e[s];i.autoPlay&&i.isStopped?i.play():t[s]?i.resume():i.isLoaded||i.load()}}onDisable(){const e=this._slots,t={};for(const s in e)e[s].overlap||e[s].isPlaying&&(e[s].pause(),t[s]=!0);this._playingBeforeDisable=t}onRemove(){this.off()}addSlot(e,t){const s=this._slots;if(s[e])return null;const i=new nP(this,e,t);return s[e]=i,i.autoPlay&&this.enabled&&this.entity.enabled&&i.play(),i}removeSlot(e){const t=this._slots;t[e]&&(t[e].stop(),delete t[e])}slot(e){return this._slots[e]}play(e){if(!this.enabled||!this.entity.enabled)return null;const t=this._slots[e];return t?t.play():null}pause(e){const t=this._slots;if(e){const s=t[e];if(!s)return;s.pause()}else for(const e in t)t[e].pause()}resume(e){const t=this._slots;if(e){const s=t[e];if(!s)return;s.isPaused&&s.resume()}else for(const e in t)t[e].resume()}stop(e){const t=this._slots;if(e){const s=t[e];if(!s)return;s.stop()}else for(const e in t)t[e].stop()}}class rP{constructor(){this.enabled=!0}}const oP=["enabled"];class hP extends Uw{constructor(e){super(e),this.id="sound",this.ComponentType=aP,this.DataType=rP,this.schema=oP,this.manager=e.soundManager,this.app.systems.on("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this)}set volume(e){this.manager.volume=e}get volume(){return this.manager.volume}get context(){return bg()?this.manager.context:null}initializeComponentData(e,t,s){s=["volume","pitch","positional","refDistance","maxDistance","rollOffFactor","distanceModel","slots"];for(let i=0;i<s.length;i++)t.hasOwnProperty(s[i])&&(e[s[i]]=t[s[i]]);super.initializeComponentData(e,t,["enabled"])}cloneComponent(e,t){const s=e.sound,i=s.slots,n={};for(const e in i){const t=i[e];n[e]={name:t.name,volume:t.volume,pitch:t.pitch,loop:t.loop,duration:t.duration,startTime:t.startTime,overlap:t.overlap,autoPlay:t.autoPlay,asset:t.asset}}const a={distanceModel:s.distanceModel,enabled:s.enabled,maxDistance:s.maxDistance,pitch:s.pitch,positional:s.positional,refDistance:s.refDistance,rollOffFactor:s.rollOffFactor,slots:n,volume:s.volume};return this.addComponent(t,a)}onUpdate(e){const t=this.store;for(const e in t)if(t.hasOwnProperty(e)){const s=t[e].entity;if(s.enabled){const e=s.sound;if(e.enabled&&e.positional){const t=s.getPosition(),i=e.slots;for(const e in i)i[e].updatePosition(t)}}}}onBeforeRemove(e,t){const s=t.slots;for(const e in s)s[e].overlap||s[e].stop();t.onRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}Tm._buildAccessors(aP.prototype,oP);const lP="simple",cP="animated";class dP extends C{constructor(e,t){super(),this._component=e,this._frame=0,this._sprite=null,this._spriteAsset=null,this.spriteAsset=t.spriteAsset,this.name=t.name,this.fps=t.fps||0,this.loop=t.loop||!1,this._playing=!1,this._paused=!1,this._time=0}get duration(){if(this._sprite){const e=this.fps||Number.MIN_VALUE;return this._sprite.frameKeys.length/Math.abs(e)}return 0}set frame(e){this._setFrame(e);const t=this.fps||Number.MIN_VALUE;this._setTime(this._frame/t)}get frame(){return this._frame}get isPaused(){return this._paused}get isPlaying(){return this._playing}set sprite(e){if(this._sprite&&(this._sprite.off("set:meshes",this._onSpriteMeshesChange,this),this._sprite.off("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.off("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.off("set:texture",this._onSpriteMeshesChange,this)),this._sprite=e,this._sprite&&(this._sprite.on("set:meshes",this._onSpriteMeshesChange,this),this._sprite.on("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.on("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.on("set:texture",this._onSpriteMeshesChange,this)),this._component.currentClip===this){let t;e&&e.atlas?(e.atlas.texture&&(t=this._component._meshInstance,t&&(t.setParameter("texture_emissiveMap",e.atlas.texture),t.setParameter("texture_opacityMap",e.atlas.texture)),this._component.enabled&&this._component.entity.enabled&&this._component._showModel()),this.time&&this.fps?this.time=this.time:this.frame=this.frame):(t=this._component._meshInstance,t&&(t.deleteParameter("texture_emissiveMap"),t.deleteParameter("texture_opacityMap")),this._component._hideModel())}}get sprite(){return this._sprite}set spriteAsset(e){const t=this._component.system.app.assets;let s=e;if(e instanceof um&&(s=e.id),this._spriteAsset!==s){if(this._spriteAsset){const e=t.get(this._spriteAsset);e&&this._unbindSpriteAsset(e)}if(this._spriteAsset=s,this._spriteAsset){const e=t.get(this._spriteAsset);e?this._bindSpriteAsset(e):(this.sprite=null,t.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this))}else this.sprite=null}}get spriteAsset(){return this._spriteAsset}set time(e){this._setTime(e),this._sprite?this.frame=Math.min(this._sprite.frameKeys.length-1,Math.floor(this._time*Math.abs(this.fps))):this.frame=0}get time(){return this._time}_onSpriteAssetAdded(e){this._component.system.app.assets.off("add:"+e.id,this._onSpriteAssetAdded,this),this._spriteAsset===e.id&&this._bindSpriteAsset(e)}_bindSpriteAsset(e){e.on("load",this._onSpriteAssetLoad,this),e.on("remove",this._onSpriteAssetRemove,this),e.resource?this._onSpriteAssetLoad(e):this._component.system.app.assets.load(e)}_unbindSpriteAsset(e){e.off("load",this._onSpriteAssetLoad,this),e.off("remove",this._onSpriteAssetRemove,this),e.resource&&e.resource.atlas&&this._component.system.app.assets.off("load:"+e.data.textureAtlasAsset,this._onTextureAtlasLoad,this)}_onSpriteAssetLoad(e){if(e.resource)if(e.resource.atlas)this.sprite=e.resource;else{const t=e.data.textureAtlasAsset,s=this._component.system.app.assets;s.off("load:"+t,this._onTextureAtlasLoad,this),s.once("load:"+t,this._onTextureAtlasLoad,this)}else this.sprite=null}_onTextureAtlasLoad(e){const t=this._spriteAsset;t instanceof um?this._onSpriteAssetLoad(t):this._onSpriteAssetLoad(this._component.system.app.assets.get(t))}_onSpriteAssetRemove(e){this.sprite=null}_onSpriteMeshesChange(){this._component.currentClip===this&&this._component._showFrame(this.frame)}_onSpritePpuChanged(){this._component.currentClip===this&&0!==this.sprite.renderMode&&this._component._showFrame(this.frame)}_update(e){if(0===this.fps)return;if(!this._playing||this._paused||!this._sprite)return;const t=this.fps<0?-1:1,s=this._time+e*this._component.speed*t,i=this.duration,n=s>i||s<0;this._setTime(s);let a=this.frame;a=this._sprite?Math.floor(this._sprite.frameKeys.length*this._time/i):0,a!==this._frame&&this._setFrame(a),n&&(this.loop?(this.fire("loop"),this._component.fire("loop",this)):(this._playing=!1,this._paused=!1,this.fire("end"),this._component.fire("end",this)))}_setTime(e){this._time=e;const t=this.duration;this._time<0?this.loop?this._time=this._time%t+t:this._time=0:this._time>t&&(this.loop?this._time%=t:this._time=t)}_setFrame(e){this._sprite?this._frame=ne.clamp(e,0,this._sprite.frameKeys.length-1):this._frame=e,this._component.currentClip===this&&this._component._showFrame(this._frame)}_destroy(){this._sprite&&(this.sprite=null),this._spriteAsset&&(this.spriteAsset=null)}play(){this._playing||(this._playing=!0,this._paused=!1,this.frame=0,this.fire("play"),this._component.fire("play",this))}pause(){this._playing&&!this._paused&&(this._paused=!0,this.fire("pause"),this._component.fire("pause",this))}resume(){this._paused&&(this._paused=!1,this.fire("resume"),this._component.fire("resume",this))}stop(){this._playing&&(this._playing=!1,this._paused=!1,this._time=0,this.frame=0,this.fire("stop"),this._component.fire("stop",this))}}class uP extends Tm{constructor(e,t){super(e,t),this._type="simple",this._material=e.defaultMaterial,this._color=new pe(1,1,1,1),this._colorUniform=new Float32Array(3),this._speed=1,this._flipX=!1,this._flipY=!1,this._width=1,this._height=1,this._drawOrder=0,this._layers=[0],this._outerScale=new ve(1,1),this._outerScaleUniform=new Float32Array(2),this._innerOffset=new xe,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new xe,this._atlasRectUniform=new Float32Array(4),this._batchGroupId=-1,this._batchGroup=null,this._node=new kh,this._model=new rf,this._model.graph=this._node,this._meshInstance=null,t.addChild(this._model.graph),this._model._entity=t,this._updateAabbFunc=this._updateAabb.bind(this),this._addedModel=!1,this._autoPlayClip=null,this._clips={},this._defaultClip=new dP(this,{name:this.entity.name,fps:0,loop:!1,spriteAsset:null}),this._currentClip=this._defaultClip}set type(e){this._type!==e&&(this._type=e,"simple"===this._type?(this.stop(),this._currentClip=this._defaultClip,this.enabled&&this.entity.enabled&&(this._currentClip.frame=this.frame,this._currentClip.sprite?this._showModel():this._hideModel())):"animated"===this._type&&(this.stop(),this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.isPlaying&&this.enabled&&this.entity.enabled?this._showModel():this._hideModel()))}get type(){return this._type}set frame(e){this._currentClip.frame=e}get frame(){return this._currentClip.frame}set spriteAsset(e){this._defaultClip.spriteAsset=e}get spriteAsset(){return this._defaultClip._spriteAsset}set sprite(e){this._currentClip.sprite=e}get sprite(){return this._currentClip.sprite}set material(e){this._material=e,this._meshInstance&&(this._meshInstance.material=e)}get material(){return this._material}set color(e){this._color.r=e.r,this._color.g=e.g,this._color.b=e.b,this._meshInstance&&(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter("material_emissive",this._colorUniform))}get color(){return this._color}set opacity(e){this._color.a=e,this._meshInstance&&this._meshInstance.setParameter("material_opacity",e)}get opacity(){return this._color.a}set clips(e){if(e){for(const t in this._clips){let s=!1;for(const i in e)if(e[i].name===t){s=!0,this._clips[t].fps=e[i].fps,this._clips[t].loop=e[i].loop,e[i].hasOwnProperty("sprite")?this._clips[t].sprite=e[i].sprite:e[i].hasOwnProperty("spriteAsset")&&(this._clips[t].spriteAsset=e[i].spriteAsset);break}s||this.removeClip(t)}for(const t in e)this._clips[e[t].name]||this.addClip(e[t]);this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.sprite||this._hideModel()}else for(const e in this._clips)this.removeClip(e)}get clips(){return this._clips}get currentClip(){return this._currentClip}set speed(e){this._speed=e}get speed(){return this._speed}set flipX(e){this._flipX!==e&&(this._flipX=e,this._updateTransform())}get flipX(){return this._flipX}set flipY(e){this._flipY!==e&&(this._flipY=e,this._updateTransform())}get flipY(){return this._flipY}set width(e){e!==this._width&&(this._width=e,this._outerScale.x=this._width,!this.sprite||2!==this.sprite.renderMode&&1!==this.sprite.renderMode||this._updateTransform())}get width(){return this._width}set height(e){e!==this._height&&(this._height=e,this._outerScale.y=this.height,!this.sprite||2!==this.sprite.renderMode&&1!==this.sprite.renderMode||this._updateTransform())}get height(){return this._height}set batchGroupId(e){if(this._batchGroupId===e)return;const t=this._batchGroupId;var s,i;(this._batchGroupId=e,this.entity.enabled&&t>=0)&&(null==(s=this.system.app.batcher)||s.remove(rd.SPRITE,t,this.entity));this.entity.enabled&&e>=0?null==(i=this.system.app.batcher)||i.insert(rd.SPRITE,e,this.entity):t>=0&&this._currentClip&&this._currentClip.sprite&&this.enabled&&this.entity.enabled&&this._showModel()}get batchGroupId(){return this._batchGroupId}set autoPlayClip(e){this._autoPlayClip=e instanceof dP?e.name:e,this._tryAutoPlay()}get autoPlayClip(){return this._autoPlayClip}set drawOrder(e){this._drawOrder=e,this._meshInstance&&(this._meshInstance.drawOrder=e)}get drawOrder(){return this._drawOrder}set layers(e){this._addedModel&&this._hideModel(),this._layers=e,this._meshInstance&&this.enabled&&this.entity.enabled&&this._showModel()}get layers(){return this._layers}get aabb(){return this._meshInstance?this._meshInstance.aabb:null}onEnable(){const e=this.system.app,t=e.scene;var s;(t.on("set:layers",this._onLayersChanged,this),t.layers&&(t.layers.on("add",this._onLayerAdded,this),t.layers.on("remove",this._onLayerRemoved,this)),this._showModel(),this._autoPlayClip&&this._tryAutoPlay(),this._batchGroupId>=0)&&(null==(s=e.batcher)||s.insert(rd.SPRITE,this._batchGroupId,this.entity))}onDisable(){const e=this.system.app,t=e.scene;var s;(t.off("set:layers",this._onLayersChanged,this),t.layers&&(t.layers.off("add",this._onLayerAdded,this),t.layers.off("remove",this._onLayerRemoved,this)),this.stop(),this._hideModel(),this._batchGroupId>=0)&&(null==(s=e.batcher)||s.remove(rd.SPRITE,this._batchGroupId,this.entity))}onDestroy(){this._currentClip=null,this._defaultClip&&(this._defaultClip._destroy(),this._defaultClip=null);for(const e in this._clips)this._clips[e]._destroy();this._clips=null,this._hideModel(),this._model=null,this._node&&(this._node.parent&&this._node.parent.removeChild(this._node),this._node=null),this._meshInstance&&(this._meshInstance.material=null,this._meshInstance.mesh=null,this._meshInstance=null)}_showModel(){if(this._addedModel)return;if(!this._meshInstance)return;const e=[this._meshInstance];for(let t=0,s=this._layers.length;t<s;t++){const s=this.system.app.scene.layers.getLayerById(this._layers[t]);s&&s.addMeshInstances(e)}this._addedModel=!0}_hideModel(){if(!this._addedModel||!this._meshInstance)return;const e=[this._meshInstance];for(let t=0,s=this._layers.length;t<s;t++){const s=this.system.app.scene.layers.getLayerById(this._layers[t]);s&&s.removeMeshInstances(e)}this._addedModel=!1}_showFrame(e){if(!this.sprite)return;const t=this.sprite.meshes[e];if(!t)return void(this._meshInstance&&(this._meshInstance.mesh=null,this._meshInstance.visible=!1));let s;if(s=1===this.sprite.renderMode?this.system.default9SlicedMaterialSlicedMode:2===this.sprite.renderMode?this.system.default9SlicedMaterialTiledMode:this.system.defaultMaterial,this._meshInstance||(this._meshInstance=new xd(t,this._material,this._node),this._meshInstance.castShadow=!1,this._meshInstance.receiveShadow=!1,this._meshInstance.drawOrder=this._drawOrder,this._model.meshInstances.push(this._meshInstance),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter("material_emissive",this._colorUniform),this._meshInstance.setParameter("material_opacity",this._color.a),this.enabled&&this.entity.enabled&&this._showModel()),this._meshInstance.material!==s&&(this._meshInstance.material=s),this._meshInstance.mesh!==t&&(this._meshInstance.mesh=t,this._meshInstance.visible=!0,this._meshInstance._aabbVer=-1),this.sprite.atlas&&this.sprite.atlas.texture?(this._meshInstance.setParameter("texture_emissiveMap",this.sprite.atlas.texture),this._meshInstance.setParameter("texture_opacityMap",this.sprite.atlas.texture)):(this._meshInstance.deleteParameter("texture_emissiveMap"),this._meshInstance.deleteParameter("texture_opacityMap")),!this.sprite.atlas||1!==this.sprite.renderMode&&2!==this.sprite.renderMode)this._meshInstance._updateAabbFunc=null;else{this._meshInstance._updateAabbFunc=this._updateAabbFunc;const t=this.sprite.atlas.frames[this.sprite.frameKeys[e]];if(t){const e=2/t.rect.z,s=2/t.rect.w;this._innerOffset.set(t.border.x*e,t.border.y*s,t.border.z*e,t.border.w*s);const i=this.sprite.atlas.texture;this._atlasRect.set(t.rect.x/i.width,t.rect.y/i.height,t.rect.z/i.width,t.rect.w/i.height)}else this._innerOffset.set(0,0,0,0);this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._meshInstance.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._meshInstance.setParameter("atlasRect",this._atlasRectUniform)}this._updateTransform()}_updateTransform(){let e=this.flipX?-1:1,t=this.flipY?-1:1,s=0,i=0;if(this.sprite&&(1===this.sprite.renderMode||2===this.sprite.renderMode)){let n=1,a=1;if(this.sprite.atlas){const e=this.sprite.atlas.frames[this.sprite.frameKeys[this.frame]];e&&(n=e.rect.z,a=e.rect.w,s=(.5-e.pivot.x)*this._width,i=(.5-e.pivot.y)*this._height)}const r=n/this.sprite.pixelsPerUnit,o=a/this.sprite.pixelsPerUnit;this._outerScale.set(Math.max(this._width,this._innerOffset.x*r),Math.max(this._height,this._innerOffset.y*o)),e*=r,t*=o,this._outerScale.x/=r,this._outerScale.y/=o,e*=ne.clamp(this._width/(this._innerOffset.x*r),1e-4,1),t*=ne.clamp(this._height/(this._innerOffset.y*o),1e-4,1),this._meshInstance&&(this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._meshInstance.setParameter("outerScale",this._outerScaleUniform))}this._node.setLocalScale(e,t,1),this._node.setLocalPosition(s,i,0)}_updateAabb(e){return e.center.set(0,0,0),e.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001),e.setFromTransformedAabb(e,this._node.getWorldTransform()),e}_tryAutoPlay(){if(!this._autoPlayClip)return;if("animated"!==this.type)return;const e=this._clips[this._autoPlayClip];!e||e.isPlaying||this._currentClip&&this._currentClip.isPlaying||this.enabled&&this.entity.enabled&&this.play(e.name)}_onLayersChanged(e,t){e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this),this.enabled&&this.entity.enabled&&this._showModel()}_onLayerAdded(e){this.layers.indexOf(e.id)<0||this._addedModel&&this.enabled&&this.entity.enabled&&this._meshInstance&&e.addMeshInstances([this._meshInstance])}_onLayerRemoved(e){if(!this._meshInstance)return;this.layers.indexOf(e.id)<0||e.removeMeshInstances([this._meshInstance])}removeModelFromLayers(){for(let e=0;e<this.layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&t.removeMeshInstances([this._meshInstance])}}addClip(e){const t=new dP(this,{name:e.name,fps:e.fps,loop:e.loop,spriteAsset:e.spriteAsset});return this._clips[e.name]=t,t.name&&t.name===this._autoPlayClip&&this._tryAutoPlay(),t}removeClip(e){delete this._clips[e]}clip(e){return this._clips[e]}play(e){const t=this._clips[e],s=this._currentClip;return s&&s!==t&&(s._playing=!1),this._currentClip=t,this._currentClip&&(this._currentClip=t,this._currentClip.play()),t}pause(){this._currentClip!==this._defaultClip&&this._currentClip.isPlaying&&this._currentClip.pause()}resume(){this._currentClip!==this._defaultClip&&this._currentClip.isPaused&&this._currentClip.resume()}stop(){this._currentClip!==this._defaultClip&&this._currentClip.stop()}}class pP{constructor(){this.enabled=!0}}const mP=["enabled"];class fP extends Uw{constructor(e){super(e),this.id="sprite",this.ComponentType=uP,this.DataType=pP,this.schema=mP,this._defaultTexture=null,this._defaultMaterial=null,this._default9SlicedMaterialSlicedMode=null,this._default9SlicedMaterialTiledMode=null,this.app.systems.on("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this)}set defaultMaterial(e){this._defaultMaterial=e}get defaultMaterial(){if(!this._defaultMaterial){const e=new fh(this.app.graphicsDevice,{width:1,height:1,format:7,name:"sprite"}),t=new Uint8Array(e.lock());t[0]=t[1]=t[2]=t[3]=255,e.unlock();const s=new zl;s.diffuse.set(0,0,0),s.emissive.set(.5,.5,.5),s.emissiveMap=e,s.emissiveTint=!0,s.opacityMap=e,s.opacityMapChannel="a",s.opacityTint=!0,s.opacity=0,s.useLighting=!1,s.useGammaTonemap=!1,s.useFog=!1,s.useSkybox=!1,s.blendType=4,s.depthWrite=!1,s.pixelSnap=!1,s.cull=0,s.update(),this._defaultTexture=e,this._defaultMaterial=s}return this._defaultMaterial}set default9SlicedMaterialSlicedMode(e){this._default9SlicedMaterialSlicedMode=e}get default9SlicedMaterialSlicedMode(){if(!this._default9SlicedMaterialSlicedMode){const e=this.defaultMaterial.clone();e.nineSlicedMode=1,e.update(),this._default9SlicedMaterialSlicedMode=e}return this._default9SlicedMaterialSlicedMode}set default9SlicedMaterialTiledMode(e){this._default9SlicedMaterialTiledMode=e}get default9SlicedMaterialTiledMode(){if(!this._default9SlicedMaterialTiledMode){const e=this.defaultMaterial.clone();e.nineSlicedMode=2,e.update(),this._default9SlicedMaterialTiledMode=e}return this._default9SlicedMaterialTiledMode}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this),this._defaultTexture&&(this._defaultTexture.destroy(),this._defaultTexture=null)}initializeComponentData(e,t,s){if(void 0!==t.enabled&&(e.enabled=t.enabled),e.type=t.type,t.layers&&Array.isArray(t.layers)&&(e.layers=t.layers.slice(0)),void 0!==t.drawOrder&&(e.drawOrder=t.drawOrder),void 0!==t.color&&(t.color instanceof pe?e.color.set(t.color.r,t.color.g,t.color.b,void 0!==t.opacity?t.opacity:1):e.color.set(t.color[0],t.color[1],t.color[2],void 0!==t.opacity?t.opacity:1),e.color=e.color),void 0!==t.opacity&&(e.opacity=t.opacity),void 0!==t.flipX&&(e.flipX=t.flipX),void 0!==t.flipY&&(e.flipY=t.flipY),void 0!==t.width&&(e.width=t.width),void 0!==t.height&&(e.height=t.height),void 0!==t.spriteAsset&&(e.spriteAsset=t.spriteAsset),t.sprite&&(e.sprite=t.sprite),void 0!==t.frame&&(e.frame=t.frame),t.clips)for(const s in t.clips)e.addClip(t.clips[s]);void 0!==t.speed&&(e.speed=t.speed),t.autoPlayClip&&(e.autoPlayClip=t.autoPlayClip),e.batchGroupId=void 0===t.batchGroupId||null===t.batchGroupId?-1:t.batchGroupId,super.initializeComponentData(e,t,s)}cloneComponent(e,t){const s=e.sprite;return this.addComponent(t,{enabled:s.enabled,type:s.type,spriteAsset:s.spriteAsset,sprite:s.sprite,frame:s.frame,color:s.color.clone(),opacity:s.opacity,flipX:s.flipX,flipY:s.flipY,speed:s.speed,clips:s.clips,autoPlayClip:s.autoPlayClip,batchGroupId:s.batchGroupId,drawOrder:s.drawOrder,layers:s.layers.slice(0)})}onUpdate(e){const t=this.store;for(const s in t)if(t.hasOwnProperty(s)){const i=t[s];if(i.data.enabled&&i.entity.enabled){const t=i.entity.sprite;t._currentClip&&t._currentClip._update(e)}}}onBeforeRemove(e,t){t.onDestroy()}}Tm._buildAccessors(uP.prototype,mP);class _P extends Tm{constructor(e,t){super(e,t),this._oldState=!0,this._size=new ge,this.on("set_enabled",this._onSetEnabled,this)}set size(e){e instanceof ge?this._size.copy(e):e instanceof Array&&e.length>=3&&this.size.set(e[0],e[1],e[2])}get size(){return this._size}onEnable(){this._checkState()}onDisable(){this._checkState()}_onSetEnabled(e,t,s){this._checkState()}_checkState(){const e=this.enabled&&this.entity.enabled;e!==this._oldState&&(this._oldState=e,this.fire("enable"),this.fire("state",this.enabled))}_onBeforeRemove(){this.fire("remove")}}class gP{constructor(){this.enabled=!0}}const yP=["enabled"];class vP extends Uw{constructor(e){super(e),this.id="zone",this.ComponentType=_P,this.DataType=gP,this.schema=yP,this.on("beforeremove",this._onBeforeRemove,this)}initializeComponentData(e,t,s){e.enabled=!t.hasOwnProperty("enabled")||!!t.enabled,t.size&&(t.size instanceof ge?e.size.copy(t.size):t.size instanceof Array&&t.size.length>=3&&e.size.set(t.size[0],t.size[1],t.size[2]))}cloneComponent(e,t){const s={size:e.zone.size};return this.addComponent(t,s)}_onBeforeRemove(e,t){t._onBeforeRemove()}}Tm._buildAccessors(_P.prototype,yP);class xP{constructor(e,t){this.effect=e,this.inputTarget=t,this.outputTarget=null,this.name=e.constructor.name}}class bP{constructor(e,t){this.app=e,this.camera=t,this.destinationRenderTarget=null,this.effects=[],this.enabled=!1,this.depthTarget=null,t.on("set:rect",this.onCameraRectChanged,this)}_allocateColorBuffer(e,t){const s=this.camera.rect,i=Math.floor(s.z*this.app.graphicsDevice.width),n=Math.floor(s.w*this.app.graphicsDevice.height);return new fh(this.app.graphicsDevice,{name:t,format:e,width:i,height:n,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1})}_createOffscreenTarget(e,t){const s=this.app.graphicsDevice,i=t?s.getHdrFormat():7,n=this.camera.entity.name+"-posteffect-"+this.effects.length,a=this._allocateColorBuffer(i,n);return new Jl({colorBuffer:a,depth:e,stencil:e&&this.app.graphicsDevice.supportsStencil,samples:e?s.samples:1})}_resizeOffscreenTarget(e){const t=e.colorBuffer.format,s=e.colorBuffer.name;e.destroyFrameBuffers(),e.destroyTextureBuffers(),e._colorBuffer=this._allocateColorBuffer(t,s)}_destroyOffscreenTarget(e){e.destroyTextureBuffers(),e.destroy()}addEffect(e){const t=this.effects,s=0===t.length,i=this._createOffscreenTarget(s,e.hdr),n=new xP(e,i);t.push(n),this._sourceTarget=n.inputTarget,t.length>1&&(t[t.length-2].outputTarget=n.inputTarget),this._newPostEffect=e,e.needsDepthBuffer&&this._requestDepthMap(),this.enable(),this._newPostEffect=void 0}removeEffect(e){let t=-1;for(let s=0,i=this.effects.length;s<i;s++)if(this.effects[s].effect===e){t=s;break}t>=0&&(t>0?this.effects[t-1].outputTarget=t+1<this.effects.length?this.effects[t+1].inputTarget:null:this.effects.length>1&&(this.effects[1].inputTarget._depth||(this._destroyOffscreenTarget(this.effects[1].inputTarget),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr),this._sourceTarget=this.effects[1].inputTarget),this.camera.renderTarget=this.effects[1].inputTarget),this._destroyOffscreenTarget(this.effects[t].inputTarget),this.effects.splice(t,1)),this.enabled&&e.needsDepthBuffer&&this._releaseDepthMap(),0===this.effects.length&&this.disable()}_requestDepthMaps(){for(let e=0,t=this.effects.length;e<t;e++){const t=this.effects[e].effect;this._newPostEffect!==t&&(t.needsDepthBuffer&&this._requestDepthMap())}}_releaseDepthMaps(){for(let e=0,t=this.effects.length;e<t;e++){this.effects[e].effect.needsDepthBuffer&&this._releaseDepthMap()}}_requestDepthMap(){const e=this.app.scene.layers.getLayerById(1);e&&(e.incrementCounter(),this.camera.requestSceneDepthMap(!0))}_releaseDepthMap(){const e=this.app.scene.layers.getLayerById(1);e&&(e.decrementCounter(),this.camera.requestSceneDepthMap(!1))}destroy(){for(let e=0,t=this.effects.length;e<t;e++)this.effects[e].inputTarget.destroy();this.effects.length=0,this.disable()}enable(){!this.enabled&&this.effects.length&&(this.enabled=!0,this._requestDepthMaps(),this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this),this.destinationRenderTarget=this.camera.renderTarget,this.camera.renderTarget=this.effects[0].inputTarget,this.camera.onPostprocessing=()=>{if(this.enabled){let e=null;const t=this.effects.length;if(t)for(let s=0;s<t;s++){const i=this.effects[s];let n=i.outputTarget;s===t-1&&(e=this.camera.rect,this.destinationRenderTarget&&(n=this.destinationRenderTarget)),i.effect.render(i.inputTarget,n,e)}}})}disable(){this.enabled&&(this.enabled=!1,this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this),this._releaseDepthMaps(),this._destroyOffscreenTarget(this._sourceTarget),this.camera.renderTarget=null,this.camera.onPostprocessing=null)}_onCanvasResized(e,t){const s=this.camera.rect,i=this.app.graphicsDevice;this.camera.camera.aspectRatio=i.width*s.z/(i.height*s.w),this.resizeRenderTargets()}resizeRenderTargets(){const e=this.camera.rect,t=Math.floor(e.z*this.app.graphicsDevice.width),s=Math.floor(e.w*this.app.graphicsDevice.height),i=this.effects;for(let e=0,n=i.length;e<n;e++){const n=i[e];n.inputTarget.width===t&&n.inputTarget.height===s||this._resizeOffscreenTarget(n.inputTarget)}}onCameraRectChanged(e,t,s){this.enabled&&this.resizeRenderTargets()}}const SP=[{name:"aspectRatio",readonly:!1},{name:"aspectRatioMode",readonly:!1},{name:"calculateProjection",readonly:!1},{name:"calculateTransform",readonly:!1},{name:"clearColor",readonly:!1},{name:"cullFaces",readonly:!1},{name:"farClip",readonly:!1},{name:"flipFaces",readonly:!1},{name:"fov",readonly:!1},{name:"frustumCulling",readonly:!1},{name:"horizontalFov",readonly:!1},{name:"nearClip",readonly:!1},{name:"orthoHeight",readonly:!1},{name:"projection",readonly:!1},{name:"scissorRect",readonly:!1}];class wP extends Tm{constructor(e,t){super(e,t),this.onPostprocessing=null,this.onPreRender=null,this.onPostRender=null,this._renderSceneDepthMap=0,this._renderSceneColorMap=0,this._camera=new xh,this._camera.node=t,this._priority=0,this._disablePostEffectsLayer=4,this._postEffects=new bP(e.app,this)}get camera(){return this._camera}set clearColorBuffer(e){this._camera.clearColorBuffer=e,this.dirtyLayerCompositionCameras()}get clearColorBuffer(){return this._camera.clearColorBuffer}set clearDepthBuffer(e){this._camera.clearDepthBuffer=e,this.dirtyLayerCompositionCameras()}get clearDepthBuffer(){return this._camera.clearDepthBuffer}set clearStencilBuffer(e){this._camera.clearStencilBuffer=e,this.dirtyLayerCompositionCameras()}get clearStencilBuffer(){return this._camera.clearStencilBuffer}set disablePostEffectsLayer(e){this._disablePostEffectsLayer=e,this.dirtyLayerCompositionCameras()}get disablePostEffectsLayer(){return this._disablePostEffectsLayer}_enableDepthLayer(e){if(this.layers.find((e=>1===e))){const t=this.system.app.scene.layers.getLayerById(1);e?null==t||t.incrementCounter():null==t||t.decrementCounter()}else if(e)return!1;return!0}requestSceneColorMap(e){this._renderSceneColorMap+=e?1:-1,this._enableDepthLayer(e)}get renderSceneColorMap(){return this._renderSceneColorMap>0}requestSceneDepthMap(e){this._renderSceneDepthMap+=e?1:-1,this._enableDepthLayer(e)}get renderSceneDepthMap(){return this._renderSceneDepthMap>0}get frustum(){return this._camera.frustum}set layers(e){const t=this._camera.layers;for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);s&&s.removeCamera(this)}if(this._camera.layers=e,this.enabled&&this.entity.enabled)for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.addCamera(this)}}get layers(){return this._camera.layers}get layersSet(){return this._camera.layersSet}get postEffectsEnabled(){return this._postEffects.enabled}get postEffects(){return this._postEffects}set priority(e){this._priority=e,this.dirtyLayerCompositionCameras()}get priority(){return this._priority}get projectionMatrix(){return this._camera.projectionMatrix}set rect(e){this._camera.rect=e,this.fire("set:rect",this._camera.rect)}get rect(){return this._camera.rect}set renderTarget(e){this._camera.renderTarget=e,this.dirtyLayerCompositionCameras()}get renderTarget(){return this._camera.renderTarget}get viewMatrix(){return this._camera.viewMatrix}dirtyLayerCompositionCameras(){this.system.app.scene.layers._dirtyCameras=!0}screenToWorld(e,t,s,i){const n=this.system.app.graphicsDevice,a=n.clientRect.width,r=n.clientRect.height;return this._camera.screenToWorld(e,t,s,a,r,i)}worldToScreen(e,t){const s=this.system.app.graphicsDevice,i=s.clientRect.width,n=s.clientRect.height;return this._camera.worldToScreen(e,i,n,t)}onAppPrerender(){this._camera._viewMatDirty=!0,this._camera._viewProjMatDirty=!0}addCameraToLayers(){const e=this.layers;for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.addCamera(this)}}removeCameraFromLayers(){const e=this.layers;for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.removeCamera(this)}}onLayersChanged(e,t){this.addCameraToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||e.addCamera(this)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||e.removeCamera(this)}onEnable(){const e=this.system,t=e.app.scene,s=t.layers;e.addCamera(this),t.on("set:layers",this.onLayersChanged,this),s&&(s.on("add",this.onLayerAdded,this),s.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addCameraToLayers(),this.postEffects.enable()}onDisable(){const e=this.system,t=e.app.scene,s=t.layers;this.postEffects.disable(),this.removeCameraFromLayers(),t.off("set:layers",this.onLayersChanged,this),s&&(s.off("add",this.onLayerAdded,this),s.off("remove",this.onLayerRemoved,this)),e.removeCamera(this)}onRemove(){this.onDisable(),this.off()}calculateAspectRatio(e){const t=this.system.app.graphicsDevice,s=e?e.width:t.width,i=e?e.height:t.height;return s*this.rect.z/(i*this.rect.w)}frameUpdate(e){0===this.aspectRatioMode&&(this.aspectRatio=this.calculateAspectRatio(e))}startXr(e,t,s){this.system.app.xr.start(this,e,t,s)}endXr(e){this._camera.xr?this._camera.xr.end(e):e&&e(new Error("Camera is not in XR"))}copy(e){SP.forEach((t=>{if(!t.readonly){const s=t.name;this[s]=e[s]}})),this.clearColorBuffer=e.clearColorBuffer,this.clearDepthBuffer=e.clearDepthBuffer,this.clearStencilBuffer=e.clearStencilBuffer,this.disablePostEffectsLayer=e.disablePostEffectsLayer,this.layers=e.layers,this.priority=e.priority,this.renderTarget=e.renderTarget,this.rect=e.rect}}SP.forEach((function(e){const t=e.name,s={get:function(){return this._camera[t]}};e.readonly||(s.set=function(e){this._camera[t]=e}),Object.defineProperty(wP.prototype,t,s)}));class TP{constructor(){this.enabled=!0}}const MP=["enabled"];class CP extends Uw{constructor(e){super(e),this.cameras=[],this.id="camera",this.ComponentType=wP,this.DataType=TP,this.schema=MP,this.on("beforeremove",this.onBeforeRemove,this),this.app.on("prerender",this.onAppPrerender,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(e,t,s){s=["aspectRatio","aspectRatioMode","calculateProjection","calculateTransform","clearColor","clearColorBuffer","clearDepthBuffer","clearStencilBuffer","cullFaces","farClip","flipFaces","fov","frustumCulling","horizontalFov","layers","renderTarget","nearClip","orthoHeight","projection","priority","rect","scissorRect"];for(let i=0;i<s.length;i++){const n=s[i];if(t.hasOwnProperty(n)){const s=t[n];switch(n){case"rect":case"scissorRect":Array.isArray(s)?e[n]=new xe(s[0],s[1],s[2],s[3]):e[n]=s;break;case"clearColor":Array.isArray(s)?e[n]=new pe(s[0],s[1],s[2],s[3]):e[n]=s;break;default:e[n]=s}}}super.initializeComponentData(e,t,["enabled"])}cloneComponent(e,t){const s=e.camera;return this.addComponent(t,{aspectRatio:s.aspectRatio,aspectRatioMode:s.aspectRatioMode,calculateProjection:s.calculateProjection,calculateTransform:s.calculateTransform,clearColor:s.clearColor,clearColorBuffer:s.clearColorBuffer,clearDepthBuffer:s.clearDepthBuffer,clearStencilBuffer:s.clearStencilBuffer,cullFaces:s.cullFaces,enabled:s.enabled,farClip:s.farClip,flipFaces:s.flipFaces,fov:s.fov,frustumCulling:s.frustumCulling,horizontalFov:s.horizontalFov,layers:s.layers,renderTarget:s.renderTarget,nearClip:s.nearClip,orthoHeight:s.orthoHeight,projection:s.projection,priority:s.priority,rect:s.rect,scissorRect:s.scissorRect})}onBeforeRemove(e,t){this.removeCamera(t)}onUpdate(e){}onAppPrerender(){for(let e=0,t=this.cameras.length;e<t;e++)this.cameras[e].onAppPrerender()}addCamera(e){this.cameras.push(e),Ju(this.cameras)}removeCamera(e){const t=this.cameras.indexOf(e);t>=0&&(this.cameras.splice(t,1),Ju(this.cameras))}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}Tm._buildAccessors(wP.prototype,MP);const AP=[],PP=[];class EP extends Tm{constructor(e,t){super(e,t),this._cookieAsset=null,this._cookieAssetId=null,this._cookieAssetAdd=!1,this._cookieMatrix=null}addLightToLayers(){for(let e=0;e<this.layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&t.addLight(this)}}removeLightFromLayers(){for(let e=0;e<this.layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&t.removeLight(this)}}onLayersChanged(e,t){this.enabled&&this.entity.enabled&&this.addLightToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)>=0&&this.enabled&&this.entity.enabled&&e.addLight(this)}onLayerRemoved(e){this.layers.indexOf(e.id)>=0&&e.removeLight(this)}refreshProperties(){for(let e=0;e<AP.length;e++){const t=AP[e];this[t]=this[t]}this.enabled&&this.entity.enabled&&this.onEnable()}updateShadow(){this.light.updateShadow()}onCookieAssetSet(){let e=!1;"cubemap"!==this._cookieAsset.type||this._cookieAsset.loadFaces||(this._cookieAsset.loadFaces=!0,e=!0),this._cookieAsset.resource&&!e||this.system.app.assets.load(this._cookieAsset),this._cookieAsset.resource&&this.onCookieAssetLoad()}onCookieAssetAdd(e){this._cookieAssetId===e.id&&(this._cookieAsset=e,this.light.enabled&&this.onCookieAssetSet(),this._cookieAsset.on("load",this.onCookieAssetLoad,this),this._cookieAsset.on("remove",this.onCookieAssetRemove,this))}onCookieAssetLoad(){this._cookieAsset&&this._cookieAsset.resource&&(this.cookie=this._cookieAsset.resource)}onCookieAssetRemove(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off("add:"+this._cookieAssetId,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)}onEnable(){this.light.enabled=!0,this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addLightToLayers(),this._cookieAsset&&!this.cookie&&this.onCookieAssetSet()}onDisable(){this.light.enabled=!1,this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.removeLightFromLayers()}onRemove(){this.onDisable(),this.light.destroy(),this.cookieAsset=null}}function RP(e,t,s,i){const n=EP.prototype;AP.push(e),PP.push(t),Object.defineProperty(n,e,{get:function(){return this.data[e]},set:function(t){const n=this.data,a=n[e];(i||a!==t)&&(n[e]=t,s&&s.call(this,t,a))},configurable:!0})}RP("enabled",!0,(function(e,t){this.onSetEnabled(null,t,e)})),RP("light",null),RP("type","directional",(function(e,t){this.system.changeType(this,t,e),this.refreshProperties()})),RP("color",new pe(1,1,1),(function(e,t){this.light.setColor(e)}),!0),RP("intensity",1,(function(e,t){this.light.intensity=e})),RP("luminance",0,(function(e,t){this.light.lumninance=e})),RP("shape",0,(function(e,t){this.light.shape=e})),RP("castShadows",!1,(function(e,t){this.light.castShadows=e})),RP("shadowDistance",40,(function(e,t){this.light.shadowDistance=e})),RP("shadowIntensity",1,(function(e,t){this.light.shadowIntensity=e})),RP("shadowResolution",1024,(function(e,t){this.light.shadowResolution=e})),RP("shadowBias",.05,(function(e,t){this.light.shadowBias=-.01*ne.clamp(e,0,1)})),RP("numCascades",1,(function(e,t){this.light.numCascades=ne.clamp(Math.floor(e),1,4)})),RP("bakeNumSamples",1,(function(e,t){this.light.bakeNumSamples=ne.clamp(Math.floor(e),1,255)})),RP("bakeArea",0,(function(e,t){this.light.bakeArea=ne.clamp(e,0,180)})),RP("cascadeDistribution",.5,(function(e,t){this.light.cascadeDistribution=ne.clamp(e,0,1)})),RP("normalOffsetBias",0,(function(e,t){this.light.normalOffsetBias=ne.clamp(e,0,1)})),RP("range",10,(function(e,t){this.light.attenuationEnd=e})),RP("innerConeAngle",40,(function(e,t){this.light.innerConeAngle=e})),RP("outerConeAngle",45,(function(e,t){this.light.outerConeAngle=e})),RP("falloffMode",0,(function(e,t){this.light.falloffMode=e})),RP("shadowType",0,(function(e,t){this.light.shadowType=e})),RP("vsmBlurSize",11,(function(e,t){this.light.vsmBlurSize=e})),RP("vsmBlurMode",1,(function(e,t){this.light.vsmBlurMode=e})),RP("vsmBias",.0025,(function(e,t){this.light.vsmBias=ne.clamp(e,0,1)})),RP("cookieAsset",null,(function(e,t){if(!this._cookieAssetId||!(e instanceof um&&e.id===this._cookieAssetId||e===this._cookieAssetId))if(this.onCookieAssetRemove(),this._cookieAssetId=null,e instanceof um)this.data.cookieAsset=e.id,this._cookieAssetId=e.id,this.onCookieAssetAdd(e);else if("number"==typeof e){this._cookieAssetId=e;const t=this.system.app.assets.get(e);t?this.onCookieAssetAdd(t):(this._cookieAssetAdd=!0,this.system.app.assets.on("add:"+this._cookieAssetId,this.onCookieAssetAdd,this))}})),RP("cookie",null,(function(e,t){this.light.cookie=e})),RP("cookieIntensity",1,(function(e,t){this.light.cookieIntensity=ne.clamp(e,0,1)})),RP("cookieFalloff",!0,(function(e,t){this.light.cookieFalloff=e})),RP("cookieChannel","rgb",(function(e,t){this.light.cookieChannel=e})),RP("cookieAngle",0,(function(e,t){if(0!==e||null!==this.cookieScale){this._cookieMatrix||(this._cookieMatrix=new xe);let t=1,s=1;this.cookieScale&&(t=this.cookieScale.x,s=this.cookieScale.y);const i=Math.cos(e*ne.DEG_TO_RAD),n=Math.sin(e*ne.DEG_TO_RAD);this._cookieMatrix.set(i/t,-n/t,n/s,i/s),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null})),RP("cookieScale",null,(function(e,t){if(null!==e||0!==this.cookieAngle){this._cookieMatrix||(this._cookieMatrix=new xe);const t=e.x,s=e.y,i=Math.cos(this.cookieAngle*ne.DEG_TO_RAD),n=Math.sin(this.cookieAngle*ne.DEG_TO_RAD);this._cookieMatrix.set(i/t,-n/t,n/s,i/s),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null}),!0),RP("cookieOffset",null,(function(e,t){this.light.cookieOffset=e}),!0),RP("shadowUpdateMode",2,(function(e,t){this.light.shadowUpdateMode=e}),!0),RP("mask",1,(function(e,t){this.light.mask=e})),RP("affectDynamic",!0,(function(e,t){e?this.light.mask|=1:this.light.mask&=-2,this.light.layersDirty()})),RP("affectLightmapped",!1,(function(e,t){e?(this.light.mask|=2,this.bake&&(this.light.mask&=-5)):(this.light.mask&=-3,this.bake&&(this.light.mask|=4))})),RP("bake",!1,(function(e,t){e?(this.light.mask|=4,this.affectLightmapped&&(this.light.mask&=-3)):(this.light.mask&=-5,this.affectLightmapped&&(this.light.mask|=2)),this.light.layersDirty()})),RP("bakeDir",!0,(function(e,t){this.light.bakeDir=e})),RP("isStatic",!1,(function(e,t){this.light.isStatic=e})),RP("layers",[0],(function(e,t){for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);s&&s.removeLight(this)}for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&this.enabled&&this.entity.enabled&&s.addLight(this)}}));class LP{constructor(){const e=AP,t=PP;for(let s=0;s<e.length;s++){const i=t[s];i&&i.clone?this[e[s]]=i.clone():this[e[s]]=i}}}const IP={directional:0,omni:1,point:1,spot:2};class DP extends Uw{constructor(e){super(e),this.id="light",this.ComponentType=EP,this.DataType=LP,this.on("beforeremove",this._onRemoveComponent,this)}initializeComponentData(e,t){const s=AP,i={};for(let e=0,n=s.length;e<n;e++){const n=s[e];i[n]=t[n]}i.type||(i.type=e.data.type),e.data.type=i.type,i.layers&&Array.isArray(i.layers)&&(i.layers=i.layers.slice(0)),i.color&&Array.isArray(i.color)&&(i.color=new pe(i.color[0],i.color[1],i.color[2])),i.cookieOffset&&i.cookieOffset instanceof Array&&(i.cookieOffset=new ve(i.cookieOffset[0],i.cookieOffset[1])),i.cookieScale&&i.cookieScale instanceof Array&&(i.cookieScale=new ve(i.cookieScale[0],i.cookieScale[1])),i.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),i.enabled=i.enable),i.shape||(i.shape=0);const n=new pp(this.app.graphicsDevice);n.type=IP[i.type],n._node=e.entity,n._scene=this.app.scene,e.data.light=n,super.initializeComponentData(e,i,s)}_onRemoveComponent(e,t){t.onRemove()}cloneComponent(e,t){const s=e.light,i=[];let n;const a=AP;for(let e=0;e<a.length;e++)n=a[e],"light"!==n&&(s[n]&&s[n].clone?i[n]=s[n].clone():i[n]=s[n]);return this.addComponent(t,i)}changeType(e,t,s){t!==s&&(e.light.type=IP[s])}}class OP{constructor(){this.enabled=!0}}let FP=0;class kP extends Uw{constructor(e){super(e),this.id="script",this.ComponentType=Mm,this.DataType=OP,this._components=new K({sortBy:"_executionOrder"}),this._enabledComponents=new K({sortBy:"_executionOrder"}),this.preloading=!0,this.on("beforeremove",this._onBeforeRemove,this),this.app.systems.on("initialize",this._onInitialize,this),this.app.systems.on("postInitialize",this._onPostInitialize,this),this.app.systems.on("update",this._onUpdate,this),this.app.systems.on("postUpdate",this._onPostUpdate,this)}initializeComponentData(e,t){if(e._executionOrder=FP++,this._components.append(e),FP>Number.MAX_SAFE_INTEGER&&this._resetExecutionOrder(),e.enabled=!t.hasOwnProperty("enabled")||!!t.enabled,e.enabled&&e.entity.enabled&&this._enabledComponents.append(e),t.hasOwnProperty("order")&&t.hasOwnProperty("scripts")){e._scriptsData=t.scripts;for(let s=0;s<t.order.length;s++)e.create(t.order[s],{enabled:t.scripts[t.order[s]].enabled,attributes:t.scripts[t.order[s]].attributes,preloading:this.preloading})}}cloneComponent(e,t){const s=[],i={};for(let t=0;t<e.script._scripts.length;t++){const n=e.script._scripts[t],a=n.__scriptType.__name;s.push(a);const r={};for(const e in n.__attributes)r[e]=n.__attributes[e];i[a]={enabled:n._enabled,attributes:r}}for(const t in e.script._scriptsIndex)t.awaiting&&s.splice(t.ind,0,t);const n={enabled:e.script.enabled,order:s,scripts:i};return this.addComponent(t,n)}_resetExecutionOrder(){FP=0;for(let e=0,t=this._components.length;e<t;e++)this._components.items[e]._executionOrder=FP++}_callComponentMethod(e,t,s){for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++)e.items[e.loopIndex][t](s)}_onInitialize(){this.preloading=!1,this._callComponentMethod(this._components,"_onInitializeAttributes"),this._callComponentMethod(this._enabledComponents,"_onInitialize")}_onPostInitialize(){this._callComponentMethod(this._enabledComponents,"_onPostInitialize")}_onUpdate(e){this._callComponentMethod(this._enabledComponents,"_onUpdate",e)}_onPostUpdate(e){this._callComponentMethod(this._enabledComponents,"_onPostUpdate",e)}_addComponentToEnabled(e){this._enabledComponents.insert(e)}_removeComponentFromEnabled(e){this._enabledComponents.remove(e)}_onBeforeRemove(e,t){this._components.items.indexOf(t)>=0&&t._onBeforeRemove(),this._removeComponentFromEnabled(t),this._components.remove(t)}destroy(){super.destroy(),this.app.systems.off("initialize",this._onInitialize,this),this.app.systems.off("postInitialize",this._onPostInitialize,this),this.app.systems.off("update",this._onUpdate,this),this.app.systems.off("postUpdate",this._onPostUpdate,this)}}const BP="inline",zP="immersive-vr",UP="immersive-ar",VP="viewer",NP="local",GP="local-floor",WP="bounded-floor",HP="unbounded",XP="gaze",qP="screen",jP="tracked-pointer",YP="none",$P="left",KP="right",ZP="point",QP="plane",JP="mesh",eE="cpu-optimized",tE="gpu-optimized",sE="luminance-alpha",iE="float32",nE=[],aE=[];class rE extends C{constructor(e,t,s){super(),this.manager=void 0,this._xrHitTestSource=void 0,this._transient=void 0,this.manager=e,this._xrHitTestSource=t,this._transient=s}remove(){if(!this._xrHitTestSource)return;const e=this.manager.hitTest.sources,t=e.indexOf(this);-1!==t&&e.splice(t,1),this.onStop()}onStop(){this._xrHitTestSource.cancel(),this._xrHitTestSource=null,this.fire("remove"),this.manager.hitTest.fire("remove",this)}update(e){if(this._transient){const t=e.getHitTestResultsForTransientInput(this._xrHitTestSource);for(let e=0;e<t.length;e++){const s=t[e];let i;s.inputSource&&(i=this.manager.input._getByInputSource(s.inputSource)),this.updateHitResults(s.results,i)}}else this.updateHitResults(e.getHitTestResults(this._xrHitTestSource))}updateHitResults(e,t){for(let s=0;s<e.length;s++){const i=e[s].getPose(this.manager._referenceSpace);let n=nE.pop();n||(n=new ge),n.copy(i.transform.position);let a=aE.pop();a||(a=new Ae),a.copy(i.transform.orientation),this.fire("result",n,a,t),this.manager.hitTest.fire("result",this,n,a,t),nE.push(n),aE.push(a)}}}class oE extends C{constructor(e){super(),this.manager=void 0,this._supported=N.browser&&!(!window.XRSession||!window.XRSession.prototype.requestHitTestSource),this._session=null,this.sources=[],this.manager=e,this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this))}_onSessionStart(){this.manager.type===UP&&(this._session=this.manager.session)}_onSessionEnd(){if(this._session){this._session=null;for(let e=0;e<this.sources.length;e++)this.sources[e].onStop();this.sources=[]}}isAvailable(e,t){let s;return this._supported||(s=new Error("XR HitTest is not supported")),this._session||(s=new Error("XR Session is not started (1)")),this.manager.type!==UP&&(s=new Error("XR HitTest is available only for AR")),!s||(e&&e(s),t&&t.fire("error",s),!1)}start(e={}){if(!this.isAvailable(e.callback,this))return;let t;e.profile||e.spaceType||(e.spaceType="viewer");const s=e.offsetRay;if(s){const e=new DOMPoint(s.origin.x,s.origin.y,s.origin.z,1),i=new DOMPoint(s.direction.x,s.direction.y,s.direction.z,0);t=new XRRay(e,i)}const i=e.callback;e.spaceType?this._session.requestReferenceSpace(e.spaceType).then((s=>{if(!this._session){const e=new Error("XR Session is not started (2)");return i&&i(e),void this.fire("error",e)}this._session.requestHitTestSource({space:s,entityTypes:e.entityTypes||void 0,offsetRay:t}).then((e=>{this._onHitTestSource(e,!1,i)})).catch((e=>{i&&i(e),this.fire("error",e)}))})).catch((e=>{i&&i(e),this.fire("error",e)})):this._session.requestHitTestSourceForTransientInput({profile:e.profile,entityTypes:e.entityTypes||void 0,offsetRay:t}).then((e=>{this._onHitTestSource(e,!0,i)})).catch((e=>{i&&i(e),this.fire("error",e)}))}_onHitTestSource(e,t,s){if(!this._session){e.cancel();const t=new Error("XR Session is not started (3)");return s&&s(t),void this.fire("error",t)}const i=new rE(this.manager,e,t);this.sources.push(i),s&&s(null,i),this.fire("add",i)}update(e){for(let t=0;t<this.sources.length;t++)this.sources[t].update(e)}get supported(){return this._supported}}class hE{constructor(e,t){this._index=void 0,this._hand=void 0,this._joints=[],this._tip=null,this._index=e,this._hand=t,this._hand._fingers.push(this)}get index(){return this._index}get hand(){return this._hand}get joints(){return this._joints}get tip(){return this._tip}}const lE=N.browser&&window.XRHand?["thumb-tip","index-finger-tip","middle-finger-tip","ring-finger-tip","pinky-finger-tip"]:[],cE={};for(let e=0;e<lE.length;e++)cE[lE[e]]=!0;class dE{constructor(e,t,s,i=null){this._index=void 0,this._id=void 0,this._hand=void 0,this._finger=void 0,this._wrist=void 0,this._tip=void 0,this._radius=null,this._localTransform=new Ce,this._worldTransform=new Ce,this._localPosition=new ge,this._localRotation=new Ae,this._position=new ge,this._rotation=new Ae,this._dirtyLocal=!0,this._index=e,this._id=t,this._hand=s,this._finger=i,this._wrist="wrist"===t,this._tip=this._finger&&!!cE[t]}update(e){this._dirtyLocal=!0,this._radius=e.radius,this._localPosition.copy(e.transform.position),this._localRotation.copy(e.transform.orientation)}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,ge.ONE));const e=this._hand._manager.camera.parent;e?this._worldTransform.mul2(e.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}getPosition(){return this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position}getRotation(){return this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation}get index(){return this._index}get hand(){return this._hand}get finger(){return this._finger}get wrist(){return this._wrist}get tip(){return this._tip}get radius(){return this._radius||.005}}let uE=[];const pE=new ge,mE=new ge,fE=new ge;N.browser&&window.XRHand&&(uE=[["thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip"],["index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip"],["middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip"],["ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip"],["pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]]);class _E extends C{constructor(e){super(),this._manager=void 0,this._inputSource=void 0,this._tracking=!1,this._fingers=[],this._joints=[],this._jointsById={},this._tips=[],this._wrist=null;const t=e._xrInputSource.hand;if(this._manager=e._manager,this._inputSource=e,t.get("wrist")){const e=new dE(0,"wrist",this,null);this._wrist=e,this._joints.push(e),this._jointsById.wrist=e}for(let e=0;e<uE.length;e++){const s=new hE(e,this);for(let i=0;i<uE[e].length;i++){const n=uE[e][i];if(!t.get(n))continue;const a=new dE(i,n,this,s);this._joints.push(a),this._jointsById[n]=a,a.tip&&(this._tips.push(a),s._tip=a),s._joints.push(a)}}}update(e){const t=this._inputSource._xrInputSource;for(let s=0;s<this._joints.length;s++){const i=this._joints[s],n=t.hand.get(i._id);if(n){let t;if("hidden"!==e.session.visibilityState&&(t=e.getJointPose(n,this._manager._referenceSpace)),t)i.update(t),i.wrist&&!this._tracking&&(this._tracking=!0,this.fire("tracking"));else if(i.wrist){this._tracking&&(this._tracking=!1,this.fire("trackinglost"));break}}}const s=this._jointsById["thumb-metacarpal"],i=this._jointsById["thumb-tip"],n=this._jointsById["index-finger-phalanx-proximal"],a=this._jointsById["index-finger-tip"],r=this._jointsById["ring-finger-phalanx-proximal"],o=this._jointsById["pinky-finger-phalanx-proximal"];if(s&&i&&n&&a&&r&&o){this._inputSource._dirtyRay=!0,this._inputSource._rayLocal.origin.lerp(i._localPosition,a._localPosition,.5);let e=s,t=o;if("left"===this._inputSource.handedness){const s=e;e=t,t=s}pE.sub2(e._localPosition,this._wrist._localPosition),mE.sub2(t._localPosition,this._wrist._localPosition),fE.cross(pE,mE).normalize(),pE.lerp(n._localPosition,r._localPosition,.5),pE.sub(this._wrist._localPosition).normalize(),this._inputSource._rayLocal.direction.lerp(fE,pE,.5).normalize()}this._fingerIsClosed(1)&&this._fingerIsClosed(2)&&this._fingerIsClosed(3)&&this._fingerIsClosed(4)?this._inputSource._squeezing||(this._inputSource._squeezing=!0,this._inputSource.fire("squeezestart"),this._manager.input.fire("squeezestart",this._inputSource)):this._inputSource._squeezing&&(this._inputSource._squeezing=!1,this._inputSource.fire("squeeze"),this._manager.input.fire("squeeze",this._inputSource),this._inputSource.fire("squeezeend"),this._manager.input.fire("squeezeend",this._inputSource))}_fingerIsClosed(e){const t=this._fingers[e];return pE.sub2(t.joints[0]._localPosition,t.joints[1]._localPosition).normalize(),mE.sub2(t.joints[2]._localPosition,t.joints[3]._localPosition).normalize(),pE.dot(mE)<-.8}getJointById(e){return this._jointsById[e]||null}get fingers(){return this._fingers}get joints(){return this._joints}get tips(){return this._tips}get wrist(){return this._wrist}get tracking(){return this._tracking}}const gE=new Ae;let yE=0;class vE extends C{constructor(e,t){super(),this._id=void 0,this._manager=void 0,this._xrInputSource=void 0,this._ray=new vi,this._rayLocal=new vi,this._grip=!1,this._hand=null,this._localTransform=null,this._worldTransform=null,this._position=new ge,this._rotation=new Ae,this._localPosition=null,this._localRotation=null,this._dirtyLocal=!0,this._dirtyRay=!1,this._selecting=!1,this._squeezing=!1,this._elementInput=!0,this._elementEntity=null,this._hitTestSources=[],this._id=++yE,this._manager=e,this._xrInputSource=t,t.hand&&(this._hand=new _E(this))}get id(){return this._id}get inputSource(){return this._xrInputSource}get targetRayMode(){return this._xrInputSource.targetRayMode}get handedness(){return this._xrInputSource.handedness}get profiles(){return this._xrInputSource.profiles}get grip(){return this._grip}get hand(){return this._hand}get gamepad(){return this._xrInputSource.gamepad||null}get selecting(){return this._selecting}get squeezing(){return this._squeezing}set elementInput(e){this._elementInput!==e&&(this._elementInput=e,this._elementInput||(this._elementEntity=null))}get elementInput(){return this._elementInput}get elementEntity(){return this._elementEntity}get hitTestSources(){return this._hitTestSources}update(e){if(this._hand)this._hand.update(e);else{if(this._xrInputSource.gripSpace){const t=e.getPose(this._xrInputSource.gripSpace,this._manager._referenceSpace);t&&(this._grip||(this._grip=!0,this._localTransform=new Ce,this._worldTransform=new Ce,this._localPosition=new ge,this._localRotation=new Ae),this._dirtyLocal=!0,this._localPosition.copy(t.transform.position),this._localRotation.copy(t.transform.orientation))}const t=e.getPose(this._xrInputSource.targetRaySpace,this._manager._referenceSpace);t&&(this._dirtyRay=!0,this._rayLocal.origin.copy(t.transform.position),this._rayLocal.direction.set(0,0,-1),gE.copy(t.transform.orientation),gE.transformVector(this._rayLocal.direction,this._rayLocal.direction))}}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,ge.ONE));const e=this._manager.camera.parent;e?this._worldTransform.mul2(e.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}_updateRayTransforms(){const e=this._dirtyRay;this._dirtyRay=!1;if(this._manager.camera.parent){const e=this._manager.camera.parent.getWorldTransform();e.getTranslation(this._position),this._rotation.setFromMat4(e),this._rotation.transformVector(this._rayLocal.origin,this._ray.origin),this._ray.origin.add(this._position),this._rotation.transformVector(this._rayLocal.direction,this._ray.direction)}else e&&(this._ray.origin.copy(this._rayLocal.origin),this._ray.direction.copy(this._rayLocal.direction))}getPosition(){return this._position?(this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position):null}getLocalPosition(){return this._localPosition}getRotation(){return this._rotation?(this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation):null}getLocalRotation(){return this._localRotation}getOrigin(){return this._updateRayTransforms(),this._ray.origin}getDirection(){return this._updateRayTransforms(),this._ray.direction}hitTestStart(e={}){e.profile=this._xrInputSource.profiles[0];const t=e.callback;e.callback=(e,s)=>{s&&this.onHitTestSourceAdd(s),t&&t(e,s)},this._manager.hitTest.start(e)}onHitTestSourceAdd(e){this._hitTestSources.push(e),this.fire("hittest:add",e),e.on("result",(function(t,s,i){i===this&&this.fire("hittest:result",e,t,s)}),this),e.once("remove",(function(){this.onHitTestSourceRemove(e),this.fire("hittest:remove",e)}),this)}onHitTestSourceRemove(e){const t=this._hitTestSources.indexOf(e);-1!==t&&this._hitTestSources.splice(t,1)}}class xE extends C{constructor(e){super(),this.manager=void 0,this._inputSources=[],this._onInputSourcesChangeEvt=void 0,this.manager=e,this._onInputSourcesChangeEvt=e=>{this._onInputSourcesChange(e)},this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this)}_onSessionStart(){const e=this.manager.session;e.addEventListener("inputsourceschange",this._onInputSourcesChangeEvt),e.addEventListener("select",(e=>{const t=this._getByInputSource(e.inputSource);t.update(e.frame),t.fire("select",e),this.fire("select",t,e)})),e.addEventListener("selectstart",(e=>{const t=this._getByInputSource(e.inputSource);t.update(e.frame),t._selecting=!0,t.fire("selectstart",e),this.fire("selectstart",t,e)})),e.addEventListener("selectend",(e=>{const t=this._getByInputSource(e.inputSource);t.update(e.frame),t._selecting=!1,t.fire("selectend",e),this.fire("selectend",t,e)})),e.addEventListener("squeeze",(e=>{const t=this._getByInputSource(e.inputSource);t.update(e.frame),t.fire("squeeze",e),this.fire("squeeze",t,e)})),e.addEventListener("squeezestart",(e=>{const t=this._getByInputSource(e.inputSource);t.update(e.frame),t._squeezing=!0,t.fire("squeezestart",e),this.fire("squeezestart",t,e)})),e.addEventListener("squeezeend",(e=>{const t=this._getByInputSource(e.inputSource);t.update(e.frame),t._squeezing=!1,t.fire("squeezeend",e),this.fire("squeezeend",t,e)}));const t=e.inputSources;for(let e=0;e<t.length;e++)this._addInputSource(t[e])}_onSessionEnd(){let e=this._inputSources.length;for(;e--;){const t=this._inputSources[e];this._inputSources.splice(e,1),t.fire("remove"),this.fire("remove",t)}this.manager.session.removeEventListener("inputsourceschange",this._onInputSourcesChangeEvt)}_onInputSourcesChange(e){for(let t=0;t<e.removed.length;t++)this._removeInputSource(e.removed[t]);for(let t=0;t<e.added.length;t++)this._addInputSource(e.added[t])}_getByInputSource(e){for(let t=0;t<this._inputSources.length;t++)if(this._inputSources[t].inputSource===e)return this._inputSources[t];return null}_addInputSource(e){if(this._getByInputSource(e))return;const t=new vE(this.manager,e);this._inputSources.push(t),this.fire("add",t)}_removeInputSource(e){for(let t=0;t<this._inputSources.length;t++){if(this._inputSources[t].inputSource!==e)continue;const s=this._inputSources[t];this._inputSources.splice(t,1);let i=s.hitTestSources.length;for(;i--;)s.hitTestSources[i].remove();return s.fire("remove"),void this.fire("remove",s)}}update(e){for(let t=0;t<this._inputSources.length;t++)this._inputSources[t].update(e)}get inputSources(){return this._inputSources}}const bE=new ge,SE=new ge,wE=new Ce,TE=new Ce;class ME extends C{constructor(e){super(),this._manager=void 0,this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null,this._intensity=0,this._rotation=new Ae,this._color=new pe,this._sphericalHarmonics=new Float32Array(27),this._manager=e,this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this)}_onSessionStart(){!!this._manager.session.requestLightProbe&&(this._supported=!0)}_onSessionEnd(){this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null}start(){let e;this._manager.session||(e=new Error("XR session is not running")),e||this._manager.type===UP||(e=new Error("XR session type is not AR")),e||this._supported||(e=new Error("light-estimation is not supported")),(!e&&this._lightProbe||this._lightProbeRequested)&&(e=new Error("light estimation is already requested")),e?this.fire("error",e):(this._lightProbeRequested=!0,this._manager.session.requestLightProbe().then((e=>{const t=this._lightProbeRequested;this._lightProbeRequested=!1,this._manager.active?t&&(this._lightProbe=e):this.fire("error",new Error("XR session is not active"))})).catch((e=>{this._lightProbeRequested=!1,this.fire("error",e)})))}end(){this._lightProbeRequested=!1,this._lightProbe=null,this._available=!1}update(e){if(!this._lightProbe)return;const t=e.getLightEstimate(this._lightProbe);if(!t)return;this._available||(this._available=!0,this.fire("available"));const s=t.primaryLightIntensity;this._intensity=Math.max(1,Math.max(s.x,Math.max(s.y,s.z))),bE.copy(s).mulScalar(1/this._intensity),this._color.set(bE.x,bE.y,bE.z),bE.set(0,0,0),SE.copy(t.primaryLightDirection),wE.setLookAt(SE,bE,ge.UP),TE.setFromAxisAngle(ge.RIGHT,90),wE.mul(TE),this._rotation.setFromMat4(wE),this._sphericalHarmonics.set(t.sphericalHarmonicsCoefficients)}get supported(){return this._supported}get available(){return this._available}get intensity(){return this._available?this._intensity:null}get color(){return this._available?this._color:null}get rotation(){return this._available?this._rotation:null}get sphericalHarmonics(){return this._available?this._sphericalHarmonics:null}}class CE extends C{constructor(e,t){super(),this._image=void 0,this._width=void 0,this._bitmap=null,this._measuredWidth=0,this._trackable=!1,this._tracking=!1,this._emulated=!1,this._pose=null,this._position=new ge,this._rotation=new Ae,this._image=e,this._width=t}get image(){return this._image}set width(e){this._width=e}get width(){return this._width}get trackable(){return this._trackable}get tracking(){return this._tracking}get emulated(){return this._emulated}prepare(){return this._bitmap?{image:this._bitmap,widthInMeters:this._width}:createImageBitmap(this._image).then((e=>(this._bitmap=e,{image:this._bitmap,widthInMeters:this._width})))}destroy(){this._image=null,this._pose=null,this._bitmap&&(this._bitmap.close(),this._bitmap=null)}getPosition(){return this._pose&&this._position.copy(this._pose.transform.position),this._position}getRotation(){return this._pose&&this._rotation.copy(this._pose.transform.orientation),this._rotation}}class AE extends C{constructor(e){super(),this._manager=void 0,this._supported=N.browser&&!!window.XRImageTrackingResult,this._available=!1,this._images=[],this._manager=e,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}add(e,t){if(!this._supported||this._manager.active)return null;const s=new CE(e,t);return this._images.push(s),s}remove(e){if(this._manager.active)return;const t=this._images.indexOf(e);-1!==t&&(e.destroy(),this._images.splice(t,1))}_onSessionStart(){this._manager.session.getTrackedImageScores().then((e=>{this._available=!0;for(let t=0;t<e.length;t++)this._images[t]._trackable="trackable"===e[t]})).catch((e=>{this._available=!1,this.fire("error",e)}))}_onSessionEnd(){this._available=!1;for(let e=0;e<this._images.length;e++){const t=this._images[e];t._pose=null,t._measuredWidth=0,t._tracking&&(t._tracking=!1,t.fire("untracked"))}}prepareImages(e){this._images.length?Promise.all(this._images.map((function(e){return e.prepare()}))).then((function(t){e(null,t)})).catch((function(t){e(t,null)})):e(null,null)}update(e){if(!this._available)return;const t=e.getImageTrackingResults(),s={};for(let i=0;i<t.length;i++){s[t[i].index]=t[i];const n=this._images[t[i].index];n._emulated="emulated"===t[i].trackingState,n._measuredWidth=t[i].measuredWidthInMeters,n._pose=e.getPose(t[i].imageSpace,this._manager._referenceSpace)}for(let e=0;e<this._images.length;e++)this._images[e]._tracking&&!s[e]?(this._images[e]._tracking=!1,this._images[e].fire("untracked")):!this._images[e]._tracking&&s[e]&&(this._images[e]._tracking=!0,this._images[e].fire("tracked"))}get supported(){return this._supported}get available(){return this._available}get images(){return this._images}}class PE{constructor(e){this._manager=void 0,this._supported=N.browser&&!!window.XRDOMOverlayState,this._root=null,this._manager=e}get supported(){return this._supported}get available(){return this._supported&&this._manager.active&&null!==this._manager._session.domOverlayState}get state(){return this._supported&&this._manager.active&&this._manager._session.domOverlayState?this._manager._session.domOverlayState.type:null}set root(e){this._supported&&!this._manager.active&&(this._root=e)}get root(){return this._root}}class EE extends C{constructor(e){super(),this._manager=void 0,this._available=!1,this._depthInfoCpu=null,this._depthInfoGpu=null,this._usage=null,this._dataFormat=null,this._matrixDirty=!1,this._matrix=new Ce,this._emptyBuffer=new Uint8Array(32),this._depthBuffer=null,this._texture=void 0,this._manager=e,this._texture=new fh(this._manager.app.graphicsDevice,{format:2,mipmaps:!1,addressU:1,addressV:1,minFilter:1,magFilter:1,name:"XRDepthSensing"}),this.supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}destroy(){this._texture.destroy(),this._texture=null}_onSessionStart(){const e=this._manager.session;try{this._usage=e.depthUsage,this._dataFormat=e.depthDataFormat}catch(e){this._usage=null,this._dataFormat=null,this._available=!1,this.fire("error",e)}}_onSessionEnd(){this._depthInfoCpu=null,this._depthInfoGpu=null,this._usage=null,this._dataFormat=null,this._available&&(this._available=!1,this.fire("unavailable")),this._depthBuffer=null,this._texture._width=4,this._texture._height=4,this._texture._levels[0]=this._emptyBuffer,this._texture.upload()}_updateTexture(){const e=this._depthInfoCpu||this._depthInfoGpu;if(e){let t=!1;if(e.width===this._texture.width&&e.height===this._texture.height||(this._texture._width=e.width,this._texture._height=e.height,this._matrixDirty=!0,t=!0),this._depthInfoCpu){const e=this._depthInfoCpu.data;this._depthBuffer=new Uint8Array(e),this._texture._levels[0]=this._depthBuffer,this._texture.upload()}else this._depthInfoGpu&&(this._texture._levels[0]=this._depthInfoGpu.texture,this._texture.upload());t&&this.fire("resize",e.width,e.height)}else this._depthBuffer&&(this._depthBuffer=null,this._texture._width=4,this._texture._height=4,this._texture._levels[0]=this._emptyBuffer,this._texture.upload())}update(e,t){if(!this._usage)return;let s=null,i=null;if("cpu-optimized"===this._usage&&t?s=e.getDepthInformation(t):"gpu-optimized"===this._usage&&t&&(i=e.getDepthInformation(t)),(this._depthInfoCpu&&!s||!this._depthInfoCpu&&s||this.depthInfoGpu&&!i||!this._depthInfoGpu&&i)&&(this._matrixDirty=!0),this._depthInfoCpu=s,this._depthInfoGpu=i,this._updateTexture(),this._matrixDirty){this._matrixDirty=!1;const e=this._depthInfoCpu||this._depthInfoGpu;e?this._matrix.data.set(e.normDepthBufferFromNormView.matrix):this._matrix.setIdentity()}!this._depthInfoCpu&&!this._depthInfoGpu||this._available?this._depthInfoCpu||this._depthInfoGpu||!this._available||(this._available=!1,this.fire("unavailable")):(this._available=!0,this.fire("available"))}getDepth(e,t){return this._depthInfoCpu?this._depthInfoCpu.getDepthInMeters(e,t):null}get supported(){return N.browser&&!!window.XRDepthInformation}get available(){return this._available}get usage(){return this._usage}get dataFormat(){return this._dataFormat}get width(){const e=this._depthInfoCpu||this._depthInfoGpu;return e&&e.width||0}get height(){const e=this._depthInfoCpu||this._depthInfoGpu;return e&&e.height||0}get texture(){return this._texture}get uvMatrix(){return this._matrix}get rawValueToMeters(){const e=this._depthInfoCpu||this._depthInfoGpu;return e&&e.rawValueToMeters||0}}let RE=0;class LE extends C{constructor(e,t){super(),this._id=void 0,this._planeDetection=void 0,this._xrPlane=void 0,this._lastChangedTime=void 0,this._orientation=void 0,this._position=new ge,this._rotation=new Ae,this._id=++RE,this._planeDetection=e,this._xrPlane=t,this._lastChangedTime=t.lastChangedTime,this._orientation=t.orientation}destroy(){this.fire("remove")}update(e){const t=this._planeDetection._manager,s=e.getPose(this._xrPlane.planeSpace,t._referenceSpace);s&&(this._position.copy(s.transform.position),this._rotation.copy(s.transform.orientation)),this._lastChangedTime!==this._xrPlane.lastChangedTime&&(this._lastChangedTime=this._xrPlane.lastChangedTime,this.fire("change"))}getPosition(){return this._position}getRotation(){return this._rotation}get id(){return this._id}get orientation(){return this._orientation}get points(){return this._xrPlane.polygon}}class IE extends C{constructor(e){super(),this._manager=void 0,this._supported=N.browser&&!!window.XRPlane,this._available=!1,this._planesIndex=new Map,this._planes=null,this._manager=e,this._supported&&this._manager.on("end",this._onSessionEnd,this)}_onSessionEnd(){if(this._planes)for(let e=0;e<this._planes.length;e++)this._planes[e].destroy();this._planesIndex.clear(),this._planes=null,this._available&&(this._available=!1,this.fire("unavailable"))}update(e){let t;if(this._available)t=e.detectedPlanes;else try{t=e.detectedPlanes,this._planes=[],this._available=!0,this.fire("available")}catch(e){return}for(const[e,s]of this._planesIndex)t.has(e)||(this._planesIndex.delete(e),this._planes.splice(this._planes.indexOf(s),1),s.destroy(),this.fire("remove",s));for(const s of t){let t=this._planesIndex.get(s);t?t.update(e):(t=new LE(this,s),this._planesIndex.set(s,t),this._planes.push(t),t.update(e),this.fire("add",t))}}get supported(){return this._supported}get available(){return this._available}get planes(){return this._planes}}class DE extends C{constructor(e){super(),this.app=void 0,this._supported=N.browser&&!!navigator.xr,this._available={},this._type=null,this._spaceType=null,this._session=null,this._baseLayer=null,this._referenceSpace=null,this.depthSensing=void 0,this.domOverlay=void 0,this.hitTest=void 0,this.imageTracking=void 0,this.planeDetection=void 0,this.input=void 0,this.lightEstimation=void 0,this._camera=null,this.views=[],this.viewsPool=[],this._localPosition=new ge,this._localRotation=new Ae,this._depthNear=.1,this._depthFar=1e3,this._width=0,this._height=0,this.app=e,this._available.inline=!1,this._available["immersive-vr"]=!1,this._available[UP]=!1,this.depthSensing=new EE(this),this.domOverlay=new PE(this),this.hitTest=new oE(this),this.imageTracking=new AE(this),this.planeDetection=new IE(this),this.input=new xE(this),this.lightEstimation=new ME(this),this._supported&&(navigator.xr.addEventListener("devicechange",(()=>{this._deviceAvailabilityCheck()})),this._deviceAvailabilityCheck())}destroy(){this.depthSensing.destroy(),this.depthSensing=null}start(e,t,s,i){let n=i;if("object"==typeof i&&(n=i.callback),!this._available[t])return void(n&&n(new Error("XR is not available")));if(this._session)return void(n&&n(new Error("XR session is already started")));this._camera=e,this._camera.camera.xr=this,this._type=t,this._spaceType=s,this._setClipPlanes(e.nearClip,e.farClip);const a={requiredFeatures:[s],optionalFeatures:[]};if(t===UP){if(a.optionalFeatures.push("light-estimation"),a.optionalFeatures.push("hit-test"),i&&(i.imageTracking&&this.imageTracking.supported&&a.optionalFeatures.push("image-tracking"),i.planeDetection&&a.optionalFeatures.push("plane-detection")),this.domOverlay.supported&&this.domOverlay.root&&(a.optionalFeatures.push("dom-overlay"),a.domOverlay={root:this.domOverlay.root}),i&&i.depthSensing&&this.depthSensing.supported){a.optionalFeatures.push("depth-sensing");const e=["cpu-optimized"],t=["luminance-alpha"];if(i.depthSensing.usagePreference){const t=e.indexOf(i.depthSensing.usagePreference);-1!==t&&e.splice(t,1),e.unshift(i.depthSensing.usagePreference)}if(i.depthSensing.dataFormatPreference){const e=t.indexOf(i.depthSensing.dataFormatPreference);-1!==e&&t.splice(e,1),t.unshift(i.depthSensing.dataFormatPreference)}a.depthSensing={usagePreference:e,dataFormatPreference:t}}}else"immersive-vr"===t&&a.optionalFeatures.push("hand-tracking");i&&i.optionalFeatures&&(a.optionalFeatures=a.optionalFeatures.concat(i.optionalFeatures)),this.imageTracking.supported&&this.imageTracking.images.length?this.imageTracking.prepareImages(((e,i)=>{if(e)return n&&n(e),void this.fire("error",e);null!==i&&(a.trackedImages=i),this._onStartOptionsReady(t,s,a,n)})):this._onStartOptionsReady(t,s,a,n)}_onStartOptionsReady(e,t,s,i){navigator.xr.requestSession(e,s).then((e=>{this._onSessionStart(e,t,i)})).catch((e=>{this._camera.camera.xr=null,this._camera=null,this._type=null,this._spaceType=null,i&&i(e),this.fire("error",e)}))}end(e){this._session?(e&&this.once("end",e),this._session.end()):e&&e(new Error("XR Session is not initialized"))}isAvailable(e){return this._available[e]}_deviceAvailabilityCheck(){for(const e in this._available)this._sessionSupportCheck(e)}_sessionSupportCheck(e){navigator.xr.isSessionSupported(e).then((t=>{this._available[e]!==t&&(this._available[e]=t,this.fire("available",e,t),this.fire("available:"+e,t))})).catch((e=>{this.fire("error",e)}))}_onSessionStart(e,t,s){let i=!1;this._session=e;const n=()=>{this.fire("visibility:change",e.visibilityState)},a=()=>{this._setClipPlanes(this._camera.nearClip,this._camera.farClip)},r=()=>{this._camera&&(this._camera.off("set_nearClip",a),this._camera.off("set_farClip",a),this._camera.camera.xr=null,this._camera=null),e.removeEventListener("end",r),e.removeEventListener("visibilitychange",n),i||this.fire("end"),this._session=null,this._referenceSpace=null,this.views=[],this._width=0,this._height=0,this._type=null,this._spaceType=null,this.app.tick()};e.addEventListener("end",r),e.addEventListener("visibilitychange",n),this._camera.on("set_nearClip",a),this._camera.on("set_farClip",a),this._baseLayer=new XRWebGLLayer(e,this.app.graphicsDevice.gl,{alpha:!0,depth:!0,stencil:!0}),e.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar}),e.requestReferenceSpace(t).then((e=>{this._referenceSpace=e,this.app.tick(),s&&s(null),this.fire("start")})).catch((t=>{i=!0,e.end(),s&&s(t),this.fire("error",t)}))}_setClipPlanes(e,t){this._depthNear===e&&this._depthFar===t||(this._depthNear=e,this._depthFar=t,this._session&&this._session.updateRenderState({depthNear:this._depthNear,depthFar:this._depthFar}))}update(e){if(!this._session)return;const t=e.session.renderState.baseLayer.framebufferWidth,s=e.session.renderState.baseLayer.framebufferHeight;this._width===t&&this._height===s||(this._width=t,this._height=s,this.app.graphicsDevice.setResolution(t,s));const i=e.getViewerPose(this._referenceSpace),n=i?i.views.length:0;if(n>this.views.length)for(let e=0;e<=n-this.views.length;e++){let e=this.viewsPool.pop();e||(e={viewport:new xe,projMat:new Ce,viewMat:new Ce,viewOffMat:new Ce,viewInvMat:new Ce,viewInvOffMat:new Ce,projViewOffMat:new Ce,viewMat3:new ye,position:new Float32Array(3),rotation:new Ae}),this.views.push(e)}else if(n<=this.views.length)for(let e=0;e<this.views.length-n;e++)this.viewsPool.push(this.views.pop());if(i){const t=i.transform.position,s=i.transform.orientation;this._localPosition.set(t.x,t.y,t.z),this._localRotation.set(s.x,s.y,s.z,s.w);const n=e.session.renderState.baseLayer;for(let e=0;e<i.views.length;e++){const t=i.views[e],s=this.views[e],a=n.getViewport(t);s.viewport.x=a.x,s.viewport.y=a.y,s.viewport.z=a.width,s.viewport.w=a.height,s.projMat.set(t.projectionMatrix),s.viewMat.set(t.transform.inverse.matrix),s.viewInvMat.set(t.transform.matrix)}}this._camera.camera._node.setLocalPosition(this._localPosition),this._camera.camera._node.setLocalRotation(this._localRotation),this.input.update(e),this._type===UP&&(this.hitTest.supported&&this.hitTest.update(e),this.lightEstimation.supported&&this.lightEstimation.update(e),this.depthSensing.supported&&this.depthSensing.update(e,i&&i.views[0]),this.imageTracking.supported&&this.imageTracking.update(e),this.planeDetection.supported&&this.planeDetection.update(e)),this.fire("update",e)}get supported(){return this._supported}get active(){return!!this._session}get type(){return this._type}get spaceType(){return this._spaceType}get session(){return this._session}get camera(){return this._camera?this._camera.entity:null}get visibilityState(){return this._session?this._session.visibilityState:null}}class OE extends Xm{constructor(e,t={}){super(e);const s=new zw;s.graphicsDevice=this.createDevice(e,t),this.addComponentSystems(s),this.addResourceHandles(s),s.elementInput=t.elementInput,s.keyboard=t.keyboard,s.mouse=t.mouse,s.touch=t.touch,s.gamepads=t.gamepads,s.scriptPrefix=t.scriptPrefix,s.assetPrefix=t.assetPrefix,s.scriptsOrder=t.scriptsOrder,s.soundManager=new Cg(t),s.lightmapper=sf,s.batchManager=Rd,s.xr=DE,this.init(s)}createDevice(e,t){return t.graphicsDeviceOptions||(t.graphicsDeviceOptions={}),N.browser&&navigator.xr&&(t.graphicsDeviceOptions.xrCompatible=!0),t.graphicsDeviceOptions.alpha=t.graphicsDeviceOptions.alpha||!1,new Fc(e,t.graphicsDeviceOptions)}addComponentSystems(e){e.componentSystems=[SA,EM,yC,Hw,tT,qC,rA,CP,DP,gm.legacy?DA:kP,lT,hP,aT,tA,EA,lC,RT,QA,sP,fP,GC,SC,vP]}addResourceHandles(e){e.resourceHandlers=[vv,Fy,Gg,Wg,fv,ov,Wv,Ev,sv,zy,mm,bv,Hy,tv,Gy,wv,ev,Xy,jy,Uy,jv,Cv,Pv,Ny]}}const FE={write:function(e){console.log(e)},open:function(){FE.write("Powered by PlayCanvas 1.56.0 50ffa14a7")},info:function(e){console.info("INFO:    "+e)},debug:function(e){console.debug("DEBUG:   "+e)},error:function(e){console.error("ERROR:   "+e)},warning:function(e){console.warn("WARNING: "+e)},alert:function(e){FE.write("ALERT:   "+e),alert(e)},assert:function(e,t){!1===e&&FE.write("ASSERT:  "+t)}};X.endsWith=function(e,t){return e.endsWith(t)},X.startsWith=function(e,t){return e.startsWith(t)};const kE={now:Q,Timer:J};function BE(e,t){const s=function(){},i=function(s,i,n,a,r,o,h,l){t.call(this,s,i,n,a,r,o,h,l),e.call(this,s,i,n,a,r,o,h,l)};return i._super=t.prototype,s.prototype=t.prototype,i.prototype=new s,i}function zE(e){return Array.prototype.slice.call(e)}Object.defineProperty(pe.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.r,this._data[1]=this.g,this._data[2]=this.b,this._data[3]=this.a,this._data}}),Object.defineProperty(pe.prototype,"data3",{get:function(){return this._data3||(this._data3=new Float32Array(3)),this._data3[0]=this.r,this._data3[1]=this.g,this._data3[2]=this.b,this._data3}}),ne.INV_LOG2=Math.LOG2E,ne.intToBytes=ne.intToBytes32,ne.bytesToInt=ne.bytesToInt32,Object.defineProperty(ve.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(2)),this._data[0]=this.x,this._data[1]=this.y,this._data}}),ve.prototype.scale=ve.prototype.mulScalar,Object.defineProperty(ge.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(3)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data}}),ge.prototype.scale=ge.prototype.mulScalar,Object.defineProperty(xe.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data[3]=this.w,this._data}}),xe.prototype.scale=xe.prototype.mulScalar;const UE={Aabb:De,Sphere:ke,Plane:Ci};ke.prototype.intersectRay=ke.prototype.intersectsRay,yi.prototype.update=function(e,t){const s=new Ce;s.mul2(e,t),this.setFromMat4(s)};const VE=0,NE=1,GE=2,WE=3,HE=4,XE=5,qE=6;function jE(e){this.name="UnsupportedBrowserError",this.message=e||""}function YE(e){this.name="ContextCreationError",this.message=e||""}jE.prototype=Error.prototype,YE.prototype=Error.prototype;const $E={begin:$o,dummyFragmentCode:Yo,end:Ko,fogCode:No,gammaCode:Uo,precisionCode:Wo,skinCode:Go,tonemapCode:Vo,versionCode:Ho},KE={ADDRESS_CLAMP_TO_EDGE:1,ADDRESS_MIRRORED_REPEAT:2,ADDRESS_REPEAT:0,BLENDMODE_ZERO:0,BLENDMODE_ONE:1,BLENDMODE_SRC_COLOR:2,BLENDMODE_ONE_MINUS_SRC_COLOR:3,BLENDMODE_DST_COLOR:4,BLENDMODE_ONE_MINUS_DST_COLOR:5,BLENDMODE_SRC_ALPHA:6,BLENDMODE_SRC_ALPHA_SATURATE:7,BLENDMODE_ONE_MINUS_SRC_ALPHA:8,BLENDMODE_DST_ALPHA:9,BLENDMODE_ONE_MINUS_DST_ALPHA:10,BUFFER_STATIC:0,BUFFER_DYNAMIC:1,BUFFER_STREAM:2,CULLFACE_NONE:0,CULLFACE_BACK:1,CULLFACE_FRONT:2,CULLFACE_FRONTANDBACK:3,ELEMENTTYPE_INT8:0,ELEMENTTYPE_UINT8:1,ELEMENTTYPE_INT16:2,ELEMENTTYPE_UINT16:3,ELEMENTTYPE_INT32:4,ELEMENTTYPE_UINT32:5,ELEMENTTYPE_FLOAT32:6,FILTER_NEAREST:0,FILTER_LINEAR:1,FILTER_NEAREST_MIPMAP_NEAREST:2,FILTER_NEAREST_MIPMAP_LINEAR:3,FILTER_LINEAR_MIPMAP_NEAREST:4,FILTER_LINEAR_MIPMAP_LINEAR:5,INDEXFORMAT_UINT8:0,INDEXFORMAT_UINT16:1,INDEXFORMAT_UINT32:2,PIXELFORMAT_R5_G6_B5:3,PIXELFORMAT_R8_G8_B8:6,PIXELFORMAT_R8_G8_B8_A8:7,PRIMITIVE_POINTS:0,PRIMITIVE_LINES:1,PRIMITIVE_LINELOOP:2,PRIMITIVE_LINESTRIP:3,PRIMITIVE_TRIANGLES:4,PRIMITIVE_TRISTRIP:5,PRIMITIVE_TRIFAN:6,SEMANTIC_POSITION:"POSITION",SEMANTIC_NORMAL:"NORMAL",SEMANTIC_COLOR:"COLOR",SEMANTIC_TEXCOORD:"TEXCOORD",SEMANTIC_TEXCOORD0:"TEXCOORD0",SEMANTIC_TEXCOORD1:"TEXCOORD1",SEMANTIC_ATTR0:"ATTR0",SEMANTIC_ATTR1:"ATTR1",SEMANTIC_ATTR2:"ATTR2",SEMANTIC_ATTR3:"ATTR3",TEXTURELOCK_READ:1,TEXTURELOCK_WRITE:2,drawQuadWithShader:bo,programlib:$E,shaderChunks:Bo,ContextCreationError:YE,Device:Kl,IndexBuffer:nc,ProgramLibrary:$l,RenderTarget:Jl,ScopeId:nh,Shader:Oo,ShaderInput:Pc,Texture:fh,UnsupportedBrowserError:jE,VertexBuffer:fo,VertexFormat:go,VertexIterator:vc},ZE={createFullscreenQuad:Sc,drawFullscreenQuad:wc,PostEffect:bc,PostEffectQueue:bP};Object.defineProperty(Bo,"transformSkinnedVS",{get:function(){return"#define SKIN\n"+Bo.transformVS}});const QE={"ambientPrefilteredCube.frag":"ambientEnv.frag","ambientPrefilteredCubeLod.frag":"ambientEnv.frag","dpAtlasQuad.frag":null,"genParaboloid.frag":null,"prefilterCubemap.frag":null,"reflectionDpAtlas.frag":"reflectionEnv.frag","reflectionPrefilteredCube.frag":"reflectionEnv.frag","reflectionPrefilteredCubeLod.frag":"reflectionEnv.frag"};Object.keys(QE).forEach((e=>{Object.defineProperty(Bo,e,{get:function(){return null},set:function(){}})})),Object.defineProperties(Jl.prototype,{_glFrameBuffer:{get:function(){return this.impl._glFrameBuffer},set:function(e){}}}),go.prototype.update=function(){},Object.defineProperties(fh.prototype,{rgbm:{get:function(){return"rgbm"===this.type},set:function(e){this.type=e?"rgbm":"default"}},swizzleGGGR:{get:function(){return"swizzleGGGR"===this.type},set:function(e){this.type=e?"swizzleGGGR":"default"}},_glTexture:{get:function(){return this.impl._glTexture}}});const JE=zl,eR={partitionSkin:dv,procedural:{calculateTangents:qc,createMesh:jc,createTorus:Yc,createCylinder:Kc,createCapsule:Zc,createCone:Qc,createSphere:Jc,createPlane:ed,createBox:td},BasicMaterial:nd,Command:vd,ForwardRenderer:Vu,GraphNode:kh,Material:Al,Mesh:Wc,MeshInstance:xd,Model:rf,ParticleEmitter:s_,PhongMaterial:zl,Picker:a_,Projection:{ORTHOGRAPHIC:1,PERSPECTIVE:0},Scene:Ip,Skin:r_,SkinInstance:hd};function tR(e,t){Object.defineProperty(zl.prototype,t,{get:function(){return this[e]},set:function(t){this[e]=t}})}Object.defineProperty(Ip.prototype,"defaultMaterial",{get:function(){return Tl(zc().graphicsDevice)}}),["128","64","32","16","8","4"].forEach(((e,t)=>{Object.defineProperty(Ip.prototype,`skyboxPrefiltered${e}`,{get:function(){return this._prefilteredCubemaps[t]},set:function(e){this._prefilteredCubemaps[t]=e,this.updateShaders=!0}})})),Object.defineProperty(Ip.prototype,"models",{get:function(){return this._models||(this._models=[]),this._models}}),Ip.prototype._updateSkybox=function(e){this._updateSky(e)},Ip.prototype.addModel=function(e){if(this.containsModel(e))return;const t=this.layers.getLayerById(0);t&&(t.addMeshInstances(e.meshInstances),this.models.push(e))},Ip.prototype.addShadowCaster=function(e){const t=this.layers.getLayerById(0);t&&t.addShadowCasters(e.meshInstances)},Ip.prototype.removeModel=function(e){const t=this.models.indexOf(e);if(-1!==t){const s=this.layers.getLayerById(0);if(!s)return;s.removeMeshInstances(e.meshInstances),this.models.splice(t,1)}},Ip.prototype.removeShadowCasters=function(e){const t=this.layers.getLayerById(0);t&&t.removeShadowCasters(e.meshInstances)},Ip.prototype.containsModel=function(e){return this.models.indexOf(e)>=0},Ip.prototype.getModels=function(e){return this.models},Object.defineProperty(ad.prototype,"model",{get:function(){return null}}),Vu.prototype.renderComposition=function(e){zc().renderComposition(e)},Vu.prototype.updateShader=function(e,t,s,i,n){const a=e.material._scene||zc().scene;return e.updatePassShader(a,i,s,n)},xd.prototype.syncAabb=function(){},nf.prototype.getTarget=function(e){return this.targets[e]},kh.prototype._dirtify=function(e){e?this._dirtifyLocal():this._dirtifyWorld()},kh.prototype.addLabel=function(e){this._labels[e]=!0},kh.prototype.getLabels=function(){return Object.keys(this._labels)},kh.prototype.hasLabel=function(e){return!!this._labels[e]},kh.prototype.removeLabel=function(e){delete this._labels[e]},kh.prototype.findByLabel=function(e,t=[]){this.hasLabel(e)&&t.push(this);for(let s=0;s<this._children.length;++s)t=this._children[s].findByLabel(e,t);return t},kh.prototype.getChildren=function(){return this.children},kh.prototype.getName=function(){return this.name},kh.prototype.getPath=function(){return this.path},kh.prototype.getRoot=function(){return this.root},kh.prototype.getParent=function(){return this.parent},kh.prototype.setName=function(e){this.name=e},Al.prototype.getName=function(){return this.name},Al.prototype.setName=function(e){this.name=e},Al.prototype.getShader=function(){return this.shader},Al.prototype.setShader=function(e){this.shader=e},tR("diffuseTint","diffuseMapTint"),tR("specularTint","specularMapTint"),tR("emissiveTint","emissiveMapTint"),tR("aoVertexColor","aoMapVertexColor"),tR("diffuseVertexColor","diffuseMapVertexColor"),tR("specularVertexColor","specularMapVertexColor"),tR("emissiveVertexColor","emissiveMapVertexColor"),tR("metalnessVertexColor","metalnessMapVertexColor"),tR("glossVertexColor","glossMapVertexColor"),tR("opacityVertexColor","opacityMapVertexColor"),tR("lightVertexColor","lightMapVertexColor");const sR={Animation:m_,Key:u_,Node:p_,Skeleton:__};m_.prototype.getDuration=function(){return this.duration},m_.prototype.getName=function(){return this.name},m_.prototype.getNodes=function(){return this.nodes},m_.prototype.setDuration=function(e){this.duration=e},m_.prototype.setName=function(e){this.name=e},__.prototype.getAnimation=function(){return this.animation},__.prototype.getCurrentTime=function(){return this.currentTime},__.prototype.getLooping=function(){return this.looping},__.prototype.getNumNodes=function(){return this.numNodes},__.prototype.setAnimation=function(e){this.animation=e},__.prototype.setCurrentTime=function(e){this.currentTime=e},__.prototype.setLooping=function(e){this.looping=e};const iR={AudioManager:Cg,Channel:Sg,Channel3d:wg,Listener:Tg,Sound:Ag};Cg.prototype.getListener=function(){return this.listener},Cg.prototype.getVolume=function(){return this.volume},Cg.prototype.setVolume=function(e){this.volume=e};const nR={ASSET_ANIMATION:"animation",ASSET_AUDIO:"audio",ASSET_IMAGE:"image",ASSET_JSON:"json",ASSET_MODEL:"model",ASSET_MATERIAL:"material",ASSET_TEXT:"text",ASSET_TEXTURE:"texture",ASSET_CUBEMAP:"cubemap",ASSET_SCRIPT:"script"};ym.prototype.getAssetById=function(e){return this.get(e)},Object.defineProperty(vE.prototype,"ray",{get:function(){return this._rayLocal}}),Object.defineProperty(vE.prototype,"position",{get:function(){return this._localPosition}}),Object.defineProperty(vE.prototype,"rotation",{get:function(){return this._localRotation}});const aR={getTouchTargetCoords:Ow,Controller:KS,GamePads:Dw,Keyboard:qS,KeyboardEvent:NS,Mouse:$S,MouseEvent:YS,Touch:Fw,TouchDevice:Bw,TouchEvent:kw};Object.defineProperty(Rw.prototype,"wheel",{get:function(){return-2*this.wheelDelta}}),Object.defineProperty(YS.prototype,"wheel",{get:function(){return-2*this.wheelDelta}});const rR="static",oR="dynamic",hR="kinematic",lR=1,cR=2,dR=4,uR=1,pR=2,mR=3,fR=4,_R=5,gR={Application:OE,Component:Tm,ComponentSystem:Uw,Entity:$m,FillMode:{NONE:"NONE",FILL_WINDOW:"FILL_WINDOW",KEEP_ASPECT:"KEEP_ASPECT"},ResolutionMode:{AUTO:"AUTO",FIXED:"FIXED"}};function yR(e,t,s){Ug({glueUrl:e,wasmUrl:t,fallbackUrl:s,lazyInit:!0})}function vR(e){}OE.prototype.isFullscreen=function(){return!!document.fullscreenElement},OE.prototype.enableFullscreen=function(e,t,s){e=e||this.graphicsDevice.canvas;const i=function e(){t(),document.removeEventListener("fullscreenchange",e)},n=function e(){s(),document.removeEventListener("fullscreenerror",e)};t&&document.addEventListener("fullscreenchange",i,!1),s&&document.addEventListener("fullscreenerror",n,!1),e.requestFullscreen?e.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT):s()},OE.prototype.disableFullscreen=function(e){const t=function t(){e(),document.removeEventListener("fullscreenchange",t)};e&&document.addEventListener("fullscreenchange",t,!1),document.exitFullscreen()},OE.prototype.getSceneUrl=function(e){const t=this.scenes.find(e);return t?t.url:null},OE.prototype.loadScene=function(e,t){this.scenes.loadScene(e,t)},OE.prototype.loadSceneHierarchy=function(e,t){this.scenes.loadSceneHierarchy(e,t)},OE.prototype.loadSceneSettings=function(e,t){this.scenes.loadSceneSettings(e,t)},OE.prototype.renderMeshInstance=function(e,t){const s=null!=t&&t.layer?t.layer:this.scene.defaultDrawLayer;this.scene.immediate.drawMesh(null,null,null,e,s)},OE.prototype.renderMesh=function(e,t,s,i){const n=null!=i&&i.layer?i.layer:this.scene.defaultDrawLayer;this.scene.immediate.drawMesh(t,s,e,null,n)},OE.prototype._addLines=function(e,t,s){const i=s&&s.layer?s.layer:this.scene.layers.getLayerById(3),n=!s||void 0===s.depthTest||s.depthTest;this.scene.immediate.getBatch(i,n).addLines(e,t)},OE.prototype.renderLine=function(e,t,s){let i,n=s;const a=arguments[3],r=arguments[4];a instanceof pe?(n=a,i="number"==typeof r?1===r?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}:r):"number"==typeof a?(n=s,i=1===a?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}):a&&(i=a),this._addLines([e,t],[s,n],i)},OE.prototype.renderLines=function(e,t,s){s?"number"==typeof s&&(s=1===s?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}):s={layer:this.scene.layers.getLayerById(3),depthTest:!0};!t.length||e.length===t.length?e.length%2==0?this._addLines(e,t,s):console.error("renderLines: array length is not divisible by 2"):console.error("renderLines: position/color arrays have different lengths")},OE.prototype.enableVr=function(){},Object.defineProperty(wP.prototype,"node",{get:function(){return this.entity}}),Object.defineProperty(EP.prototype,"enable",{get:function(){return this.enabled},set:function(e){this.enabled=e}}),WC.prototype.setVisible=function(e){this.enabled=e},Object.defineProperty(WC.prototype,"aabb",{get:function(){return null},set:function(e){}}),Object.defineProperty(sA.prototype,"aabb",{get:function(){return null},set:function(e){}}),Object.defineProperty(fA.prototype,"bodyType",{get:function(){return this.type},set:function(e){this.type=e}}),fA.prototype.syncBodyToEntity=function(){this._updateDynamic()},SA.prototype.setGravity=function(){1===arguments.length?this.gravity.copy(arguments[0]):this.gravity.set(arguments[0],arguments[1],arguments[2])};export{jp as ABSOLUTE_URL,sx as ACTION_GAMEPAD,tx as ACTION_KEYBOARD,ex as ACTION_MOUSE,Pi as ADDRESS_CLAMP_TO_EDGE,Ei as ADDRESS_MIRRORED_REPEAT,Ai as ADDRESS_REPEAT,G_ as ANIM_BLEND_1D,H_ as ANIM_BLEND_2D_CARTESIAN,W_ as ANIM_BLEND_2D_DIRECTIONAL,X_ as ANIM_BLEND_DIRECT,$_ as ANIM_CONTROL_STATES,k_ as ANIM_EQUAL_TO,I_ as ANIM_GREATER_THAN,O_ as ANIM_GREATER_THAN_EQUAL_TO,E_ as ANIM_INTERRUPTION_NEXT,L_ as ANIM_INTERRUPTION_NEXT_PREV,A_ as ANIM_INTERRUPTION_NONE,P_ as ANIM_INTERRUPTION_PREV,R_ as ANIM_INTERRUPTION_PREV_NEXT,Z_ as ANIM_LAYER_ADDITIVE,K_ as ANIM_LAYER_OVERWRITE,D_ as ANIM_LESS_THAN,F_ as ANIM_LESS_THAN_EQUAL_TO,B_ as ANIM_NOT_EQUAL_TO,V_ as ANIM_PARAMETER_BOOLEAN,U_ as ANIM_PARAMETER_FLOAT,z_ as ANIM_PARAMETER_INTEGER,N_ as ANIM_PARAMETER_TRIGGER,Y_ as ANIM_STATE_ANY,j_ as ANIM_STATE_END,q_ as ANIM_STATE_START,pi as ASPECT_AUTO,mi as ASPECT_MANUAL,Yp as ASSET_ANIMATION,$p as ASSET_AUDIO,om as ASSET_CONTAINER,nm as ASSET_CSS,sm as ASSET_CUBEMAP,am as ASSET_HTML,Kp as ASSET_IMAGE,Zp as ASSET_JSON,Jp as ASSET_MATERIAL,Qp as ASSET_MODEL,rm as ASSET_SCRIPT,im as ASSET_SHADER,em as ASSET_TEXT,tm as ASSET_TEXTURE,lx as AXIS_KEY,ix as AXIS_MOUSE_X,nx as AXIS_MOUSE_Y,ax as AXIS_PAD_L_X,rx as AXIS_PAD_L_Y,ox as AXIS_PAD_R_X,hx as AXIS_PAD_R_Y,x_ as AnimBinder,T_ as AnimClip,Gg as AnimClipHandler,Qw as AnimComponent,Zw as AnimComponentLayer,tT as AnimComponentSystem,ug as AnimController,M_ as AnimCurve,C_ as AnimData,J_ as AnimEvaluator,tg as AnimEvents,w_ as AnimSnapshot,pg as AnimStateGraph,Wg as AnimStateGraphHandler,eg as AnimTarget,sg as AnimTrack,m_ as Animation,Nw as AnimationComponent,Hw as AnimationComponentSystem,Fy as AnimationHandler,Xm as AppBase,zw as AppOptions,OE as Application,um as Asset,Yv as AssetListLoader,av as AssetReference,ym as AssetRegistry,zy as AudioHandler,sT as AudioListenerComponent,aT as AudioListenerComponentSystem,rT as AudioSourceComponent,lT as AudioSourceComponentSystem,Qs as BAKE_COLOR,Js as BAKE_COLORDIR,to as BINDGROUP_MESH,eo as BINDGROUP_VIEW,Xi as BLENDEQUATION_ADD,$i as BLENDEQUATION_MAX,Yi as BLENDEQUATION_MIN,ji as BLENDEQUATION_REVERSE_SUBTRACT,qi as BLENDEQUATION_SUBTRACT,Wi as BLENDMODE_CONSTANT_ALPHA,Ni as BLENDMODE_CONSTANT_COLOR,Ui as BLENDMODE_DST_ALPHA,Oi as BLENDMODE_DST_COLOR,Li as BLENDMODE_ONE,Hi as BLENDMODE_ONE_MINUS_CONSTANT_ALPHA,Gi as BLENDMODE_ONE_MINUS_CONSTANT_COLOR,Vi as BLENDMODE_ONE_MINUS_DST_ALPHA,Fi as BLENDMODE_ONE_MINUS_DST_COLOR,zi as BLENDMODE_ONE_MINUS_SRC_ALPHA,Di as BLENDMODE_ONE_MINUS_SRC_COLOR,ki as BLENDMODE_SRC_ALPHA,Bi as BLENDMODE_SRC_ALPHA_SATURATE,Ii as BLENDMODE_SRC_COLOR,Ri as BLENDMODE_ZERO,ze as BLEND_ADDITIVE,We as BLEND_ADDITIVEALPHA,je as BLEND_MAX,qe as BLEND_MIN,Ge as BLEND_MULTIPLICATIVE,He as BLEND_MULTIPLICATIVE2X,Ve as BLEND_NONE,Ue as BLEND_NORMAL,Ne as BLEND_PREMULTIPLIED,Xe as BLEND_SCREEN,Be as BLEND_SUBTRACTIVE,Et as BLUR_BOX,Rt as BLUR_GAUSSIAN,BT as BODYFLAG_KINEMATIC_OBJECT,zT as BODYFLAG_NORESPONSE_OBJECT,kT as BODYFLAG_STATIC_OBJECT,XT as BODYGROUP_DEFAULT,qT as BODYGROUP_DYNAMIC,$T as BODYGROUP_ENGINE_1,ZT as BODYGROUP_ENGINE_2,QT as BODYGROUP_ENGINE_3,YT as BODYGROUP_KINEMATIC,HT as BODYGROUP_NONE,jT as BODYGROUP_STATIC,KT as BODYGROUP_TRIGGER,JT as BODYGROUP_USER_1,eM as BODYGROUP_USER_2,tM as BODYGROUP_USER_3,sM as BODYGROUP_USER_4,iM as BODYGROUP_USER_5,nM as BODYGROUP_USER_6,aM as BODYGROUP_USER_7,rM as BODYGROUP_USER_8,hM as BODYMASK_ALL,oM as BODYMASK_NONE,cM as BODYMASK_NOT_STATIC,dM as BODYMASK_NOT_STATIC_KINEMATIC,lM as BODYMASK_STATIC,UT as BODYSTATE_ACTIVE_TAG,GT as BODYSTATE_DISABLE_DEACTIVATION,WT as BODYSTATE_DISABLE_SIMULATION,VT as BODYSTATE_ISLAND_SLEEPING,NT as BODYSTATE_WANTS_DEACTIVATION,OT as BODYTYPE_DYNAMIC,FT as BODYTYPE_KINEMATIC,DT as BODYTYPE_STATIC,Zi as BUFFER_DYNAMIC,Ji as BUFFER_GPUDYNAMIC,Ki as BUFFER_STATIC,Qi as BUFFER_STREAM,uT as BUTTON_TRANSITION_MODE_SPRITE_CHANGE,dT as BUTTON_TRANSITION_MODE_TINT,nd as BasicMaterial,ad as Batch,rd as BatchGroup,Rd as BatchManager,Uy as BinaryHandler,De as BoundingBox,ke as BoundingSphere,Dp as Bundle,zp as BundleHandler,vm as BundleRegistry,CT as ButtonComponent,RT as ButtonComponentSystem,co as CHUNKAPI_1_51,uo as CHUNKAPI_1_55,po as CHUNKAPI_1_56,en as CLEARFLAG_COLOR,tn as CLEARFLAG_DEPTH,sn as CLEARFLAG_STENCIL,ui as COMPUPDATED_BLEND,di as COMPUPDATED_CAMERAS,li as COMPUPDATED_INSTANCES,ci as COMPUPDATED_LIGHTS,an as CUBEFACE_NEGX,on as CUBEFACE_NEGY,ln as CUBEFACE_NEGZ,nn as CUBEFACE_POSX,rn as CUBEFACE_POSY,hn as CUBEFACE_POSZ,Yt as CUBEPROJ_BOX,jt as CUBEPROJ_NONE,dn as CULLFACE_BACK,un as CULLFACE_FRONT,pn as CULLFACE_FRONTANDBACK,cn as CULLFACE_NONE,ce as CURVE_CARDINAL,le as CURVE_CATMULL,oe as CURVE_LINEAR,he as CURVE_SMOOTHSTEP,de as CURVE_SPLINE,ue as CURVE_STEP,xh as Camera,wP as CameraComponent,CP as CameraComponentSystem,gg as CanvasFont,LT as CollisionComponent,EM as CollisionComponentSystem,pe as Color,vd as Command,Tm as Component,Uw as ComponentSystem,Lm as ComponentSystemRegistry,vA as ContactPoint,xA as ContactResult,Ny as ContainerHandler,Vy as ContainerResource,YE as ContextCreationError,KS as Controller,Gy as CssHandler,Hy as CubemapHandler,fe as Curve,_e as CurveSet,Qt as DETAILMODE_ADD,ss as DETAILMODE_MAX,ts as DETAILMODE_MIN,Zt as DETAILMODE_MUL,es as DETAILMODE_OVERLAY,Jt as DETAILMODE_SCREEN,$r as DEVICETYPE_WEBGL,Kr as DEVICETYPE_WEBGPU,xg as DISTANCE_EXPONENTIAL,vg as DISTANCE_INVERSE,yg as DISTANCE_LINEAR,ig as DefaultAnimBinder,qE as ELEMENTTYPE_FLOAT32,pT as ELEMENTTYPE_GROUP,mT as ELEMENTTYPE_IMAGE,GE as ELEMENTTYPE_INT16,HE as ELEMENTTYPE_INT32,VE as ELEMENTTYPE_INT8,fT as ELEMENTTYPE_TEXT,WE as ELEMENTTYPE_UINT16,XE as ELEMENTTYPE_UINT32,NE as ELEMENTTYPE_UINT8,Bt as EMITTERSHAPE_BOX,zt as EMITTERSHAPE_SPHERE,cx as EVENT_KEYDOWN,dx as EVENT_KEYUP,ux as EVENT_MOUSEDOWN,px as EVENT_MOUSEMOVE,mx as EVENT_MOUSEUP,fx as EVENT_MOUSEWHEEL,xx as EVENT_SELECT,Sx as EVENT_SELECTEND,bx as EVENT_SELECTSTART,vx as EVENT_TOUCHCANCEL,gx as EVENT_TOUCHEND,yx as EVENT_TOUCHMOVE,_x as EVENT_TOUCHSTART,aC as ElementComponent,lC as ElementComponentSystem,GA as ElementDragHelper,Rw as ElementInput,Cw as ElementInputEvent,Aw as ElementMouseEvent,Ew as ElementSelectEvent,Pw as ElementTouchEvent,$m as Entity,cT as EntityReference,Sl as EnvLighting,C as EventHandler,Um as FILLMODE_FILL_WINDOW,Vm as FILLMODE_KEEP_ASPECT,zm as FILLMODE_NONE,fn as FILTER_LINEAR,vn as FILTER_LINEAR_MIPMAP_LINEAR,yn as FILTER_LINEAR_MIPMAP_NEAREST,mn as FILTER_NEAREST,gn as FILTER_NEAREST_MIPMAP_LINEAR,_n as FILTER_NEAREST_MIPMAP_NEAREST,gT as FITMODE_CONTAIN,yT as FITMODE_COVER,_T as FITMODE_STRETCH,CC as FITTING_BOTH,wC as FITTING_NONE,MC as FITTING_SHRINK,TC as FITTING_STRETCH,Ke as FOG_EXP,Ze as FOG_EXP2,$e as FOG_LINEAR,Ye as FOG_NONE,fg as FONT_BITMAP,mg as FONT_MSDF,Qe as FRESNEL_NONE,Je as FRESNEL_SCHLICK,An as FUNC_ALWAYS,Sn as FUNC_EQUAL,Tn as FUNC_GREATER,Cn as FUNC_GREATEREQUAL,bn as FUNC_LESS,wn as FUNC_LESSEQUAL,xn as FUNC_NEVER,Mn as FUNC_NOTEQUAL,Xy as FolderHandler,_g as Font,jy as FontHandler,Vu as ForwardRenderer,yi as Frustum,is as GAMMA_NONE,ns as GAMMA_SRGB,as as GAMMA_SRGBFAST,rs as GAMMA_SRGBHDR,Dw as GamePads,kh as GraphNode,Kl as GraphicsDevice,ev as HierarchyHandler,tv as HtmlHandler,ae as Http,Rm as I18n,En as INDEXFORMAT_UINT16,Rn as INDEXFORMAT_UINT32,Pn as INDEXFORMAT_UINT8,v_ as INTERPOLATION_CUBIC,y_ as INTERPOLATION_LINEAR,g_ as INTERPOLATION_STEP,LM as ImageElement,nc as IndexBuffer,q as IndexedList,mC as JointComponent,yC as JointComponentSystem,sv as JsonHandler,nv as JsonStandardMaterialParser,Xx as KEY_0,qx as KEY_1,jx as KEY_2,Yx as KEY_3,$x as KEY_4,Kx as KEY_5,Zx as KEY_6,Qx as KEY_7,Jx as KEY_8,eb as KEY_9,ib as KEY_A,Gb as KEY_ADD,Ex as KEY_ALT,nb as KEY_B,wx as KEY_BACKSPACE,lS as KEY_BACK_SLASH,ab as KEY_C,Lx as KEY_CAPS_LOCK,cS as KEY_CLOSE_BRACKET,aS as KEY_COMMA,Rb as KEY_CONTEXT_MENU,Px as KEY_CONTROL,rb as KEY_D,Xb as KEY_DECIMAL,Hx as KEY_DELETE,qb as KEY_DIVIDE,Nx as KEY_DOWN,ob as KEY_E,kx as KEY_END,Cx as KEY_ENTER,sb as KEY_EQUAL,Ix as KEY_ESCAPE,hb as KEY_F,jb as KEY_F1,sS as KEY_F10,iS as KEY_F11,nS as KEY_F12,Yb as KEY_F2,$b as KEY_F3,Kb as KEY_F4,Zb as KEY_F5,Qb as KEY_F6,Jb as KEY_F7,eS as KEY_F8,tS as KEY_F9,lb as KEY_G,cb as KEY_H,Bx as KEY_HOME,db as KEY_I,Wx as KEY_INSERT,ub as KEY_J,pb as KEY_K,mb as KEY_L,zx as KEY_LEFT,fb as KEY_M,dS as KEY_META,Nb as KEY_MULTIPLY,_b as KEY_N,Lb as KEY_NUMPAD_0,Ib as KEY_NUMPAD_1,Db as KEY_NUMPAD_2,Ob as KEY_NUMPAD_3,Fb as KEY_NUMPAD_4,kb as KEY_NUMPAD_5,Bb as KEY_NUMPAD_6,zb as KEY_NUMPAD_7,Ub as KEY_NUMPAD_8,Vb as KEY_NUMPAD_9,gb as KEY_O,hS as KEY_OPEN_BRACKET,yb as KEY_P,Fx as KEY_PAGE_DOWN,Ox as KEY_PAGE_UP,Rx as KEY_PAUSE,rS as KEY_PERIOD,Gx as KEY_PRINT_SCREEN,vb as KEY_Q,xb as KEY_R,Mx as KEY_RETURN,Vx as KEY_RIGHT,bb as KEY_S,tb as KEY_SEMICOLON,Wb as KEY_SEPARATOR,Ax as KEY_SHIFT,oS as KEY_SLASH,Dx as KEY_SPACE,Hb as KEY_SUBTRACT,Sb as KEY_T,Tx as KEY_TAB,wb as KEY_U,Ux as KEY_UP,Tb as KEY_V,Mb as KEY_W,Eb as KEY_WINDOWS,Cb as KEY_X,Ab as KEY_Y,Pb as KEY_Z,u_ as Key,qS as Keyboard,NS as KeyboardEvent,at as LAYERID_DEPTH,ot as LAYERID_IMMEDIATE,rt as LAYERID_SKYBOX,ht as LAYERID_UI,nt as LAYERID_WORLD,st as LAYER_FX,tt as LAYER_GIZMO,et as LAYER_HUD,it as LAYER_WORLD,vt as LIGHTFALLOFF_INVERSESQUARED,yt as LIGHTFALLOFF_LINEAR,_t as LIGHTSHAPE_DISK,mt as LIGHTSHAPE_PUNCTUAL,ft as LIGHTSHAPE_RECT,gt as LIGHTSHAPE_SPHERE,pt as LIGHTTYPE_COUNT,lt as LIGHTTYPE_DIRECTIONAL,ct as LIGHTTYPE_OMNI,dt as LIGHTTYPE_POINT,ut as LIGHTTYPE_SPOT,Ls as LINEBATCH_GIZMO,Rs as LINEBATCH_OVERLAY,Es as LINEBATCH_WORLD,Ku as Layer,np as LayerComposition,kC as LayoutCalculator,vC as LayoutChildComponent,SC as LayoutChildComponentSystem,UC as LayoutGroupComponent,GC as LayoutGroupComponentSystem,pp as Light,EP as LightComponent,DP as LightComponentSystem,mp as LightingParams,sf as Lightmapper,$v as LocalizedAsset,Bs as MASK_AFFECT_DYNAMIC,zs as MASK_AFFECT_LIGHTMAPPED,Us as MASK_BAKE,cC as MOTION_FREE,dC as MOTION_LIMITED,uC as MOTION_LOCKED,pS as MOUSEBUTTON_LEFT,mS as MOUSEBUTTON_MIDDLE,uS as MOUSEBUTTON_NONE,fS as MOUSEBUTTON_RIGHT,ye as Mat3,Ce as Mat4,Al as Material,ov as MaterialHandler,Wc as Mesh,xd as MeshInstance,rf as Model,WC as ModelComponent,qC as ModelComponentSystem,fv as ModelHandler,nf as Morph,af as MorphInstance,of as MorphTarget,$S as Mouse,YS as MouseEvent,p_ as Node,fi as ORIENTATION_HORIZONTAL,_i as ORIENTATION_VERTICAL,Ti as OrientedBox,_S as PAD_1,gS as PAD_2,yS as PAD_3,vS as PAD_4,DS as PAD_DOWN,xS as PAD_FACE_1,bS as PAD_FACE_2,SS as PAD_FACE_3,wS as PAD_FACE_4,OS as PAD_LEFT,TS as PAD_L_SHOULDER_1,CS as PAD_L_SHOULDER_2,RS as PAD_L_STICK_BUTTON,BS as PAD_L_STICK_X,zS as PAD_L_STICK_Y,FS as PAD_RIGHT,MS as PAD_R_SHOULDER_1,AS as PAD_R_SHOULDER_2,LS as PAD_R_STICK_BUTTON,US as PAD_R_STICK_X,VS as PAD_R_STICK_Y,PS as PAD_SELECT,ES as PAD_START,IS as PAD_UP,kS as PAD_VENDOR,kt as PARTICLEMODE_CPU,Ft as PARTICLEMODE_GPU,Nt as PARTICLEORIENTATION_EMITTER,Ut as PARTICLEORIENTATION_SCREEN,Vt as PARTICLEORIENTATION_WORLD,It as PARTICLESORT_DISTANCE,Dt as PARTICLESORT_NEWER_FIRST,Lt as PARTICLESORT_NONE,Ot as PARTICLESORT_OLDER_FIRST,$n as PIXELFORMAT_111110F,Ln as PIXELFORMAT_A8,aa as PIXELFORMAT_ASTC_4x4,ra as PIXELFORMAT_ATC_RGB,oa as PIXELFORMAT_ATC_RGBA,jn as PIXELFORMAT_DEPTH,Yn as PIXELFORMAT_DEPTHSTENCIL,Un as PIXELFORMAT_DXT1,Vn as PIXELFORMAT_DXT3,Nn as PIXELFORMAT_DXT5,Qn as PIXELFORMAT_ETC1,Jn as PIXELFORMAT_ETC2_RGB,ea as PIXELFORMAT_ETC2_RGBA,In as PIXELFORMAT_L8,Dn as PIXELFORMAT_L8_A8,sa as PIXELFORMAT_PVRTC_2BPP_RGBA_1,ta as PIXELFORMAT_PVRTC_2BPP_RGB_1,na as PIXELFORMAT_PVRTC_4BPP_RGBA_1,ia as PIXELFORMAT_PVRTC_4BPP_RGB_1,qn as PIXELFORMAT_R32F,kn as PIXELFORMAT_R4_G4_B4_A4,Fn as PIXELFORMAT_R5_G5_B5_A1,On as PIXELFORMAT_R5_G6_B5,Bn as PIXELFORMAT_R8_G8_B8,zn as PIXELFORMAT_R8_G8_B8_A8,Gn as PIXELFORMAT_RGB16F,Hn as PIXELFORMAT_RGB32F,Wn as PIXELFORMAT_RGBA16F,Xn as PIXELFORMAT_RGBA32F,Kn as PIXELFORMAT_SRGB,Zn as PIXELFORMAT_SRGBA,ca as PRIMITIVE_LINELOOP,la as PRIMITIVE_LINES,da as PRIMITIVE_LINESTRIP,ha as PRIMITIVE_POINTS,ua as PRIMITIVE_TRIANGLES,ma as PRIMITIVE_TRIFAN,pa as PRIMITIVE_TRISTRIP,Wt as PROJECTION_ORTHOGRAPHIC,Gt as PROJECTION_PERSPECTIVE,s_ as ParticleEmitter,QC as ParticleSystemComponent,tA as ParticleSystemComponentSystem,JE as PhongMaterial,a_ as Picker,Ci as Plane,bc as PostEffect,bP as PostEffectQueue,$l as ProgramLibrary,Ae as Quat,qt as RENDERSTYLE_POINTS,Ht as RENDERSTYLE_SOLID,Xt as RENDERSTYLE_WIREFRAME,Nm as RESOLUTION_AUTO,Gm as RESOLUTION_FIXED,uR as RIGIDBODY_ACTIVE_TAG,cR as RIGIDBODY_CF_KINEMATIC_OBJECT,dR as RIGIDBODY_CF_NORESPONSE_OBJECT,lR as RIGIDBODY_CF_STATIC_OBJECT,fR as RIGIDBODY_DISABLE_DEACTIVATION,_R as RIGIDBODY_DISABLE_SIMULATION,pR as RIGIDBODY_ISLAND_SLEEPING,oR as RIGIDBODY_TYPE_DYNAMIC,hR as RIGIDBODY_TYPE_KINEMATIC,rR as RIGIDBODY_TYPE_STATIC,mR as RIGIDBODY_WANTS_DEACTIVATION,vi as Ray,gA as RaycastResult,$ as ReadStream,sA as RenderComponent,rA as RenderComponentSystem,vv as RenderHandler,Jl as RenderTarget,xv as ResourceHandler,Up as ResourceLoader,fA as RigidBodyComponent,SA as RigidBodyComponentSystem,TA as SCALEMODE_BLEND,wA as SCALEMODE_NONE,qA as SCROLLBAR_VISIBILITY_SHOW_ALWAYS,jA as SCROLLBAR_VISIBILITY_SHOW_WHEN_REQUIRED,HA as SCROLL_MODE_BOUNCE,WA as SCROLL_MODE_CLAMP,XA as SCROLL_MODE_INFINITE,Ra as SEMANTIC_ATTR,La as SEMANTIC_ATTR0,Ia as SEMANTIC_ATTR1,Na as SEMANTIC_ATTR10,Ga as SEMANTIC_ATTR11,Wa as SEMANTIC_ATTR12,Ha as SEMANTIC_ATTR13,Xa as SEMANTIC_ATTR14,qa as SEMANTIC_ATTR15,Da as SEMANTIC_ATTR2,Oa as SEMANTIC_ATTR3,Fa as SEMANTIC_ATTR4,ka as SEMANTIC_ATTR5,Ba as SEMANTIC_ATTR6,za as SEMANTIC_ATTR7,Ua as SEMANTIC_ATTR8,Va as SEMANTIC_ATTR9,va as SEMANTIC_BLENDINDICES,ya as SEMANTIC_BLENDWEIGHT,xa as SEMANTIC_COLOR,_a as SEMANTIC_NORMAL,fa as SEMANTIC_POSITION,ga as SEMANTIC_TANGENT,ba as SEMANTIC_TEXCOORD,Sa as SEMANTIC_TEXCOORD0,wa as SEMANTIC_TEXCOORD1,Ta as SEMANTIC_TEXCOORD2,Ma as SEMANTIC_TEXCOORD3,Ca as SEMANTIC_TEXCOORD4,Aa as SEMANTIC_TEXCOORD5,Pa as SEMANTIC_TEXCOORD6,Ea as SEMANTIC_TEXCOORD7,Ss as SHADERDEF_DIRLM,xs as SHADERDEF_INSTANCING,bs as SHADERDEF_LM,Ps as SHADERDEF_LMAMBIENT,Cs as SHADERDEF_MORPH_NORMAL,Ms as SHADERDEF_MORPH_POSITION,As as SHADERDEF_MORPH_TEXTURE_BASED,fs as SHADERDEF_NOSHADOW,ws as SHADERDEF_SCREENSPACE,_s as SHADERDEF_SKIN,Ts as SHADERDEF_TANGENTS,gs as SHADERDEF_UV0,ys as SHADERDEF_UV1,vs as SHADERDEF_VCOLOR,Jr as SHADERSTAGE_COMPUTE,Qr as SHADERSTAGE_FRAGMENT,Zr as SHADERSTAGE_VERTEX,ja as SHADERTAG_MATERIAL,qs as SHADERTYPE_DEPTH,Xs as SHADERTYPE_FORWARD,js as SHADERTYPE_PICK,Ys as SHADERTYPE_SHADOW,Gs as SHADER_DEPTH,Vs as SHADER_FORWARD,Ns as SHADER_FORWARDHDR,Ws as SHADER_PICK,Hs as SHADER_SHADOW,Is as SHADOWUPDATE_NONE,Os as SHADOWUPDATE_REALTIME,Ds as SHADOWUPDATE_THISFRAME,At as SHADOW_COUNT,bt as SHADOW_DEPTH,Ct as SHADOW_PCF1,xt as SHADOW_PCF3,Mt as SHADOW_PCF5,wt as SHADOW_VSM16,Tt as SHADOW_VSM32,St as SHADOW_VSM8,ks as SORTKEY_DEPTH,Fs as SORTKEY_FORWARD,ri as SORTMODE_BACK2FRONT,hi as SORTMODE_CUSTOM,oi as SORTMODE_FRONT2BACK,ni as SORTMODE_MANUAL,ai as SORTMODE_MATERIALMESH,ii as SORTMODE_NONE,ps as SPECOCC_AO,ms as SPECOCC_GLOSSDEPENDENT,us as SPECOCC_NONE,Kt as SPECULAR_BLINN,$t as SPECULAR_PHONG,cP as SPRITETYPE_ANIMATED,lP as SPRITETYPE_SIMPLE,$s as SPRITE_RENDERMODE_SIMPLE,Ks as SPRITE_RENDERMODE_SLICED,Zs as SPRITE_RENDERMODE_TILED,Ja as STENCILOP_DECREMENT,er as STENCILOP_DECREMENTWRAP,Za as STENCILOP_INCREMENT,Qa as STENCILOP_INCREMENTWRAP,tr as STENCILOP_INVERT,Ya as STENCILOP_KEEP,Ka as STENCILOP_REPLACE,$a as STENCILOP_ZERO,Ip as Scene,bv as SceneHandler,Om as SceneRegistry,Dm as SceneRegistryItem,Sv as SceneSettingsHandler,nh as ScopeId,ah as ScopeSpace,CA as ScreenComponent,EA as ScreenComponentSystem,wm as ScriptAttributes,Mm as ScriptComponent,kP as ScriptComponentSystem,mm as ScriptHandler,RA as ScriptLegacyComponent,DA as ScriptLegacyComponentSystem,Pm as ScriptRegistry,Am as ScriptType,$A as ScrollViewComponent,QA as ScrollViewComponentSystem,JA as ScrollbarComponent,sP as ScrollbarComponentSystem,Oo as Shader,wv as ShaderHandler,yA as SingleContactResult,__ as Skeleton,r_ as Skin,ld as SkinBatchInstance,hd as SkinInstance,K as SortedLoopArray,Ag as Sound,aP as SoundComponent,hP as SoundComponentSystem,Eg as SoundInstance,Rg as SoundInstance3d,Cg as SoundManager,nP as SoundSlot,l_ as Sprite,dP as SpriteAnimationClip,uP as SpriteComponent,fP as SpriteComponentSystem,Cv as SpriteHandler,zl as StandardMaterial,c_ as StencilParameters,dr as TEXHINT_ASSET,ur as TEXHINT_LIGHTMAP,lr as TEXHINT_NONE,cr as TEXHINT_SHADOWMAP,sr as TEXTURELOCK_READ,ir as TEXTURELOCK_WRITE,mr as TEXTUREPROJECTION_CUBE,fr as TEXTUREPROJECTION_EQUIRECT,pr as TEXTUREPROJECTION_NONE,_r as TEXTUREPROJECTION_OCTAHEDRAL,nr as TEXTURETYPE_DEFAULT,rr as TEXTURETYPE_RGBE,ar as TEXTURETYPE_RGBM,or as TEXTURETYPE_RGBP,hr as TEXTURETYPE_SWIZZLEGGGR,cs as TONEMAP_ACES,ds as TONEMAP_ACES2,hs as TONEMAP_FILMIC,ls as TONEMAP_HEJL,os as TONEMAP_LINEAR,l as TRACEID_RENDER_ACTION,r as TRACEID_RENDER_FRAME,o as TRACEID_RENDER_PASS,h as TRACEID_RENDER_PASS_DETAIL,c as TRACEID_RENDER_TARGET_ALLOC,u as TRACEID_SHADER_ALLOC,d as TRACEID_TEXTURE_ALLOC,f as TRACEID_VRAM_IB,p as TRACEID_VRAM_TEXTURE,m as TRACEID_VRAM_VB,wr as TYPE_FLOAT32,vr as TYPE_INT16,br as TYPE_INT32,gr as TYPE_INT8,xr as TYPE_UINT16,Sr as TYPE_UINT32,yr as TYPE_UINT8,Z as Tags,Av as Template,Pv as TemplateHandler,KM as TextElement,Ev as TextHandler,fh as Texture,d_ as TextureAtlas,jv as TextureAtlasHandler,Wv as TextureHandler,Gv as TextureParser,J as Timer,Fw as Touch,Bw as TouchDevice,kw as TouchEvent,ie as Tracing,Tc as TransformFeedback,Tr as UNIFORMTYPE_BOOL,Dr as UNIFORMTYPE_BVEC2,Or as UNIFORMTYPE_BVEC3,Fr as UNIFORMTYPE_BVEC4,Cr as UNIFORMTYPE_FLOAT,Nr as UNIFORMTYPE_FLOATARRAY,Mr as UNIFORMTYPE_INT,Rr as UNIFORMTYPE_IVEC2,Lr as UNIFORMTYPE_IVEC3,Ir as UNIFORMTYPE_IVEC4,kr as UNIFORMTYPE_MAT2,Br as UNIFORMTYPE_MAT3,zr as UNIFORMTYPE_MAT4,Ur as UNIFORMTYPE_TEXTURE2D,Gr as UNIFORMTYPE_TEXTURE2D_SHADOW,Hr as UNIFORMTYPE_TEXTURE3D,Vr as UNIFORMTYPE_TEXTURECUBE,Wr as UNIFORMTYPE_TEXTURECUBE_SHADOW,Ar as UNIFORMTYPE_VEC2,Xr as UNIFORMTYPE_VEC2ARRAY,Pr as UNIFORMTYPE_VEC3,qr as UNIFORMTYPE_VEC3ARRAY,Er as UNIFORMTYPE_VEC4,jr as UNIFORMTYPE_VEC4ARRAY,so as UNIFORM_BUFFER_DEFAULT_SLOT_NAME,se as URI,jE as UnsupportedBrowserError,ei as VIEW_CENTER,ti as VIEW_LEFT,si as VIEW_RIGHT,ve as Vec2,ge as Vec3,xe as Vec4,fo as VertexBuffer,go as VertexFormat,vc as VertexIterator,Y as WasmModule,Fc as WebglGraphicsDevice,kd as WorldClusters,iE as XRDEPTHSENSINGFORMAT_F32,sE as XRDEPTHSENSINGFORMAT_L8A8,eE as XRDEPTHSENSINGUSAGE_CPU,tE as XRDEPTHSENSINGUSAGE_GPU,$P as XRHAND_LEFT,YP as XRHAND_NONE,KP as XRHAND_RIGHT,WP as XRSPACE_BOUNDEDFLOOR,NP as XRSPACE_LOCAL,GP as XRSPACE_LOCALFLOOR,HP as XRSPACE_UNBOUNDED,VP as XRSPACE_VIEWER,XP as XRTARGETRAY_GAZE,jP as XRTARGETRAY_POINTER,qP as XRTARGETRAY_SCREEN,JP as XRTRACKABLE_MESH,QP as XRTRACKABLE_PLANE,ZP as XRTRACKABLE_POINT,UP as XRTYPE_AR,BP as XRTYPE_INLINE,zP as XRTYPE_VR,EE as XrDepthSensing,PE as XrDomOverlay,oE as XrHitTest,rE as XrHitTestSource,AE as XrImageTracking,xE as XrInput,vE as XrInputSource,ME as XrLightEstimation,DE as XrManager,LE as XrPlane,IE as XrPlaneDetection,CE as XrTrackedImage,_P as ZoneComponent,vP as ZoneComponentSystem,sR as anim,Hm as app,x as apps,nR as asset,iR as audio,Ug as basisInitialize,yR as basisSetDownloadConfig,Ng as basisTranscode,io as bindGroupNames,Xc as calculateNormals,qc as calculateTangents,v as common,y as config,td as createBox,Zc as createCapsule,Qc as createCone,Kc as createCylinder,jc as createMesh,ed as createPlane,Zv as createScript,Jo as createShader,eh as createShaderFromCode,Jc as createSphere,Wy as createStyle,Yc as createTorus,ee as createURI,b as data,wc as drawFullscreenQuad,bo as drawQuadWithShader,So as drawTexture,A as events,T as extend,gR as fw,Ow as getTouchTargetCoords,KE as gfx,P as guid,re as http,BE as inherits,aR as input,M as isDefined,FE as log,zE as makeArray,ne as math,Q as now,E as path,N as platform,ZE as posteffect,vR as prefilterCubemap,$E as programlib,Jv as registerScript,xl as reprojectTexture,g as revision,eR as scene,gm as script,lo as semanticToLocation,sc as shFromCubemap,Bo as shaderChunks,Pt as shadowTypeToString,UE as shape,X as string,kE as time,w as type,oo as typedArrayIndexFormats,ho as typedArrayIndexFormatsByteSize,ro as typedArrayToType,no as typedArrayTypes,ao as typedArrayTypesByteSize,Yr as uniformTypeToName,_ as version};
