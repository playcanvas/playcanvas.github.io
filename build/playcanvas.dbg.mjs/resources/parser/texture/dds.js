/**
 * @license
 * PlayCanvas Engine v1.57.1 revision 256dd83c2 (DEBUG PROFILER)
 * Copyright 2011-2022 PlayCanvas Ltd. All rights reserved.
 */
import { Debug } from '../../../core/debug.js';
import { Asset } from '../../../asset/asset.js';
import { Texture } from '../../../graphics/texture.js';
import { PIXELFORMAT_R8_G8_B8, TEXHINT_ASSET, ADDRESS_CLAMP_TO_EDGE, ADDRESS_REPEAT, PIXELFORMAT_DXT1, PIXELFORMAT_DXT5, PIXELFORMAT_RGBA16F, PIXELFORMAT_RGBA32F, PIXELFORMAT_ETC1, PIXELFORMAT_PVRTC_2BPP_RGB_1, PIXELFORMAT_PVRTC_2BPP_RGBA_1, PIXELFORMAT_PVRTC_4BPP_RGB_1, PIXELFORMAT_PVRTC_4BPP_RGBA_1, PIXELFORMAT_R8_G8_B8_A8 } from '../../../graphics/constants.js';

class DdsParser {
  constructor(registry) {
    this.maxRetries = 0;
  }

  load(url, callback, asset) {
    Asset.fetchArrayBuffer(url.load, callback, asset, this.maxRetries);
  }

  open(url, data, device) {
    const header = new Uint32Array(data, 0, 128 / 4);
    const width = header[4];
    const height = header[3];
    const mips = Math.max(header[7], 1);
    const isFourCc = header[20] === 4;
    const fcc = header[21];
    const bpp = header[22];
    const isCubemap = header[28] === 65024;
    const FCC_DXT1 = 827611204;
    const FCC_DXT5 = 894720068;
    const FCC_FP16 = 113;
    const FCC_FP32 = 116;
    const FCC_ETC1 = 826496069;
    const FCC_PVRTC_2BPP_RGB_1 = 825438800;
    const FCC_PVRTC_2BPP_RGBA_1 = 825504336;
    const FCC_PVRTC_4BPP_RGB_1 = 825439312;
    const FCC_PVRTC_4BPP_RGBA_1 = 825504848;
    let compressed = false;
    let etc1 = false;
    let pvrtc2 = false;
    let pvrtc4 = false;
    let format = null;
    let componentSize = 1;
    let texture;

    if (isFourCc) {
      if (fcc === FCC_DXT1) {
        format = PIXELFORMAT_DXT1;
        compressed = true;
      } else if (fcc === FCC_DXT5) {
        format = PIXELFORMAT_DXT5;
        compressed = true;
      } else if (fcc === FCC_FP16) {
        format = PIXELFORMAT_RGBA16F;
        componentSize = 2;
      } else if (fcc === FCC_FP32) {
        format = PIXELFORMAT_RGBA32F;
        componentSize = 4;
      } else if (fcc === FCC_ETC1) {
        format = PIXELFORMAT_ETC1;
        compressed = true;
        etc1 = true;
      } else if (fcc === FCC_PVRTC_2BPP_RGB_1 || fcc === FCC_PVRTC_2BPP_RGBA_1) {
        format = fcc === FCC_PVRTC_2BPP_RGB_1 ? PIXELFORMAT_PVRTC_2BPP_RGB_1 : PIXELFORMAT_PVRTC_2BPP_RGBA_1;
        compressed = true;
        pvrtc2 = true;
      } else if (fcc === FCC_PVRTC_4BPP_RGB_1 || fcc === FCC_PVRTC_4BPP_RGBA_1) {
        format = fcc === FCC_PVRTC_4BPP_RGB_1 ? PIXELFORMAT_PVRTC_4BPP_RGB_1 : PIXELFORMAT_PVRTC_4BPP_RGBA_1;
        compressed = true;
        pvrtc4 = true;
      }
    } else {
      if (bpp === 32) {
        format = PIXELFORMAT_R8_G8_B8_A8;
      }
    }

    if (!format) {
      Debug.error('This DDS pixel format is currently unsupported. Empty texture will be created instead.');
      texture = new Texture(device, {
        width: 4,
        height: 4,
        format: PIXELFORMAT_R8_G8_B8,
        name: 'dds-legacy-empty'
      });
      return texture;
    }

    texture = new Texture(device, {
      name: url,
      profilerHint: TEXHINT_ASSET,
      addressU: isCubemap ? ADDRESS_CLAMP_TO_EDGE : ADDRESS_REPEAT,
      addressV: isCubemap ? ADDRESS_CLAMP_TO_EDGE : ADDRESS_REPEAT,
      width: width,
      height: height,
      format: format,
      cubemap: isCubemap,
      mipmaps: mips > 1
    });
    let offset = 128;
    const faces = isCubemap ? 6 : 1;
    let mipSize;
    const DXT_BLOCK_WIDTH = 4;
    const DXT_BLOCK_HEIGHT = 4;
    const blockSize = fcc === FCC_DXT1 ? 8 : 16;
    let numBlocksAcross, numBlocksDown, numBlocks;

    for (let face = 0; face < faces; face++) {
      let mipWidth = width;
      let mipHeight = height;

      for (let i = 0; i < mips; i++) {
        if (compressed) {
          if (etc1) {
            mipSize = Math.floor((mipWidth + 3) / 4) * Math.floor((mipHeight + 3) / 4) * 8;
          } else if (pvrtc2) {
            mipSize = Math.max(mipWidth, 16) * Math.max(mipHeight, 8) / 4;
          } else if (pvrtc4) {
            mipSize = Math.max(mipWidth, 8) * Math.max(mipHeight, 8) / 2;
          } else {
            numBlocksAcross = Math.floor((mipWidth + DXT_BLOCK_WIDTH - 1) / DXT_BLOCK_WIDTH);
            numBlocksDown = Math.floor((mipHeight + DXT_BLOCK_HEIGHT - 1) / DXT_BLOCK_HEIGHT);
            numBlocks = numBlocksAcross * numBlocksDown;
            mipSize = numBlocks * blockSize;
          }
        } else {
          mipSize = mipWidth * mipHeight * 4;
        }

        const mipBuff = format === PIXELFORMAT_RGBA32F ? new Float32Array(data, offset, mipSize) : format === PIXELFORMAT_RGBA16F ? new Uint16Array(data, offset, mipSize) : new Uint8Array(data, offset, mipSize);

        if (!isCubemap) {
          texture._levels[i] = mipBuff;
        } else {
          if (!texture._levels[i]) texture._levels[i] = [];
          texture._levels[i][face] = mipBuff;
        }

        offset += mipSize * componentSize;
        mipWidth = Math.max(mipWidth * 0.5, 1);
        mipHeight = Math.max(mipHeight * 0.5, 1);
      }
    }

    texture.upload();
    return texture;
  }

}

export { DdsParser };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGRzLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvcmVzb3VyY2VzL3BhcnNlci90ZXh0dXJlL2Rkcy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEZWJ1ZyB9IGZyb20gJy4uLy4uLy4uL2NvcmUvZGVidWcuanMnO1xuaW1wb3J0IHsgQXNzZXQgfSBmcm9tICcuLi8uLi8uLi9hc3NldC9hc3NldC5qcyc7XG5pbXBvcnQgeyBUZXh0dXJlIH0gZnJvbSAnLi4vLi4vLi4vZ3JhcGhpY3MvdGV4dHVyZS5qcyc7XG5pbXBvcnQge1xuICAgIEFERFJFU1NfQ0xBTVBfVE9fRURHRSwgQUREUkVTU19SRVBFQVQsXG4gICAgUElYRUxGT1JNQVRfRFhUMSwgUElYRUxGT1JNQVRfRFhUNSxcbiAgICBQSVhFTEZPUk1BVF9FVEMxLFxuICAgIFBJWEVMRk9STUFUX1BWUlRDXzRCUFBfUkdCXzEsIFBJWEVMRk9STUFUX1BWUlRDXzJCUFBfUkdCXzEsIFBJWEVMRk9STUFUX1BWUlRDXzRCUFBfUkdCQV8xLCBQSVhFTEZPUk1BVF9QVlJUQ18yQlBQX1JHQkFfMSxcbiAgICBQSVhFTEZPUk1BVF9SOF9HOF9COCwgUElYRUxGT1JNQVRfUjhfRzhfQjhfQTgsXG4gICAgUElYRUxGT1JNQVRfUkdCQTE2RiwgUElYRUxGT1JNQVRfUkdCQTMyRixcbiAgICBURVhISU5UX0FTU0VUXG59IGZyb20gJy4uLy4uLy4uL2dyYXBoaWNzL2NvbnN0YW50cy5qcyc7XG5cbi8qKiBAdHlwZWRlZiB7aW1wb3J0KCcuLi8uLi90ZXh0dXJlLmpzJykuVGV4dHVyZVBhcnNlcn0gVGV4dHVyZVBhcnNlciAqL1xuXG4vKipcbiAqIExlZ2FjeSB0ZXh0dXJlIHBhcnNlciBmb3IgZGRzIGZpbGVzLlxuICpcbiAqIEBpbXBsZW1lbnRzIHtUZXh0dXJlUGFyc2VyfVxuICogQGlnbm9yZVxuICovXG5jbGFzcyBEZHNQYXJzZXIge1xuICAgIGNvbnN0cnVjdG9yKHJlZ2lzdHJ5KSB7XG4gICAgICAgIHRoaXMubWF4UmV0cmllcyA9IDA7XG4gICAgfVxuXG4gICAgbG9hZCh1cmwsIGNhbGxiYWNrLCBhc3NldCkge1xuICAgICAgICBBc3NldC5mZXRjaEFycmF5QnVmZmVyKHVybC5sb2FkLCBjYWxsYmFjaywgYXNzZXQsIHRoaXMubWF4UmV0cmllcyk7XG4gICAgfVxuXG4gICAgb3Blbih1cmwsIGRhdGEsIGRldmljZSkge1xuICAgICAgICBjb25zdCBoZWFkZXIgPSBuZXcgVWludDMyQXJyYXkoZGF0YSwgMCwgMTI4IC8gNCk7XG5cbiAgICAgICAgY29uc3Qgd2lkdGggPSBoZWFkZXJbNF07XG4gICAgICAgIGNvbnN0IGhlaWdodCA9IGhlYWRlclszXTtcbiAgICAgICAgY29uc3QgbWlwcyA9IE1hdGgubWF4KGhlYWRlcls3XSwgMSk7XG4gICAgICAgIGNvbnN0IGlzRm91ckNjID0gaGVhZGVyWzIwXSA9PT0gNDtcbiAgICAgICAgY29uc3QgZmNjID0gaGVhZGVyWzIxXTtcbiAgICAgICAgY29uc3QgYnBwID0gaGVhZGVyWzIyXTtcbiAgICAgICAgY29uc3QgaXNDdWJlbWFwID0gaGVhZGVyWzI4XSA9PT0gNjUwMjQ7IC8vIFRPRE86IGNoZWNrIGJ5IGJpdGZsYWdcblxuICAgICAgICBjb25zdCBGQ0NfRFhUMSA9IDgyNzYxMTIwNDsgLy8gRFhUMVxuICAgICAgICBjb25zdCBGQ0NfRFhUNSA9IDg5NDcyMDA2ODsgLy8gRFhUNVxuICAgICAgICBjb25zdCBGQ0NfRlAxNiA9IDExMzsgICAgICAgLy8gUkdCQTE2ZlxuICAgICAgICBjb25zdCBGQ0NfRlAzMiA9IDExNjsgICAgICAgLy8gUkdCQTMyZlxuXG4gICAgICAgIC8vIG5vbiBzdGFuZGFyZFxuICAgICAgICBjb25zdCBGQ0NfRVRDMSA9IDgyNjQ5NjA2OTtcbiAgICAgICAgY29uc3QgRkNDX1BWUlRDXzJCUFBfUkdCXzEgPSA4MjU0Mzg4MDA7XG4gICAgICAgIGNvbnN0IEZDQ19QVlJUQ18yQlBQX1JHQkFfMSA9IDgyNTUwNDMzNjtcbiAgICAgICAgY29uc3QgRkNDX1BWUlRDXzRCUFBfUkdCXzEgPSA4MjU0MzkzMTI7XG4gICAgICAgIGNvbnN0IEZDQ19QVlJUQ180QlBQX1JHQkFfMSA9IDgyNTUwNDg0ODtcblxuICAgICAgICBsZXQgY29tcHJlc3NlZCA9IGZhbHNlO1xuICAgICAgICBsZXQgZXRjMSA9IGZhbHNlO1xuICAgICAgICBsZXQgcHZydGMyID0gZmFsc2U7XG4gICAgICAgIGxldCBwdnJ0YzQgPSBmYWxzZTtcbiAgICAgICAgbGV0IGZvcm1hdCA9IG51bGw7XG4gICAgICAgIGxldCBjb21wb25lbnRTaXplID0gMTtcblxuICAgICAgICBsZXQgdGV4dHVyZTtcblxuICAgICAgICBpZiAoaXNGb3VyQ2MpIHtcbiAgICAgICAgICAgIGlmIChmY2MgPT09IEZDQ19EWFQxKSB7XG4gICAgICAgICAgICAgICAgZm9ybWF0ID0gUElYRUxGT1JNQVRfRFhUMTtcbiAgICAgICAgICAgICAgICBjb21wcmVzc2VkID0gdHJ1ZTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmNjID09PSBGQ0NfRFhUNSkge1xuICAgICAgICAgICAgICAgIGZvcm1hdCA9IFBJWEVMRk9STUFUX0RYVDU7XG4gICAgICAgICAgICAgICAgY29tcHJlc3NlZCA9IHRydWU7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGZjYyA9PT0gRkNDX0ZQMTYpIHtcbiAgICAgICAgICAgICAgICBmb3JtYXQgPSBQSVhFTEZPUk1BVF9SR0JBMTZGO1xuICAgICAgICAgICAgICAgIGNvbXBvbmVudFNpemUgPSAyO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChmY2MgPT09IEZDQ19GUDMyKSB7XG4gICAgICAgICAgICAgICAgZm9ybWF0ID0gUElYRUxGT1JNQVRfUkdCQTMyRjtcbiAgICAgICAgICAgICAgICBjb21wb25lbnRTaXplID0gNDtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmNjID09PSBGQ0NfRVRDMSkge1xuICAgICAgICAgICAgICAgIGZvcm1hdCA9IFBJWEVMRk9STUFUX0VUQzE7XG4gICAgICAgICAgICAgICAgY29tcHJlc3NlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgZXRjMSA9IHRydWU7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGZjYyA9PT0gRkNDX1BWUlRDXzJCUFBfUkdCXzEgfHwgZmNjID09PSBGQ0NfUFZSVENfMkJQUF9SR0JBXzEpIHtcbiAgICAgICAgICAgICAgICBmb3JtYXQgPSBmY2MgPT09IEZDQ19QVlJUQ18yQlBQX1JHQl8xID8gUElYRUxGT1JNQVRfUFZSVENfMkJQUF9SR0JfMSA6IFBJWEVMRk9STUFUX1BWUlRDXzJCUFBfUkdCQV8xO1xuICAgICAgICAgICAgICAgIGNvbXByZXNzZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHB2cnRjMiA9IHRydWU7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGZjYyA9PT0gRkNDX1BWUlRDXzRCUFBfUkdCXzEgfHwgZmNjID09PSBGQ0NfUFZSVENfNEJQUF9SR0JBXzEpIHtcbiAgICAgICAgICAgICAgICBmb3JtYXQgPSBmY2MgPT09IEZDQ19QVlJUQ180QlBQX1JHQl8xID8gUElYRUxGT1JNQVRfUFZSVENfNEJQUF9SR0JfMSA6IFBJWEVMRk9STUFUX1BWUlRDXzRCUFBfUkdCQV8xO1xuICAgICAgICAgICAgICAgIGNvbXByZXNzZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHB2cnRjNCA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoYnBwID09PSAzMikge1xuICAgICAgICAgICAgICAgIGZvcm1hdCA9IFBJWEVMRk9STUFUX1I4X0c4X0I4X0E4O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFmb3JtYXQpIHtcbiAgICAgICAgICAgIERlYnVnLmVycm9yKCdUaGlzIEREUyBwaXhlbCBmb3JtYXQgaXMgY3VycmVudGx5IHVuc3VwcG9ydGVkLiBFbXB0eSB0ZXh0dXJlIHdpbGwgYmUgY3JlYXRlZCBpbnN0ZWFkLicpO1xuICAgICAgICAgICAgdGV4dHVyZSA9IG5ldyBUZXh0dXJlKGRldmljZSwge1xuICAgICAgICAgICAgICAgIHdpZHRoOiA0LFxuICAgICAgICAgICAgICAgIGhlaWdodDogNCxcbiAgICAgICAgICAgICAgICBmb3JtYXQ6IFBJWEVMRk9STUFUX1I4X0c4X0I4LFxuICAgICAgICAgICAgICAgIG5hbWU6ICdkZHMtbGVnYWN5LWVtcHR5J1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4gdGV4dHVyZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRleHR1cmUgPSBuZXcgVGV4dHVyZShkZXZpY2UsIHtcbiAgICAgICAgICAgIG5hbWU6IHVybCxcbiAgICAgICAgICAgIC8vICNpZiBfUFJPRklMRVJcbiAgICAgICAgICAgIHByb2ZpbGVySGludDogVEVYSElOVF9BU1NFVCxcbiAgICAgICAgICAgIC8vICNlbmRpZlxuICAgICAgICAgICAgYWRkcmVzc1U6IGlzQ3ViZW1hcCA/IEFERFJFU1NfQ0xBTVBfVE9fRURHRSA6IEFERFJFU1NfUkVQRUFULFxuICAgICAgICAgICAgYWRkcmVzc1Y6IGlzQ3ViZW1hcCA/IEFERFJFU1NfQ0xBTVBfVE9fRURHRSA6IEFERFJFU1NfUkVQRUFULFxuICAgICAgICAgICAgd2lkdGg6IHdpZHRoLFxuICAgICAgICAgICAgaGVpZ2h0OiBoZWlnaHQsXG4gICAgICAgICAgICBmb3JtYXQ6IGZvcm1hdCxcbiAgICAgICAgICAgIGN1YmVtYXA6IGlzQ3ViZW1hcCxcbiAgICAgICAgICAgIG1pcG1hcHM6IG1pcHMgPiAxXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGxldCBvZmZzZXQgPSAxMjg7XG4gICAgICAgIGNvbnN0IGZhY2VzID0gaXNDdWJlbWFwID8gNiA6IDE7XG4gICAgICAgIGxldCBtaXBTaXplO1xuICAgICAgICBjb25zdCBEWFRfQkxPQ0tfV0lEVEggPSA0O1xuICAgICAgICBjb25zdCBEWFRfQkxPQ0tfSEVJR0hUID0gNDtcbiAgICAgICAgY29uc3QgYmxvY2tTaXplID0gZmNjID09PSBGQ0NfRFhUMSA/IDggOiAxNjtcbiAgICAgICAgbGV0IG51bUJsb2Nrc0Fjcm9zcywgbnVtQmxvY2tzRG93biwgbnVtQmxvY2tzO1xuICAgICAgICBmb3IgKGxldCBmYWNlID0gMDsgZmFjZSA8IGZhY2VzOyBmYWNlKyspIHtcbiAgICAgICAgICAgIGxldCBtaXBXaWR0aCA9IHdpZHRoO1xuICAgICAgICAgICAgbGV0IG1pcEhlaWdodCA9IGhlaWdodDtcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbWlwczsgaSsrKSB7XG4gICAgICAgICAgICAgICAgaWYgKGNvbXByZXNzZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV0YzEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1pcFNpemUgPSBNYXRoLmZsb29yKChtaXBXaWR0aCArIDMpIC8gNCkgKiBNYXRoLmZsb29yKChtaXBIZWlnaHQgKyAzKSAvIDQpICogODtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwdnJ0YzIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1pcFNpemUgPSBNYXRoLm1heChtaXBXaWR0aCwgMTYpICogTWF0aC5tYXgobWlwSGVpZ2h0LCA4KSAvIDQ7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocHZydGM0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtaXBTaXplID0gTWF0aC5tYXgobWlwV2lkdGgsIDgpICogTWF0aC5tYXgobWlwSGVpZ2h0LCA4KSAvIDI7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBudW1CbG9ja3NBY3Jvc3MgPSBNYXRoLmZsb29yKChtaXBXaWR0aCArIERYVF9CTE9DS19XSURUSCAtIDEpIC8gRFhUX0JMT0NLX1dJRFRIKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG51bUJsb2Nrc0Rvd24gPSBNYXRoLmZsb29yKChtaXBIZWlnaHQgKyBEWFRfQkxPQ0tfSEVJR0hUIC0gMSkgLyBEWFRfQkxPQ0tfSEVJR0hUKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG51bUJsb2NrcyA9IG51bUJsb2Nrc0Fjcm9zcyAqIG51bUJsb2Nrc0Rvd247XG4gICAgICAgICAgICAgICAgICAgICAgICBtaXBTaXplID0gbnVtQmxvY2tzICogYmxvY2tTaXplO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbWlwU2l6ZSA9IG1pcFdpZHRoICogbWlwSGVpZ2h0ICogNDtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBjb25zdCBtaXBCdWZmID0gZm9ybWF0ID09PSBQSVhFTEZPUk1BVF9SR0JBMzJGID8gbmV3IEZsb2F0MzJBcnJheShkYXRhLCBvZmZzZXQsIG1pcFNpemUpIDpcbiAgICAgICAgICAgICAgICAgICAgKGZvcm1hdCA9PT0gUElYRUxGT1JNQVRfUkdCQTE2RiA/IG5ldyBVaW50MTZBcnJheShkYXRhLCBvZmZzZXQsIG1pcFNpemUpIDpcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBVaW50OEFycmF5KGRhdGEsIG9mZnNldCwgbWlwU2l6ZSkpO1xuXG4gICAgICAgICAgICAgICAgaWYgKCFpc0N1YmVtYXApIHtcbiAgICAgICAgICAgICAgICAgICAgdGV4dHVyZS5fbGV2ZWxzW2ldID0gbWlwQnVmZjtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXRleHR1cmUuX2xldmVsc1tpXSkgdGV4dHVyZS5fbGV2ZWxzW2ldID0gW107XG4gICAgICAgICAgICAgICAgICAgIHRleHR1cmUuX2xldmVsc1tpXVtmYWNlXSA9IG1pcEJ1ZmY7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG9mZnNldCArPSBtaXBTaXplICogY29tcG9uZW50U2l6ZTtcbiAgICAgICAgICAgICAgICBtaXBXaWR0aCA9IE1hdGgubWF4KG1pcFdpZHRoICogMC41LCAxKTtcbiAgICAgICAgICAgICAgICBtaXBIZWlnaHQgPSBNYXRoLm1heChtaXBIZWlnaHQgKiAwLjUsIDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdGV4dHVyZS51cGxvYWQoKTtcblxuICAgICAgICByZXR1cm4gdGV4dHVyZTtcbiAgICB9XG59XG5cbmV4cG9ydCB7IERkc1BhcnNlciB9O1xuIl0sIm5hbWVzIjpbIkRkc1BhcnNlciIsImNvbnN0cnVjdG9yIiwicmVnaXN0cnkiLCJtYXhSZXRyaWVzIiwibG9hZCIsInVybCIsImNhbGxiYWNrIiwiYXNzZXQiLCJBc3NldCIsImZldGNoQXJyYXlCdWZmZXIiLCJvcGVuIiwiZGF0YSIsImRldmljZSIsImhlYWRlciIsIlVpbnQzMkFycmF5Iiwid2lkdGgiLCJoZWlnaHQiLCJtaXBzIiwiTWF0aCIsIm1heCIsImlzRm91ckNjIiwiZmNjIiwiYnBwIiwiaXNDdWJlbWFwIiwiRkNDX0RYVDEiLCJGQ0NfRFhUNSIsIkZDQ19GUDE2IiwiRkNDX0ZQMzIiLCJGQ0NfRVRDMSIsIkZDQ19QVlJUQ18yQlBQX1JHQl8xIiwiRkNDX1BWUlRDXzJCUFBfUkdCQV8xIiwiRkNDX1BWUlRDXzRCUFBfUkdCXzEiLCJGQ0NfUFZSVENfNEJQUF9SR0JBXzEiLCJjb21wcmVzc2VkIiwiZXRjMSIsInB2cnRjMiIsInB2cnRjNCIsImZvcm1hdCIsImNvbXBvbmVudFNpemUiLCJ0ZXh0dXJlIiwiUElYRUxGT1JNQVRfRFhUMSIsIlBJWEVMRk9STUFUX0RYVDUiLCJQSVhFTEZPUk1BVF9SR0JBMTZGIiwiUElYRUxGT1JNQVRfUkdCQTMyRiIsIlBJWEVMRk9STUFUX0VUQzEiLCJQSVhFTEZPUk1BVF9QVlJUQ18yQlBQX1JHQl8xIiwiUElYRUxGT1JNQVRfUFZSVENfMkJQUF9SR0JBXzEiLCJQSVhFTEZPUk1BVF9QVlJUQ180QlBQX1JHQl8xIiwiUElYRUxGT1JNQVRfUFZSVENfNEJQUF9SR0JBXzEiLCJQSVhFTEZPUk1BVF9SOF9HOF9COF9BOCIsIkRlYnVnIiwiZXJyb3IiLCJUZXh0dXJlIiwiUElYRUxGT1JNQVRfUjhfRzhfQjgiLCJuYW1lIiwicHJvZmlsZXJIaW50IiwiVEVYSElOVF9BU1NFVCIsImFkZHJlc3NVIiwiQUREUkVTU19DTEFNUF9UT19FREdFIiwiQUREUkVTU19SRVBFQVQiLCJhZGRyZXNzViIsImN1YmVtYXAiLCJtaXBtYXBzIiwib2Zmc2V0IiwiZmFjZXMiLCJtaXBTaXplIiwiRFhUX0JMT0NLX1dJRFRIIiwiRFhUX0JMT0NLX0hFSUdIVCIsImJsb2NrU2l6ZSIsIm51bUJsb2Nrc0Fjcm9zcyIsIm51bUJsb2Nrc0Rvd24iLCJudW1CbG9ja3MiLCJmYWNlIiwibWlwV2lkdGgiLCJtaXBIZWlnaHQiLCJpIiwiZmxvb3IiLCJtaXBCdWZmIiwiRmxvYXQzMkFycmF5IiwiVWludDE2QXJyYXkiLCJVaW50OEFycmF5IiwiX2xldmVscyIsInVwbG9hZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQXFCQSxNQUFNQSxTQUFOLENBQWdCO0VBQ1pDLFdBQVcsQ0FBQ0MsUUFBRCxFQUFXO0lBQ2xCLElBQUtDLENBQUFBLFVBQUwsR0FBa0IsQ0FBbEIsQ0FBQTtBQUNILEdBQUE7O0FBRURDLEVBQUFBLElBQUksQ0FBQ0MsR0FBRCxFQUFNQyxRQUFOLEVBQWdCQyxLQUFoQixFQUF1QjtBQUN2QkMsSUFBQUEsS0FBSyxDQUFDQyxnQkFBTixDQUF1QkosR0FBRyxDQUFDRCxJQUEzQixFQUFpQ0UsUUFBakMsRUFBMkNDLEtBQTNDLEVBQWtELElBQUEsQ0FBS0osVUFBdkQsQ0FBQSxDQUFBO0FBQ0gsR0FBQTs7QUFFRE8sRUFBQUEsSUFBSSxDQUFDTCxHQUFELEVBQU1NLElBQU4sRUFBWUMsTUFBWixFQUFvQjtJQUNwQixNQUFNQyxNQUFNLEdBQUcsSUFBSUMsV0FBSixDQUFnQkgsSUFBaEIsRUFBc0IsQ0FBdEIsRUFBeUIsR0FBTSxHQUFBLENBQS9CLENBQWYsQ0FBQTtB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
