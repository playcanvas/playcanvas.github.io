import{path as e}from"../core/path.js";import{Quat as n}from"../math/quat.js";import{Vec3 as t}from"../math/vec3.js";import{Http as o,http as s}from"../net/http.js";import{Animation as a,Node as r,Key as i}from"../animation/animation.js";import{AnimEvents as l}from"../anim/evaluator/anim-events.js";import{GlbParser as m}from"./parser/glb-parser.js";class p{constructor(e){this.handlerType="animation",this.maxRetries=0}load(n,t){"string"==typeof n&&(n={load:n,original:n});const a={retry:this.maxRetries>0,maxRetries:this.maxRetries};(n.load.startsWith("blob:")||n.load.startsWith("data:"))&&(".glb"===e.getExtension(n.original).toLowerCase()?a.responseType=o.ResponseType.ARRAY_BUFFER:a.responseType=o.ResponseType.JSON),s.get(n.load,a,(function(e,o){e?t(`Error loading animation resource: ${n.original} [${e}]`):t(null,o)}))}open(n,t,o){if(".glb"===e.getExtension(n).toLowerCase()){const e=m.parse("filename.glb",t,null);if(e){var s;const n=e.animations;if(null!=o&&null!=(s=o.data)&&s.events)for(let e=0;e<n.length;e++)n[e].events=new l(Object.values(o.data.events));return e.destroy(),n}return null}return this["_parseAnimationV"+t.animation.version](t)}patch(e,n){}_parseAnimationV3(e){const o=e.animation,s=new a;s.name=o.name,s.duration=o.duration;for(let e=0;e<o.nodes.length;e++){const a=new r,l=o.nodes[e];a._name=l.name;for(let e=0;e<l.keys.length;e++){const o=l.keys[e],s=o.time,r=o.pos,m=o.rot,p=o.scale,d=new t(r[0],r[1],r[2]),u=(new n).setFromEulerAngles(m[0],m[1],m[2]),f=new t(p[0],p[1],p[2]),c=new i(s,d,u,f);a._keys.push(c)}s.addNode(a)}return s}_parseAnimationV4(e){const o=e.animation,s=new a;s.name=o.name,s.duration=o.duration;for(let e=0;e<o.nodes.length;e++){const a=new r,l=o.nodes[e];a._name=l.name;const m=l.defaults.p,p=l.defaults.r,d=l.defaults.s;for(let e=0;e<l.keys.length;e++){const o=l.keys[e],s=o.t,r=m||o.p,u=p||o.r,f=d||o.s,c=new t(r[0],r[1],r[2]),h=(new n).setFromEulerAngles(u[0],u[1],u[2]),g=new t(f[0],f[1],f[2]),w=new i(s,c,h,g);a._keys.push(w)}s.addNode(a)}return s}}export{p as AnimationHandler};
