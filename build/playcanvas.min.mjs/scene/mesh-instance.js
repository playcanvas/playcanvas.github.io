import"../core/tracing.js";import{BoundingBox as t}from"../core/shape/bounding-box.js";import{BoundingSphere as e}from"../core/shape/bounding-sphere.js";import{BindGroup as s}from"../platform/graphics/bind-group.js";import{UniformBuffer as a}from"../platform/graphics/uniform-buffer.js";import{SORTKEY_FORWARD as i,MASK_AFFECT_DYNAMIC as r,SHADERDEF_UV0 as h,SHADERDEF_UV1 as n,SHADERDEF_VCOLOR as l,SHADERDEF_TANGENTS as o,LAYER_WORLD as c,RENDERSTYLE_SOLID as m,SHADERDEF_NOSHADOW as u,SHADER_FORWARD as d,SHADER_FORWARDHDR as _,SHADERDEF_MORPH_TEXTURE_BASED as p,SHADERDEF_MORPH_POSITION as f,SHADERDEF_MORPH_NORMAL as b,SHADERDEF_SCREENSPACE as g,BLEND_NORMAL as y,MASK_AFFECT_LIGHTMAPPED as S,MASK_BAKE as D,SHADERDEF_LM as k,SHADERDEF_DIRLM as I,SHADERDEF_LMAMBIENT as v,BLEND_NONE as x,SHADERDEF_SKIN as A}from"./constants.js";import{GraphNode as B}from"./graph-node.js";import{getDefaultMaterial as F}from"./materials/default-material.js";import{LightmapCache as P}from"./graphics/lightmap-cache.js";const w=new t,R=new t,V=new e,j=new Set;class C{constructor(t){this.vertexBuffer=null,this.count=t}}class G{constructor(t,e,s){this._key=[],this._key[i]=T(t,e,!0,0),this.command=s}set key(t){this._key[i]=t}get key(){return this._key[i]}}class L{constructor(e,s,a=null){if(this.visible=!0,this.castShadow=!1,this._material=void 0,this._shader=[],this._bindGroups=[],e instanceof B){const t=e;e=s,s=a,a=t}this._key=[0,0],this.isStatic=!1,this._staticLightList=null,this._staticSource=null,this.node=a,this._mesh=e,e.incRefCount(),this.material=s,this._shaderDefs=r<<16,this._shaderDefs|=e.vertexBuffer.format.hasUv0?h:0,this._shaderDefs|=e.vertexBuffer.format.hasUv1?n:0,this._shaderDefs|=e.vertexBuffer.format.hasColor?l:0,this._shaderDefs|=e.vertexBuffer.format.hasTangents?o:0,this._lightHash=0,this.layer=c,this._renderStyle=m,this._receiveShadow=!0,this._screenSpace=!1,this._noDepthDrawGl1=!1,this.cull=!0,this.pick=!0,this._updateAabb=!0,this._updateAabbFunc=null,this._calculateSortDistance=null,this.updateKey(),this._skinInstance=null,this._morphInstance=null,this.instancingData=null,this._customAabb=null,this.aabb=new t,this._aabbVer=-1,this.drawOrder=0,this.visibleThisFrame=!1,this.isVisibleFunc=null,this.parameters={},this.stencilFront=null,this.stencilBack=null,this.flipFaces=!1}set renderStyle(t){this._renderStyle=t,this.mesh.prepareRenderState(t)}get renderStyle(){return this._renderStyle}set mesh(t){t!==this._mesh&&(this._mesh&&this._mesh.decRefCount(),this._mesh=t,t&&t.incRefCount())}get mesh(){return this._mesh}set aabb(t){this._aabb=t}get aabb(){if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);let t=this._customAabb,e=!!t;if(!t)if(t=w,this.skinInstance){if(!this.mesh.boneAabb){const t=this._morphInstance?this._morphInstance.morph._targets:null;this.mesh._initBoneAabbs(t)}const s=this.mesh.boneUsed;let a=!0;for(let e=0;e<this.mesh.boneAabb.length;e++)s[e]&&(R.setFromTransformedAabb(this.mesh.boneAabb[e],this.skinInstance.matrices[e]),a?(a=!1,t.center.copy(R.center),t.halfExtents.copy(R.halfExtents)):t.add(R));e=!0}else if(this.node._aabbVer!==this._aabbVer){if(this.mesh?(t.center.copy(this.mesh.aabb.center),t.halfExtents.copy(this.mesh.aabb.halfExtents)):(t.center.set(0,0,0),t.halfExtents.set(0,0,0)),this.mesh&&this.mesh.morph){const e=this.mesh.morph.aabb;t._expand(e.getMin(),e.getMax())}e=!0,this._aabbVer=this.node._aabbVer}return e&&this._aabb.setFromTransformedAabb(t,this.node.getWorldTransform()),this._aabb}clearShaders(){const t=this._shader;for(let e=0;e<t.length;e++)t[e]=null;this.destroyBindGroups()}destroyBindGroups(){const t=this._bindGroups;for(let e=0;e<t.length;e++){const s=t[e];if(s){const t=s.defaultUniformBuffer;t&&t.destroy(),s.destroy()}}t.length=0}getBindGroup(t,e){let i=this._bindGroups[e];if(!i){const r=this._shader[e],h=r.meshUniformBufferFormat,n=new a(t,h),l=r.meshBindGroupFormat;i=new s(t,l,n),this._bindGroups[e]=i}return i}set material(t){this.clearShaders();const e=this._material;if(e&&e.removeMeshInstanceRef(this),this._material=t,t){t.addMeshInstanceRef(this),this.updateKey();const s=e&&e.transparent;if(t.transparent!==s){const s=this._material._scene||(null==e?void 0:e._scene);s?s.layers._dirtyBlend=!0:t._dirtyBlend=!0}}}get material(){return this._material}set layer(t){this._layer=t,this.updateKey()}get layer(){return this._layer}set calculateSortDistance(t){this._calculateSortDistance=t}get calculateSortDistance(){return this._calculateSortDistance}set receiveShadow(t){this._receiveShadow=t,this._shaderDefs=t?this._shaderDefs&~u:this._shaderDefs|u,this._shader[d]=null,this._shader[_]=null}get receiveShadow(){return this._receiveShadow}set skinInstance(t){this._skinInstance=t;let e=this._shaderDefs;e=t?e|A:e&~A,e!==this._shaderDefs&&(this._shaderDefs=e,this.clearShaders()),this._setupSkinUpdate()}get skinInstance(){return this._skinInstance}set morphInstance(t){var e;null==(e=this._morphInstance)||e.destroy(),this._morphInstance=t;let s=this._shaderDefs;s=t&&t.morph.useTextureMorph?s|p:s&~p,s=t&&t.morph.morphPositions?s|f:s&~f,s=t&&t.morph.morphNormals?s|b:s&~b,s!==this._shaderDefs&&(this._shaderDefs=s,this.clearShaders())}get morphInstance(){return this._morphInstance}set screenSpace(t){this._screenSpace=t,this._shaderDefs=t?this._shaderDefs|g:this._shaderDefs&~g,this._shader[d]=null}get screenSpace(){return this._screenSpace}set key(t){this._key[i]=t}get key(){return this._key[i]}set mask(t){const e=65535&this._shaderDefs;this._shaderDefs=e|t<<16,this._shader[d]=null,this._shader[_]=null}get mask(){return this._shaderDefs>>16}set instancingCount(t){this.instancingData&&(this.instancingData.count=t)}get instancingCount(){return this.instancingData?this.instancingData.count:0}destroy(){var t,e;const s=this.mesh;s&&(this.mesh=null,s.refCount<1&&s.destroy()),this.setRealtimeLightmap(L.lightmapParamNames[0],null),this.setRealtimeLightmap(L.lightmapParamNames[1],null),null==(t=this._skinInstance)||t.destroy(),this._skinInstance=null,null==(e=this.morphInstance)||e.destroy(),this.morphInstance=null,this.clearShaders(),this.material=null}static _prepareRenderStyleForArray(t,e){if(t){for(let s=0;s<t.length;s++){t[s]._renderStyle=e;const a=t[s].mesh;j.has(a)||(j.add(a),a.prepareRenderState(e))}j.clear()}}_isVisible(t){return!!this.visible&&(this.isVisibleFunc?this.isVisibleFunc(t):(V.center=this.aabb.center,V.radius=this._aabb.halfExtents.length(),t.frustum.containsSphere(V)))}updateKey(){const t=this.material;this._key[i]=T(this.layer,t.alphaToCoverage||t.alphaTest?y:t.blendType,!1,t.id)}setInstancing(t){t?(this.instancingData=new C(t.numVertices),this.instancingData.vertexBuffer=t,t.format.instancing=!0,this.cull=!1):(this.instancingData=null,this.cull=!0)}updatePassShader(t,e,s,a,i,r){this._shader[e]=this.material.getShaderVariant(this.mesh.device,t,this._shaderDefs,s,e,a,i,r,this._mesh.vertexBuffer.format)}ensureMaterial(t){this.material||(this.material=F(t))}clearParameters(){this.parameters={}}getParameters(){return this.parameters}getParameter(t){return this.parameters[t]}setParameter(t,e,s=-262141){if(void 0===e&&"object"==typeof t){const s=t;if(s.length){for(let t=0;t<s.length;t++)this.setParameter(s[t]);return}t=s.name,e=s.value}const a=this.parameters[t];a?(a.data=e,a.passFlags=s):this.parameters[t]={scopeId:null,data:e,passFlags:s}}setRealtimeLightmap(t,e){const s=this.getParameter(t);s!==e&&(s&&P.decRef(s.data),e?(P.incRef(e),this.setParameter(t,e)):this.deleteParameter(t))}deleteParameter(t){this.parameters[t]&&delete this.parameters[t]}setParameters(t,e){const s=this.parameters;for(const a in s){const i=s[a];i.passFlags&e&&(i.scopeId||(i.scopeId=t.scope.resolve(a)),i.scopeId.setValue(i.data))}}setLightmapped(t){t?this.mask=(this.mask|S)&~(r|D):(this.setRealtimeLightmap(L.lightmapParamNames[0],null),this.setRealtimeLightmap(L.lightmapParamNames[1],null),this._shaderDefs&=~(k|I|v),this.mask=(this.mask|r)&~(S|D))}setCustomAabb(t){t?this._customAabb?this._customAabb.copy(t):this._customAabb=t.clone():(this._customAabb=null,this._aabbVer=-1),this._setupSkinUpdate()}_setupSkinUpdate(){this._skinInstance&&(this._skinInstance._updateBeforeCull=!this._customAabb)}}function T(t,e,s,a){return(15&t)<<27|(e===x?1:0)<<26|(s?1:0)<<25|(33554431&a)<<0}L.lightmapParamNames=["texture_lightMap","texture_dirLightMap"];export{G as Command,L as MeshInstance};
