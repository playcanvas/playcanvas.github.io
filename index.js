!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";function e(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var t,s={exports:{}},i={},n={exports:{}},r={};function a(){if(t)return r;t=1;var e=Symbol.for("react.element"),s=Symbol.for("react.portal"),i=Symbol.for("react.fragment"),n=Symbol.for("react.strict_mode"),a=Symbol.for("react.profiler"),o=Symbol.for("react.provider"),l=Symbol.for("react.context"),h=Symbol.for("react.forward_ref"),c=Symbol.for("react.suspense"),d=Symbol.for("react.memo"),u=Symbol.for("react.lazy"),p=Symbol.iterator;var m={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},_=Object.assign,f={};function g(e,t,s){this.props=e,this.context=t,this.refs=f,this.updater=s||m}function v(){}function y(e,t,s){this.props=e,this.context=t,this.refs=f,this.updater=s||m}g.prototype.isReactComponent={},g.prototype.setState=function(e,t){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,t,"setState")},g.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},v.prototype=g.prototype;var b=y.prototype=new v;b.constructor=y,_(b,g.prototype),b.isPureReactComponent=!0;var x=Array.isArray,w=Object.prototype.hasOwnProperty,S={current:null},C={key:!0,ref:!0,__self:!0,__source:!0};function T(t,s,i){var n,r={},a=null,o=null;if(null!=s)for(n in void 0!==s.ref&&(o=s.ref),void 0!==s.key&&(a=""+s.key),s)w.call(s,n)&&!C.hasOwnProperty(n)&&(r[n]=s[n]);var l=arguments.length-2;if(1===l)r.children=i;else if(1<l){for(var h=Array(l),c=0;c<l;c++)h[c]=arguments[c+2];r.children=h}if(t&&t.defaultProps)for(n in l=t.defaultProps)void 0===r[n]&&(r[n]=l[n]);return{$$typeof:e,type:t,key:a,ref:o,props:r,_owner:S.current}}function A(t){return"object"==typeof t&&null!==t&&t.$$typeof===e}var E=/\/+/g;function P(e,t){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return t[e]}))}(""+e.key):t.toString(36)}function M(t,i,n,r,a){var o=typeof t;"undefined"!==o&&"boolean"!==o||(t=null);var l=!1;if(null===t)l=!0;else switch(o){case"string":case"number":l=!0;break;case"object":switch(t.$$typeof){case e:case s:l=!0}}if(l)return a=a(l=t),t=""===r?"."+P(l,0):r,x(a)?(n="",null!=t&&(n=t.replace(E,"$&/")+"/"),M(a,i,n,"",(function(e){return e}))):null!=a&&(A(a)&&(a=function(t,s){return{$$typeof:e,type:t.type,key:s,ref:t.ref,props:t.props,_owner:t._owner}}(a,n+(!a.key||l&&l.key===a.key?"":(""+a.key).replace(E,"$&/")+"/")+t)),i.push(a)),1;if(l=0,r=""===r?".":r+":",x(t))for(var h=0;h<t.length;h++){var c=r+P(o=t[h],h);l+=M(o,i,n,c,a)}else if(c=function(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=p&&e[p]||e["@@iterator"])?e:null}(t),"function"==typeof c)for(t=c.call(t),h=0;!(o=t.next()).done;)l+=M(o=o.value,i,n,c=r+P(o,h++),a);else if("object"===o)throw i=String(t),Error("Objects are not valid as a React child (found: "+("[object Object]"===i?"object with keys {"+Object.keys(t).join(", ")+"}":i)+"). If you meant to render a collection of children, use an array instead.");return l}function L(e,t,s){if(null==e)return e;var i=[],n=0;return M(e,i,"","",(function(e){return t.call(s,e,n++)})),i}function D(e){if(-1===e._status){var t=e._result;(t=t()).then((function(t){0!==e._status&&-1!==e._status||(e._status=1,e._result=t)}),(function(t){0!==e._status&&-1!==e._status||(e._status=2,e._result=t)})),-1===e._status&&(e._status=0,e._result=t)}if(1===e._status)return e._result.default;throw e._result}var k={current:null},I={transition:null},R={ReactCurrentDispatcher:k,ReactCurrentBatchConfig:I,ReactCurrentOwner:S};return r.Children={map:L,forEach:function(e,t,s){L(e,(function(){t.apply(this,arguments)}),s)},count:function(e){var t=0;return L(e,(function(){t++})),t},toArray:function(e){return L(e,(function(e){return e}))||[]},only:function(e){if(!A(e))throw Error("React.Children.only expected to receive a single React element child.");return e}},r.Component=g,r.Fragment=i,r.Profiler=a,r.PureComponent=y,r.StrictMode=n,r.Suspense=c,r.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=R,r.cloneElement=function(t,s,i){if(null==t)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+t+".");var n=_({},t.props),r=t.key,a=t.ref,o=t._owner;if(null!=s){if(void 0!==s.ref&&(a=s.ref,o=S.current),void 0!==s.key&&(r=""+s.key),t.type&&t.type.defaultProps)var l=t.type.defaultProps;for(h in s)w.call(s,h)&&!C.hasOwnProperty(h)&&(n[h]=void 0===s[h]&&void 0!==l?l[h]:s[h])}var h=arguments.length-2;if(1===h)n.children=i;else if(1<h){l=Array(h);for(var c=0;c<h;c++)l[c]=arguments[c+2];n.children=l}return{$$typeof:e,type:t.type,key:r,ref:a,props:n,_owner:o}},r.createContext=function(e){return(e={$$typeof:l,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null}).Provider={$$typeof:o,_context:e},e.Consumer=e},r.createElement=T,r.createFactory=function(e){var t=T.bind(null,e);return t.type=e,t},r.createRef=function(){return{current:null}},r.forwardRef=function(e){return{$$typeof:h,render:e}},r.isValidElement=A,r.lazy=function(e){return{$$typeof:u,_payload:{_status:-1,_result:e},_init:D}},r.memo=function(e,t){return{$$typeof:d,type:e,compare:void 0===t?null:t}},r.startTransition=function(e){var t=I.transition;I.transition={};try{e()}finally{I.transition=t}},r.unstable_act=function(){throw Error("act(...) is not supported in production builds of React.")},r.useCallback=function(e,t){return k.current.useCallback(e,t)},r.useContext=function(e){return k.current.useContext(e)},r.useDebugValue=function(){},r.useDeferredValue=function(e){return k.current.useDeferredValue(e)},r.useEffect=function(e,t){return k.current.useEffect(e,t)},r.useId=function(){return k.current.useId()},r.useImperativeHandle=function(e,t,s){return k.current.useImperativeHandle(e,t,s)},r.useInsertionEffect=function(e,t){return k.current.useInsertionEffect(e,t)},r.useLayoutEffect=function(e,t){return k.current.useLayoutEffect(e,t)},r.useMemo=function(e,t){return k.current.useMemo(e,t)},r.useReducer=function(e,t,s){return k.current.useReducer(e,t,s)},r.useRef=function(e){return k.current.useRef(e)},r.useState=function(e){return k.current.useState(e)},r.useSyncExternalStore=function(e,t,s){return k.current.useSyncExternalStore(e,t,s)},r.useTransition=function(){return k.current.useTransition()},r.version="18.2.0",r}n.exports=a();var o,l,h,c,d=e(n.exports),u={exports:{}},p={};function m(){return l||(l=1,function(e){e.exports=(o||(o=1,function(e){function t(e,t){var s=e.length;e.push(t);e:for(;0<s;){var i=s-1>>>1,r=e[i];if(!(0<n(r,t)))break e;e[i]=t,e[s]=r,s=i}}function s(e){return 0===e.length?null:e[0]}function i(e){if(0===e.length)return null;var t=e[0],s=e.pop();if(s!==t){e[0]=s;e:for(var i=0,r=e.length,a=r>>>1;i<a;){var o=2*(i+1)-1,l=e[o],h=o+1,c=e[h];if(0>n(l,s))h<r&&0>n(c,l)?(e[i]=c,e[h]=s,i=h):(e[i]=l,e[o]=s,i=o);else{if(!(h<r&&0>n(c,s)))break e;e[i]=c,e[h]=s,i=h}}}return t}function n(e,t){var s=e.sortIndex-t.sortIndex;return 0!==s?s:e.id-t.id}if("object"==typeof performance&&"function"==typeof performance.now){var r=performance;e.unstable_now=function(){return r.now()}}else{var a=Date,o=a.now();e.unstable_now=function(){return a.now()-o}}var l=[],h=[],c=1,d=null,u=3,p=!1,m=!1,_=!1,f="function"==typeof setTimeout?setTimeout:null,g="function"==typeof clearTimeout?clearTimeout:null,v="undefined"!=typeof setImmediate?setImmediate:null;function y(e){for(var n=s(h);null!==n;){if(null===n.callback)i(h);else{if(!(n.startTime<=e))break;i(h),n.sortIndex=n.expirationTime,t(l,n)}n=s(h)}}function b(e){if(_=!1,y(e),!m)if(null!==s(l))m=!0,k(x);else{var t=s(h);null!==t&&I(b,t.startTime-e)}}function x(t,n){m=!1,_&&(_=!1,g(T),T=-1),p=!0;var r=u;try{for(y(n),d=s(l);null!==d&&(!(d.expirationTime>n)||t&&!P());){var a=d.callback;if("function"==typeof a){d.callback=null,u=d.priorityLevel;var o=a(d.expirationTime<=n);n=e.unstable_now(),"function"==typeof o?d.callback=o:d===s(l)&&i(l),y(n)}else i(l);d=s(l)}if(null!==d)var c=!0;else{var f=s(h);null!==f&&I(b,f.startTime-n),c=!1}return c}finally{d=null,u=r,p=!1}}"undefined"!=typeof navigator&&void 0!==navigator.scheduling&&void 0!==navigator.scheduling.isInputPending&&navigator.scheduling.isInputPending.bind(navigator.scheduling);var w,S=!1,C=null,T=-1,A=5,E=-1;function P(){return!(e.unstable_now()-E<A)}function M(){if(null!==C){var t=e.unstable_now();E=t;var s=!0;try{s=C(!0,t)}finally{s?w():(S=!1,C=null)}}else S=!1}if("function"==typeof v)w=function(){v(M)};else if("undefined"!=typeof MessageChannel){var L=new MessageChannel,D=L.port2;L.port1.onmessage=M,w=function(){D.postMessage(null)}}else w=function(){f(M,0)};function k(e){C=e,S||(S=!0,w())}function I(t,s){T=f((function(){t(e.unstable_now())}),s)}e.unstable_IdlePriority=5,e.unstable_ImmediatePriority=1,e.unstable_LowPriority=4,e.unstable_NormalPriority=3,e.unstable_Profiling=null,e.unstable_UserBlockingPriority=2,e.unstable_cancelCallback=function(e){e.callback=null},e.unstable_continueExecution=function(){m||p||(m=!0,k(x))},e.unstable_forceFrameRate=function(e){0>e||125<e?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):A=0<e?Math.floor(1e3/e):5},e.unstable_getCurrentPriorityLevel=function(){return u},e.unstable_getFirstCallbackNode=function(){return s(l)},e.unstable_next=function(e){switch(u){case 1:case 2:case 3:var t=3;break;default:t=u}var s=u;u=t;try{return e()}finally{u=s}},e.unstable_pauseExecution=function(){},e.unstable_requestPaint=function(){},e.unstable_runWithPriority=function(e,t){switch(e){case 1:case 2:case 3:case 4:case 5:break;default:e=3}var s=u;u=e;try{return t()}finally{u=s}},e.unstable_scheduleCallback=function(i,n,r){var a=e.unstable_now();switch(r="object"==typeof r&&null!==r&&"number"==typeof(r=r.delay)&&0<r?a+r:a,i){case 1:var o=-1;break;case 2:o=250;break;case 5:o=1073741823;break;case 4:o=1e4;break;default:o=5e3}return i={id:c++,callback:n,priorityLevel:i,startTime:r,expirationTime:o=r+o,sortIndex:-1},r>a?(i.sortIndex=r,t(h,i),null===s(l)&&i===s(h)&&(_?(g(T),T=-1):_=!0,I(b,r-a))):(i.sortIndex=o,t(l,i),m||p||(m=!0,k(x))),i},e.unstable_shouldYield=P,e.unstable_wrapCallback=function(e){var t=u;return function(){var s=u;u=t;try{return e.apply(this,arguments)}finally{u=s}}}}(p)),p)}(u)),u.exports}
/**
	 * @license React
	 * react-dom.production.min.js
	 *
	 * Copyright (c) Facebook, Inc. and its affiliates.
	 *
	 * This source code is licensed under the MIT license found in the
	 * LICENSE file in the root directory of this source tree.
	 */function _(){if(h)return i;h=1;var e=n.exports,t=m();function s(e){for(var t="https://reactjs.org/docs/error-decoder.html?invariant="+e,s=1;s<arguments.length;s++)t+="&args[]="+encodeURIComponent(arguments[s]);return"Minified React error #"+e+"; visit "+t+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var r=new Set,a={};function o(e,t){l(e,t),l(e+"Capture",t)}function l(e,t){for(a[e]=t,e=0;e<t.length;e++)r.add(t[e])}var c=!("undefined"==typeof window||void 0===window.document||void 0===window.document.createElement),d=Object.prototype.hasOwnProperty,u=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,p={},_={};function f(e,t,s,i,n,r,a){this.acceptsBooleans=2===t||3===t||4===t,this.attributeName=i,this.attributeNamespace=n,this.mustUseProperty=s,this.propertyName=e,this.type=t,this.sanitizeURL=r,this.removeEmptyString=a}var g={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach((function(e){g[e]=new f(e,0,!1,e,null,!1,!1)})),[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach((function(e){var t=e[0];g[t]=new f(t,1,!1,e[1],null,!1,!1)})),["contentEditable","draggable","spellCheck","value"].forEach((function(e){g[e]=new f(e,2,!1,e.toLowerCase(),null,!1,!1)})),["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach((function(e){g[e]=new f(e,2,!1,e,null,!1,!1)})),"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach((function(e){g[e]=new f(e,3,!1,e.toLowerCase(),null,!1,!1)})),["checked","multiple","muted","selected"].forEach((function(e){g[e]=new f(e,3,!0,e,null,!1,!1)})),["capture","download"].forEach((function(e){g[e]=new f(e,4,!1,e,null,!1,!1)})),["cols","rows","size","span"].forEach((function(e){g[e]=new f(e,6,!1,e,null,!1,!1)})),["rowSpan","start"].forEach((function(e){g[e]=new f(e,5,!1,e.toLowerCase(),null,!1,!1)}));var v=/[\-:]([a-z])/g;function y(e){return e[1].toUpperCase()}function b(e,t,s,i){var n=g.hasOwnProperty(t)?g[t]:null;(null!==n?0!==n.type:i||!(2<t.length)||"o"!==t[0]&&"O"!==t[0]||"n"!==t[1]&&"N"!==t[1])&&(function(e,t,s,i){if(null==t||function(e,t,s,i){if(null!==s&&0===s.type)return!1;switch(typeof t){case"function":case"symbol":return!0;case"boolean":return!i&&(null!==s?!s.acceptsBooleans:"data-"!==(e=e.toLowerCase().slice(0,5))&&"aria-"!==e);default:return!1}}(e,t,s,i))return!0;if(i)return!1;if(null!==s)switch(s.type){case 3:return!t;case 4:return!1===t;case 5:return isNaN(t);case 6:return isNaN(t)||1>t}return!1}(t,s,n,i)&&(s=null),i||null===n?function(e){return!!d.call(_,e)||!d.call(p,e)&&(u.test(e)?_[e]=!0:(p[e]=!0,!1))}(t)&&(null===s?e.removeAttribute(t):e.setAttribute(t,""+s)):n.mustUseProperty?e[n.propertyName]=null===s?3!==n.type&&"":s:(t=n.attributeName,i=n.attributeNamespace,null===s?e.removeAttribute(t):(s=3===(n=n.type)||4===n&&!0===s?"":""+s,i?e.setAttributeNS(i,t,s):e.setAttribute(t,s))))}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach((function(e){var t=e.replace(v,y);g[t]=new f(t,1,!1,e,null,!1,!1)})),"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach((function(e){var t=e.replace(v,y);g[t]=new f(t,1,!1,e,"http://www.w3.org/1999/xlink",!1,!1)})),["xml:base","xml:lang","xml:space"].forEach((function(e){var t=e.replace(v,y);g[t]=new f(t,1,!1,e,"http://www.w3.org/XML/1998/namespace",!1,!1)})),["tabIndex","crossOrigin"].forEach((function(e){g[e]=new f(e,1,!1,e.toLowerCase(),null,!1,!1)})),g.xlinkHref=new f("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1),["src","href","action","formAction"].forEach((function(e){g[e]=new f(e,1,!1,e.toLowerCase(),null,!0,!0)}));var x=e.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,w=Symbol.for("react.element"),S=Symbol.for("react.portal"),C=Symbol.for("react.fragment"),T=Symbol.for("react.strict_mode"),A=Symbol.for("react.profiler"),E=Symbol.for("react.provider"),P=Symbol.for("react.context"),M=Symbol.for("react.forward_ref"),L=Symbol.for("react.suspense"),D=Symbol.for("react.suspense_list"),k=Symbol.for("react.memo"),I=Symbol.for("react.lazy"),R=Symbol.for("react.offscreen"),O=Symbol.iterator;function z(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=O&&e[O]||e["@@iterator"])?e:null}var F,V=Object.assign;function N(e){if(void 0===F)try{throw Error()}catch(e){var t=e.stack.trim().match(/\n( *(at )?)/);F=t&&t[1]||""}return"\n"+F+e}var B=!1;function U(e,t){if(!e||B)return"";B=!0;var s=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(t)if(t=function(){throw Error()},Object.defineProperty(t.prototype,"props",{set:function(){throw Error()}}),"object"==typeof Reflect&&Reflect.construct){try{Reflect.construct(t,[])}catch(e){var i=e}Reflect.construct(e,[],t)}else{try{t.call()}catch(e){i=e}e.call(t.prototype)}else{try{throw Error()}catch(e){i=e}e()}}catch(t){if(t&&i&&"string"==typeof t.stack){for(var n=t.stack.split("\n"),r=i.stack.split("\n"),a=n.length-1,o=r.length-1;1<=a&&0<=o&&n[a]!==r[o];)o--;for(;1<=a&&0<=o;a--,o--)if(n[a]!==r[o]){if(1!==a||1!==o)do{if(a--,0>--o||n[a]!==r[o]){var l="\n"+n[a].replace(" at new "," at ");return e.displayName&&l.includes("<anonymous>")&&(l=l.replace("<anonymous>",e.displayName)),l}}while(1<=a&&0<=o);break}}}finally{B=!1,Error.prepareStackTrace=s}return(e=e?e.displayName||e.name:"")?N(e):""}function H(e){switch(e.tag){case 5:return N(e.type);case 16:return N("Lazy");case 13:return N("Suspense");case 19:return N("SuspenseList");case 0:case 2:case 15:return e=U(e.type,!1);case 11:return e=U(e.type.render,!1);case 1:return e=U(e.type,!0);default:return""}}function W(e){if(null==e)return null;if("function"==typeof e)return e.displayName||e.name||null;if("string"==typeof e)return e;switch(e){case C:return"Fragment";case S:return"Portal";case A:return"Profiler";case T:return"StrictMode";case L:return"Suspense";case D:return"SuspenseList"}if("object"==typeof e)switch(e.$$typeof){case P:return(e.displayName||"Context")+".Consumer";case E:return(e._context.displayName||"Context")+".Provider";case M:var t=e.render;return(e=e.displayName)||(e=""!==(e=t.displayName||t.name||"")?"ForwardRef("+e+")":"ForwardRef"),e;case k:return null!==(t=e.displayName||null)?t:W(e.type)||"Memo";case I:t=e._payload,e=e._init;try{return W(e(t))}catch(e){}}return null}function G(e){var t=e.type;switch(e.tag){case 24:return"Cache";case 9:return(t.displayName||"Context")+".Consumer";case 10:return(t._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return e=(e=t.render).displayName||e.name||"",t.displayName||(""!==e?"ForwardRef("+e+")":"ForwardRef");case 7:return"Fragment";case 5:return t;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return W(t);case 8:return t===T?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if("function"==typeof t)return t.displayName||t.name||null;if("string"==typeof t)return t}return null}function j(e){switch(typeof e){case"boolean":case"number":case"string":case"undefined":case"object":return e;default:return""}}function q(e){var t=e.type;return(e=e.nodeName)&&"input"===e.toLowerCase()&&("checkbox"===t||"radio"===t)}function K(e){e._valueTracker||(e._valueTracker=function(e){var t=q(e)?"checked":"value",s=Object.getOwnPropertyDescriptor(e.constructor.prototype,t),i=""+e[t];if(!e.hasOwnProperty(t)&&void 0!==s&&"function"==typeof s.get&&"function"==typeof s.set){var n=s.get,r=s.set;return Object.defineProperty(e,t,{configurable:!0,get:function(){return n.call(this)},set:function(e){i=""+e,r.call(this,e)}}),Object.defineProperty(e,t,{enumerable:s.enumerable}),{getValue:function(){return i},setValue:function(e){i=""+e},stopTracking:function(){e._valueTracker=null,delete e[t]}}}}(e))}function X(e){if(!e)return!1;var t=e._valueTracker;if(!t)return!0;var s=t.getValue(),i="";return e&&(i=q(e)?e.checked?"true":"false":e.value),(e=i)!==s&&(t.setValue(e),!0)}function Y(e){if(void 0===(e=e||("undefined"!=typeof document?document:void 0)))return null;try{return e.activeElement||e.body}catch(t){return e.body}}function Z(e,t){var s=t.checked;return V({},t,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=s?s:e._wrapperState.initialChecked})}function $(e,t){var s=null==t.defaultValue?"":t.defaultValue,i=null!=t.checked?t.checked:t.defaultChecked;s=j(null!=t.value?t.value:s),e._wrapperState={initialChecked:i,initialValue:s,controlled:"checkbox"===t.type||"radio"===t.type?null!=t.checked:null!=t.value}}function Q(e,t){null!=(t=t.checked)&&b(e,"checked",t,!1)}function J(e,t){Q(e,t);var s=j(t.value),i=t.type;if(null!=s)"number"===i?(0===s&&""===e.value||e.value!=s)&&(e.value=""+s):e.value!==""+s&&(e.value=""+s);else if("submit"===i||"reset"===i)return void e.removeAttribute("value");t.hasOwnProperty("value")?te(e,t.type,s):t.hasOwnProperty("defaultValue")&&te(e,t.type,j(t.defaultValue)),null==t.checked&&null!=t.defaultChecked&&(e.defaultChecked=!!t.defaultChecked)}function ee(e,t,s){if(t.hasOwnProperty("value")||t.hasOwnProperty("defaultValue")){var i=t.type;if(!("submit"!==i&&"reset"!==i||void 0!==t.value&&null!==t.value))return;t=""+e._wrapperState.initialValue,s||t===e.value||(e.value=t),e.defaultValue=t}""!==(s=e.name)&&(e.name=""),e.defaultChecked=!!e._wrapperState.initialChecked,""!==s&&(e.name=s)}function te(e,t,s){"number"===t&&Y(e.ownerDocument)===e||(null==s?e.defaultValue=""+e._wrapperState.initialValue:e.defaultValue!==""+s&&(e.defaultValue=""+s))}var se=Array.isArray;function ie(e,t,s,i){if(e=e.options,t){t={};for(var n=0;n<s.length;n++)t["$"+s[n]]=!0;for(s=0;s<e.length;s++)n=t.hasOwnProperty("$"+e[s].value),e[s].selected!==n&&(e[s].selected=n),n&&i&&(e[s].defaultSelected=!0)}else{for(s=""+j(s),t=null,n=0;n<e.length;n++){if(e[n].value===s)return e[n].selected=!0,void(i&&(e[n].defaultSelected=!0));null!==t||e[n].disabled||(t=e[n])}null!==t&&(t.selected=!0)}}function ne(e,t){if(null!=t.dangerouslySetInnerHTML)throw Error(s(91));return V({},t,{value:void 0,defaultValue:void 0,children:""+e._wrapperState.initialValue})}function re(e,t){var i=t.value;if(null==i){if(i=t.children,t=t.defaultValue,null!=i){if(null!=t)throw Error(s(92));if(se(i)){if(1<i.length)throw Error(s(93));i=i[0]}t=i}null==t&&(t=""),i=t}e._wrapperState={initialValue:j(i)}}function ae(e,t){var s=j(t.value),i=j(t.defaultValue);null!=s&&((s=""+s)!==e.value&&(e.value=s),null==t.defaultValue&&e.defaultValue!==s&&(e.defaultValue=s)),null!=i&&(e.defaultValue=""+i)}function oe(e){var t=e.textContent;t===e._wrapperState.initialValue&&""!==t&&null!==t&&(e.value=t)}function le(e){switch(e){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function he(e,t){return null==e||"http://www.w3.org/1999/xhtml"===e?le(t):"http://www.w3.org/2000/svg"===e&&"foreignObject"===t?"http://www.w3.org/1999/xhtml":e}var ce,de,ue=(de=function(e,t){if("http://www.w3.org/2000/svg"!==e.namespaceURI||"innerHTML"in e)e.innerHTML=t;else{for((ce=ce||document.createElement("div")).innerHTML="<svg>"+t.valueOf().toString()+"</svg>",t=ce.firstChild;e.firstChild;)e.removeChild(e.firstChild);for(;t.firstChild;)e.appendChild(t.firstChild)}},"undefined"!=typeof MSApp&&MSApp.execUnsafeLocalFunction?function(e,t,s,i){MSApp.execUnsafeLocalFunction((function(){return de(e,t)}))}:de);function pe(e,t){if(t){var s=e.firstChild;if(s&&s===e.lastChild&&3===s.nodeType)return void(s.nodeValue=t)}e.textContent=t}var me={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},_e=["Webkit","ms","Moz","O"];function fe(e,t,s){return null==t||"boolean"==typeof t||""===t?"":s||"number"!=typeof t||0===t||me.hasOwnProperty(e)&&me[e]?(""+t).trim():t+"px"}function ge(e,t){for(var s in e=e.style,t)if(t.hasOwnProperty(s)){var i=0===s.indexOf("--"),n=fe(s,t[s],i);"float"===s&&(s="cssFloat"),i?e.setProperty(s,n):e[s]=n}}Object.keys(me).forEach((function(e){_e.forEach((function(t){t=t+e.charAt(0).toUpperCase()+e.substring(1),me[t]=me[e]}))}));var ve=V({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function ye(e,t){if(t){if(ve[e]&&(null!=t.children||null!=t.dangerouslySetInnerHTML))throw Error(s(137,e));if(null!=t.dangerouslySetInnerHTML){if(null!=t.children)throw Error(s(60));if("object"!=typeof t.dangerouslySetInnerHTML||!("__html"in t.dangerouslySetInnerHTML))throw Error(s(61))}if(null!=t.style&&"object"!=typeof t.style)throw Error(s(62))}}function be(e,t){if(-1===e.indexOf("-"))return"string"==typeof t.is;switch(e){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var xe=null;function we(e){return(e=e.target||e.srcElement||window).correspondingUseElement&&(e=e.correspondingUseElement),3===e.nodeType?e.parentNode:e}var Se=null,Ce=null,Te=null;function Ae(e){if(e=bn(e)){if("function"!=typeof Se)throw Error(s(280));var t=e.stateNode;t&&(t=wn(t),Se(e.stateNode,e.type,t))}}function Ee(e){Ce?Te?Te.push(e):Te=[e]:Ce=e}function Pe(){if(Ce){var e=Ce,t=Te;if(Te=Ce=null,Ae(e),t)for(e=0;e<t.length;e++)Ae(t[e])}}function Me(e,t){return e(t)}function Le(){}var De=!1;function ke(e,t,s){if(De)return e(t,s);De=!0;try{return Me(e,t,s)}finally{De=!1,(null!==Ce||null!==Te)&&(Le(),Pe())}}function Ie(e,t){var i=e.stateNode;if(null===i)return null;var n=wn(i);if(null===n)return null;i=n[t];e:switch(t){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(n=!n.disabled)||(n=!("button"===(e=e.type)||"input"===e||"select"===e||"textarea"===e)),e=!n;break e;default:e=!1}if(e)return null;if(i&&"function"!=typeof i)throw Error(s(231,t,typeof i));return i}var Re=!1;if(c)try{var Oe={};Object.defineProperty(Oe,"passive",{get:function(){Re=!0}}),window.addEventListener("test",Oe,Oe),window.removeEventListener("test",Oe,Oe)}catch(de){Re=!1}function ze(e,t,s,i,n,r,a,o,l){var h=Array.prototype.slice.call(arguments,3);try{t.apply(s,h)}catch(e){this.onError(e)}}var Fe=!1,Ve=null,Ne=!1,Be=null,Ue={onError:function(e){Fe=!0,Ve=e}};function He(e,t,s,i,n,r,a,o,l){Fe=!1,Ve=null,ze.apply(Ue,arguments)}function We(e){var t=e,s=e;if(e.alternate)for(;t.return;)t=t.return;else{e=t;do{0!=(4098&(t=e).flags)&&(s=t.return),e=t.return}while(e)}return 3===t.tag?s:null}function Ge(e){if(13===e.tag){var t=e.memoizedState;if(null===t&&(null!==(e=e.alternate)&&(t=e.memoizedState)),null!==t)return t.dehydrated}return null}function je(e){if(We(e)!==e)throw Error(s(188))}function qe(e){return e=function(e){var t=e.alternate;if(!t){if(null===(t=We(e)))throw Error(s(188));return t!==e?null:e}for(var i=e,n=t;;){var r=i.return;if(null===r)break;var a=r.alternate;if(null===a){if(null!==(n=r.return)){i=n;continue}break}if(r.child===a.child){for(a=r.child;a;){if(a===i)return je(r),e;if(a===n)return je(r),t;a=a.sibling}throw Error(s(188))}if(i.return!==n.return)i=r,n=a;else{for(var o=!1,l=r.child;l;){if(l===i){o=!0,i=r,n=a;break}if(l===n){o=!0,n=r,i=a;break}l=l.sibling}if(!o){for(l=a.child;l;){if(l===i){o=!0,i=a,n=r;break}if(l===n){o=!0,n=a,i=r;break}l=l.sibling}if(!o)throw Error(s(189))}}if(i.alternate!==n)throw Error(s(190))}if(3!==i.tag)throw Error(s(188));return i.stateNode.current===i?e:t}(e),null!==e?Ke(e):null}function Ke(e){if(5===e.tag||6===e.tag)return e;for(e=e.child;null!==e;){var t=Ke(e);if(null!==t)return t;e=e.sibling}return null}var Xe=t.unstable_scheduleCallback,Ye=t.unstable_cancelCallback,Ze=t.unstable_shouldYield,$e=t.unstable_requestPaint,Qe=t.unstable_now,Je=t.unstable_getCurrentPriorityLevel,et=t.unstable_ImmediatePriority,tt=t.unstable_UserBlockingPriority,st=t.unstable_NormalPriority,it=t.unstable_LowPriority,nt=t.unstable_IdlePriority,rt=null,at=null;var ot=Math.clz32?Math.clz32:function(e){return e>>>=0,0===e?32:31-(lt(e)/ht|0)|0},lt=Math.log,ht=Math.LN2;var ct=64,dt=4194304;function ut(e){switch(e&-e){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return 4194240&e;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return 130023424&e;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return e}}function pt(e,t){var s=e.pendingLanes;if(0===s)return 0;var i=0,n=e.suspendedLanes,r=e.pingedLanes,a=268435455&s;if(0!==a){var o=a&~n;0!==o?i=ut(o):0!==(r&=a)&&(i=ut(r))}else 0!==(a=s&~n)?i=ut(a):0!==r&&(i=ut(r));if(0===i)return 0;if(0!==t&&t!==i&&0==(t&n)&&((n=i&-i)>=(r=t&-t)||16===n&&0!=(4194240&r)))return t;if(0!=(4&i)&&(i|=16&s),0!==(t=e.entangledLanes))for(e=e.entanglements,t&=i;0<t;)n=1<<(s=31-ot(t)),i|=e[s],t&=~n;return i}function mt(e,t){switch(e){case 1:case 2:case 4:return t+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return t+5e3;default:return-1}}function _t(e){return 0!==(e=-1073741825&e.pendingLanes)?e:1073741824&e?1073741824:0}function ft(){var e=ct;return 0==(4194240&(ct<<=1))&&(ct=64),e}function gt(e){for(var t=[],s=0;31>s;s++)t.push(e);return t}function vt(e,t,s){e.pendingLanes|=t,536870912!==t&&(e.suspendedLanes=0,e.pingedLanes=0),(e=e.eventTimes)[t=31-ot(t)]=s}function yt(e,t){var s=e.entangledLanes|=t;for(e=e.entanglements;s;){var i=31-ot(s),n=1<<i;n&t|e[i]&t&&(e[i]|=t),s&=~n}}var bt=0;function xt(e){return 1<(e&=-e)?4<e?0!=(268435455&e)?16:536870912:4:1}var wt,St,Ct,Tt,At,Et=!1,Pt=[],Mt=null,Lt=null,Dt=null,kt=new Map,It=new Map,Rt=[],Ot="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function zt(e,t){switch(e){case"focusin":case"focusout":Mt=null;break;case"dragenter":case"dragleave":Lt=null;break;case"mouseover":case"mouseout":Dt=null;break;case"pointerover":case"pointerout":kt.delete(t.pointerId);break;case"gotpointercapture":case"lostpointercapture":It.delete(t.pointerId)}}function Ft(e,t,s,i,n,r){return null===e||e.nativeEvent!==r?(e={blockedOn:t,domEventName:s,eventSystemFlags:i,nativeEvent:r,targetContainers:[n]},null!==t&&(null!==(t=bn(t))&&St(t)),e):(e.eventSystemFlags|=i,t=e.targetContainers,null!==n&&-1===t.indexOf(n)&&t.push(n),e)}function Vt(e){var t=yn(e.target);if(null!==t){var s=We(t);if(null!==s)if(13===(t=s.tag)){if(null!==(t=Ge(s)))return e.blockedOn=t,void At(e.priority,(function(){Ct(s)}))}else if(3===t&&s.stateNode.current.memoizedState.isDehydrated)return void(e.blockedOn=3===s.tag?s.stateNode.containerInfo:null)}e.blockedOn=null}function Nt(e){if(null!==e.blockedOn)return!1;for(var t=e.targetContainers;0<t.length;){var s=Zt(e.domEventName,e.eventSystemFlags,t[0],e.nativeEvent);if(null!==s)return null!==(t=bn(s))&&St(t),e.blockedOn=s,!1;var i=new(s=e.nativeEvent).constructor(s.type,s);xe=i,s.target.dispatchEvent(i),xe=null,t.shift()}return!0}function Bt(e,t,s){Nt(e)&&s.delete(t)}function Ut(){Et=!1,null!==Mt&&Nt(Mt)&&(Mt=null),null!==Lt&&Nt(Lt)&&(Lt=null),null!==Dt&&Nt(Dt)&&(Dt=null),kt.forEach(Bt),It.forEach(Bt)}function Ht(e,s){e.blockedOn===s&&(e.blockedOn=null,Et||(Et=!0,t.unstable_scheduleCallback(t.unstable_NormalPriority,Ut)))}function Wt(e){function t(t){return Ht(t,e)}if(0<Pt.length){Ht(Pt[0],e);for(var s=1;s<Pt.length;s++){var i=Pt[s];i.blockedOn===e&&(i.blockedOn=null)}}for(null!==Mt&&Ht(Mt,e),null!==Lt&&Ht(Lt,e),null!==Dt&&Ht(Dt,e),kt.forEach(t),It.forEach(t),s=0;s<Rt.length;s++)(i=Rt[s]).blockedOn===e&&(i.blockedOn=null);for(;0<Rt.length&&null===(s=Rt[0]).blockedOn;)Vt(s),null===s.blockedOn&&Rt.shift()}var Gt=x.ReactCurrentBatchConfig,jt=!0;function qt(e,t,s,i){var n=bt,r=Gt.transition;Gt.transition=null;try{bt=1,Xt(e,t,s,i)}finally{bt=n,Gt.transition=r}}function Kt(e,t,s,i){var n=bt,r=Gt.transition;Gt.transition=null;try{bt=4,Xt(e,t,s,i)}finally{bt=n,Gt.transition=r}}function Xt(e,t,s,i){if(jt){var n=Zt(e,t,s,i);if(null===n)Gi(e,t,i,Yt,s),zt(e,i);else if(function(e,t,s,i,n){switch(t){case"focusin":return Mt=Ft(Mt,e,t,s,i,n),!0;case"dragenter":return Lt=Ft(Lt,e,t,s,i,n),!0;case"mouseover":return Dt=Ft(Dt,e,t,s,i,n),!0;case"pointerover":var r=n.pointerId;return kt.set(r,Ft(kt.get(r)||null,e,t,s,i,n)),!0;case"gotpointercapture":return r=n.pointerId,It.set(r,Ft(It.get(r)||null,e,t,s,i,n)),!0}return!1}(n,e,t,s,i))i.stopPropagation();else if(zt(e,i),4&t&&-1<Ot.indexOf(e)){for(;null!==n;){var r=bn(n);if(null!==r&&wt(r),null===(r=Zt(e,t,s,i))&&Gi(e,t,i,Yt,s),r===n)break;n=r}null!==n&&i.stopPropagation()}else Gi(e,t,i,null,s)}}var Yt=null;function Zt(e,t,s,i){if(Yt=null,null!==(e=yn(e=we(i))))if(null===(t=We(e)))e=null;else if(13===(s=t.tag)){if(null!==(e=Ge(t)))return e;e=null}else if(3===s){if(t.stateNode.current.memoizedState.isDehydrated)return 3===t.tag?t.stateNode.containerInfo:null;e=null}else t!==e&&(e=null);return Yt=e,null}function $t(e){switch(e){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch(Je()){case et:return 1;case tt:return 4;case st:case it:return 16;case nt:return 536870912;default:return 16}default:return 16}}var Qt=null,Jt=null,es=null;function ts(){if(es)return es;var e,t,s=Jt,i=s.length,n="value"in Qt?Qt.value:Qt.textContent,r=n.length;for(e=0;e<i&&s[e]===n[e];e++);var a=i-e;for(t=1;t<=a&&s[i-t]===n[r-t];t++);return es=n.slice(e,1<t?1-t:void 0)}function ss(e){var t=e.keyCode;return"charCode"in e?0===(e=e.charCode)&&13===t&&(e=13):e=t,10===e&&(e=13),32<=e||13===e?e:0}function is(){return!0}function ns(){return!1}function rs(e){function t(t,s,i,n,r){for(var a in this._reactName=t,this._targetInst=i,this.type=s,this.nativeEvent=n,this.target=r,this.currentTarget=null,e)e.hasOwnProperty(a)&&(t=e[a],this[a]=t?t(n):n[a]);return this.isDefaultPrevented=(null!=n.defaultPrevented?n.defaultPrevented:!1===n.returnValue)?is:ns,this.isPropagationStopped=ns,this}return V(t.prototype,{preventDefault:function(){this.defaultPrevented=!0;var e=this.nativeEvent;e&&(e.preventDefault?e.preventDefault():"unknown"!=typeof e.returnValue&&(e.returnValue=!1),this.isDefaultPrevented=is)},stopPropagation:function(){var e=this.nativeEvent;e&&(e.stopPropagation?e.stopPropagation():"unknown"!=typeof e.cancelBubble&&(e.cancelBubble=!0),this.isPropagationStopped=is)},persist:function(){},isPersistent:is}),t}var as,os,ls,hs={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(e){return e.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},cs=rs(hs),ds=V({},hs,{view:0,detail:0}),us=rs(ds),ps=V({},ds,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:Ts,button:0,buttons:0,relatedTarget:function(e){return void 0===e.relatedTarget?e.fromElement===e.srcElement?e.toElement:e.fromElement:e.relatedTarget},movementX:function(e){return"movementX"in e?e.movementX:(e!==ls&&(ls&&"mousemove"===e.type?(as=e.screenX-ls.screenX,os=e.screenY-ls.screenY):os=as=0,ls=e),as)},movementY:function(e){return"movementY"in e?e.movementY:os}}),ms=rs(ps),_s=rs(V({},ps,{dataTransfer:0})),fs=rs(V({},ds,{relatedTarget:0})),gs=rs(V({},hs,{animationName:0,elapsedTime:0,pseudoElement:0})),vs=V({},hs,{clipboardData:function(e){return"clipboardData"in e?e.clipboardData:window.clipboardData}}),ys=rs(vs),bs=rs(V({},hs,{data:0})),xs={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},ws={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},Ss={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function Cs(e){var t=this.nativeEvent;return t.getModifierState?t.getModifierState(e):!!(e=Ss[e])&&!!t[e]}function Ts(){return Cs}var As=V({},ds,{key:function(e){if(e.key){var t=xs[e.key]||e.key;if("Unidentified"!==t)return t}return"keypress"===e.type?13===(e=ss(e))?"Enter":String.fromCharCode(e):"keydown"===e.type||"keyup"===e.type?ws[e.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:Ts,charCode:function(e){return"keypress"===e.type?ss(e):0},keyCode:function(e){return"keydown"===e.type||"keyup"===e.type?e.keyCode:0},which:function(e){return"keypress"===e.type?ss(e):"keydown"===e.type||"keyup"===e.type?e.keyCode:0}}),Es=rs(As),Ps=rs(V({},ps,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0})),Ms=rs(V({},ds,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:Ts})),Ls=rs(V({},hs,{propertyName:0,elapsedTime:0,pseudoElement:0})),Ds=V({},ps,{deltaX:function(e){return"deltaX"in e?e.deltaX:"wheelDeltaX"in e?-e.wheelDeltaX:0},deltaY:function(e){return"deltaY"in e?e.deltaY:"wheelDeltaY"in e?-e.wheelDeltaY:"wheelDelta"in e?-e.wheelDelta:0},deltaZ:0,deltaMode:0}),ks=rs(Ds),Is=[9,13,27,32],Rs=c&&"CompositionEvent"in window,Os=null;c&&"documentMode"in document&&(Os=document.documentMode);var zs=c&&"TextEvent"in window&&!Os,Fs=c&&(!Rs||Os&&8<Os&&11>=Os),Vs=String.fromCharCode(32),Ns=!1;function Bs(e,t){switch(e){case"keyup":return-1!==Is.indexOf(t.keyCode);case"keydown":return 229!==t.keyCode;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function Us(e){return"object"==typeof(e=e.detail)&&"data"in e?e.data:null}var Hs=!1;var Ws={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function Gs(e){var t=e&&e.nodeName&&e.nodeName.toLowerCase();return"input"===t?!!Ws[e.type]:"textarea"===t}function js(e,t,s,i){Ee(i),0<(t=qi(t,"onChange")).length&&(s=new cs("onChange","change",null,s,i),e.push({event:s,listeners:t}))}var qs=null,Ks=null;function Xs(e){Vi(e,0)}function Ys(e){if(X(xn(e)))return e}function Zs(e,t){if("change"===e)return t}var $s=!1;if(c){var Qs;if(c){var Js="oninput"in document;if(!Js){var ei=document.createElement("div");ei.setAttribute("oninput","return;"),Js="function"==typeof ei.oninput}Qs=Js}else Qs=!1;$s=Qs&&(!document.documentMode||9<document.documentMode)}function ti(){qs&&(qs.detachEvent("onpropertychange",si),Ks=qs=null)}function si(e){if("value"===e.propertyName&&Ys(Ks)){var t=[];js(t,Ks,e,we(e)),ke(Xs,t)}}function ii(e,t,s){"focusin"===e?(ti(),Ks=s,(qs=t).attachEvent("onpropertychange",si)):"focusout"===e&&ti()}function ni(e){if("selectionchange"===e||"keyup"===e||"keydown"===e)return Ys(Ks)}function ri(e,t){if("click"===e)return Ys(t)}function ai(e,t){if("input"===e||"change"===e)return Ys(t)}var oi="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t};function li(e,t){if(oi(e,t))return!0;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!1;var s=Object.keys(e),i=Object.keys(t);if(s.length!==i.length)return!1;for(i=0;i<s.length;i++){var n=s[i];if(!d.call(t,n)||!oi(e[n],t[n]))return!1}return!0}function hi(e){for(;e&&e.firstChild;)e=e.firstChild;return e}function ci(e,t){var s,i=hi(e);for(e=0;i;){if(3===i.nodeType){if(s=e+i.textContent.length,e<=t&&s>=t)return{node:i,offset:t-e};e=s}e:{for(;i;){if(i.nextSibling){i=i.nextSibling;break e}i=i.parentNode}i=void 0}i=hi(i)}}function di(e,t){return!(!e||!t)&&(e===t||(!e||3!==e.nodeType)&&(t&&3===t.nodeType?di(e,t.parentNode):"contains"in e?e.contains(t):!!e.compareDocumentPosition&&!!(16&e.compareDocumentPosition(t))))}function ui(){for(var e=window,t=Y();t instanceof e.HTMLIFrameElement;){try{var s="string"==typeof t.contentWindow.location.href}catch(e){s=!1}if(!s)break;t=Y((e=t.contentWindow).document)}return t}function pi(e){var t=e&&e.nodeName&&e.nodeName.toLowerCase();return t&&("input"===t&&("text"===e.type||"search"===e.type||"tel"===e.type||"url"===e.type||"password"===e.type)||"textarea"===t||"true"===e.contentEditable)}function mi(e){var t=ui(),s=e.focusedElem,i=e.selectionRange;if(t!==s&&s&&s.ownerDocument&&di(s.ownerDocument.documentElement,s)){if(null!==i&&pi(s))if(t=i.start,void 0===(e=i.end)&&(e=t),"selectionStart"in s)s.selectionStart=t,s.selectionEnd=Math.min(e,s.value.length);else if((e=(t=s.ownerDocument||document)&&t.defaultView||window).getSelection){e=e.getSelection();var n=s.textContent.length,r=Math.min(i.start,n);i=void 0===i.end?r:Math.min(i.end,n),!e.extend&&r>i&&(n=i,i=r,r=n),n=ci(s,r);var a=ci(s,i);n&&a&&(1!==e.rangeCount||e.anchorNode!==n.node||e.anchorOffset!==n.offset||e.focusNode!==a.node||e.focusOffset!==a.offset)&&((t=t.createRange()).setStart(n.node,n.offset),e.removeAllRanges(),r>i?(e.addRange(t),e.extend(a.node,a.offset)):(t.setEnd(a.node,a.offset),e.addRange(t)))}for(t=[],e=s;e=e.parentNode;)1===e.nodeType&&t.push({element:e,left:e.scrollLeft,top:e.scrollTop});for("function"==typeof s.focus&&s.focus(),s=0;s<t.length;s++)(e=t[s]).element.scrollLeft=e.left,e.element.scrollTop=e.top}}var _i=c&&"documentMode"in document&&11>=document.documentMode,fi=null,gi=null,vi=null,yi=!1;function bi(e,t,s){var i=s.window===s?s.document:9===s.nodeType?s:s.ownerDocument;yi||null==fi||fi!==Y(i)||("selectionStart"in(i=fi)&&pi(i)?i={start:i.selectionStart,end:i.selectionEnd}:i={anchorNode:(i=(i.ownerDocument&&i.ownerDocument.defaultView||window).getSelection()).anchorNode,anchorOffset:i.anchorOffset,focusNode:i.focusNode,focusOffset:i.focusOffset},vi&&li(vi,i)||(vi=i,0<(i=qi(gi,"onSelect")).length&&(t=new cs("onSelect","select",null,t,s),e.push({event:t,listeners:i}),t.target=fi)))}function xi(e,t){var s={};return s[e.toLowerCase()]=t.toLowerCase(),s["Webkit"+e]="webkit"+t,s["Moz"+e]="moz"+t,s}var wi={animationend:xi("Animation","AnimationEnd"),animationiteration:xi("Animation","AnimationIteration"),animationstart:xi("Animation","AnimationStart"),transitionend:xi("Transition","TransitionEnd")},Si={},Ci={};function Ti(e){if(Si[e])return Si[e];if(!wi[e])return e;var t,s=wi[e];for(t in s)if(s.hasOwnProperty(t)&&t in Ci)return Si[e]=s[t];return e}c&&(Ci=document.createElement("div").style,"AnimationEvent"in window||(delete wi.animationend.animation,delete wi.animationiteration.animation,delete wi.animationstart.animation),"TransitionEvent"in window||delete wi.transitionend.transition);var Ai=Ti("animationend"),Ei=Ti("animationiteration"),Pi=Ti("animationstart"),Mi=Ti("transitionend"),Li=new Map,Di="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function ki(e,t){Li.set(e,t),o(t,[e])}for(var Ii=0;Ii<Di.length;Ii++){var Ri=Di[Ii];ki(Ri.toLowerCase(),"on"+(Ri[0].toUpperCase()+Ri.slice(1)))}ki(Ai,"onAnimationEnd"),ki(Ei,"onAnimationIteration"),ki(Pi,"onAnimationStart"),ki("dblclick","onDoubleClick"),ki("focusin","onFocus"),ki("focusout","onBlur"),ki(Mi,"onTransitionEnd"),l("onMouseEnter",["mouseout","mouseover"]),l("onMouseLeave",["mouseout","mouseover"]),l("onPointerEnter",["pointerout","pointerover"]),l("onPointerLeave",["pointerout","pointerover"]),o("onChange","change click focusin focusout input keydown keyup selectionchange".split(" ")),o("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" ")),o("onBeforeInput",["compositionend","keypress","textInput","paste"]),o("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" ")),o("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" ")),o("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var Oi="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),zi=new Set("cancel close invalid load scroll toggle".split(" ").concat(Oi));function Fi(e,t,i){var n=e.type||"unknown-event";e.currentTarget=i,function(e,t,i,n,r,a,o,l,h){if(He.apply(this,arguments),Fe){if(!Fe)throw Error(s(198));var c=Ve;Fe=!1,Ve=null,Ne||(Ne=!0,Be=c)}}(n,t,void 0,e),e.currentTarget=null}function Vi(e,t){t=0!=(4&t);for(var s=0;s<e.length;s++){var i=e[s],n=i.event;i=i.listeners;e:{var r=void 0;if(t)for(var a=i.length-1;0<=a;a--){var o=i[a],l=o.instance,h=o.currentTarget;if(o=o.listener,l!==r&&n.isPropagationStopped())break e;Fi(n,o,h),r=l}else for(a=0;a<i.length;a++){if(l=(o=i[a]).instance,h=o.currentTarget,o=o.listener,l!==r&&n.isPropagationStopped())break e;Fi(n,o,h),r=l}}}if(Ne)throw e=Be,Ne=!1,Be=null,e}function Ni(e,t){var s=t[fn];void 0===s&&(s=t[fn]=new Set);var i=e+"__bubble";s.has(i)||(Wi(t,e,2,!1),s.add(i))}function Bi(e,t,s){var i=0;t&&(i|=4),Wi(s,e,i,t)}var Ui="_reactListening"+Math.random().toString(36).slice(2);function Hi(e){if(!e[Ui]){e[Ui]=!0,r.forEach((function(t){"selectionchange"!==t&&(zi.has(t)||Bi(t,!1,e),Bi(t,!0,e))}));var t=9===e.nodeType?e:e.ownerDocument;null===t||t[Ui]||(t[Ui]=!0,Bi("selectionchange",!1,t))}}function Wi(e,t,s,i){switch($t(t)){case 1:var n=qt;break;case 4:n=Kt;break;default:n=Xt}s=n.bind(null,t,s,e),n=void 0,!Re||"touchstart"!==t&&"touchmove"!==t&&"wheel"!==t||(n=!0),i?void 0!==n?e.addEventListener(t,s,{capture:!0,passive:n}):e.addEventListener(t,s,!0):void 0!==n?e.addEventListener(t,s,{passive:n}):e.addEventListener(t,s,!1)}function Gi(e,t,s,i,n){var r=i;if(0==(1&t)&&0==(2&t)&&null!==i)e:for(;;){if(null===i)return;var a=i.tag;if(3===a||4===a){var o=i.stateNode.containerInfo;if(o===n||8===o.nodeType&&o.parentNode===n)break;if(4===a)for(a=i.return;null!==a;){var l=a.tag;if((3===l||4===l)&&((l=a.stateNode.containerInfo)===n||8===l.nodeType&&l.parentNode===n))return;a=a.return}for(;null!==o;){if(null===(a=yn(o)))return;if(5===(l=a.tag)||6===l){i=r=a;continue e}o=o.parentNode}}i=i.return}ke((function(){var i=r,n=we(s),a=[];e:{var o=Li.get(e);if(void 0!==o){var l=cs,h=e;switch(e){case"keypress":if(0===ss(s))break e;case"keydown":case"keyup":l=Es;break;case"focusin":h="focus",l=fs;break;case"focusout":h="blur",l=fs;break;case"beforeblur":case"afterblur":l=fs;break;case"click":if(2===s.button)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":l=ms;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":l=_s;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":l=Ms;break;case Ai:case Ei:case Pi:l=gs;break;case Mi:l=Ls;break;case"scroll":l=us;break;case"wheel":l=ks;break;case"copy":case"cut":case"paste":l=ys;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":l=Ps}var c=0!=(4&t),d=!c&&"scroll"===e,u=c?null!==o?o+"Capture":null:o;c=[];for(var p,m=i;null!==m;){var _=(p=m).stateNode;if(5===p.tag&&null!==_&&(p=_,null!==u&&(null!=(_=Ie(m,u))&&c.push(ji(m,_,p)))),d)break;m=m.return}0<c.length&&(o=new l(o,h,null,s,n),a.push({event:o,listeners:c}))}}if(0==(7&t)){if(l="mouseout"===e||"pointerout"===e,(!(o="mouseover"===e||"pointerover"===e)||s===xe||!(h=s.relatedTarget||s.fromElement)||!yn(h)&&!h[_n])&&(l||o)&&(o=n.window===n?n:(o=n.ownerDocument)?o.defaultView||o.parentWindow:window,l?(l=i,null!==(h=(h=s.relatedTarget||s.toElement)?yn(h):null)&&(h!==(d=We(h))||5!==h.tag&&6!==h.tag)&&(h=null)):(l=null,h=i),l!==h)){if(c=ms,_="onMouseLeave",u="onMouseEnter",m="mouse","pointerout"!==e&&"pointerover"!==e||(c=Ps,_="onPointerLeave",u="onPointerEnter",m="pointer"),d=null==l?o:xn(l),p=null==h?o:xn(h),(o=new c(_,m+"leave",l,s,n)).target=d,o.relatedTarget=p,_=null,yn(n)===i&&((c=new c(u,m+"enter",h,s,n)).target=p,c.relatedTarget=d,_=c),d=_,l&&h)e:{for(u=h,m=0,p=c=l;p;p=Ki(p))m++;for(p=0,_=u;_;_=Ki(_))p++;for(;0<m-p;)c=Ki(c),m--;for(;0<p-m;)u=Ki(u),p--;for(;m--;){if(c===u||null!==u&&c===u.alternate)break e;c=Ki(c),u=Ki(u)}c=null}else c=null;null!==l&&Xi(a,o,l,c,!1),null!==h&&null!==d&&Xi(a,d,h,c,!0)}if("select"===(l=(o=i?xn(i):window).nodeName&&o.nodeName.toLowerCase())||"input"===l&&"file"===o.type)var f=Zs;else if(Gs(o))if($s)f=ai;else{f=ni;var g=ii}else(l=o.nodeName)&&"input"===l.toLowerCase()&&("checkbox"===o.type||"radio"===o.type)&&(f=ri);switch(f&&(f=f(e,i))?js(a,f,s,n):(g&&g(e,o,i),"focusout"===e&&(g=o._wrapperState)&&g.controlled&&"number"===o.type&&te(o,"number",o.value)),g=i?xn(i):window,e){case"focusin":(Gs(g)||"true"===g.contentEditable)&&(fi=g,gi=i,vi=null);break;case"focusout":vi=gi=fi=null;break;case"mousedown":yi=!0;break;case"contextmenu":case"mouseup":case"dragend":yi=!1,bi(a,s,n);break;case"selectionchange":if(_i)break;case"keydown":case"keyup":bi(a,s,n)}var v;if(Rs)e:{switch(e){case"compositionstart":var y="onCompositionStart";break e;case"compositionend":y="onCompositionEnd";break e;case"compositionupdate":y="onCompositionUpdate";break e}y=void 0}else Hs?Bs(e,s)&&(y="onCompositionEnd"):"keydown"===e&&229===s.keyCode&&(y="onCompositionStart");y&&(Fs&&"ko"!==s.locale&&(Hs||"onCompositionStart"!==y?"onCompositionEnd"===y&&Hs&&(v=ts()):(Jt="value"in(Qt=n)?Qt.value:Qt.textContent,Hs=!0)),0<(g=qi(i,y)).length&&(y=new bs(y,e,null,s,n),a.push({event:y,listeners:g}),v?y.data=v:null!==(v=Us(s))&&(y.data=v))),(v=zs?function(e,t){switch(e){case"compositionend":return Us(t);case"keypress":return 32!==t.which?null:(Ns=!0,Vs);case"textInput":return(e=t.data)===Vs&&Ns?null:e;default:return null}}(e,s):function(e,t){if(Hs)return"compositionend"===e||!Rs&&Bs(e,t)?(e=ts(),es=Jt=Qt=null,Hs=!1,e):null;switch(e){case"paste":default:return null;case"keypress":if(!(t.ctrlKey||t.altKey||t.metaKey)||t.ctrlKey&&t.altKey){if(t.char&&1<t.char.length)return t.char;if(t.which)return String.fromCharCode(t.which)}return null;case"compositionend":return Fs&&"ko"!==t.locale?null:t.data}}(e,s))&&(0<(i=qi(i,"onBeforeInput")).length&&(n=new bs("onBeforeInput","beforeinput",null,s,n),a.push({event:n,listeners:i}),n.data=v))}Vi(a,t)}))}function ji(e,t,s){return{instance:e,listener:t,currentTarget:s}}function qi(e,t){for(var s=t+"Capture",i=[];null!==e;){var n=e,r=n.stateNode;5===n.tag&&null!==r&&(n=r,null!=(r=Ie(e,s))&&i.unshift(ji(e,r,n)),null!=(r=Ie(e,t))&&i.push(ji(e,r,n))),e=e.return}return i}function Ki(e){if(null===e)return null;do{e=e.return}while(e&&5!==e.tag);return e||null}function Xi(e,t,s,i,n){for(var r=t._reactName,a=[];null!==s&&s!==i;){var o=s,l=o.alternate,h=o.stateNode;if(null!==l&&l===i)break;5===o.tag&&null!==h&&(o=h,n?null!=(l=Ie(s,r))&&a.unshift(ji(s,l,o)):n||null!=(l=Ie(s,r))&&a.push(ji(s,l,o))),s=s.return}0!==a.length&&e.push({event:t,listeners:a})}var Yi=/\r\n?/g,Zi=/\u0000|\uFFFD/g;function $i(e){return("string"==typeof e?e:""+e).replace(Yi,"\n").replace(Zi,"")}function Qi(e,t,i){if(t=$i(t),$i(e)!==t&&i)throw Error(s(425))}function Ji(){}var en=null,tn=null;function sn(e,t){return"textarea"===e||"noscript"===e||"string"==typeof t.children||"number"==typeof t.children||"object"==typeof t.dangerouslySetInnerHTML&&null!==t.dangerouslySetInnerHTML&&null!=t.dangerouslySetInnerHTML.__html}var nn="function"==typeof setTimeout?setTimeout:void 0,rn="function"==typeof clearTimeout?clearTimeout:void 0,an="function"==typeof Promise?Promise:void 0,on="function"==typeof queueMicrotask?queueMicrotask:void 0!==an?function(e){return an.resolve(null).then(e).catch(ln)}:nn;function ln(e){setTimeout((function(){throw e}))}function hn(e,t){var s=t,i=0;do{var n=s.nextSibling;if(e.removeChild(s),n&&8===n.nodeType)if("/$"===(s=n.data)){if(0===i)return e.removeChild(n),void Wt(t);i--}else"$"!==s&&"$?"!==s&&"$!"!==s||i++;s=n}while(s);Wt(t)}function cn(e){for(;null!=e;e=e.nextSibling){var t=e.nodeType;if(1===t||3===t)break;if(8===t){if("$"===(t=e.data)||"$!"===t||"$?"===t)break;if("/$"===t)return null}}return e}function dn(e){e=e.previousSibling;for(var t=0;e;){if(8===e.nodeType){var s=e.data;if("$"===s||"$!"===s||"$?"===s){if(0===t)return e;t--}else"/$"===s&&t++}e=e.previousSibling}return null}var un=Math.random().toString(36).slice(2),pn="__reactFiber$"+un,mn="__reactProps$"+un,_n="__reactContainer$"+un,fn="__reactEvents$"+un,gn="__reactListeners$"+un,vn="__reactHandles$"+un;function yn(e){var t=e[pn];if(t)return t;for(var s=e.parentNode;s;){if(t=s[_n]||s[pn]){if(s=t.alternate,null!==t.child||null!==s&&null!==s.child)for(e=dn(e);null!==e;){if(s=e[pn])return s;e=dn(e)}return t}s=(e=s).parentNode}return null}function bn(e){return!(e=e[pn]||e[_n])||5!==e.tag&&6!==e.tag&&13!==e.tag&&3!==e.tag?null:e}function xn(e){if(5===e.tag||6===e.tag)return e.stateNode;throw Error(s(33))}function wn(e){return e[mn]||null}var Sn=[],Cn=-1;function Tn(e){return{current:e}}function An(e){0>Cn||(e.current=Sn[Cn],Sn[Cn]=null,Cn--)}function En(e,t){Cn++,Sn[Cn]=e.current,e.current=t}var Pn={},Mn=Tn(Pn),Ln=Tn(!1),Dn=Pn;function kn(e,t){var s=e.type.contextTypes;if(!s)return Pn;var i=e.stateNode;if(i&&i.__reactInternalMemoizedUnmaskedChildContext===t)return i.__reactInternalMemoizedMaskedChildContext;var n,r={};for(n in s)r[n]=t[n];return i&&((e=e.stateNode).__reactInternalMemoizedUnmaskedChildContext=t,e.__reactInternalMemoizedMaskedChildContext=r),r}function In(e){return null!=(e=e.childContextTypes)}function Rn(){An(Ln),An(Mn)}function On(e,t,i){if(Mn.current!==Pn)throw Error(s(168));En(Mn,t),En(Ln,i)}function zn(e,t,i){var n=e.stateNode;if(t=t.childContextTypes,"function"!=typeof n.getChildContext)return i;for(var r in n=n.getChildContext())if(!(r in t))throw Error(s(108,G(e)||"Unknown",r));return V({},i,n)}function Fn(e){return e=(e=e.stateNode)&&e.__reactInternalMemoizedMergedChildContext||Pn,Dn=Mn.current,En(Mn,e),En(Ln,Ln.current),!0}function Vn(e,t,i){var n=e.stateNode;if(!n)throw Error(s(169));i?(e=zn(e,t,Dn),n.__reactInternalMemoizedMergedChildContext=e,An(Ln),An(Mn),En(Mn,e)):An(Ln),En(Ln,i)}var Nn=null,Bn=!1,Un=!1;function Hn(e){null===Nn?Nn=[e]:Nn.push(e)}function Wn(){if(!Un&&null!==Nn){Un=!0;var e=0,t=bt;try{var s=Nn;for(bt=1;e<s.length;e++){var i=s[e];do{i=i(!0)}while(null!==i)}Nn=null,Bn=!1}catch(t){throw null!==Nn&&(Nn=Nn.slice(e+1)),Xe(et,Wn),t}finally{bt=t,Un=!1}}return null}var Gn=[],jn=0,qn=null,Kn=0,Xn=[],Yn=0,Zn=null,$n=1,Qn="";function Jn(e,t){Gn[jn++]=Kn,Gn[jn++]=qn,qn=e,Kn=t}function er(e,t,s){Xn[Yn++]=$n,Xn[Yn++]=Qn,Xn[Yn++]=Zn,Zn=e;var i=$n;e=Qn;var n=32-ot(i)-1;i&=~(1<<n),s+=1;var r=32-ot(t)+n;if(30<r){var a=n-n%5;r=(i&(1<<a)-1).toString(32),i>>=a,n-=a,$n=1<<32-ot(t)+n|s<<n|i,Qn=r+e}else $n=1<<r|s<<n|i,Qn=e}function tr(e){null!==e.return&&(Jn(e,1),er(e,1,0))}function sr(e){for(;e===qn;)qn=Gn[--jn],Gn[jn]=null,Kn=Gn[--jn],Gn[jn]=null;for(;e===Zn;)Zn=Xn[--Yn],Xn[Yn]=null,Qn=Xn[--Yn],Xn[Yn]=null,$n=Xn[--Yn],Xn[Yn]=null}var ir=null,nr=null,rr=!1,ar=null;function or(e,t){var s=Ih(5,null,null,0);s.elementType="DELETED",s.stateNode=t,s.return=e,null===(t=e.deletions)?(e.deletions=[s],e.flags|=16):t.push(s)}function lr(e,t){switch(e.tag){case 5:var s=e.type;return null!==(t=1!==t.nodeType||s.toLowerCase()!==t.nodeName.toLowerCase()?null:t)&&(e.stateNode=t,ir=e,nr=cn(t.firstChild),!0);case 6:return null!==(t=""===e.pendingProps||3!==t.nodeType?null:t)&&(e.stateNode=t,ir=e,nr=null,!0);case 13:return null!==(t=8!==t.nodeType?null:t)&&(s=null!==Zn?{id:$n,overflow:Qn}:null,e.memoizedState={dehydrated:t,treeContext:s,retryLane:1073741824},(s=Ih(18,null,null,0)).stateNode=t,s.return=e,e.child=s,ir=e,nr=null,!0);default:return!1}}function hr(e){return 0!=(1&e.mode)&&0==(128&e.flags)}function cr(e){if(rr){var t=nr;if(t){var i=t;if(!lr(e,t)){if(hr(e))throw Error(s(418));t=cn(i.nextSibling);var n=ir;t&&lr(e,t)?or(n,i):(e.flags=-4097&e.flags|2,rr=!1,ir=e)}}else{if(hr(e))throw Error(s(418));e.flags=-4097&e.flags|2,rr=!1,ir=e}}}function dr(e){for(e=e.return;null!==e&&5!==e.tag&&3!==e.tag&&13!==e.tag;)e=e.return;ir=e}function ur(e){if(e!==ir)return!1;if(!rr)return dr(e),rr=!0,!1;var t;if((t=3!==e.tag)&&!(t=5!==e.tag)&&(t="head"!==(t=e.type)&&"body"!==t&&!sn(e.type,e.memoizedProps)),t&&(t=nr)){if(hr(e))throw pr(),Error(s(418));for(;t;)or(e,t),t=cn(t.nextSibling)}if(dr(e),13===e.tag){if(!(e=null!==(e=e.memoizedState)?e.dehydrated:null))throw Error(s(317));e:{for(e=e.nextSibling,t=0;e;){if(8===e.nodeType){var i=e.data;if("/$"===i){if(0===t){nr=cn(e.nextSibling);break e}t--}else"$"!==i&&"$!"!==i&&"$?"!==i||t++}e=e.nextSibling}nr=null}}else nr=ir?cn(e.stateNode.nextSibling):null;return!0}function pr(){for(var e=nr;e;)e=cn(e.nextSibling)}function mr(){nr=ir=null,rr=!1}function _r(e){null===ar?ar=[e]:ar.push(e)}var fr=x.ReactCurrentBatchConfig;function gr(e,t){if(e&&e.defaultProps){for(var s in t=V({},t),e=e.defaultProps)void 0===t[s]&&(t[s]=e[s]);return t}return t}var vr=Tn(null),yr=null,br=null,xr=null;function wr(){xr=br=yr=null}function Sr(e){var t=vr.current;An(vr),e._currentValue=t}function Cr(e,t,s){for(;null!==e;){var i=e.alternate;if((e.childLanes&t)!==t?(e.childLanes|=t,null!==i&&(i.childLanes|=t)):null!==i&&(i.childLanes&t)!==t&&(i.childLanes|=t),e===s)break;e=e.return}}function Tr(e,t){yr=e,xr=br=null,null!==(e=e.dependencies)&&null!==e.firstContext&&(0!=(e.lanes&t)&&(xo=!0),e.firstContext=null)}function Ar(e){var t=e._currentValue;if(xr!==e)if(e={context:e,memoizedValue:t,next:null},null===br){if(null===yr)throw Error(s(308));br=e,yr.dependencies={lanes:0,firstContext:e}}else br=br.next=e;return t}var Er=null;function Pr(e){null===Er?Er=[e]:Er.push(e)}function Mr(e,t,s,i){var n=t.interleaved;return null===n?(s.next=s,Pr(t)):(s.next=n.next,n.next=s),t.interleaved=s,Lr(e,i)}function Lr(e,t){e.lanes|=t;var s=e.alternate;for(null!==s&&(s.lanes|=t),s=e,e=e.return;null!==e;)e.childLanes|=t,null!==(s=e.alternate)&&(s.childLanes|=t),s=e,e=e.return;return 3===s.tag?s.stateNode:null}var Dr=!1;function kr(e){e.updateQueue={baseState:e.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function Ir(e,t){e=e.updateQueue,t.updateQueue===e&&(t.updateQueue={baseState:e.baseState,firstBaseUpdate:e.firstBaseUpdate,lastBaseUpdate:e.lastBaseUpdate,shared:e.shared,effects:e.effects})}function Rr(e,t){return{eventTime:e,lane:t,tag:0,payload:null,callback:null,next:null}}function Or(e,t,s){var i=e.updateQueue;if(null===i)return null;if(i=i.shared,0!=(2&Ll)){var n=i.pending;return null===n?t.next=t:(t.next=n.next,n.next=t),i.pending=t,Lr(e,s)}return null===(n=i.interleaved)?(t.next=t,Pr(i)):(t.next=n.next,n.next=t),i.interleaved=t,Lr(e,s)}function zr(e,t,s){if(null!==(t=t.updateQueue)&&(t=t.shared,0!=(4194240&s))){var i=t.lanes;s|=i&=e.pendingLanes,t.lanes=s,yt(e,s)}}function Fr(e,t){var s=e.updateQueue,i=e.alternate;if(null!==i&&s===(i=i.updateQueue)){var n=null,r=null;if(null!==(s=s.firstBaseUpdate)){do{var a={eventTime:s.eventTime,lane:s.lane,tag:s.tag,payload:s.payload,callback:s.callback,next:null};null===r?n=r=a:r=r.next=a,s=s.next}while(null!==s);null===r?n=r=t:r=r.next=t}else n=r=t;return s={baseState:i.baseState,firstBaseUpdate:n,lastBaseUpdate:r,shared:i.shared,effects:i.effects},void(e.updateQueue=s)}null===(e=s.lastBaseUpdate)?s.firstBaseUpdate=t:e.next=t,s.lastBaseUpdate=t}function Vr(e,t,s,i){var n=e.updateQueue;Dr=!1;var r=n.firstBaseUpdate,a=n.lastBaseUpdate,o=n.shared.pending;if(null!==o){n.shared.pending=null;var l=o,h=l.next;l.next=null,null===a?r=h:a.next=h,a=l;var c=e.alternate;null!==c&&((o=(c=c.updateQueue).lastBaseUpdate)!==a&&(null===o?c.firstBaseUpdate=h:o.next=h,c.lastBaseUpdate=l))}if(null!==r){var d=n.baseState;for(a=0,c=h=l=null,o=r;;){var u=o.lane,p=o.eventTime;if((i&u)===u){null!==c&&(c=c.next={eventTime:p,lane:0,tag:o.tag,payload:o.payload,callback:o.callback,next:null});e:{var m=e,_=o;switch(u=t,p=s,_.tag){case 1:if("function"==typeof(m=_.payload)){d=m.call(p,d,u);break e}d=m;break e;case 3:m.flags=-65537&m.flags|128;case 0:if(null==(u="function"==typeof(m=_.payload)?m.call(p,d,u):m))break e;d=V({},d,u);break e;case 2:Dr=!0}}null!==o.callback&&0!==o.lane&&(e.flags|=64,null===(u=n.effects)?n.effects=[o]:u.push(o))}else p={eventTime:p,lane:u,tag:o.tag,payload:o.payload,callback:o.callback,next:null},null===c?(h=c=p,l=d):c=c.next=p,a|=u;if(null===(o=o.next)){if(null===(o=n.shared.pending))break;o=(u=o).next,u.next=null,n.lastBaseUpdate=u,n.shared.pending=null}}if(null===c&&(l=d),n.baseState=l,n.firstBaseUpdate=h,n.lastBaseUpdate=c,null!==(t=n.shared.interleaved)){n=t;do{a|=n.lane,n=n.next}while(n!==t)}else null===r&&(n.shared.lanes=0);Vl|=a,e.lanes=a,e.memoizedState=d}}function Nr(e,t,i){if(e=t.effects,t.effects=null,null!==e)for(t=0;t<e.length;t++){var n=e[t],r=n.callback;if(null!==r){if(n.callback=null,n=i,"function"!=typeof r)throw Error(s(191,r));r.call(n)}}}var Br=(new e.Component).refs;function Ur(e,t,s,i){s=null==(s=s(i,t=e.memoizedState))?t:V({},t,s),e.memoizedState=s,0===e.lanes&&(e.updateQueue.baseState=s)}var Hr={isMounted:function(e){return!!(e=e._reactInternals)&&We(e)===e},enqueueSetState:function(e,t,s){e=e._reactInternals;var i=sh(),n=ih(e),r=Rr(i,n);r.payload=t,null!=s&&(r.callback=s),null!==(t=Or(e,r,n))&&(nh(t,e,n,i),zr(t,e,n))},enqueueReplaceState:function(e,t,s){e=e._reactInternals;var i=sh(),n=ih(e),r=Rr(i,n);r.tag=1,r.payload=t,null!=s&&(r.callback=s),null!==(t=Or(e,r,n))&&(nh(t,e,n,i),zr(t,e,n))},enqueueForceUpdate:function(e,t){e=e._reactInternals;var s=sh(),i=ih(e),n=Rr(s,i);n.tag=2,null!=t&&(n.callback=t),null!==(t=Or(e,n,i))&&(nh(t,e,i,s),zr(t,e,i))}};function Wr(e,t,s,i,n,r,a){return"function"==typeof(e=e.stateNode).shouldComponentUpdate?e.shouldComponentUpdate(i,r,a):!t.prototype||!t.prototype.isPureReactComponent||(!li(s,i)||!li(n,r))}function Gr(e,t,s){var i=!1,n=Pn,r=t.contextType;return"object"==typeof r&&null!==r?r=Ar(r):(n=In(t)?Dn:Mn.current,r=(i=null!=(i=t.contextTypes))?kn(e,n):Pn),t=new t(s,r),e.memoizedState=null!==t.state&&void 0!==t.state?t.state:null,t.updater=Hr,e.stateNode=t,t._reactInternals=e,i&&((e=e.stateNode).__reactInternalMemoizedUnmaskedChildContext=n,e.__reactInternalMemoizedMaskedChildContext=r),t}function jr(e,t,s,i){e=t.state,"function"==typeof t.componentWillReceiveProps&&t.componentWillReceiveProps(s,i),"function"==typeof t.UNSAFE_componentWillReceiveProps&&t.UNSAFE_componentWillReceiveProps(s,i),t.state!==e&&Hr.enqueueReplaceState(t,t.state,null)}function qr(e,t,s,i){var n=e.stateNode;n.props=s,n.state=e.memoizedState,n.refs=Br,kr(e);var r=t.contextType;"object"==typeof r&&null!==r?n.context=Ar(r):(r=In(t)?Dn:Mn.current,n.context=kn(e,r)),n.state=e.memoizedState,"function"==typeof(r=t.getDerivedStateFromProps)&&(Ur(e,t,r,s),n.state=e.memoizedState),"function"==typeof t.getDerivedStateFromProps||"function"==typeof n.getSnapshotBeforeUpdate||"function"!=typeof n.UNSAFE_componentWillMount&&"function"!=typeof n.componentWillMount||(t=n.state,"function"==typeof n.componentWillMount&&n.componentWillMount(),"function"==typeof n.UNSAFE_componentWillMount&&n.UNSAFE_componentWillMount(),t!==n.state&&Hr.enqueueReplaceState(n,n.state,null),Vr(e,s,n,i),n.state=e.memoizedState),"function"==typeof n.componentDidMount&&(e.flags|=4194308)}function Kr(e,t,i){if(null!==(e=i.ref)&&"function"!=typeof e&&"object"!=typeof e){if(i._owner){if(i=i._owner){if(1!==i.tag)throw Error(s(309));var n=i.stateNode}if(!n)throw Error(s(147,e));var r=n,a=""+e;return null!==t&&null!==t.ref&&"function"==typeof t.ref&&t.ref._stringRef===a?t.ref:(t=function(e){var t=r.refs;t===Br&&(t=r.refs={}),null===e?delete t[a]:t[a]=e},t._stringRef=a,t)}if("string"!=typeof e)throw Error(s(284));if(!i._owner)throw Error(s(290,e))}return e}function Xr(e,t){throw e=Object.prototype.toString.call(t),Error(s(31,"[object Object]"===e?"object with keys {"+Object.keys(t).join(", ")+"}":e))}function Yr(e){return(0,e._init)(e._payload)}function Zr(e){function t(t,s){if(e){var i=t.deletions;null===i?(t.deletions=[s],t.flags|=16):i.push(s)}}function i(s,i){if(!e)return null;for(;null!==i;)t(s,i),i=i.sibling;return null}function n(e,t){for(e=new Map;null!==t;)null!==t.key?e.set(t.key,t):e.set(t.index,t),t=t.sibling;return e}function r(e,t){return(e=Oh(e,t)).index=0,e.sibling=null,e}function a(t,s,i){return t.index=i,e?null!==(i=t.alternate)?(i=i.index)<s?(t.flags|=2,s):i:(t.flags|=2,s):(t.flags|=1048576,s)}function o(t){return e&&null===t.alternate&&(t.flags|=2),t}function l(e,t,s,i){return null===t||6!==t.tag?((t=Nh(s,e.mode,i)).return=e,t):((t=r(t,s)).return=e,t)}function h(e,t,s,i){var n=s.type;return n===C?d(e,t,s.props.children,i,s.key):null!==t&&(t.elementType===n||"object"==typeof n&&null!==n&&n.$$typeof===I&&Yr(n)===t.type)?((i=r(t,s.props)).ref=Kr(e,t,s),i.return=e,i):((i=zh(s.type,s.key,s.props,null,e.mode,i)).ref=Kr(e,t,s),i.return=e,i)}function c(e,t,s,i){return null===t||4!==t.tag||t.stateNode.containerInfo!==s.containerInfo||t.stateNode.implementation!==s.implementation?((t=Bh(s,e.mode,i)).return=e,t):((t=r(t,s.children||[])).return=e,t)}function d(e,t,s,i,n){return null===t||7!==t.tag?((t=Fh(s,e.mode,i,n)).return=e,t):((t=r(t,s)).return=e,t)}function u(e,t,s){if("string"==typeof t&&""!==t||"number"==typeof t)return(t=Nh(""+t,e.mode,s)).return=e,t;if("object"==typeof t&&null!==t){switch(t.$$typeof){case w:return(s=zh(t.type,t.key,t.props,null,e.mode,s)).ref=Kr(e,null,t),s.return=e,s;case S:return(t=Bh(t,e.mode,s)).return=e,t;case I:return u(e,(0,t._init)(t._payload),s)}if(se(t)||z(t))return(t=Fh(t,e.mode,s,null)).return=e,t;Xr(e,t)}return null}function p(e,t,s,i){var n=null!==t?t.key:null;if("string"==typeof s&&""!==s||"number"==typeof s)return null!==n?null:l(e,t,""+s,i);if("object"==typeof s&&null!==s){switch(s.$$typeof){case w:return s.key===n?h(e,t,s,i):null;case S:return s.key===n?c(e,t,s,i):null;case I:return p(e,t,(n=s._init)(s._payload),i)}if(se(s)||z(s))return null!==n?null:d(e,t,s,i,null);Xr(e,s)}return null}function m(e,t,s,i,n){if("string"==typeof i&&""!==i||"number"==typeof i)return l(t,e=e.get(s)||null,""+i,n);if("object"==typeof i&&null!==i){switch(i.$$typeof){case w:return h(t,e=e.get(null===i.key?s:i.key)||null,i,n);case S:return c(t,e=e.get(null===i.key?s:i.key)||null,i,n);case I:return m(e,t,s,(0,i._init)(i._payload),n)}if(se(i)||z(i))return d(t,e=e.get(s)||null,i,n,null);Xr(t,i)}return null}function _(s,r,o,l){for(var h=null,c=null,d=r,_=r=0,f=null;null!==d&&_<o.length;_++){d.index>_?(f=d,d=null):f=d.sibling;var g=p(s,d,o[_],l);if(null===g){null===d&&(d=f);break}e&&d&&null===g.alternate&&t(s,d),r=a(g,r,_),null===c?h=g:c.sibling=g,c=g,d=f}if(_===o.length)return i(s,d),rr&&Jn(s,_),h;if(null===d){for(;_<o.length;_++)null!==(d=u(s,o[_],l))&&(r=a(d,r,_),null===c?h=d:c.sibling=d,c=d);return rr&&Jn(s,_),h}for(d=n(s,d);_<o.length;_++)null!==(f=m(d,s,_,o[_],l))&&(e&&null!==f.alternate&&d.delete(null===f.key?_:f.key),r=a(f,r,_),null===c?h=f:c.sibling=f,c=f);return e&&d.forEach((function(e){return t(s,e)})),rr&&Jn(s,_),h}function f(r,o,l,h){var c=z(l);if("function"!=typeof c)throw Error(s(150));if(null==(l=c.call(l)))throw Error(s(151));for(var d=c=null,_=o,f=o=0,g=null,v=l.next();null!==_&&!v.done;f++,v=l.next()){_.index>f?(g=_,_=null):g=_.sibling;var y=p(r,_,v.value,h);if(null===y){null===_&&(_=g);break}e&&_&&null===y.alternate&&t(r,_),o=a(y,o,f),null===d?c=y:d.sibling=y,d=y,_=g}if(v.done)return i(r,_),rr&&Jn(r,f),c;if(null===_){for(;!v.done;f++,v=l.next())null!==(v=u(r,v.value,h))&&(o=a(v,o,f),null===d?c=v:d.sibling=v,d=v);return rr&&Jn(r,f),c}for(_=n(r,_);!v.done;f++,v=l.next())null!==(v=m(_,r,f,v.value,h))&&(e&&null!==v.alternate&&_.delete(null===v.key?f:v.key),o=a(v,o,f),null===d?c=v:d.sibling=v,d=v);return e&&_.forEach((function(e){return t(r,e)})),rr&&Jn(r,f),c}return function e(s,n,a,l){if("object"==typeof a&&null!==a&&a.type===C&&null===a.key&&(a=a.props.children),"object"==typeof a&&null!==a){switch(a.$$typeof){case w:e:{for(var h=a.key,c=n;null!==c;){if(c.key===h){if((h=a.type)===C){if(7===c.tag){i(s,c.sibling),(n=r(c,a.props.children)).return=s,s=n;break e}}else if(c.elementType===h||"object"==typeof h&&null!==h&&h.$$typeof===I&&Yr(h)===c.type){i(s,c.sibling),(n=r(c,a.props)).ref=Kr(s,c,a),n.return=s,s=n;break e}i(s,c);break}t(s,c),c=c.sibling}a.type===C?((n=Fh(a.props.children,s.mode,l,a.key)).return=s,s=n):((l=zh(a.type,a.key,a.props,null,s.mode,l)).ref=Kr(s,n,a),l.return=s,s=l)}return o(s);case S:e:{for(c=a.key;null!==n;){if(n.key===c){if(4===n.tag&&n.stateNode.containerInfo===a.containerInfo&&n.stateNode.implementation===a.implementation){i(s,n.sibling),(n=r(n,a.children||[])).return=s,s=n;break e}i(s,n);break}t(s,n),n=n.sibling}(n=Bh(a,s.mode,l)).return=s,s=n}return o(s);case I:return e(s,n,(c=a._init)(a._payload),l)}if(se(a))return _(s,n,a,l);if(z(a))return f(s,n,a,l);Xr(s,a)}return"string"==typeof a&&""!==a||"number"==typeof a?(a=""+a,null!==n&&6===n.tag?(i(s,n.sibling),(n=r(n,a)).return=s,s=n):(i(s,n),(n=Nh(a,s.mode,l)).return=s,s=n),o(s)):i(s,n)}}var $r=Zr(!0),Qr=Zr(!1),Jr={},ea=Tn(Jr),ta=Tn(Jr),sa=Tn(Jr);function ia(e){if(e===Jr)throw Error(s(174));return e}function na(e,t){switch(En(sa,t),En(ta,e),En(ea,Jr),e=t.nodeType){case 9:case 11:t=(t=t.documentElement)?t.namespaceURI:he(null,"");break;default:t=he(t=(e=8===e?t.parentNode:t).namespaceURI||null,e=e.tagName)}An(ea),En(ea,t)}function ra(){An(ea),An(ta),An(sa)}function aa(e){ia(sa.current);var t=ia(ea.current),s=he(t,e.type);t!==s&&(En(ta,e),En(ea,s))}function oa(e){ta.current===e&&(An(ea),An(ta))}var la=Tn(0);function ha(e){for(var t=e;null!==t;){if(13===t.tag){var s=t.memoizedState;if(null!==s&&(null===(s=s.dehydrated)||"$?"===s.data||"$!"===s.data))return t}else if(19===t.tag&&void 0!==t.memoizedProps.revealOrder){if(0!=(128&t.flags))return t}else if(null!==t.child){t.child.return=t,t=t.child;continue}if(t===e)break;for(;null===t.sibling;){if(null===t.return||t.return===e)return null;t=t.return}t.sibling.return=t.return,t=t.sibling}return null}var ca=[];function da(){for(var e=0;e<ca.length;e++)ca[e]._workInProgressVersionPrimary=null;ca.length=0}var ua=x.ReactCurrentDispatcher,pa=x.ReactCurrentBatchConfig,ma=0,_a=null,fa=null,ga=null,va=!1,ya=!1,ba=0,xa=0;function wa(){throw Error(s(321))}function Sa(e,t){if(null===t)return!1;for(var s=0;s<t.length&&s<e.length;s++)if(!oi(e[s],t[s]))return!1;return!0}function Ca(e,t,i,n,r,a){if(ma=a,_a=t,t.memoizedState=null,t.updateQueue=null,t.lanes=0,ua.current=null===e||null===e.memoizedState?oo:lo,e=i(n,r),ya){a=0;do{if(ya=!1,ba=0,25<=a)throw Error(s(301));a+=1,ga=fa=null,t.updateQueue=null,ua.current=ho,e=i(n,r)}while(ya)}if(ua.current=ao,t=null!==fa&&null!==fa.next,ma=0,ga=fa=_a=null,va=!1,t)throw Error(s(300));return e}function Ta(){var e=0!==ba;return ba=0,e}function Aa(){var e={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return null===ga?_a.memoizedState=ga=e:ga=ga.next=e,ga}function Ea(){if(null===fa){var e=_a.alternate;e=null!==e?e.memoizedState:null}else e=fa.next;var t=null===ga?_a.memoizedState:ga.next;if(null!==t)ga=t,fa=e;else{if(null===e)throw Error(s(310));e={memoizedState:(fa=e).memoizedState,baseState:fa.baseState,baseQueue:fa.baseQueue,queue:fa.queue,next:null},null===ga?_a.memoizedState=ga=e:ga=ga.next=e}return ga}function Pa(e,t){return"function"==typeof t?t(e):t}function Ma(e){var t=Ea(),i=t.queue;if(null===i)throw Error(s(311));i.lastRenderedReducer=e;var n=fa,r=n.baseQueue,a=i.pending;if(null!==a){if(null!==r){var o=r.next;r.next=a.next,a.next=o}n.baseQueue=r=a,i.pending=null}if(null!==r){a=r.next,n=n.baseState;var l=o=null,h=null,c=a;do{var d=c.lane;if((ma&d)===d)null!==h&&(h=h.next={lane:0,action:c.action,hasEagerState:c.hasEagerState,eagerState:c.eagerState,next:null}),n=c.hasEagerState?c.eagerState:e(n,c.action);else{var u={lane:d,action:c.action,hasEagerState:c.hasEagerState,eagerState:c.eagerState,next:null};null===h?(l=h=u,o=n):h=h.next=u,_a.lanes|=d,Vl|=d}c=c.next}while(null!==c&&c!==a);null===h?o=n:h.next=l,oi(n,t.memoizedState)||(xo=!0),t.memoizedState=n,t.baseState=o,t.baseQueue=h,i.lastRenderedState=n}if(null!==(e=i.interleaved)){r=e;do{a=r.lane,_a.lanes|=a,Vl|=a,r=r.next}while(r!==e)}else null===r&&(i.lanes=0);return[t.memoizedState,i.dispatch]}function La(e){var t=Ea(),i=t.queue;if(null===i)throw Error(s(311));i.lastRenderedReducer=e;var n=i.dispatch,r=i.pending,a=t.memoizedState;if(null!==r){i.pending=null;var o=r=r.next;do{a=e(a,o.action),o=o.next}while(o!==r);oi(a,t.memoizedState)||(xo=!0),t.memoizedState=a,null===t.baseQueue&&(t.baseState=a),i.lastRenderedState=a}return[a,n]}function Da(){}function ka(e,t){var i=_a,n=Ea(),r=t(),a=!oi(n.memoizedState,r);if(a&&(n.memoizedState=r,xo=!0),n=n.queue,Ga(Oa.bind(null,i,n,e),[e]),n.getSnapshot!==t||a||null!==ga&&1&ga.memoizedState.tag){if(i.flags|=2048,Na(9,Ra.bind(null,i,n,r,t),void 0,null),null===Dl)throw Error(s(349));0!=(30&ma)||Ia(i,t,r)}return r}function Ia(e,t,s){e.flags|=16384,e={getSnapshot:t,value:s},null===(t=_a.updateQueue)?(t={lastEffect:null,stores:null},_a.updateQueue=t,t.stores=[e]):null===(s=t.stores)?t.stores=[e]:s.push(e)}function Ra(e,t,s,i){t.value=s,t.getSnapshot=i,za(t)&&Fa(e)}function Oa(e,t,s){return s((function(){za(t)&&Fa(e)}))}function za(e){var t=e.getSnapshot;e=e.value;try{var s=t();return!oi(e,s)}catch(e){return!0}}function Fa(e){var t=Lr(e,1);null!==t&&nh(t,e,1,-1)}function Va(e){var t=Aa();return"function"==typeof e&&(e=e()),t.memoizedState=t.baseState=e,e={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:Pa,lastRenderedState:e},t.queue=e,e=e.dispatch=so.bind(null,_a,e),[t.memoizedState,e]}function Na(e,t,s,i){return e={tag:e,create:t,destroy:s,deps:i,next:null},null===(t=_a.updateQueue)?(t={lastEffect:null,stores:null},_a.updateQueue=t,t.lastEffect=e.next=e):null===(s=t.lastEffect)?t.lastEffect=e.next=e:(i=s.next,s.next=e,e.next=i,t.lastEffect=e),e}function Ba(){return Ea().memoizedState}function Ua(e,t,s,i){var n=Aa();_a.flags|=e,n.memoizedState=Na(1|t,s,void 0,void 0===i?null:i)}function Ha(e,t,s,i){var n=Ea();i=void 0===i?null:i;var r=void 0;if(null!==fa){var a=fa.memoizedState;if(r=a.destroy,null!==i&&Sa(i,a.deps))return void(n.memoizedState=Na(t,s,r,i))}_a.flags|=e,n.memoizedState=Na(1|t,s,r,i)}function Wa(e,t){return Ua(8390656,8,e,t)}function Ga(e,t){return Ha(2048,8,e,t)}function ja(e,t){return Ha(4,2,e,t)}function qa(e,t){return Ha(4,4,e,t)}function Ka(e,t){return"function"==typeof t?(e=e(),t(e),function(){t(null)}):null!=t?(e=e(),t.current=e,function(){t.current=null}):void 0}function Xa(e,t,s){return s=null!=s?s.concat([e]):null,Ha(4,4,Ka.bind(null,t,e),s)}function Ya(){}function Za(e,t){var s=Ea();t=void 0===t?null:t;var i=s.memoizedState;return null!==i&&null!==t&&Sa(t,i[1])?i[0]:(s.memoizedState=[e,t],e)}function $a(e,t){var s=Ea();t=void 0===t?null:t;var i=s.memoizedState;return null!==i&&null!==t&&Sa(t,i[1])?i[0]:(e=e(),s.memoizedState=[e,t],e)}function Qa(e,t,s){return 0==(21&ma)?(e.baseState&&(e.baseState=!1,xo=!0),e.memoizedState=s):(oi(s,t)||(s=ft(),_a.lanes|=s,Vl|=s,e.baseState=!0),t)}function Ja(e,t){var s=bt;bt=0!==s&&4>s?s:4,e(!0);var i=pa.transition;pa.transition={};try{e(!1),t()}finally{bt=s,pa.transition=i}}function eo(){return Ea().memoizedState}function to(e,t,s){var i=ih(e);if(s={lane:i,action:s,hasEagerState:!1,eagerState:null,next:null},io(e))no(t,s);else if(null!==(s=Mr(e,t,s,i))){nh(s,e,i,sh()),ro(s,t,i)}}function so(e,t,s){var i=ih(e),n={lane:i,action:s,hasEagerState:!1,eagerState:null,next:null};if(io(e))no(t,n);else{var r=e.alternate;if(0===e.lanes&&(null===r||0===r.lanes)&&null!==(r=t.lastRenderedReducer))try{var a=t.lastRenderedState,o=r(a,s);if(n.hasEagerState=!0,n.eagerState=o,oi(o,a)){var l=t.interleaved;return null===l?(n.next=n,Pr(t)):(n.next=l.next,l.next=n),void(t.interleaved=n)}}catch(e){}null!==(s=Mr(e,t,n,i))&&(nh(s,e,i,n=sh()),ro(s,t,i))}}function io(e){var t=e.alternate;return e===_a||null!==t&&t===_a}function no(e,t){ya=va=!0;var s=e.pending;null===s?t.next=t:(t.next=s.next,s.next=t),e.pending=t}function ro(e,t,s){if(0!=(4194240&s)){var i=t.lanes;s|=i&=e.pendingLanes,t.lanes=s,yt(e,s)}}var ao={readContext:Ar,useCallback:wa,useContext:wa,useEffect:wa,useImperativeHandle:wa,useInsertionEffect:wa,useLayoutEffect:wa,useMemo:wa,useReducer:wa,useRef:wa,useState:wa,useDebugValue:wa,useDeferredValue:wa,useTransition:wa,useMutableSource:wa,useSyncExternalStore:wa,useId:wa,unstable_isNewReconciler:!1},oo={readContext:Ar,useCallback:function(e,t){return Aa().memoizedState=[e,void 0===t?null:t],e},useContext:Ar,useEffect:Wa,useImperativeHandle:function(e,t,s){return s=null!=s?s.concat([e]):null,Ua(4194308,4,Ka.bind(null,t,e),s)},useLayoutEffect:function(e,t){return Ua(4194308,4,e,t)},useInsertionEffect:function(e,t){return Ua(4,2,e,t)},useMemo:function(e,t){var s=Aa();return t=void 0===t?null:t,e=e(),s.memoizedState=[e,t],e},useReducer:function(e,t,s){var i=Aa();return t=void 0!==s?s(t):t,i.memoizedState=i.baseState=t,e={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:e,lastRenderedState:t},i.queue=e,e=e.dispatch=to.bind(null,_a,e),[i.memoizedState,e]},useRef:function(e){return e={current:e},Aa().memoizedState=e},useState:Va,useDebugValue:Ya,useDeferredValue:function(e){return Aa().memoizedState=e},useTransition:function(){var e=Va(!1),t=e[0];return e=Ja.bind(null,e[1]),Aa().memoizedState=e,[t,e]},useMutableSource:function(){},useSyncExternalStore:function(e,t,i){var n=_a,r=Aa();if(rr){if(void 0===i)throw Error(s(407));i=i()}else{if(i=t(),null===Dl)throw Error(s(349));0!=(30&ma)||Ia(n,t,i)}r.memoizedState=i;var a={value:i,getSnapshot:t};return r.queue=a,Wa(Oa.bind(null,n,a,e),[e]),n.flags|=2048,Na(9,Ra.bind(null,n,a,i,t),void 0,null),i},useId:function(){var e=Aa(),t=Dl.identifierPrefix;if(rr){var s=Qn;t=":"+t+"R"+(s=($n&~(1<<32-ot($n)-1)).toString(32)+s),0<(s=ba++)&&(t+="H"+s.toString(32)),t+=":"}else t=":"+t+"r"+(s=xa++).toString(32)+":";return e.memoizedState=t},unstable_isNewReconciler:!1},lo={readContext:Ar,useCallback:Za,useContext:Ar,useEffect:Ga,useImperativeHandle:Xa,useInsertionEffect:ja,useLayoutEffect:qa,useMemo:$a,useReducer:Ma,useRef:Ba,useState:function(){return Ma(Pa)},useDebugValue:Ya,useDeferredValue:function(e){return Qa(Ea(),fa.memoizedState,e)},useTransition:function(){return[Ma(Pa)[0],Ea().memoizedState]},useMutableSource:Da,useSyncExternalStore:ka,useId:eo,unstable_isNewReconciler:!1},ho={readContext:Ar,useCallback:Za,useContext:Ar,useEffect:Ga,useImperativeHandle:Xa,useInsertionEffect:ja,useLayoutEffect:qa,useMemo:$a,useReducer:La,useRef:Ba,useState:function(){return La(Pa)},useDebugValue:Ya,useDeferredValue:function(e){var t=Ea();return null===fa?t.memoizedState=e:Qa(t,fa.memoizedState,e)},useTransition:function(){return[La(Pa)[0],Ea().memoizedState]},useMutableSource:Da,useSyncExternalStore:ka,useId:eo,unstable_isNewReconciler:!1};function co(e,t){try{var s="",i=t;do{s+=H(i),i=i.return}while(i);var n=s}catch(e){n="\nError generating stack: "+e.message+"\n"+e.stack}return{value:e,source:t,stack:n,digest:null}}function uo(e,t,s){return{value:e,source:null,stack:null!=s?s:null,digest:null!=t?t:null}}function po(e,t){try{console.error(t.value)}catch(e){setTimeout((function(){throw e}))}}var mo="function"==typeof WeakMap?WeakMap:Map;function _o(e,t,s){(s=Rr(-1,s)).tag=3,s.payload={element:null};var i=t.value;return s.callback=function(){ql||(ql=!0,Kl=i),po(0,t)},s}function fo(e,t,s){(s=Rr(-1,s)).tag=3;var i=e.type.getDerivedStateFromError;if("function"==typeof i){var n=t.value;s.payload=function(){return i(n)},s.callback=function(){po(0,t)}}var r=e.stateNode;return null!==r&&"function"==typeof r.componentDidCatch&&(s.callback=function(){po(0,t),"function"!=typeof i&&(null===Xl?Xl=new Set([this]):Xl.add(this));var e=t.stack;this.componentDidCatch(t.value,{componentStack:null!==e?e:""})}),s}function go(e,t,s){var i=e.pingCache;if(null===i){i=e.pingCache=new mo;var n=new Set;i.set(t,n)}else void 0===(n=i.get(t))&&(n=new Set,i.set(t,n));n.has(s)||(n.add(s),e=Eh.bind(null,e,t,s),t.then(e,e))}function vo(e){do{var t;if((t=13===e.tag)&&(t=null===(t=e.memoizedState)||null!==t.dehydrated),t)return e;e=e.return}while(null!==e);return null}function yo(e,t,s,i,n){return 0==(1&e.mode)?(e===t?e.flags|=65536:(e.flags|=128,s.flags|=131072,s.flags&=-52805,1===s.tag&&(null===s.alternate?s.tag=17:((t=Rr(-1,1)).tag=2,Or(s,t,1))),s.lanes|=1),e):(e.flags|=65536,e.lanes=n,e)}var bo=x.ReactCurrentOwner,xo=!1;function wo(e,t,s,i){t.child=null===e?Qr(t,null,s,i):$r(t,e.child,s,i)}function So(e,t,s,i,n){s=s.render;var r=t.ref;return Tr(t,n),i=Ca(e,t,s,i,r,n),s=Ta(),null===e||xo?(rr&&s&&tr(t),t.flags|=1,wo(e,t,i,n),t.child):(t.updateQueue=e.updateQueue,t.flags&=-2053,e.lanes&=~n,qo(e,t,n))}function Co(e,t,s,i,n){if(null===e){var r=s.type;return"function"!=typeof r||Rh(r)||void 0!==r.defaultProps||null!==s.compare||void 0!==s.defaultProps?((e=zh(s.type,null,i,t,t.mode,n)).ref=t.ref,e.return=t,t.child=e):(t.tag=15,t.type=r,To(e,t,r,i,n))}if(r=e.child,0==(e.lanes&n)){var a=r.memoizedProps;if((s=null!==(s=s.compare)?s:li)(a,i)&&e.ref===t.ref)return qo(e,t,n)}return t.flags|=1,(e=Oh(r,i)).ref=t.ref,e.return=t,t.child=e}function To(e,t,s,i,n){if(null!==e){var r=e.memoizedProps;if(li(r,i)&&e.ref===t.ref){if(xo=!1,t.pendingProps=i=r,0==(e.lanes&n))return t.lanes=e.lanes,qo(e,t,n);0!=(131072&e.flags)&&(xo=!0)}}return Po(e,t,s,i,n)}function Ao(e,t,s){var i=t.pendingProps,n=i.children,r=null!==e?e.memoizedState:null;if("hidden"===i.mode)if(0==(1&t.mode))t.memoizedState={baseLanes:0,cachePool:null,transitions:null},En(Ol,Rl),Rl|=s;else{if(0==(1073741824&s))return e=null!==r?r.baseLanes|s:s,t.lanes=t.childLanes=1073741824,t.memoizedState={baseLanes:e,cachePool:null,transitions:null},t.updateQueue=null,En(Ol,Rl),Rl|=e,null;t.memoizedState={baseLanes:0,cachePool:null,transitions:null},i=null!==r?r.baseLanes:s,En(Ol,Rl),Rl|=i}else null!==r?(i=r.baseLanes|s,t.memoizedState=null):i=s,En(Ol,Rl),Rl|=i;return wo(e,t,n,s),t.child}function Eo(e,t){var s=t.ref;(null===e&&null!==s||null!==e&&e.ref!==s)&&(t.flags|=512,t.flags|=2097152)}function Po(e,t,s,i,n){var r=In(s)?Dn:Mn.current;return r=kn(t,r),Tr(t,n),s=Ca(e,t,s,i,r,n),i=Ta(),null===e||xo?(rr&&i&&tr(t),t.flags|=1,wo(e,t,s,n),t.child):(t.updateQueue=e.updateQueue,t.flags&=-2053,e.lanes&=~n,qo(e,t,n))}function Mo(e,t,s,i,n){if(In(s)){var r=!0;Fn(t)}else r=!1;if(Tr(t,n),null===t.stateNode)jo(e,t),Gr(t,s,i),qr(t,s,i,n),i=!0;else if(null===e){var a=t.stateNode,o=t.memoizedProps;a.props=o;var l=a.context,h=s.contextType;"object"==typeof h&&null!==h?h=Ar(h):h=kn(t,h=In(s)?Dn:Mn.current);var c=s.getDerivedStateFromProps,d="function"==typeof c||"function"==typeof a.getSnapshotBeforeUpdate;d||"function"!=typeof a.UNSAFE_componentWillReceiveProps&&"function"!=typeof a.componentWillReceiveProps||(o!==i||l!==h)&&jr(t,a,i,h),Dr=!1;var u=t.memoizedState;a.state=u,Vr(t,i,a,n),l=t.memoizedState,o!==i||u!==l||Ln.current||Dr?("function"==typeof c&&(Ur(t,s,c,i),l=t.memoizedState),(o=Dr||Wr(t,s,o,i,u,l,h))?(d||"function"!=typeof a.UNSAFE_componentWillMount&&"function"!=typeof a.componentWillMount||("function"==typeof a.componentWillMount&&a.componentWillMount(),"function"==typeof a.UNSAFE_componentWillMount&&a.UNSAFE_componentWillMount()),"function"==typeof a.componentDidMount&&(t.flags|=4194308)):("function"==typeof a.componentDidMount&&(t.flags|=4194308),t.memoizedProps=i,t.memoizedState=l),a.props=i,a.state=l,a.context=h,i=o):("function"==typeof a.componentDidMount&&(t.flags|=4194308),i=!1)}else{a=t.stateNode,Ir(e,t),o=t.memoizedProps,h=t.type===t.elementType?o:gr(t.type,o),a.props=h,d=t.pendingProps,u=a.context,"object"==typeof(l=s.contextType)&&null!==l?l=Ar(l):l=kn(t,l=In(s)?Dn:Mn.current);var p=s.getDerivedStateFromProps;(c="function"==typeof p||"function"==typeof a.getSnapshotBeforeUpdate)||"function"!=typeof a.UNSAFE_componentWillReceiveProps&&"function"!=typeof a.componentWillReceiveProps||(o!==d||u!==l)&&jr(t,a,i,l),Dr=!1,u=t.memoizedState,a.state=u,Vr(t,i,a,n);var m=t.memoizedState;o!==d||u!==m||Ln.current||Dr?("function"==typeof p&&(Ur(t,s,p,i),m=t.memoizedState),(h=Dr||Wr(t,s,h,i,u,m,l)||!1)?(c||"function"!=typeof a.UNSAFE_componentWillUpdate&&"function"!=typeof a.componentWillUpdate||("function"==typeof a.componentWillUpdate&&a.componentWillUpdate(i,m,l),"function"==typeof a.UNSAFE_componentWillUpdate&&a.UNSAFE_componentWillUpdate(i,m,l)),"function"==typeof a.componentDidUpdate&&(t.flags|=4),"function"==typeof a.getSnapshotBeforeUpdate&&(t.flags|=1024)):("function"!=typeof a.componentDidUpdate||o===e.memoizedProps&&u===e.memoizedState||(t.flags|=4),"function"!=typeof a.getSnapshotBeforeUpdate||o===e.memoizedProps&&u===e.memoizedState||(t.flags|=1024),t.memoizedProps=i,t.memoizedState=m),a.props=i,a.state=m,a.context=l,i=h):("function"!=typeof a.componentDidUpdate||o===e.memoizedProps&&u===e.memoizedState||(t.flags|=4),"function"!=typeof a.getSnapshotBeforeUpdate||o===e.memoizedProps&&u===e.memoizedState||(t.flags|=1024),i=!1)}return Lo(e,t,s,i,r,n)}function Lo(e,t,s,i,n,r){Eo(e,t);var a=0!=(128&t.flags);if(!i&&!a)return n&&Vn(t,s,!1),qo(e,t,r);i=t.stateNode,bo.current=t;var o=a&&"function"!=typeof s.getDerivedStateFromError?null:i.render();return t.flags|=1,null!==e&&a?(t.child=$r(t,e.child,null,r),t.child=$r(t,null,o,r)):wo(e,t,o,r),t.memoizedState=i.state,n&&Vn(t,s,!0),t.child}function Do(e){var t=e.stateNode;t.pendingContext?On(0,t.pendingContext,t.pendingContext!==t.context):t.context&&On(0,t.context,!1),na(e,t.containerInfo)}function ko(e,t,s,i,n){return mr(),_r(n),t.flags|=256,wo(e,t,s,i),t.child}var Io,Ro,Oo,zo,Fo={dehydrated:null,treeContext:null,retryLane:0};function Vo(e){return{baseLanes:e,cachePool:null,transitions:null}}function No(e,t,i){var n,r=t.pendingProps,a=la.current,o=!1,l=0!=(128&t.flags);if((n=l)||(n=(null===e||null!==e.memoizedState)&&0!=(2&a)),n?(o=!0,t.flags&=-129):null!==e&&null===e.memoizedState||(a|=1),En(la,1&a),null===e)return cr(t),null!==(e=t.memoizedState)&&null!==(e=e.dehydrated)?(0==(1&t.mode)?t.lanes=1:"$!"===e.data?t.lanes=8:t.lanes=1073741824,null):(l=r.children,e=r.fallback,o?(r=t.mode,o=t.child,l={mode:"hidden",children:l},0==(1&r)&&null!==o?(o.childLanes=0,o.pendingProps=l):o=Vh(l,r,0,null),e=Fh(e,r,i,null),o.return=t,e.return=t,o.sibling=e,t.child=o,t.child.memoizedState=Vo(i),t.memoizedState=Fo,e):Bo(t,l));if(null!==(a=e.memoizedState)&&null!==(n=a.dehydrated))return function(e,t,i,n,r,a,o){if(i)return 256&t.flags?(t.flags&=-257,Uo(e,t,o,n=uo(Error(s(422))))):null!==t.memoizedState?(t.child=e.child,t.flags|=128,null):(a=n.fallback,r=t.mode,n=Vh({mode:"visible",children:n.children},r,0,null),(a=Fh(a,r,o,null)).flags|=2,n.return=t,a.return=t,n.sibling=a,t.child=n,0!=(1&t.mode)&&$r(t,e.child,null,o),t.child.memoizedState=Vo(o),t.memoizedState=Fo,a);if(0==(1&t.mode))return Uo(e,t,o,null);if("$!"===r.data){if(n=r.nextSibling&&r.nextSibling.dataset)var l=n.dgst;return n=l,Uo(e,t,o,n=uo(a=Error(s(419)),n,void 0))}if(l=0!=(o&e.childLanes),xo||l){if(null!==(n=Dl)){switch(o&-o){case 4:r=2;break;case 16:r=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:r=32;break;case 536870912:r=268435456;break;default:r=0}0!==(r=0!=(r&(n.suspendedLanes|o))?0:r)&&r!==a.retryLane&&(a.retryLane=r,Lr(e,r),nh(n,e,r,-1))}return gh(),Uo(e,t,o,n=uo(Error(s(421))))}return"$?"===r.data?(t.flags|=128,t.child=e.child,t=Mh.bind(null,e),r._reactRetry=t,null):(e=a.treeContext,nr=cn(r.nextSibling),ir=t,rr=!0,ar=null,null!==e&&(Xn[Yn++]=$n,Xn[Yn++]=Qn,Xn[Yn++]=Zn,$n=e.id,Qn=e.overflow,Zn=t),t=Bo(t,n.children),t.flags|=4096,t)}(e,t,l,r,n,a,i);if(o){o=r.fallback,l=t.mode,n=(a=e.child).sibling;var h={mode:"hidden",children:r.children};return 0==(1&l)&&t.child!==a?((r=t.child).childLanes=0,r.pendingProps=h,t.deletions=null):(r=Oh(a,h)).subtreeFlags=14680064&a.subtreeFlags,null!==n?o=Oh(n,o):(o=Fh(o,l,i,null)).flags|=2,o.return=t,r.return=t,r.sibling=o,t.child=r,r=o,o=t.child,l=null===(l=e.child.memoizedState)?Vo(i):{baseLanes:l.baseLanes|i,cachePool:null,transitions:l.transitions},o.memoizedState=l,o.childLanes=e.childLanes&~i,t.memoizedState=Fo,r}return e=(o=e.child).sibling,r=Oh(o,{mode:"visible",children:r.children}),0==(1&t.mode)&&(r.lanes=i),r.return=t,r.sibling=null,null!==e&&(null===(i=t.deletions)?(t.deletions=[e],t.flags|=16):i.push(e)),t.child=r,t.memoizedState=null,r}function Bo(e,t){return(t=Vh({mode:"visible",children:t},e.mode,0,null)).return=e,e.child=t}function Uo(e,t,s,i){return null!==i&&_r(i),$r(t,e.child,null,s),(e=Bo(t,t.pendingProps.children)).flags|=2,t.memoizedState=null,e}function Ho(e,t,s){e.lanes|=t;var i=e.alternate;null!==i&&(i.lanes|=t),Cr(e.return,t,s)}function Wo(e,t,s,i,n){var r=e.memoizedState;null===r?e.memoizedState={isBackwards:t,rendering:null,renderingStartTime:0,last:i,tail:s,tailMode:n}:(r.isBackwards=t,r.rendering=null,r.renderingStartTime=0,r.last=i,r.tail=s,r.tailMode=n)}function Go(e,t,s){var i=t.pendingProps,n=i.revealOrder,r=i.tail;if(wo(e,t,i.children,s),0!=(2&(i=la.current)))i=1&i|2,t.flags|=128;else{if(null!==e&&0!=(128&e.flags))e:for(e=t.child;null!==e;){if(13===e.tag)null!==e.memoizedState&&Ho(e,s,t);else if(19===e.tag)Ho(e,s,t);else if(null!==e.child){e.child.return=e,e=e.child;continue}if(e===t)break e;for(;null===e.sibling;){if(null===e.return||e.return===t)break e;e=e.return}e.sibling.return=e.return,e=e.sibling}i&=1}if(En(la,i),0==(1&t.mode))t.memoizedState=null;else switch(n){case"forwards":for(s=t.child,n=null;null!==s;)null!==(e=s.alternate)&&null===ha(e)&&(n=s),s=s.sibling;null===(s=n)?(n=t.child,t.child=null):(n=s.sibling,s.sibling=null),Wo(t,!1,n,s,r);break;case"backwards":for(s=null,n=t.child,t.child=null;null!==n;){if(null!==(e=n.alternate)&&null===ha(e)){t.child=n;break}e=n.sibling,n.sibling=s,s=n,n=e}Wo(t,!0,s,null,r);break;case"together":Wo(t,!1,null,null,void 0);break;default:t.memoizedState=null}return t.child}function jo(e,t){0==(1&t.mode)&&null!==e&&(e.alternate=null,t.alternate=null,t.flags|=2)}function qo(e,t,i){if(null!==e&&(t.dependencies=e.dependencies),Vl|=t.lanes,0==(i&t.childLanes))return null;if(null!==e&&t.child!==e.child)throw Error(s(153));if(null!==t.child){for(i=Oh(e=t.child,e.pendingProps),t.child=i,i.return=t;null!==e.sibling;)e=e.sibling,(i=i.sibling=Oh(e,e.pendingProps)).return=t;i.sibling=null}return t.child}function Ko(e,t){if(!rr)switch(e.tailMode){case"hidden":t=e.tail;for(var s=null;null!==t;)null!==t.alternate&&(s=t),t=t.sibling;null===s?e.tail=null:s.sibling=null;break;case"collapsed":s=e.tail;for(var i=null;null!==s;)null!==s.alternate&&(i=s),s=s.sibling;null===i?t||null===e.tail?e.tail=null:e.tail.sibling=null:i.sibling=null}}function Xo(e){var t=null!==e.alternate&&e.alternate.child===e.child,s=0,i=0;if(t)for(var n=e.child;null!==n;)s|=n.lanes|n.childLanes,i|=14680064&n.subtreeFlags,i|=14680064&n.flags,n.return=e,n=n.sibling;else for(n=e.child;null!==n;)s|=n.lanes|n.childLanes,i|=n.subtreeFlags,i|=n.flags,n.return=e,n=n.sibling;return e.subtreeFlags|=i,e.childLanes=s,t}function Yo(e,t,i){var n=t.pendingProps;switch(sr(t),t.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return Xo(t),null;case 1:case 17:return In(t.type)&&Rn(),Xo(t),null;case 3:return n=t.stateNode,ra(),An(Ln),An(Mn),da(),n.pendingContext&&(n.context=n.pendingContext,n.pendingContext=null),null!==e&&null!==e.child||(ur(t)?t.flags|=4:null===e||e.memoizedState.isDehydrated&&0==(256&t.flags)||(t.flags|=1024,null!==ar&&(lh(ar),ar=null))),Ro(e,t),Xo(t),null;case 5:oa(t);var r=ia(sa.current);if(i=t.type,null!==e&&null!=t.stateNode)Oo(e,t,i,n,r),e.ref!==t.ref&&(t.flags|=512,t.flags|=2097152);else{if(!n){if(null===t.stateNode)throw Error(s(166));return Xo(t),null}if(e=ia(ea.current),ur(t)){n=t.stateNode,i=t.type;var o=t.memoizedProps;switch(n[pn]=t,n[mn]=o,e=0!=(1&t.mode),i){case"dialog":Ni("cancel",n),Ni("close",n);break;case"iframe":case"object":case"embed":Ni("load",n);break;case"video":case"audio":for(r=0;r<Oi.length;r++)Ni(Oi[r],n);break;case"source":Ni("error",n);break;case"img":case"image":case"link":Ni("error",n),Ni("load",n);break;case"details":Ni("toggle",n);break;case"input":$(n,o),Ni("invalid",n);break;case"select":n._wrapperState={wasMultiple:!!o.multiple},Ni("invalid",n);break;case"textarea":re(n,o),Ni("invalid",n)}for(var l in ye(i,o),r=null,o)if(o.hasOwnProperty(l)){var h=o[l];"children"===l?"string"==typeof h?n.textContent!==h&&(!0!==o.suppressHydrationWarning&&Qi(n.textContent,h,e),r=["children",h]):"number"==typeof h&&n.textContent!==""+h&&(!0!==o.suppressHydrationWarning&&Qi(n.textContent,h,e),r=["children",""+h]):a.hasOwnProperty(l)&&null!=h&&"onScroll"===l&&Ni("scroll",n)}switch(i){case"input":K(n),ee(n,o,!0);break;case"textarea":K(n),oe(n);break;case"select":case"option":break;default:"function"==typeof o.onClick&&(n.onclick=Ji)}n=r,t.updateQueue=n,null!==n&&(t.flags|=4)}else{l=9===r.nodeType?r:r.ownerDocument,"http://www.w3.org/1999/xhtml"===e&&(e=le(i)),"http://www.w3.org/1999/xhtml"===e?"script"===i?((e=l.createElement("div")).innerHTML="<script><\/script>",e=e.removeChild(e.firstChild)):"string"==typeof n.is?e=l.createElement(i,{is:n.is}):(e=l.createElement(i),"select"===i&&(l=e,n.multiple?l.multiple=!0:n.size&&(l.size=n.size))):e=l.createElementNS(e,i),e[pn]=t,e[mn]=n,Io(e,t,!1,!1),t.stateNode=e;e:{switch(l=be(i,n),i){case"dialog":Ni("cancel",e),Ni("close",e),r=n;break;case"iframe":case"object":case"embed":Ni("load",e),r=n;break;case"video":case"audio":for(r=0;r<Oi.length;r++)Ni(Oi[r],e);r=n;break;case"source":Ni("error",e),r=n;break;case"img":case"image":case"link":Ni("error",e),Ni("load",e),r=n;break;case"details":Ni("toggle",e),r=n;break;case"input":$(e,n),r=Z(e,n),Ni("invalid",e);break;case"option":default:r=n;break;case"select":e._wrapperState={wasMultiple:!!n.multiple},r=V({},n,{value:void 0}),Ni("invalid",e);break;case"textarea":re(e,n),r=ne(e,n),Ni("invalid",e)}for(o in ye(i,r),h=r)if(h.hasOwnProperty(o)){var c=h[o];"style"===o?ge(e,c):"dangerouslySetInnerHTML"===o?null!=(c=c?c.__html:void 0)&&ue(e,c):"children"===o?"string"==typeof c?("textarea"!==i||""!==c)&&pe(e,c):"number"==typeof c&&pe(e,""+c):"suppressContentEditableWarning"!==o&&"suppressHydrationWarning"!==o&&"autoFocus"!==o&&(a.hasOwnProperty(o)?null!=c&&"onScroll"===o&&Ni("scroll",e):null!=c&&b(e,o,c,l))}switch(i){case"input":K(e),ee(e,n,!1);break;case"textarea":K(e),oe(e);break;case"option":null!=n.value&&e.setAttribute("value",""+j(n.value));break;case"select":e.multiple=!!n.multiple,null!=(o=n.value)?ie(e,!!n.multiple,o,!1):null!=n.defaultValue&&ie(e,!!n.multiple,n.defaultValue,!0);break;default:"function"==typeof r.onClick&&(e.onclick=Ji)}switch(i){case"button":case"input":case"select":case"textarea":n=!!n.autoFocus;break e;case"img":n=!0;break e;default:n=!1}}n&&(t.flags|=4)}null!==t.ref&&(t.flags|=512,t.flags|=2097152)}return Xo(t),null;case 6:if(e&&null!=t.stateNode)zo(e,t,e.memoizedProps,n);else{if("string"!=typeof n&&null===t.stateNode)throw Error(s(166));if(i=ia(sa.current),ia(ea.current),ur(t)){if(n=t.stateNode,i=t.memoizedProps,n[pn]=t,(o=n.nodeValue!==i)&&null!==(e=ir))switch(e.tag){case 3:Qi(n.nodeValue,i,0!=(1&e.mode));break;case 5:!0!==e.memoizedProps.suppressHydrationWarning&&Qi(n.nodeValue,i,0!=(1&e.mode))}o&&(t.flags|=4)}else(n=(9===i.nodeType?i:i.ownerDocument).createTextNode(n))[pn]=t,t.stateNode=n}return Xo(t),null;case 13:if(An(la),n=t.memoizedState,null===e||null!==e.memoizedState&&null!==e.memoizedState.dehydrated){if(rr&&null!==nr&&0!=(1&t.mode)&&0==(128&t.flags))pr(),mr(),t.flags|=98560,o=!1;else if(o=ur(t),null!==n&&null!==n.dehydrated){if(null===e){if(!o)throw Error(s(318));if(!(o=null!==(o=t.memoizedState)?o.dehydrated:null))throw Error(s(317));o[pn]=t}else mr(),0==(128&t.flags)&&(t.memoizedState=null),t.flags|=4;Xo(t),o=!1}else null!==ar&&(lh(ar),ar=null),o=!0;if(!o)return 65536&t.flags?t:null}return 0!=(128&t.flags)?(t.lanes=i,t):((n=null!==n)!==(null!==e&&null!==e.memoizedState)&&n&&(t.child.flags|=8192,0!=(1&t.mode)&&(null===e||0!=(1&la.current)?0===zl&&(zl=3):gh())),null!==t.updateQueue&&(t.flags|=4),Xo(t),null);case 4:return ra(),Ro(e,t),null===e&&Hi(t.stateNode.containerInfo),Xo(t),null;case 10:return Sr(t.type._context),Xo(t),null;case 19:if(An(la),null===(o=t.memoizedState))return Xo(t),null;if(n=0!=(128&t.flags),null===(l=o.rendering))if(n)Ko(o,!1);else{if(0!==zl||null!==e&&0!=(128&e.flags))for(e=t.child;null!==e;){if(null!==(l=ha(e))){for(t.flags|=128,Ko(o,!1),null!==(n=l.updateQueue)&&(t.updateQueue=n,t.flags|=4),t.subtreeFlags=0,n=i,i=t.child;null!==i;)e=n,(o=i).flags&=14680066,null===(l=o.alternate)?(o.childLanes=0,o.lanes=e,o.child=null,o.subtreeFlags=0,o.memoizedProps=null,o.memoizedState=null,o.updateQueue=null,o.dependencies=null,o.stateNode=null):(o.childLanes=l.childLanes,o.lanes=l.lanes,o.child=l.child,o.subtreeFlags=0,o.deletions=null,o.memoizedProps=l.memoizedProps,o.memoizedState=l.memoizedState,o.updateQueue=l.updateQueue,o.type=l.type,e=l.dependencies,o.dependencies=null===e?null:{lanes:e.lanes,firstContext:e.firstContext}),i=i.sibling;return En(la,1&la.current|2),t.child}e=e.sibling}null!==o.tail&&Qe()>Gl&&(t.flags|=128,n=!0,Ko(o,!1),t.lanes=4194304)}else{if(!n)if(null!==(e=ha(l))){if(t.flags|=128,n=!0,null!==(i=e.updateQueue)&&(t.updateQueue=i,t.flags|=4),Ko(o,!0),null===o.tail&&"hidden"===o.tailMode&&!l.alternate&&!rr)return Xo(t),null}else 2*Qe()-o.renderingStartTime>Gl&&1073741824!==i&&(t.flags|=128,n=!0,Ko(o,!1),t.lanes=4194304);o.isBackwards?(l.sibling=t.child,t.child=l):(null!==(i=o.last)?i.sibling=l:t.child=l,o.last=l)}return null!==o.tail?(t=o.tail,o.rendering=t,o.tail=t.sibling,o.renderingStartTime=Qe(),t.sibling=null,i=la.current,En(la,n?1&i|2:1&i),t):(Xo(t),null);case 22:case 23:return ph(),n=null!==t.memoizedState,null!==e&&null!==e.memoizedState!==n&&(t.flags|=8192),n&&0!=(1&t.mode)?0!=(1073741824&Rl)&&(Xo(t),6&t.subtreeFlags&&(t.flags|=8192)):Xo(t),null;case 24:case 25:return null}throw Error(s(156,t.tag))}function Zo(e,t){switch(sr(t),t.tag){case 1:return In(t.type)&&Rn(),65536&(e=t.flags)?(t.flags=-65537&e|128,t):null;case 3:return ra(),An(Ln),An(Mn),da(),0!=(65536&(e=t.flags))&&0==(128&e)?(t.flags=-65537&e|128,t):null;case 5:return oa(t),null;case 13:if(An(la),null!==(e=t.memoizedState)&&null!==e.dehydrated){if(null===t.alternate)throw Error(s(340));mr()}return 65536&(e=t.flags)?(t.flags=-65537&e|128,t):null;case 19:return An(la),null;case 4:return ra(),null;case 10:return Sr(t.type._context),null;case 22:case 23:return ph(),null;default:return null}}Io=function(e,t){for(var s=t.child;null!==s;){if(5===s.tag||6===s.tag)e.appendChild(s.stateNode);else if(4!==s.tag&&null!==s.child){s.child.return=s,s=s.child;continue}if(s===t)break;for(;null===s.sibling;){if(null===s.return||s.return===t)return;s=s.return}s.sibling.return=s.return,s=s.sibling}},Ro=function(){},Oo=function(e,t,s,i){var n=e.memoizedProps;if(n!==i){e=t.stateNode,ia(ea.current);var r,o=null;switch(s){case"input":n=Z(e,n),i=Z(e,i),o=[];break;case"select":n=V({},n,{value:void 0}),i=V({},i,{value:void 0}),o=[];break;case"textarea":n=ne(e,n),i=ne(e,i),o=[];break;default:"function"!=typeof n.onClick&&"function"==typeof i.onClick&&(e.onclick=Ji)}for(c in ye(s,i),s=null,n)if(!i.hasOwnProperty(c)&&n.hasOwnProperty(c)&&null!=n[c])if("style"===c){var l=n[c];for(r in l)l.hasOwnProperty(r)&&(s||(s={}),s[r]="")}else"dangerouslySetInnerHTML"!==c&&"children"!==c&&"suppressContentEditableWarning"!==c&&"suppressHydrationWarning"!==c&&"autoFocus"!==c&&(a.hasOwnProperty(c)?o||(o=[]):(o=o||[]).push(c,null));for(c in i){var h=i[c];if(l=null!=n?n[c]:void 0,i.hasOwnProperty(c)&&h!==l&&(null!=h||null!=l))if("style"===c)if(l){for(r in l)!l.hasOwnProperty(r)||h&&h.hasOwnProperty(r)||(s||(s={}),s[r]="");for(r in h)h.hasOwnProperty(r)&&l[r]!==h[r]&&(s||(s={}),s[r]=h[r])}else s||(o||(o=[]),o.push(c,s)),s=h;else"dangerouslySetInnerHTML"===c?(h=h?h.__html:void 0,l=l?l.__html:void 0,null!=h&&l!==h&&(o=o||[]).push(c,h)):"children"===c?"string"!=typeof h&&"number"!=typeof h||(o=o||[]).push(c,""+h):"suppressContentEditableWarning"!==c&&"suppressHydrationWarning"!==c&&(a.hasOwnProperty(c)?(null!=h&&"onScroll"===c&&Ni("scroll",e),o||l===h||(o=[])):(o=o||[]).push(c,h))}s&&(o=o||[]).push("style",s);var c=o;(t.updateQueue=c)&&(t.flags|=4)}},zo=function(e,t,s,i){s!==i&&(t.flags|=4)};var $o=!1,Qo=!1,Jo="function"==typeof WeakSet?WeakSet:Set,el=null;function tl(e,t){var s=e.ref;if(null!==s)if("function"==typeof s)try{s(null)}catch(s){Ah(e,t,s)}else s.current=null}function sl(e,t,s){try{s()}catch(s){Ah(e,t,s)}}var il=!1;function nl(e,t,s){var i=t.updateQueue;if(null!==(i=null!==i?i.lastEffect:null)){var n=i=i.next;do{if((n.tag&e)===e){var r=n.destroy;n.destroy=void 0,void 0!==r&&sl(t,s,r)}n=n.next}while(n!==i)}}function rl(e,t){if(null!==(t=null!==(t=t.updateQueue)?t.lastEffect:null)){var s=t=t.next;do{if((s.tag&e)===e){var i=s.create;s.destroy=i()}s=s.next}while(s!==t)}}function al(e){var t=e.ref;if(null!==t){var s=e.stateNode;e.tag,e=s,"function"==typeof t?t(e):t.current=e}}function ol(e){var t=e.alternate;null!==t&&(e.alternate=null,ol(t)),e.child=null,e.deletions=null,e.sibling=null,5===e.tag&&(null!==(t=e.stateNode)&&(delete t[pn],delete t[mn],delete t[fn],delete t[gn],delete t[vn])),e.stateNode=null,e.return=null,e.dependencies=null,e.memoizedProps=null,e.memoizedState=null,e.pendingProps=null,e.stateNode=null,e.updateQueue=null}function ll(e){return 5===e.tag||3===e.tag||4===e.tag}function hl(e){e:for(;;){for(;null===e.sibling;){if(null===e.return||ll(e.return))return null;e=e.return}for(e.sibling.return=e.return,e=e.sibling;5!==e.tag&&6!==e.tag&&18!==e.tag;){if(2&e.flags)continue e;if(null===e.child||4===e.tag)continue e;e.child.return=e,e=e.child}if(!(2&e.flags))return e.stateNode}}function cl(e,t,s){var i=e.tag;if(5===i||6===i)e=e.stateNode,t?8===s.nodeType?s.parentNode.insertBefore(e,t):s.insertBefore(e,t):(8===s.nodeType?(t=s.parentNode).insertBefore(e,s):(t=s).appendChild(e),null!=(s=s._reactRootContainer)||null!==t.onclick||(t.onclick=Ji));else if(4!==i&&null!==(e=e.child))for(cl(e,t,s),e=e.sibling;null!==e;)cl(e,t,s),e=e.sibling}function dl(e,t,s){var i=e.tag;if(5===i||6===i)e=e.stateNode,t?s.insertBefore(e,t):s.appendChild(e);else if(4!==i&&null!==(e=e.child))for(dl(e,t,s),e=e.sibling;null!==e;)dl(e,t,s),e=e.sibling}var ul=null,pl=!1;function ml(e,t,s){for(s=s.child;null!==s;)_l(e,t,s),s=s.sibling}function _l(e,t,s){if(at&&"function"==typeof at.onCommitFiberUnmount)try{at.onCommitFiberUnmount(rt,s)}catch(e){}switch(s.tag){case 5:Qo||tl(s,t);case 6:var i=ul,n=pl;ul=null,ml(e,t,s),pl=n,null!==(ul=i)&&(pl?(e=ul,s=s.stateNode,8===e.nodeType?e.parentNode.removeChild(s):e.removeChild(s)):ul.removeChild(s.stateNode));break;case 18:null!==ul&&(pl?(e=ul,s=s.stateNode,8===e.nodeType?hn(e.parentNode,s):1===e.nodeType&&hn(e,s),Wt(e)):hn(ul,s.stateNode));break;case 4:i=ul,n=pl,ul=s.stateNode.containerInfo,pl=!0,ml(e,t,s),ul=i,pl=n;break;case 0:case 11:case 14:case 15:if(!Qo&&(null!==(i=s.updateQueue)&&null!==(i=i.lastEffect))){n=i=i.next;do{var r=n,a=r.destroy;r=r.tag,void 0!==a&&(0!=(2&r)||0!=(4&r))&&sl(s,t,a),n=n.next}while(n!==i)}ml(e,t,s);break;case 1:if(!Qo&&(tl(s,t),"function"==typeof(i=s.stateNode).componentWillUnmount))try{i.props=s.memoizedProps,i.state=s.memoizedState,i.componentWillUnmount()}catch(e){Ah(s,t,e)}ml(e,t,s);break;case 21:ml(e,t,s);break;case 22:1&s.mode?(Qo=(i=Qo)||null!==s.memoizedState,ml(e,t,s),Qo=i):ml(e,t,s);break;default:ml(e,t,s)}}function fl(e){var t=e.updateQueue;if(null!==t){e.updateQueue=null;var s=e.stateNode;null===s&&(s=e.stateNode=new Jo),t.forEach((function(t){var i=Lh.bind(null,e,t);s.has(t)||(s.add(t),t.then(i,i))}))}}function gl(e,t){var i=t.deletions;if(null!==i)for(var n=0;n<i.length;n++){var r=i[n];try{var a=e,o=t,l=o;e:for(;null!==l;){switch(l.tag){case 5:ul=l.stateNode,pl=!1;break e;case 3:case 4:ul=l.stateNode.containerInfo,pl=!0;break e}l=l.return}if(null===ul)throw Error(s(160));_l(a,o,r),ul=null,pl=!1;var h=r.alternate;null!==h&&(h.return=null),r.return=null}catch(e){Ah(r,t,e)}}if(12854&t.subtreeFlags)for(t=t.child;null!==t;)vl(t,e),t=t.sibling}function vl(e,t){var i=e.alternate,n=e.flags;switch(e.tag){case 0:case 11:case 14:case 15:if(gl(t,e),yl(e),4&n){try{nl(3,e,e.return),rl(3,e)}catch(t){Ah(e,e.return,t)}try{nl(5,e,e.return)}catch(t){Ah(e,e.return,t)}}break;case 1:gl(t,e),yl(e),512&n&&null!==i&&tl(i,i.return);break;case 5:if(gl(t,e),yl(e),512&n&&null!==i&&tl(i,i.return),32&e.flags){var r=e.stateNode;try{pe(r,"")}catch(t){Ah(e,e.return,t)}}if(4&n&&null!=(r=e.stateNode)){var a=e.memoizedProps,o=null!==i?i.memoizedProps:a,l=e.type,h=e.updateQueue;if(e.updateQueue=null,null!==h)try{"input"===l&&"radio"===a.type&&null!=a.name&&Q(r,a),be(l,o);var c=be(l,a);for(o=0;o<h.length;o+=2){var d=h[o],u=h[o+1];"style"===d?ge(r,u):"dangerouslySetInnerHTML"===d?ue(r,u):"children"===d?pe(r,u):b(r,d,u,c)}switch(l){case"input":J(r,a);break;case"textarea":ae(r,a);break;case"select":var p=r._wrapperState.wasMultiple;r._wrapperState.wasMultiple=!!a.multiple;var m=a.value;null!=m?ie(r,!!a.multiple,m,!1):p!==!!a.multiple&&(null!=a.defaultValue?ie(r,!!a.multiple,a.defaultValue,!0):ie(r,!!a.multiple,a.multiple?[]:"",!1))}r[mn]=a}catch(t){Ah(e,e.return,t)}}break;case 6:if(gl(t,e),yl(e),4&n){if(null===e.stateNode)throw Error(s(162));r=e.stateNode,a=e.memoizedProps;try{r.nodeValue=a}catch(t){Ah(e,e.return,t)}}break;case 3:if(gl(t,e),yl(e),4&n&&null!==i&&i.memoizedState.isDehydrated)try{Wt(t.containerInfo)}catch(t){Ah(e,e.return,t)}break;case 4:default:gl(t,e),yl(e);break;case 13:gl(t,e),yl(e),8192&(r=e.child).flags&&(a=null!==r.memoizedState,r.stateNode.isHidden=a,!a||null!==r.alternate&&null!==r.alternate.memoizedState||(Wl=Qe())),4&n&&fl(e);break;case 22:if(d=null!==i&&null!==i.memoizedState,1&e.mode?(Qo=(c=Qo)||d,gl(t,e),Qo=c):gl(t,e),yl(e),8192&n){if(c=null!==e.memoizedState,(e.stateNode.isHidden=c)&&!d&&0!=(1&e.mode))for(el=e,d=e.child;null!==d;){for(u=el=d;null!==el;){switch(m=(p=el).child,p.tag){case 0:case 11:case 14:case 15:nl(4,p,p.return);break;case 1:tl(p,p.return);var _=p.stateNode;if("function"==typeof _.componentWillUnmount){n=p,i=p.return;try{t=n,_.props=t.memoizedProps,_.state=t.memoizedState,_.componentWillUnmount()}catch(e){Ah(n,i,e)}}break;case 5:tl(p,p.return);break;case 22:if(null!==p.memoizedState){Sl(u);continue}}null!==m?(m.return=p,el=m):Sl(u)}d=d.sibling}e:for(d=null,u=e;;){if(5===u.tag){if(null===d){d=u;try{r=u.stateNode,c?"function"==typeof(a=r.style).setProperty?a.setProperty("display","none","important"):a.display="none":(l=u.stateNode,o=null!=(h=u.memoizedProps.style)&&h.hasOwnProperty("display")?h.display:null,l.style.display=fe("display",o))}catch(t){Ah(e,e.return,t)}}}else if(6===u.tag){if(null===d)try{u.stateNode.nodeValue=c?"":u.memoizedProps}catch(t){Ah(e,e.return,t)}}else if((22!==u.tag&&23!==u.tag||null===u.memoizedState||u===e)&&null!==u.child){u.child.return=u,u=u.child;continue}if(u===e)break e;for(;null===u.sibling;){if(null===u.return||u.return===e)break e;d===u&&(d=null),u=u.return}d===u&&(d=null),u.sibling.return=u.return,u=u.sibling}}break;case 19:gl(t,e),yl(e),4&n&&fl(e);case 21:}}function yl(e){var t=e.flags;if(2&t){try{e:{for(var i=e.return;null!==i;){if(ll(i)){var n=i;break e}i=i.return}throw Error(s(160))}switch(n.tag){case 5:var r=n.stateNode;32&n.flags&&(pe(r,""),n.flags&=-33),dl(e,hl(e),r);break;case 3:case 4:var a=n.stateNode.containerInfo;cl(e,hl(e),a);break;default:throw Error(s(161))}}catch(t){Ah(e,e.return,t)}e.flags&=-3}4096&t&&(e.flags&=-4097)}function bl(e,t,s){el=e,xl(e)}function xl(e,t,s){for(var i=0!=(1&e.mode);null!==el;){var n=el,r=n.child;if(22===n.tag&&i){var a=null!==n.memoizedState||$o;if(!a){var o=n.alternate,l=null!==o&&null!==o.memoizedState||Qo;o=$o;var h=Qo;if($o=a,(Qo=l)&&!h)for(el=n;null!==el;)l=(a=el).child,22===a.tag&&null!==a.memoizedState?Cl(n):null!==l?(l.return=a,el=l):Cl(n);for(;null!==r;)el=r,xl(r),r=r.sibling;el=n,$o=o,Qo=h}wl(e)}else 0!=(8772&n.subtreeFlags)&&null!==r?(r.return=n,el=r):wl(e)}}function wl(e){for(;null!==el;){var t=el;if(0!=(8772&t.flags)){var i=t.alternate;try{if(0!=(8772&t.flags))switch(t.tag){case 0:case 11:case 15:Qo||rl(5,t);break;case 1:var n=t.stateNode;if(4&t.flags&&!Qo)if(null===i)n.componentDidMount();else{var r=t.elementType===t.type?i.memoizedProps:gr(t.type,i.memoizedProps);n.componentDidUpdate(r,i.memoizedState,n.__reactInternalSnapshotBeforeUpdate)}var a=t.updateQueue;null!==a&&Nr(t,a,n);break;case 3:var o=t.updateQueue;if(null!==o){if(i=null,null!==t.child)switch(t.child.tag){case 5:case 1:i=t.child.stateNode}Nr(t,o,i)}break;case 5:var l=t.stateNode;if(null===i&&4&t.flags){i=l;var h=t.memoizedProps;switch(t.type){case"button":case"input":case"select":case"textarea":h.autoFocus&&i.focus();break;case"img":h.src&&(i.src=h.src)}}break;case 6:case 4:case 12:case 19:case 17:case 21:case 22:case 23:case 25:break;case 13:if(null===t.memoizedState){var c=t.alternate;if(null!==c){var d=c.memoizedState;if(null!==d){var u=d.dehydrated;null!==u&&Wt(u)}}}break;default:throw Error(s(163))}Qo||512&t.flags&&al(t)}catch(e){Ah(t,t.return,e)}}if(t===e){el=null;break}if(null!==(i=t.sibling)){i.return=t.return,el=i;break}el=t.return}}function Sl(e){for(;null!==el;){var t=el;if(t===e){el=null;break}var s=t.sibling;if(null!==s){s.return=t.return,el=s;break}el=t.return}}function Cl(e){for(;null!==el;){var t=el;try{switch(t.tag){case 0:case 11:case 15:var s=t.return;try{rl(4,t)}catch(e){Ah(t,s,e)}break;case 1:var i=t.stateNode;if("function"==typeof i.componentDidMount){var n=t.return;try{i.componentDidMount()}catch(e){Ah(t,n,e)}}var r=t.return;try{al(t)}catch(e){Ah(t,r,e)}break;case 5:var a=t.return;try{al(t)}catch(e){Ah(t,a,e)}}}catch(e){Ah(t,t.return,e)}if(t===e){el=null;break}var o=t.sibling;if(null!==o){o.return=t.return,el=o;break}el=t.return}}var Tl,Al=Math.ceil,El=x.ReactCurrentDispatcher,Pl=x.ReactCurrentOwner,Ml=x.ReactCurrentBatchConfig,Ll=0,Dl=null,kl=null,Il=0,Rl=0,Ol=Tn(0),zl=0,Fl=null,Vl=0,Nl=0,Bl=0,Ul=null,Hl=null,Wl=0,Gl=1/0,jl=null,ql=!1,Kl=null,Xl=null,Yl=!1,Zl=null,$l=0,Ql=0,Jl=null,eh=-1,th=0;function sh(){return 0!=(6&Ll)?Qe():-1!==eh?eh:eh=Qe()}function ih(e){return 0==(1&e.mode)?1:0!=(2&Ll)&&0!==Il?Il&-Il:null!==fr.transition?(0===th&&(th=ft()),th):0!==(e=bt)?e:e=void 0===(e=window.event)?16:$t(e.type)}function nh(e,t,i,n){if(50<Ql)throw Ql=0,Jl=null,Error(s(185));vt(e,i,n),0!=(2&Ll)&&e===Dl||(e===Dl&&(0==(2&Ll)&&(Nl|=i),4===zl&&hh(e,Il)),rh(e,n),1===i&&0===Ll&&0==(1&t.mode)&&(Gl=Qe()+500,Bn&&Wn()))}function rh(e,t){var s=e.callbackNode;!function(e,t){for(var s=e.suspendedLanes,i=e.pingedLanes,n=e.expirationTimes,r=e.pendingLanes;0<r;){var a=31-ot(r),o=1<<a,l=n[a];-1===l?0!=(o&s)&&0==(o&i)||(n[a]=mt(o,t)):l<=t&&(e.expiredLanes|=o),r&=~o}}(e,t);var i=pt(e,e===Dl?Il:0);if(0===i)null!==s&&Ye(s),e.callbackNode=null,e.callbackPriority=0;else if(t=i&-i,e.callbackPriority!==t){if(null!=s&&Ye(s),1===t)0===e.tag?function(e){Bn=!0,Hn(e)}(ch.bind(null,e)):Hn(ch.bind(null,e)),on((function(){0==(6&Ll)&&Wn()})),s=null;else{switch(xt(i)){case 1:s=et;break;case 4:s=tt;break;case 16:default:s=st;break;case 536870912:s=nt}s=Dh(s,ah.bind(null,e))}e.callbackPriority=t,e.callbackNode=s}}function ah(e,t){if(eh=-1,th=0,0!=(6&Ll))throw Error(s(327));var i=e.callbackNode;if(Ch()&&e.callbackNode!==i)return null;var n=pt(e,e===Dl?Il:0);if(0===n)return null;if(0!=(30&n)||0!=(n&e.expiredLanes)||t)t=vh(e,n);else{t=n;var r=Ll;Ll|=2;var a=fh();for(Dl===e&&Il===t||(jl=null,Gl=Qe()+500,mh(e,t));;)try{bh();break}catch(t){_h(e,t)}wr(),El.current=a,Ll=r,null!==kl?t=0:(Dl=null,Il=0,t=zl)}if(0!==t){if(2===t&&(0!==(r=_t(e))&&(n=r,t=oh(e,r))),1===t)throw i=Fl,mh(e,0),hh(e,n),rh(e,Qe()),i;if(6===t)hh(e,n);else{if(r=e.current.alternate,0==(30&n)&&!function(e){for(var t=e;;){if(16384&t.flags){var s=t.updateQueue;if(null!==s&&null!==(s=s.stores))for(var i=0;i<s.length;i++){var n=s[i],r=n.getSnapshot;n=n.value;try{if(!oi(r(),n))return!1}catch(e){return!1}}}if(s=t.child,16384&t.subtreeFlags&&null!==s)s.return=t,t=s;else{if(t===e)break;for(;null===t.sibling;){if(null===t.return||t.return===e)return!0;t=t.return}t.sibling.return=t.return,t=t.sibling}}return!0}(r)&&(2===(t=vh(e,n))&&(0!==(a=_t(e))&&(n=a,t=oh(e,a))),1===t))throw i=Fl,mh(e,0),hh(e,n),rh(e,Qe()),i;switch(e.finishedWork=r,e.finishedLanes=n,t){case 0:case 1:throw Error(s(345));case 2:case 5:Sh(e,Hl,jl);break;case 3:if(hh(e,n),(130023424&n)===n&&10<(t=Wl+500-Qe())){if(0!==pt(e,0))break;if(((r=e.suspendedLanes)&n)!==n){sh(),e.pingedLanes|=e.suspendedLanes&r;break}e.timeoutHandle=nn(Sh.bind(null,e,Hl,jl),t);break}Sh(e,Hl,jl);break;case 4:if(hh(e,n),(4194240&n)===n)break;for(t=e.eventTimes,r=-1;0<n;){var o=31-ot(n);a=1<<o,(o=t[o])>r&&(r=o),n&=~a}if(n=r,10<(n=(120>(n=Qe()-n)?120:480>n?480:1080>n?1080:1920>n?1920:3e3>n?3e3:4320>n?4320:1960*Al(n/1960))-n)){e.timeoutHandle=nn(Sh.bind(null,e,Hl,jl),n);break}Sh(e,Hl,jl);break;default:throw Error(s(329))}}}return rh(e,Qe()),e.callbackNode===i?ah.bind(null,e):null}function oh(e,t){var s=Ul;return e.current.memoizedState.isDehydrated&&(mh(e,t).flags|=256),2!==(e=vh(e,t))&&(t=Hl,Hl=s,null!==t&&lh(t)),e}function lh(e){null===Hl?Hl=e:Hl.push.apply(Hl,e)}function hh(e,t){for(t&=~Bl,t&=~Nl,e.suspendedLanes|=t,e.pingedLanes&=~t,e=e.expirationTimes;0<t;){var s=31-ot(t),i=1<<s;e[s]=-1,t&=~i}}function ch(e){if(0!=(6&Ll))throw Error(s(327));Ch();var t=pt(e,0);if(0==(1&t))return rh(e,Qe()),null;var i=vh(e,t);if(0!==e.tag&&2===i){var n=_t(e);0!==n&&(t=n,i=oh(e,n))}if(1===i)throw i=Fl,mh(e,0),hh(e,t),rh(e,Qe()),i;if(6===i)throw Error(s(345));return e.finishedWork=e.current.alternate,e.finishedLanes=t,Sh(e,Hl,jl),rh(e,Qe()),null}function dh(e,t){var s=Ll;Ll|=1;try{return e(t)}finally{0===(Ll=s)&&(Gl=Qe()+500,Bn&&Wn())}}function uh(e){null!==Zl&&0===Zl.tag&&0==(6&Ll)&&Ch();var t=Ll;Ll|=1;var s=Ml.transition,i=bt;try{if(Ml.transition=null,bt=1,e)return e()}finally{bt=i,Ml.transition=s,0==(6&(Ll=t))&&Wn()}}function ph(){Rl=Ol.current,An(Ol)}function mh(e,t){e.finishedWork=null,e.finishedLanes=0;var s=e.timeoutHandle;if(-1!==s&&(e.timeoutHandle=-1,rn(s)),null!==kl)for(s=kl.return;null!==s;){var i=s;switch(sr(i),i.tag){case 1:null!=(i=i.type.childContextTypes)&&Rn();break;case 3:ra(),An(Ln),An(Mn),da();break;case 5:oa(i);break;case 4:ra();break;case 13:case 19:An(la);break;case 10:Sr(i.type._context);break;case 22:case 23:ph()}s=s.return}if(Dl=e,kl=e=Oh(e.current,null),Il=Rl=t,zl=0,Fl=null,Bl=Nl=Vl=0,Hl=Ul=null,null!==Er){for(t=0;t<Er.length;t++)if(null!==(i=(s=Er[t]).interleaved)){s.interleaved=null;var n=i.next,r=s.pending;if(null!==r){var a=r.next;r.next=n,i.next=a}s.pending=i}Er=null}return e}function _h(e,t){for(;;){var i=kl;try{if(wr(),ua.current=ao,va){for(var n=_a.memoizedState;null!==n;){var r=n.queue;null!==r&&(r.pending=null),n=n.next}va=!1}if(ma=0,ga=fa=_a=null,ya=!1,ba=0,Pl.current=null,null===i||null===i.return){zl=1,Fl=t,kl=null;break}e:{var a=e,o=i.return,l=i,h=t;if(t=Il,l.flags|=32768,null!==h&&"object"==typeof h&&"function"==typeof h.then){var c=h,d=l,u=d.tag;if(0==(1&d.mode)&&(0===u||11===u||15===u)){var p=d.alternate;p?(d.updateQueue=p.updateQueue,d.memoizedState=p.memoizedState,d.lanes=p.lanes):(d.updateQueue=null,d.memoizedState=null)}var m=vo(o);if(null!==m){m.flags&=-257,yo(m,o,l,0,t),1&m.mode&&go(a,c,t),h=c;var _=(t=m).updateQueue;if(null===_){var f=new Set;f.add(h),t.updateQueue=f}else _.add(h);break e}if(0==(1&t)){go(a,c,t),gh();break e}h=Error(s(426))}else if(rr&&1&l.mode){var g=vo(o);if(null!==g){0==(65536&g.flags)&&(g.flags|=256),yo(g,o,l,0,t),_r(co(h,l));break e}}a=h=co(h,l),4!==zl&&(zl=2),null===Ul?Ul=[a]:Ul.push(a),a=o;do{switch(a.tag){case 3:a.flags|=65536,t&=-t,a.lanes|=t,Fr(a,_o(0,h,t));break e;case 1:l=h;var v=a.type,y=a.stateNode;if(0==(128&a.flags)&&("function"==typeof v.getDerivedStateFromError||null!==y&&"function"==typeof y.componentDidCatch&&(null===Xl||!Xl.has(y)))){a.flags|=65536,t&=-t,a.lanes|=t,Fr(a,fo(a,l,t));break e}}a=a.return}while(null!==a)}wh(i)}catch(e){t=e,kl===i&&null!==i&&(kl=i=i.return);continue}break}}function fh(){var e=El.current;return El.current=ao,null===e?ao:e}function gh(){0!==zl&&3!==zl&&2!==zl||(zl=4),null===Dl||0==(268435455&Vl)&&0==(268435455&Nl)||hh(Dl,Il)}function vh(e,t){var i=Ll;Ll|=2;var n=fh();for(Dl===e&&Il===t||(jl=null,mh(e,t));;)try{yh();break}catch(t){_h(e,t)}if(wr(),Ll=i,El.current=n,null!==kl)throw Error(s(261));return Dl=null,Il=0,zl}function yh(){for(;null!==kl;)xh(kl)}function bh(){for(;null!==kl&&!Ze();)xh(kl)}function xh(e){var t=Tl(e.alternate,e,Rl);e.memoizedProps=e.pendingProps,null===t?wh(e):kl=t,Pl.current=null}function wh(e){var t=e;do{var s=t.alternate;if(e=t.return,0==(32768&t.flags)){if(null!==(s=Yo(s,t,Rl)))return void(kl=s)}else{if(null!==(s=Zo(s,t)))return s.flags&=32767,void(kl=s);if(null===e)return zl=6,void(kl=null);e.flags|=32768,e.subtreeFlags=0,e.deletions=null}if(null!==(t=t.sibling))return void(kl=t);kl=t=e}while(null!==t);0===zl&&(zl=5)}function Sh(e,t,i){var n=bt,r=Ml.transition;try{Ml.transition=null,bt=1,function(e,t,i,n){do{Ch()}while(null!==Zl);if(0!=(6&Ll))throw Error(s(327));i=e.finishedWork;var r=e.finishedLanes;if(null===i)return null;if(e.finishedWork=null,e.finishedLanes=0,i===e.current)throw Error(s(177));e.callbackNode=null,e.callbackPriority=0;var a=i.lanes|i.childLanes;if(function(e,t){var s=e.pendingLanes&~t;e.pendingLanes=t,e.suspendedLanes=0,e.pingedLanes=0,e.expiredLanes&=t,e.mutableReadLanes&=t,e.entangledLanes&=t,t=e.entanglements;var i=e.eventTimes;for(e=e.expirationTimes;0<s;){var n=31-ot(s),r=1<<n;t[n]=0,i[n]=-1,e[n]=-1,s&=~r}}(e,a),e===Dl&&(kl=Dl=null,Il=0),0==(2064&i.subtreeFlags)&&0==(2064&i.flags)||Yl||(Yl=!0,Dh(st,(function(){return Ch(),null}))),a=0!=(15990&i.flags),0!=(15990&i.subtreeFlags)||a){a=Ml.transition,Ml.transition=null;var o=bt;bt=1;var l=Ll;Ll|=4,Pl.current=null,function(e,t){if(en=jt,pi(e=ui())){if("selectionStart"in e)var i={start:e.selectionStart,end:e.selectionEnd};else e:{var n=(i=(i=e.ownerDocument)&&i.defaultView||window).getSelection&&i.getSelection();if(n&&0!==n.rangeCount){i=n.anchorNode;var r=n.anchorOffset,a=n.focusNode;n=n.focusOffset;try{i.nodeType,a.nodeType}catch(e){i=null;break e}var o=0,l=-1,h=-1,c=0,d=0,u=e,p=null;t:for(;;){for(var m;u!==i||0!==r&&3!==u.nodeType||(l=o+r),u!==a||0!==n&&3!==u.nodeType||(h=o+n),3===u.nodeType&&(o+=u.nodeValue.length),null!==(m=u.firstChild);)p=u,u=m;for(;;){if(u===e)break t;if(p===i&&++c===r&&(l=o),p===a&&++d===n&&(h=o),null!==(m=u.nextSibling))break;p=(u=p).parentNode}u=m}i=-1===l||-1===h?null:{start:l,end:h}}else i=null}i=i||{start:0,end:0}}else i=null;for(tn={focusedElem:e,selectionRange:i},jt=!1,el=t;null!==el;)if(e=(t=el).child,0!=(1028&t.subtreeFlags)&&null!==e)e.return=t,el=e;else for(;null!==el;){t=el;try{var _=t.alternate;if(0!=(1024&t.flags))switch(t.tag){case 0:case 11:case 15:case 5:case 6:case 4:case 17:break;case 1:if(null!==_){var f=_.memoizedProps,g=_.memoizedState,v=t.stateNode,y=v.getSnapshotBeforeUpdate(t.elementType===t.type?f:gr(t.type,f),g);v.__reactInternalSnapshotBeforeUpdate=y}break;case 3:var b=t.stateNode.containerInfo;1===b.nodeType?b.textContent="":9===b.nodeType&&b.documentElement&&b.removeChild(b.documentElement);break;default:throw Error(s(163))}}catch(e){Ah(t,t.return,e)}if(null!==(e=t.sibling)){e.return=t.return,el=e;break}el=t.return}_=il,il=!1}(e,i),vl(i,e),mi(tn),jt=!!en,tn=en=null,e.current=i,bl(i),$e(),Ll=l,bt=o,Ml.transition=a}else e.current=i;if(Yl&&(Yl=!1,Zl=e,$l=r),a=e.pendingLanes,0===a&&(Xl=null),function(e){if(at&&"function"==typeof at.onCommitFiberRoot)try{at.onCommitFiberRoot(rt,e,void 0,128==(128&e.current.flags))}catch(e){}}(i.stateNode),rh(e,Qe()),null!==t)for(n=e.onRecoverableError,i=0;i<t.length;i++)r=t[i],n(r.value,{componentStack:r.stack,digest:r.digest});if(ql)throw ql=!1,e=Kl,Kl=null,e;0!=(1&$l)&&0!==e.tag&&Ch(),a=e.pendingLanes,0!=(1&a)?e===Jl?Ql++:(Ql=0,Jl=e):Ql=0,Wn()}(e,t,i,n)}finally{Ml.transition=r,bt=n}return null}function Ch(){if(null!==Zl){var e=xt($l),t=Ml.transition,i=bt;try{if(Ml.transition=null,bt=16>e?16:e,null===Zl)var n=!1;else{if(e=Zl,Zl=null,$l=0,0!=(6&Ll))throw Error(s(331));var r=Ll;for(Ll|=4,el=e.current;null!==el;){var a=el,o=a.child;if(0!=(16&el.flags)){var l=a.deletions;if(null!==l){for(var h=0;h<l.length;h++){var c=l[h];for(el=c;null!==el;){var d=el;switch(d.tag){case 0:case 11:case 15:nl(8,d,a)}var u=d.child;if(null!==u)u.return=d,el=u;else for(;null!==el;){var p=(d=el).sibling,m=d.return;if(ol(d),d===c){el=null;break}if(null!==p){p.return=m,el=p;break}el=m}}}var _=a.alternate;if(null!==_){var f=_.child;if(null!==f){_.child=null;do{var g=f.sibling;f.sibling=null,f=g}while(null!==f)}}el=a}}if(0!=(2064&a.subtreeFlags)&&null!==o)o.return=a,el=o;else e:for(;null!==el;){if(0!=(2048&(a=el).flags))switch(a.tag){case 0:case 11:case 15:nl(9,a,a.return)}var v=a.sibling;if(null!==v){v.return=a.return,el=v;break e}el=a.return}}var y=e.current;for(el=y;null!==el;){var b=(o=el).child;if(0!=(2064&o.subtreeFlags)&&null!==b)b.return=o,el=b;else e:for(o=y;null!==el;){if(0!=(2048&(l=el).flags))try{switch(l.tag){case 0:case 11:case 15:rl(9,l)}}catch(e){Ah(l,l.return,e)}if(l===o){el=null;break e}var x=l.sibling;if(null!==x){x.return=l.return,el=x;break e}el=l.return}}if(Ll=r,Wn(),at&&"function"==typeof at.onPostCommitFiberRoot)try{at.onPostCommitFiberRoot(rt,e)}catch(e){}n=!0}return n}finally{bt=i,Ml.transition=t}}return!1}function Th(e,t,s){e=Or(e,t=_o(0,t=co(s,t),1),1),t=sh(),null!==e&&(vt(e,1,t),rh(e,t))}function Ah(e,t,s){if(3===e.tag)Th(e,e,s);else for(;null!==t;){if(3===t.tag){Th(t,e,s);break}if(1===t.tag){var i=t.stateNode;if("function"==typeof t.type.getDerivedStateFromError||"function"==typeof i.componentDidCatch&&(null===Xl||!Xl.has(i))){t=Or(t,e=fo(t,e=co(s,e),1),1),e=sh(),null!==t&&(vt(t,1,e),rh(t,e));break}}t=t.return}}function Eh(e,t,s){var i=e.pingCache;null!==i&&i.delete(t),t=sh(),e.pingedLanes|=e.suspendedLanes&s,Dl===e&&(Il&s)===s&&(4===zl||3===zl&&(130023424&Il)===Il&&500>Qe()-Wl?mh(e,0):Bl|=s),rh(e,t)}function Ph(e,t){0===t&&(0==(1&e.mode)?t=1:(t=dt,0==(130023424&(dt<<=1))&&(dt=4194304)));var s=sh();null!==(e=Lr(e,t))&&(vt(e,t,s),rh(e,s))}function Mh(e){var t=e.memoizedState,s=0;null!==t&&(s=t.retryLane),Ph(e,s)}function Lh(e,t){var i=0;switch(e.tag){case 13:var n=e.stateNode,r=e.memoizedState;null!==r&&(i=r.retryLane);break;case 19:n=e.stateNode;break;default:throw Error(s(314))}null!==n&&n.delete(t),Ph(e,i)}function Dh(e,t){return Xe(e,t)}function kh(e,t,s,i){this.tag=e,this.key=s,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=t,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=i,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function Ih(e,t,s,i){return new kh(e,t,s,i)}function Rh(e){return!(!(e=e.prototype)||!e.isReactComponent)}function Oh(e,t){var s=e.alternate;return null===s?((s=Ih(e.tag,t,e.key,e.mode)).elementType=e.elementType,s.type=e.type,s.stateNode=e.stateNode,s.alternate=e,e.alternate=s):(s.pendingProps=t,s.type=e.type,s.flags=0,s.subtreeFlags=0,s.deletions=null),s.flags=14680064&e.flags,s.childLanes=e.childLanes,s.lanes=e.lanes,s.child=e.child,s.memoizedProps=e.memoizedProps,s.memoizedState=e.memoizedState,s.updateQueue=e.updateQueue,t=e.dependencies,s.dependencies=null===t?null:{lanes:t.lanes,firstContext:t.firstContext},s.sibling=e.sibling,s.index=e.index,s.ref=e.ref,s}function zh(e,t,i,n,r,a){var o=2;if(n=e,"function"==typeof e)Rh(e)&&(o=1);else if("string"==typeof e)o=5;else e:switch(e){case C:return Fh(i.children,r,a,t);case T:o=8,r|=8;break;case A:return(e=Ih(12,i,t,2|r)).elementType=A,e.lanes=a,e;case L:return(e=Ih(13,i,t,r)).elementType=L,e.lanes=a,e;case D:return(e=Ih(19,i,t,r)).elementType=D,e.lanes=a,e;case R:return Vh(i,r,a,t);default:if("object"==typeof e&&null!==e)switch(e.$$typeof){case E:o=10;break e;case P:o=9;break e;case M:o=11;break e;case k:o=14;break e;case I:o=16,n=null;break e}throw Error(s(130,null==e?e:typeof e,""))}return(t=Ih(o,i,t,r)).elementType=e,t.type=n,t.lanes=a,t}function Fh(e,t,s,i){return(e=Ih(7,e,i,t)).lanes=s,e}function Vh(e,t,s,i){return(e=Ih(22,e,i,t)).elementType=R,e.lanes=s,e.stateNode={isHidden:!1},e}function Nh(e,t,s){return(e=Ih(6,e,null,t)).lanes=s,e}function Bh(e,t,s){return(t=Ih(4,null!==e.children?e.children:[],e.key,t)).lanes=s,t.stateNode={containerInfo:e.containerInfo,pendingChildren:null,implementation:e.implementation},t}function Uh(e,t,s,i,n){this.tag=t,this.containerInfo=e,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=gt(0),this.expirationTimes=gt(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=gt(0),this.identifierPrefix=i,this.onRecoverableError=n,this.mutableSourceEagerHydrationData=null}function Hh(e,t,s,i,n,r,a,o,l){return e=new Uh(e,t,s,o,l),1===t?(t=1,!0===r&&(t|=8)):t=0,r=Ih(3,null,null,t),e.current=r,r.stateNode=e,r.memoizedState={element:i,isDehydrated:s,cache:null,transitions:null,pendingSuspenseBoundaries:null},kr(r),e}function Wh(e){if(!e)return Pn;e:{if(We(e=e._reactInternals)!==e||1!==e.tag)throw Error(s(170));var t=e;do{switch(t.tag){case 3:t=t.stateNode.context;break e;case 1:if(In(t.type)){t=t.stateNode.__reactInternalMemoizedMergedChildContext;break e}}t=t.return}while(null!==t);throw Error(s(171))}if(1===e.tag){var i=e.type;if(In(i))return zn(e,i,t)}return t}function Gh(e,t,s,i,n,r,a,o,l){return(e=Hh(s,i,!0,e,0,r,0,o,l)).context=Wh(null),s=e.current,(r=Rr(i=sh(),n=ih(s))).callback=null!=t?t:null,Or(s,r,n),e.current.lanes=n,vt(e,n,i),rh(e,i),e}function jh(e,t,s,i){var n=t.current,r=sh(),a=ih(n);return s=Wh(s),null===t.context?t.context=s:t.pendingContext=s,(t=Rr(r,a)).payload={element:e},null!==(i=void 0===i?null:i)&&(t.callback=i),null!==(e=Or(n,t,a))&&(nh(e,n,a,r),zr(e,n,a)),a}function qh(e){return(e=e.current).child?(e.child.tag,e.child.stateNode):null}function Kh(e,t){if(null!==(e=e.memoizedState)&&null!==e.dehydrated){var s=e.retryLane;e.retryLane=0!==s&&s<t?s:t}}function Xh(e,t){Kh(e,t),(e=e.alternate)&&Kh(e,t)}Tl=function(e,t,i){if(null!==e)if(e.memoizedProps!==t.pendingProps||Ln.current)xo=!0;else{if(0==(e.lanes&i)&&0==(128&t.flags))return xo=!1,function(e,t,s){switch(t.tag){case 3:Do(t),mr();break;case 5:aa(t);break;case 1:In(t.type)&&Fn(t);break;case 4:na(t,t.stateNode.containerInfo);break;case 10:var i=t.type._context,n=t.memoizedProps.value;En(vr,i._currentValue),i._currentValue=n;break;case 13:if(null!==(i=t.memoizedState))return null!==i.dehydrated?(En(la,1&la.current),t.flags|=128,null):0!=(s&t.child.childLanes)?No(e,t,s):(En(la,1&la.current),null!==(e=qo(e,t,s))?e.sibling:null);En(la,1&la.current);break;case 19:if(i=0!=(s&t.childLanes),0!=(128&e.flags)){if(i)return Go(e,t,s);t.flags|=128}if(null!==(n=t.memoizedState)&&(n.rendering=null,n.tail=null,n.lastEffect=null),En(la,la.current),i)break;return null;case 22:case 23:return t.lanes=0,Ao(e,t,s)}return qo(e,t,s)}(e,t,i);xo=0!=(131072&e.flags)}else xo=!1,rr&&0!=(1048576&t.flags)&&er(t,Kn,t.index);switch(t.lanes=0,t.tag){case 2:var n=t.type;jo(e,t),e=t.pendingProps;var r=kn(t,Mn.current);Tr(t,i),r=Ca(null,t,n,e,r,i);var a=Ta();return t.flags|=1,"object"==typeof r&&null!==r&&"function"==typeof r.render&&void 0===r.$$typeof?(t.tag=1,t.memoizedState=null,t.updateQueue=null,In(n)?(a=!0,Fn(t)):a=!1,t.memoizedState=null!==r.state&&void 0!==r.state?r.state:null,kr(t),r.updater=Hr,t.stateNode=r,r._reactInternals=t,qr(t,n,e,i),t=Lo(null,t,n,!0,a,i)):(t.tag=0,rr&&a&&tr(t),wo(null,t,r,i),t=t.child),t;case 16:n=t.elementType;e:{switch(jo(e,t),e=t.pendingProps,n=(r=n._init)(n._payload),t.type=n,r=t.tag=function(e){if("function"==typeof e)return Rh(e)?1:0;if(null!=e){if((e=e.$$typeof)===M)return 11;if(e===k)return 14}return 2}(n),e=gr(n,e),r){case 0:t=Po(null,t,n,e,i);break e;case 1:t=Mo(null,t,n,e,i);break e;case 11:t=So(null,t,n,e,i);break e;case 14:t=Co(null,t,n,gr(n.type,e),i);break e}throw Error(s(306,n,""))}return t;case 0:return n=t.type,r=t.pendingProps,Po(e,t,n,r=t.elementType===n?r:gr(n,r),i);case 1:return n=t.type,r=t.pendingProps,Mo(e,t,n,r=t.elementType===n?r:gr(n,r),i);case 3:e:{if(Do(t),null===e)throw Error(s(387));n=t.pendingProps,r=(a=t.memoizedState).element,Ir(e,t),Vr(t,n,null,i);var o=t.memoizedState;if(n=o.element,a.isDehydrated){if(a={element:n,isDehydrated:!1,cache:o.cache,pendingSuspenseBoundaries:o.pendingSuspenseBoundaries,transitions:o.transitions},t.updateQueue.baseState=a,t.memoizedState=a,256&t.flags){t=ko(e,t,n,i,r=co(Error(s(423)),t));break e}if(n!==r){t=ko(e,t,n,i,r=co(Error(s(424)),t));break e}for(nr=cn(t.stateNode.containerInfo.firstChild),ir=t,rr=!0,ar=null,i=Qr(t,null,n,i),t.child=i;i;)i.flags=-3&i.flags|4096,i=i.sibling}else{if(mr(),n===r){t=qo(e,t,i);break e}wo(e,t,n,i)}t=t.child}return t;case 5:return aa(t),null===e&&cr(t),n=t.type,r=t.pendingProps,a=null!==e?e.memoizedProps:null,o=r.children,sn(n,r)?o=null:null!==a&&sn(n,a)&&(t.flags|=32),Eo(e,t),wo(e,t,o,i),t.child;case 6:return null===e&&cr(t),null;case 13:return No(e,t,i);case 4:return na(t,t.stateNode.containerInfo),n=t.pendingProps,null===e?t.child=$r(t,null,n,i):wo(e,t,n,i),t.child;case 11:return n=t.type,r=t.pendingProps,So(e,t,n,r=t.elementType===n?r:gr(n,r),i);case 7:return wo(e,t,t.pendingProps,i),t.child;case 8:case 12:return wo(e,t,t.pendingProps.children,i),t.child;case 10:e:{if(n=t.type._context,r=t.pendingProps,a=t.memoizedProps,o=r.value,En(vr,n._currentValue),n._currentValue=o,null!==a)if(oi(a.value,o)){if(a.children===r.children&&!Ln.current){t=qo(e,t,i);break e}}else for(null!==(a=t.child)&&(a.return=t);null!==a;){var l=a.dependencies;if(null!==l){o=a.child;for(var h=l.firstContext;null!==h;){if(h.context===n){if(1===a.tag){(h=Rr(-1,i&-i)).tag=2;var c=a.updateQueue;if(null!==c){var d=(c=c.shared).pending;null===d?h.next=h:(h.next=d.next,d.next=h),c.pending=h}}a.lanes|=i,null!==(h=a.alternate)&&(h.lanes|=i),Cr(a.return,i,t),l.lanes|=i;break}h=h.next}}else if(10===a.tag)o=a.type===t.type?null:a.child;else if(18===a.tag){if(null===(o=a.return))throw Error(s(341));o.lanes|=i,null!==(l=o.alternate)&&(l.lanes|=i),Cr(o,i,t),o=a.sibling}else o=a.child;if(null!==o)o.return=a;else for(o=a;null!==o;){if(o===t){o=null;break}if(null!==(a=o.sibling)){a.return=o.return,o=a;break}o=o.return}a=o}wo(e,t,r.children,i),t=t.child}return t;case 9:return r=t.type,n=t.pendingProps.children,Tr(t,i),n=n(r=Ar(r)),t.flags|=1,wo(e,t,n,i),t.child;case 14:return r=gr(n=t.type,t.pendingProps),Co(e,t,n,r=gr(n.type,r),i);case 15:return To(e,t,t.type,t.pendingProps,i);case 17:return n=t.type,r=t.pendingProps,r=t.elementType===n?r:gr(n,r),jo(e,t),t.tag=1,In(n)?(e=!0,Fn(t)):e=!1,Tr(t,i),Gr(t,n,r),qr(t,n,r,i),Lo(null,t,n,!0,e,i);case 19:return Go(e,t,i);case 22:return Ao(e,t,i)}throw Error(s(156,t.tag))};var Yh="function"==typeof reportError?reportError:function(e){console.error(e)};function Zh(e){this._internalRoot=e}function $h(e){this._internalRoot=e}function Qh(e){return!(!e||1!==e.nodeType&&9!==e.nodeType&&11!==e.nodeType)}function Jh(e){return!(!e||1!==e.nodeType&&9!==e.nodeType&&11!==e.nodeType&&(8!==e.nodeType||" react-mount-point-unstable "!==e.nodeValue))}function ec(){}function tc(e,t,s,i,n){var r=s._reactRootContainer;if(r){var a=r;if("function"==typeof n){var o=n;n=function(){var e=qh(a);o.call(e)}}jh(t,a,e,n)}else a=function(e,t,s,i,n){if(n){if("function"==typeof i){var r=i;i=function(){var e=qh(a);r.call(e)}}var a=Gh(t,i,e,0,null,!1,0,"",ec);return e._reactRootContainer=a,e[_n]=a.current,Hi(8===e.nodeType?e.parentNode:e),uh(),a}for(;n=e.lastChild;)e.removeChild(n);if("function"==typeof i){var o=i;i=function(){var e=qh(l);o.call(e)}}var l=Hh(e,0,!1,null,0,!1,0,"",ec);return e._reactRootContainer=l,e[_n]=l.current,Hi(8===e.nodeType?e.parentNode:e),uh((function(){jh(t,l,s,i)})),l}(s,t,e,n,i);return qh(a)}$h.prototype.render=Zh.prototype.render=function(e){var t=this._internalRoot;if(null===t)throw Error(s(409));jh(e,t,null,null)},$h.prototype.unmount=Zh.prototype.unmount=function(){var e=this._internalRoot;if(null!==e){this._internalRoot=null;var t=e.containerInfo;uh((function(){jh(null,e,null,null)})),t[_n]=null}},$h.prototype.unstable_scheduleHydration=function(e){if(e){var t=Tt();e={blockedOn:null,target:e,priority:t};for(var s=0;s<Rt.length&&0!==t&&t<Rt[s].priority;s++);Rt.splice(s,0,e),0===s&&Vt(e)}},wt=function(e){switch(e.tag){case 3:var t=e.stateNode;if(t.current.memoizedState.isDehydrated){var s=ut(t.pendingLanes);0!==s&&(yt(t,1|s),rh(t,Qe()),0==(6&Ll)&&(Gl=Qe()+500,Wn()))}break;case 13:uh((function(){var t=Lr(e,1);if(null!==t){var s=sh();nh(t,e,1,s)}})),Xh(e,1)}},St=function(e){if(13===e.tag){var t=Lr(e,134217728);if(null!==t)nh(t,e,134217728,sh());Xh(e,134217728)}},Ct=function(e){if(13===e.tag){var t=ih(e),s=Lr(e,t);if(null!==s)nh(s,e,t,sh());Xh(e,t)}},Tt=function(){return bt},At=function(e,t){var s=bt;try{return bt=e,t()}finally{bt=s}},Se=function(e,t,i){switch(t){case"input":if(J(e,i),t=i.name,"radio"===i.type&&null!=t){for(i=e;i.parentNode;)i=i.parentNode;for(i=i.querySelectorAll("input[name="+JSON.stringify(""+t)+'][type="radio"]'),t=0;t<i.length;t++){var n=i[t];if(n!==e&&n.form===e.form){var r=wn(n);if(!r)throw Error(s(90));X(n),J(n,r)}}}break;case"textarea":ae(e,i);break;case"select":null!=(t=i.value)&&ie(e,!!i.multiple,t,!1)}},Me=dh,Le=uh;var sc={usingClientEntryPoint:!1,Events:[bn,xn,wn,Ee,Pe,dh]},ic={findFiberByHostInstance:yn,bundleType:0,version:"18.2.0",rendererPackageName:"react-dom"},nc={bundleType:ic.bundleType,version:ic.version,rendererPackageName:ic.rendererPackageName,rendererConfig:ic.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:x.ReactCurrentDispatcher,findHostInstanceByFiber:function(e){return null===(e=qe(e))?null:e.stateNode},findFiberByHostInstance:ic.findFiberByHostInstance||function(){return null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.2.0-next-9e3b772b8-20220608"};if("undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__){var rc=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!rc.isDisabled&&rc.supportsFiber)try{rt=rc.inject(nc),at=rc}catch(de){}}return i.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=sc,i.createPortal=function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;if(!Qh(t))throw Error(s(200));return function(e,t,s){var i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:S,key:null==i?null:""+i,children:e,containerInfo:t,implementation:s}}(e,t,null,i)},i.createRoot=function(e,t){if(!Qh(e))throw Error(s(299));var i=!1,n="",r=Yh;return null!=t&&(!0===t.unstable_strictMode&&(i=!0),void 0!==t.identifierPrefix&&(n=t.identifierPrefix),void 0!==t.onRecoverableError&&(r=t.onRecoverableError)),t=Hh(e,1,!1,null,0,i,0,n,r),e[_n]=t.current,Hi(8===e.nodeType?e.parentNode:e),new Zh(t)},i.findDOMNode=function(e){if(null==e)return null;if(1===e.nodeType)return e;var t=e._reactInternals;if(void 0===t){if("function"==typeof e.render)throw Error(s(188));throw e=Object.keys(e).join(","),Error(s(268,e))}return e=null===(e=qe(t))?null:e.stateNode},i.flushSync=function(e){return uh(e)},i.hydrate=function(e,t,i){if(!Jh(t))throw Error(s(200));return tc(null,e,t,!0,i)},i.hydrateRoot=function(e,t,i){if(!Qh(e))throw Error(s(405));var n=null!=i&&i.hydratedSources||null,r=!1,a="",o=Yh;if(null!=i&&(!0===i.unstable_strictMode&&(r=!0),void 0!==i.identifierPrefix&&(a=i.identifierPrefix),void 0!==i.onRecoverableError&&(o=i.onRecoverableError)),t=Gh(t,null,e,1,null!=i?i:null,r,0,a,o),e[_n]=t.current,Hi(e),n)for(e=0;e<n.length;e++)r=(r=(i=n[e])._getVersion)(i._source),null==t.mutableSourceEagerHydrationData?t.mutableSourceEagerHydrationData=[i,r]:t.mutableSourceEagerHydrationData.push(i,r);return new $h(t)},i.render=function(e,t,i){if(!Jh(t))throw Error(s(200));return tc(null,e,t,!1,i)},i.unmountComponentAtNode=function(e){if(!Jh(e))throw Error(s(40));return!!e._reactRootContainer&&(uh((function(){tc(null,null,e,!1,(function(){e._reactRootContainer=null,e[_n]=null}))})),!0)},i.unstable_batchedUpdates=dh,i.unstable_renderSubtreeIntoContainer=function(e,t,i,n){if(!Jh(i))throw Error(s(200));if(null==e||void 0===e._reactInternals)throw Error(s(38));return tc(e,t,i,!1,n)},i.version="18.2.0-next-9e3b772b8-20220608",i}!function(e){!function e(){if("undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE)try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(e)}catch(e){console.error(e)}}(),e.exports=_()}(s);var f=s.exports;c=f.createRoot,f.hydrateRoot;const g=n.exports.createElement,v=(...e)=>g(n.exports.Fragment,null,...e);function y(e,t){return y=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},y(e,t)}function b(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,y(e,t)}var x,w,S,C,T,A,E={exports:{}},P={exports:{}},M={};function L(){return w||(w=1,function(e){e.exports=function(){if(x)return M;x=1;var e="function"==typeof Symbol&&Symbol.for,t=e?Symbol.for("react.element"):60103,s=e?Symbol.for("react.portal"):60106,i=e?Symbol.for("react.fragment"):60107,n=e?Symbol.for("react.strict_mode"):60108,r=e?Symbol.for("react.profiler"):60114,a=e?Symbol.for("react.provider"):60109,o=e?Symbol.for("react.context"):60110,l=e?Symbol.for("react.async_mode"):60111,h=e?Symbol.for("react.concurrent_mode"):60111,c=e?Symbol.for("react.forward_ref"):60112,d=e?Symbol.for("react.suspense"):60113,u=e?Symbol.for("react.suspense_list"):60120,p=e?Symbol.for("react.memo"):60115,m=e?Symbol.for("react.lazy"):60116,_=e?Symbol.for("react.block"):60121,f=e?Symbol.for("react.fundamental"):60117,g=e?Symbol.for("react.responder"):60118,v=e?Symbol.for("react.scope"):60119;function y(e){if("object"==typeof e&&null!==e){var u=e.$$typeof;switch(u){case t:switch(e=e.type){case l:case h:case i:case r:case n:case d:return e;default:switch(e=e&&e.$$typeof){case o:case c:case m:case p:case a:return e;default:return u}}case s:return u}}}function b(e){return y(e)===h}return M.AsyncMode=l,M.ConcurrentMode=h,M.ContextConsumer=o,M.ContextProvider=a,M.Element=t,M.ForwardRef=c,M.Fragment=i,M.Lazy=m,M.Memo=p,M.Portal=s,M.Profiler=r,M.StrictMode=n,M.Suspense=d,M.isAsyncMode=function(e){return b(e)||y(e)===l},M.isConcurrentMode=b,M.isContextConsumer=function(e){return y(e)===o},M.isContextProvider=function(e){return y(e)===a},M.isElement=function(e){return"object"==typeof e&&null!==e&&e.$$typeof===t},M.isForwardRef=function(e){return y(e)===c},M.isFragment=function(e){return y(e)===i},M.isLazy=function(e){return y(e)===m},M.isMemo=function(e){return y(e)===p},M.isPortal=function(e){return y(e)===s},M.isProfiler=function(e){return y(e)===r},M.isStrictMode=function(e){return y(e)===n},M.isSuspense=function(e){return y(e)===d},M.isValidElementType=function(e){return"string"==typeof e||"function"==typeof e||e===i||e===h||e===r||e===n||e===d||e===u||"object"==typeof e&&null!==e&&(e.$$typeof===m||e.$$typeof===p||e.$$typeof===a||e.$$typeof===o||e.$$typeof===c||e.$$typeof===f||e.$$typeof===g||e.$$typeof===v||e.$$typeof===_)},M.typeOf=y,M}()}(P)),P.exports}function D(){return D=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i])}return e},D.apply(this,arguments)}function k(e){return"/"===e.charAt(0)}function I(e,t){for(var s=t,i=s+1,n=e.length;i<n;s+=1,i+=1)e[s]=e[i];e.pop()}function R(e){return e.valueOf?e.valueOf():Object.prototype.valueOf.call(e)}function O(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if(Array.isArray(e))return Array.isArray(t)&&e.length===t.length&&e.every((function(e,s){return O(e,t[s])}));if("object"==typeof e||"object"==typeof t){var s=R(e),i=R(t);return s!==e||i!==t?O(s,i):Object.keys(Object.assign({},e,t)).every((function(s){return O(e[s],t[s])}))}return!1}E.exports=function(){if(A)return T;A=1;var e=C?S:(C=1,S="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED");function t(){}function s(){}return s.resetWarningCache=t,T=function(){function i(t,s,i,n,r,a){if(a!==e){var o=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw o.name="Invariant Violation",o}}function n(){return i}i.isRequired=i;var r={array:i,bigint:i,bool:i,func:i,number:i,object:i,string:i,symbol:i,any:i,arrayOf:n,element:i,elementType:i,instanceOf:n,node:i,objectOf:n,oneOf:n,oneOfType:n,shape:n,exact:n,checkPropTypes:s,resetWarningCache:t};return r.PropTypes=r,r}}()();var z="Invariant failed";function F(e,t){if(!e)throw new Error(z)}function V(e){return"/"===e.charAt(0)?e:"/"+e}function N(e){return"/"===e.charAt(0)?e.substr(1):e}function B(e,t){return function(e,t){return 0===e.toLowerCase().indexOf(t.toLowerCase())&&-1!=="/?#".indexOf(e.charAt(t.length))}(e,t)?e.substr(t.length):e}function U(e){return"/"===e.charAt(e.length-1)?e.slice(0,-1):e}function H(e){var t=e.pathname,s=e.search,i=e.hash,n=t||"/";return s&&"?"!==s&&(n+="?"===s.charAt(0)?s:"?"+s),i&&"#"!==i&&(n+="#"===i.charAt(0)?i:"#"+i),n}function W(e,t,s,i){var n;"string"==typeof e?(n=function(e){var t=e||"/",s="",i="",n=t.indexOf("#");-1!==n&&(i=t.substr(n),t=t.substr(0,n));var r=t.indexOf("?");return-1!==r&&(s=t.substr(r),t=t.substr(0,r)),{pathname:t,search:"?"===s?"":s,hash:"#"===i?"":i}}(e),n.state=t):(void 0===(n=D({},e)).pathname&&(n.pathname=""),n.search?"?"!==n.search.charAt(0)&&(n.search="?"+n.search):n.search="",n.hash?"#"!==n.hash.charAt(0)&&(n.hash="#"+n.hash):n.hash="",void 0!==t&&void 0===n.state&&(n.state=t));try{n.pathname=decodeURI(n.pathname)}catch(e){throw e instanceof URIError?new URIError('Pathname "'+n.pathname+'" could not be decoded. This is likely caused by an invalid percent-encoding.'):e}return s&&(n.key=s),i?n.pathname?"/"!==n.pathname.charAt(0)&&(n.pathname=function(e,t){void 0===t&&(t="");var s,i=e&&e.split("/")||[],n=t&&t.split("/")||[],r=e&&k(e),a=t&&k(t),o=r||a;if(e&&k(e)?n=i:i.length&&(n.pop(),n=n.concat(i)),!n.length)return"/";if(n.length){var l=n[n.length-1];s="."===l||".."===l||""===l}else s=!1;for(var h=0,c=n.length;c>=0;c--){var d=n[c];"."===d?I(n,c):".."===d?(I(n,c),h++):h&&(I(n,c),h--)}if(!o)for(;h--;h)n.unshift("..");!o||""===n[0]||n[0]&&k(n[0])||n.unshift("");var u=n.join("/");return s&&"/"!==u.substr(-1)&&(u+="/"),u}(n.pathname,i.pathname)):n.pathname=i.pathname:n.pathname||(n.pathname="/"),n}function G(e,t){return e.pathname===t.pathname&&e.search===t.search&&e.hash===t.hash&&e.key===t.key&&O(e.state,t.state)}function j(){var e=null;var t=[];return{setPrompt:function(t){return e=t,function(){e===t&&(e=null)}},confirmTransitionTo:function(t,s,i,n){if(null!=e){var r="function"==typeof e?e(t,s):e;"string"==typeof r?"function"==typeof i?i(r,n):n(!0):n(!1!==r)}else n(!0)},appendListener:function(e){var s=!0;function i(){s&&e.apply(void 0,arguments)}return t.push(i),function(){s=!1,t=t.filter((function(e){return e!==i}))}},notifyListeners:function(){for(var e=arguments.length,s=new Array(e),i=0;i<e;i++)s[i]=arguments[i];t.forEach((function(e){return e.apply(void 0,s)}))}}}var q=!("undefined"==typeof window||!window.document||!window.document.createElement);function K(e,t){t(window.confirm(e))}var X="hashchange",Y={hashbang:{encodePath:function(e){return"!"===e.charAt(0)?e:"!/"+N(e)},decodePath:function(e){return"!"===e.charAt(0)?e.substr(1):e}},noslash:{encodePath:N,decodePath:V},slash:{encodePath:V,decodePath:V}};function Z(e){var t=e.indexOf("#");return-1===t?e:e.slice(0,t)}function $(){var e=window.location.href,t=e.indexOf("#");return-1===t?"":e.substring(t+1)}function Q(e){window.location.replace(Z(window.location.href)+"#"+e)}function J(e){void 0===e&&(e={}),q||F(!1);var t=window.history;window.navigator.userAgent.indexOf("Firefox");var s=e,i=s.getUserConfirmation,n=void 0===i?K:i,r=s.hashType,a=void 0===r?"slash":r,o=e.basename?U(V(e.basename)):"",l=Y[a],h=l.encodePath,c=l.decodePath;function d(){var e=c($());return o&&(e=B(e,o)),W(e)}var u=j();function p(e){D(T,e),T.length=t.length,u.notifyListeners(T.location,T.action)}var m=!1,_=null;function f(){var e=$(),t=h(e);if(e!==t)Q(t);else{var s=d(),i=T.location;if(!m&&function(e,t){return e.pathname===t.pathname&&e.search===t.search&&e.hash===t.hash}(i,s))return;if(_===H(s))return;_=null,function(e){if(m)m=!1,p();else{var t="POP";u.confirmTransitionTo(e,t,n,(function(s){s?p({action:t,location:e}):function(e){var t=T.location,s=b.lastIndexOf(H(t));-1===s&&(s=0);var i=b.lastIndexOf(H(e));-1===i&&(i=0);var n=s-i;n&&(m=!0,x(n))}(e)}))}}(s)}}var g=$(),v=h(g);g!==v&&Q(v);var y=d(),b=[H(y)];function x(e){t.go(e)}var w=0;function S(e){1===(w+=e)&&1===e?window.addEventListener(X,f):0===w&&window.removeEventListener(X,f)}var C=!1;var T={length:t.length,action:"POP",location:y,createHref:function(e){var t=document.querySelector("base"),s="";return t&&t.getAttribute("href")&&(s=Z(window.location.href)),s+"#"+h(o+H(e))},push:function(e,t){var s="PUSH",i=W(e,void 0,void 0,T.location);u.confirmTransitionTo(i,s,n,(function(e){if(e){var t=H(i),n=h(o+t);if($()!==n){_=t,function(e){window.location.hash=e}(n);var r=b.lastIndexOf(H(T.location)),a=b.slice(0,r+1);a.push(t),b=a,p({action:s,location:i})}else p()}}))},replace:function(e,t){var s="REPLACE",i=W(e,void 0,void 0,T.location);u.confirmTransitionTo(i,s,n,(function(e){if(e){var t=H(i),n=h(o+t);$()!==n&&(_=t,Q(n));var r=b.indexOf(H(T.location));-1!==r&&(b[r]=t),p({action:s,location:i})}}))},go:x,goBack:function(){x(-1)},goForward:function(){x(1)},block:function(e){void 0===e&&(e=!1);var t=u.setPrompt(e);return C||(S(1),C=!0),function(){return C&&(C=!1,S(-1)),t()}},listen:function(e){var t=u.appendListener(e);return S(1),function(){S(-1),t()}}};return T}var ee={exports:{}},te=Array.isArray||function(e){return"[object Array]"==Object.prototype.toString.call(e)},se=te;ee.exports=ue,ee.exports.parse=ne,ee.exports.compile=function(e,t){return ae(ne(e,t),t)},ee.exports.tokensToFunction=ae,ee.exports.tokensToRegExp=de;var ie=new RegExp(["(\\\\.)","([\\/.])?(?:(?:\\:(\\w+)(?:\\(((?:\\\\.|[^\\\\()])+)\\))?|\\(((?:\\\\.|[^\\\\()])+)\\))([+*?])?|(\\*))"].join("|"),"g");function ne(e,t){for(var s,i=[],n=0,r=0,a="",o=t&&t.delimiter||"/";null!=(s=ie.exec(e));){var l=s[0],h=s[1],c=s.index;if(a+=e.slice(r,c),r=c+l.length,h)a+=h[1];else{var d=e[r],u=s[2],p=s[3],m=s[4],_=s[5],f=s[6],g=s[7];a&&(i.push(a),a="");var v=null!=u&&null!=d&&d!==u,y="+"===f||"*"===f,b="?"===f||"*"===f,x=s[2]||o,w=m||_;i.push({name:p||n++,prefix:u||"",delimiter:x,optional:b,repeat:y,partial:v,asterisk:!!g,pattern:w?le(w):g?".*":"[^"+oe(x)+"]+?"})}}return r<e.length&&(a+=e.substr(r)),a&&i.push(a),i}function re(e){return encodeURI(e).replace(/[\/?#]/g,(function(e){return"%"+e.charCodeAt(0).toString(16).toUpperCase()}))}function ae(e,t){for(var s=new Array(e.length),i=0;i<e.length;i++)"object"==typeof e[i]&&(s[i]=new RegExp("^(?:"+e[i].pattern+")$",ce(t)));return function(t,i){for(var n="",r=t||{},a=(i||{}).pretty?re:encodeURIComponent,o=0;o<e.length;o++){var l=e[o];if("string"!=typeof l){var h,c=r[l.name];if(null==c){if(l.optional){l.partial&&(n+=l.prefix);continue}throw new TypeError('Expected "'+l.name+'" to be defined')}if(se(c)){if(!l.repeat)throw new TypeError('Expected "'+l.name+'" to not repeat, but received `'+JSON.stringify(c)+"`");if(0===c.length){if(l.optional)continue;throw new TypeError('Expected "'+l.name+'" to not be empty')}for(var d=0;d<c.length;d++){if(h=a(c[d]),!s[o].test(h))throw new TypeError('Expected all "'+l.name+'" to match "'+l.pattern+'", but received `'+JSON.stringify(h)+"`");n+=(0===d?l.prefix:l.delimiter)+h}}else{if(h=l.asterisk?encodeURI(c).replace(/[?#]/g,(function(e){return"%"+e.charCodeAt(0).toString(16).toUpperCase()})):a(c),!s[o].test(h))throw new TypeError('Expected "'+l.name+'" to match "'+l.pattern+'", but received "'+h+'"');n+=l.prefix+h}}else n+=l}return n}}function oe(e){return e.replace(/([.+*?=^!:${}()[\]|\/\\])/g,"\\$1")}function le(e){return e.replace(/([=!:$\/()])/g,"\\$1")}function he(e,t){return e.keys=t,e}function ce(e){return e&&e.sensitive?"":"i"}function de(e,t,s){se(t)||(s=t||s,t=[]);for(var i=(s=s||{}).strict,n=!1!==s.end,r="",a=0;a<e.length;a++){var o=e[a];if("string"==typeof o)r+=oe(o);else{var l=oe(o.prefix),h="(?:"+o.pattern+")";t.push(o),o.repeat&&(h+="(?:"+l+h+")*"),r+=h=o.optional?o.partial?l+"("+h+")?":"(?:"+l+"("+h+"))?":l+"("+h+")"}}var c=oe(s.delimiter||"/"),d=r.slice(-c.length)===c;return i||(r=(d?r.slice(0,-c.length):r)+"(?:"+c+"(?=$))?"),r+=n?"$":i&&d?"":"(?="+c+"|$)",he(new RegExp("^"+r,ce(s)),t)}function ue(e,t,s){return se(t)||(s=t||s,t=[]),s=s||{},e instanceof RegExp?function(e,t){var s=e.source.match(/\((?!\?)/g);if(s)for(var i=0;i<s.length;i++)t.push({name:i,prefix:null,delimiter:null,optional:!1,repeat:!1,partial:!1,asterisk:!1,pattern:null});return he(e,t)}(e,t):se(e)?function(e,t,s){for(var i=[],n=0;n<e.length;n++)i.push(ue(e[n],t,s).source);return he(new RegExp("(?:"+i.join("|")+")",ce(s)),t)}(e,t,s):function(e,t,s){return de(ne(e,s),t,s)}(e,t,s)}function pe(e,t){if(null==e)return{};var s,i,n={},r=Object.keys(e);for(i=0;i<r.length;i++)s=r[i],t.indexOf(s)>=0||(n[s]=e[s]);return n}L();var me=L(),_e={childContextTypes:!0,contextType:!0,contextTypes:!0,defaultProps:!0,displayName:!0,getDefaultProps:!0,getDerivedStateFromError:!0,getDerivedStateFromProps:!0,mixins:!0,propTypes:!0,type:!0},fe={name:!0,length:!0,prototype:!0,caller:!0,callee:!0,arguments:!0,arity:!0},ge={$$typeof:!0,compare:!0,defaultProps:!0,displayName:!0,propTypes:!0,type:!0},ve={};function ye(e){return me.isMemo(e)?ge:ve[e.$$typeof]||_e}ve[me.ForwardRef]={$$typeof:!0,render:!0,defaultProps:!0,displayName:!0,propTypes:!0},ve[me.Memo]=ge;var be=Object.defineProperty,xe=Object.getOwnPropertyNames,we=Object.getOwnPropertySymbols,Se=Object.getOwnPropertyDescriptor,Ce=Object.getPrototypeOf,Te=Object.prototype;var Ae=function e(t,s,i){if("string"!=typeof s){if(Te){var n=Ce(s);n&&n!==Te&&e(t,n,i)}var r=xe(s);we&&(r=r.concat(we(s)));for(var a=ye(t),o=ye(s),l=0;l<r.length;++l){var h=r[l];if(!(fe[h]||i&&i[h]||o&&o[h]||a&&a[h])){var c=Se(s,h);try{be(t,h,c)}catch(e){}}}}return t},Ee=1073741823,Pe="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{};var Me=d.createContext||function(e,t){var s,i,n,r="__create-react-context-"+((Pe[n="__global_unique_id__"]=(Pe[n]||0)+1)+"__"),a=function(e){function s(){for(var t,s,i,n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(t=e.call.apply(e,[this].concat(r))||this).emitter=(s=t.props.value,i=[],{on:function(e){i.push(e)},off:function(e){i=i.filter((function(t){return t!==e}))},get:function(){return s},set:function(e,t){s=e,i.forEach((function(e){return e(s,t)}))}}),t}b(s,e);var i=s.prototype;return i.getChildContext=function(){var e;return(e={})[r]=this.emitter,e},i.componentWillReceiveProps=function(e){if(this.props.value!==e.value){var s,i=this.props.value,n=e.value;!function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t}(i,n)?(s="function"==typeof t?t(i,n):Ee,0!==(s|=0)&&this.emitter.set(e.value,s)):s=0}},i.render=function(){return this.props.children},s}(d.Component);a.childContextTypes=((s={})[r]=E.exports.object.isRequired,s);var o=function(t){function s(){for(var e,s=arguments.length,i=new Array(s),n=0;n<s;n++)i[n]=arguments[n];return(e=t.call.apply(t,[this].concat(i))||this).observedBits=void 0,e.state={value:e.getValue()},e.onUpdate=function(t,s){0!=((0|e.observedBits)&s)&&e.setState({value:e.getValue()})},e}b(s,t);var i=s.prototype;return i.componentWillReceiveProps=function(e){var t=e.observedBits;this.observedBits=null==t?Ee:t},i.componentDidMount=function(){this.context[r]&&this.context[r].on(this.onUpdate);var e=this.props.observedBits;this.observedBits=null==e?Ee:e},i.componentWillUnmount=function(){this.context[r]&&this.context[r].off(this.onUpdate)},i.getValue=function(){return this.context[r]?this.context[r].get():e},i.render=function(){return(e=this.props.children,Array.isArray(e)?e[0]:e)(this.state.value);var e},s}(d.Component);return o.contextTypes=((i={})[r]=E.exports.object,i),{Provider:a,Consumer:o}},Le=function(e){var t=Me();return t.displayName=e,t},De=Le("Router-History"),ke=Le("Router"),Ie=function(e){function t(t){var s;return(s=e.call(this,t)||this).state={location:t.history.location},s._isMounted=!1,s._pendingLocation=null,t.staticContext||(s.unlisten=t.history.listen((function(e){s._pendingLocation=e}))),s}b(t,e),t.computeRootMatch=function(e){return{path:"/",url:"/",params:{},isExact:"/"===e}};var s=t.prototype;return s.componentDidMount=function(){var e=this;this._isMounted=!0,this.unlisten&&this.unlisten(),this.props.staticContext||(this.unlisten=this.props.history.listen((function(t){e._isMounted&&e.setState({location:t})}))),this._pendingLocation&&this.setState({location:this._pendingLocation})},s.componentWillUnmount=function(){this.unlisten&&(this.unlisten(),this._isMounted=!1,this._pendingLocation=null)},s.render=function(){return d.createElement(ke.Provider,{value:{history:this.props.history,location:this.state.location,match:t.computeRootMatch(this.state.location.pathname),staticContext:this.props.staticContext}},d.createElement(De.Provider,{children:this.props.children||null,value:this.props.history}))},t}(d.Component);d.Component;var Re=function(e){function t(){return e.apply(this,arguments)||this}b(t,e);var s=t.prototype;return s.componentDidMount=function(){this.props.onMount&&this.props.onMount.call(this,this)},s.componentDidUpdate=function(e){this.props.onUpdate&&this.props.onUpdate.call(this,this,e)},s.componentWillUnmount=function(){this.props.onUnmount&&this.props.onUnmount.call(this,this)},s.render=function(){return null},t}(d.Component),Oe={},ze=1e4,Fe=0;function Ve(e,t){return void 0===e&&(e="/"),void 0===t&&(t={}),"/"===e?e:function(e){if(Oe[e])return Oe[e];var t=ee.exports.compile(e);return Fe<ze&&(Oe[e]=t,Fe++),t}(e)(t,{pretty:!0})}function Ne(e){var t=e.computedMatch,s=e.to,i=e.push,n=void 0!==i&&i;return d.createElement(ke.Consumer,null,(function(e){e||F(!1);var i=e.history,r=e.staticContext,a=n?i.push:i.replace,o=W(t?"string"==typeof s?Ve(s,t.params):D({},s,{pathname:Ve(s.pathname,t.params)}):s);return r?(a(o),null):d.createElement(Re,{onMount:function(){a(o)},onUpdate:function(e,t){var s=W(t.to);G(s,D({},o,{key:s.key}))||a(o)},to:s})}))}var Be={},Ue=1e4,He=0;function We(e,t){void 0===t&&(t={}),("string"==typeof t||Array.isArray(t))&&(t={path:t});var s=t,i=s.path,n=s.exact,r=void 0!==n&&n,a=s.strict,o=void 0!==a&&a,l=s.sensitive,h=void 0!==l&&l;return[].concat(i).reduce((function(t,s){if(!s&&""!==s)return null;if(t)return t;var i=function(e,t){var s=""+t.end+t.strict+t.sensitive,i=Be[s]||(Be[s]={});if(i[e])return i[e];var n=[],r={regexp:ee.exports(e,n,t),keys:n};return He<Ue&&(i[e]=r,He++),r}(s,{end:r,strict:o,sensitive:h}),n=i.regexp,a=i.keys,l=n.exec(e);if(!l)return null;var c=l[0],d=l.slice(1),u=e===c;return r&&!u?null:{path:s,url:"/"===s&&""===c?"/":c,isExact:u,params:a.reduce((function(e,t,s){return e[t.name]=d[s],e}),{})}}),null)}var Ge=function(e){function t(){return e.apply(this,arguments)||this}return b(t,e),t.prototype.render=function(){var e=this;return d.createElement(ke.Consumer,null,(function(t){t||F(!1);var s=e.props.location||t.location,i=D({},t,{location:s,match:e.props.computedMatch?e.props.computedMatch:e.props.path?We(s.pathname,e.props):t.match}),n=e.props,r=n.children,a=n.component,o=n.render;return Array.isArray(r)&&function(e){return 0===d.Children.count(e)}(r)&&(r=null),d.createElement(ke.Provider,{value:i},i.match?r?"function"==typeof r?r(i):r:a?d.createElement(a,i):o?o(i):null:"function"==typeof r?r(i):null)}))},t}(d.Component);d.Component;var je=function(e){function t(){return e.apply(this,arguments)||this}return b(t,e),t.prototype.render=function(){var e=this;return d.createElement(ke.Consumer,null,(function(t){t||F(!1);var s,i,n=e.props.location||t.location;return d.Children.forEach(e.props.children,(function(e){if(null==i&&d.isValidElement(e)){s=e;var r=e.props.path||e.props.from;i=r?We(n.pathname,D({},e.props,{path:r})):t.match}})),i?d.cloneElement(s,{location:n,computedMatch:i}):null}))},t}(d.Component);d.useContext,d.Component;var qe=function(e){function t(){for(var t,s=arguments.length,i=new Array(s),n=0;n<s;n++)i[n]=arguments[n];return(t=e.call.apply(e,[this].concat(i))||this).history=J(t.props),t}return b(t,e),t.prototype.render=function(){return d.createElement(Ie,{history:this.history,children:this.props.children})},t}(d.Component),Ke=function(e,t){return"function"==typeof e?e(t):e},Xe=function(e,t){return"string"==typeof e?W(e,null,null,t):e},Ye=function(e){return e},Ze=d.forwardRef;void 0===Ze&&(Ze=Ye);var $e=Ze((function(e,t){var s=e.innerRef,i=e.navigate,n=e.onClick,r=pe(e,["innerRef","navigate","onClick"]),a=r.target,o=D({},r,{onClick:function(e){try{n&&n(e)}catch(t){throw e.preventDefault(),t}e.defaultPrevented||0!==e.button||a&&"_self"!==a||function(e){return!!(e.metaKey||e.altKey||e.ctrlKey||e.shiftKey)}(e)||(e.preventDefault(),i())}});return o.ref=Ye!==Ze&&t||s,d.createElement("a",o)})),Qe=Ze((function(e,t){var s=e.component,i=void 0===s?$e:s,n=e.replace,r=e.to,a=e.innerRef,o=pe(e,["component","replace","to","innerRef"]);return d.createElement(ke.Consumer,null,(function(e){e||F(!1);var s=e.history,l=Xe(Ke(r,e.location),e.location),h=l?s.createHref(l):"",c=D({},o,{href:h,navigate:function(){var t=Ke(r,e.location),i=H(e.location)===H(Xe(t));(n||i?s.replace:s.push)(t)}});return Ye!==Ze?c.ref=t||a:c.innerRef=a,d.createElement(i,c)}))})),Je=function(e){return e},et=d.forwardRef;void 0===et&&(et=Je),et((function(e,t){var s=e["aria-current"],i=void 0===s?"page":s,n=e.activeClassName,r=void 0===n?"active":n,a=e.activeStyle,o=e.className,l=e.exact,h=e.isActive,c=e.location,u=e.sensitive,p=e.strict,m=e.style,_=e.to,f=e.innerRef,g=pe(e,["aria-current","activeClassName","activeStyle","className","exact","isActive","location","sensitive","strict","style","to","innerRef"]);return d.createElement(ke.Consumer,null,(function(e){e||F(!1);var s=c||e.location,n=Xe(Ke(_,s),s),v=n.pathname,y=v&&v.replace(/([.+*?=^!:${}()[\]|/\\])/g,"\\$1"),b=y?We(s.pathname,{path:y,exact:l,sensitive:u,strict:p}):null,x=!!(h?h(b,s):b),w="function"==typeof o?o(x):o,S="function"==typeof m?m(x):m;x&&(w=function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return t.filter((function(e){return e})).join(" ")}(w,r),S=D({},S,a));var C=D({"aria-current":x&&i||null,className:w,style:S,to:n},g);return Je!==et?C.ref=t||f:C.innerRef=f,d.createElement(Qe,C)}))}));class tt{constructor(e,t,s){this.owner=e,this.name=t,this.fn=s}unbind(){this.owner&&(this.owner.unbind(this.name,this.fn),this.owner=null,this.name=null,this.fn=null)}call(){this.fn&&this.fn.call(this.owner,arguments[0],arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6],arguments[7])}on(e,t){return this.owner.on(e,t)}}class st{constructor(){Object.defineProperty(this,"_events",{enumerable:!1,configurable:!1,writable:!0,value:{}}),this._suspendEvents=!1,this._additionalEmitters=[]}set suspendEvents(e){this._suspendEvents=!!e}get suspendEvents(){return this._suspendEvents}on(e,t){const s=this._events[e];return void 0===s?this._events[e]=[t]:-1===s.indexOf(t)&&s.push(t),new tt(this,e,t)}once(e,t){const s=this.on(e,((e,i,n,r,a,o,l,h)=>{t.call(this,e,i,n,r,a,o,l,h),s.unbind()}));return s}emit(e,t,s,i,n,r,a,o,l){if(this._suspendEvents)return this;let h=this._events[e];if(h&&h.length){h=h.slice(0);for(let c=0;c<h.length;c++)if(h[c])try{h[c].call(this,t,s,i,n,r,a,o,l)}catch(t){console.info("%c%s %c(event error)","color: #06f",e,"color: #f00"),console.log(t.stack)}}if(this._additionalEmitters.length){this._additionalEmitters.slice().forEach((h=>{h.emit(e,t,s,i,n,r,a,o,l)}))}return this}unbind(e,t){if(e){const s=this._events[e];if(!s)return this;if(t){const i=s.indexOf(t);-1!==i&&(1===s.length?delete this._events[e]:s.splice(i,1))}else delete this._events[e]}else this._events={};return this}addEmitter(e){this._additionalEmitters.includes(e)||this._additionalEmitters.push(e)}removeEmitter(e){const t=this._additionalEmitters.indexOf(e);-1!==t&&this._additionalEmitters.splice(t,1)}}const it=(e,t)=>{if(!e||!t)return!1;const s=e.length;if(s!==t.length)return!1;for(let i=0;i<s;i++)if(e[i]instanceof Array&&t[i]instanceof Array){if(!it(e[i],t[i]))return!1}else if(e[i]!==t[i])return!1;return!0};class nt extends st{constructor(e,t={}){if(super(),this._destroyed=!1,this._path="",this._keys=[],this._data={},this._pathsWithDuplicates=null,t.pathsWithDuplicates){this._pathsWithDuplicates={};for(let e=0;e<t.pathsWithDuplicates.length;e++)this._pathsWithDuplicates[t.pathsWithDuplicates[e]]=!0}this.patch(e),this._parent=t.parent||null,this._parentPath=t.parentPath||"",this._parentField=t.parentField||null,this._parentKey=t.parentKey||null,this._latestFn=t.latestFn||null,this._silent=!1;const s=function(e){return function(t,s,i,n){if(!this._parent)return;let r,a=this._parentKey;!a&&this._parentField instanceof Array&&(a=this._parentField.indexOf(this),-1===a)||(t=this._parentPath+"."+a+"."+t,this._silent&&(r=this._parent.silence()),this._parent.emit(t+":"+e,s,i,n),this._parent.emit("*:"+e,t,s,i,n),this._silent&&this._parent.silenceRestore(r))}};this.on("*:set",s("set")),this.on("*:unset",s("unset")),this.on("*:insert",s("insert")),this.on("*:remove",s("remove")),this.on("*:move",s("move"))}static _splitPath(e){const t=nt._splitPathsCache;let s=t[e];return s?s=s.slice():(s=e.split("."),t[e]=s),s}silence(){this._silent=!0;const e=this.history&&this.history.enabled;e&&(this.history.enabled=!1);const t=this.sync&&this.sync.enabled;return t&&(this.sync.enabled=!1),[e,t]}silenceRestore(e){this._silent=!1,e[0]&&(this.history.enabled=!0),e[1]&&(this.sync.enabled=!0)}_prepare(e,t,s,i,n){let r,a;const o=(e._path?e._path+".":"")+t,l=typeof s;if(e._keys.push(t),"object"===l&&s instanceof Array){for(e._data[t]=s.slice(0),r=0;r<e._data[t].length;r++)"object"==typeof e._data[t][r]&&null!==e._data[t][r]?e._data[t][r]instanceof Array?e._data[t][r].slice(0):e._data[t][r]=new nt(e._data[t][r],{parent:this,parentPath:o,parentField:e._data[t],parentKey:null}):(a=this.silence(),this.emit(o+"."+r+":set",e._data[t][r],null,n),this.emit("*:set",o+"."+r,e._data[t][r],null,n),this.silenceRestore(a));i&&(a=this.silence()),this.emit(o+":set",e._data[t],null,n),this.emit("*:set",o,e._data[t],null,n),i&&this.silenceRestore(a)}else if("object"===l&&s instanceof Object){for(r in"object"!=typeof e._data[t]&&(e._data[t]={_path:o,_keys:[],_data:{}}),s)"object"==typeof s[r]?this._prepare(e._data[t],r,s[r],!0,n):(a=this.silence(),e._data[t]._data[r]=s[r],e._data[t]._keys.push(r),this.emit(o+"."+r+":set",s[r],null,n),this.emit("*:set",o+"."+r,s[r],null,n),this.silenceRestore(a));i&&(a=this.silence()),this.emit(o+":set",s,void 0,n),this.emit("*:set",o,s,void 0,n),i&&this.silenceRestore(a)}else i&&(a=this.silence()),e._data[t]=s,this.emit(o+":set",s,void 0,n),this.emit("*:set",o,s,void 0,n),i&&this.silenceRestore(a);return!0}set(e,t,s,i,n){let r,a,o=nt._splitPath(e);const l=o.length,h=o[l-1];let c,d,u=this,p="",m=this;for(r=0;r<l-1;r++)u instanceof Array?(u=u[o[r]],u instanceof nt&&(e=o.slice(r+1).join("."),m=u)):(r<l&&"object"!=typeof u._data[o[r]]&&(u._data[o[r]]&&m.unset((u.__path?u.__path+".":"")+o[r]),u._data[o[r]]={_path:e,_keys:[],_data:{}},u._keys.push(o[r])),r===l-1&&u.__path&&(p=u.__path+"."+o[r]),u=u._data[o[r]]);if(u instanceof Array){const r=parseInt(h,10);return!(u[r]===t&&!n)&&(a=u[r],a=a instanceof nt?a.json():m.json(a),u[r]=t,t instanceof nt&&(t._parent=m,t._parentPath=p,t._parentField=u,t._parentKey=null),s&&(c=m.silence()),m.emit(e+":set",t,a,i),m.emit("*:set",e,t,a,i),s&&m.silenceRestore(c),!0)}if(u._data&&!u._data.hasOwnProperty(h))return"object"==typeof t?m._prepare(u,h,t,!1,i):(u._data[h]=t,u._keys.push(h),s&&(c=m.silence()),m.emit(e+":set",t,null,i),m.emit("*:set",e,t,null,i),s&&m.silenceRestore(c),!0);if("object"==typeof t&&t instanceof Array){if(it(t,u._data[h])&&!n)return!1;if(a=u._data[h],a instanceof nt||(a=m.json(a)),u._data[h]&&u._data[h].length===t.length){for(c=m.silence(),0===t.length&&(u._data[h]=t),r=0;r<u._data[h].length;r++)u._data[h][r]instanceof nt?u._data[h][r].patch(t[r],!0):u._data[h][r]!==t[r]&&(u._data[h][r]=t[r],m.emit(e+"."+r+":set",u._data[h][r],a&&a[r]||null,i),m.emit("*:set",e+"."+r,u._data[h][r],a&&a[r]||null,i));m.silenceRestore(c)}else{for(u._data[h]=[],t.forEach((e=>{this._doInsert(u,h,e,void 0,!0)})),c=m.silence(),r=0;r<u._data[h].length;r++)m.emit(e+"."+r+":set",u._data[h][r],a&&a[r]||null,i),m.emit("*:set",e+"."+r,u._data[h][r],a&&a[r]||null,i);m.silenceRestore(c)}return s&&(c=m.silence()),m.emit(e+":set",t,a,i),m.emit("*:set",e,t,a,i),s&&m.silenceRestore(c),!0}if("object"==typeof t&&t instanceof Object){let n,l=!1;a=u._data[h],a instanceof nt||(a=m.json(a)),o=Object.keys(t),u._data[h]&&u._data[h]._data||(u._data[h]?m.unset((u.__path?u.__path+".":"")+h):l=!0,u._data[h]={_path:e,_keys:[],_data:{}});for(const s in u._data[h]._data)t.hasOwnProperty(s)?u._data[h]._data.hasOwnProperty(s)?m._equals(u._data[h]._data[s],t[s])||(n=m.set(e+"."+s,t[s],!0),n&&(l=!0)):(n=m._prepare(u._data[h],s,t[s],!0,i),n&&(l=!0)):(n=m.unset(e+"."+s,!0),n&&(l=!0));for(r=0;r<o.length;r++)void 0===t[o[r]]&&u._data[h]._data.hasOwnProperty(o[r])?(n=m.unset(e+"."+o[r],!0),n&&(l=!0)):"object"==typeof t[o[r]]?u._data[h]._data.hasOwnProperty(o[r])?(n=m.set(e+"."+o[r],t[o[r]],!0),n&&(l=!0)):(n=m._prepare(u._data[h],o[r],t[o[r]],!0,i),n&&(l=!0)):m._equals(u._data[h]._data[o[r]],t[o[r]])||("object"==typeof t[o[r]]?(n=m.set(u._data[h]._path+"."+o[r],t[o[r]],!0),n&&(l=!0)):u._data[h]._data[o[r]]!==t[o[r]]&&(l=!0,-1===u._data[h]._keys.indexOf(o[r])&&u._data[h]._keys.push(o[r]),u._data[h]._data[o[r]]=t[o[r]],c=m.silence(),m.emit(u._data[h]._path+"."+o[r]+":set",u._data[h]._data[o[r]],null,i),m.emit("*:set",u._data[h]._path+"."+o[r],u._data[h]._data[o[r]],null,i),m.silenceRestore(c)));if(l){s&&(c=m.silence());const e=m.json(u._data[h]);return m.emit(u._data[h]._path+":set",e,a,i),m.emit("*:set",u._data[h]._path,e,a,i),s&&m.silenceRestore(c),!0}return!1}return d=!u.hasOwnProperty("_data")&&u.hasOwnProperty(h)?u:u._data,!(d[h]===t&&!n)&&(s&&(c=m.silence()),a=d[h],a instanceof nt||(a=m.json(a)),d[h]=t,m.emit(e+":set",t,a,i),m.emit("*:set",e,t,a,i),s&&m.silenceRestore(c),!0)}has(e){const t=nt._splitPath(e);let s=this;for(let e=0,i=t.length;e<i;e++){if(null==s)return;s=s._data?s._data[t[e]]:s[t[e]]}return void 0!==s}get(e,t){const s=nt._splitPath(e);let i=this;for(let e=0;e<s.length;e++){if(null==i)return;i=i._data?i._data[s[e]]:i[s[e]]}return t?i:null==i?null:this.json(i)}getRaw(e){return this.get(e,!0)}_equals(e,t){return e===t||!!(e instanceof Array&&t instanceof Array&&it(e,t))}unset(e,t,s){let i;const n=nt._splitPath(e),r=n[n.length-1];let a=this,o=this;for(i=0;i<n.length-1;i++)a instanceof Array?(a=a[n[i]],a instanceof nt&&(e=n.slice(i+1).join("."),o=a)):a=a._data[n[i]];if(!a._data||!a._data.hasOwnProperty(r))return!1;let l,h=a._data[r];if(h instanceof nt||(h=o.json(h)),a._data[r]&&a._data[r]._data)for(i=a._data[r]._keys.length-1;i>=0;i--)o.unset(e+"."+a._data[r]._keys[i],!0);return a._keys.splice(a._keys.indexOf(r),1),delete a._data[r],t&&(l=o.silence()),o.emit(e+":unset",h,s),o.emit("*:unset",e,h,s),t&&o.silenceRestore(l),!0}remove(e,t,s,i){const n=nt._splitPath(e),r=n[n.length-1];let a=this,o=this;for(let t=0;t<n.length-1;t++)if(a instanceof Array)a=a[parseInt(n[t],10)],a instanceof nt&&(e=n.slice(t+1).join("."),o=a);else{if(!a._data||!a._data.hasOwnProperty(n[t]))return!1;a=a._data[n[t]]}if(!(a._data&&a._data.hasOwnProperty(r)&&a._data[r]instanceof Array))return!1;const l=a._data[r];if(l.length<t)return!1;let h,c=l[t];return c instanceof nt?c._parent=null:c=o.json(c),l.splice(t,1),s&&(h=o.silence()),o.emit(e+":remove",c,t,i),o.emit("*:remove",e,c,t,i),s&&o.silenceRestore(h),!0}removeValue(e,t,s,i){const n=nt._splitPath(e),r=n[n.length-1];let a=this,o=this;for(let t=0;t<n.length-1;t++)if(a instanceof Array)a=a[parseInt(n[t],10)],a instanceof nt&&(e=n.slice(t+1).join("."),o=a);else{if(!a._data||!a._data.hasOwnProperty(n[t]))return;a=a._data[n[t]]}if(!(a._data&&a._data.hasOwnProperty(r)&&a._data[r]instanceof Array))return;const l=a._data[r],h=l.indexOf(t);if(-1===h)return;if(l.length<h)return;let c;return(t=l[h])instanceof nt?t._parent=null:t=o.json(t),l.splice(h,1),s&&(c=o.silence()),o.emit(e+":remove",t,h,i),o.emit("*:remove",e,t,h,i),s&&o.silenceRestore(c),!0}insert(e,t,s,i,n){const r=nt._splitPath(e),a=r[r.length-1];let o=this,l=this;for(let t=0;t<r.length-1;t++)if(o instanceof Array)o=o[parseInt(r[t],10)],o instanceof nt&&(e=r.slice(t+1).join("."),l=o);else{if(!o._data||!o._data.hasOwnProperty(r[t]))return;o=o._data[r[t]]}if(!(o._data&&o._data.hasOwnProperty(a)&&o._data[a]instanceof Array))return;const h=o._data[a];let c;return t=l._doInsert(o,a,t,s),void 0===s&&(s=h.length-1),i&&(c=l.silence()),l.emit(e+":insert",t,s,n),l.emit("*:insert",e,t,s,n),i&&l.silenceRestore(c),!0}_doInsert(e,t,s,i,n){const r=e._data[t];"object"!=typeof s||s instanceof nt||null===s||(s=s instanceof Array?s.slice(0):new nt(s));const a=e._path?`${e._path}.${t}`:t;if(null===s||n||this._pathsWithDuplicates&&this._pathsWithDuplicates[a]||-1===r.indexOf(s))return void 0===i?r.push(s):r.splice(i,0,s),s instanceof nt?(s._parent=this,s._parentPath=a,s._parentField=r,s._parentKey=null):s=this.json(s),s}move(e,t,s,i,n){const r=nt._splitPath(e),a=r[r.length-1];let o=this,l=this;for(let t=0;t<r.length-1;t++)if(o instanceof Array)o=o[parseInt(r[t],10)],o instanceof nt&&(e=r.slice(t+1).join("."),l=o);else{if(!o._data||!o._data.hasOwnProperty(r[t]))return;o=o._data[r[t]]}if(!(o._data&&o._data.hasOwnProperty(a)&&o._data[a]instanceof Array))return;const h=o._data[a];if(h.length<t||h.length<s||t===s)return;let c,d=h[t];return h.splice(t,1),-1===s&&(s=h.length),h.splice(s,0,d),d instanceof nt||(d=l.json(d)),i&&(c=l.silence()),l.emit(e+":move",d,s,t,n),l.emit("*:move",e,d,s,t,n),i&&l.silenceRestore(c),!0}patch(e,t){if("object"==typeof e){for(const t in e)"object"!=typeof e[t]||this._data.hasOwnProperty(t)?this._data[t]!==e[t]&&this.set(t,e[t]):this._prepare(this,t,e[t]);if(t)for(const t in this._data)e.hasOwnProperty(t)||this.unset(t)}}json(e){let t,s,i={};const n=void 0===e?this:e;let r,a;if(n instanceof Object&&n._keys){r=n._keys.length;for(let e=0;e<r;e++){t=n._keys[e];const r=n._data[t],o=typeof r;if("object"===o&&r instanceof Array)for(i[t]=r.slice(0),a=i[t].length,s=0;s<a;s++)"object"==typeof i[t][s]&&(i[t][s]=this.json(i[t][s]));else i[t]="object"===o&&r instanceof Object?this.json(r):r}}else{if(null===n)return null;if("object"==typeof n&&n instanceof Array)for(i=n.slice(0),r=i.length,s=0;s<r;s++)i[s]=this.json(i[s]);else if("object"==typeof n)for(t in n)n.hasOwnProperty(t)&&(i[t]=n[t]);else i=n}return i}forEach(e,t,s=""){const i=t||this;for(let t=0;t<i._keys.length;t++){const n=i._keys[t],r=i._data[n],a=this.schema&&this.schema.has(s+n)&&this.schema.get(s+n).type.name.toLowerCase()||typeof r;"object"===a&&r instanceof Array?e(s+n,"array",r,n):"object"===a&&r instanceof Object?(e(s+n,"object",r,n),this.forEach(e,r,s+n+".")):e(s+n,a,r,n)}}latest(){return this._latestFn?this._latestFn():this}destroy(){this._destroyed||(this._destroyed=!0,this.emit("destroy"),this.unbind())}set latestFn(e){this._latestFn=e}get latestFn(){return this._latestFn}}nt._splitPathsCache={};var rt=class extends st{constructor(e){super(),this._observers=[],this._paths=[],this._applyingChange=!1,this._linked=!1,this._element=e.element,this._history=e.history,this._historyPrefix=e.historyPrefix,this._historyPostfix=e.historyPostfix,this._historyName=e.historyName,this._historyCombine=e.historyCombine||!1}_pathAt(e,t){return e[t]||e[0]}link(e,t){this._observers&&this.unlink(),this._observers=Array.isArray(e)?e:[e],this._paths=Array.isArray(t)?t:[t],this._linked=!0}unlink(){this._observers=[],this._paths=[],this._linked=!1}clone(){throw new Error("BindingBase#clone: Not implemented")}setValue(e){}setValues(e){}addValue(e){}addValues(e){}removeValue(e){}removeValues(e){}set element(e){this._element=e}get element(){return this._element}set applyingChange(e){this._applyingChange!==e&&(this._applyingChange=e,this.emit("applyingChange",e))}get applyingChange(){return this._applyingChange}get linked(){return this._linked}set historyCombine(e){this._historyCombine=e}get historyCombine(){return this._historyCombine}set historyName(e){this._historyName=e}get historyName(){return this._historyName}set historyPrefix(e){this._historyPrefix=e}get historyPrefix(){return this._historyPrefix}set historyPostfix(e){this._historyPostfix=e}get historyPostfix(){return this._historyPostfix}set historyEnabled(e){this._history&&(this._history.enabled=e)}get historyEnabled(){return this._history&&this._history.enabled}get observers(){return this._observers}get paths(){return this._paths}};class at extends rt{clone(){return new at({history:this._history,historyPrefix:this._historyPrefix,historyPostfix:this._historyPostfix,historyName:this._historyName,historyCombine:this._historyCombine})}_getHistoryActionName(e){return`${this._historyPrefix||""}${this._historyName||e[0]}${this._historyPostfix||""}`}_setValue(e,t){if(this.applyingChange)return;if(!this._observers.length)return;this.applyingChange=!0;const s=this._observers.slice(),i=this._paths.slice(),n={observers:s,paths:i},r=()=>{this._setValueToObservers(s,i,e,t),this.emit("history:redo",n)};if(this._history){let e=[];e=1===s.length&&i.length>1?i.map((e=>s[0].has(e)?s[0].get(e):void 0)):s.map(((e,t)=>{const s=this._pathAt(i,t);return e.has(s)?e.get(s):void 0})),this.emit("history:init",n),this._history.add({name:this._getHistoryActionName(i),redo:r,combine:this._historyCombine,undo:()=>{this._setValueToObservers(s,i,e,!0),this.emit("history:undo",n)}})}r(),this.applyingChange=!1}_setValueToObservers(e,t,s,i){if(1===e.length&&t.length>1)for(let i=0;i<t.length;i++){const n=e[0].latest();if(!n)continue;let r=!1;n.history&&(r=n.history.enabled,n.history.enabled=!1);const a=t[i],o=s[i];void 0!==s?this._observerSet(n,a,o):n.unset(a),r&&(n.history.enabled=!0)}else for(let n=0;n<e.length;n++){const r=e[n].latest();if(!r)continue;let a=!1;r.history&&(a=r.history.enabled,r.history.enabled=!1);const o=this._pathAt(t,n),l=i?s[n]:s;void 0!==s?this._observerSet(r,o,l):r.unset(o),a&&(r.history.enabled=!0)}}_observerSet(e,t,s){const i=t.lastIndexOf(".");if(i>0&&!e.has(t.substring(0,i)))return;const n=Array.isArray(s);e.set(t,n&&s?s.slice():s)}_addValues(e){if(this.applyingChange)return;if(!this._observers)return;this.applyingChange=!0;const t=this._observers.slice(),s=this._paths.slice(),i=[];for(let n=0;n<t.length;n++){const r=this._pathAt(s,n),a=t[n];e.forEach((e=>{-1===a.get(r).indexOf(e)&&i.push({observer:a,path:r,value:e})}))}const n=()=>{for(const e of i){const t=e.observer.latest();if(!t)continue;const s=e.path;let i=!1;t.history&&(i=t.history.enabled,t.history.enabled=!1),t.insert(s,e.value),i&&(t.history.enabled=!0)}};this._history&&i.length&&this._history.add({name:this._getHistoryActionName(s),redo:n,combine:this._historyCombine,undo:()=>{for(const e of i){const t=e.observer.latest();if(!t)continue;const s=e.path;let i=!1;t.history&&(i=t.history.enabled,t.history.enabled=!1),t.removeValue(s,e.value),i&&(t.history.enabled=!0)}}}),n(),this.applyingChange=!1}_removeValues(e){if(this.applyingChange)return;if(!this._observers)return;this.applyingChange=!0;const t=this._observers.slice(),s=this._paths.slice(),i=[];for(let n=0;n<t.length;n++){const r=this._pathAt(s,n),a=t[n];e.forEach((e=>{const t=a.get(r).indexOf(e);-1!==t&&i.push({observer:a,path:r,value:e,index:t})}))}const n=()=>{for(const e of i){const t=e.observer.latest();if(!t)continue;const s=e.path;let i=!1;t.history&&(i=t.history.enabled,t.history.enabled=!1),t.removeValue(s,e.value),i&&(t.history.enabled=!0)}};this._history&&i.length&&this._history.add({name:this._getHistoryActionName(s),redo:n,combine:this._historyCombine,undo:()=>{for(const e of i){const t=e.observer.latest();if(!t)continue;const s=e.path;let i=!1;t.history&&(i=t.history.enabled,t.history.enabled=!1),-1===t.get(s).indexOf(e.value)&&t.insert(s,e.value,e.index),i&&(t.history.enabled=!0)}}}),n(),this.applyingChange=!1}setValue(e){this._setValue(e,!1)}setValues(e){e=e.slice().map((e=>Array.isArray(e)?e.slice():e)),this._setValue(e,!0)}addValue(e){this._addValues([e])}addValues(e){this._addValues(e)}removeValue(e){this._removeValues([e])}removeValues(e){this._removeValues(e)}}var ot=at;class lt extends rt{constructor(e={}){super(e),this._events=[],this._updateTimeout=null,this._deferUpdateElement=()=>{this.applyingChange||(this.applyingChange=!0,this._updateTimeout=window.setTimeout((()=>{this._updateElement()})))},this._customUpdate=e.customUpdate}_linkObserver(e,t){this._events.push(e.on(t+":set",this._deferUpdateElement)),this._events.push(e.on(t+":unset",this._deferUpdateElement)),this._events.push(e.on(t+":insert",this._deferUpdateElement)),this._events.push(e.on(t+":remove",this._deferUpdateElement))}_updateElement(){this._updateTimeout&&(window.clearTimeout(this._updateTimeout),this._updateTimeout=null),this._updateTimeout=null,this.applyingChange=!0,this._element&&("function"==typeof this._customUpdate?this._customUpdate(this._element,this._observers,this._paths):1===this._observers.length?this._paths.length>1?this._element.value=this._paths.map((e=>this._observers[0].has(e)?this._observers[0].get(e):void 0)):this._element.value=this._observers[0].has(this._paths[0])?this._observers[0].get(this._paths[0]):void 0:this._element.values=this._observers.map(((e,t)=>{const s=this._pathAt(this._paths,t);return e.has(s)?e.get(s):void 0})),this.applyingChange=!1)}link(e,t){if(super.link(e,t),this._element){const e=this._element.renderChanges;this._element.renderChanges=!1,this._updateElement(),this._element.renderChanges=e}if(1===this._observers.length&&this._paths.length>1)for(let e=0;e<this._paths.length;e++)this._linkObserver(this._observers[0],this._paths[e]);else for(let e=0;e<this._observers.length;e++)this._linkObserver(this._observers[e],this._pathAt(this._paths,e))}unlink(){for(const e of this._events)e.unbind();this._events.length=0,this._updateTimeout&&(window.clearTimeout(this._updateTimeout),this._updateTimeout=null),super.unlink()}clone(){return new lt({customUpdate:this._customUpdate})}}var ht=lt;class ct extends rt{constructor(e={}){super(e),this._bindingElementToObservers=e.bindingElementToObservers||new ot(e),this._bindingObserversToElement=e.bindingObserversToElement||new ht(e),this._bindingElementToObservers.on("applyingChange",(e=>{this.applyingChange=e})),this._bindingElementToObservers.on("history:init",(e=>{this.emit("history:init",e)})),this._bindingElementToObservers.on("history:undo",(e=>{this.emit("history:undo",e)})),this._bindingElementToObservers.on("history:redo",(e=>{this.emit("history:redo",e)})),this._bindingObserversToElement.on("applyingChange",(e=>{this.applyingChange=e}))}link(e,t){super.link(e,t),this._bindingElementToObservers.link(e,t),this._bindingObserversToElement.link(e,t)}unlink(){this._bindingElementToObservers.unlink(),this._bindingObserversToElement.unlink(),super.unlink()}clone(){return new ct({bindingElementToObservers:this._bindingElementToObservers.clone(),bindingObserversToElement:this._bindingObserversToElement.clone()})}setValue(e){this._bindingElementToObservers.setValue(e)}setValues(e){this._bindingElementToObservers.setValues(e)}addValue(e){this._bindingElementToObservers.addValue(e)}addValues(e){this._bindingElementToObservers.addValues(e)}removeValue(e){this._bindingElementToObservers.removeValue(e)}removeValues(e){this._bindingElementToObservers.removeValues(e)}set element(e){this._element=e,this._bindingElementToObservers.element=e,this._bindingObserversToElement.element=e}get element(){return this._element}set applyingChange(e){super.applyingChange!==e&&(this._bindingElementToObservers.applyingChange=e,this._bindingObserversToElement.applyingChange=e,super.applyingChange=e)}get applyingChange(){return super.applyingChange}set historyCombine(e){this._bindingElementToObservers.historyCombine=e}get historyCombine(){return this._bindingElementToObservers.historyCombine}set historyPrefix(e){this._bindingElementToObservers.historyPrefix=e}get historyPrefix(){return this._bindingElementToObservers.historyPrefix}set historyPostfix(e){this._bindingElementToObservers.historyPostfix=e}get historyPostfix(){return this._bindingElementToObservers.historyPostfix}set historyEnabled(e){this._bindingElementToObservers.historyEnabled=e}get historyEnabled(){return this._bindingElementToObservers.historyEnabled}}var dt=ct;function ut(e){if(null==e||"object"!=typeof e)return e;if(e instanceof Array){const t=[];for(let s=0;s<e.length;s++)t[s]=ut(e[s]);return t}const t={};for(const s in e)e.hasOwnProperty(s)&&(t[s]=ut(e[s]));return t}function pt(e,t){if(!e)return!1;if(!t)return!1;if(e.length!==t.length)return!1;for(let s=0,i=e.length;s<i;s++)if(e[s]instanceof Array&&t[s]instanceof Array){if(!e[s].equals(t[s]))return!1}else if(e[s]!==t[s])return!1;return!0}const mt="pcui-flex",_t="pcui-grid",ft="pcui-hidden",gt="pcui-scrollable",vt="pcui-resizable",yt="pcui-readonly",bt="pcui-disabled",xt="pcui-collapsible",wt="pcui-collapsed",St="pcui-focus",Ct="pcui-multiple-values",Tt="pcui-error",At="flash",Et="pcui-not-flexible",Pt="font-regular",Mt="font-bold",Lt=["flexDirection","flexGrow","flexBasis","flexShrink","flexWrap","alignItems","alignSelf","justifyContent","justifySelf"],Dt=new Map;class kt extends st{constructor(e={}){var t,s,i;if(super(),this._destroyed=!1,this._parent=null,this._eventsParent=[],this._flashTimeout=null,this._suppressChange=!1,this._onMouseOver=e=>{this.emit("hover",e)},this._onMouseOut=e=>{this.emit("hoverend",e)},"string"==typeof e.dom?this._dom=document.createElement(e.dom):e.dom instanceof Node?this._dom=e.dom:this._dom=document.createElement("div"),void 0!==e.id&&(this._dom.id=e.id),this._dom.ui=this,this._onClickEvt=this._onClick.bind(this),this._dom.addEventListener("click",this._onClickEvt),this._dom.addEventListener("mouseover",this._onMouseOver),this._dom.addEventListener("mouseout",this._onMouseOut),this._dom.classList.add("pcui-element",Pt),e.class){const t=Array.isArray(e.class)?e.class:[e.class];for(const e of t)this._dom.classList.add(e)}this.enabled=void 0===e.enabled||e.enabled,this._hiddenParents=!e.isRoot,this.hidden=null!==(t=e.hidden)&&void 0!==t&&t,this.readOnly=null!==(s=e.readOnly)&&void 0!==s&&s,this.ignoreParent=null!==(i=e.ignoreParent)&&void 0!==i&&i,void 0!==e.width&&(this.width=e.width),void 0!==e.height&&(this.height=e.height),void 0!==e.tabIndex&&(this.tabIndex=e.tabIndex);for(const t in e)void 0!==e[t]&&-1!==Lt.indexOf(t)&&(this[t]=e[t]);e.binding&&(this.binding=e.binding)}destroy(){if(this._destroyed)return;if(this._destroyed=!0,this.binding?this.binding=null:this.unlink(),this.parent){const e=this.parent;for(const e of this._eventsParent)e.unbind();this._eventsParent.length=0,e.remove&&!e._destroyed&&e.remove(this),this._parent=null,!e._destroyed&&this._dom&&this._dom.parentElement&&this._dom.parentElement.removeChild(this._dom)}const e=this._dom;e&&(e.removeEventListener("click",this._onClickEvt),e.removeEventListener("mouseover",this._onMouseOver),e.removeEventListener("mouseout",this._onMouseOut),delete e.ui,this._dom=null),this._flashTimeout&&window.clearTimeout(this._flashTimeout),this.emit("destroy",e,this),this.unbind()}link(e,t){this._binding&&this._binding.link(e,t)}unlink(){this._binding&&this._binding.unlink()}flash(){this._flashTimeout||(this.class.add(At),this._flashTimeout=window.setTimeout((()=>{this._flashTimeout=null,this.class.remove(At)}),200))}_onClick(e){this.enabled&&this.emit("click",e)}_onHiddenToRootChange(e){this.emit(e?"hideToRoot":"showToRoot")}_onEnabledChange(e){e?this.class.remove(bt):this.class.add(bt),this.emit(e?"enable":"disable")}_onParentDestroy(){this.destroy()}_onParentDisable(){this._ignoreParent||this._enabled&&this._onEnabledChange(!1)}_onParentEnable(){this._ignoreParent||this._enabled&&this._onEnabledChange(!0)}_onParentShowToRoot(){const e=this.hiddenToRoot;this._hiddenParents=!1,e!==this.hiddenToRoot&&this._onHiddenToRootChange(this.hiddenToRoot)}_onParentHideToRoot(){const e=this.hiddenToRoot;this._hiddenParents=!0,e!==this.hiddenToRoot&&this._onHiddenToRootChange(this.hiddenToRoot)}_onReadOnlyChange(e){e?this.class.add(yt):this.class.remove(yt),this.emit("readOnly",e)}_onParentReadOnlyChange(e){this._ignoreParent||(e?this._readOnly||this._onReadOnlyChange(!0):this._readOnly||this._onReadOnlyChange(!1))}unbind(e,t){return super.unbind(e,t)}static register(e,t,s){Dt.set(e,{cls:t,defaultArguments:s})}static unregister(e){Dt.delete(e)}static create(e,t){const s=Dt.get(e);if(!s)return void console.error("Invalid type passed to Element.create:",e);return new(0,s.cls)(Object.assign(Object.assign({},s.defaultArguments),t))}set enabled(e){if(this._enabled===e)return;const t=this.enabled;this._enabled=e,t!==e&&this._onEnabledChange(e)}get enabled(){return this._ignoreParent?this._enabled:this._enabled&&(!this._parent||this._parent.enabled)}set ignoreParent(e){this._ignoreParent=e,this._onEnabledChange(this.enabled),this._onReadOnlyChange(this.readOnly)}get ignoreParent(){return this._ignoreParent}get dom(){return this._dom}set parent(e){if(e===this._parent)return;const t=this.enabled,s=this.readOnly,i=this.hiddenToRoot;if(this._parent){for(let e=0;e<this._eventsParent.length;e++)this._eventsParent[e].unbind();this._eventsParent.length=0}this._parent=e,this._parent?(this._eventsParent.push(this._parent.once("destroy",this._onParentDestroy.bind(this))),this._eventsParent.push(this._parent.on("disable",this._onParentDisable.bind(this))),this._eventsParent.push(this._parent.on("enable",this._onParentEnable.bind(this))),this._eventsParent.push(this._parent.on("readOnly",this._onParentReadOnlyChange.bind(this))),this._eventsParent.push(this._parent.on("showToRoot",this._onParentShowToRoot.bind(this))),this._eventsParent.push(this._parent.on("hideToRoot",this._onParentHideToRoot.bind(this))),this._hiddenParents=this._parent.hiddenToRoot):this._hiddenParents=!0,this.emit("parent",this._parent);const n=this.enabled;n!==t&&this._onEnabledChange(n);const r=this.readOnly;r!==s&&this._onReadOnlyChange(r);const a=this.hiddenToRoot;a!==i&&this._onHiddenToRootChange(a)}get parent(){return this._parent}set hidden(e){if(e===this._hidden)return;const t=this.hiddenToRoot;this._hidden=e,e?this.class.add(ft):this.class.remove(ft),this.emit(e?"hide":"show"),this.hiddenToRoot!==t&&this._onHiddenToRootChange(this.hiddenToRoot)}get hidden(){return this._hidden}get hiddenToRoot(){return this._hidden||this._hiddenParents}set readOnly(e){this._readOnly!==e&&(this._readOnly=e,this._onReadOnlyChange(e))}get readOnly(){return this._ignoreParent?this._readOnly:this._readOnly||!(!this._parent||!this._parent.readOnly)}set error(e){this._hasError!==e&&(this._hasError=e,e?this.class.add(Tt):this.class.remove(Tt))}get error(){return this._hasError}get style(){return this._dom.style}get class(){return this._dom.classList}set width(e){"number"==typeof e&&(e=String(e)+"px"),this.style.width=e}get width(){return this._dom.clientWidth}set height(e){"number"==typeof e&&(e=String(e)+"px"),this.style.height=e}get height(){return this._dom.clientHeight}set tabIndex(e){this._dom.tabIndex=e}get tabIndex(){return this._dom.tabIndex}set binding(e){if(this._binding===e)return;let t,s;this._binding&&(t=this._binding.observers,s=this._binding.paths,this.unlink(),this._binding.element=null,this._binding=null),this._binding=e,this._binding&&(this._binding.element=this,t&&s&&this.link(t,s))}get binding(){return this._binding}get destroyed(){return this._destroyed}set flexDirection(e){this.style.flexDirection=e}get flexDirection(){return this.style.flexDirection}set flexGrow(e){this.style.flexGrow=e}get flexGrow(){return this.style.flexGrow}set flexBasis(e){this.style.flexBasis=e}get flexBasis(){return this.style.flexBasis}set flexShrink(e){this.style.flexShrink=e}get flexShrink(){return this.style.flexShrink}set flexWrap(e){this.style.flexWrap=e}get flexWrap(){return this.style.flexWrap}set alignItems(e){this.style.alignItems=e}get alignItems(){return this.style.alignItems}set alignSelf(e){this.style.alignSelf=e}get alignSelf(){return this.style.alignSelf}set justifyContent(e){this.style.justifyContent=e}get justifyContent(){return this.style.justifyContent}set justifySelf(e){this.style.justifySelf=e}get justifySelf(){return this.style.justifySelf}set disabled(e){this.enabled=!e}get disabled(){return!this.enabled}set element(e){this._dom=e}get element(){return this.dom}set innerElement(e){this._domContent=e}get innerElement(){return this._domContent}}kt.EVENT_ENABLE="enable",kt.EVENT_DISABLE="disable",kt.EVENT_HIDE="hide",kt.EVENT_HIDE_TO_ROOT="hideToRoot",kt.EVENT_SHOW="show",kt.EVENT_SHOW_TO_ROOT="showToRoot",kt.EVENT_READ_ONLY="readOnly",kt.EVENT_PARENT="parent",kt.EVENT_CLICK="click",kt.EVENT_HOVER="hover",kt.EVENT_HOVER_END="hoverend",kt.EVENT_DESTROY="destroy";var It=kt;const Rt=[null,"top","right","bottom","left"],Ot=vt+"-resizing",zt="pcui-container",Ft=zt+"-dragged",Vt=Ft+"-child";class Nt extends It{constructor(e={}){var t;super(e),this._scrollable=!1,this._flex=!1,this._grid=!1,this._domResizeHandle=null,this._resizePointerId=null,this._resizeData=null,this._resizeHorizontally=!0,this._resizeMin=100,this._resizeMax=300,this._draggedStartIndex=-1,this._onScroll=e=>{this.emit("scroll",e)},this._onResizeStart=e=>{null===this._resizePointerId&&(e.preventDefault(),e.stopPropagation(),this._domResizeHandle.setPointerCapture(e.pointerId),this._resizePointerId=e.pointerId,this._resizeStart())},this._onResizeMove=e=>{this._resizePointerId===e.pointerId&&(e.preventDefault(),e.stopPropagation(),this._resizeMove(e.clientX,e.clientY))},this._onResizeEnd=e=>{this._resizePointerId===e.pointerId&&(e.preventDefault(),e.stopPropagation(),this._resizeEnd(),this._domResizeHandle.releasePointerCapture(e.pointerId),this._resizePointerId=null)},this.class.add(zt),this.domContent=this._dom,e.scrollable&&(this.scrollable=!0),this.flex=!!e.flex;let s=!!e.grid;s&&this.flex&&(console.error('Invalid Container arguments: "grid" and "flex" cannot both be true.'),s=!1),this.grid=s,this.resizable=null!==(t=e.resizable)&&void 0!==t?t:null,void 0!==e.resizeMin&&(this.resizeMin=e.resizeMin),void 0!==e.resizeMax&&(this.resizeMax=e.resizeMax)}destroy(){this._destroyed||(this.domContent=null,this._domResizeHandle&&(this._domResizeHandle.removeEventListener("pointerdown",this._onResizeStart),this._domResizeHandle.removeEventListener("pointermove",this._onResizeMove),this._domResizeHandle.removeEventListener("pointerup",this._onResizeEnd)),super.destroy())}append(e){const t=this._getDomFromElement(e);this._domContent.appendChild(t),this._onAppendChild(e)}appendBefore(e,t){const s=this._getDomFromElement(e);this._domContent.appendChild(s);const i=t&&this._getDomFromElement(t);this._domContent.insertBefore(s,i),this._onAppendChild(e)}appendAfter(e,t){const s=this._getDomFromElement(e),i=t&&this._getDomFromElement(t),n=i?i.nextSibling:null;n?this._domContent.insertBefore(s,n):this._domContent.appendChild(s),this._onAppendChild(e)}prepend(e){const t=this._getDomFromElement(e),s=this._domContent.firstChild;s?this._domContent.insertBefore(t,s):this._domContent.appendChild(t),this._onAppendChild(e)}remove(e){if(e.parent!==this)return;const t=this._getDomFromElement(e);this._domContent.removeChild(t),this._onRemoveChild(e)}move(e,t){let s=-1;for(let t=0;t<this.dom.childNodes.length;t++)if(this.dom.childNodes[t].ui===e){s=t;break}-1===s?this.appendBefore(e,this.dom.childNodes[t]):t!==s&&(this.remove(e),t<s?this.appendBefore(e,this.dom.childNodes[t]):this.appendAfter(e,this.dom.childNodes[t-1]))}clear(){let e=this._domContent.childNodes.length;for(;e--;){const t=this._domContent.childNodes[e];t.ui&&t.ui!==this&&t.ui.destroy()}this._domResizeHandle&&(this._domResizeHandle.removeEventListener("pointerdown",this._onResizeStart),this._domResizeHandle.removeEventListener("pointermove",this._onResizeMove),this._domResizeHandle.removeEventListener("pointerup",this._onResizeEnd),this._domResizeHandle=null),this._domContent.innerHTML="",this.resizable&&(this._createResizeHandle(),this._dom.appendChild(this._domResizeHandle))}_getDomFromElement(e){return e.dom?e.dom:e.element?e.element:e}_onAppendChild(e){e.parent=this,this.emit("append",e)}_onRemoveChild(e){e.parent=null,this.emit("remove",e)}_createResizeHandle(){const e=document.createElement("div");e.classList.add("pcui-resizable-handle"),e.ui=this,e.addEventListener("pointerdown",this._onResizeStart),e.addEventListener("pointermove",this._onResizeMove),e.addEventListener("pointerup",this._onResizeEnd),this._domResizeHandle=e}_resizeStart(){this.class.add(Ot)}_resizeMove(e,t){if(this._resizeData){if(this._resizeHorizontally){let t=this._resizeData.x-e;"right"===this._resizable&&(t=-t),this.width=4+Math.max(this._resizeMin,Math.min(this._resizeMax,this._resizeData.width+t))}else{let e=this._resizeData.y-t;"bottom"===this._resizable&&(e=-e),this.height=Math.max(this._resizeMin,Math.min(this._resizeMax,this._resizeData.height+e))}this.emit("resize")}else this._resizeData={x:e,y:t,width:this.dom.clientWidth,height:this.dom.clientHeight}}_resizeEnd(){this._resizeData=null,this.class.remove(Ot)}resize(e,t){e=e||0,t=t||0,this._resizeStart(),this._resizeMove(0,0),this._resizeMove(4-e,-t),this._resizeEnd()}_getDraggedChildIndex(e){for(let t=0;t<this.dom.childNodes.length;t++)if(this.dom.childNodes[t].ui===e)return t;return-1}_onChildDragStart(e,t){this.class.add(Vt),this._draggedStartIndex=this._getDraggedChildIndex(t),t.class.add(Ft),this.emit("child:dragstart",t,this._draggedStartIndex)}_onChildDragMove(e,t){const s=this.dom.getBoundingClientRect(),i=e.clientX<s.left||e.clientX>s.right||e.clientY<s.top||e.clientY>s.bottom,n=this._getDraggedChildIndex(t);if(i)return t.class.remove(Ft),void(this._draggedStartIndex!==n&&(this.remove(t),this._draggedStartIndex<n?this.appendBefore(t,this.dom.childNodes[this._draggedStartIndex]):this.appendAfter(t,this.dom.childNodes[this._draggedStartIndex-1])));t.class.add(Ft);const r=e.clientY-s.top;let a=null;for(let e=0;e<this.dom.childNodes.length;e++){const s=this.dom.childNodes[e].ui,i=s.dom.offsetTop;if(e<n){if(r<=i+s.header.height){a=e;break}}else if(e>n&&r+t.height>=i+s.height){a=e;break}}null!==a&&n!==a&&(this.remove(t),a<n?this.appendBefore(t,this.dom.childNodes[a]):this.appendAfter(t,this.dom.childNodes[a-1]))}_onChildDragEnd(e,t){this.class.remove(Vt),t.class.remove(Ft);const s=this._getDraggedChildIndex(t);this.emit("child:dragend",t,s,this._draggedStartIndex),this._draggedStartIndex=-1}forEachChild(e){for(let t=0;t<this.dom.childNodes.length;t++){const s=this.dom.childNodes[t].ui;if(s){if(!1===e(s,t))break}}}_buildDomNode(e){const t=Object.keys(e);let s;return t.includes("root")?(s=this._buildDomNode(e.root),e.children.forEach((e=>{const t=this._buildDomNode(e);null!==t&&s.append(t)}))):(s=e[t[0]],this[`_${t[0]}`]=s),s}buildDom(e){e.forEach((e=>{const t=this._buildDomNode(e);this.append(t)}))}set flex(e){e!==this._flex&&(this._flex=e,e?this.class.add(mt):this.class.remove(mt))}get flex(){return this._flex}set grid(e){e!==this._grid&&(this._grid=e,e?this.class.add(_t):this.class.remove(_t))}get grid(){return this._grid}set scrollable(e){this._scrollable!==e&&(this._scrollable=e,e?this.class.add(gt):this.class.remove(gt))}get scrollable(){return this._scrollable}set resizable(e){e!==this._resizable&&(-1!==Rt.indexOf(e)?(this._resizable&&this.class.remove(`${vt}-${this._resizable}`),this._resizable=e,this._resizeHorizontally="right"===e||"left"===e,e?(this.class.add(vt),this.class.add(`${vt}-${e}`),this._domResizeHandle||this._createResizeHandle(),this._dom.appendChild(this._domResizeHandle)):(this.class.remove(vt),this._domResizeHandle&&this._dom.removeChild(this._domResizeHandle))):console.error("Invalid resizable value: must be one of "+Rt.join(",")))}get resizable(){return this._resizable}set resizeMin(e){this._resizeMin=Math.max(0,Math.min(e,this._resizeMax))}get resizeMin(){return this._resizeMin}set resizeMax(e){this._resizeMax=Math.max(this._resizeMin,e)}get resizeMax(){return this._resizeMax}set domContent(e){this._domContent!==e&&(this._domContent&&this._domContent.removeEventListener("scroll",this._onScroll),this._domContent=e,this._domContent&&this._domContent.addEventListener("scroll",this._onScroll))}get domContent(){return this._domContent}}Nt.EVENT_APPEND="append",Nt.EVENT_REMOVE="remove",Nt.EVENT_SCROLL="scroll",Nt.EVENT_RESIZE="resize",It.register("container",Nt);var Bt=Nt;class Ut extends It{constructor(e={}){var t,s,i;super(Object.assign({dom:"span"},e)),this.class.add("pcui-label"),this._unsafe=null!==(t=e.unsafe)&&void 0!==t&&t,this.text=null!==(i=null!==(s=e.text)&&void 0!==s?s:e.value)&&void 0!==i?i:"",e.allowTextSelection&&this.class.add("pcui-default-mousedown"),e.nativeTooltip&&(this.dom.title=this.text),this.placeholder=e.placeholder,this.renderChanges=e.renderChanges,this.on("change",(()=>{this.renderChanges&&this.flash()}))}_updateText(e){return this.class.remove(Ct),this._text!==e&&(this._text=e,this._unsafe?this._dom.innerHTML=e:this._dom.textContent=e,this.emit("change",e),!0)}set text(e){null==e&&(e="");this._updateText(e)&&this._binding&&this._binding.setValue(e)}get text(){return this._text}set value(e){this.text=e}get value(){return this.text}set values(e){const t=e.some((t=>t!==e[0]));t?(this._updateText(""),this.class.add(Ct)):this._updateText(e[0])}set placeholder(e){e?this.dom.setAttribute("placeholder",e):this.dom.removeAttribute("placeholder")}get placeholder(){return this.dom.getAttribute("placeholder")}set renderChanges(e){this._renderChanges=e}get renderChanges(){return this._renderChanges}}It.register("label",Ut);var Ht=Ut;class Wt extends It{constructor(e={}){super(Object.assign({dom:"button"},e)),this._onKeyDown=e=>{"Escape"===e.key?this.blur():"Enter"===e.key&&this._onClick(e)},this.class.add("pcui-button"),this._unsafe=e.unsafe,this.text=e.text,this.size=e.size,this.icon=e.icon,this.dom.addEventListener("keydown",this._onKeyDown)}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),super.destroy())}_onClick(e){this.blur(),this.readOnly||super._onClick(e)}focus(){this.dom.focus()}blur(){this.dom.blur()}set text(e){this._text!==e&&(this._text=e,this._unsafe?this.dom.innerHTML=e:this.dom.textContent=e)}get text(){return this._text}set icon(e){this._icon!==e&&e.match(/^E[0-9]{0,4}$/)&&(this._icon=e,e?this.dom.setAttribute("data-icon",String.fromCodePoint(parseInt(e,16))):this.dom.removeAttribute("data-icon"))}get icon(){return this._icon}set size(e){this._size!==e&&(this._size&&(this.class.remove("pcui-"+this._size),this._size=null),this._size=e,this._size&&this.class.add("pcui-"+this._size))}get size(){return this._size}}It.register("button",Wt);var Gt=Wt;const jt="pcui-panel",qt=jt+"-header",Kt=qt+"-title",Xt=jt+"-content",Yt=jt+"-horizontal",Zt=jt+"-sortable-icon",$t=jt+"-remove";class Qt extends Bt{constructor(e={}){var t;const s=Object.assign(Object.assign({},e),{flex:!0});delete s.grid,delete s.flexDirection,delete s.scrollable,super(s),this._reflowTimeout=null,this._widthBeforeCollapse=null,this._heightBeforeCollapse=null,this._iconSort=null,this._btnRemove=null,this._onHeaderClick=e=>{this._collapsible&&(e.target!==this.header.dom&&e.target!==this._labelTitle.dom||(this.collapsed=!this.collapsed))},this._onDragStart=e=>{this.enabled&&!this.readOnly&&(e.stopPropagation(),e.preventDefault(),window.addEventListener("mouseup",this._onDragEndEvt),window.addEventListener("mouseleave",this._onDragEndEvt),window.addEventListener("mousemove",this._onDragMove),this.emit("dragstart"),this.parent&&this.parent._onChildDragStart&&this.parent._onChildDragStart(e,this))},this._onDragMove=e=>{this.emit("dragmove"),this.parent&&this.parent._onChildDragStart&&this.parent._onChildDragMove(e,this)},this.class.add(jt),e.panelType&&this.class.add(jt+"-"+e.panelType),this._suspendReflow=!0,this._initializeHeader(e),this._initializeContent(e),this.headerSize=null!==(t=e.headerSize)&&void 0!==t?t:32,this.collapsible=e.collapsible||!1,this.collapsed=e.collapsed||!1,this.collapseHorizontally=e.collapseHorizontally||!1,this.sortable=e.sortable||!1,this.removable=e.removable||!!e.onRemove||!1,this.domContent=this._containerContent.dom,this._suspendReflow=!1,this._reflow(),this._onDragEndEvt=this._onDragEnd.bind(this)}destroy(){this._destroyed||(this._reflowTimeout&&(cancelAnimationFrame(this._reflowTimeout),this._reflowTimeout=null),window.removeEventListener("mouseup",this._onDragEndEvt),window.removeEventListener("mouseleave",this._onDragEndEvt),window.removeEventListener("mousemove",this._onDragMove),super.destroy())}_initializeHeader(e){this._containerHeader=new Bt({flex:!0,flexDirection:"row",class:[qt,Mt]}),this._labelTitle=new Ht({text:e.headerText,class:[Kt,Mt]}),this._containerHeader.append(this._labelTitle),this._containerHeader.dom.addEventListener("click",this._onHeaderClick),this.append(this._containerHeader)}_onClickRemove(e){e.preventDefault(),e.stopPropagation(),this.emit("click:remove")}_initializeContent(e){this._containerContent=new Bt({class:Xt,grid:e.grid,flex:e.flex,flexDirection:e.flexDirection,scrollable:e.scrollable,dom:e.content}),this.append(this._containerContent)}_reflow(){this._suspendReflow||(this._reflowTimeout&&(cancelAnimationFrame(this._reflowTimeout),this._reflowTimeout=null),!this.hidden&&this.collapsible&&(this.collapsed&&this.collapseHorizontally?this._containerHeader.style.top=-this.headerSize+"px":this._containerHeader.style.top="",this._reflowTimeout=requestAnimationFrame((()=>{this._reflowTimeout=null,this.collapsed?(this._widthBeforeCollapse||(this._widthBeforeCollapse=this.style.width),this._heightBeforeCollapse||(this._heightBeforeCollapse=this.style.height),this._collapseHorizontally?(this.height="",this.width=this.headerSize):this.height=this.headerSize,this.class.add(wt)):(this.class.remove(wt),this._collapseHorizontally?(this.height="",null!==this._widthBeforeCollapse&&(this.width=this._widthBeforeCollapse)):null!==this._heightBeforeCollapse&&(this.height=this._heightBeforeCollapse),this._widthBeforeCollapse=null,this._heightBeforeCollapse=null)}))))}_onDragEnd(e){window.removeEventListener("mouseup",this._onDragEndEvt),window.removeEventListener("mouseleave",this._onDragEndEvt),window.removeEventListener("mousemove",this._onDragMove),this._draggedChild===this&&(this._draggedChild=null),this.emit("dragend"),this.parent&&this.parent._onChildDragStart&&this.parent._onChildDragEnd(e,this)}set collapsible(e){e!==this._collapsible&&(this._collapsible=e,e?this.class.add(xt):this.class.remove(xt),this._reflow(),this.collapsed&&this.emit(e?"collapse":"expand"))}get collapsible(){return this._collapsible}set collapsed(e){this._collapsed!==e&&(this._collapsed=e,this._reflow(),this.collapsible&&this.emit(e?"collapse":"expand"))}get collapsed(){return this._collapsed}set sortable(e){this._sortable!==e&&(this._sortable=e,e?(this._iconSort=new Ht({class:Zt}),this._iconSort.dom.addEventListener("mousedown",this._onDragStart),this.header.prepend(this._iconSort)):this._iconSort&&(this._iconSort.destroy(),this._iconSort=null))}get sortable(){return this._sortable}set removable(e){this.removable!==e&&(e?(this._btnRemove=new Gt({icon:"E289",class:$t}),this._btnRemove.on("click",this._onClickRemove.bind(this)),this.header.append(this._btnRemove)):(this._btnRemove.destroy(),this._btnRemove=null))}get removable(){return!!this._btnRemove}set collapseHorizontally(e){this._collapseHorizontally!==e&&(this._collapseHorizontally=e,e?this.class.add(Yt):this.class.remove(Yt),this._reflow())}get collapseHorizontally(){return this._collapseHorizontally}get content(){return this._containerContent}get header(){return this._containerHeader}set headerText(e){this._labelTitle.text=e}get headerText(){return this._labelTitle.text}set headerSize(e){this._headerSize=e;const t=this._containerHeader.dom.style;t.height=Math.max(0,e)+"px",t.lineHeight=t.height,this._reflow()}get headerSize(){return this._headerSize}}Qt.EVENT_COLLAPSE="collapse",Qt.EVENT_EXPAND="expand",It.register("panel",Qt);var Jt=Qt;var es=class extends It{constructor(e={}){var t,s,i,n,r;super(e),this._onInputFocus=e=>{this.class.add(St),this.emit("focus",e),this._prevValue=this._domInput.value},this._onInputBlur=e=>{this.class.remove(St),this.emit("blur",e)},this._onInputKeyUp=e=>{"Escape"!==e.key&&this._onInputChange(e),this.emit("keyup",e)},this._onInputCtxMenu=e=>{this._domInput.select()},this._updateInputReadOnly=()=>{!this.enabled||this.readOnly?this._domInput.setAttribute("readonly","true"):this._domInput.removeAttribute("readonly")},this.class.add("pcui-input-element");let a=e.input;a||(a=document.createElement("input"),a.type="text"),a.ui=this,a.tabIndex=0,a.autocomplete="off",this._onInputKeyDownEvt=this._onInputKeyDown.bind(this),this._onInputChangeEvt=this._onInputChange.bind(this),a.addEventListener("change",this._onInputChangeEvt),a.addEventListener("keydown",this._onInputKeyDownEvt),a.addEventListener("focus",this._onInputFocus),a.addEventListener("blur",this._onInputBlur),a.addEventListener("contextmenu",this._onInputCtxMenu,!1),this.dom.appendChild(a),this._domInput=a,this._suspendInputChangeEvt=!1,void 0!==e.value&&(this._domInput.value=e.value),this.placeholder=null!==(t=e.placeholder)&&void 0!==t?t:"",this.renderChanges=null!==(s=e.renderChanges)&&void 0!==s&&s,this.blurOnEnter=null===(i=e.blurOnEnter)||void 0===i||i,this.blurOnEscape=null===(n=e.blurOnEscape)||void 0===n||n,this.keyChange=null!==(r=e.keyChange)&&void 0!==r&&r,this._prevValue=null,this.on("change",(()=>{this.renderChanges&&this.flash()})),this.on("disable",this._updateInputReadOnly),this.on("enable",this._updateInputReadOnly),this.on("readOnly",this._updateInputReadOnly),this._updateInputReadOnly()}destroy(){if(this._destroyed)return;const e=this._domInput;e.removeEventListener("change",this._onInputChangeEvt),e.removeEventListener("keydown",this._onInputKeyDownEvt),e.removeEventListener("focus",this._onInputFocus),e.removeEventListener("blur",this._onInputBlur),e.removeEventListener("keyup",this._onInputKeyUp),e.removeEventListener("contextmenu",this._onInputCtxMenu),super.destroy()}_onInputKeyDown(e){if("Enter"===e.key&&this.blurOnEnter)this._suspendInputChangeEvt=this.keyChange,this._domInput.blur(),this._suspendInputChangeEvt=!1;else if("Escape"===e.key){this._suspendInputChangeEvt=!0;const t=this._domInput.value;this._domInput.value=this._prevValue,this._suspendInputChangeEvt=!1,this.keyChange&&t!==this._prevValue&&this._onInputChange(e),this.blurOnEscape&&this._domInput.blur()}this.emit("keydown",e)}_onInputChange(e){}focus(e){this._domInput.focus(),e&&this._domInput.select()}blur(){this._domInput.blur()}set placeholder(e){e?this.dom.setAttribute("placeholder",e):this.dom.removeAttribute("placeholder")}get placeholder(){var e;return null!==(e=this.dom.getAttribute("placeholder"))&&void 0!==e?e:""}set keyChange(e){this._keyChange!==e&&(this._keyChange=e,e?this._domInput.addEventListener("keyup",this._onInputKeyUp):this._domInput.removeEventListener("keyup",this._onInputKeyUp))}get keyChange(){return this._keyChange}get input(){return this._domInput}set blurOnEnter(e){this._blurOnEnter=e}get blurOnEnter(){return this._blurOnEnter}set blurOnEscape(e){this._blurOnEscape=e}get blurOnEscape(){return this._blurOnEscape}set renderChanges(e){this._renderChanges=e}get renderChanges(){return this._renderChanges}};const ts="pcui-numeric-input",ss=ts+"-slider-control",is=ss+"-active",ns=ss+"-hidden",rs=/,/g;class as extends es{constructor(e={}){var t,s,i,n;const r=Object.assign({},e);delete r.value,delete r.renderChanges,super(r),this._sliderUsed=!1,this._onSliderMouseWheel=e=>{this._updatePosition(e.deltaY,e.shiftKey)},this._onSliderMouseMove=e=>{this._updatePosition(e.movementX,e.shiftKey)},this._onSliderMouseDown=()=>{this._sliderControl.dom.requestPointerLock(),this._sliderMovement=0,this._sliderPrevValue=this.value,this._sliderUsed=!0,this.binding&&(this._historyCombine=this.binding.historyCombine,this._historyPostfix=this.binding.historyPostfix,this.binding.historyCombine=!0,this.binding.historyPostfix=`(${Date.now()})`)},this._onSliderMouseUp=()=>{document.exitPointerLock(),this._sliderUsed&&(this._sliderUsed=!1,this.value=this._sliderPrevValue+this._sliderMovement,this.binding&&(this.binding.historyCombine=this._historyCombine,this.binding.historyPostfix=this._historyPostfix,this._historyCombine=!1,this._historyPostfix=null),this.focus())},this._onPointerLockChange=()=>{this._isScrolling()?(this._sliderControl.dom.addEventListener("mousemove",this._onSliderMouseMove,!1),this._sliderControl.dom.addEventListener("wheel",this._onSliderMouseWheel,{passive:!0}),this._sliderControl.class.add(is)):(this._sliderControl.dom.removeEventListener("mousemove",this._onSliderMouseMove,!1),this._sliderControl.dom.removeEventListener("wheel",this._onSliderMouseWheel),this._sliderControl.class.remove(is))},this.class.add(ts),this._min=null!==(t=e.min)&&void 0!==t?t:null,this._max=null!==(s=e.max)&&void 0!==s?s:null,this._allowNull=null!==(i=e.allowNull)&&void 0!==i&&i,this._precision=null!==(n=e.precision)&&void 0!==n?n:7,Number.isFinite(e.step)?this._step=e.step:e.precision?this._step=10/Math.pow(10,e.precision):this._step=1,Number.isFinite(e.stepPrecision)?this._stepPrecision=e.stepPrecision:this._stepPrecision=.1*this._step,this._oldValue=void 0,Number.isFinite(e.value)?this.value=e.value:this._allowNull||(this.value=0),this._historyCombine=!1,this._historyPostfix=null,this._sliderPrevValue=0,this.renderChanges=e.renderChanges,e.hideSlider||(this._sliderControl=new It,this._sliderControl.class.add(ss),this.dom.append(this._sliderControl.dom),this._sliderControl.dom.addEventListener("mousedown",this._onSliderMouseDown),this._sliderControl.dom.addEventListener("mouseup",this._onSliderMouseUp),document.addEventListener("pointerlockchange",this._onPointerLockChange,!1))}destroy(){this.destroyed||(this._sliderControl&&(this._sliderControl.dom.removeEventListener("mousedown",this._onSliderMouseDown),this._sliderControl.dom.removeEventListener("mouseup",this._onSliderMouseUp),this._sliderControl.dom.removeEventListener("mousemove",this._onSliderMouseMove,!1),this._sliderControl.dom.removeEventListener("wheel",this._onSliderMouseWheel),document.removeEventListener("pointerlockchange",this._onPointerLockChange,!1)),super.destroy())}_updatePosition(e,t){this._sliderMovement+=e/100*(t?this._stepPrecision:this._step),this.value=this._sliderPrevValue+this._sliderMovement}_onInputChange(e){this.value=this._normalizeValue(this._domInput.value)}_onInputKeyDown(e){if(this.enabled&&!this.readOnly){if("ArrowUp"===e.key||"ArrowDown"===e.key){const t="ArrowDown"===e.key?-1:1;this.value+=(e.shiftKey?this._stepPrecision:this._step)*t}super._onInputKeyDown(e)}}_isScrolling(){return!!this._sliderControl&&document.pointerLockElement===this._sliderControl.dom}_normalizeValue(e){try{if("string"==typeof e){if("0"===e)return 0;if(null!==(e=(e=(e=e.replace(rs,".")).replace(/\s/g,"")).match(/^[*/+\-0-9().]+$/))&&e[0].length<20){let t=e[0];["+","-","/","*"].forEach((e=>{const s=t.split(e);s.forEach(((e,t)=>{s[t]=s[t].replace(/^0+/,"")})),t=s.join(e)})),e=Function('"use strict";return ('+t+")")()}}}catch(t){e=null}if(null===e||isNaN(e)){if(this._allowNull)return null;e=0}return null!==this.min&&e<this.min&&(e=this.min),null!==this.max&&e>this.max&&(e=this.max),null!==this.precision&&(e=parseFloat(Number(e).toFixed(this.precision))),e}_updateValue(e,t){const s=e!==this._oldValue||t;return this._oldValue=e,this._domInput.value=null===e?"":String(e),this.class.remove(Ct),s&&this.emit("change",e),s}set value(e){e=this._normalizeValue(e);const t=this.class.contains(Ct)&&null===e&&this._allowNull;this._updateValue(e,t)&&this.binding&&this.binding.setValue(e),this._sliderControl&&this._sliderControl.class.remove(ns)}get value(){const e=this._domInput.value;return""!==e?parseFloat(e):null}set values(e){const t=e.map((e=>this._normalizeValue(e))),s=t.some((e=>e!==t[0]));s?(this._updateValue(null),this.class.add(Ct),this._sliderControl&&this._sliderControl.class.add(ns)):(this._updateValue(t[0]),this._sliderControl&&this._sliderControl.class.remove(ns))}set min(e){this._min!==e&&(this._min=e,null!==this._min&&(this.value=this.value))}get min(){return this._min}set max(e){this._max!==e&&(this._max=e,null!==this._max&&(this.value=this.value))}get max(){return this._max}set precision(e){this._precision!==e&&(this._precision=e,null!==this._precision&&(this.value=this.value))}get precision(){return this._precision}set step(e){this._step=e}get step(){return this._step}}It.register("number",as,{renderChanges:!0});var os=as;const ls="pcui-array-input",hs="pcui-array-empty",cs=ls+"-size",ds=ls+"-items",us=ls+"-item",ps=us+"-delete";class ms extends It{constructor(e={}){var t,s,i;const n=new Bt({dom:e.dom,flex:!0}),r=Object.assign(Object.assign({},e),{dom:n.dom});delete r.binding,super(r),this._suspendSizeChangeEvt=!1,this._suspendArrayElementEvts=!1,this._arrayElementChangeTimeout=null,this._container=n,this._container.parent=this,this.class.add(ls,hs),this._usePanels=null!==(t=e.usePanels)&&void 0!==t&&t,this._fixedSize=!!e.fixedSize,this._inputSize=new os({class:[cs],placeholder:"Array Size",value:0,hideSlider:!0,step:1,precision:0,min:0,readOnly:this._fixedSize}),this._inputSize.on("change",(e=>{this._onSizeChange(e)})),this._inputSize.on("focus",(()=>{this.emit("focus")})),this._inputSize.on("blur",(()=>{this.emit("blur")})),this._container.append(this._inputSize),this._containerArray=new Bt({class:ds,hidden:!0}),this._containerArray.on("append",(()=>{this._containerArray.hidden=!1})),this._containerArray.on("remove",(()=>{this._containerArray.hidden=0===this._arrayElements.length})),this._container.append(this._containerArray),this._getDefaultFn=null!==(s=e.getDefaultFn)&&void 0!==s?s:null;let a=e.elementArgs&&e.elementArgs.type||e.type;ms.DEFAULTS.hasOwnProperty(a)||(a="string"),this._valueType=a,this._elementType=null!==(i=e.type)&&void 0!==i?i:"string",e.elementArgs?this._elementArgs=e.elementArgs:(delete r.dom,this._elementArgs=r),this._arrayElements=[],this.binding=e.binding,this._values=[],e.value&&(this.value=e.value),this.renderChanges=e.renderChanges||!1}destroy(){this._destroyed||(this._arrayElements.length=0,super.destroy())}_onSizeChange(e){if(0===e?this.class.add(hs):this.class.remove(hs),null===e)return;if(this._suspendSizeChangeEvt)return;let t;const s=()=>{if(this._getDefaultFn)t=this._getDefaultFn();else if(t=ms.DEFAULTS[this._valueType],"curveset"===this._valueType){if(t=ut(t),Array.isArray(this._elementArgs.curves))for(let e=0;e<this._elementArgs.curves.length;e++)t.keys.push([0,0])}else if("gradient"===this._valueType&&(t=ut(t),this._elementArgs.channels))for(let e=0;e<this._elementArgs.channels;e++)t.keys.push([0,1])},i=this._values.map((i=>{if(i)if(i.length<e){const n=new Array(e-i.length);for(let e=0;e<n.length;e++)void 0===t&&s(),n[e]=ut(t);i=i.concat(n)}else{const t=new Array(e);for(let s=0;s<e;s++)t[s]=ut(i[s]);i=t}else{i=new Array(e);for(let n=0;n<e;n++)void 0===t&&s(),i[n]=ut(t)}return i}));if(!i.length){const n=new Array(e);for(let i=0;i<e;i++)void 0===t&&s(),n[i]=ut(t);i.push(n)}this._updateValues(i,!0)}_createArrayElement(){const e=Object.assign({},this._elementArgs);let t;e.binding?e.binding=e.binding.clone():this._binding&&(e.binding=this._binding.clone()),e.renderChanges=!1,t=this._usePanels?new Jt({headerText:`[${this._arrayElements.length}]`,removable:!this._fixedSize,collapsible:!0,class:[us,us+"-"+this._elementType]}):new Bt({flex:!0,flexDirection:"row",alignItems:"center",class:[us,us+"-"+this._elementType]}),"json"===this._elementType&&e.attributes&&(e.attributes=e.attributes.map((e=>{if(!e.path)return e;const t=(e=Object.assign({},e)).path.split(".");return t.splice(t.length-1,0,this._arrayElements.length),e.path=t.join("."),e})));const s=It.create(this._elementType,e);t.append(s),s.renderChanges=this.renderChanges;const i={container:t,element:s};if(this._arrayElements.push(i),this._usePanels)t.on("click:remove",(()=>{this._removeArrayElement(i)}));else if(!this._fixedSize){const e=new Gt({icon:"E289",size:"small",class:ps,tabIndex:-1});e.on("click",(()=>{this._removeArrayElement(i)})),t.append(e)}return s.on("change",(e=>{this._onArrayElementChange(i,e)})),this._containerArray.append(t),i}_removeArrayElement(e){const t=this._arrayElements.indexOf(e);if(-1===t)return;const s=this._values.map((e=>e?(e.splice(t,1),e):null));this._updateValues(s,!0)}_onArrayElementChange(e,t){if(this._suspendArrayElementEvts)return;const s=this._arrayElements.indexOf(e);-1!==s&&(this._values.forEach((e=>{e&&e.length>s&&("curveset"===this._valueType?e[s]=Array.isArray(t)?t[0]:t:e[s]=t)})),this._arrayElementChangeTimeout=window.setTimeout((()=>{this._arrayElementChangeTimeout=null,this.emit("change",this.value)})))}_linkArrayElement(e,t){const s=this._binding.observers,i=this._binding.paths,n=1===i.length||s.length!==i.length;e.unlink(),e.value=null,this.emit("unlinkElement",e,t);const r=n?i[0]+`.${t}`:i.map((e=>`${e}.${t}`));e.link(s,r),this.emit("linkElement",e,t,r)}_updateValues(e,t){this._values=e||[],this._suspendArrayElementEvts=!0,this._suspendSizeChangeEvt=!0,t&&this._binding&&this._binding.setValues(e);const s=[],i=[];e.forEach((e=>{e&&(i.push(e.length),e.forEach(((e,t)=>{s[t]||(s[t]=[]),s[t].push(e)})))}));let n=-1;for(let t=0;t<s.length&&s[t].length===e.length;t++)this._arrayElements[t]||this._createArrayElement(),this._binding&&this._binding.observers?this._linkArrayElement(this._arrayElements[t].element,t):s[t].length>1?this._arrayElements[t].element.values=s[t]:this._arrayElements[t].element.value=s[t][0],n=t;for(let e=this._arrayElements.length-1;e>n;e--)this._arrayElements[e].container.destroy(),this._arrayElements.splice(e,1);this._inputSize.values=i,this._suspendSizeChangeEvt=!1,this._suspendArrayElementEvts=!1,this._arrayElementChangeTimeout&&(window.clearTimeout(this._arrayElementChangeTimeout),this._arrayElementChangeTimeout=null),this.emit("change",this.value)}focus(){this._inputSize.focus()}blur(){this._inputSize.blur()}unlink(){super.unlink(),this._arrayElements.forEach((e=>{e.element.unlink()}))}link(e,t){super.link(e,t),this._arrayElements.forEach(((e,t)=>{this._linkArrayElement(e.element,t)}))}forEachArrayElement(e){this._containerArray.forEachChild(((t,s)=>e(t.dom.firstChild.ui,s)))}set binding(e){super.binding=e,this._arrayElements.forEach((t=>{t.element.binding=e?e.clone():null}))}get binding(){return super.binding}set value(e){Array.isArray(e)||(e=[]);pt(this.value||[],e)||this._updateValues(new Array(this._values.length||1).fill(e),!0)}get value(){return this._arrayElements.map((e=>e.element.value))}set values(e){pt(this._values,e)||this._updateValues(e,!1)}set renderChanges(e){this._renderChanges=e,this._arrayElements.forEach((t=>{t.element.renderChanges=e}))}get renderChanges(){return this._renderChanges}}ms.DEFAULTS={boolean:!1,number:0,string:"",vec2:[0,0],vec3:[0,0,0],vec4:[0,0,0,0]};for(const e in ms.DEFAULTS)It.register(`array:${e}`,ms,{type:e,renderChanges:!0});It.register("array:select",ms,{type:"select",renderChanges:!0});var _s=ms;class fs extends n.exports.Component{constructor(e){super(e),this.attachElement=(e,t)=>{if(!e)return;this.elementClass===It?this.element=new this.elementClass(e,Object.assign(Object.assign({},this.props),{container:t,parent:void 0})):this.element=new this.elementClass(Object.assign(Object.assign({},this.props),{dom:e,content:t,parent:void 0}));const s=this.props.class;this.class=new Set(s?Array.isArray(s)?s.slice():[s]:void 0),this.onClick&&this.element.on("click",this.onClick),this.onRemove&&this.element.on("click:remove",this.onRemove),this.onChange&&this.element.on("change",this.onChange),this.props.parent&&(this.element.parent=this.props.parent),this.onAttach&&this.onAttach()},this.getPropertyDescriptor=(e,t)=>{let s;do{s=Object.getOwnPropertyDescriptor(e,t)}while(!s&&(e=Object.getPrototypeOf(e)));return s},this.elementClass=It,e.onClick&&(this.onClick=e.onClick),e.onRemove&&(this.onRemove=e.onRemove),e.onChange&&(this.onChange=e.onChange),e.link&&(this.link=e.link)}componentDidMount(){this.link&&this.element.link(this.link.observer,this.link.path)}componentDidUpdate(e){Object.keys(this.props).forEach((e=>{const t=this.getPropertyDescriptor(this.element,e);if(t&&t.set)"value"===e?(this.element._suppressChange=!0,this.element[e]=this.props[e],this.element._suppressChange=!1):this.element[e]=this.props[e];else if("class"===e){const t=this.props[e],s=new Set(t?Array.isArray(t)?t.slice():[t]:void 0);s.forEach((e=>{this.class.has(e)||(this.element.class.add(e),this.class.add(e))})),this.class.forEach((e=>{s.has(e)||(this.element.class.remove(e),this.class.delete(e))}))}})),e.link!==this.props.link&&this.props.link&&this.element.link(this.props.link.observer,this.props.link.path)}render(){return n.exports.createElement("div",{ref:this.attachElement})}}var gs=fs;class vs extends gs{constructor(e){super(e),this.elementClass=_s}render(){return super.render()}}vs.ctor=_s;var ys=vs;const bs="pcui-boolean-input",xs=bs+"-ticked",ws=bs+"-toggle";class Ss extends It{constructor(e={}){var t;super(Object.assign({tabIndex:0},e)),this._onKeyDown=e=>{"Escape"!==e.key?this.enabled&&!this.readOnly&&" "===e.key&&(e.stopPropagation(),e.preventDefault(),this.value=!this.value):this.blur()},this._onFocus=()=>{this.emit("focus")},this._onBlur=()=>{this.emit("blur")},"toggle"===e.type?this.class.add(ws):this.class.add(bs),this.class.add(Et),this.dom.addEventListener("keydown",this._onKeyDown),this.dom.addEventListener("focus",this._onFocus),this.dom.addEventListener("blur",this._onBlur),this._value=null,void 0!==e.value&&(this.value=e.value),this.renderChanges=null!==(t=e.renderChanges)&&void 0!==t&&t}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),this.dom.removeEventListener("focus",this._onFocus),this.dom.removeEventListener("blur",this._onBlur),super.destroy())}_onClick(e){return this.enabled&&this.focus(),this.enabled&&!this.readOnly&&(this.value=!this.value),super._onClick(e)}_updateValue(e){return this.class.remove(Ct),e!==this.value&&(this._value=e,e?this.class.add(xs):this.class.remove(xs),this.renderChanges&&this.flash(),this.emit("change",e),!0)}focus(){this.dom.focus()}blur(){this.dom.blur()}set value(e){this._updateValue(e)&&this._binding&&this._binding.setValue(e)}get value(){return this._value}set values(e){const t=e.some((t=>t!==e[0]));t?(this._updateValue(null),this.class.add(Ct)):this._updateValue(e[0])}set renderChanges(e){this._renderChanges=e}get renderChanges(){return this._renderChanges}}It.register("boolean",Ss,{renderChanges:!0});var Cs=Ss;class Ts extends gs{constructor(e={}){super(e),this.elementClass=Cs}render(){return super.render()}}Ts.ctor=Cs;var As=Ts;class Es extends gs{constructor(e={}){super(e),this.elementClass=Gt}render(){return n.exports.createElement("button",{ref:this.attachElement})}}Es.ctor=Gt;var Ps=Es;class Ms extends It{constructor(e={}){super(Object.assign({dom:"canvas"},e)),this._width=300,this._height=150,this._ratio=1,this.class.add("pcui-canvas");const{useDevicePixelRatio:t=!1}=e;this._ratio=t?window.devicePixelRatio:1,this.dom.onselectstart=e=>!1}resize(e,t){if(this._width===e&&this._height===t)return;this._width=e,this._height=t;const s=this._dom;s.width=this.pixelWidth,s.height=this.pixelHeight,s.style.width=e+"px",s.style.height=t+"px",this.emit("resize",e,t)}set width(e){if(this._width===e)return;this._width=e;const t=this._dom;t.width=this.pixelWidth,t.style.width=e+"px",this.emit("resize",this._width,this._height)}get width(){return this._width}set height(e){if(this._height===e)return;this._height=e;const t=this._dom;t.height=this.pixelHeight,t.style.height=e+"px",this.emit("resize",this._width,this._height)}get height(){return this._height}get pixelWidth(){return Math.floor(this._width*this._ratio)}get pixelHeight(){return Math.floor(this._height*this._ratio)}get pixelRatio(){return this._ratio}}It.register("canvas",Ms);var Ls=Ms;class Ds extends gs{constructor(e={}){super(e),this.elementClass=Ls}render(){return n.exports.createElement("canvas",{ref:this.attachElement})}}Ds.ctor=Ls;var ks=Ds;const Is="pcui-code",Rs=Is+"-inner";class Os extends Bt{constructor(e={}){super(e),this.class.add(Is),this._inner=new Ht({class:Rs}),this.append(this._inner),e.text&&(this.text=e.text)}set text(e){this._text=e,this._inner.text=e}get text(){return this._text}}It.register("code",Os);var zs=Os;class Fs extends gs{constructor(e){super(e),this.elementClass=zs}render(){return super.render()}}Fs.ctor=zs;var Vs=Fs;const Ns="pcui-overlay",Bs=Ns+"-inner",Us=Ns+"-clickable",Hs=Ns+"-transparent",Ws=Ns+"-content";class Gs extends Bt{constructor(e={}){super(e),this._onMouseDown=e=>{this.clickable&&(document.body.blur(),requestAnimationFrame((()=>{this.hidden=!0})),e.preventDefault())},this.class.add(Ns),this._domClickableOverlay=document.createElement("div"),this._domClickableOverlay.ui=this,this._domClickableOverlay.classList.add(Bs),this.dom.appendChild(this._domClickableOverlay),this._domClickableOverlay.addEventListener("mousedown",this._onMouseDown),this.domContent=document.createElement("div"),this.domContent.ui=this,this.domContent.classList.add(Ws),this.dom.appendChild(this.domContent),this.clickable=e.clickable||!1,this.transparent=e.transparent||!1}destroy(){this._destroyed||(this._domClickableOverlay.removeEventListener("mousedown",this._onMouseDown),super.destroy())}position(e,t){const s=this._domClickableOverlay.getBoundingClientRect(),i=this.domContent.getBoundingClientRect();e=Math.max(0,Math.min(s.width-i.width,e)),t=Math.max(0,Math.min(s.height-i.height,t)),this.domContent.style.position="absolute",this.domContent.style.left=`${e}px`,this.domContent.style.top=`${t}px`}set clickable(e){e?this.class.add(Us):this.class.remove(Us)}get clickable(){return this.class.contains(Us)}set transparent(e){e?this.class.add(Hs):this.class.remove(Hs)}get transparent(){return this.class.contains(Hs)}}It.register("overlay",Gs);var js=Gs;class qs extends es{constructor(e={}){super(e),this.class.add("pcui-text-input"),e.onValidate&&(this.onValidate=e.onValidate)}_onInputChange(e){if(!this._suspendInputChangeEvt){if(this._onValidate){const e=!this._onValidate(this.value);if(this.error=e,e)return}else this.error=!1;this.emit("change",this.value),this._binding&&this._binding.setValue(this.value)}}_updateValue(e){if(this.class.remove(Ct),e&&"object"==typeof e)if(Array.isArray(e)){let t=!1;for(let s=0;s<e.length;s++)if(e[s]&&"object"==typeof e[s]){t=!0;break}e=t?"[Not available]":e.map((e=>null===e?"null":e)).join(",")}else e="[Not available]";return e!==this.value&&(this._suspendInputChangeEvt=!0,this._domInput.value=null==e?"":String(e),this._suspendInputChangeEvt=!1,this.emit("change",e),!0)}set value(e){const t=this._updateValue(e);t&&(this.error=!1),t&&this._binding&&this._binding.setValue(e)}get value(){return this._domInput.value}set values(e){const t=e.some((t=>t!==e[0]));t?(this._updateValue(null),this.class.add(Ct)):this._updateValue(e[0])}set onValidate(e){this._onValidate=e}get onValidate(){return this._onValidate}}It.register("string",qs,{renderChanges:!0});var Ks=qs;function Xs(e){const t=e[0]/255,s=e[1]/255,i=e[2]/255;let n,r;const a=Math.max(t,s,i),o=a-Math.min(t,s,i),l=e=>(a-e)/6/o+.5;if(0===o)return n=r=0,[n,r,a];r=o/a;const h=l(t),c=l(s),d=l(i);return t===a?n=d-c:s===a?n=1/3+h-d:i===a&&(n=2/3+c-h),n<0?n+=1:n>1&&(n-=1),[n,r,a]}function Ys(e){const t=e[0],s=e[1],i=e[2];let n,r,a;const o=Math.floor(6*t),l=6*t-o,h=i*(1-s),c=i*(1-l*s),d=i*(1-(1-l)*s);switch(o%6){case 0:n=i,r=d,a=h;break;case 1:n=c,r=i,a=h;break;case 2:n=h,r=i,a=d;break;case 3:n=h,r=c,a=i;break;case 4:n=d,r=h,a=i;break;case 5:n=i,r=h,a=c}return[Math.round(255*n),Math.round(255*r),Math.round(255*a)]}class Zs extends It{constructor(e={}){var t,s,i;super(e),this._historyCombine=!1,this._historyPostfix=null,this._size=144,this._directInput=!0,this._colorHSV=[0,0,0],this._pickerChannels=[],this._channelsNumber=4,this._changing=!1,this._dragging=!1,this._callingCallback=!1,this._pickRectPointerId=null,this._pickHuePointerId=null,this._pickOpacityPointerId=null,this._evtColorPick=null,this._evtColorToPicker=null,this._evtColorPickStart=null,this._evtColorPickEnd=null,this._onKeyDown=e=>{"Escape"===e.key&&this.blur(),"Enter"===e.key&&this.enabled&&!this.readOnly&&(e.stopPropagation(),e.preventDefault())},this._onFocus=e=>{this.emit("focus")},this._onBlur=e=>{this.emit("blur")},this._pickRectPointerDown=e=>{null===this._pickRectPointerId&&(this._pickRect.setPointerCapture(e.pointerId),this._pickRectPointerId=e.pointerId,e.preventDefault(),e.stopPropagation(),this.emit("picker:color:start"),this._pickRectPointerMove(e))},this._pickRectPointerMove=e=>{if(this._pickRectPointerId!==e.pointerId)return;this._changing=!0;const t=this._pickRect.getBoundingClientRect(),s=Math.max(0,Math.min(this._size,Math.floor(e.clientX-t.left))),i=Math.max(0,Math.min(this._size,Math.floor(e.clientY-t.top)));this._colorHSV[1]=s/this._size,this._colorHSV[2]=1-i/this._size,this._directInput=!1;const n=Ys(this._colorHSV);for(let e=0;e<3;e++)this._pickerChannels[e].value=n[e];this._fieldHex.value=this._getHex(),this._directInput=!0,this._pickRectHandle.style.left=Math.max(4,Math.min(this._size-4,s))+"px",this._pickRectHandle.style.top=Math.max(4,Math.min(this._size-4,i))+"px",this._changing=!1},this._pickRectPointerUp=e=>{this._pickRectPointerId===e.pointerId&&(this.emit("picker:color:end"),this._pickRect.releasePointerCapture(e.pointerId),this._pickRectPointerId=null)},this._pickHuePointerDown=e=>{null===this._pickHuePointerId&&(this._pickHue.setPointerCapture(e.pointerId),this._pickHuePointerId=e.pointerId,e.preventDefault(),e.stopPropagation(),this.emit("picker:color:start"),this._pickHuePointerMove(e))},this._pickHuePointerMove=e=>{if(this._pickHuePointerId!==e.pointerId)return;this._changing=!0;const t=this._pickHue.getBoundingClientRect(),s=Math.max(0,Math.min(this._size,Math.floor(e.clientY-t.top)))/this._size,i=Ys([s,this._colorHSV[1],this._colorHSV[2]]);this._colorHSV[0]=s,this._directInput=!1;for(let e=0;e<3;e++)this._pickerChannels[e].value=i[e];this._fieldHex.value=this._getHex(),this._onChangeRgb(),this._directInput=!0,this._changing=!1},this._pickHuePointerUp=e=>{this._pickHuePointerId===e.pointerId&&(this.emit("picker:color:end"),this._pickHue.releasePointerCapture(e.pointerId),this._pickHuePointerId=null)},this._pickOpacityPointerDown=e=>{null===this._pickOpacityPointerId&&(this._pickOpacity.setPointerCapture(e.pointerId),this._pickOpacityPointerId=e.pointerId,e.preventDefault(),e.stopPropagation(),this.emit("picker:color:start"),this._pickOpacityPointerMove(e))},this._pickOpacityPointerMove=e=>{if(this._pickOpacityPointerId!==e.pointerId)return;this._changing=!0;const t=this._pickOpacity.getBoundingClientRect(),s=1-Math.max(0,Math.min(this._size,Math.floor(e.clientY-t.top)))/this._size;this._directInput=!1,this._pickerChannels[3].value=Math.max(0,Math.min(255,Math.round(255*s))),this._fieldHex.value=this._getHex(),this._directInput=!0,this._changing=!1},this._pickOpacityPointerUp=e=>{this._pickOpacityPointerId===e.pointerId&&(this.emit("picker:color:end"),this._pickOpacity.releasePointerCapture(e.pointerId),this._pickOpacityPointerId=null)},this.class.add("pcui-color-input",Et),this._domColor=document.createElement("div"),this.dom.appendChild(this._domColor),this.dom.addEventListener("keydown",this._onKeyDown),this.dom.addEventListener("focus",this._onFocus),this.dom.addEventListener("blur",this._onBlur),this.on("click",(()=>{this.enabled&&!this.readOnly&&this._openColorPicker()})),this._value=null!==(t=e.value)&&void 0!==t?t:[0,0,255,1],this._channels=null!==(s=e.channels)&&void 0!==s?s:3,this._setValue(this._value),this.renderChanges=null!==(i=e.renderChanges)&&void 0!==i&&i,this.on("change",(()=>{this.renderChanges&&this.flash()})),this._overlay=new js({class:"picker-color",clickable:!0,hidden:!0,transparent:!0}),this.dom.appendChild(this._overlay.dom),this._pickRect=document.createElement("div"),this._pickRect.classList.add("pick-rect"),this._overlay.append(this._pickRect),this._pickRect.addEventListener("pointerdown",this._pickRectPointerDown),this._pickRect.addEventListener("pointermove",this._pickRectPointerMove),this._pickRect.addEventListener("pointerup",this._pickRectPointerUp),this._pickRectWhite=document.createElement("div"),this._pickRectWhite.classList.add("white"),this._pickRect.appendChild(this._pickRectWhite),this._pickRectBlack=document.createElement("div"),this._pickRectBlack.classList.add("black"),this._pickRect.appendChild(this._pickRectBlack),this._pickRectHandle=document.createElement("div"),this._pickRectHandle.classList.add("handle"),this._pickRect.appendChild(this._pickRectHandle),this._pickHue=document.createElement("div"),this._pickHue.classList.add("pick-hue"),this._overlay.append(this._pickHue),this._pickHue.addEventListener("pointerdown",this._pickHuePointerDown),this._pickHue.addEventListener("pointermove",this._pickHuePointerMove),this._pickHue.addEventListener("pointerup",this._pickHuePointerUp),this._pickHueHandle=document.createElement("div"),this._pickHueHandle.classList.add("handle"),this._pickHue.appendChild(this._pickHueHandle),this._pickOpacity=document.createElement("div"),this._pickOpacity.classList.add("pick-opacity"),this._overlay.append(this._pickOpacity),this._pickOpacity.addEventListener("pointerdown",this._pickOpacityPointerDown),this._pickOpacity.addEventListener("pointermove",this._pickOpacityPointerMove),this._pickOpacity.addEventListener("pointerup",this._pickOpacityPointerUp),this._pickOpacityHandle=document.createElement("div"),this._pickOpacityHandle.classList.add("handle"),this._pickOpacity.appendChild(this._pickOpacityHandle),this._panelFields=document.createElement("div"),this._panelFields.classList.add("fields"),this._overlay.append(this._panelFields),this._overlay.on("hide",(()=>{this._evtColorPick.unbind(),this._evtColorPick=null,this._evtColorToPicker.unbind(),this._evtColorToPicker=null,this._evtColorPickStart.unbind(),this._evtColorPickStart=null,this._evtColorPickEnd.unbind(),this._evtColorPickEnd=null}));const n=e=>new os({class:["field","field-"+e],precision:0,step:1,min:0,max:255,placeholder:e}),r=n("r");r.on("change",(()=>{this._onChangeRgb()})),this._pickerChannels.push(r),this._panelFields.appendChild(r.dom);const a=n("g");a.on("change",(()=>{this._onChangeRgb()})),this._pickerChannels.push(a),this._panelFields.appendChild(a.dom);const o=n("b");o.on("change",(()=>{this._onChangeRgb()})),this._pickerChannels.push(o),this._panelFields.appendChild(o.dom);const l=n("a");l.on("change",(e=>{this._onChangeAlpha(e)})),this._pickerChannels.push(l),this._panelFields.appendChild(l.dom),this._fieldHex=new Ks({class:["field","field-hex"],placeholder:"#"}),this._fieldHex.on("change",(()=>{this._onChangeHex()})),this._panelFields.appendChild(this._fieldHex.dom)}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),this.dom.removeEventListener("focus",this._onFocus),this.dom.removeEventListener("blur",this._onBlur),this._pickRect.removeEventListener("pointerdown",this._pickRectPointerDown),this._pickRect.removeEventListener("pointermove",this._pickRectPointerMove),this._pickRect.removeEventListener("pointerup",this._pickRectPointerUp),this._pickHue.removeEventListener("pointerdown",this._pickHuePointerDown),this._pickHue.removeEventListener("pointermove",this._pickHuePointerMove),this._pickHue.removeEventListener("pointerup",this._pickHuePointerUp),this._pickOpacity.removeEventListener("pointerdown",this._pickOpacityPointerDown),this._pickOpacity.removeEventListener("pointermove",this._pickOpacityPointerMove),this._pickOpacity.removeEventListener("pointerup",this._pickOpacityPointerUp),super.destroy())}focus(){this.dom.focus()}blur(){this.dom.blur()}_setColorPickerPosition(e,t){this._overlay.position(e,t)}_setPickerColor(e){if(!this._changing&&!this._dragging){if(this._channelsNumber>=3){const t=Xs(e);this._colorHSV[0]=t[0],this._colorHSV[1]=t[1],this._colorHSV[2]=t[2]}this._directInput=!1;for(let t=0;t<e.length;t++)this._pickerChannels[t].value=e[t];this._fieldHex.value=this._getHex(),this._directInput=!0}}_openColorPicker(){this._callPicker(this.value.map((e=>Math.floor(255*e)))),this._evtColorPick=this.on("picker:color",(e=>{this.value=e.map((e=>e/255))})),this._evtColorPickStart=this.on("picker:color:start",(()=>{this.binding?(this._historyCombine=this.binding.historyCombine,this._historyPostfix=this.binding.historyPostfix,this.binding.historyCombine=!0,this._binding.historyPostfix=`(${Date.now()})`):(this._historyCombine=!1,this._historyPostfix=null)})),this._evtColorPickEnd=this.on("picker:color:end",(()=>{this.binding&&(this.binding.historyCombine=this._historyCombine,this.binding.historyPostfix=this._historyPostfix)}));const e=this._overlay.dom.getBoundingClientRect(),t=this.dom.getBoundingClientRect();this._setColorPickerPosition(t.left-e.width,t.top+25),this._evtColorToPicker=this.on("change",(()=>{this._setPickerColor(this.value.map((e=>Math.floor(255*e))))}))}_callPicker(e){for(let t=0;t<4;t++)e.length-1<t?this._overlay.class.remove("c-"+(t+1)):this._overlay.class.add("c-"+(t+1));if(this._channelsNumber=e.length,this._channelsNumber>=3){const t=Xs(e);this._colorHSV[0]=t[0],this._colorHSV[1]=t[1],this._colorHSV[2]=t[2]}this._directInput=!1;for(let t=0;t<e.length;t++)this._pickerChannels[t].value=e[t];this._fieldHex.value=this._getHex(),this._directInput=!0,this._overlay.hidden=!1,this._fieldHex.dom.focus(),window.setTimeout((()=>{this._fieldHex.dom.focus()}),100)}_valueToColor(e){return e=Math.floor(255*e),Math.max(0,Math.min(e,255))}_setValue(e){const t=this._valueToColor(e[0]),s=this._valueToColor(e[1]),i=this._valueToColor(e[2]),n=e[3];1===this._channels?this._domColor.style.backgroundColor=`rgb(${t}, ${t}, ${t})`:3===this._channels?this._domColor.style.backgroundColor=`rgb(${t}, ${s}, ${i})`:4===this._channels&&(this._domColor.style.backgroundColor=`rgba(${t}, ${s}, ${i}, ${n})`)}_updateValue(e){let t=!1;for(let s=0;s<e.length;s++)this._value[s]!==e[s]&&(t=!0,this._value[s]=e[s]);return this.class.remove(Ct),t&&(this._setValue(e),this.emit("change",e)),t}_getHex(){let e="";for(let t=0;t<this._channelsNumber;t++)e+=("00"+this._pickerChannels[t].value.toString(16)).slice(-2).toUpperCase();return e}_onChangeHex(){if(!this._directInput)return;this._changing=!0;const e=this._fieldHex.value.trim().toLowerCase();if(/^([0-9a-f]{2}){3,4}$/.test(e))for(let t=0;t<this._channelsNumber;t++)this._pickerChannels[t].value=parseInt(e.slice(2*t,2*t+2),16);this._changing=!1}_onChangeRgb(){const e=this._pickerChannels.map((function(e){return e.value||0})).slice(0,this._channelsNumber),t=Xs(e);if(this._directInput){const s=e[0]+e[1]+e[2];765!==s&&0!==s&&(this._colorHSV[0]=t[0]),this._colorHSV[1]=t[1],this._colorHSV[2]=t[2],this._dragging=!0,this.emit("picker:color:start")}if(this._pickHueHandle.style.top=Math.floor(this._size*this._colorHSV[0])+"px",this._pickRectHandle.style.left=Math.max(4,Math.min(this._size-4,this._size*this._colorHSV[1]))+"px",this._pickRectHandle.style.top=Math.max(4,Math.min(this._size-4,this._size*(1-this._colorHSV[2])))+"px",this._channelsNumber>=3){const t=Ys([this._colorHSV[0],1,1]).join(",");this._pickRect.style.backgroundColor="rgb("+t+")",this._pickRectHandle.style.backgroundColor="rgb("+e.slice(0,3).join(",")+")",this._pickHueHandle.style.backgroundColor="rgb("+t+")"}this.callCallback()}_onChangeAlpha(e){4===this._channelsNumber&&(this._pickOpacityHandle.style.top=Math.floor(this._size*(1-Math.max(0,Math.min(255,e))/255))+"px",this._pickOpacityHandle.style.backgroundColor=`rgb(${e}, ${e}, ${e})`,this.callCallback())}callbackHandle(){this._callingCallback=!1,this.emit("picker:color",this._pickerChannels.map((function(e){return e.value||0})).slice(0,this._channelsNumber))}callCallback(){this._callingCallback||(this._callingCallback=!0,window.setTimeout((()=>{this.callbackHandle()}),1e3/60))}set value(e){e=e||[0,0,0,0];this._updateValue(e)&&this._binding&&this._binding.setValue(e)}get value(){return this._value.slice(0,this._channels)}set values(e){let t=!1;const s=e[0];for(let i=1;i<e.length;i++)if(Array.isArray(s)){if(!s.equals(e[i])){t=!0;break}}else if(s!==e[i]){t=!0;break}t?(this.value=null,this.class.add(Ct)):this.value=e[0]}set channels(e){this._channels!==e&&(this._channels=Math.max(0,Math.min(e,4)),this._setValue(this.value))}get channels(){return this._channels}set renderChanges(e){this._renderChanges=e}get renderChanges(){return this._renderChanges}}It.register("rgb",Zs),It.register("rgba",Zs,{channels:4});var $s=Zs;class Qs extends gs{constructor(e){super(e),this.elementClass=$s}render(){return n.exports.createElement("div",{ref:this.attachElement})}}Qs.ctor=$s;var Js=Qs;class ei extends gs{constructor(e={}){super(e),this.getParent=()=>this,this.elementClass=Bt}componentDidMount(){this.props.onResize&&this.element.on("resize",this.props.onResize)}render(){let e=n.exports.Children.toArray(this.props.children);return 1===e.length?e=n.exports.cloneElement(e[0],{parent:this.element}):e.length>0&&(e=e.map((e=>n.exports.cloneElement(e,{parent:this.element})))),n.exports.createElement("div",{ref:this.attachElement},e)}}ei.ctor=Bt;var ti=ei;class si extends It{constructor(e={}){super(e),this.class.add("pcui-divider")}}It.register("divider",si);var ii=si;class ni extends gs{constructor(e){super(e),this.elementClass=ii}render(){return super.render()}}ni.ctor=ii;var ri=ni;const ai=(e,t)=>{if(0===e.length)return t.length;if(0===t.length)return e.length;if(e===t)return 0;const s=[];for(let e=0;e<=t.length;e++)s[e]=[e];for(let t=0;t<=e.length;t++)s[0][t]=t;for(let i=1;i<=t.length;i++)for(let n=1;n<=e.length;n++)t.charAt(i-1)===e.charAt(n-1)?s[i][n]=s[i-1][n-1]:s[i][n]=Math.min(s[i-1][n-1]+1,Math.min(s[i][n-1]+1,s[i-1][n]+1));return s[t.length][e.length]},oi=(e,t)=>{if(e===t)return e.length;let s=0;const i=new Set;for(let e=0;e<t.length;e++)i.add(t.charAt(e));for(let t=0;t<e.length;t++)i.has(e.charAt(t))&&s++;return s},li=e=>{const t=[],s=e.replace(/([^A-Z])([A-Z][^A-Z])/g,"$1 $2").replace(/([A-Z0-9]{2,})/g," $1").split(/(\s|\-|_)/g);for(let e=0;e<s.length;e++)s[e]=s[e].toLowerCase().trim(),s[e]&&"-"!==s[e]&&"_"!==s[e]&&t.push(s[e]);return t},hi=(e,t,s)=>{const i=[];for(const n of e){if(n.subFull!==1/0){i.push(n),n.edits===1/0&&(n.edits=0),n.sub===1/0&&(n.sub=n.subFull);continue}if(n.name===t||0===n.name.indexOf(t)){i.push(n),n.edits===1/0&&(n.edits=0),n.sub===1/0&&(n.sub=0);continue}if(oi(t,n.name)/t.length<s.containsCharsTolerance)continue;let e=1/0,r=1/0;for(let i=0;i<n.tokens.length;i++){if(n.tokens[i]===t){e=0,r=i;break}const a=ai(t,n.tokens[i]);(r===1/0||a<e)&&-1!==n.tokens[i].indexOf(t)?(r=i,e=a):r===1/0&&a<e&&a/Math.max(t.length,n.tokens[i].length)<=s.editsDistanceTolerance&&(e=a)}e!==1/0&&(i.push(n),n.edits=n.edits===1/0?e:n.edits+e,n.sub=n.sub===1/0?r:n.sub+r)}return i},ci=(e,t="",s={})=>{if(!(t=t.toLowerCase().trim()))return[];const i=li(t);if(!i.length)return[];s.containsCharsTolerance=s.containsCharsTolerance||.5,s.editsDistanceTolerance=s.editsDistanceTolerance||.5;let n=[];for(const s of e){const e=s[0].toLowerCase().trim().indexOf(t);n.push({name:s[0],item:s[1],tokens:li(s[0]),edits:1/0,subFull:-1!==e?e:1/0,sub:1/0})}for(let e=0;e<i.length;e++)n=hi(n,i[e],s);n.sort(((e,t)=>e.subFull!==t.subFull?e.subFull-t.subFull:e.sub!==t.sub?e.sub-t.sub:e.edits!==t.edits?e.edits-t.edits:e.name.length-t.name.length));let r=n.map((e=>e.item));return s.hasOwnProperty("limitResults")&&r.length>s.limitResults&&(r=r.slice(0,s.limitResults)),r},di="pcui-select-input",ui=di+"-container-value",pi=di+"-multi",mi=di+"-disabled-value",_i=di+"-has-disabled-value",fi=di+"-value",gi=di+"-icon",vi=di+"-textinput",yi=di+"-list",bi=di+"-tags",xi=di+"-tags-empty",wi=di+"-tag",Si=di+"-tag-not-everywhere",Ci=di+"-shadow",Ti=di+"-fit-height",Ai="pcui-selected",Ei=di+"-label-highlighted",Pi=di+"-create-new",Mi="pcui-open";class Li extends It{constructor(e={}){var t,s,i,n;const r=new Bt({dom:e.dom});super(Object.assign(Object.assign({},e),{dom:r.dom})),this._timeoutLabelValueTabIndex=null,this._valueToText={},this._valueToLabel={},this._labelToValue=new Map,this._labelHighlighted=null,this._disabledOptions={},this._prefix="",this._onInputChange=e=>{this._suspendInputChange||this._lastInputValue!==e&&(this.open(),this._lastInputValue=e,this._filterOptions(e))},this._onInputKeyDown=e=>{if("Enter"===e.key&&this.enabled&&!this.readOnly){let t;if(e.stopPropagation(),e.preventDefault(),t=this._labelHighlighted&&this._labelToValue.has(this._labelHighlighted)?this._labelToValue.get(this._labelHighlighted):this._input.value,void 0!==t)return this.focus(),this.close(),void(this._valueToText[t]?this._onSelectValue(t):this._allowCreate&&(this._createFn?this._createFn(t):this._onSelectValue(t)))}this._onKeyDown(e)},this._onWindowMouseDown=e=>{this.dom.contains(e.target)||this.close()},this._onKeyDown=e=>{if("Escape"!==e.key)if("Tab"!==e.key){if(this.enabled&&!this.readOnly)if("Enter"!==e.key||this._allowInput){if("ArrowUp"===e.key||"ArrowDown"===e.key)if(e.stopPropagation(),e.preventDefault(),(this._allowInput||this.multiSelect)&&this._containerOptions.hidden)this.open();else if(this._containerOptions.hidden){if(!this._options.length)return;let t=-1;for(let e=0;e<this._options.length;e++)if(this._options[e].v===this.value){t=e;break}"ArrowUp"===e.key?t--:"ArrowDown"===e.key&&t++,t>=0&&t<this._options.length&&this._onSelectValue(this._options[t].v)}else{if(!this._containerOptions.dom.childNodes.length)return;if(this._labelHighlighted){let t=this._labelHighlighted.dom;do{"ArrowUp"===e.key?t=t.previousSibling:"ArrowDown"===e.key&&(t=t.nextSibling)}while(t&&t.ui.hidden);t&&this._highlightLabel(t.ui)}else this._highlightLabel(this._containerOptions.dom.childNodes[0].ui)}}else this._labelHighlighted&&this._labelToValue.has(this._labelHighlighted)&&(this._onSelectValue(this._labelToValue.get(this._labelHighlighted)),this.close())}else this.close();else this.close()},this._onMouseDown=()=>{this._allowInput||this.focus()},this._onFocus=()=>{this.class.add(St),this.emit("focus"),this._input.hidden||this.open()},this._onBlur=()=>{this.class.remove(St),this.emit("blur")},this._onWheel=e=>{e.stopPropagation()},this._container=r,this._container.parent=this,this.class.add(di),this._containerValue=new Bt({class:ui}),this._container.append(this._containerValue),this._domShadow=document.createElement("div"),this._domShadow.classList.add(Ci),this._containerValue.append(this._domShadow),this._allowInput=e.allowInput,this._allowInput&&this.class.add("pcui-select-input-allow-input"),this._allowCreate=e.allowCreate,this._createFn=e.createFn,this._createLabelText=e.createLabelText,this._labelValue=new Ht({class:fi,tabIndex:0}),this._labelValue.on("click",(()=>{this.enabled&&!this.readOnly&&this.toggle()})),this._containerValue.append(this._labelValue),this._labelIcon=new Ht({class:gi,hidden:e.allowInput&&e.multiSelect}),this._containerValue.append(this._labelIcon),this._input=new Ks({class:vi,blurOnEnter:!1,keyChange:!0}),this._containerValue.append(this._input),this._lastInputValue="",this._suspendInputChange=!1,this._input.on("change",this._onInputChange),this._input.on("keydown",this._onInputKeyDown),this._input.on("focus",this._onFocus),this._input.on("blur",this._onBlur),e.placeholder&&(this.placeholder=e.placeholder),this._containerOptions=new Bt({class:yi,hidden:!0}),this._containerValue.append(this._containerOptions),this._containerTags=new Bt({class:bi,flex:!0,flexDirection:"row",hidden:!0}),this._container.append(this._containerTags),e.multiSelect&&(this.class.add(pi),this._containerTags.hidden=!1),this._labelValue.dom.addEventListener("keydown",this._onKeyDown),this._labelValue.dom.addEventListener("focus",this._onFocus),this._labelValue.dom.addEventListener("blur",this._onBlur),this._labelValue.dom.addEventListener("mousedown",this._onMouseDown),this._containerOptions.dom.addEventListener("wheel",this._onWheel,{passive:!0}),this.on("hide",(()=>{this.close()})),this._type=null!==(t=e.type)&&void 0!==t?t:"string",this.invalidOptions=null!==(s=e.invalidOptions)&&void 0!==s?s:[],this.options=null!==(i=e.options)&&void 0!==i?i:[],this._optionsFn=e.optionsFn,this._allowNull=e.allowNull,this._values=null,void 0!==e.value?this.value=e.value:e.defaultValue?this.value=e.defaultValue:this.value=null,this._renderChanges=e.renderChanges,this.on("change",(()=>{this._updateInputFieldsVisibility(),this.renderChanges&&!this.multiSelect&&this._labelValue.flash()})),this._updateInputFieldsVisibility(!1),this._onSelect=e.onSelect,this.fallbackOrder=e.fallbackOrder,this.disabledOptions=e.disabledOptions,this._prefix=null!==(n=e.prefix)&&void 0!==n?n:""}destroy(){this._destroyed||(this._labelValue.dom.removeEventListener("keydown",this._onKeyDown),this._labelValue.dom.removeEventListener("mousedown",this._onMouseDown),this._labelValue.dom.removeEventListener("focus",this._onFocus),this._labelValue.dom.removeEventListener("blur",this._onBlur),this._containerOptions.dom.removeEventListener("wheel",this._onWheel),window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("mousedown",this._onWindowMouseDown),this._timeoutLabelValueTabIndex&&(cancelAnimationFrame(this._timeoutLabelValueTabIndex),this._timeoutLabelValueTabIndex=null),super.destroy())}_initializeCreateLabel(){const e=new Bt({class:Pi,flex:!0,flexDirection:"row"}),t=new Ht({text:this._input.value,tabIndex:-1});e.append(t);let s=this._input.on("change",(s=>{t.destroyed||(t.text=s,this.invalidOptions&&-1!==this.invalidOptions.indexOf(s)?e.hidden||(e.hidden=!0,this._resizeShadow()):e.hidden&&(e.hidden=!1,this._resizeShadow()))}));e.on("click",(e=>{e.stopPropagation();const s=t.text;this.focus(),this.close(),this._createFn?this._createFn(s):s&&this._onSelectValue(s)})),t.on("destroy",(()=>{s.unbind(),s=null}));const i=new Ht({text:this._createLabelText});return e.append(i),this._containerOptions.append(e),e}_convertSingleValue(e){if(null===e&&this._allowNull)return e;if("string"===this._type)e=e?e.toString():"";else if("number"===this._type)e=e?parseInt(e,10):0;else if("boolean"===this._type)return!!e;return e}_convertValue(e){return null===e&&this._allowNull?e:this.multiSelect?Array.isArray(e)?e.map((e=>this._convertSingleValue(e))):e:this._convertSingleValue(e)}_onSelectValue(e){if(e=this._convertSingleValue(e),this.multiSelect)if(this._values){let t=!1;this._values.forEach((s=>{s?-1===s.indexOf(e)&&(s.push(e),t=!0):(s=[e],t=!0)})),t&&(this._onMultipleValuesChange(this._values),this.emit("change",this.value),this._binding&&this._binding.addValues([e]))}else this._value&&Array.isArray(this._value)?-1===this._value.indexOf(e)&&(this._value.push(e),this._addTag(e),this.emit("change",this.value),this._binding&&this._binding.addValues([e])):this.value=[e];else this.value=e}_highlightLabel(e){if(this._labelHighlighted!==e&&(this._labelHighlighted&&this._labelHighlighted.class.remove(Ei),this._labelHighlighted=e,this._labelHighlighted)){this._labelHighlighted.class.add(Ei);const e=this._labelHighlighted.dom.offsetTop,t=this._containerOptions.dom.scrollTop;e<t?this._containerOptions.dom.scrollTop=e:e+this._labelHighlighted.height>this._containerOptions.height+t&&(this._containerOptions.dom.scrollTop=e+this._labelHighlighted.height-this._containerOptions.height)}}_onValueChange(e){if(this.multiSelect){if(this._labelValue.value="",this._containerTags.clear(),this._containerTags.class.add(xi),e&&Array.isArray(e)){for(const t of e){this._addTag(t);const e=this._valueToLabel[t];e&&e.class.add(Ai)}for(const t in this._valueToLabel){const s=this._valueToLabel[t];-1!==e.indexOf(this._convertSingleValue(t))?s.class.add(Ai):s.class.remove(Ai)}}}else{this._labelValue.value=this._prefix+(this._valueToText[e]||""),e=""+e;for(const t in this._valueToLabel){const s=this._valueToLabel[t];t===e?s.class.add(Ai):s.class.remove(Ai)}}}_onMultipleValuesChange(e){this._labelValue.value="",this._containerTags.clear(),this._containerTags.class.add(xi);const t={},s={};e.forEach((e=>{e&&e.forEach((e=>{t[e]?s[e]++:(t[e]=this._addTag(e),s[e]=1)}))}));for(const i in s)if(s[i]!==e.length){t[i].class.add(Si);const e=this._valueToLabel[i];e&&e.class.remove(Ai)}}_addTag(e){const t=new Bt({flex:!0,flexDirection:"row",class:wi});t.append(new Ht({text:this._valueToText[e]||e}));const s=new Gt({size:"small",icon:"E132",tabIndex:-1});t.append(s),s.on("click",(()=>this._removeTag(t,e))),this._containerTags.append(t),this._containerTags.class.remove(xi);const i=this._valueToLabel[e];return i&&i.class.add(Ai),t.value=e,t}_removeTag(e,t){e.destroy();const s=this._valueToLabel[t];if(s&&s.class.remove(Ai),this._values)this._values.forEach((e=>{if(!e)return;const s=e.indexOf(t);-1!==s&&e.splice(s,1)}));else if(this._value&&Array.isArray(this._value)){const e=this._value.indexOf(t);-1!==e&&this._value.splice(e,1)}this.emit("change",this.value),this._binding&&this._binding.removeValues([t])}_filterOptions(e){const t=this._containerOptions.dom;for(;t.firstChild;)t.removeChild(t.lastChild);if(e){const s=this.options.map((e=>[e.t,e.v]));ci(s,e).forEach((e=>{const s=this._valueToLabel[e];t.appendChild(s.dom)}))}else for(const e of this._options){const s=this._valueToLabel[e.v];t.appendChild(s.dom)}this._createLabelContainer&&t.appendChild(this._createLabelContainer.dom),t.firstChild&&this._highlightLabel(t.firstChild.ui),this._resizeShadow()}_resizeShadow(){this._domShadow.style.height=this._containerValue.height+this._containerOptions.height+"px"}_updateInputFieldsVisibility(e){let t=!1,s=!1;this._allowInput&&(e?(t=!0,s=!0):t=this.multiSelect||!this._valueToLabel[this.value]),this._labelValue.hidden=t,this._labelIcon.hidden=t,this._input.hidden=!t,s&&this._input.focus(),this._labelValue.hidden||(this._labelValue.tabIndex=-1,this._timeoutLabelValueTabIndex||(this._timeoutLabelValueTabIndex=requestAnimationFrame((()=>{this._timeoutLabelValueTabIndex=null,this._labelValue.tabIndex=0}))))}focus(){this._input.hidden?this._labelValue.dom.focus():this._input.focus()}blur(){this._allowInput?this._input.blur():this._labelValue.dom.blur()}open(){if(!this._containerOptions.hidden||!this.enabled||this.readOnly)return;if(this._updateInputFieldsVisibility(!0),this._optionsFn&&(this.options=this._optionsFn()),0===this._containerOptions.dom.childNodes.length)return;this._containerOptions.forEachChild((e=>{e.hidden=!1,this._labelToValue.get(e)===this.value&&this._highlightLabel(e)})),this._labelHighlighted||this._highlightLabel(this._containerOptions.dom.childNodes[0].ui),this._containerOptions.hidden=!1,this.class.add(Mi),window.addEventListener("keydown",this._onKeyDown),window.addEventListener("mousedown",this._onWindowMouseDown);const e=(this._allowInput?this._input.dom:this._labelValue.dom).getBoundingClientRect();let t=e.bottom+this._containerOptions.height+25>=window.innerHeight;t&&e.top-this._containerOptions.height<0&&(t=!1,this._containerOptions.style.maxHeight=window.innerHeight-e.bottom-25+"px"),t?this.class.add(Ti):this.class.remove(Ti),this._resizeShadow()}close(){this._containerOptions.style.maxHeight="",this._highlightLabel(null),this._updateInputFieldsVisibility(!1),this._suspendInputChange=!0,this._input.value="",this._lastInputValue&&(this._lastInputValue="",this._filterOptions(null)),this._suspendInputChange=!1,this._containerOptions.hidden||(this._containerOptions.hidden=!0,this._domShadow.style.height="",this.class.remove(Mi),window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("mousedown",this._onWindowMouseDown))}toggle(){this._containerOptions.hidden?this.open():this.close()}unlink(){super.unlink(),this._containerOptions.hidden||this.close()}_updateValue(e){e!==this._value&&(this._value=e,this._onValueChange(e),this._suppressChange||this.emit("change",e),this._binding&&this._binding.setValue(e))}_updateDisabledValue(e){const t={};this._containerOptions.forEachChild((e=>{t[e.dom.id]=e,this._disabledOptions[e.dom.id]?(e.enabled=!1,e.text=this._disabledOptions[e.dom.id]):(e.enabled=!0,e.text=this._valueToText[e.dom.id]),e.class.remove(mi)}));const s=this._disabledOptions[e]?e:null;let i=null;if(s){if(this._fallbackOrder)for(let t=0;t<this._fallbackOrder.length;t++)if(this._fallbackOrder[t]!==e){i=this._fallbackOrder[t];break}this.disabledValue=s,t[s].class.add(mi)}else this._disabledValue?(i=this._disabledValue,this.disabledValue=null):(i=e,this.disabledValue=null);return i}set options(e){if(!this._options||JSON.stringify(this._options)!==JSON.stringify(e)){this._containerOptions.clear(),this._labelHighlighted=null,this._valueToText={},this._valueToLabel={},this._options=e;for(const e of this._options){if(this._valueToText[e.v]=e.t,""===e.v)return;const t=new Ht({text:e.t,tabIndex:-1,id:e.v});this._labelToValue.set(t,e.v),this._valueToLabel[e.v]=t,t.on("click",(t=>{t.stopPropagation(),this._onSelectValue(e.v),this.close(),this._onSelect&&this._onSelect(this.value)})),this._containerOptions.append(t)}this._createLabelContainer=null,this._createLabelText&&(this._createLabelContainer=this._initializeCreateLabel()),this.multiSelect&&this._values?this._onMultipleValuesChange(this._values):this._onValueChange(this.value),this._lastInputValue&&this._filterOptions(this._lastInputValue)}}get options(){return this._options.slice()}set invalidOptions(e){this._invalidOptions=e||null}get invalidOptions(){return this._invalidOptions}set disabledValue(e){this._disabledValue=e,null!==this._disabledValue?this.class.add(_i):this.class.remove(_i)}set disabledOptions(e){if(JSON.stringify(this._disabledOptions)===JSON.stringify(e))return;this._disabledOptions=e||{};const t=this._updateDisabledValue(this._value);this._updateValue(t)}set fallbackOrder(e){this._fallbackOrder=e||null}get multiSelect(){return this.class.contains(pi)}set value(e){this._values=null,this._suspendInputChange=!0,this._input.value="",this._lastInputValue&&(this._lastInputValue="",this._filterOptions(null)),this._suspendInputChange=!1,this.class.remove(Ct),e=this._convertValue(e),(!(this._value===e||this.multiSelect&&this._value&&this._value.equals(e))||null===e&&this._allowNull&&this.class.contains(Ct))&&(this.disabledValue=null,this._updateValue(e))}get value(){if(!this.multiSelect)return this._value;const e=[];return this._containerTags.dom.childNodes.forEach((t=>{e.push(t.ui.value)})),e}set values(e){e=e.map((e=>this._convertValue(e)));let t=!1;const s=e[0],i=this.multiSelect;this._values=null;for(let n=1;n<e.length;n++)if(!(e[n]===s||i&&e[n]&&e[n].equals(s))){t=!0;break}t?(this._labelValue.values=e,i?(this._values=e,this._value=null,this._onMultipleValuesChange(this._values),this.emit("change",this.value)):null!==this._value&&(this._value=null,this.emit("change",null)),this.class.add(Ct)):this.value=e[0]}set placeholder(e){this._input.placeholder=e}get placeholder(){return this._input.placeholder}set renderChanges(e){this._renderChanges=e}get renderChanges(){return this._renderChanges}}It.register("select",Li,{renderChanges:!0}),It.register("multiselect",Li,{multiSelect:!0,renderChanges:!0}),It.register("tags",Li,{allowInput:!0,allowCreate:!0,multiSelect:!0,renderChanges:!0});var Di=Li;const ki={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:function(e,t,s){return e>=s?s:e<=t?t:e},intToBytes24:function(e){return[e>>16&255,e>>8&255,255&e]},intToBytes32:function(e){return[e>>24&255,e>>16&255,e>>8&255,255&e]},bytesToInt24:function(e,t,s){return e.length&&(s=e[2],t=e[1],e=e[0]),e<<16|t<<8|s},bytesToInt32:function(e,t,s,i){return e.length&&(i=e[3],s=e[2],t=e[1],e=e[0]),(e<<24|t<<16|s<<8|i)>>>0},lerp:function(e,t,s){return e+(t-e)*ki.clamp(s,0,1)},lerpAngle:function(e,t,s){return t-e>180&&(t-=360),t-e<-180&&(t+=360),ki.lerp(e,t,ki.clamp(s,0,1))},powerOfTwo:function(e){return 0!==e&&!(e&e-1)},nextPowerOfTwo:function(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e},nearestPowerOfTwo:function(e){return Math.pow(2,Math.round(Math.log(e)/Math.log(2)))},random:function(e,t){const s=t-e;return Math.random()*s+e},smoothstep:function(e,t,s){return s<=e?0:s>=t?1:(s=(s-e)/(t-e))*s*(3-2*s)},smootherstep:function(e,t,s){return s<=e?0:s>=t?1:(s=(s-e)/(t-e))*s*s*(s*(6*s-15)+10)},roundUp:function(e,t){return 0===t?e:Math.ceil(e/t)*t},between:function(e,t,s,i){const n=Math.min(t,s),r=Math.max(t,s);return i?e>=n&&e<=r:e>n&&e<r}},Ii=function(){const e={},t=["Array","Object","Function","Date","RegExp","Float32Array"];for(let s=0;s<t.length;s++)e["[object "+t[s]+"]"]=t[s].toLowerCase();return e}();function Ri(e){if(null===e)return"null";const t=typeof e;return"undefined"===t||"number"===t||"string"===t||"boolean"===t?t:Ii[Object.prototype.toString.call(e)]}function Oi(e,t){for(const s in t){const i=t[s];"object"===Ri(i)?e[s]=Oi({},i):"array"===Ri(i)?e[s]=Oi([],i):e[s]=i}return e}class zi{constructor(e,t=0){this._curve=void 0,this._left=-1/0,this._right=1/0,this._recip=0,this._p0=0,this._p1=0,this._m0=0,this._m1=0,this._curve=e,this._reset(t)}evaluate(e,t=!1){let s;(t||e<this._left||e>=this._right)&&this._reset(e);const i=this._curve.type;if(5===i)s=this._p0;else{const t=0===this._recip?0:(e-this._left)*this._recip;s=0===i?ki.lerp(this._p0,this._p1,t):1===i?ki.lerp(this._p0,this._p1,t*t*(3-2*t)):this._evaluateHermite(this._p0,this._p1,this._m0,this._m1,t)}return s}_reset(e){const t=this._curve.keys,s=t.length;if(s)if(e<t[0][0])this._left=-1/0,this._right=t[0][0],this._recip=0,this._p0=this._p1=t[0][1],this._m0=this._m1=0;else if(e>=t[s-1][0])this._left=t[s-1][0],this._right=1/0,this._recip=0,this._p0=this._p1=t[s-1][1],this._m0=this._m1=0;else{let s=0;for(;e>=t[s+1][0];)s++;this._left=t[s][0],this._right=t[s+1][0];const i=1/(this._right-this._left);this._recip=isFinite(i)?i:0,this._p0=t[s][1],this._p1=t[s+1][1],this._isHermite()&&this._calcTangents(t,s)}else this._left=-1/0,this._right=1/0,this._recip=0,this._p0=this._p1=this._m0=this._m1=0}_isHermite(){return 2===this._curve.type||3===this._curve.type||4===this._curve.type}_calcTangents(e,t){let s;const i=e[t],n=e[t+1];let r;if(s=0===t?[e[0][0]+(e[0][0]-e[1][0]),e[0][1]+(e[0][1]-e[1][1])]:e[t-1],r=t===e.length-2?[e[t+1][0]+(e[t+1][0]-e[t][0]),e[t+1][1]+(e[t+1][1]-e[t][1])]:e[t+2],4===this._curve.type){const e=2*(n[0]-i[0])/(n[0]-s[0]),t=2*(n[0]-i[0])/(r[0]-i[0]);this._m0=this._curve.tension*(isFinite(e)?e:0)*(n[1]-s[1]),this._m1=this._curve.tension*(isFinite(t)?t:0)*(r[1]-i[1])}else{const e=(n[0]-i[0])/(i[0]-s[0]),t=(n[0]-i[0])/(r[0]-n[0]),a=i[1]+(s[1]-i[1])*(isFinite(e)?e:0),o=n[1]+(r[1]-n[1])*(isFinite(t)?t:0),l=2===this._curve.type?.5:this._curve.tension;this._m0=l*(n[1]-a),this._m1=l*(o-i[1])}}_evaluateHermite(e,t,s,i,n){const r=n*n,a=n+n,o=1-n,l=o*o;return e*((1+a)*l)+s*(n*l)+t*(r*(3-a))+i*(r*(n-1))}}class Fi{constructor(e){if(this.keys=[],this.type=1,this.tension=.5,this._eval=new zi(this),e)for(let t=0;t<e.length-1;t+=2)this.keys.push([e[t],e[t+1]]);this.sort()}get length(){return this.keys.length}add(e,t){const s=this.keys,i=s.length;let n=0;for(;n<i&&!(s[n][0]>e);n++);const r=[e,t];return this.keys.splice(n,0,r),r}get(e){return this.keys[e]}sort(){this.keys.sort((function(e,t){return e[0]-t[0]}))}value(e){return this._eval.evaluate(e,!0)}closest(e){const t=this.keys,s=t.length;let i=2,n=null;for(let r=0;r<s;r++){const s=Math.abs(e-t[r][0]);if(!(i>=s))break;i=s,n=t[r]}return n}clone(){const e=new this.constructor;return e.keys=Oi(e.keys,this.keys),e.type=this.type,e.tension=this.tension,e}quantize(e){e=Math.max(e,2);const t=new Float32Array(e),s=1/(e-1);t[0]=this._eval.evaluate(0,!0);for(let i=1;i<e;i++)t[i]=this._eval.evaluate(s*i);return t}quantizeClamped(e,t,s){const i=this.quantize(e);for(let e=0;e<i.length;++e)i[e]=Math.min(s,Math.max(t,i[e]));return i}}class Vi{constructor(){if(this.curves=[],this._type=1,arguments.length>1)for(let e=0;e<arguments.length;e++)this.curves.push(new Fi(arguments[e]));else if(0===arguments.length)this.curves.push(new Fi);else{const e=arguments[0];if("number"==typeof e)for(let t=0;t<e;t++)this.curves.push(new Fi);else for(let t=0;t<e.length;t++)this.curves.push(new Fi(e[t]))}}get length(){return this.curves.length}set type(e){this._type=e;for(let t=0;t<this.curves.length;t++)this.curves[t].type=e}get type(){return this._type}get(e){return this.curves[e]}value(e,t=[]){const s=this.curves.length;t.length=s;for(let i=0;i<s;i++)t[i]=this.curves[i].value(e);return t}clone(){const e=new this.constructor;e.curves=[];for(let t=0;t<this.curves.length;t++)e.curves.push(this.curves[t].clone());return e._type=this._type,e}quantize(e){e=Math.max(e,2);const t=this.curves.length,s=new Float32Array(e*t),i=1/(e-1);for(let n=0;n<t;n++){const r=new zi(this.curves[n]);for(let a=0;a<e;a++)s[a*t+n]=r.evaluate(i*a)}return s}quantizeClamped(e,t,s){const i=this.quantize(e);for(let e=0;e<i.length;++e)i[e]=Math.min(s,Math.max(t,i[e]));return i}}const Ni="pcui-multiple-values",Bi=/keys/,Ui=/type/;class Hi extends It{constructor(e={}){var t;super(e),this._onKeyDown=e=>{"Escape"===e.key&&this.blur(),"Enter"!==e.key||!this.enabled||this.readOnly||this.class.contains(Ni)||(e.stopPropagation(),e.preventDefault(),this._openGradientPicker())},this._onFocus=e=>{this.emit("focus")},this._onBlur=e=>{this.emit("blur")},this._onAnchorsMouseDown=e=>{if(-1===this.STATE.hoveredAnchor){const t=this.calcNormalizedCoord(e.clientX,e.clientY,this.getClientRect(this.UI.anchors.dom));this.insertAnchor(t[0],this.evaluateGradient(t[0])),this.STATE.anchors=this.calcAnchorTimes(),this.selectAnchor(this.STATE.anchors.indexOf(t[0]))}else this.STATE.hoveredAnchor!==this.STATE.selectedAnchor&&this.selectAnchor(this.STATE.hoveredAnchor);this.UI.anchors.dom.style.cursor="grabbing",this.UI.anchorAddCrossHair.style.visibility="hidden",this.dragStart(),this.UI.draggingAnchor=!0},this._onAnchorsMouseMove=e=>{const t=this.calcNormalizedCoord(e.clientX,e.clientY,this.getClientRect(this.UI.anchors.dom));if(this.UI.draggingAnchor)this.dragUpdate(ki.clamp(t[0],0,1)),this.UI.anchorAddCrossHair.style.visibility="hidden";else if(t[0]>=0&&t[0]<=1&&t[1]>=0&&t[1]<=1){let e=-1,s=0;for(let i=0;i<this.STATE.anchors.length;++i){const n=Math.abs(this.STATE.anchors[i]-t[0]);(-1===e||n<s)&&(e=i,s=n)}const i=-1!==e&&s<.02?e:-1;i!==this.STATE.hoveredAnchor&&(this.selectHovered(i),this.render()),-1===i?(this.UI.anchorAddCrossHair.style.visibility="visible",this.UI.anchors.dom.style.cursor="none"):this.UI.anchorAddCrossHair.style.visibility="hidden",this.UI.showCrosshairPosition.innerText=Math.round(100*t[0]).toString(),this.UI.anchorAddCrossHair.style.left=(2.5+320*t[0]).toString()+"px"}else-1!==this.STATE.hoveredAnchor?(this.UI.anchorAddCrossHair.style.visibility="hidden",this.selectHovered(-1),this.render()):this.UI.anchorAddCrossHair.style.visibility="hidden"},this._onAnchorsMouseUp=e=>{this.UI.draggingAnchor&&(this.dragEnd(),this.UI.draggingAnchor=!1),this.UI.anchors.dom.style.cursor="pointer"},this.class.add("pcui-gradient"),this._canvas=new Ls({useDevicePixelRatio:!0}),this.dom.appendChild(this._canvas.dom),this._canvas.parent=this,this._canvas.on("resize",(()=>{this._renderGradient()}));const s=this._canvas.dom;function i(e,t){return function(s){t.apply(e,[s])}}function n(e){const t=new os({precision:1,step:1,min:0,max:255});return t.renderChanges=!1,t.placeholder=e,t.on("change",this.fieldChangeHandler),this._fields.appendChild(t.dom),t}this._checkerboardPattern=this._createCheckerboardPattern(s.getContext("2d")),this._resizeInterval=window.setInterval((()=>{this._canvas.resize(this.width,this.height)}),50),this.dom.addEventListener("keydown",this._onKeyDown),this.dom.addEventListener("focus",this._onFocus),this.dom.addEventListener("blur",this._onBlur),this.on("click",(()=>{!this.enabled||this.readOnly||this.class.contains(Ni)||this._openGradientPicker()})),this.renderChanges=null===(t=e.renderChanges)||void 0===t||t,this.on("change",(()=>{this.renderChanges&&this.flash()})),this.Helpers={rgbaStr:function(e,t){t||(t=1);let s=e.map((function(e,s){return s<3?Math.round(e*t):e})).join(",");for(let i=e.length;i<4;++i)s+=","+(i<3?t:1);return"rgba("+s+")"},hexStr:function(e){return e.map((function(e){return("00"+e.toString(16)).slice(-2).toUpperCase()})).join("")},toHsva:function(e){const t=Xs(e.map((function(e){return 255*e})));return t.push(e.length>3?e[3]:1),t},toRgba:function(e){const t=Ys(e).map((function(e){return e/255}));return t.push(e.length>3?e[3]:1),t},normalizedCoord:function(e,t,s){const i=e.dom.getBoundingClientRect();return[(t-i.left)/i.width,(s-i.top)/i.height]}},this._panel=new Jt,this._panel.class.add("color-panel"),this.dom.appendChild(this._panel.dom),this._colorRect=new Ls({useDevicePixelRatio:!0}),this._colorRect.class.add("color-rect"),this._panel.append(this._colorRect.dom),this._colorRect.resize(140,140),this._colorHandle=document.createElement("div"),this._colorHandle.classList.add("color-handle"),this._panel.append(this._colorHandle),this._hueRect=new Ls({useDevicePixelRatio:!0}),this._hueRect.class.add("hue-rect"),this._panel.append(this._hueRect.dom),this._hueRect.resize(20,140),this._hueHandle=document.createElement("div"),this._hueHandle.classList.add("hue-handle"),this._panel.append(this._hueHandle),this._alphaRect=new Ls({useDevicePixelRatio:!0}),this._alphaRect.class.add("alpha-rect"),this._panel.append(this._alphaRect.dom),this._alphaRect.resize(20,140),this._alphaHandle=document.createElement("div"),this._alphaHandle.classList.add("alpha-handle"),this._panel.append(this._alphaHandle),this._fields=document.createElement("div"),this._fields.classList.add("fields"),this._panel.append(this._fields),this.fieldChangeHandler=i(this,this._onFieldChanged),this.hexChangeHandler=i(this,this._onHexChanged),this.downHandler=i(this,this._onMouseDown),this.moveHandler=i(this,this._onMouseMove),this.upHandler=i(this,this._onMouseUp),this._rField=n.call(this,"r"),this._gField=n.call(this,"g"),this._bField=n.call(this,"b"),this._aField=n.call(this,"a"),this._hexField=new Ks,this._hexField.renderChanges=!1,this._hexField.placeholder="#",this._hexField.on("change",this.hexChangeHandler),this._fields.appendChild(this._hexField.dom),this._colorRect.dom.addEventListener("mousedown",this.downHandler),this._hueRect.dom.addEventListener("mousedown",this.downHandler),this._alphaRect.dom.addEventListener("mousedown",this.downHandler),this._generateHue(this._hueRect),this._generateAlpha(this._alphaRect),this._hsva=[-1,-1,-1,1],this._storeHsva=[0,0,0,1],this._dragMode=0,this._changing=!1,this.CONSTANTS={bg:"#2c393c",anchorRadius:5,selectedRadius:7},this.UI={root:this.dom,overlay:new js,panel:document.createElement("div"),gradient:new Ls({useDevicePixelRatio:!0}),checkerPattern:this.createCheckerPattern(),anchors:new Ls({useDevicePixelRatio:!0}),footer:new Jt,typeLabel:new Ht({text:"Type"}),typeCombo:new Di({options:[{t:"0",v:"placeholder"}],type:"number"}),positionLabel:new Ht({text:"Position"}),positionEdit:new os({min:0,max:100,step:1}),copyButton:new Gt,pasteButton:new Gt,deleteButton:new Gt,showSelectedPosition:new os({min:0,max:100,step:1,hideSlider:!0}),showCrosshairPosition:document.createElement("div"),anchorAddCrossHair:document.createElement("div"),colorPicker:null},this.STATE={curves:[],keystore:[],anchors:[],hoveredAnchor:-1,selectedAnchor:-1,selectedValue:[],changing:!1,draggingAnchor:!1,typeMap:{}},this.UI.root.appendChild(this.UI.overlay.dom),this.UI.overlay.class.add("picker-gradient"),this.UI.overlay.center=!1,this.UI.overlay.transparent=!0,this.UI.overlay.hidden=!0,this.UI.overlay.clickable=!0,this.UI.overlay.dom.style.position="fixed",this.UI.overlay.on("show",(()=>{this.onOpen()})),this.UI.overlay.on("hide",(()=>{this.onClose()})),this.UI.panel.classList.add("picker-gradient-panel"),this.UI.overlay.append(this.UI.panel),this.UI.panel.appendChild(this.UI.gradient.dom),this.UI.gradient.class.add("picker-gradient-gradient"),this.UI.gradient.resize(320,28),this.UI.panel.appendChild(this.UI.anchors.dom),this.UI.anchors.class.add("picker-gradient-anchors"),this.UI.anchors.resize(320,28),this.UI.panel.appendChild(this.UI.footer.dom),this.UI.footer.append(this.UI.typeLabel),this.UI.footer.class.add("picker-gradient-footer"),this.UI.footer.append(this.UI.typeCombo),this.UI.typeCombo.value=-1,this.UI.typeCombo.on("change",(e=>{this._onTypeChanged(e)})),this.UI.positionEdit.style.width="40px",this.UI.positionEdit.renderChanges=!1,this.UI.showSelectedPosition.on("change",(e=>{this.STATE.changing||this.moveSelectedAnchor(e/100)})),this.UI.copyButton.on("click",(()=>{this.doCopy()})),this.UI.copyButton.class.add("copy-curve-button"),this.UI.footer.append(this.UI.copyButton),this.UI.pasteButton.on("click",(()=>{this.doPaste()})),this.UI.pasteButton.class.add("paste-curve-button"),this.UI.footer.append(this.UI.pasteButton),this.UI.deleteButton.on("click",(()=>{this.doDelete()})),this.UI.deleteButton.class.add("delete-curve-button"),this.UI.footer.append(this.UI.deleteButton),this.UI.panel.appendChild(this._panel.dom),this.UI.panel.append(this.UI.showSelectedPosition.dom),this.UI.showSelectedPosition.class.add("show-selected-position"),this.UI.showSelectedPosition._domInput.classList.add("show-selected-position-input");const r=document.createElementNS("http://www.w3.org/2000/svg","path");r.setAttribute("fill-rule","evenodd"),r.setAttribute("clip-rule","evenodd"),r.setAttribute("d","M8.5 17C7.35596 17 6.26043 16.7741 5.2134 16.3222C4.16637 15.8703 3.26152 15.2629 2.49882 14.4997C1.73612 13.7366 1.12899 12.8312 0.677391 11.7835C0.225795 10.7359 0 9.6397 0 8.49498C0 7.35026 0.225795 6.25409 0.677391 5.20644C1.12899 4.15879 1.73612 3.25507 2.49882 2.49527C3.26152 1.73548 4.16637 1.12965 5.2134 0.677791C6.26043 0.225928 7.35596 0 8.5 0C9.64404 0 10.7396 0.225928 11.7866 0.677791C12.8336 1.12965 13.7385 1.73548 14.5012 2.49527C15.2639 3.25507 15.871 4.15879 16.3226 5.20644C16.7742 6.25409 17 7.35026 17 8.49498C17 9.6397 16.7742 10.7359 16.3226 11.7835C15.871 12.8312 15.2639 13.7366 14.5012 14.4997C13.7385 15.2629 12.8336 15.8703 11.7866 16.3222C10.7396 16.7741 9.64404 17 8.5 17ZM8.5 2.2593C7.64364 2.2593 6.82576 2.42498 6.04634 2.75635C5.26692 3.08772 4.59622 3.53288 4.03424 4.09185C3.47225 4.65082 3.02568 5.31354 2.69451 6.08004C2.36334 6.84653 2.19776 7.6515 2.19776 8.49498C2.19776 9.6397 2.47875 10.6957 3.04073 11.663C3.60272 12.6303 4.36707 13.3952 5.33383 13.9575C6.30058 14.5198 7.35596 14.8009 8.5 14.8009C9.34298 14.8009 10.1475 14.6353 10.9135 14.3039C11.6796 13.9725 12.3419 13.5257 12.9005 12.9634C13.4592 12.4011 13.9041 11.73 14.2352 10.9501C14.5664 10.1702 14.732 9.35184 14.732 8.49498C14.732 7.6515 14.5664 6.84653 14.2352 6.08004C13.9041 5.31354 13.4592 4.65082 12.9005 4.09185C12.3419 3.53288 11.6796 3.08772 10.9135 2.75635C10.1475 2.42498 9.34298 2.2593 8.5 2.2593ZM9.52361 9.73007V12.9533H7.40614V9.73007H4.11452V7.61134H7.40614V4.31778H9.52361V7.61134H12.745V9.73007H9.52361Z"),r.setAttribute("fill","#FF6600");const a=document.createElementNS("http://www.w3.org/2000/svg","svg"),o=document.createElement("div");a.appendChild(r),a.setAttribute("width","17"),a.setAttribute("height","17"),a.setAttribute("viewBox","0 0 17 17"),this.UI.showCrosshairPosition.classList.add("show-crosshair-position"),o.classList.add("crosshair-bar"),this.UI.anchorAddCrossHair.appendChild(a),this.UI.anchorAddCrossHair.appendChild(o),this.UI.anchorAddCrossHair.appendChild(this.UI.showCrosshairPosition),this.UI.anchorAddCrossHair.classList.add("anchor-crosshair"),this.UI.anchorAddCrossHair.style.visibility="hidden",this.UI.panel.append(this.UI.anchorAddCrossHair),this.on("changing",(function(e){this.colorSelectedAnchor(e,!0)})),this._copiedData=null,this._channels=e.channels||3,this._value=this._getDefaultValue(),e.value&&(this.value=e.value)}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),this.dom.removeEventListener("focus",this._onFocus),this.dom.removeEventListener("blur",this._onBlur),window.clearInterval(this._resizeInterval),super.destroy())}_createCheckerboardPattern(e){const t=document.createElement("canvas"),s=12;t.width=24,t.height=24;const i=t.getContext("2d");return i.fillStyle="#",i.fillStyle="#949a9c",i.fillRect(0,0,s,s),i.fillRect(s,s,s,s),i.fillStyle="#657375",i.fillRect(s,0,s,s),i.fillRect(0,s,s,s),e.createPattern(t,"repeat")}_getDefaultValue(){return{type:4,keys:new Array(this._channels).fill([0,0]),betweenCurves:!1}}_openGradientPicker(){this.callOpenGradientPicker([this.value||this._getDefaultValue()]);const e=this.getGradientPickerRect(),t=this.dom.getBoundingClientRect();this.positionGradientPicker(t.right-e.width,t.bottom),this._evtPickerChanged=this.on("picker:curve:change",this._onPickerChange.bind(this)),this._evtRefreshPicker=this.on("change",(()=>this.setGradientPicker([this.value])))}_onPickerChange(e,t){const s=this.value||this._getDefaultValue();Bi.test(e[0])?this.value={type:s.type,keys:t,betweenCurves:!1}:Ui.test(e[0])&&(this.value={type:t[0],keys:s.keys,betweenCurves:!1})}_renderGradient(){const e=this._canvas.dom.getContext("2d"),t=this._canvas.width,s=this._canvas.height,i=this._canvas.pixelRatio;if(e.setTransform(i,0,0,i,0,0),e.fillStyle=this._checkerboardPattern,e.fillRect(0,0,t,s),!this.value||!this.value.keys||!this.value.keys.length)return;const n=[],r=1===this.channels?new Vi([this.value.keys]):new Vi(this.value.keys);r.type=this.value.type;const a=e.createLinearGradient(0,0,t,0);for(let e=2;e<t;e+=2){r.value(e/t,n);const s=Math.round(255*(n[0]||0)),i=Math.round(255*(n[1]||0)),o=Math.round(255*(n[2]||0)),l=4===this.channels?n[3]||0:1;a.addColorStop(e/t,`rgba(${s}, ${i}, ${o}, ${l})`)}e.fillStyle=a,e.fillRect(0,0,t,s)}focus(){this.dom.focus()}blur(){this.dom.blur()}set channels(e){this._channels!==e&&(this._channels=Math.max(1,Math.min(e,4)),this.value&&this._renderGradient())}get channels(){return this._channels}set value(e){this._value=e,this.class.remove(Ni),this._renderGradient(),this.emit("change",e),this.setValue([e])}get value(){return this._value}set values(e){this.class.add(Ni),this._renderGradient()}_generateHue(e){const t=e.dom.getContext("2d"),s=e.pixelWidth,i=e.pixelHeight,n=t.createLinearGradient(0,0,0,i);for(let e=0;e<=6;e+=1)n.addColorStop(e/6,this.Helpers.rgbaStr(Ys([e/6,1,1])));t.fillStyle=n,t.fillRect(0,0,s,i)}_generateAlpha(e){const t=e.dom.getContext("2d"),s=e.pixelWidth,i=e.pixelHeight,n=t.createLinearGradient(0,0,0,i);n.addColorStop(0,"rgb(255, 255, 255)"),n.addColorStop(1,"rgb(0, 0, 0)"),t.fillStyle=n,t.fillRect(0,0,s,i)}_generateGradient(e,t){const s=e.dom.getContext("2d"),i=e.pixelWidth,n=e.pixelHeight;let r=s.createLinearGradient(0,0,i,0);r.addColorStop(0,this.Helpers.rgbaStr([255,255,255,255])),r.addColorStop(1,this.Helpers.rgbaStr([t[0],t[1],t[2],255])),s.fillStyle=r,s.fillRect(0,0,i,n),r=s.createLinearGradient(0,0,0,n),r.addColorStop(0,"rgba(0, 0, 0, 0)"),r.addColorStop(1,"rgba(0, 0, 0, 255)"),s.fillStyle=r,s.fillRect(0,0,i,n)}_onFieldChanged(){if(!this._changing){const e=[this._rField.value,this._gField.value,this._bField.value,this._aField.value].map((function(e){return e/255}));this.hsva=this.Helpers.toHsva(e),this.colorSelectedAnchor(this.color)}}_onHexChanged(){if(!this._changing){const e=this._hexField.value.trim().toLowerCase();if(/^([0-9a-f]{2}){3,4}$/.test(e)){const t=[parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16)];this.hsva=Xs(t).concat([this.hsva[3]]),this.colorSelectedAnchor(this.color)}}}_onMouseDown(e){e.currentTarget===this._colorRect.dom?this._dragMode=1:e.currentTarget===this._hueRect.dom?this._dragMode=2:this._dragMode=3,this._storeHsva=this._hsva.slice(),this._onMouseMove(e),window.addEventListener("mousemove",this.moveHandler),window.addEventListener("mouseup",this.upHandler)}_onMouseMove(e){let t;if(1===this._dragMode){const s=this.Helpers.normalizedCoord(this._colorRect,e.pageX,e.pageY),i=ki.clamp(s[0],0,1),n=ki.clamp(s[1],0,1);t=[this.hsva[0],i,1-n,this._hsva[3]]}else if(2===this._dragMode){const s=this.Helpers.normalizedCoord(this._hueRect,e.pageX,e.pageY);t=[ki.clamp(s[1],0,1),this.hsva[1],this.hsva[2],this.hsva[3]]}else{const s=this.Helpers.normalizedCoord(this._alphaRect,e.pageX,e.pageY),i=ki.clamp(s[1],0,1);t=[this.hsva[0],this.hsva[1],this.hsva[2],1-i]}t[0]===this._hsva[0]&&t[1]===this._hsva[1]&&t[2]===this._hsva[2]&&t[3]===this._hsva[3]||(this.hsva=t,this.emit("changing",this.color))}_onMouseUp(e){window.removeEventListener("mousemove",this.moveHandler),window.removeEventListener("mouseup",this.upHandler),this._storeHsva[0]===this._hsva[0]&&this._storeHsva[1]===this._hsva[1]&&this._storeHsva[2]===this._hsva[2]&&this._storeHsva[3]===this._hsva[3]||this.colorSelectedAnchor(this.color)}set hsva(e){const t=Ys(e),s=Ys([e[0],1,1]);e[0]!==this._hsva[0]&&this._generateGradient(this._colorRect,s);const i=this._colorRect.dom,n=i.getBoundingClientRect(),r=n.width-2,a=n.height-2;this._colorHandle.style.backgroundColor=this.Helpers.rgbaStr(t),this._colorHandle.style.left=i.offsetLeft-7+Math.floor(r*e[1])+"px",this._colorHandle.style.top=i.offsetTop-7+Math.floor(a*(1-e[2]))+"px",this._hueHandle.style.backgroundColor=this.Helpers.rgbaStr(s),this._hueHandle.style.top=i.offsetTop-3+Math.floor(140*e[0])+"px",this._hueHandle.style.left="162px",this._alphaHandle.style.backgroundColor=this.Helpers.rgbaStr(Ys([0,0,e[3]])),this._alphaHandle.style.top=i.offsetTop-3+Math.floor(140*(1-e[3]))+"px",this._alphaHandle.style.left="194px",this._changing=!0,this._rField.value=t[0],this._gField.value=t[1],this._bField.value=t[2],this._aField.value=Math.round(255*e[3]),this._hexField.value=this.Helpers.hexStr(t),this._changing=!1,this._hsva=e}get hsva(){return this._hsva}set color(e){const t=this.Helpers.toHsva(e);0===t[0]&&0===t[1]&&-1!==this._hsva[0]&&(t[0]=this._hsva[0]),this.hsva=t}get color(){return this.Helpers.toRgba(this._hsva)}set editAlpha(e){e?(this._alphaRect.dom.style.display="inline",this._alphaHandle.style.display="block",this._aField.dom.style.display="inline-block"):(this._alphaRect.dom.style.display="none",this._alphaHandle.style.display="none",this._aField.dom.style.display="none")}get editAlpha(){return this.editAlpha}open(){this.UI.overlay.hidden=!1}close(){this.UI.overlay.hidden=!0}onOpen(){window.addEventListener("mousemove",this._onAnchorsMouseMove),window.addEventListener("mouseup",this._onAnchorsMouseUp),this.UI.anchors.dom.addEventListener("mousedown",this._onAnchorsMouseDown)}onClose(){this.STATE.hoveredAnchor=-1,window.removeEventListener("mousemove",this._onAnchorsMouseMove),window.removeEventListener("mouseup",this._onAnchorsMouseUp),this.UI.anchors.dom.removeEventListener("mousedown",this._onAnchorsMouseDown),this._evtRefreshPicker.unbind(),this._evtRefreshPicker=null,this._evtPickerChanged.unbind(),this._evtPickerChanged=null}onDeleteKey(){if(!this.UI.overlay.hidden&&-1!==this.STATE.selectedAnchor){const e=this.STATE.anchors[this.STATE.selectedAnchor];this.STATE.selectedAnchor=-1,this.deleteAnchor(e)}}_onTypeChanged(e){e=this.STATE.typeMap[e];const t=[],s=[];for(let i=0;i<this.STATE.curves.length;++i)t.push(i.toString()+".type"),s.push(e);this.emit("picker:curve:change",t,s)}render(){this.renderGradient(),this.renderAnchors()}renderGradient(){const e=this.UI.gradient.dom.getContext("2d"),t=this.UI.gradient.width,s=this.UI.gradient.height,i=this.UI.gradient.pixelRatio;e.setTransform(i,0,0,i,0,0),e.fillStyle=this.UI.checkerPattern,e.fillRect(0,0,t,s);const n=e.createLinearGradient(0,0,t,0);for(let e=0;e<=t;e+=2){const s=e/t;n.addColorStop(s,this.Helpers.rgbaStr(this.evaluateGradient(s),255))}if(e.fillStyle=n,e.fillRect(0,0,t,s),-1!==this.STATE.selectedAnchor){const i=[this.STATE.anchors[this.STATE.selectedAnchor]*t,s],n=this.UI.draggingAnchor?-30:-6;e.beginPath(),e.rect(i[0]-.5,i[1],1,n),e.fillStyle="rgb(41, 53, 56)",e.fill()}}renderAnchors(){const e=this.UI.anchors.dom.getContext("2d"),t=this.UI.anchors.width,s=this.UI.anchors.height,i=this.UI.anchors.pixelRatio;e.setTransform(i,0,0,i,0,0),e.fillStyle=this.CONSTANTS.bg,e.fillRect(0,0,t,s);for(let t=0;t<this.STATE.anchors.length;++t)t!==this.STATE.hoveredAnchor&&t!==this.STATE.selectedAnchor&&this.renderAnchor(e,this.STATE.anchors[t]);-1!==this.STATE.hoveredAnchor&&this.STATE.hoveredAnchor!==this.STATE.selectedAnchor&&this.renderAnchor(e,this.STATE.anchors[this.STATE.hoveredAnchor],"hovered"),-1!==this.STATE.selectedAnchor&&this.renderAnchor(e,this.STATE.anchors[this.STATE.selectedAnchor],"selected")}renderAnchor(e,t,s){const i=[t*this.UI.anchors.width,this.UI.anchors.height/2],n="selected"===s?this.CONSTANTS.selectedRadius:this.CONSTANTS.anchorRadius;"selected"===s&&(e.beginPath(),e.rect(i[0]-.5,i[1],1,-i[1]),e.fillStyle="rgb(41, 53, 56)",e.fill()),"selected"!==s&&"hovered"!==s||(e.beginPath(),e.arc(i[0],i[1],n+2,0,2*Math.PI,!1),e.fillStyle="rgb(255, 255, 255)",e.fill()),e.beginPath(),e.arc(i[0],i[1],n+1,0,2*Math.PI,!1),e.fillStyle=this.Helpers.rgbaStr(this.evaluateGradient(t,1),255),e.fill()}evaluateGradient(e,t){const s=[];for(let t=0;t<3;++t)s.push(this.STATE.curves[t].value(e));return t?s.push(t):this.STATE.curves.length>3?s.push(this.STATE.curves[3].value(e)):s.push(1),s}calcAnchorTimes(){let e=[];for(let t=0;t<this.STATE.curves.length;t++){const s=this.STATE.curves[t];for(let t=0;t<s.keys.length;++t)e.push(s.keys[t][0])}return e.sort(),e=e.filter((function(e,t,s){return!t||e!==s[t-1]})),e}calcNormalizedCoord(e,t,s){return[(e-s.left)/s.width,(t-s.top)/s.height]}getClientRect(e){const t=window.getComputedStyle(e),s=parseFloat(t.paddingTop),i=parseFloat(t.paddingRight),n=parseFloat(t.paddingBottom),r=parseFloat(t.paddingLeft),a=e.getBoundingClientRect();return new DOMRect(a.x+r,a.y+s,a.width-i-r,a.height-s-n)}selectHovered(e){this.STATE.hoveredAnchor=e,this.UI.anchors.dom.style.cursor=-1===e?"":"pointer"}selectAnchor(e){if(this.STATE.selectedAnchor=e,this.STATE.changing=!0,-1===e)this.UI.positionEdit.value="",this.color=[0,0,0];else{const t=this.STATE.anchors[e];this.UI.positionEdit.value=Math.round(100*t),this.STATE.selectedValue=this.evaluateGradient(t),this.color=this.STATE.selectedValue,this.UI.showSelectedPosition.dom.style.left=(this.STATE.anchors[e]*this.UI.gradient.width-4).toString()+"px",this.UI.showSelectedPosition.value=Math.round(100*this.STATE.anchors[e])}this.STATE.changing=!1,this.render()}dragStart(){if(-1===this.STATE.selectedAnchor)return;const e=this.STATE.anchors[this.STATE.selectedAnchor];this.STATE.keystore=[];for(let t=0;t<this.STATE.curves.length;++t){const s=[];this.STATE.curves[t].keys.forEach((function(t){t[0]!==e&&s.push([t[0],t[1]])})),this.STATE.keystore.push(s)}}dragUpdate(e){if(-1!==this.STATE.selectedAnchor){for(let t=0;t<this.STATE.curves.length;++t){const s=this.STATE.curves[t],i=this.STATE.keystore[t];s.keys=i.map((function(e){return[e[0],e[1]]})).filter((function(t){return t[0]!==e})),s.keys.push([e,this.STATE.selectedValue[t]]),s.sort()}this.STATE.anchors=this.calcAnchorTimes(),this.selectAnchor(this.STATE.anchors.indexOf(e))}}dragEnd(){-1!==this.STATE.selectedAnchor&&this.emitCurveChange()}insertAnchor(e,t){for(let s=0;s<this.STATE.curves.length;++s){const i=this.STATE.curves[s].keys;let n=0;for(;n<i.length&&!(i[n][0]>=e);)++n;n<i.length&&i[n][0]===e?i[n][1]=t[s]:i.splice(n,0,[e,t[s]])}this.emitCurveChange()}deleteAnchor(e){for(let t=0;t<this.STATE.curves.length;++t){const s=this.STATE.curves[t];for(let t=0;t<s.keys.length;++t)if(s.keys[t][0]===e){s.keys.splice(t,1);break}}this.selectHovered(-1),this.emitCurveChange()}moveSelectedAnchor(e){-1!==this.STATE.selectedAnchor&&(this.dragStart(),this.dragUpdate(e),this.dragEnd())}colorSelectedAnchor(e,t){if(-1!==this.STATE.selectedAnchor){const s=this.STATE.anchors[this.STATE.selectedAnchor];for(let t=0;t<this.STATE.curves.length;++t){const i=this.STATE.curves[t];for(let n=0;n<i.keys.length;++n)if(i.keys[n][0]===s){i.keys[n][1]=e[t];break}}this.STATE.selectedValue=e,t?this.render():this.emitCurveChange()}}emitCurveChange(){const e=[],t=[];this.STATE.curves.forEach((function(s,i){e.push("0.keys."+i);const n=[];s.keys.forEach((function(e){n.push(e[0],e[1])})),t.push(n)})),this.emit("picker:curve:change",e,t)}doCopy(){const e={type:this.STATE.curves[0].type,keys:this.STATE.curves.map((function(e){return[].concat(...e.keys)}))};this._copiedData=e}doPaste(){const e=this._copiedData;if(null!==e){const t={type:e.type,keys:[]};for(let s=0;s<this.STATE.curves.length;++s)s<e.keys.length?t.keys.push(e.keys[s]):t.keys.push([].concat(...this.STATE.curves[s].keys));this.setValue([t]),this.emitCurveChange()}}doDelete(){const e=this.STATE.selectedAnchor;if(-1!==e&&1!==this.STATE.curves[0].keys.length){for(let t=0;t<this.STATE.curves.length;++t){this.STATE.curves[t].keys.splice(e,1)}this.emitCurveChange()}}createCheckerPattern(){const e=new Ls;e.width=16,e.height=16;const t=e.dom,s=t.getContext("2d");return s.fillStyle="#949a9c",s.fillRect(0,0,8,8),s.fillRect(8,8,8,8),s.fillStyle="#657375",s.fillRect(8,0,8,8),s.fillRect(0,8,8,8),s.createPattern(t,"repeat")}setValue(e,t){if(!(e instanceof Array)||1!==e.length||void 0===e[0].keys||3!==e[0].keys.length&&4!==e[0].keys.length)return;this.STATE.typeMap={0:5,1:0,2:4};const s=Object.fromEntries(Object.entries(this.STATE.typeMap).map((([e,t])=>[t,e])));5!==e[0].type&&0!==e[0].type&&4!==e[0].type&&(this.STATE.typeMap[3]=e[0].type),this.UI.typeCombo.options=[{v:0,t:"Step"},{v:1,t:"Linear"},{v:2,t:"Spline"}],this.UI.typeCombo.value=-1===this.UI.typeCombo.value?s[this.value.type]:this.UI.typeCombo.value,this.STATE.curves=[],e[0].keys.forEach((t=>{const s=new Fi(t);s.type=e[0].type,this.STATE.curves.push(s)})),this.STATE.anchors=this.calcAnchorTimes(),0===this.STATE.anchors.length?this.selectAnchor(-1):this.selectAnchor(ki.clamp(this.STATE.selectedAnchor,0,this.STATE.anchors.length-1)),this.editAlpha=this.STATE.curves.length>3}callOpenGradientPicker(e,t){this.setValue(e,t),this.open()}getGradientPickerRect(){return this.UI.overlay.dom.getBoundingClientRect()}positionGradientPicker(e,t){t+this.UI.panel.clientHeight>window.innerHeight&&(t=window.innerHeight-this.UI.panel.clientHeight),this.UI.overlay.position(e,t)}setGradientPicker(e,t){this.setValue(e,t)}}It.register("div",Hi);var Wi=Hi;class Gi extends gs{constructor(e){super(e),this.elementClass=Wi}render(){return n.exports.createElement("div",{ref:this.attachElement})}}Gi.ctor=Wi;var ji=Gi;const qi="pcui-radio-button",Ki=qi+"-selected";class Xi extends It{constructor(e={}){super(Object.assign({tabIndex:0},e)),this._onKeyDown=e=>{"Escape"!==e.key?this.enabled&&!this.readOnly&&" "===e.key&&(e.stopPropagation(),e.preventDefault(),this.value=!this.value):this.blur()},this._onFocus=e=>{this.emit("focus")},this._onBlur=e=>{this.emit("blur")},this.class.add(qi),this.class.add(Et),this.dom.addEventListener("keydown",this._onKeyDown),this.dom.addEventListener("focus",this._onFocus),this.dom.addEventListener("blur",this._onBlur),this.value=e.value,this._renderChanges=e.renderChanges}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),this.dom.removeEventListener("focus",this._onFocus),this.dom.removeEventListener("blur",this._onBlur),super.destroy())}_onClick(e){return this.enabled&&this.focus(),this.enabled&&!this.readOnly&&(this.value=!this.value),super._onClick(e)}_updateValue(e){return this.class.remove(Ct),e!==this.value&&(this._value=e,e?this.class.add(Ki):this.class.remove(Ki),this.renderChanges&&this.flash(),this.emit("change",e),!0)}focus(){this.dom.focus()}blur(){this.dom.blur()}set value(e){this._updateValue(e)&&this._binding&&this._binding.setValue(e)}get value(){return this._value}set values(e){const t=e.some((t=>t!==e[0]));t?(this._updateValue(null),this.class.add(Ct)):this._updateValue(e[0])}set renderChanges(e){this._renderChanges=e}get renderChanges(){return this._renderChanges}}It.register("radio",Xi,{renderChanges:!0});var Yi=Xi;const Zi="pcui-gridview-item",$i=Zi+"-selected",Qi=Zi+"-text";class Ji extends Bt{constructor(e={}){var t,s,i;super(Object.assign({tabIndex:0},e)),this._onRadioButtonClick=()=>{this._radioButton.value=this.selected},this._onFocus=()=>{this.emit("focus")},this._onBlur=()=>{this.emit("blur")},this.allowSelect=null===(t=e.allowSelect)||void 0===t||t,this._type=null!==(s=e.type)&&void 0!==s?s:null,this._selected=!1,"radio"===e.type?(this.class.add("pcui-gridview-radio-container"),this._radioButton=new Yi({class:"pcui-gridview-radiobtn",binding:new ht}),this._radioButton.dom.removeEventListener("click",this._radioButton._onClick),this._radioButton.dom.addEventListener("click",this._onRadioButtonClick),this.append(this._radioButton)):this.class.add(Zi),this._labelText=new Ht({class:Qi,binding:new ht,text:null!==(i=e.text)&&void 0!==i?i:""}),this.append(this._labelText),this.dom.addEventListener("focus",this._onFocus),this.dom.addEventListener("blur",this._onBlur)}destroy(){this._destroyed||(this.dom.removeEventListener("focus",this._onFocus),this.dom.removeEventListener("blur",this._onBlur),super.destroy())}focus(){this.dom.focus()}blur(){this.dom.blur()}link(e,t){this._labelText.link(e,t)}unlink(){this._labelText.unlink()}set allowSelect(e){this._allowSelect=e}get allowSelect(){return this._allowSelect}set selected(e){e&&this.focus(),this._selected!==e&&(this._selected=e,e?(this._radioButton?this._radioButton.value=e:this.class.add($i),this.emit("select",this)):(this._radioButton?this._radioButton.value=!1:this.class.remove($i),this.emit("deselect",this)))}get selected(){return this._selected}set text(e){this._labelText.text=e}get text(){return this._labelText.text}get nextSibling(){let e=this.dom.nextSibling;for(;e;){if(e.ui instanceof Ji&&!e.ui.hidden)return e.ui;e=e.nextSibling}return null}get previousSibling(){let e=this.dom.previousSibling;for(;e;){if(e.ui instanceof Ji&&!e.ui.hidden)return e.ui;e=e.previousSibling}return null}}var en=Ji;const tn="pcui-gridview",sn=tn+"-vertical";var nn=class extends Bt{constructor(e={}){var t,s;super(e),this._filterAnimationFrame=null,this._filterCanceled=!1,this._selected=[],this._vertical=!!e.vertical,this.class.add(this._vertical?sn:tn),this.on("append",(e=>{this._onAppendGridViewItem(e)})),this.on("remove",(e=>{this._onRemoveGridViewItem(e)})),this._filterFn=e.filterFn,this._multiSelect=null===(t=e.multiSelect)||void 0===t||t,this._allowDeselect=null===(s=e.allowDeselect)||void 0===s||s}_onAppendGridViewItem(e){if(!(e instanceof en))return;let t;t=this._clickFn?e.on("click",(t=>this._clickFn(t,e))):e.on("click",(t=>this._onClickItem(t,e)));let s,i=e.on("select",(()=>this._onSelectItem(e)));this._allowDeselect&&(s=e.on("deselect",(()=>this._onDeselectItem(e)))),this._filterFn&&!this._filterFn(e)&&(e.hidden=!0),e.once("griditem:remove",(()=>{t.unbind(),t=null,i.unbind(),i=null,this._allowDeselect&&(s.unbind(),s=null)}))}_onRemoveGridViewItem(e){e instanceof en&&(e.selected=!1,e.emit("griditem:remove"),e.unbind("griditem:remove"))}_onClickItem(e,t){if((e.ctrlKey||e.metaKey)&&this._multiSelect)t.selected=!t.selected;else if(e.shiftKey&&this._multiSelect){const e=this._selected[this._selected.length-1];if(e){if(e.dom.compareDocumentPosition(t.dom)&Node.DOCUMENT_POSITION_FOLLOWING){let s=e.nextSibling;for(;s&&(s.selected=!0,s!==t);)s=s.nextSibling}else{let s=e.previousSibling;for(;s&&(s.selected=!0,s!==t);)s=s.previousSibling}}else t.selected=!0}else{let e=!1,s=this._selected.length;for(;s--;)this._selected[s]&&this._selected[s]!==t&&(this._selected[s].selected=!1,e=!0);t.selected=!!e||!t.selected}}_onSelectItem(e){this._selected.push(e),this.emit("select",e)}_onDeselectItem(e){const t=this._selected.indexOf(e);-1!==t&&(this._selected.splice(t,1),this.emit("deselect",e))}deselect(){let e=this._selected.length;for(;e--;)this._selected[e]&&(this._selected[e].selected=!1)}filter(){this.forEachChild((e=>{e instanceof en&&(e.hidden=this._filterFn&&!this._filterFn(e))}))}filterAsync(e=100){let t=0;const s=this.dom.childNodes,i=s.length;this.emit("filter:start"),this._filterCanceled=!1;const n=()=>{this._filterAnimationFrame=null;let r=0;for(;t<i&&r<e;t++){if(this._filterCanceled)return this._filterCanceled=!1,void this.emit("filter:cancel");const e=s[t].ui;e instanceof en&&(this._filterFn&&!this._filterFn(e)?e.hidden=!0:(e.hidden=!1,r++))}t<i?(this.emit("filter:delay"),this._filterAnimationFrame=requestAnimationFrame(n)):this.emit("filter:end")};n()}filterAsyncCancel(){this._filterAnimationFrame?(cancelAnimationFrame(this._filterAnimationFrame),this._filterAnimationFrame=null):this._filterCanceled=!0}destroy(){this._destroyed||(this._filterAnimationFrame&&(cancelAnimationFrame(this._filterAnimationFrame),this._filterAnimationFrame=null),super.destroy())}get selected(){return this._selected.slice()}get vertical(){return this._vertical}};class rn extends gs{constructor(e){super(e),this.element=new nn(Object.assign({},e)),this.loadChildren(this.props.children,this.element)}loadChildren(e,t){e&&(Array.isArray(e)||(e=[e]),e.forEach((e=>{const s=new en({text:e.props.text,open:!1});t.append(s),this.loadChildren(e.props.children,s)})))}render(){return n.exports.createElement("div",{ref:e=>{e&&e.appendChild(this.element.dom)}})}}rn.ctor=nn;var an=rn;class on extends gs{constructor(e){super(e),this.elementClass=en}render(){return super.render()}}on.ctor=en;var ln=on;class hn extends Bt{constructor(e={}){var t,s,i,n;super(e),this._titleElement=new It,this._textElement=new It,this.class.add("pcui-infobox"),this.append(this._titleElement),this.append(this._textElement),this._unsafe=null!==(t=e.unsafe)&&void 0!==t&&t,this.icon=null!==(s=e.icon)&&void 0!==s?s:"",this.title=null!==(i=e.title)&&void 0!==i?i:"",this.text=null!==(n=e.text)&&void 0!==n?n:""}set icon(e){this._icon!==e&&(this._icon=e,e?this.dom.setAttribute("data-icon",String.fromCodePoint(parseInt(e,16))):this.dom.removeAttribute("data-icon"))}get icon(){return this._icon}set title(e){this._title!==e&&(this._title=e,this._unsafe?this._titleElement.dom.innerHTML=e:this._titleElement.dom.textContent=e)}get title(){return this._title}set text(e){this._text!==e&&(this._text=e,this._unsafe?this._textElement.dom.innerHTML=e:this._textElement.dom.textContent=e)}get text(){return this._text}}It.register("infobox",hn);var cn=hn;class dn extends gs{constructor(e){super(e),this.elementClass=cn}render(){return n.exports.createElement("span",{ref:this.attachElement})}}dn.ctor=cn;var un=dn;class pn extends gs{constructor(e={}){super(e),this.elementClass=Ht}render(){return n.exports.createElement("span",{ref:this.attachElement})}}pn.ctor=Ht;var mn=pn;const _n="pcui-label-group",fn=_n+"-align-top";class gn extends Bt{constructor(e={}){var t,s;super(e),this.class.add(_n),this._label=new Ht({text:null!==(t=e.text)&&void 0!==t?t:"Label",nativeTooltip:e.nativeTooltip}),this.append(this._label),this._field=null!==(s=e.field)&&void 0!==s?s:null,this._field&&this.append(this._field),this.labelAlignTop=e.labelAlignTop}get label(){return this._label}get field(){return this._field}set text(e){this._label.text=e}get text(){return this._label.text}set labelAlignTop(e){e?this.class.add(fn):this.class.remove(fn)}get labelAlignTop(){return this.class.contains(fn)}}It.register("labelgroup",gn);var vn=gn;class yn extends gs{constructor(e){super(e),this.attachElement=(e,t)=>{if(!e)return;const s="A LabelGroup must contain a single PCUI react component as a child";if(Array.isArray(this.props.children)||!this.props.children)throw new Error(s);const i=this.props.children,n=i.props;if(!(i.type.prototype instanceof gs))throw new Error(s);const r=new(0,i.type.ctor)(Object.assign({},n));i.props.link&&r.link(n.link.observer,n.link.path),this.element=new this.elementClass(Object.assign(Object.assign({},this.props),{dom:e,container:t,parent:void 0,field:r}))},this.elementClass=vn}render(){return super.render()}}yn.ctor=vn;var bn=yn;const xn="pcui-menu-item",wn=xn+"-content",Sn=xn+"-children",Cn=xn+"-has-children";class Tn extends Bt{constructor(e={}){super(e),this._numChildren=0,this._icon=null,this._menu=null,this._onClickMenuItem=e=>{e.preventDefault(),e.stopPropagation(),this.enabled&&(this._onSelect&&this._onSelect(e),this.emit("select"),this.menu&&(this.menu.hidden=!0))},this.class.add(xn),this._containerContent=new Bt({class:wn,flex:!0,flexDirection:"row"}),this.append(this._containerContent),this._labelText=new Ht,this._containerContent.append(this._labelText),this._containerItems=new Bt({class:Sn}),this.append(this._containerItems),this.domContent=this._containerItems.dom,this.text=e.text||"Untitled",this.dom.addEventListener("click",this._onClickMenuItem),e.value&&(this.value=e.value),e.icon&&(this.icon=e.icon),e.binding&&(this.binding=e.binding),this.onIsEnabled=e.onIsEnabled,this.onSelect=e.onSelect,this.onIsVisible=e.onIsVisible,e.items&&e.items.forEach((e=>{const t=new Tn(e);this.append(t)}))}destroy(){this.destroyed||(this.dom.removeEventListener("click",this._onClickMenuItem),super.destroy())}_onAppendChild(e){super._onAppendChild(e),this._numChildren++,e instanceof Tn&&(this.class.add(Cn),e.menu=this.menu)}_onRemoveChild(e){e instanceof Tn&&(this._numChildren--,0===this._numChildren&&this.class.remove(Cn),e.menu=null),super._onRemoveChild(e)}link(e,t){super.link(e,t),this._labelText.link(e,t)}unlink(){super.unlink(),this._labelText.unlink()}select(){this.enabled&&(this._onSelect&&this._onSelect(),this.emit("select"),this.menu&&(this.menu.hidden=!0))}set text(e){this._labelText.text=e}get text(){return this._labelText.text}set value(e){this.text=e}get value(){return this.text}set values(e){this._labelText.values=e}set icon(e){this._icon!==e&&e.match(/^E[0-9]{0,4}$/)&&(this._icon=e,e?this._labelText.dom.setAttribute("data-icon",String.fromCodePoint(parseInt(e,16))):this._labelText.dom.removeAttribute("data-icon"))}get icon(){return this._icon}set binding(e){this._labelText.binding=e}get binding(){return this._labelText.binding}set menu(e){if(this._menu=e,!this._containerItems.destroyed)for(const t of this._containerItems.dom.childNodes)t.ui instanceof Tn&&(t.ui.menu=e)}get menu(){return this._menu}set onSelect(e){this._onSelect=e}get onSelect(){return this._onSelect}set onIsEnabled(e){this._onIsEnabled=e}get onIsEnabled(){return this._onIsEnabled}set onIsVisible(e){this._onIsVisible=e}get onIsVisible(){return this._onIsVisible}get hasChildren(){return this._numChildren>0}set renderChanges(e){this._renderChanges=e}get renderChanges(){return this._renderChanges}}var An=Tn;const En="pcui-menu",Pn=En+"-items";var Mn=class extends Bt{constructor(e={}){var t;super(Object.assign({tabIndex:1},e)),this._onClickMenu=e=>{this._containerMenuItems.dom.contains(e.target)||(this.hidden=!0)},this._onFocus=e=>{this.emit("focus")},this._onBlur=e=>{this.emit("blur")},this._onKeyDown=e=>{this.hidden||"Escape"===e.key&&(this.hidden=!0)},this.hidden=null===(t=e.hidden)||void 0===t||t,this.class.add(En),this._containerMenuItems=new Bt({class:Pn,flex:!0,flexDirection:"column"}),this.append(this._containerMenuItems),this.domContent=this._containerMenuItems.dom,this.on("click",this._onClickMenu),this.on("show",(()=>{this._onShowMenu()})),this.dom.addEventListener("contextmenu",this._onClickMenu),this.dom.addEventListener("keydown",this._onKeyDown),e.items&&e.items.forEach((e=>{const t=new An(e);this.append(t)}))}destroy(){this.destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),this.dom.removeEventListener("contextmenu",this._onClickMenu),this.dom.removeEventListener("focus",this._onFocus),this.dom.removeEventListener("blur",this._onBlur),super.destroy())}_onAppendChild(e){e instanceof An&&(e.menu=this)}_onRemoveChild(e){e instanceof An&&(e.menu=null)}_filterMenuItems(e){if(e instanceof An){e.onIsEnabled&&(e.enabled=e.onIsEnabled()),e.onIsVisible&&(e.hidden=!e.onIsVisible());for(const t of e._containerItems.dom.childNodes)this._filterMenuItems(t.ui)}}_onShowMenu(){this.focus();for(const e of this._containerMenuItems.dom.childNodes)this._filterMenuItems(e.ui)}_limitSubmenuAtScreenEdges(e){if(!(e instanceof An&&e.hasChildren))return;const t=e._containerItems;t.style.top="",t.style.left="",t.style.right="";const s=t.dom.getBoundingClientRect();s.bottom>window.innerHeight&&(t.style.top=-(s.bottom-window.innerHeight)+"px"),s.right>window.innerWidth&&(t.style.left="auto",t.style.right="100%");for(const e of t.dom.childNodes)this._limitSubmenuAtScreenEdges(e.ui)}focus(){this.dom.focus()}blur(){this.dom.blur()}position(e,t){const s=this._containerMenuItems.dom.getBoundingClientRect();let i=e||0,n=t||0;n+s.height>window.innerHeight?n=window.innerHeight-s.height:n<0&&(n=0),i+s.width>window.innerWidth?i=window.innerWidth-s.width:i<0&&(i=0),this._containerMenuItems.style.left=i+"px",this._containerMenuItems.style.top=n+"px";for(const e of this._containerMenuItems.dom.childNodes)this._limitSubmenuAtScreenEdges(e.ui)}clear(){this._containerMenuItems.clear()}};class Ln extends gs{constructor(e){super(e),this.onDivLoaded=e=>{this.element=new Mn(Object.assign(Object.assign({},this.props),{dom:e}))},this.elementClass=Mn}render(){return n.exports.createElement("div",{ref:this.onDivLoaded})}}Ln.ctor=Mn;var Dn=Ln;class kn extends gs{constructor(e){super(e),this.elementClass=os}render(){return super.render()}}kn.ctor=os;var In=kn;class Rn extends gs{constructor(e){super(e),this.elementClass=js}render(){return super.render()}}Rn.ctor=js;var On=Rn;class zn extends gs{constructor(e={}){super(e),this.elementClass=Jt}componentDidMount(){this.attachElement(this.nodeElement,this.containerElement)}render(){let e=n.exports.Children.toArray(this.props.children);return 1===e.length?e=n.exports.cloneElement(e[0],{parent:this.element}):e.length>0&&(e=e.map((e=>n.exports.cloneElement(e,{parent:this.element})))),n.exports.createElement("div",{ref:e=>{this.nodeElement=e}},n.exports.createElement("div",{ref:e=>{this.containerElement=e}},e))}}zn.ctor=Jt;var Fn=zn;const Vn="pcui-progress",Nn=Vn+"-inner";class Bn extends Bt{constructor(e={}){super(e),this._inner=new It({class:Nn}),this.class.add(Vn),this.append(this._inner),void 0!==e.value&&(this.value=e.value)}set value(e){this._value!==e&&(this._value=e,this._inner.width=`${this._value}%`,this.emit("change",e))}get value(){return this._value}}It.register("progress",Bn);var Un=Bn;class Hn extends gs{constructor(e){super(e),this.elementClass=Un}render(){return super.render()}}Hn.ctor=Un;var Wn=Hn;class Gn extends gs{constructor(e){super(e),this.elementClass=Yi}render(){return super.render()}}Gn.ctor=Yi;var jn=Gn;class qn extends gs{constructor(e){super(e),this.elementClass=Di,this.onSelect=e.onSelect,this.onAttach=this.onAttachFn.bind(this)}onAttachFn(){this.props.onSelect&&this.element.on("select",this.onSelect)}render(){return super.render()}}qn.ctor=Di;var Kn,Xn=qn;const Yn="pcui-slider",Zn=Yn+"-container",$n=Yn+"-bar",Qn=Yn+"-handle",Jn=Yn+"-active",er=/Chrome\//.test(null===(Kn=globalThis.navigator)||void 0===Kn?void 0:Kn.userAgent);class tr extends It{constructor(e={}){var t,s,i,n,r;super(e),this._historyCombine=!1,this._historyPostfix=null,this._cursorHandleOffset=0,this._touchId=null,this._onMouseDown=e=>{0===e.button&&this.enabled&&!this.readOnly&&this._onSlideStart(e.pageX)},this._onMouseMove=e=>{e.stopPropagation(),e.preventDefault(),this._onSlideMove(e.pageX)},this._onMouseUp=e=>{e.stopPropagation(),e.preventDefault(),this._onSlideEnd(e.pageX)},this._onTouchStart=e=>{if(this.enabled&&!this.readOnly)for(let t=0;t<e.changedTouches.length;t++){const s=e.changedTouches[t],i=s.target;if(i.ui&&i.ui===this){this._touchId=s.identifier,this._onSlideStart(s.pageX);break}}},this._onTouchMove=e=>{for(let t=0;t<e.changedTouches.length;t++){const s=e.changedTouches[t];if(s.identifier===this._touchId){e.stopPropagation(),e.preventDefault(),this._onSlideMove(s.pageX);break}}},this._onTouchEnd=e=>{for(let t=0;t<e.changedTouches.length;t++){const s=e.changedTouches[t];if(s.identifier===this._touchId){e.stopPropagation(),e.preventDefault(),this._onSlideEnd(s.pageX),this._touchId=null;break}}},this._onKeyDown=e=>{if("Escape"===e.key)return void this.blur();if(!this.enabled||this.readOnly)return;if("ArrowLeft"!==e.key&&"ArrowRight"!==e.key)return;e.stopPropagation(),e.preventDefault();let t="ArrowLeft"===e.key?-1:1;e.shiftKey&&(t*=10),this.value+=t*this.step},this.class.add(Yn);const a=new os({allowNull:e.allowNull,hideSlider:!0,min:e.min,max:e.max,keyChange:e.keyChange,placeholder:e.placeholder,precision:null!==(t=e.precision)&&void 0!==t?t:2,renderChanges:e.renderChanges,step:e.step});a.on("change",(e=>{this._onValueChange(e)})),a.on("focus",(()=>{this.emit("focus")})),a.on("blur",(()=>{this.emit("blur")})),a.parent=this,this.dom.appendChild(a.dom),this._numericInput=a,this._sliderMin=null!==(i=null!==(s=e.sliderMin)&&void 0!==s?s:e.min)&&void 0!==i?i:0,this._sliderMax=null!==(r=null!==(n=e.sliderMax)&&void 0!==n?n:e.max)&&void 0!==r?r:1,this._domSlider=document.createElement("div"),this._domSlider.classList.add(Zn),this.dom.appendChild(this._domSlider),this._domBar=document.createElement("div"),this._domBar.classList.add($n),this._domBar.ui=this,this._domSlider.appendChild(this._domBar),this._domHandle=document.createElement("div"),this._domHandle.ui=this,this._domHandle.tabIndex=0,this._domHandle.classList.add(Qn),this._domBar.appendChild(this._domHandle),this._domSlider.addEventListener("mousedown",this._onMouseDown),this._domSlider.addEventListener("touchstart",this._onTouchStart,{passive:!0}),this._domHandle.addEventListener("keydown",this._onKeyDown),void 0!==e.value&&(this.value=e.value),void 0!==e.values&&(this.values=e.values),0===this.value&&this._updateHandle(0)}destroy(){this._destroyed||(this._domSlider.removeEventListener("mousedown",this._onMouseDown),this._domSlider.removeEventListener("touchstart",this._onTouchStart),this._domHandle.removeEventListener("keydown",this._onKeyDown),this.dom.removeEventListener("mouseup",this._onMouseUp),this.dom.removeEventListener("mousemove",this._onMouseMove),this.dom.removeEventListener("touchmove",this._onTouchMove),this.dom.removeEventListener("touchend",this._onTouchEnd),super.destroy())}_updateHandle(e){const t=100*Math.max(0,Math.min(1,((e||0)-this._sliderMin)/(this._sliderMax-this._sliderMin))),s=this._domHandle.getBoundingClientRect().width;this._domHandle.style.left=`calc(${t}% + ${s/2}px)`}_onValueChange(e){this._updateHandle(e),this._suppressChange||this.emit("change",e),this._binding&&this._binding.setValue(e)}_calculateCursorHandleOffset(e){const t=er?2:0,s=this._domHandle.getBoundingClientRect(),i=s.left-t,n=s.right;return this._cursorHandleOffset=e>=i&&e<=n?e-(i+(n-i)/2):0,this._cursorHandleOffset}_onSlideStart(e){this._domHandle.focus(),null===this._touchId?(window.addEventListener("mousemove",this._onMouseMove),window.addEventListener("mouseup",this._onMouseUp)):(window.addEventListener("touchmove",this._onTouchMove),window.addEventListener("touchend",this._onTouchEnd)),this.class.add(Jn),this._calculateCursorHandleOffset(e)||this._onSlideMove(e),this.binding&&(this._historyCombine=this.binding.historyCombine,this._historyPostfix=this.binding.historyPostfix,this.binding.historyCombine=!0,this.binding.historyPostfix=`(${Date.now()})`)}_onSlideMove(e){const t=this._domBar.getBoundingClientRect();e-=this._cursorHandleOffset;let s=Math.max(0,Math.min(1,(e-t.left)/t.width))*(this._sliderMax-this._sliderMin)+this._sliderMin;s=parseFloat(s.toFixed(this.precision)),this.value=s}_onSlideEnd(e){this._calculateCursorHandleOffset(e)||this._onSlideMove(e),this.class.remove(Jn),null===this._touchId?(window.removeEventListener("mousemove",this._onMouseMove),window.removeEventListener("mouseup",this._onMouseUp)):(window.removeEventListener("touchmove",this._onTouchMove),window.removeEventListener("touchend",this._onTouchEnd)),this.binding&&(this.binding.historyCombine=this._historyCombine,this.binding.historyPostfix=this._historyPostfix,this._historyCombine=!1,this._historyPostfix=null)}focus(){this._numericInput.focus()}blur(){this._domHandle.blur(),this._numericInput.blur()}set sliderMin(e){this._sliderMin!==e&&(this._sliderMin=e,this._updateHandle(this.value))}get sliderMin(){return this._sliderMin}set sliderMax(e){this._sliderMax!==e&&(this._sliderMax=e,this._updateHandle(this.value))}get sliderMax(){return this._sliderMax}set value(e){this._numericInput.value=e,this._numericInput.class.contains(Ct)?this.class.add(Ct):this.class.remove(Ct)}get value(){return this._numericInput.value}set values(e){this._numericInput.values=e,this._numericInput.class.contains(Ct)?this.class.add(Ct):this.class.remove(Ct)}set renderChanges(e){this._numericInput.renderChanges=e}get renderChanges(){return this._numericInput.renderChanges}set min(e){this._numericInput.min=e}get min(){return this._numericInput.min}set max(e){this._numericInput.max=e}get max(){return this._numericInput.max}set step(e){this._numericInput.step=e}get step(){return this._numericInput.step}set precision(e){this._numericInput.precision=e}get precision(){return this._numericInput.precision}set keyChange(e){this._numericInput.keyChange=e}get keyChange(){return this._numericInput.keyChange}set placeholder(e){this._numericInput.placeholder=e}get placeholder(){return this._numericInput.placeholder}}It.register("slider",tr,{renderChanges:!0});var sr=tr;class ir extends gs{constructor(e){super(e),this.elementClass=sr}render(){return super.render()}}ir.ctor=sr;var nr=ir;class rr extends It{constructor(e={}){var t,s;if((null!==(t=e.type)&&void 0!==t?t:"small-thick")===rr.TYPE_SMALL_THICK){const t=function(e,t){const s=t||document.createElementNS("http://www.w3.org/2000/svg","svg");return s.classList.add("spin"),s.setAttribute("width",e),s.setAttribute("height",e),s.setAttribute("viewBox","0 0 14 14"),s.setAttribute("fill","none"),s.innerHTML='<path d="M7 14C3.13871 14 0 10.8613 0 7C0 3.13871 3.13871 0 7 0C10.8613 0 14 3.13871 14 7C14 10.8613 10.8613 14 7 14ZM7 2.25806C4.38064 2.25806 2.25806 4.38064 2.25806 7C2.25806 9.61935 4.38064 11.7419 7 11.7419C9.61935 11.7419 11.7419 9.61935 11.7419 7C11.7419 4.38064 9.61935 2.25806 7 2.25806Z" fill="#773417"/><path class="pcui-spinner-highlight" d="M7 14V11.7419C9.61935 11.7419 11.7419 9.61935 11.7419 7H14C14 10.8613 10.8613 14 7 14Z" fill="#FF6600"/>',s}(null!==(s=e.size)&&void 0!==s?s:12,e.dom);e=Object.assign(Object.assign({},e),{dom:t})}super(e),this.class.add("pcui-spinner")}}rr.TYPE_SMALL_THICK="small-thick";var ar=rr;class or extends gs{constructor(e){super(e),this.elementClass=ar}render(){return n.exports.createElement("svg",{ref:this.attachElement})}}or.ctor=ar;var lr=or;const hr="pcui-text-area-input",cr=hr+"-resizable",dr=cr+"-none",ur=cr+"-both",pr=cr+"-horizontal",mr=cr+"-vertical";class _r extends Ks{constructor(e={}){switch(super(e=Object.assign({input:document.createElement("textarea")},e)),this.class.add(hr),e.resizable){case"both":this.class.add(ur);break;case"horizontal":this.class.add(pr);break;case"vertical":this.class.add(mr);break;default:this.class.add(dr)}}_onInputKeyDown(e){("Escape"===e.key&&this.blurOnEscape||"Enter"===e.key&&this.blurOnEnter&&!e.shiftKey)&&this._domInput.blur(),this.emit("keydown",e)}}It.register("text",_r,{renderChanges:!0});var fr=_r;class gr extends gs{constructor(e){super(e),this.elementClass=fr}render(){return super.render()}}gr.ctor=fr;var vr=gr;class yr extends gs{constructor(e={}){super(e),this.elementClass=Ks,e.onValidate&&(this.onValidate=e.onValidate),this.onAttach=this.onAttachFn.bind(this)}onAttachFn(){this.onValidate&&(this.element.onValidate=this.onValidate)}render(){return super.render()}}yr.ctor=Ks;var br=yr;const xr="pcui-treeview-item",wr=xr+"-icon",Sr=xr+"-text",Cr=xr+"-selected",Tr=xr+"-open",Ar=xr+"-contents",Er=xr+"-empty",Pr=xr+"-rename";class Mr extends Bt{constructor(e={}){var t,s,i,n;super(e),this._numChildren=0,this._onContentKeyDown=e=>{"INPUT"!==e.target.tagName&&this.allowSelect&&this._treeView&&this._treeView._onChildKeyDown(e,this)},this._onContentMouseDown=e=>{this._treeView&&this._treeView.allowDrag&&this._allowDrag&&(this._treeView._updateModifierKeys(e),e.stopPropagation())},this._onContentMouseUp=e=>{e.stopPropagation(),e.preventDefault(),window.removeEventListener("mouseup",this._onContentMouseUp),this._treeView&&this._treeView._onChildDragEnd(e,this)},this._onContentMouseOver=e=>{e.stopPropagation(),this._treeView&&this._treeView._onChildDragOver(e,this),this.emit("hover",e)},this._onContentDragStart=e=>{e.stopPropagation(),e.preventDefault(),this._treeView&&this._treeView.allowDrag&&(this.class.contains(Pr)||(this._treeView._onChildDragStart(e,this),window.addEventListener("mouseup",this._onContentMouseUp)))},this._onContentClick=e=>{if(!this.allowSelect||0!==e.button)return;if("INPUT"===e.target.tagName)return;e.stopPropagation();const t=this._containerContents.dom.getBoundingClientRect();this._numChildren>0&&e.clientX-t.left<0?(this.open=!this.open,e.altKey&&this._dfs((e=>{e.open=this.open})),this.focus()):this._treeView&&this._treeView._onChildClick(e,this)},this._onContentDblClick=e=>{if(!this._treeView||!this._treeView.allowRenaming||0!==e.button)return;if("INPUT"===e.target.tagName)return;e.stopPropagation();const t=this._containerContents.dom.getBoundingClientRect();this.numChildren&&e.clientX-t.left<0||(this.allowSelect&&(this._treeView.deselect(),this._treeView._onChildClick(e,this)),this.rename())},this._onContentContextMenu=e=>{this._treeView&&this._treeView._onContextMenu&&this._treeView._onContextMenu(e,this)},this._onContentFocus=e=>{this.emit("focus")},this._onContentBlur=e=>{this.emit("blur")},this.class.add(xr,Er),this._containerContents=new Bt({class:Ar,flex:!0,flexDirection:"row",tabIndex:0}),this.append(this._containerContents),this._containerContents.dom.draggable=!0,this._labelIcon=new Ht({class:wr}),this._containerContents.append(this._labelIcon),this.icon=null!==(t=e.icon)&&void 0!==t?t:"E360",this._labelText=new Ht({class:Sr}),this._containerContents.append(this._labelText),this.allowSelect=null===(s=e.allowSelect)||void 0===s||s,this.allowDrop=null===(i=e.allowDrop)||void 0===i||i,this.allowDrag=null===(n=e.allowDrag)||void 0===n||n,e.text&&(this.text=e.text),e.selected&&(this.selected=e.selected);const r=this._containerContents.dom;r.addEventListener("focus",this._onContentFocus),r.addEventListener("blur",this._onContentBlur),r.addEventListener("keydown",this._onContentKeyDown),r.addEventListener("dragstart",this._onContentDragStart),r.addEventListener("mousedown",this._onContentMouseDown),r.addEventListener("mouseover",this._onContentMouseOver),r.addEventListener("click",this._onContentClick),r.addEventListener("dblclick",this._onContentDblClick),r.addEventListener("contextmenu",this._onContentContextMenu)}destroy(){if(this._destroyed)return;const e=this._containerContents.dom;e.removeEventListener("focus",this._onContentFocus),e.removeEventListener("blur",this._onContentBlur),e.removeEventListener("keydown",this._onContentKeyDown),e.removeEventListener("dragstart",this._onContentDragStart),e.removeEventListener("mousedown",this._onContentMouseDown),e.removeEventListener("mouseover",this._onContentMouseOver),e.removeEventListener("click",this._onContentClick),e.removeEventListener("dblclick",this._onContentDblClick),e.removeEventListener("contextmenu",this._onContentContextMenu),window.removeEventListener("mouseup",this._onContentMouseUp),super.destroy()}_onAppendChild(e){super._onAppendChild(e),e instanceof Mr&&(this._numChildren++,this._parent!==this._treeView&&this.class.remove(Er),this._treeView&&this._treeView._onAppendTreeViewItem(e))}_onRemoveChild(e){e instanceof Mr&&(this._numChildren--,0===this._numChildren&&this.class.add(Er),this._treeView&&this._treeView._onRemoveTreeViewItem(e)),super._onRemoveChild(e)}_dfs(e){e(this);let t=this.firstChild;for(;t;)t._dfs(e),t=t.nextSibling}rename(){this.class.add(Pr);const e=new Ks({renderChanges:!1,value:this.text,class:Pt});e.on("blur",(()=>{e.destroy()})),e.on("destroy",(()=>{this.class.remove(Pr),this.focus()})),e.on("change",(t=>{(t=t.trim())&&(this.text=t,e.destroy())})),e.on("disable",(()=>{e.input.removeAttribute("readonly")})),this._containerContents.append(e),e.focus(!0)}focus(){this._containerContents.dom.focus()}blur(){this._containerContents.dom.blur()}set selected(e){e!==this.selected?e?(this._containerContents.class.add(Cr),this.emit("select",this),this._treeView&&this._treeView._onChildSelected(this),this.focus()):(this._containerContents.class.remove(Cr),this.blur(),this.emit("deselect",this),this._treeView&&this._treeView._onChildDeselected(this)):e&&this.focus()}get selected(){return this._containerContents.class.contains(Cr)}set text(e){this._labelText.value!==e&&(this._labelText.value=e,this._treeView&&this._treeView._onChildRename(this,e))}get text(){return this._labelText.value}get textLabel(){return this._labelText}get iconLabel(){return this._labelIcon}set open(e){if(this.open!==e)if(e){if(!this.numChildren)return;this.class.add(Tr),this.emit("open",this)}else this.class.remove(Tr),this.emit("close",this)}get open(){return this.class.contains(Tr)||this.parent===this._treeView}set parentsOpen(e){let t=this.parent;for(;t&&t instanceof Mr;)t.open=e,t=t.parent}get parentsOpen(){let e=this.parent;for(;e&&e instanceof Mr;){if(!e.open)return!1;e=e.parent}return!0}set allowDrop(e){this._allowDrop=e}get allowDrop(){return this._allowDrop}set allowDrag(e){this._allowDrag=e}get allowDrag(){return this._allowDrag}set allowSelect(e){this._allowSelect=e}get allowSelect(){return this._allowSelect}set treeView(e){this._treeView=e}get treeView(){return this._treeView}get numChildren(){return this._numChildren}get firstChild(){if(this._numChildren)for(const e of this.dom.childNodes)if(e.ui instanceof Mr)return e.ui;return null}get lastChild(){if(this._numChildren)for(let e=this.dom.childNodes.length-1;e>=0;e--)if(this.dom.childNodes[e].ui instanceof Mr)return this.dom.childNodes[e].ui;return null}get nextSibling(){let e=this.dom.nextSibling;for(;e&&!(e.ui instanceof Mr);)e=e.nextSibling;return e&&e.ui}get previousSibling(){let e=this.dom.previousSibling;for(;e&&!(e.ui instanceof Mr);)e=e.previousSibling;return e&&e.ui}set icon(e){this._icon!==e&&e.match(/^E[0-9]{0,4}$/)&&(this._icon=e,e?this._labelIcon.dom.setAttribute("data-icon",String.fromCodePoint(parseInt(e,16))):this._labelIcon.dom.removeAttribute("data-icon"))}get icon(){return this._icon}}Mr.EVENT_SELECT="select",Mr.EVENT_DESELECT="deselect",Mr.EVENT_OPEN="open",Mr.EVENT_CLOSE="close";var Lr=Mr;const Dr="pcui-treeview",kr=Dr+"-item-dragged",Ir=Dr+"-drag-handle",Rr=Dr+"-filtering",Or=Rr+"-result",zr="inside",Fr="before",Vr="after";class Nr extends Bt{constructor(e={}){var t,s,i;super(e),this._selectedItems=[],this._dragItems=[],this._dragging=!1,this._dragOverItem=null,this._dragArea=zr,this._dragScroll=0,this._dragScrollInterval=null,this._pressedCtrl=!1,this._pressedShift=!1,this._filter=null,this._filterResults=[],this._updateModifierKeys=e=>{this._pressedCtrl=e.ctrlKey||e.metaKey,this._pressedShift=e.shiftKey},this._onMouseLeave=e=>{this._allowDrag&&this._dragging&&(this._dragOverItem=null,this._updateDragHandle())},this._onMouseMove=e=>{if(!this._dragging)return;const t=this.dom.getBoundingClientRect();this._dragScroll=0;let s=t.top,i=t.bottom;if(this._dragScrollElement!==this){const e=this._dragScrollElement.dom.getBoundingClientRect();s=Math.max(s+this._dragScrollElement.dom.scrollTop,e.top),i=Math.min(i+this._dragScrollElement.dom.scrollTop,e.bottom)}s=Math.max(0,s),i=Math.min(i,document.body.clientHeight),e.pageY<s+32&&this._dragScrollElement.dom.scrollTop>0?this._dragScroll=-1:e.pageY>i-32&&this._dragScrollElement.dom.scrollHeight>this._dragScrollElement.height+this._dragScrollElement.dom.scrollTop&&(this._dragScroll=1)},this._onDragMove=e=>{if(e.preventDefault(),e.stopPropagation(),!this._allowDrag||!this._dragOverItem)return;const t=this._dragHandle.dom.getBoundingClientRect(),s=Math.floor((e.clientY-t.top)/t.height*5),i=this._dragArea,n=this._dragOverItem;if(this._dragOverItem.parent===this){let e=!1;for(let t=0;t<this._dragItems.length;t++)if(this._dragItems[t].parent===this._dragOverItem){e=!0,this._dragOverItem=null;break}e||(this._dragArea=zr)}else{let e=!1;for(let t=0;t<this._dragItems.length;t++)if(this._dragItems[t].dom.contains(this._dragOverItem.dom)){e=!0;break}if(e)this._dragOverItem=null;else if(this._allowReordering&&s<=1&&-1===this._dragItems.indexOf(this._dragOverItem.previousSibling))this._dragArea=Fr;else if(this._allowReordering&&s>=4&&-1===this._dragItems.indexOf(this._dragOverItem.nextSibling)&&(0===this._dragOverItem.numChildren||!this._dragOverItem.open))this._dragArea=Vr;else{let e=!1;if(this._allowReordering&&this._dragOverItem.open)for(let t=0;t<this._dragItems.length;t++)if(this._dragItems[t].parent===this._dragOverItem){e=!0,this._dragArea=Fr;break}e||(this._dragArea=zr)}}i===this._dragArea&&n===this._dragOverItem||this._updateDragHandle()},this.class.add(Dr),this._allowDrag=null===(t=e.allowDrag)||void 0===t||t,this._allowReordering=null===(s=e.allowReordering)||void 0===s||s,this._allowRenaming=null!==(i=e.allowRenaming)&&void 0!==i&&i,this._dragHandle=new It({class:Ir}),this._dragScrollElement=e.dragScrollElement||this,this.append(this._dragHandle),this._onContextMenu=e.onContextMenu,this._onReparentFn=e.onReparent,this._wasDraggingAllowedBeforeFiltering=this._allowDrag,window.addEventListener("keydown",this._updateModifierKeys),window.addEventListener("keyup",this._updateModifierKeys),window.addEventListener("mousedown",this._updateModifierKeys),this.dom.addEventListener("mouseleave",this._onMouseLeave),this._dragHandle.dom.addEventListener("mousemove",this._onDragMove),this._dragHandle.on("destroy",(e=>{e.removeEventListener("mousemove",this._onDragMove)}))}destroy(){this._destroyed||(window.removeEventListener("keydown",this._updateModifierKeys),window.removeEventListener("keyup",this._updateModifierKeys),window.removeEventListener("mousedown",this._updateModifierKeys),window.removeEventListener("mousemove",this._onMouseMove),this.dom.removeEventListener("mouseleave",this._onMouseLeave),this._dragScrollInterval&&(window.clearInterval(this._dragScrollInterval),this._dragScrollInterval=null),super.destroy())}_findNextVisibleTreeItem(e){if(e.numChildren>0&&e.open)return e.firstChild;const t=e.nextSibling;if(t)return t;let s=e.parent;if(!(s instanceof Lr))return null;let i=s.nextSibling;for(;!i&&(s=s.parent,s instanceof Lr);)i=s.nextSibling;return i}_findLastVisibleChildTreeItem(e){if(!e.numChildren||!e.open)return null;let t=e.lastChild;for(;t&&t.numChildren&&t.open;)t=t.lastChild;return t}_findPreviousVisibleTreeItem(e){const t=e.previousSibling;if(t)return t.numChildren>0&&t.open?this._findLastVisibleChildTreeItem(t):t;const s=e.parent;return s instanceof Lr?s:null}_getChildrenRange(e,t){const s=[];if(this._filterResults.length){const i=this.dom.querySelectorAll(`.${Dr}-item.${Or}`);let n=-1,r=-1;for(let a=0;a<i.length;a++){const o=i[a].ui;if(o===e?n=a:o===t&&(r=a),-1!==n&&-1!==r){const e=n<r?r:n;for(let t=n<r?n:r;t<=e;t++)s.push(i[t].ui);break}}}else{let i=e;const n=e.dom.getBoundingClientRect(),r=t.dom.getBoundingClientRect();if(n.top<r.top)for(;i&&i!==t;)i=this._findNextVisibleTreeItem(i),i&&i!==t&&s.push(i);else for(;i&&i!==t;)i=this._findPreviousVisibleTreeItem(i),i&&i!==t&&s.push(i);s.push(t)}return s}_onAppendChild(e){super._onAppendChild(e),e instanceof Lr&&this._onAppendTreeViewItem(e)}_onRemoveChild(e){e instanceof Lr&&this._onRemoveTreeViewItem(e),super._onRemoveChild(e)}_onAppendTreeViewItem(e){e.treeView=this,this._filter&&this._searchItems([[e.text,e]],this._filter),e.forEachChild((e=>{e instanceof Lr&&this._onAppendTreeViewItem(e)}))}_onRemoveTreeViewItem(e){e.selected=!1,e.forEachChild((e=>{e instanceof Lr&&this._onRemoveTreeViewItem(e)}))}_onChildKeyDown(e,t){if(-1!==["Tab","ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].indexOf(e.key))if(e.preventDefault(),e.stopPropagation(),"ArrowDown"===e.key){if(this._selectedItems.length){const e=this._findNextVisibleTreeItem(t);e&&(this._pressedShift||this._pressedCtrl?e.selected=!0:this._selectSingleItem(e))}}else if("ArrowUp"===e.key){if(this._selectedItems.length){const e=this._findPreviousVisibleTreeItem(t);e&&(this._pressedShift||this._pressedCtrl?e.selected=!0:this._selectSingleItem(e))}}else"ArrowLeft"===e.key?t.parent!==this&&(t.open=!1):"ArrowRight"===e.key&&(t.open=!0)}_onChildClick(e,t){if(0===e.button&&t.allowSelect)if(this._pressedCtrl)t.selected=!t.selected;else if(this._pressedShift){if(!this._selectedItems.length||1===this._selectedItems.length&&this._selectedItems[0]===t)return void(t.selected=!0);const e=this._selectedItems[this._selectedItems.length-1];this._openHierarchy(e);this._getChildrenRange(e,t).forEach((e=>{e.allowSelect&&(e.selected=!0)}))}else this._selectSingleItem(t)}_traverseDepthFirst(e){function t(s){if(s&&s instanceof Lr&&(e(s),s.numChildren))for(const e of s.dom.childNodes)t(e.ui)}for(const e of this.dom.childNodes)t(e.ui)}_getTreeOrder(){const e=new Map;let t=0;return this._traverseDepthFirst((s=>{e.set(s,t++)})),e}_getChildIndex(e,t){return Array.prototype.indexOf.call(t.dom.childNodes,e.dom)-1}_onChildDragStart(e,t){if(this.allowDrag&&!this._dragging){if(this._dragItems=[],-1!==this._selectedItems.indexOf(t)){const e=[];let t=-1;for(let s=0;s<this._selectedItems.length;s++){let i=this._selectedItems[s].parent,n=0,r=!1;for(;i&&i instanceof Lr;){if(-1!==this._selectedItems.indexOf(i)){r=!0;break}n++,i=i.parent}if(!r){if(-1===t)t=n;else if(t!==n)return;e.push(this._selectedItems[s])}}this._dragItems=e}else t.class.add(kr),this._dragItems.push(t);this._dragItems.length&&(this._dragItems.forEach((e=>{e.class.add(kr)})),this.isDragging=!0,this.emit("dragstart",this._dragItems.slice()))}}_onChildDragEnd(e,t){if(!this.allowDrag||!this._dragging)return;this._dragItems.forEach((e=>e.class.remove(kr)));let s=!1;for(let e=0;e<this._dragItems.length;e++)if(this._dragItems[e].parent===this){s=!0;break}if(!s&&this._dragOverItem){if(this._dragItems.length>1){const e=this._getTreeOrder();this._dragItems.sort(((t,s)=>e.get(t)-e.get(s)))}if(this._dragItems.length){const e=[];if(this._onReparentFn){const t=[],s=e=>{let s=t.findIndex((t=>t.parent===e));return-1===s&&(t.push({parent:e,children:[...e.dom.childNodes]}),s=t.length-1),t[s].children};this._dragItems.forEach((t=>{if(t.parent===this._dragOverItem&&this._dragArea===zr)return;e.push({item:t,oldParent:t.parent});const i=s(t.parent),n=i.indexOf(t.dom);i.splice(n,1)})),e.forEach(((t,i)=>{if(this._dragArea===Fr){t.newParent=this._dragOverItem.parent;const e=s(this._dragOverItem.parent),i=e.indexOf(this._dragOverItem.dom);e.splice(i,0,t.item.dom),t.newChildIndex=i}else if(this._dragArea===zr){t.newParent=this._dragOverItem;const e=s(this._dragOverItem);e.push(t.item.dom),t.newChildIndex=e.length-1}else if(this._dragArea===Vr){t.newParent=this._dragOverItem.parent;const n=s(this._dragOverItem.parent),r=i>0?e[i-1].item:this._dragOverItem,a=n.indexOf(r.dom);n.splice(a+1,0,t.item.dom),t.newChildIndex=a+1}t.newChildIndex--}))}else this._dragItems.forEach((t=>{t.parent===this._dragOverItem&&this._dragArea===zr||(e.push({item:t,oldParent:t.parent}),t.parent.remove(t))})),e.forEach(((t,s)=>{this._dragArea===Fr?(t.newParent=this._dragOverItem.parent,t.newParent.appendBefore(t.item,this._dragOverItem),t.newChildIndex=this._getChildIndex(t.item,t.newParent)):this._dragArea===zr?(t.newParent=this._dragOverItem,t.newParent.append(t.item),t.newParent.open=!0,t.newChildIndex=this._getChildIndex(t.item,t.newParent)):this._dragArea===Vr&&(t.newParent=this._dragOverItem.parent,t.newParent.appendAfter(t.item,s>0?e[s-1].item:this._dragOverItem),t.newChildIndex=this._getChildIndex(t.item,t.newParent))}));e.length&&(this._onReparentFn&&this._onReparentFn(e),this.emit("reparent",e))}}this._dragItems=[],this.isDragging=!1,this.emit("dragend")}_onChildDragOver(e,t){this._allowDrag&&this._dragging&&(t.allowDrop&&-1===this._dragItems.indexOf(t)?this._dragOverItem=t:this._dragOverItem=null,this._updateDragHandle(),this._onDragMove(e))}_scrollWhileDragging(){this._dragging&&0!==this._dragScroll&&(this._dragScrollElement.dom.scrollTop+=8*this._dragScroll,this._dragOverItem=null,this._updateDragHandle())}_updateDragHandle(e,t){if(t||this._allowDrag&&this._dragging)if(e||(e=this._dragOverItem),e&&!e.hidden&&e.parentsOpen){const t=e._containerContents.dom.getBoundingClientRect();this._dragHandle.hidden=!1,this._dragHandle.class.remove(Vr,Fr,zr),this._dragHandle.class.add(this._dragArea);const s=t.top;let i=t.left,n=t.width;if(this.dom.parentElement){const e=this.dom.parentElement.getBoundingClientRect();i=Math.max(i,e.left),n=Math.min(n,this.dom.parentElement.clientWidth-i+e.left)}this._dragHandle.style.top=s+"px",this._dragHandle.style.left=i+"px",this._dragHandle.style.width=n-7+"px"}else this._dragHandle.hidden=!0}_openHierarchy(e){e.parentsOpen=!0}_selectSingleItem(e){let t=this._selectedItems.length,s=!1;for(;t--;)this._selectedItems[t]&&this._selectedItems[t]!==e&&(this._selectedItems[t].selected=!1,s=!0);e.selected=!!s||!e.selected}_onChildSelected(e){this._selectedItems.push(e),this._openHierarchy(e),this.emit("select",e)}_onChildDeselected(e){const t=this._selectedItems.indexOf(e);-1!==t&&(this._selectedItems.splice(t,1),this.emit("deselect",e))}_onChildRename(e,t){if(this._filter){e.class.remove(Or);const t=this._filterResults.indexOf(e);-1!==t&&this._filterResults.splice(t,1),this._searchItems([[e.text,e]],this._filter)}this.emit("rename",e,t)}_searchItems(e,t){const s=ci(e,t);s.length&&s.forEach((e=>{this._filterResults.push(e),e.class.add(Or)}))}_applyFilter(e){this._clearFilter(),this._wasDraggingAllowedBeforeFiltering=this._allowDrag,this._allowDrag=!1,this.class.add(Rr);const t=[];this._traverseDepthFirst((e=>{t.push([e.text,e])})),this._searchItems(t,e)}_clearFilter(){this._filterResults.forEach((e=>{e.destroyed||e.class.remove(Or)})),this._filterResults.length=0,this.class.remove(Rr),this._allowDrag=this._wasDraggingAllowedBeforeFiltering}showDragHandle(e){this._updateDragHandle(e,!0)}deselect(){let e=this._selectedItems.length;for(;e--;)this._selectedItems[e]&&(this._selectedItems[e].selected=!1)}clearTreeItems(){let e=this.dom.childNodes.length;for(;e--;){const t=this.dom.childNodes[e];if(!t)continue;const s=t.ui;s instanceof Lr&&s.destroy()}this._selectedItems=[],this._dragItems=[],this._allowDrag=this._wasDraggingAllowedBeforeFiltering}set allowDrag(e){this._allowDrag=e,this._filter&&(this._wasDraggingAllowedBeforeFiltering=e)}get allowDrag(){return this._allowDrag}set allowReordering(e){this._allowReordering=e}get allowReordering(){return this._allowReordering}set allowRenaming(e){this._allowRenaming=e}get allowRenaming(){return this._allowRenaming}set isDragging(e){this._dragging!==e&&(e?(this._dragging=!0,this._updateDragHandle(),(this.scrollable||this._dragScrollElement!==this)&&(window.removeEventListener("mousemove",this._onMouseMove),window.addEventListener("mousemove",this._onMouseMove),this._dragScrollInterval||(this._dragScrollInterval=window.setInterval((()=>{this._scrollWhileDragging()}),1e3/60)))):(this._dragOverItem=null,this._updateDragHandle(),this._dragging=!1,window.removeEventListener("mousemove",this._onMouseMove),this._dragScrollInterval&&(window.clearInterval(this._dragScrollInterval),this._dragScrollInterval=null)))}get isDragging(){return this._dragging}get selected(){return this._selectedItems.slice()}set filter(e){this._filter!==e&&(this._filter=e,e?this._applyFilter(e):this._clearFilter())}get filter(){return this._filter}get pressedCtrl(){return this._pressedCtrl}get pressedShift(){return this._pressedShift}}Nr.EVENT_DRAGSTART="dragstart",Nr.EVENT_DRAGEND="dragend",Nr.EVENT_REPARENT="reparent",Nr.EVENT_SELECT="select",Nr.EVENT_DESELECT="deselect",Nr.EVENT_RENAME="rename";var Br=Nr;class Ur extends gs{constructor(e){super(e),this.element=new Br(Object.assign({},e)),this.loadChildren(this.props.children,this.element)}loadChildren(e,t){e&&(Array.isArray(e)||(e=[e]),e.forEach((e=>{const s=new Lr({text:e.props.text,icon:e.props.icon,open:!1});e.props.onSelect&&s.on("select",e.props.onSelect),e.props.onDeselect&&s.on("deselect",e.props.onDeselect),t.append(s),this.loadChildren(e.props.children,s)})))}componentDidUpdate(){this.parentElement.removeChild(this.element.dom),this.element=new Br(Object.assign({},this.props)),this.loadChildren(this.props.children,this.element),this.parentElement.appendChild(this.element.dom)}parentElementRendered(e){e&&(this.parentElement=e,this.parentElement.appendChild(this.element.dom))}render(){return n.exports.createElement("div",{ref:this.parentElementRendered.bind(this)})}}Ur.ctor=Br;var Hr=Ur;class Wr extends gs{constructor(e){super(e),this.elementClass=Lr,this.onSelect=()=>{e.onSelect&&e.onSelect((()=>{this.element.selected=!1}))},e.onDeselect&&(this.onDeselect=e.onDeselect),this.onAttach=this.onAttachFn.bind(this)}onAttachFn(){this.props.onSelect&&this.element.on("select",this.onSelect),this.props.onDeselect&&this.element.on("deselect",this.onDeselect)}render(){return super.render()}}Wr.ctor=Lr;var Gr=Wr;class jr extends It{constructor(e={}){var t,s,i;const n=Object.assign({},e);delete n.binding,super(n),this._inputs=[],this._applyingChange=!1,this.class.add("pcui-vector-input");const r=Math.max(2,Math.min(4,null!==(t=e.dimensions)&&void 0!==t?t:3));for(let t=0;t<r;t++){const n=new os({min:e.min,max:e.max,precision:null!==(s=e.precision)&&void 0!==s?s:7,step:null!==(i=e.step)&&void 0!==i?i:1,stepPrecision:e.stepPrecision,renderChanges:e.renderChanges,placeholder:e.placeholder?Array.isArray(e.placeholder)?e.placeholder[t]:e.placeholder:null});n.on("change",(()=>{this._onInputChange()})),n.on("focus",(()=>{this.emit("focus")})),n.on("blur",(()=>{this.emit("blur")})),this.dom.appendChild(n.dom),n.parent=this,this._inputs.push(n)}e.binding&&(this.binding=e.binding),void 0!==e.value&&(this.value=e.value)}_onInputChange(){if(this._applyingChange)return;this._inputs.some((e=>e.class.contains(Ct)))?this.class.add(Ct):this.class.remove(Ct),this.emit("change",this.value)}_updateValue(e){return this.class.remove(Ct),JSON.stringify(this.value)!==JSON.stringify(e)&&(this._applyingChange=!0,this._inputs.forEach(((t,s)=>{const i=t.binding;let n=!1;i&&(n=i.applyingChange,i.applyingChange=!0),t.value=e&&void 0!==e[s]?e[s]:null,i&&(i.applyingChange=n)})),this.emit("change",this.value),this._applyingChange=!1,!0)}link(e,t){super.link(e,t),e=Array.isArray(e)?e:[e];if(1===(t=Array.isArray(t)?t:[t]).length||e.length!==t.length)for(let s=0;s<this._inputs.length;s++)this._inputs[s].link(e,t[0]+`.${s}`);else for(let s=0;s<this._inputs.length;s++)this._inputs[s].link(e,t.map((e=>`${e}.${s}`)))}unlink(){super.unlink();for(const e of this._inputs)e.unlink()}focus(){this._inputs[0].focus()}blur(){for(const e of this._inputs)e.blur()}set value(e){if("string"==typeof e)try{if(e=JSON.parse(e),Array.isArray(e)&&e.some((e=>!Number.isFinite(e))))throw new Error("VectorInput value set to string which doesn't contain an array of numbers")}catch(t){console.error(t),e=[]}Array.isArray(e)||(e=[]);this._updateValue(e)&&this._binding&&this._binding.setValue(e)}get value(){return this._inputs.map((e=>e.value))}set values(e){e=this._inputs.map(((t,s)=>e.map((e=>e?e[s]:void 0)))),this._inputs.forEach(((t,s)=>{t.values=e[s]}))}set binding(e){super.binding=e;for(const t of this._inputs)t.binding=e?e.clone():null}get binding(){return super.binding}set placeholder(e){for(let t=0;t<this._inputs.length;t++)this._inputs[t].placeholder=e[t]||e||null}get placeholder(){return this._inputs.map((e=>e.placeholder))}get inputs(){return this._inputs.slice()}set renderChanges(e){for(const t of this._inputs)t.renderChanges=e}get renderChanges(){return this._inputs[0].renderChanges}set min(e){for(const t of this._inputs)t.min=e}get min(){return this._inputs[0].min}set max(e){for(const t of this._inputs)t.max=e}get max(){return this._inputs[0].max}set precision(e){for(const t of this._inputs)t.precision=e}get precision(){return this._inputs[0].precision}set step(e){for(const t of this._inputs)t.step=e}get step(){return this._inputs[0].step}}It.register("vec2",jr,{dimensions:2,renderChanges:!0}),It.register("vec3",jr,{dimensions:3,renderChanges:!0}),It.register("vec4",jr,{dimensions:4,renderChanges:!0});var qr=jr;class Kr extends gs{constructor(e){super(e),this.elementClass=qr}render(){return super.render()}}Kr.ctor=qr;var Xr=Kr;var Yr=Object.freeze({__proto__:null,revision:"6c69a4b",version:"4.1.1",BindingBase:rt,BindingElementToObservers:ot,BindingObserversToElement:ht,BindingTwoWay:dt,ArrayInput:ys,BooleanInput:As,Button:Ps,Canvas:ks,Code:Vs,ColorPicker:Js,Container:ti,Divider:ri,Element:gs,GradientPicker:ji,GridView:an,GridViewItem:ln,InfoBox:un,Label:mn,LabelGroup:bn,Menu:Dn,NumericInput:In,Overlay:On,Panel:Fn,Progress:Wn,RadioButton:jn,SelectInput:Xn,SliderInput:nr,Spinner:lr,TextAreaInput:vr,TextInput:br,TreeView:Hr,TreeViewItem:Gr,VectorInput:Xr});function Zr(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function $r(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}function Qr(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?$r(Object(s),!0).forEach((function(t){Zr(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):$r(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}function Jr(e,t){if(null==e)return{};var s,i,n=function(e,t){if(null==e)return{};var s,i,n={},r=Object.keys(e);for(i=0;i<r.length;i++)s=r[i],t.indexOf(s)>=0||(n[s]=e[s]);return n}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)s=r[i],t.indexOf(s)>=0||Object.prototype.propertyIsEnumerable.call(e,s)&&(n[s]=e[s])}return n}function ea(e,t){(null==t||t>e.length)&&(t=e.length);for(var s=0,i=new Array(t);s<t;s++)i[s]=e[s];return i}function ta(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function sa(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}function ia(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?sa(Object(s),!0).forEach((function(t){ta(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):sa(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}function na(e){return function t(){for(var s=this,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return n.length>=e.length?e.apply(this,n):function(){for(var e=arguments.length,i=new Array(e),r=0;r<e;r++)i[r]=arguments[r];return t.apply(s,[].concat(n,i))}}}function ra(e){return{}.toString.call(e).includes("Object")}function aa(e){return"function"==typeof e}var oa=na((function(e,t){throw new Error(e[t]||e.default)}))({initialIsRequired:"initial state is required",initialType:"initial state should be an object",initialContent:"initial state shouldn't be an empty object",handlerType:"handler should be an object or a function",handlersType:"all handlers should be a functions",selectorType:"selector should be a function",changeType:"provided value of changes should be an object",changeField:'it seams you want to change a field in the state which is not specified in the "initial" state',default:"an unknown error accured in `state-local` package"}),la={changes:function(e,t){return ra(t)||oa("changeType"),Object.keys(t).some((function(t){return s=e,i=t,!Object.prototype.hasOwnProperty.call(s,i);var s,i}))&&oa("changeField"),t},selector:function(e){aa(e)||oa("selectorType")},handler:function(e){aa(e)||ra(e)||oa("handlerType"),ra(e)&&Object.values(e).some((function(e){return!aa(e)}))&&oa("handlersType")},initial:function(e){var t;e||oa("initialIsRequired"),ra(e)||oa("initialType"),t=e,Object.keys(t).length||oa("initialContent")}};function ha(e,t){return aa(t)?t(e.current):t}function ca(e,t){return e.current=ia(ia({},e.current),t),t}function da(e,t,s){return aa(t)?t(e.current):Object.keys(s).forEach((function(s){var i;return null===(i=t[s])||void 0===i?void 0:i.call(t,e.current[s])})),s}var ua={create:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};la.initial(e),la.handler(t);var s={current:e},i=na(da)(s,t),n=na(ca)(s),r=na(la.changes)(e),a=na(ha)(s);return[function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(e){return e};return la.selector(e),e(s.current)},function(e){!function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return function(e){return t.reduceRight((function(e,t){return t(e)}),e)}}(i,n,r,a)(e)}]}};var pa,ma={configIsRequired:"the configuration object is required",configType:"the configuration object should be an object",default:"an unknown error accured in `@monaco-editor/loader` package",deprecation:"Deprecation warning!\n    You are using deprecated way of configuration.\n\n    Instead of using\n      monaco.config({ urls: { monacoBase: '...' } })\n    use\n      monaco.config({ paths: { vs: '...' } })\n\n    For more please check the link https://github.com/suren-atoyan/monaco-loader#config\n  "},_a=(pa=function(e,t){throw new Error(e[t]||e.default)},function e(){for(var t=this,s=arguments.length,i=new Array(s),n=0;n<s;n++)i[n]=arguments[n];return i.length>=pa.length?pa.apply(this,i):function(){for(var s=arguments.length,n=new Array(s),r=0;r<s;r++)n[r]=arguments[r];return e.apply(t,[].concat(i,n))}})(ma),fa={config:function(e){var t;return e||_a("configIsRequired"),t=e,{}.toString.call(t).includes("Object")||_a("configType"),e.urls?(console.warn(ma.deprecation),{paths:{vs:e.urls.monacoBase}}):e}};function ga(e,t){return Object.keys(t).forEach((function(s){t[s]instanceof Object&&e[s]&&Object.assign(t[s],ga(e[s],t[s]))})),Qr(Qr({},e),t)}var va={type:"cancelation",msg:"operation is manually canceled"};function ya(e){var t=!1,s=new Promise((function(s,i){e.then((function(e){return t?i(va):s(e)})),e.catch(i)}));return s.cancel=function(){return t=!0},s}var ba,xa,wa=ua.create({config:{paths:{vs:"https://cdn.jsdelivr.net/npm/monaco-editor@0.36.1/min/vs"}},isInitialized:!1,resolve:null,reject:null,monaco:null}),Sa=(xa=2,function(e){if(Array.isArray(e))return e}(ba=wa)||function(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var s=[],i=!0,n=!1,r=void 0;try{for(var a,o=e[Symbol.iterator]();!(i=(a=o.next()).done)&&(s.push(a.value),!t||s.length!==t);i=!0);}catch(e){n=!0,r=e}finally{try{i||null==o.return||o.return()}finally{if(n)throw r}}return s}}(ba,xa)||function(e,t){if(e){if("string"==typeof e)return ea(e,t);var s=Object.prototype.toString.call(e).slice(8,-1);return"Object"===s&&e.constructor&&(s=e.constructor.name),"Map"===s||"Set"===s?Array.from(e):"Arguments"===s||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(s)?ea(e,t):void 0}}(ba,xa)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),Ca=Sa[0],Ta=Sa[1];function Aa(e){return document.body.appendChild(e)}function Ea(e){var t=Ca((function(e){return{config:e.config,reject:e.reject}})),s=function(e){var t=document.createElement("script");return e&&(t.src=e),t}("".concat(t.config.paths.vs,"/loader.js"));return s.onload=function(){return e()},s.onerror=t.reject,s}function Pa(){var e=Ca((function(e){return{config:e.config,resolve:e.resolve,reject:e.reject}})),t=window.require;t.config(e.config),t(["vs/editor/editor.main"],(function(t){Ma(t),e.resolve(t)}),(function(t){e.reject(t)}))}function Ma(e){Ca().monaco||Ta({monaco:e})}var La=new Promise((function(e,t){return Ta({resolve:e,reject:t})})),Da={config:function(e){var t=fa.config(e),s=t.monaco,i=Jr(t,["monaco"]);Ta((function(e){return{config:ga(e.config,i),monaco:s}}))},init:function(){var e=Ca((function(e){return{monaco:e.monaco,isInitialized:e.isInitialized,resolve:e.resolve}}));if(!e.isInitialized){if(Ta({isInitialized:!0}),e.monaco)return e.resolve(e.monaco),ya(La);if(window.monaco&&window.monaco.editor)return Ma(window.monaco),e.resolve(window.monaco),ya(La);!function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return function(e){return t.reduceRight((function(e,t){return t(e)}),e)}}(Aa,Ea)(Pa)}return ya(La)},__getMonacoInstance:function(){return Ca((function(e){return e.monaco}))}},ka={wrapper:{display:"flex",position:"relative",textAlign:"initial"},fullWidth:{width:"100%"},hide:{display:"none"}},Ia={container:{display:"flex",height:"100%",width:"100%",justifyContent:"center",alignItems:"center"}};var Ra=function({children:e}){return d.createElement("div",{style:Ia.container},e)};var Oa=function({width:e,height:t,isEditorReady:s,loading:i,_ref:n,className:r,wrapperProps:a}){return d.createElement("section",{style:{...ka.wrapper,width:e,height:t},...a},!s&&d.createElement(Ra,null,i),d.createElement("div",{ref:n,style:{...ka.fullWidth,...!s&&ka.hide},className:r}))},za=n.exports.memo(Oa);var Fa=function(e){n.exports.useEffect(e,[])};var Va=function(e,t,s=!0){let i=n.exports.useRef(!0);n.exports.useEffect(i.current||!s?()=>{i.current=!1}:e,t)};function Na(){}function Ba(e,t,s,i){return function(e,t){return e.editor.getModel(Ua(e,t))}(e,i)||function(e,t,s,i){return e.editor.createModel(t,s,i?Ua(e,i):void 0)}(e,t,s,i)}function Ua(e,t){return e.Uri.parse(t)}var Ha=function({original:e,modified:t,language:s,originalLanguage:i,modifiedLanguage:r,originalModelPath:a,modifiedModelPath:o,keepCurrentOriginalModel:l=!1,keepCurrentModifiedModel:h=!1,theme:c="light",loading:u="Loading...",options:p={},height:m="100%",width:_="100%",className:f,wrapperProps:g={},beforeMount:v=Na,onMount:y=Na}){let[b,x]=n.exports.useState(!1),[w,S]=n.exports.useState(!0),C=n.exports.useRef(null),T=n.exports.useRef(null),A=n.exports.useRef(null),E=n.exports.useRef(y),P=n.exports.useRef(v),M=n.exports.useRef(!1);Fa((()=>{let e=Da.init();return e.then((e=>(T.current=e)&&S(!1))).catch((e=>"cancelation"!==e?.type&&console.error("Monaco initialization: error:",e))),()=>C.current?function(){let e=C.current?.getModel();l||e?.original?.dispose(),h||e?.modified?.dispose(),C.current?.dispose()}():e.cancel()})),Va((()=>{let e=C.current.getModifiedEditor();e.getOption(T.current.editor.EditorOption.readOnly)?e.setValue(t||""):t!==e.getValue()&&(e.executeEdits("",[{range:e.getModel().getFullModelRange(),text:t||"",forceMoveMarkers:!0}]),e.pushUndoStop())}),[t],b),Va((()=>{C.current?.getModel()?.original.setValue(e||"")}),[e],b),Va((()=>{let{original:e,modified:t}=C.current.getModel();T.current.editor.setModelLanguage(e,i||s||"text"),T.current.editor.setModelLanguage(t,r||s||"text")}),[s,i,r],b),Va((()=>{T.current?.editor.setTheme(c)}),[c],b),Va((()=>{C.current?.updateOptions(p)}),[p],b);let L=n.exports.useCallback((()=>{if(!T.current)return;P.current(T.current);let n=Ba(T.current,e||"",i||s||"text",a||""),l=Ba(T.current,t||"",r||s||"text",o||"");C.current?.setModel({original:n,modified:l})}),[s,t,r,e,i,a,o]),D=n.exports.useCallback((()=>{!M.current&&A.current&&(C.current=T.current.editor.createDiffEditor(A.current,{automaticLayout:!0,...p}),L(),T.current?.editor.setTheme(c),x(!0),M.current=!0)}),[p,c,L]);return n.exports.useEffect((()=>{b&&E.current(C.current,T.current)}),[b]),n.exports.useEffect((()=>{!w&&!b&&D()}),[w,b,D]),Va((()=>{if(C.current&&T.current){let t=C.current.getOriginalEditor(),n=Ba(T.current,e||"",i||s||"text",a||"");n!==t.getModel()&&t.setModel(n)}}),[a],b),Va((()=>{if(C.current&&T.current){let e=C.current.getModifiedEditor(),i=Ba(T.current,t||"",r||s||"text",o||"");i!==e.getModel()&&e.setModel(i)}}),[o],b),d.createElement(za,{width:_,height:m,isEditorReady:b,loading:u,_ref:A,className:f,wrapperProps:g})};n.exports.memo(Ha);var Wa=function(e){let t=n.exports.useRef();return n.exports.useEffect((()=>{t.current=e}),[e]),t.current},Ga=new Map;var ja=function({defaultValue:e,defaultLanguage:t,defaultPath:s,value:i,language:r,path:a,theme:o="light",line:l,loading:h="Loading...",options:c={},overrideServices:u={},saveViewState:p=!0,keepCurrentModel:m=!1,width:_="100%",height:f="100%",className:g,wrapperProps:v={},beforeMount:y=Na,onMount:b=Na,onChange:x,onValidate:w=Na}){let[S,C]=n.exports.useState(!1),[T,A]=n.exports.useState(!0),E=n.exports.useRef(null),P=n.exports.useRef(null),M=n.exports.useRef(null),L=n.exports.useRef(b),D=n.exports.useRef(y),k=n.exports.useRef(),I=n.exports.useRef(i),R=Wa(a),O=n.exports.useRef(!1),z=n.exports.useRef(!1);Fa((()=>{let e=Da.init();return e.then((e=>(E.current=e)&&A(!1))).catch((e=>"cancelation"!==e?.type&&console.error("Monaco initialization: error:",e))),()=>P.current?(k.current?.dispose(),m?p&&Ga.set(a,P.current.saveViewState()):P.current.getModel()?.dispose(),void P.current.dispose()):e.cancel()})),Va((()=>{let n=Ba(E.current,e||i||"",t||r||"",a||s||"");n!==P.current?.getModel()&&(p&&Ga.set(R,P.current?.saveViewState()),P.current?.setModel(n),p&&P.current?.restoreViewState(Ga.get(a)))}),[a],S),Va((()=>{P.current?.updateOptions(c)}),[c],S),Va((()=>{!P.current||void 0===i||(P.current.getOption(E.current.editor.EditorOption.readOnly)?P.current.setValue(i):i!==P.current.getValue()&&(z.current=!0,P.current.executeEdits("",[{range:P.current.getModel().getFullModelRange(),text:i,forceMoveMarkers:!0}]),P.current.pushUndoStop(),z.current=!1))}),[i],S),Va((()=>{let e=P.current?.getModel();e&&r&&E.current?.editor.setModelLanguage(e,r)}),[r],S),Va((()=>{void 0!==l&&P.current?.revealLine(l)}),[l],S),Va((()=>{E.current?.editor.setTheme(o)}),[o],S);let F=n.exports.useCallback((()=>{if(M.current&&E.current&&!O.current){D.current(E.current);let n=a||s,l=Ba(E.current,i||e||"",t||r||"",n||"");P.current=E.current?.editor.create(M.current,{model:l,automaticLayout:!0,...c},u),p&&P.current.restoreViewState(Ga.get(n)),E.current.editor.setTheme(o),C(!0),O.current=!0}}),[e,t,s,i,r,a,c,u,p,o]);return n.exports.useEffect((()=>{S&&L.current(P.current,E.current)}),[S]),n.exports.useEffect((()=>{!T&&!S&&F()}),[T,S,F]),I.current=i,n.exports.useEffect((()=>{S&&x&&(k.current?.dispose(),k.current=P.current?.onDidChangeModelContent((e=>{z.current||x(P.current.getValue(),e)})))}),[S,x]),n.exports.useEffect((()=>{if(S){let e=E.current.editor.onDidChangeMarkers((e=>{let t=P.current.getModel()?.uri;if(t&&e.find((e=>e.path===t.path))){let e=E.current.editor.getModelMarkers({resource:t});w?.(e)}}));return()=>{e?.dispose()}}return()=>{}}),[S,w]),d.createElement(za,{width:_,height:f,isEditorReady:S,loading:h,_ref:M,className:g,wrapperProps:v})},qa=n.exports.memo(ja);const Ka="undefined"!=typeof location?location.href:"",Xa=new URL(Ka).pathname.replace(/\/[^/]+\.html$/g,""),Ya=Xa+"/playcanvas.d.ts",Za=Xa+"/iframe/",$a=Xa+"/thumbnails/",Qa=Xa+"/playcanvas-logo.png";const Ja=new class{_id;constructor(e){this._id=e}get window(){const e=document.getElementById(this._id);return e instanceof HTMLIFrameElement?e.contentWindow:(console.warn("iframe doesnt exist yet."),null)}get ready(){try{return this.window?.eval("ready === true")}catch(e){}return!1}get path(){const e=/([\w\d-]+)_([\w\d-]+).html$/g.exec(this.window?.location.href??"");return e?`/${e[1]}/${e[2]}`:""}reload(){this.window?.location.reload()}fire(e,t={}){this.window?.dispatchEvent(new CustomEvent(e,{detail:t}))}}("exampleIframe");function eo(e){let t=0;for(let s=0;s<e.length&&" "===e[s];s++)t++;return t}const to={base:"vs-dark",inherit:!0,rules:[{foreground:"#ffffff"},{token:"#f1c40f",foreground:"#f1c40f"}],colors:{"editor.background":"#1d292c"}},so={tokenPostfix:".glsl",defaultToken:"invalid",keywords:["const","uniform","break","continue","do","for","while","if","else","switch","case","in","out","inout","true","false","invariant","discard","return","sampler2D","samplerCube","sampler3D","struct","radians","degrees","sin","cos","tan","asin","acos","atan","pow","sinh","cosh","tanh","asinh","acosh","atanh","exp","log","exp2","log2","sqrt","inversesqrt","abs","sign","floor","ceil","round","roundEven","trunc","fract","mod","modf","min","max","clamp","mix","step","smoothstep","length","distance","dot","cross ","determinant","inverse","normalize","faceforward","reflect","refract","matrixCompMult","outerProduct","transpose","lessThan ","lessThanEqual","greaterThan","greaterThanEqual","equal","notEqual","any","all","not","packUnorm2x16","unpackUnorm2x16","packSnorm2x16","unpackSnorm2x16","packHalf2x16","unpackHalf2x16","dFdx","dFdy","fwidth","textureSize","texture","textureProj","textureLod","textureGrad","texelFetch","texelFetchOffset","textureProjLod","textureLodOffset","textureGradOffset","textureProjLodOffset","textureProjGrad","intBitsToFloat","uintBitsToFloat","floatBitsToInt","floatBitsToUint","isnan","isinf","vec2","vec3","vec4","ivec2","ivec3","ivec4","uvec2","uvec3","uvec4","bvec2","bvec3","bvec4","mat2","mat3","mat2x2","mat2x3","mat2x4","mat3x2","mat3x3","mat3x4","mat4x2","mat4x3","mat4x4","mat4","float","int","uint","void","bool"],operators:["=",">","<","!","~","?",":","==","<=",">=","!=","&&","||","++","--","+","-","*","/","&","|","^","%","<<",">>",">>>","+=","-=","*=","/=","&=","|=","^=","%=","<<=",">>=",">>>="],symbols:/[=><!~?:&|+\-*\/\^%]+/,escapes:/\\(?:[abfnrtv\\"']|x[0-9A-Fa-f]{1,4}|u[0-9A-Fa-f]{4}|U[0-9A-Fa-f]{8})/,integersuffix:/([uU](ll|LL|l|L)|(ll|LL|l|L)?[uU]?)/,floatsuffix:/[fFlL]?/,encoding:/u|u8|U|L/,tokenizer:{root:[[/[a-zA-Z_]\w*/,{cases:{"@keywords":{token:"keyword.$0"},"@default":"identifier"}}],[/^\s*#\s*\w+/,"keyword.directive"],{include:"@whitespace"},[/[{}()\[\]]/,"@brackets"],[/@symbols/,{cases:{"@operators":"operator","@default":""}}],[/\d*\d+[eE]([\-+]?\d+)?(@floatsuffix)/,"number.float"],[/\d*\.\d+([eE][\-+]?\d+)?(@floatsuffix)/,"number.float"],[/0[xX][0-9a-fA-F']*[0-9a-fA-F](@integersuffix)/,"number.hex"],[/0[0-7']*[0-7](@integersuffix)/,"number.octal"],[/0[bB][0-1']*[0-1](@integersuffix)/,"number.binary"],[/\d[\d']*\d(@integersuffix)/,"number"],[/\d(@integersuffix)/,"number"],[/[;,.]/,"delimiter"]],comment:[[/[^\/*]+/,"comment"],[/\/\*/,"comment","@push"],["\\*/","comment","@pop"],[/[\/*]/,"comment"]],string:[[/[^\\"]+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/"/,{token:"string.quote",bracket:"@close",next:"@pop"}]],whitespace:[[/[ \t\r\n]+/,"white"],[/\/\*/,"comment","@comment"],[/\/\/.*$/,"comment"]]}};var io=Object.freeze({__proto__:null,conf:{comments:{lineComment:"//",blockComment:["/*","*/"]},brackets:[["{","}"],["[","]"],["(",")"]],autoClosingPairs:[{open:"[",close:"]"},{open:"{",close:"}"},{open:"(",close:")"},{open:"'",close:"'",notIn:["string","comment"]},{open:'"',close:'"',notIn:["string"]}],surroundingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}]},language:so});function no(e){const t=[],s=e.split(/\t+|\r+|\n+| +/);for(let e=0;e<s.length;++e)s[e].length>0&&t.push(s[e]);return t}const ro=/[_\p{XID_Start}]\p{XID_Continue}*/u,ao="variable.predefined",oo={tokenPostfix:".wgsl",defaultToken:"invalid",unicode:!0,atoms:no("true false"),keywords:no("\n              alias\n              break\n              case\n              const\n              const_assert\n              continue\n              continuing\n              default\n              diagnostic\n              discard\n              else\n              enable\n              fn\n              for\n              if\n              let\n              loop\n              override\n              requires\n              return\n              struct\n              switch\n              var\n              while\n              "),reserved:no("\n              NULL\n              Self\n              abstract\n              active\n              alignas\n              alignof\n              as\n              asm\n              asm_fragment\n              async\n              attribute\n              auto\n              await\n              become\n              binding_array\n              cast\n              catch\n              class\n              co_await\n              co_return\n              co_yield\n              coherent\n              column_major\n              common\n              compile\n              compile_fragment\n              concept\n              const_cast\n              consteval\n              constexpr\n              constinit\n              crate\n              debugger\n              decltype\n              delete\n              demote\n              demote_to_helper\n              do\n              dynamic_cast\n              enum\n              explicit\n              export\n              extends\n              extern\n              external\n              fallthrough\n              filter\n              final\n              finally\n              friend\n              from\n              fxgroup\n              get\n              goto\n              groupshared\n              highp\n              impl\n              implements\n              import\n              inline\n              instanceof\n              interface\n              layout\n              lowp\n              macro\n              macro_rules\n              match\n              mediump\n              meta\n              mod\n              module\n              move\n              mut\n              mutable\n              namespace\n              new\n              nil\n              noexcept\n              noinline\n              nointerpolation\n              noperspective\n              null\n              nullptr\n              of\n              operator\n              package\n              packoffset\n              partition\n              pass\n              patch\n              pixelfragment\n              precise\n              precision\n              premerge\n              priv\n              protected\n              pub\n              public\n              readonly\n              ref\n              regardless\n              register\n              reinterpret_cast\n              require\n              resource\n              restrict\n              self\n              set\n              shared\n              sizeof\n              smooth\n              snorm\n              static\n              static_assert\n              static_cast\n              std\n              subroutine\n              super\n              target\n              template\n              this\n              thread_local\n              throw\n              trait\n              try\n              type\n              typedef\n              typeid\n              typename\n              typeof\n              union\n              unless\n              unorm\n              unsafe\n              unsized\n              use\n              using\n              varying\n              virtual\n              volatile\n              wgsl\n              where\n              with\n              writeonly\n              yield\n              "),predeclared_enums:no("\n        read write read_write\n        function private workgroup uniform storage\n        perspective linear flat\n        center centroid sample\n        vertex_index instance_index position front_facing frag_depth\n            local_invocation_id local_invocation_index\n            global_invocation_id workgroup_id num_workgroups\n            sample_index sample_mask\n        rgba8unorm\n        rgba8snorm\n        rgba8uint\n        rgba8sint\n        rgba16uint\n        rgba16sint\n        rgba16float\n        r32uint\n        r32sint\n        r32float\n        rg32uint\n        rg32sint\n        rg32float\n        rgba32uint\n        rgba32sint\n        rgba32float\n        bgra8unorm\n"),predeclared_types:no("\n        bool\n        f16\n        f32\n        i32\n        sampler sampler_comparison\n        texture_depth_2d\n        texture_depth_2d_array\n        texture_depth_cube\n        texture_depth_cube_array\n        texture_depth_multisampled_2d\n        texture_external\n        texture_external\n        u32\n        "),predeclared_type_generators:no("\n        array\n        atomic\n        mat2x2\n        mat2x3\n        mat2x4\n        mat3x2\n        mat3x3\n        mat3x4\n        mat4x2\n        mat4x3\n        mat4x4\n        ptr\n        texture_1d\n        texture_2d\n        texture_2d_array\n        texture_3d\n        texture_cube\n        texture_cube_array\n        texture_multisampled_2d\n        texture_storage_1d\n        texture_storage_2d\n        texture_storage_2d_array\n        texture_storage_3d\n        vec2\n        vec3\n        vec4\n        "),predeclared_type_aliases:no("\n        vec2i vec3i vec4i\n        vec2u vec3u vec4u\n        vec2f vec3f vec4f\n        vec2h vec3h vec4h\n        mat2x2f mat2x3f mat2x4f\n        mat3x2f mat3x3f mat3x4f\n        mat4x2f mat4x3f mat4x4f\n        mat2x2h mat2x3h mat2x4h\n        mat3x2h mat3x3h mat3x4h\n        mat4x2h mat4x3h mat4x4h\n        "),predeclared_intrinsics:no("\n  bitcast all any select arrayLength abs acos acosh asin asinh atan atanh atan2\n  ceil clamp cos cosh countLeadingZeros countOneBits countTrailingZeros cross\n  degrees determinant distance dot exp exp2 extractBits faceForward firstLeadingBit\n  firstTrailingBit floor fma fract frexp inverseBits inverseSqrt ldexp length\n  log log2 max min mix modf normalize pow quantizeToF16 radians reflect refract\n  reverseBits round saturate sign sin sinh smoothstep sqrt step tan tanh transpose\n  trunc dpdx dpdxCoarse dpdxFine dpdy dpdyCoarse dpdyFine fwidth fwidthCoarse fwidthFine\n  textureDimensions textureGather textureGatherCompare textureLoad textureNumLayers\n  textureNumLevels textureNumSamples textureSample textureSampleBias textureSampleCompare\n  textureSampleCompareLevel textureSampleGrad textureSampleLevel textureSampleBaseClampToEdge\n  textureStore atomicLoad atomicStore atomicAdd atomicSub atomicMax atomicMin\n  atomicAnd atomicOr atomicXor atomicExchange atomicCompareExchangeWeak pack4x8snorm\n  pack4x8unorm pack2x16snorm pack2x16unorm pack2x16float unpack4x8snorm unpack4x8unorm\n  unpack2x16snorm unpack2x16unorm unpack2x16float storageBarrier workgroupBarrier\n  workgroupUniformLoad\n"),operators:no("\n                     &\n                     &&\n                     ->\n                     /\n                     =\n                     ==\n                     !=\n                     >\n                     >=\n                     <\n                     <=\n                     %\n                     -\n                     --\n                     +\n                     ++\n                     |\n                     ||\n                     *\n                     <<\n                     >>\n                     +=\n                     -=\n                     *=\n                     /=\n                     %=\n                     &=\n                     |=\n                     ^=\n                     >>=\n                     <<=\n                     "),symbols:/[!%&*+\-\.\/:;<=>^|_~]+/,tokenizer:{root:[[/enable|requires|diagnostic/,"keyword","@directive"],[ro,{cases:{"@atoms":ao,"@keywords":"keyword","@reserved":"invalid","@predeclared_enums":ao,"@predeclared_types":ao,"@predeclared_type_generators":ao,"@predeclared_type_aliases":ao,"@predeclared_intrinsics":ao,"@default":"identifier"}}],{include:"@commentOrSpace"},{include:"@numbers"},[/;:\./,"delimiter"],[/,/,"delimiter"],[/[{}()\[\]]/,"@brackets"],["@","annotation","@attribute"],[/@symbols/,{cases:{"@operators":"operator","@default":"delimiter"}}],[/./,"invalid"]],commentOrSpace:[[/\s+/,"white"],[/\/\*/,"comment","@blockComment"],[/\/\/.*$/,"comment"]],blockComment:[[/[^\/*]+/,"comment"],[/\/\*/,"comment","@push"],[/\*\//,"comment","@pop"],[/[\/*]/,"comment"]],attribute:[{include:"@commentOrSpace"},[/\w+/,"annotation","@pop"]],directive:[{include:"@commentOrSpace"},[/[()]/,"@brackets"],[/,/,"delimiter"],[ro,"meta.content"],[/;/,"delimiter","@pop"]],numbers:[[/0[fh]/,"number.float"],[/[1-9][0-9]*[fh]/,"number.float"],[/[0-9]*\.[0-9]+([eE][+-]?[0-9]+)?[fh]?/,"number.float"],[/[0-9]+\.[0-9]*([eE][+-]?[0-9]+)?[fh]?/,"number.float"],[/[0-9]+[eE][+-]?[0-9]+[fh]?/,"number.float"],[/0[xX][0-9a-fA-F]*\.[0-9a-fA-F]+(?:[pP][+-]?[0-9]+[fh]?)?/,"number.hex"],[/0[xX][0-9a-fA-F]+\.[0-9a-fA-F]*(?:[pP][+-]?[0-9]+[fh]?)?/,"number.hex"],[/0[xX][0-9a-fA-F]+[pP][+-]?[0-9]+[fh]?/,"number.hex"],[/0[xX][0-9a-fA-F]+[iu]?/,"number.hex"],[/[1-9][0-9]*[iu]?/,"number"],[/0[iu]?/,"number"]]}};var lo=Object.freeze({__proto__:null,conf:{comments:{lineComment:"//",blockComment:["/*","*/"]},brackets:[["{","}"],["[","]"],["(",")"]],autoClosingPairs:[{open:"[",close:"]"},{open:"{",close:"}"},{open:"(",close:")"}],surroundingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"}]},language:oo}),ho=Object.freeze({__proto__:null,glsl:io,wgsl:lo});function co(){let e=!0;return localStorage.getItem("showMinimap")&&(e="true"===localStorage.getItem("showMinimap")),e}Da.config({paths:{vs:"./modules/monaco-editor/min/vs"}});const uo={json:"json",shader:"",vert:"glsl",frag:"glsl",wgsl:"wgsl",javascript:"javascript",js:"javascript",mjs:"javascript"};let po;const mo=n.exports.Component;class _o extends mo{state={files:{"example.mjs":"// init"},selectedFile:"example.mjs",showMinimap:co()};constructor(e){super(e),this._handleExampleLoad=this._handleExampleLoad.bind(this),this._handleExampleLoading=this._handleExampleLoading.bind(this),this._handleRequestedFiles=this._handleRequestedFiles.bind(this)}_handleExampleLoad(e){const{files:t}=e.detail;this.mergeState({files:t,selectedFile:"example.mjs"})}_handleExampleLoading(){this.mergeState({files:{"example.mjs":"// reloading"}})}_handleRequestedFiles(e){const{files:t}=e.detail;this.mergeState({files:t})}mergeState(e){this.setState((t=>({...t,...e})))}componentDidMount(){window.addEventListener("exampleLoad",this._handleExampleLoad),window.addEventListener("exampleLoading",this._handleExampleLoading),window.addEventListener("requestedFiles",this._handleRequestedFiles),Ja.fire("requestFiles")}componentWillUnmount(){window.removeEventListener("exampleLoad",this._handleExampleLoad),window.removeEventListener("exampleLoading",this._handleExampleLoading),window.removeEventListener("requestedFiles",this._handleRequestedFiles)}beforeMount(e){fetch(Ya).then((e=>e.text())).then((t=>{e.languages.typescript.typescriptDefaults.addExtraLib(t,"@playcanvas/playcanvas.d.ts"),e.languages.typescript.javascriptDefaults.addExtraLib(t,"@playcanvas/playcanvas.d.ts");for(const t in ho)e.languages.register({id:t}),e.languages.setLanguageConfiguration(t,ho[t].conf),e.languages.setMonarchTokensProvider(t,ho[t].language)}))}editorDidMount(e){window.editor=e,po=e;const t=window.monaco;t.editor.defineTheme("playcanvas",to),t.editor.setTheme("playcanvas"),e.addCommand(t.KeyMod.Shift|t.KeyCode.Enter,(()=>{Ja.fire("hotReload")}));const s=document.getElementById("codePane");if(!s)return;s.classList.add("multiple-files"),this.state.files[this.state.selectedFile]||this.mergeState({selectedFile:"example.mjs"}),s.ui.on("resize",(()=>localStorage.setItem("codePaneStyle",s.getAttribute("style")??"")));const i=localStorage.getItem("codePaneStyle");i&&s.setAttribute("style",i);const n=s.querySelector(".panel-toggle");n&&(n.addEventListener("click",(function(){s.classList.toggle("collapsed"),localStorage.setItem("codePaneCollapsed",s.classList.contains("collapsed")?"true":"false")})),e.addAction({id:"view-toggle-minimap",label:"View: Toggle Minimap",contextMenuOrder:1.5,run:()=>{const e=!co();localStorage.setItem("showMinimap",`${e}`),this.mergeState({showMinimap:e})}}))}onChange(e){const{files:t,selectedFile:s}=this.state;t[s]=e}selectFile(e){this.mergeState({selectedFile:e}),po?.setScrollPosition({scrollTop:0,scrollLeft:0})}renderTabs(){const{files:e,selectedFile:t}=this.state,s=[];for(const i in e){const e=g(Ps,{key:i,id:`code-editor-file-tab-${i}`,text:i,class:i===t?"selected":null,onClick:()=>this.selectFile(i)});s.push(e)}return s}render(){setTimeout((()=>Ja.fire("resize")),50);const{files:e,selectedFile:t,showMinimap:s}=this.state,i=uo[t.split(".").pop()||"shader"];let n=e[t];n=n?function(e){const t=e.split("\n").slice(0,-1).filter((e=>Boolean(e.trim()))).map(eo);if(!t.length)return e;const s=Math.min(...t),i=new RegExp(" ".repeat(s),"g");return e.replace(i,"").trim()+"\n"}(n):"// reloading, please wait";const r={value:n,language:i,theme:"vs-dark",loading:null,beforeMount:this.beforeMount.bind(this),onMount:this.editorDidMount.bind(this),onChange:this.onChange.bind(this),options:{scrollbar:{horizontal:"visible"},readOnly:!1,minimap:{enabled:s}}};return g(Fn,{headerText:"CODE",id:"codePane",class:"true"===localStorage.getItem("codePaneCollapsed")?"collapsed":null,resizable:"left",resizeMax:2e3},g("div",{className:"panel-toggle",id:"codePane-panel-toggle"}),g(ti,{class:"tabs-wrapper"},g(ti,{class:"code-editor-menu-container"},g(Ps,{id:"play-button",icon:"E304",text:"",onClick:()=>Ja.fire("hotReload")}),g(Ps,{icon:"E259",text:"",onClick:()=>{const e="#/"===location.hash?"misc/hello-world":location.hash.replace("#/","");window.open(`https://github.com/playcanvas/engine/blob/main/examples/src/examples/${e}.mjs`)}})),g(ti,{class:"tabs-container"},this.renderTabs())),g(qa,r))}}var fo=class extends st{constructor(e){super(),this._observers=[],this._paths=[],this._applyingChange=!1,this._linked=!1,this._element=e.element,this._history=e.history,this._historyPrefix=e.historyPrefix,this._historyPostfix=e.historyPostfix,this._historyName=e.historyName,this._historyCombine=e.historyCombine||!1}_pathAt(e,t){return e[t]||e[0]}link(e,t){this._observers&&this.unlink(),this._observers=Array.isArray(e)?e:[e],this._paths=Array.isArray(t)?t:[t],this._linked=!0}unlink(){this._observers=[],this._paths=[],this._linked=!1}clone(){throw new Error("BindingBase#clone: Not implemented")}setValue(e){}setValues(e){}addValue(e){}addValues(e){}removeValue(e){}removeValues(e){}set element(e){this._element=e}get element(){return this._element}set applyingChange(e){this._applyingChange!==e&&(this._applyingChange=e,this.emit("applyingChange",e))}get applyingChange(){return this._applyingChange}get linked(){return this._linked}set historyCombine(e){this._historyCombine=e}get historyCombine(){return this._historyCombine}set historyName(e){this._historyName=e}get historyName(){return this._historyName}set historyPrefix(e){this._historyPrefix=e}get historyPrefix(){return this._historyPrefix}set historyPostfix(e){this._historyPostfix=e}get historyPostfix(){return this._historyPostfix}set historyEnabled(e){this._history&&(this._history.enabled=e)}get historyEnabled(){return this._history&&this._history.enabled}get observers(){return this._observers}get paths(){return this._paths}};class go extends fo{clone(){return new go({history:this._history,historyPrefix:this._historyPrefix,historyPostfix:this._historyPostfix,historyName:this._historyName,historyCombine:this._historyCombine})}_getHistoryActionName(e){return`${this._historyPrefix||""}${this._historyName||e[0]}${this._historyPostfix||""}`}_setValue(e,t){if(this.applyingChange)return;if(!this._observers.length)return;this.applyingChange=!0;const s=this._observers.slice(),i=this._paths.slice(),n={observers:s,paths:i},r=()=>{this._setValueToObservers(s,i,e,t),this.emit("history:redo",n)};if(this._history){let e=[];e=1===s.length&&i.length>1?i.map((e=>s[0].has(e)?s[0].get(e):void 0)):s.map(((e,t)=>{const s=this._pathAt(i,t);return e.has(s)?e.get(s):void 0})),this.emit("history:init",n),this._history.add({name:this._getHistoryActionName(i),redo:r,combine:this._historyCombine,undo:()=>{this._setValueToObservers(s,i,e,!0),this.emit("history:undo",n)}})}r(),this.applyingChange=!1}_setValueToObservers(e,t,s,i){if(1===e.length&&t.length>1)for(let i=0;i<t.length;i++){const n=e[0].latest();if(!n)continue;let r=!1;n.history&&(r=n.history.enabled,n.history.enabled=!1);const a=t[i],o=s[i];void 0!==s?this._observerSet(n,a,o):n.unset(a),r&&(n.history.enabled=!0)}else for(let n=0;n<e.length;n++){const r=e[n].latest();if(!r)continue;let a=!1;r.history&&(a=r.history.enabled,r.history.enabled=!1);const o=this._pathAt(t,n),l=i?s[n]:s;void 0!==s?this._observerSet(r,o,l):r.unset(o),a&&(r.history.enabled=!0)}}_observerSet(e,t,s){const i=t.lastIndexOf(".");if(i>0&&!e.has(t.substring(0,i)))return;const n=Array.isArray(s);e.set(t,n&&s?s.slice():s)}_addValues(e){if(this.applyingChange)return;if(!this._observers)return;this.applyingChange=!0;const t=this._observers.slice(),s=this._paths.slice(),i=[];for(let n=0;n<t.length;n++){const r=this._pathAt(s,n),a=t[n];e.forEach((e=>{-1===a.get(r).indexOf(e)&&i.push({observer:a,path:r,value:e})}))}const n=()=>{for(const e of i){const t=e.observer.latest();if(!t)continue;const s=e.path;let i=!1;t.history&&(i=t.history.enabled,t.history.enabled=!1),t.insert(s,e.value),i&&(t.history.enabled=!0)}};this._history&&i.length&&this._history.add({name:this._getHistoryActionName(s),redo:n,combine:this._historyCombine,undo:()=>{for(const e of i){const t=e.observer.latest();if(!t)continue;const s=e.path;let i=!1;t.history&&(i=t.history.enabled,t.history.enabled=!1),t.removeValue(s,e.value),i&&(t.history.enabled=!0)}}}),n(),this.applyingChange=!1}_removeValues(e){if(this.applyingChange)return;if(!this._observers)return;this.applyingChange=!0;const t=this._observers.slice(),s=this._paths.slice(),i=[];for(let n=0;n<t.length;n++){const r=this._pathAt(s,n),a=t[n];e.forEach((e=>{const t=a.get(r).indexOf(e);-1!==t&&i.push({observer:a,path:r,value:e,index:t})}))}const n=()=>{for(const e of i){const t=e.observer.latest();if(!t)continue;const s=e.path;let i=!1;t.history&&(i=t.history.enabled,t.history.enabled=!1),t.removeValue(s,e.value),i&&(t.history.enabled=!0)}};this._history&&i.length&&this._history.add({name:this._getHistoryActionName(s),redo:n,combine:this._historyCombine,undo:()=>{for(const e of i){const t=e.observer.latest();if(!t)continue;const s=e.path;let i=!1;t.history&&(i=t.history.enabled,t.history.enabled=!1),-1===t.get(s).indexOf(e.value)&&t.insert(s,e.value,e.index),i&&(t.history.enabled=!0)}}}),n(),this.applyingChange=!1}setValue(e){this._setValue(e,!1)}setValues(e){e=e.slice().map((e=>Array.isArray(e)?e.slice():e)),this._setValue(e,!0)}addValue(e){this._addValues([e])}addValues(e){this._addValues(e)}removeValue(e){this._removeValues([e])}removeValues(e){this._removeValues(e)}}var vo=go;class yo extends fo{constructor(e={}){super(e),this._events=[],this._updateTimeout=null,this._deferUpdateElement=()=>{this.applyingChange||(this.applyingChange=!0,this._updateTimeout=window.setTimeout((()=>{this._updateElement()})))},this._customUpdate=e.customUpdate}_linkObserver(e,t){this._events.push(e.on(t+":set",this._deferUpdateElement)),this._events.push(e.on(t+":unset",this._deferUpdateElement)),this._events.push(e.on(t+":insert",this._deferUpdateElement)),this._events.push(e.on(t+":remove",this._deferUpdateElement))}_updateElement(){this._updateTimeout&&(window.clearTimeout(this._updateTimeout),this._updateTimeout=null),this._updateTimeout=null,this.applyingChange=!0,this._element&&("function"==typeof this._customUpdate?this._customUpdate(this._element,this._observers,this._paths):1===this._observers.length?this._paths.length>1?this._element.value=this._paths.map((e=>this._observers[0].has(e)?this._observers[0].get(e):void 0)):this._element.value=this._observers[0].has(this._paths[0])?this._observers[0].get(this._paths[0]):void 0:this._element.values=this._observers.map(((e,t)=>{const s=this._pathAt(this._paths,t);return e.has(s)?e.get(s):void 0})),this.applyingChange=!1)}link(e,t){if(super.link(e,t),this._element){const e=this._element.renderChanges;this._element.renderChanges=!1,this._updateElement(),this._element.renderChanges=e}if(1===this._observers.length&&this._paths.length>1)for(let e=0;e<this._paths.length;e++)this._linkObserver(this._observers[0],this._paths[e]);else for(let e=0;e<this._observers.length;e++)this._linkObserver(this._observers[e],this._pathAt(this._paths,e))}unlink(){for(const e of this._events)e.unbind();this._events.length=0,this._updateTimeout&&(window.clearTimeout(this._updateTimeout),this._updateTimeout=null),super.unlink()}clone(){return new yo({customUpdate:this._customUpdate})}}var bo=yo;class xo extends fo{constructor(e={}){super(e),this._bindingElementToObservers=e.bindingElementToObservers||new vo(e),this._bindingObserversToElement=e.bindingObserversToElement||new bo(e),this._bindingElementToObservers.on("applyingChange",(e=>{this.applyingChange=e})),this._bindingElementToObservers.on("history:init",(e=>{this.emit("history:init",e)})),this._bindingElementToObservers.on("history:undo",(e=>{this.emit("history:undo",e)})),this._bindingElementToObservers.on("history:redo",(e=>{this.emit("history:redo",e)})),this._bindingObserversToElement.on("applyingChange",(e=>{this.applyingChange=e}))}link(e,t){super.link(e,t),this._bindingElementToObservers.link(e,t),this._bindingObserversToElement.link(e,t)}unlink(){this._bindingElementToObservers.unlink(),this._bindingObserversToElement.unlink(),super.unlink()}clone(){return new xo({bindingElementToObservers:this._bindingElementToObservers.clone(),bindingObserversToElement:this._bindingObserversToElement.clone()})}setValue(e){this._bindingElementToObservers.setValue(e)}setValues(e){this._bindingElementToObservers.setValues(e)}addValue(e){this._bindingElementToObservers.addValue(e)}addValues(e){this._bindingElementToObservers.addValues(e)}removeValue(e){this._bindingElementToObservers.removeValue(e)}removeValues(e){this._bindingElementToObservers.removeValues(e)}set element(e){this._element=e,this._bindingElementToObservers.element=e,this._bindingObserversToElement.element=e}get element(){return this._element}set applyingChange(e){super.applyingChange!==e&&(this._bindingElementToObservers.applyingChange=e,this._bindingObserversToElement.applyingChange=e,super.applyingChange=e)}get applyingChange(){return super.applyingChange}set historyCombine(e){this._bindingElementToObservers.historyCombine=e}get historyCombine(){return this._bindingElementToObservers.historyCombine}set historyPrefix(e){this._bindingElementToObservers.historyPrefix=e}get historyPrefix(){return this._bindingElementToObservers.historyPrefix}set historyPostfix(e){this._bindingElementToObservers.historyPostfix=e}get historyPostfix(){return this._bindingElementToObservers.historyPostfix}set historyEnabled(e){this._bindingElementToObservers.historyEnabled=e}get historyEnabled(){return this._bindingElementToObservers.historyEnabled}}var wo=xo;function So(e){if(null==e||"object"!=typeof e)return e;if(e instanceof Array){const t=[];for(let s=0;s<e.length;s++)t[s]=So(e[s]);return t}const t={};for(const s in e)e.hasOwnProperty(s)&&(t[s]=So(e[s]));return t}function Co(e,t){if(!e)return!1;if(!t)return!1;if(e.length!==t.length)return!1;for(let s=0,i=e.length;s<i;s++)if(e[s]instanceof Array&&t[s]instanceof Array){if(!e[s].equals(t[s]))return!1}else if(e[s]!==t[s])return!1;return!0}const To="pcui-flex",Ao="pcui-grid",Eo="pcui-hidden",Po="pcui-scrollable",Mo="pcui-resizable",Lo="pcui-readonly",Do="pcui-disabled",ko="pcui-collapsible",Io="pcui-collapsed",Ro="pcui-focus",Oo="pcui-multiple-values",zo="pcui-error",Fo="flash",Vo="pcui-not-flexible",No="font-regular",Bo="font-bold",Uo=["flexDirection","flexGrow","flexBasis","flexShrink","flexWrap","alignItems","alignSelf","justifyContent","justifySelf"],Ho=new Map;class Wo extends st{constructor(e={}){var t,s,i;if(super(),this._destroyed=!1,this._parent=null,this._eventsParent=[],this._flashTimeout=null,this._suppressChange=!1,this._onMouseOver=e=>{this.emit("hover",e)},this._onMouseOut=e=>{this.emit("hoverend",e)},"string"==typeof e.dom?this._dom=document.createElement(e.dom):e.dom instanceof Node?this._dom=e.dom:this._dom=document.createElement("div"),void 0!==e.id&&(this._dom.id=e.id),this._dom.ui=this,this._onClickEvt=this._onClick.bind(this),this._dom.addEventListener("click",this._onClickEvt),this._dom.addEventListener("mouseover",this._onMouseOver),this._dom.addEventListener("mouseout",this._onMouseOut),this._dom.classList.add("pcui-element",No),e.class){const t=Array.isArray(e.class)?e.class:[e.class];for(const e of t)this._dom.classList.add(e)}this.enabled=void 0===e.enabled||e.enabled,this._hiddenParents=!e.isRoot,this.hidden=null!==(t=e.hidden)&&void 0!==t&&t,this.readOnly=null!==(s=e.readOnly)&&void 0!==s&&s,this.ignoreParent=null!==(i=e.ignoreParent)&&void 0!==i&&i,void 0!==e.width&&(this.width=e.width),void 0!==e.height&&(this.height=e.height),void 0!==e.tabIndex&&(this.tabIndex=e.tabIndex);for(const t in e)void 0!==e[t]&&-1!==Uo.indexOf(t)&&(this[t]=e[t]);e.binding&&(this.binding=e.binding)}destroy(){if(this._destroyed)return;if(this._destroyed=!0,this.binding?this.binding=null:this.unlink(),this.parent){const e=this.parent;for(const e of this._eventsParent)e.unbind();this._eventsParent.length=0,e.remove&&!e._destroyed&&e.remove(this),this._parent=null,!e._destroyed&&this._dom&&this._dom.parentElement&&this._dom.parentElement.removeChild(this._dom)}const e=this._dom;e&&(e.removeEventListener("click",this._onClickEvt),e.removeEventListener("mouseover",this._onMouseOver),e.removeEventListener("mouseout",this._onMouseOut),delete e.ui,this._dom=null),this._flashTimeout&&window.clearTimeout(this._flashTimeout),this.emit("destroy",e,this),this.unbind()}link(e,t){this._binding&&this._binding.link(e,t)}unlink(){this._binding&&this._binding.unlink()}flash(){this._flashTimeout||(this.class.add(Fo),this._flashTimeout=window.setTimeout((()=>{this._flashTimeout=null,this.class.remove(Fo)}),200))}_onClick(e){this.enabled&&this.emit("click",e)}_onHiddenToRootChange(e){this.emit(e?"hideToRoot":"showToRoot")}_onEnabledChange(e){e?this.class.remove(Do):this.class.add(Do),this.emit(e?"enable":"disable")}_onParentDestroy(){this.destroy()}_onParentDisable(){this._ignoreParent||this._enabled&&this._onEnabledChange(!1)}_onParentEnable(){this._ignoreParent||this._enabled&&this._onEnabledChange(!0)}_onParentShowToRoot(){const e=this.hiddenToRoot;this._hiddenParents=!1,e!==this.hiddenToRoot&&this._onHiddenToRootChange(this.hiddenToRoot)}_onParentHideToRoot(){const e=this.hiddenToRoot;this._hiddenParents=!0,e!==this.hiddenToRoot&&this._onHiddenToRootChange(this.hiddenToRoot)}_onReadOnlyChange(e){e?this.class.add(Lo):this.class.remove(Lo),this.emit("readOnly",e)}_onParentReadOnlyChange(e){this._ignoreParent||(e?this._readOnly||this._onReadOnlyChange(!0):this._readOnly||this._onReadOnlyChange(!1))}unbind(e,t){return super.unbind(e,t)}static register(e,t,s){Ho.set(e,{cls:t,defaultArguments:s})}static unregister(e){Ho.delete(e)}static create(e,t){const s=Ho.get(e);if(!s)return void console.error("Invalid type passed to Element.create:",e);return new(0,s.cls)(Object.assign(Object.assign({},s.defaultArguments),t))}set enabled(e){if(this._enabled===e)return;const t=this.enabled;this._enabled=e,t!==e&&this._onEnabledChange(e)}get enabled(){return this._ignoreParent?this._enabled:this._enabled&&(!this._parent||this._parent.enabled)}set ignoreParent(e){this._ignoreParent=e,this._onEnabledChange(this.enabled),this._onReadOnlyChange(this.readOnly)}get ignoreParent(){return this._ignoreParent}get dom(){return this._dom}set parent(e){if(e===this._parent)return;const t=this.enabled,s=this.readOnly,i=this.hiddenToRoot;if(this._parent){for(let e=0;e<this._eventsParent.length;e++)this._eventsParent[e].unbind();this._eventsParent.length=0}this._parent=e,this._parent?(this._eventsParent.push(this._parent.once("destroy",this._onParentDestroy.bind(this))),this._eventsParent.push(this._parent.on("disable",this._onParentDisable.bind(this))),this._eventsParent.push(this._parent.on("enable",this._onParentEnable.bind(this))),this._eventsParent.push(this._parent.on("readOnly",this._onParentReadOnlyChange.bind(this))),this._eventsParent.push(this._parent.on("showToRoot",this._onParentShowToRoot.bind(this))),this._eventsParent.push(this._parent.on("hideToRoot",this._onParentHideToRoot.bind(this))),this._hiddenParents=this._parent.hiddenToRoot):this._hiddenParents=!0,this.emit("parent",this._parent);const n=this.enabled;n!==t&&this._onEnabledChange(n);const r=this.readOnly;r!==s&&this._onReadOnlyChange(r);const a=this.hiddenToRoot;a!==i&&this._onHiddenToRootChange(a)}get parent(){return this._parent}set hidden(e){if(e===this._hidden)return;const t=this.hiddenToRoot;this._hidden=e,e?this.class.add(Eo):this.class.remove(Eo),this.emit(e?"hide":"show"),this.hiddenToRoot!==t&&this._onHiddenToRootChange(this.hiddenToRoot)}get hidden(){return this._hidden}get hiddenToRoot(){return this._hidden||this._hiddenParents}set readOnly(e){this._readOnly!==e&&(this._readOnly=e,this._onReadOnlyChange(e))}get readOnly(){return this._ignoreParent?this._readOnly:this._readOnly||!(!this._parent||!this._parent.readOnly)}set error(e){this._hasError!==e&&(this._hasError=e,e?this.class.add(zo):this.class.remove(zo))}get error(){return this._hasError}get style(){return this._dom.style}get class(){return this._dom.classList}set width(e){"number"==typeof e&&(e=String(e)+"px"),this.style.width=e}get width(){return this._dom.clientWidth}set height(e){"number"==typeof e&&(e=String(e)+"px"),this.style.height=e}get height(){return this._dom.clientHeight}set tabIndex(e){this._dom.tabIndex=e}get tabIndex(){return this._dom.tabIndex}set binding(e){if(this._binding===e)return;let t,s;this._binding&&(t=this._binding.observers,s=this._binding.paths,this.unlink(),this._binding.element=null,this._binding=null),this._binding=e,this._binding&&(this._binding.element=this,t&&s&&this.link(t,s))}get binding(){return this._binding}get destroyed(){return this._destroyed}set flexDirection(e){this.style.flexDirection=e}get flexDirection(){return this.style.flexDirection}set flexGrow(e){this.style.flexGrow=e}get flexGrow(){return this.style.flexGrow}set flexBasis(e){this.style.flexBasis=e}get flexBasis(){return this.style.flexBasis}set flexShrink(e){this.style.flexShrink=e}get flexShrink(){return this.style.flexShrink}set flexWrap(e){this.style.flexWrap=e}get flexWrap(){return this.style.flexWrap}set alignItems(e){this.style.alignItems=e}get alignItems(){return this.style.alignItems}set alignSelf(e){this.style.alignSelf=e}get alignSelf(){return this.style.alignSelf}set justifyContent(e){this.style.justifyContent=e}get justifyContent(){return this.style.justifyContent}set justifySelf(e){this.style.justifySelf=e}get justifySelf(){return this.style.justifySelf}set disabled(e){this.enabled=!e}get disabled(){return!this.enabled}set element(e){this._dom=e}get element(){return this.dom}set innerElement(e){this._domContent=e}get innerElement(){return this._domContent}}Wo.EVENT_ENABLE="enable",Wo.EVENT_DISABLE="disable",Wo.EVENT_HIDE="hide",Wo.EVENT_HIDE_TO_ROOT="hideToRoot",Wo.EVENT_SHOW="show",Wo.EVENT_SHOW_TO_ROOT="showToRoot",Wo.EVENT_READ_ONLY="readOnly",Wo.EVENT_PARENT="parent",Wo.EVENT_CLICK="click",Wo.EVENT_HOVER="hover",Wo.EVENT_HOVER_END="hoverend",Wo.EVENT_DESTROY="destroy";var Go=Wo;const jo=[null,"top","right","bottom","left"],qo=Mo+"-resizing",Ko="pcui-container",Xo=Ko+"-dragged",Yo=Xo+"-child";class Zo extends Go{constructor(e={}){var t;super(e),this._scrollable=!1,this._flex=!1,this._grid=!1,this._domResizeHandle=null,this._resizePointerId=null,this._resizeData=null,this._resizeHorizontally=!0,this._resizeMin=100,this._resizeMax=300,this._draggedStartIndex=-1,this._onScroll=e=>{this.emit("scroll",e)},this._onResizeStart=e=>{null===this._resizePointerId&&(e.preventDefault(),e.stopPropagation(),this._domResizeHandle.setPointerCapture(e.pointerId),this._resizePointerId=e.pointerId,this._resizeStart())},this._onResizeMove=e=>{this._resizePointerId===e.pointerId&&(e.preventDefault(),e.stopPropagation(),this._resizeMove(e.clientX,e.clientY))},this._onResizeEnd=e=>{this._resizePointerId===e.pointerId&&(e.preventDefault(),e.stopPropagation(),this._resizeEnd(),this._domResizeHandle.releasePointerCapture(e.pointerId),this._resizePointerId=null)},this.class.add(Ko),this.domContent=this._dom,e.scrollable&&(this.scrollable=!0),this.flex=!!e.flex;let s=!!e.grid;s&&this.flex&&(console.error('Invalid Container arguments: "grid" and "flex" cannot both be true.'),s=!1),this.grid=s,this.resizable=null!==(t=e.resizable)&&void 0!==t?t:null,void 0!==e.resizeMin&&(this.resizeMin=e.resizeMin),void 0!==e.resizeMax&&(this.resizeMax=e.resizeMax)}destroy(){this._destroyed||(this.domContent=null,this._domResizeHandle&&(this._domResizeHandle.removeEventListener("pointerdown",this._onResizeStart),this._domResizeHandle.removeEventListener("pointermove",this._onResizeMove),this._domResizeHandle.removeEventListener("pointerup",this._onResizeEnd)),super.destroy())}append(e){const t=this._getDomFromElement(e);this._domContent.appendChild(t),this._onAppendChild(e)}appendBefore(e,t){const s=this._getDomFromElement(e);this._domContent.appendChild(s);const i=t&&this._getDomFromElement(t);this._domContent.insertBefore(s,i),this._onAppendChild(e)}appendAfter(e,t){const s=this._getDomFromElement(e),i=t&&this._getDomFromElement(t),n=i?i.nextSibling:null;n?this._domContent.insertBefore(s,n):this._domContent.appendChild(s),this._onAppendChild(e)}prepend(e){const t=this._getDomFromElement(e),s=this._domContent.firstChild;s?this._domContent.insertBefore(t,s):this._domContent.appendChild(t),this._onAppendChild(e)}remove(e){if(e.parent!==this)return;const t=this._getDomFromElement(e);this._domContent.removeChild(t),this._onRemoveChild(e)}move(e,t){let s=-1;for(let t=0;t<this.dom.childNodes.length;t++)if(this.dom.childNodes[t].ui===e){s=t;break}-1===s?this.appendBefore(e,this.dom.childNodes[t]):t!==s&&(this.remove(e),t<s?this.appendBefore(e,this.dom.childNodes[t]):this.appendAfter(e,this.dom.childNodes[t-1]))}clear(){let e=this._domContent.childNodes.length;for(;e--;){const t=this._domContent.childNodes[e];t.ui&&t.ui!==this&&t.ui.destroy()}this._domResizeHandle&&(this._domResizeHandle.removeEventListener("pointerdown",this._onResizeStart),this._domResizeHandle.removeEventListener("pointermove",this._onResizeMove),this._domResizeHandle.removeEventListener("pointerup",this._onResizeEnd),this._domResizeHandle=null),this._domContent.innerHTML="",this.resizable&&(this._createResizeHandle(),this._dom.appendChild(this._domResizeHandle))}_getDomFromElement(e){return e.dom?e.dom:e.element?e.element:e}_onAppendChild(e){e.parent=this,this.emit("append",e)}_onRemoveChild(e){e.parent=null,this.emit("remove",e)}_createResizeHandle(){const e=document.createElement("div");e.classList.add("pcui-resizable-handle"),e.ui=this,e.addEventListener("pointerdown",this._onResizeStart),e.addEventListener("pointermove",this._onResizeMove),e.addEventListener("pointerup",this._onResizeEnd),this._domResizeHandle=e}_resizeStart(){this.class.add(qo)}_resizeMove(e,t){if(this._resizeData){if(this._resizeHorizontally){let t=this._resizeData.x-e;"right"===this._resizable&&(t=-t),this.width=4+Math.max(this._resizeMin,Math.min(this._resizeMax,this._resizeData.width+t))}else{let e=this._resizeData.y-t;"bottom"===this._resizable&&(e=-e),this.height=Math.max(this._resizeMin,Math.min(this._resizeMax,this._resizeData.height+e))}this.emit("resize")}else this._resizeData={x:e,y:t,width:this.dom.clientWidth,height:this.dom.clientHeight}}_resizeEnd(){this._resizeData=null,this.class.remove(qo)}resize(e,t){e=e||0,t=t||0,this._resizeStart(),this._resizeMove(0,0),this._resizeMove(4-e,-t),this._resizeEnd()}_getDraggedChildIndex(e){for(let t=0;t<this.dom.childNodes.length;t++)if(this.dom.childNodes[t].ui===e)return t;return-1}_onChildDragStart(e,t){this.class.add(Yo),this._draggedStartIndex=this._getDraggedChildIndex(t),t.class.add(Xo),this.emit("child:dragstart",t,this._draggedStartIndex)}_onChildDragMove(e,t){const s=this.dom.getBoundingClientRect(),i=e.clientX<s.left||e.clientX>s.right||e.clientY<s.top||e.clientY>s.bottom,n=this._getDraggedChildIndex(t);if(i)return t.class.remove(Xo),void(this._draggedStartIndex!==n&&(this.remove(t),this._draggedStartIndex<n?this.appendBefore(t,this.dom.childNodes[this._draggedStartIndex]):this.appendAfter(t,this.dom.childNodes[this._draggedStartIndex-1])));t.class.add(Xo);const r=e.clientY-s.top;let a=null;for(let e=0;e<this.dom.childNodes.length;e++){const s=this.dom.childNodes[e].ui,i=s.dom.offsetTop;if(e<n){if(r<=i+s.header.height){a=e;break}}else if(e>n&&r+t.height>=i+s.height){a=e;break}}null!==a&&n!==a&&(this.remove(t),a<n?this.appendBefore(t,this.dom.childNodes[a]):this.appendAfter(t,this.dom.childNodes[a-1]))}_onChildDragEnd(e,t){this.class.remove(Yo),t.class.remove(Xo);const s=this._getDraggedChildIndex(t);this.emit("child:dragend",t,s,this._draggedStartIndex),this._draggedStartIndex=-1}forEachChild(e){for(let t=0;t<this.dom.childNodes.length;t++){const s=this.dom.childNodes[t].ui;if(s){if(!1===e(s,t))break}}}_buildDomNode(e){const t=Object.keys(e);let s;return t.includes("root")?(s=this._buildDomNode(e.root),e.children.forEach((e=>{const t=this._buildDomNode(e);null!==t&&s.append(t)}))):(s=e[t[0]],this[`_${t[0]}`]=s),s}buildDom(e){e.forEach((e=>{const t=this._buildDomNode(e);this.append(t)}))}set flex(e){e!==this._flex&&(this._flex=e,e?this.class.add(To):this.class.remove(To))}get flex(){return this._flex}set grid(e){e!==this._grid&&(this._grid=e,e?this.class.add(Ao):this.class.remove(Ao))}get grid(){return this._grid}set scrollable(e){this._scrollable!==e&&(this._scrollable=e,e?this.class.add(Po):this.class.remove(Po))}get scrollable(){return this._scrollable}set resizable(e){e!==this._resizable&&(-1!==jo.indexOf(e)?(this._resizable&&this.class.remove(`${Mo}-${this._resizable}`),this._resizable=e,this._resizeHorizontally="right"===e||"left"===e,e?(this.class.add(Mo),this.class.add(`${Mo}-${e}`),this._domResizeHandle||this._createResizeHandle(),this._dom.appendChild(this._domResizeHandle)):(this.class.remove(Mo),this._domResizeHandle&&this._dom.removeChild(this._domResizeHandle))):console.error("Invalid resizable value: must be one of "+jo.join(",")))}get resizable(){return this._resizable}set resizeMin(e){this._resizeMin=Math.max(0,Math.min(e,this._resizeMax))}get resizeMin(){return this._resizeMin}set resizeMax(e){this._resizeMax=Math.max(this._resizeMin,e)}get resizeMax(){return this._resizeMax}set domContent(e){this._domContent!==e&&(this._domContent&&this._domContent.removeEventListener("scroll",this._onScroll),this._domContent=e,this._domContent&&this._domContent.addEventListener("scroll",this._onScroll))}get domContent(){return this._domContent}}Zo.EVENT_APPEND="append",Zo.EVENT_REMOVE="remove",Zo.EVENT_SCROLL="scroll",Zo.EVENT_RESIZE="resize",Go.register("container",Zo);var $o=Zo;class Qo extends Go{constructor(e={}){var t,s,i;super(Object.assign({dom:"span"},e)),this.class.add("pcui-label"),this._unsafe=null!==(t=e.unsafe)&&void 0!==t&&t,this.text=null!==(i=null!==(s=e.text)&&void 0!==s?s:e.value)&&void 0!==i?i:"",e.allowTextSelection&&this.class.add("pcui-default-mousedown"),e.nativeTooltip&&(this.dom.title=this.text),this.placeholder=e.placeholder,this.renderChanges=e.renderChanges,this.on("change",(()=>{this.renderChanges&&this.flash()}))}_updateText(e){return this.class.remove(Oo),this._text!==e&&(this._text=e,this._unsafe?this._dom.innerHTML=e:this._dom.textContent=e,this.emit("change",e),!0)}set text(e){null==e&&(e="");this._updateText(e)&&this._binding&&this._binding.setValue(e)}get text(){return this._text}set value(e){this.text=e}get value(){return this.text}set values(e){const t=e.some((t=>t!==e[0]));t?(this._updateText(""),this.class.add(Oo)):this._updateText(e[0])}set placeholder(e){e?this.dom.setAttribute("placeholder",e):this.dom.removeAttribute("placeholder")}get placeholder(){return this.dom.getAttribute("placeholder")}set renderChanges(e){this._renderChanges=e}get renderChanges(){return this._renderChanges}}Go.register("label",Qo);var Jo=Qo;class el extends Go{constructor(e={}){super(Object.assign({dom:"button"},e)),this._onKeyDown=e=>{"Escape"===e.key?this.blur():"Enter"===e.key&&this._onClick(e)},this.class.add("pcui-button"),this._unsafe=e.unsafe,this.text=e.text,this.size=e.size,this.icon=e.icon,this.dom.addEventListener("keydown",this._onKeyDown)}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),super.destroy())}_onClick(e){this.blur(),this.readOnly||super._onClick(e)}focus(){this.dom.focus()}blur(){this.dom.blur()}set text(e){this._text!==e&&(this._text=e,this._unsafe?this.dom.innerHTML=e:this.dom.textContent=e)}get text(){return this._text}set icon(e){this._icon!==e&&e.match(/^E[0-9]{0,4}$/)&&(this._icon=e,e?this.dom.setAttribute("data-icon",String.fromCodePoint(parseInt(e,16))):this.dom.removeAttribute("data-icon"))}get icon(){return this._icon}set size(e){this._size!==e&&(this._size&&(this.class.remove("pcui-"+this._size),this._size=null),this._size=e,this._size&&this.class.add("pcui-"+this._size))}get size(){return this._size}}Go.register("button",el);var tl=el;const sl="pcui-panel",il=sl+"-header",nl=il+"-title",rl=sl+"-content",al=sl+"-horizontal",ol=sl+"-sortable-icon",ll=sl+"-remove";class hl extends $o{constructor(e={}){var t;const s=Object.assign(Object.assign({},e),{flex:!0});delete s.grid,delete s.flexDirection,delete s.scrollable,super(s),this._reflowTimeout=null,this._widthBeforeCollapse=null,this._heightBeforeCollapse=null,this._iconSort=null,this._btnRemove=null,this._onHeaderClick=e=>{this._collapsible&&(e.target!==this.header.dom&&e.target!==this._labelTitle.dom||(this.collapsed=!this.collapsed))},this._onDragStart=e=>{this.enabled&&!this.readOnly&&(e.stopPropagation(),e.preventDefault(),window.addEventListener("mouseup",this._onDragEndEvt),window.addEventListener("mouseleave",this._onDragEndEvt),window.addEventListener("mousemove",this._onDragMove),this.emit("dragstart"),this.parent&&this.parent._onChildDragStart&&this.parent._onChildDragStart(e,this))},this._onDragMove=e=>{this.emit("dragmove"),this.parent&&this.parent._onChildDragStart&&this.parent._onChildDragMove(e,this)},this.class.add(sl),e.panelType&&this.class.add(sl+"-"+e.panelType),this._suspendReflow=!0,this._initializeHeader(e),this._initializeContent(e),this.headerSize=null!==(t=e.headerSize)&&void 0!==t?t:32,this.collapsible=e.collapsible||!1,this.collapsed=e.collapsed||!1,this.collapseHorizontally=e.collapseHorizontally||!1,this.sortable=e.sortable||!1,this.removable=e.removable||!!e.onRemove||!1,this.domContent=this._containerContent.dom,this._suspendReflow=!1,this._reflow(),this._onDragEndEvt=this._onDragEnd.bind(this)}destroy(){this._destroyed||(this._reflowTimeout&&(cancelAnimationFrame(this._reflowTimeout),this._reflowTimeout=null),window.removeEventListener("mouseup",this._onDragEndEvt),window.removeEventListener("mouseleave",this._onDragEndEvt),window.removeEventListener("mousemove",this._onDragMove),super.destroy())}_initializeHeader(e){this._containerHeader=new $o({flex:!0,flexDirection:"row",class:[il,Bo]}),this._labelTitle=new Jo({text:e.headerText,class:[nl,Bo]}),this._containerHeader.append(this._labelTitle),this._containerHeader.dom.addEventListener("click",this._onHeaderClick),this.append(this._containerHeader)}_onClickRemove(e){e.preventDefault(),e.stopPropagation(),this.emit("click:remove")}_initializeContent(e){this._containerContent=new $o({class:rl,grid:e.grid,flex:e.flex,flexDirection:e.flexDirection,scrollable:e.scrollable,dom:e.content}),this.append(this._containerContent)}_reflow(){this._suspendReflow||(this._reflowTimeout&&(cancelAnimationFrame(this._reflowTimeout),this._reflowTimeout=null),!this.hidden&&this.collapsible&&(this.collapsed&&this.collapseHorizontally?this._containerHeader.style.top=-this.headerSize+"px":this._containerHeader.style.top="",this._reflowTimeout=requestAnimationFrame((()=>{this._reflowTimeout=null,this.collapsed?(this._widthBeforeCollapse||(this._widthBeforeCollapse=this.style.width),this._heightBeforeCollapse||(this._heightBeforeCollapse=this.style.height),this._collapseHorizontally?(this.height="",this.width=this.headerSize):this.height=this.headerSize,this.class.add(Io)):(this.class.remove(Io),this._collapseHorizontally?(this.height="",null!==this._widthBeforeCollapse&&(this.width=this._widthBeforeCollapse)):null!==this._heightBeforeCollapse&&(this.height=this._heightBeforeCollapse),this._widthBeforeCollapse=null,this._heightBeforeCollapse=null)}))))}_onDragEnd(e){window.removeEventListener("mouseup",this._onDragEndEvt),window.removeEventListener("mouseleave",this._onDragEndEvt),window.removeEventListener("mousemove",this._onDragMove),this._draggedChild===this&&(this._draggedChild=null),this.emit("dragend"),this.parent&&this.parent._onChildDragStart&&this.parent._onChildDragEnd(e,this)}set collapsible(e){e!==this._collapsible&&(this._collapsible=e,e?this.class.add(ko):this.class.remove(ko),this._reflow(),this.collapsed&&this.emit(e?"collapse":"expand"))}get collapsible(){return this._collapsible}set collapsed(e){this._collapsed!==e&&(this._collapsed=e,this._reflow(),this.collapsible&&this.emit(e?"collapse":"expand"))}get collapsed(){return this._collapsed}set sortable(e){this._sortable!==e&&(this._sortable=e,e?(this._iconSort=new Jo({class:ol}),this._iconSort.dom.addEventListener("mousedown",this._onDragStart),this.header.prepend(this._iconSort)):this._iconSort&&(this._iconSort.destroy(),this._iconSort=null))}get sortable(){return this._sortable}set removable(e){this.removable!==e&&(e?(this._btnRemove=new tl({icon:"E289",class:ll}),this._btnRemove.on("click",this._onClickRemove.bind(this)),this.header.append(this._btnRemove)):(this._btnRemove.destroy(),this._btnRemove=null))}get removable(){return!!this._btnRemove}set collapseHorizontally(e){this._collapseHorizontally!==e&&(this._collapseHorizontally=e,e?this.class.add(al):this.class.remove(al),this._reflow())}get collapseHorizontally(){return this._collapseHorizontally}get content(){return this._containerContent}get header(){return this._containerHeader}set headerText(e){this._labelTitle.text=e}get headerText(){return this._labelTitle.text}set headerSize(e){this._headerSize=e;const t=this._containerHeader.dom.style;t.height=Math.max(0,e)+"px",t.lineHeight=t.height,this._reflow()}get headerSize(){return this._headerSize}}hl.EVENT_COLLAPSE="collapse",hl.EVENT_EXPAND="expand",Go.register("panel",hl);var cl=hl;var dl=class extends Go{constructor(e={}){var t,s,i,n,r;super(e),this._onInputFocus=e=>{this.class.add(Ro),this.emit("focus",e),this._prevValue=this._domInput.value},this._onInputBlur=e=>{this.class.remove(Ro),this.emit("blur",e)},this._onInputKeyUp=e=>{"Escape"!==e.key&&this._onInputChange(e),this.emit("keyup",e)},this._onInputCtxMenu=e=>{this._domInput.select()},this._updateInputReadOnly=()=>{!this.enabled||this.readOnly?this._domInput.setAttribute("readonly","true"):this._domInput.removeAttribute("readonly")},this.class.add("pcui-input-element");let a=e.input;a||(a=document.createElement("input"),a.type="text"),a.ui=this,a.tabIndex=0,a.autocomplete="off",this._onInputKeyDownEvt=this._onInputKeyDown.bind(this),this._onInputChangeEvt=this._onInputChange.bind(this),a.addEventListener("change",this._onInputChangeEvt),a.addEventListener("keydown",this._onInputKeyDownEvt),a.addEventListener("focus",this._onInputFocus),a.addEventListener("blur",this._onInputBlur),a.addEventListener("contextmenu",this._onInputCtxMenu,!1),this.dom.appendChild(a),this._domInput=a,this._suspendInputChangeEvt=!1,void 0!==e.value&&(this._domInput.value=e.value),this.placeholder=null!==(t=e.placeholder)&&void 0!==t?t:"",this.renderChanges=null!==(s=e.renderChanges)&&void 0!==s&&s,this.blurOnEnter=null===(i=e.blurOnEnter)||void 0===i||i,this.blurOnEscape=null===(n=e.blurOnEscape)||void 0===n||n,this.keyChange=null!==(r=e.keyChange)&&void 0!==r&&r,this._prevValue=null,this.on("change",(()=>{this.renderChanges&&this.flash()})),this.on("disable",this._updateInputReadOnly),this.on("enable",this._updateInputReadOnly),this.on("readOnly",this._updateInputReadOnly),this._updateInputReadOnly()}destroy(){if(this._destroyed)return;const e=this._domInput;e.removeEventListener("change",this._onInputChangeEvt),e.removeEventListener("keydown",this._onInputKeyDownEvt),e.removeEventListener("focus",this._onInputFocus),e.removeEventListener("blur",this._onInputBlur),e.removeEventListener("keyup",this._onInputKeyUp),e.removeEventListener("contextmenu",this._onInputCtxMenu),super.destroy()}_onInputKeyDown(e){if("Enter"===e.key&&this.blurOnEnter)this._suspendInputChangeEvt=this.keyChange,this._domInput.blur(),this._suspendInputChangeEvt=!1;else if("Escape"===e.key){this._suspendInputChangeEvt=!0;const t=this._domInput.value;this._domInput.value=this._prevValue,this._suspendInputChangeEvt=!1,this.keyChange&&t!==this._prevValue&&this._onInputChange(e),this.blurOnEscape&&this._domInput.blur()}this.emit("keydown",e)}_onInputChange(e){}focus(e){this._domInput.focus(),e&&this._domInput.select()}blur(){this._domInput.blur()}set placeholder(e){e?this.dom.setAttribute("placeholder",e):this.dom.removeAttribute("placeholder")}get placeholder(){var e;return null!==(e=this.dom.getAttribute("placeholder"))&&void 0!==e?e:""}set keyChange(e){this._keyChange!==e&&(this._keyChange=e,e?this._domInput.addEventListener("keyup",this._onInputKeyUp):this._domInput.removeEventListener("keyup",this._onInputKeyUp))}get keyChange(){return this._keyChange}get input(){return this._domInput}set blurOnEnter(e){this._blurOnEnter=e}get blurOnEnter(){return this._blurOnEnter}set blurOnEscape(e){this._blurOnEscape=e}get blurOnEscape(){return this._blurOnEscape}set renderChanges(e){this._renderChanges=e}get renderChanges(){return this._renderChanges}};const ul="pcui-numeric-input",pl=ul+"-slider-control",ml=pl+"-active",_l=pl+"-hidden",fl=/,/g;class gl extends dl{constructor(e={}){var t,s,i,n;const r=Object.assign({},e);delete r.value,delete r.renderChanges,super(r),this._sliderUsed=!1,this._onSliderMouseWheel=e=>{this._updatePosition(e.deltaY,e.shiftKey)},this._onSliderMouseMove=e=>{this._updatePosition(e.movementX,e.shiftKey)},this._onSliderMouseDown=()=>{this._sliderControl.dom.requestPointerLock(),this._sliderMovement=0,this._sliderPrevValue=this.value,this._sliderUsed=!0,this.binding&&(this._historyCombine=this.binding.historyCombine,this._historyPostfix=this.binding.historyPostfix,this.binding.historyCombine=!0,this.binding.historyPostfix=`(${Date.now()})`)},this._onSliderMouseUp=()=>{document.exitPointerLock(),this._sliderUsed&&(this._sliderUsed=!1,this.value=this._sliderPrevValue+this._sliderMovement,this.binding&&(this.binding.historyCombine=this._historyCombine,this.binding.historyPostfix=this._historyPostfix,this._historyCombine=!1,this._historyPostfix=null),this.focus())},this._onPointerLockChange=()=>{this._isScrolling()?(this._sliderControl.dom.addEventListener("mousemove",this._onSliderMouseMove,!1),this._sliderControl.dom.addEventListener("wheel",this._onSliderMouseWheel,{passive:!0}),this._sliderControl.class.add(ml)):(this._sliderControl.dom.removeEventListener("mousemove",this._onSliderMouseMove,!1),this._sliderControl.dom.removeEventListener("wheel",this._onSliderMouseWheel),this._sliderControl.class.remove(ml))},this.class.add(ul),this._min=null!==(t=e.min)&&void 0!==t?t:null,this._max=null!==(s=e.max)&&void 0!==s?s:null,this._allowNull=null!==(i=e.allowNull)&&void 0!==i&&i,this._precision=null!==(n=e.precision)&&void 0!==n?n:7,Number.isFinite(e.step)?this._step=e.step:e.precision?this._step=10/Math.pow(10,e.precision):this._step=1,Number.isFinite(e.stepPrecision)?this._stepPrecision=e.stepPrecision:this._stepPrecision=.1*this._step,this._oldValue=void 0,Number.isFinite(e.value)?this.value=e.value:this._allowNull||(this.value=0),this._historyCombine=!1,this._historyPostfix=null,this._sliderPrevValue=0,this.renderChanges=e.renderChanges,e.hideSlider||(this._sliderControl=new Go,this._sliderControl.class.add(pl),this.dom.append(this._sliderControl.dom),this._sliderControl.dom.addEventListener("mousedown",this._onSliderMouseDown),this._sliderControl.dom.addEventListener("mouseup",this._onSliderMouseUp),document.addEventListener("pointerlockchange",this._onPointerLockChange,!1))}destroy(){this.destroyed||(this._sliderControl&&(this._sliderControl.dom.removeEventListener("mousedown",this._onSliderMouseDown),this._sliderControl.dom.removeEventListener("mouseup",this._onSliderMouseUp),this._sliderControl.dom.removeEventListener("mousemove",this._onSliderMouseMove,!1),this._sliderControl.dom.removeEventListener("wheel",this._onSliderMouseWheel),document.removeEventListener("pointerlockchange",this._onPointerLockChange,!1)),super.destroy())}_updatePosition(e,t){this._sliderMovement+=e/100*(t?this._stepPrecision:this._step),this.value=this._sliderPrevValue+this._sliderMovement}_onInputChange(e){this.value=this._normalizeValue(this._domInput.value)}_onInputKeyDown(e){if(this.enabled&&!this.readOnly){if("ArrowUp"===e.key||"ArrowDown"===e.key){const t="ArrowDown"===e.key?-1:1;this.value+=(e.shiftKey?this._stepPrecision:this._step)*t}super._onInputKeyDown(e)}}_isScrolling(){return!!this._sliderControl&&document.pointerLockElement===this._sliderControl.dom}_normalizeValue(e){try{if("string"==typeof e){if("0"===e)return 0;if(null!==(e=(e=(e=e.replace(fl,".")).replace(/\s/g,"")).match(/^[*/+\-0-9().]+$/))&&e[0].length<20){let t=e[0];["+","-","/","*"].forEach((e=>{const s=t.split(e);s.forEach(((e,t)=>{s[t]=s[t].replace(/^0+/,"")})),t=s.join(e)})),e=Function('"use strict";return ('+t+")")()}}}catch(t){e=null}if(null===e||isNaN(e)){if(this._allowNull)return null;e=0}return null!==this.min&&e<this.min&&(e=this.min),null!==this.max&&e>this.max&&(e=this.max),null!==this.precision&&(e=parseFloat(Number(e).toFixed(this.precision))),e}_updateValue(e,t){const s=e!==this._oldValue||t;return this._oldValue=e,this._domInput.value=null===e?"":String(e),this.class.remove(Oo),s&&this.emit("change",e),s}set value(e){e=this._normalizeValue(e);const t=this.class.contains(Oo)&&null===e&&this._allowNull;this._updateValue(e,t)&&this.binding&&this.binding.setValue(e),this._sliderControl&&this._sliderControl.class.remove(_l)}get value(){const e=this._domInput.value;return""!==e?parseFloat(e):null}set values(e){const t=e.map((e=>this._normalizeValue(e))),s=t.some((e=>e!==t[0]));s?(this._updateValue(null),this.class.add(Oo),this._sliderControl&&this._sliderControl.class.add(_l)):(this._updateValue(t[0]),this._sliderControl&&this._sliderControl.class.remove(_l))}set min(e){this._min!==e&&(this._min=e,null!==this._min&&(this.value=this.value))}get min(){return this._min}set max(e){this._max!==e&&(this._max=e,null!==this._max&&(this.value=this.value))}get max(){return this._max}set precision(e){this._precision!==e&&(this._precision=e,null!==this._precision&&(this.value=this.value))}get precision(){return this._precision}set step(e){this._step=e}get step(){return this._step}}Go.register("number",gl,{renderChanges:!0});var vl=gl;const yl="pcui-array-input",bl="pcui-array-empty",xl=yl+"-size",wl=yl+"-items",Sl=yl+"-item",Cl=Sl+"-delete";class Tl extends Go{constructor(e={}){var t,s,i;const n=new $o({dom:e.dom,flex:!0}),r=Object.assign(Object.assign({},e),{dom:n.dom});delete r.binding,super(r),this._suspendSizeChangeEvt=!1,this._suspendArrayElementEvts=!1,this._arrayElementChangeTimeout=null,this._container=n,this._container.parent=this,this.class.add(yl,bl),this._usePanels=null!==(t=e.usePanels)&&void 0!==t&&t,this._fixedSize=!!e.fixedSize,this._inputSize=new vl({class:[xl],placeholder:"Array Size",value:0,hideSlider:!0,step:1,precision:0,min:0,readOnly:this._fixedSize}),this._inputSize.on("change",(e=>{this._onSizeChange(e)})),this._inputSize.on("focus",(()=>{this.emit("focus")})),this._inputSize.on("blur",(()=>{this.emit("blur")})),this._container.append(this._inputSize),this._containerArray=new $o({class:wl,hidden:!0}),this._containerArray.on("append",(()=>{this._containerArray.hidden=!1})),this._containerArray.on("remove",(()=>{this._containerArray.hidden=0===this._arrayElements.length})),this._container.append(this._containerArray),this._getDefaultFn=null!==(s=e.getDefaultFn)&&void 0!==s?s:null;let a=e.elementArgs&&e.elementArgs.type||e.type;Tl.DEFAULTS.hasOwnProperty(a)||(a="string"),this._valueType=a,this._elementType=null!==(i=e.type)&&void 0!==i?i:"string",e.elementArgs?this._elementArgs=e.elementArgs:(delete r.dom,this._elementArgs=r),this._arrayElements=[],this.binding=e.binding,this._values=[],e.value&&(this.value=e.value),this.renderChanges=e.renderChanges||!1}destroy(){this._destroyed||(this._arrayElements.length=0,super.destroy())}_onSizeChange(e){if(0===e?this.class.add(bl):this.class.remove(bl),null===e)return;if(this._suspendSizeChangeEvt)return;let t;const s=()=>{if(this._getDefaultFn)t=this._getDefaultFn();else if(t=Tl.DEFAULTS[this._valueType],"curveset"===this._valueType){if(t=So(t),Array.isArray(this._elementArgs.curves))for(let e=0;e<this._elementArgs.curves.length;e++)t.keys.push([0,0])}else if("gradient"===this._valueType&&(t=So(t),this._elementArgs.channels))for(let e=0;e<this._elementArgs.channels;e++)t.keys.push([0,1])},i=this._values.map((i=>{if(i)if(i.length<e){const n=new Array(e-i.length);for(let e=0;e<n.length;e++)void 0===t&&s(),n[e]=So(t);i=i.concat(n)}else{const t=new Array(e);for(let s=0;s<e;s++)t[s]=So(i[s]);i=t}else{i=new Array(e);for(let n=0;n<e;n++)void 0===t&&s(),i[n]=So(t)}return i}));if(!i.length){const n=new Array(e);for(let i=0;i<e;i++)void 0===t&&s(),n[i]=So(t);i.push(n)}this._updateValues(i,!0)}_createArrayElement(){const e=Object.assign({},this._elementArgs);let t;e.binding?e.binding=e.binding.clone():this._binding&&(e.binding=this._binding.clone()),e.renderChanges=!1,t=this._usePanels?new cl({headerText:`[${this._arrayElements.length}]`,removable:!this._fixedSize,collapsible:!0,class:[Sl,Sl+"-"+this._elementType]}):new $o({flex:!0,flexDirection:"row",alignItems:"center",class:[Sl,Sl+"-"+this._elementType]}),"json"===this._elementType&&e.attributes&&(e.attributes=e.attributes.map((e=>{if(!e.path)return e;const t=(e=Object.assign({},e)).path.split(".");return t.splice(t.length-1,0,this._arrayElements.length),e.path=t.join("."),e})));const s=Go.create(this._elementType,e);t.append(s),s.renderChanges=this.renderChanges;const i={container:t,element:s};if(this._arrayElements.push(i),this._usePanels)t.on("click:remove",(()=>{this._removeArrayElement(i)}));else if(!this._fixedSize){const e=new tl({icon:"E289",size:"small",class:Cl,tabIndex:-1});e.on("click",(()=>{this._removeArrayElement(i)})),t.append(e)}return s.on("change",(e=>{this._onArrayElementChange(i,e)})),this._containerArray.append(t),i}_removeArrayElement(e){const t=this._arrayElements.indexOf(e);if(-1===t)return;const s=this._values.map((e=>e?(e.splice(t,1),e):null));this._updateValues(s,!0)}_onArrayElementChange(e,t){if(this._suspendArrayElementEvts)return;const s=this._arrayElements.indexOf(e);-1!==s&&(this._values.forEach((e=>{e&&e.length>s&&("curveset"===this._valueType?e[s]=Array.isArray(t)?t[0]:t:e[s]=t)})),this._arrayElementChangeTimeout=window.setTimeout((()=>{this._arrayElementChangeTimeout=null,this.emit("change",this.value)})))}_linkArrayElement(e,t){const s=this._binding.observers,i=this._binding.paths,n=1===i.length||s.length!==i.length;e.unlink(),e.value=null,this.emit("unlinkElement",e,t);const r=n?i[0]+`.${t}`:i.map((e=>`${e}.${t}`));e.link(s,r),this.emit("linkElement",e,t,r)}_updateValues(e,t){this._values=e||[],this._suspendArrayElementEvts=!0,this._suspendSizeChangeEvt=!0,t&&this._binding&&this._binding.setValues(e);const s=[],i=[];e.forEach((e=>{e&&(i.push(e.length),e.forEach(((e,t)=>{s[t]||(s[t]=[]),s[t].push(e)})))}));let n=-1;for(let t=0;t<s.length&&s[t].length===e.length;t++)this._arrayElements[t]||this._createArrayElement(),this._binding&&this._binding.observers?this._linkArrayElement(this._arrayElements[t].element,t):s[t].length>1?this._arrayElements[t].element.values=s[t]:this._arrayElements[t].element.value=s[t][0],n=t;for(let e=this._arrayElements.length-1;e>n;e--)this._arrayElements[e].container.destroy(),this._arrayElements.splice(e,1);this._inputSize.values=i,this._suspendSizeChangeEvt=!1,this._suspendArrayElementEvts=!1,this._arrayElementChangeTimeout&&(window.clearTimeout(this._arrayElementChangeTimeout),this._arrayElementChangeTimeout=null),this.emit("change",this.value)}focus(){this._inputSize.focus()}blur(){this._inputSize.blur()}unlink(){super.unlink(),this._arrayElements.forEach((e=>{e.element.unlink()}))}link(e,t){super.link(e,t),this._arrayElements.forEach(((e,t)=>{this._linkArrayElement(e.element,t)}))}forEachArrayElement(e){this._containerArray.forEachChild(((t,s)=>e(t.dom.firstChild.ui,s)))}set binding(e){super.binding=e,this._arrayElements.forEach((t=>{t.element.binding=e?e.clone():null}))}get binding(){return super.binding}set value(e){Array.isArray(e)||(e=[]);Co(this.value||[],e)||this._updateValues(new Array(this._values.length||1).fill(e),!0)}get value(){return this._arrayElements.map((e=>e.element.value))}set values(e){Co(this._values,e)||this._updateValues(e,!1)}set renderChanges(e){this._renderChanges=e,this._arrayElements.forEach((t=>{t.element.renderChanges=e}))}get renderChanges(){return this._renderChanges}}Tl.DEFAULTS={boolean:!1,number:0,string:"",vec2:[0,0],vec3:[0,0,0],vec4:[0,0,0,0]};for(const e in Tl.DEFAULTS)Go.register(`array:${e}`,Tl,{type:e,renderChanges:!0});Go.register("array:select",Tl,{type:"select",renderChanges:!0});var Al=Tl;const El="pcui-boolean-input",Pl=El+"-ticked",Ml=El+"-toggle";class Ll extends Go{constructor(e={}){var t;super(Object.assign({tabIndex:0},e)),this._onKeyDown=e=>{"Escape"!==e.key?this.enabled&&!this.readOnly&&" "===e.key&&(e.stopPropagation(),e.preventDefault(),this.value=!this.value):this.blur()},this._onFocus=()=>{this.emit("focus")},this._onBlur=()=>{this.emit("blur")},"toggle"===e.type?this.class.add(Ml):this.class.add(El),this.class.add(Vo),this.dom.addEventListener("keydown",this._onKeyDown),this.dom.addEventListener("focus",this._onFocus),this.dom.addEventListener("blur",this._onBlur),this._value=null,void 0!==e.value&&(this.value=e.value),this.renderChanges=null!==(t=e.renderChanges)&&void 0!==t&&t}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),this.dom.removeEventListener("focus",this._onFocus),this.dom.removeEventListener("blur",this._onBlur),super.destroy())}_onClick(e){return this.enabled&&this.focus(),this.enabled&&!this.readOnly&&(this.value=!this.value),super._onClick(e)}_updateValue(e){return this.class.remove(Oo),e!==this.value&&(this._value=e,e?this.class.add(Pl):this.class.remove(Pl),this.renderChanges&&this.flash(),this.emit("change",e),!0)}focus(){this.dom.focus()}blur(){this.dom.blur()}set value(e){this._updateValue(e)&&this._binding&&this._binding.setValue(e)}get value(){return this._value}set values(e){const t=e.some((t=>t!==e[0]));t?(this._updateValue(null),this.class.add(Oo)):this._updateValue(e[0])}set renderChanges(e){this._renderChanges=e}get renderChanges(){return this._renderChanges}}Go.register("boolean",Ll,{renderChanges:!0});var Dl=Ll;class kl extends Go{constructor(e={}){super(Object.assign({dom:"canvas"},e)),this._width=300,this._height=150,this._ratio=1,this.class.add("pcui-canvas");const{useDevicePixelRatio:t=!1}=e;this._ratio=t?window.devicePixelRatio:1,this.dom.onselectstart=e=>!1}resize(e,t){if(this._width===e&&this._height===t)return;this._width=e,this._height=t;const s=this._dom;s.width=this.pixelWidth,s.height=this.pixelHeight,s.style.width=e+"px",s.style.height=t+"px",this.emit("resize",e,t)}set width(e){if(this._width===e)return;this._width=e;const t=this._dom;t.width=this.pixelWidth,t.style.width=e+"px",this.emit("resize",this._width,this._height)}get width(){return this._width}set height(e){if(this._height===e)return;this._height=e;const t=this._dom;t.height=this.pixelHeight,t.style.height=e+"px",this.emit("resize",this._width,this._height)}get height(){return this._height}get pixelWidth(){return Math.floor(this._width*this._ratio)}get pixelHeight(){return Math.floor(this._height*this._ratio)}get pixelRatio(){return this._ratio}}Go.register("canvas",kl);var Il=kl;const Rl="pcui-code",Ol=Rl+"-inner";class zl extends $o{constructor(e={}){super(e),this.class.add(Rl),this._inner=new Jo({class:Ol}),this.append(this._inner),e.text&&(this.text=e.text)}set text(e){this._text=e,this._inner.text=e}get text(){return this._text}}Go.register("code",zl);var Fl=zl;const Vl="pcui-overlay",Nl=Vl+"-inner",Bl=Vl+"-clickable",Ul=Vl+"-transparent",Hl=Vl+"-content";class Wl extends $o{constructor(e={}){super(e),this._onMouseDown=e=>{this.clickable&&(document.body.blur(),requestAnimationFrame((()=>{this.hidden=!0})),e.preventDefault())},this.class.add(Vl),this._domClickableOverlay=document.createElement("div"),this._domClickableOverlay.ui=this,this._domClickableOverlay.classList.add(Nl),this.dom.appendChild(this._domClickableOverlay),this._domClickableOverlay.addEventListener("mousedown",this._onMouseDown),this.domContent=document.createElement("div"),this.domContent.ui=this,this.domContent.classList.add(Hl),this.dom.appendChild(this.domContent),this.clickable=e.clickable||!1,this.transparent=e.transparent||!1}destroy(){this._destroyed||(this._domClickableOverlay.removeEventListener("mousedown",this._onMouseDown),super.destroy())}position(e,t){const s=this._domClickableOverlay.getBoundingClientRect(),i=this.domContent.getBoundingClientRect();e=Math.max(0,Math.min(s.width-i.width,e)),t=Math.max(0,Math.min(s.height-i.height,t)),this.domContent.style.position="absolute",this.domContent.style.left=`${e}px`,this.domContent.style.top=`${t}px`}set clickable(e){e?this.class.add(Bl):this.class.remove(Bl)}get clickable(){return this.class.contains(Bl)}set transparent(e){e?this.class.add(Ul):this.class.remove(Ul)}get transparent(){return this.class.contains(Ul)}}Go.register("overlay",Wl);var Gl=Wl;class jl extends dl{constructor(e={}){super(e),this.class.add("pcui-text-input"),e.onValidate&&(this.onValidate=e.onValidate)}_onInputChange(e){if(!this._suspendInputChangeEvt){if(this._onValidate){const e=!this._onValidate(this.value);if(this.error=e,e)return}else this.error=!1;this.emit("change",this.value),this._binding&&this._binding.setValue(this.value)}}_updateValue(e){if(this.class.remove(Oo),e&&"object"==typeof e)if(Array.isArray(e)){let t=!1;for(let s=0;s<e.length;s++)if(e[s]&&"object"==typeof e[s]){t=!0;break}e=t?"[Not available]":e.map((e=>null===e?"null":e)).join(",")}else e="[Not available]";return e!==this.value&&(this._suspendInputChangeEvt=!0,this._domInput.value=null==e?"":String(e),this._suspendInputChangeEvt=!1,this.emit("change",e),!0)}set value(e){const t=this._updateValue(e);t&&(this.error=!1),t&&this._binding&&this._binding.setValue(e)}get value(){return this._domInput.value}set values(e){const t=e.some((t=>t!==e[0]));t?(this._updateValue(null),this.class.add(Oo)):this._updateValue(e[0])}set onValidate(e){this._onValidate=e}get onValidate(){return this._onValidate}}Go.register("string",jl,{renderChanges:!0});var ql=jl;function Kl(e){const t=e[0]/255,s=e[1]/255,i=e[2]/255;let n,r;const a=Math.max(t,s,i),o=a-Math.min(t,s,i),l=e=>(a-e)/6/o+.5;if(0===o)return n=r=0,[n,r,a];r=o/a;const h=l(t),c=l(s),d=l(i);return t===a?n=d-c:s===a?n=1/3+h-d:i===a&&(n=2/3+c-h),n<0?n+=1:n>1&&(n-=1),[n,r,a]}function Xl(e){const t=e[0],s=e[1],i=e[2];let n,r,a;const o=Math.floor(6*t),l=6*t-o,h=i*(1-s),c=i*(1-l*s),d=i*(1-(1-l)*s);switch(o%6){case 0:n=i,r=d,a=h;break;case 1:n=c,r=i,a=h;break;case 2:n=h,r=i,a=d;break;case 3:n=h,r=c,a=i;break;case 4:n=d,r=h,a=i;break;case 5:n=i,r=h,a=c}return[Math.round(255*n),Math.round(255*r),Math.round(255*a)]}class Yl extends Go{constructor(e={}){var t,s,i;super(e),this._historyCombine=!1,this._historyPostfix=null,this._size=144,this._directInput=!0,this._colorHSV=[0,0,0],this._pickerChannels=[],this._channelsNumber=4,this._changing=!1,this._dragging=!1,this._callingCallback=!1,this._pickRectPointerId=null,this._pickHuePointerId=null,this._pickOpacityPointerId=null,this._evtColorPick=null,this._evtColorToPicker=null,this._evtColorPickStart=null,this._evtColorPickEnd=null,this._onKeyDown=e=>{"Escape"===e.key&&this.blur(),"Enter"===e.key&&this.enabled&&!this.readOnly&&(e.stopPropagation(),e.preventDefault())},this._onFocus=e=>{this.emit("focus")},this._onBlur=e=>{this.emit("blur")},this._pickRectPointerDown=e=>{null===this._pickRectPointerId&&(this._pickRect.setPointerCapture(e.pointerId),this._pickRectPointerId=e.pointerId,e.preventDefault(),e.stopPropagation(),this.emit("picker:color:start"),this._pickRectPointerMove(e))},this._pickRectPointerMove=e=>{if(this._pickRectPointerId!==e.pointerId)return;this._changing=!0;const t=this._pickRect.getBoundingClientRect(),s=Math.max(0,Math.min(this._size,Math.floor(e.clientX-t.left))),i=Math.max(0,Math.min(this._size,Math.floor(e.clientY-t.top)));this._colorHSV[1]=s/this._size,this._colorHSV[2]=1-i/this._size,this._directInput=!1;const n=Xl(this._colorHSV);for(let e=0;e<3;e++)this._pickerChannels[e].value=n[e];this._fieldHex.value=this._getHex(),this._directInput=!0,this._pickRectHandle.style.left=Math.max(4,Math.min(this._size-4,s))+"px",this._pickRectHandle.style.top=Math.max(4,Math.min(this._size-4,i))+"px",this._changing=!1},this._pickRectPointerUp=e=>{this._pickRectPointerId===e.pointerId&&(this.emit("picker:color:end"),this._pickRect.releasePointerCapture(e.pointerId),this._pickRectPointerId=null)},this._pickHuePointerDown=e=>{null===this._pickHuePointerId&&(this._pickHue.setPointerCapture(e.pointerId),this._pickHuePointerId=e.pointerId,e.preventDefault(),e.stopPropagation(),this.emit("picker:color:start"),this._pickHuePointerMove(e))},this._pickHuePointerMove=e=>{if(this._pickHuePointerId!==e.pointerId)return;this._changing=!0;const t=this._pickHue.getBoundingClientRect(),s=Math.max(0,Math.min(this._size,Math.floor(e.clientY-t.top)))/this._size,i=Xl([s,this._colorHSV[1],this._colorHSV[2]]);this._colorHSV[0]=s,this._directInput=!1;for(let e=0;e<3;e++)this._pickerChannels[e].value=i[e];this._fieldHex.value=this._getHex(),this._onChangeRgb(),this._directInput=!0,this._changing=!1},this._pickHuePointerUp=e=>{this._pickHuePointerId===e.pointerId&&(this.emit("picker:color:end"),this._pickHue.releasePointerCapture(e.pointerId),this._pickHuePointerId=null)},this._pickOpacityPointerDown=e=>{null===this._pickOpacityPointerId&&(this._pickOpacity.setPointerCapture(e.pointerId),this._pickOpacityPointerId=e.pointerId,e.preventDefault(),e.stopPropagation(),this.emit("picker:color:start"),this._pickOpacityPointerMove(e))},this._pickOpacityPointerMove=e=>{if(this._pickOpacityPointerId!==e.pointerId)return;this._changing=!0;const t=this._pickOpacity.getBoundingClientRect(),s=1-Math.max(0,Math.min(this._size,Math.floor(e.clientY-t.top)))/this._size;this._directInput=!1,this._pickerChannels[3].value=Math.max(0,Math.min(255,Math.round(255*s))),this._fieldHex.value=this._getHex(),this._directInput=!0,this._changing=!1},this._pickOpacityPointerUp=e=>{this._pickOpacityPointerId===e.pointerId&&(this.emit("picker:color:end"),this._pickOpacity.releasePointerCapture(e.pointerId),this._pickOpacityPointerId=null)},this.class.add("pcui-color-input",Vo),this._domColor=document.createElement("div"),this.dom.appendChild(this._domColor),this.dom.addEventListener("keydown",this._onKeyDown),this.dom.addEventListener("focus",this._onFocus),this.dom.addEventListener("blur",this._onBlur),this.on("click",(()=>{this.enabled&&!this.readOnly&&this._openColorPicker()})),this._value=null!==(t=e.value)&&void 0!==t?t:[0,0,255,1],this._channels=null!==(s=e.channels)&&void 0!==s?s:3,this._setValue(this._value),this.renderChanges=null!==(i=e.renderChanges)&&void 0!==i&&i,this.on("change",(()=>{this.renderChanges&&this.flash()})),this._overlay=new Gl({class:"picker-color",clickable:!0,hidden:!0,transparent:!0}),this.dom.appendChild(this._overlay.dom),this._pickRect=document.createElement("div"),this._pickRect.classList.add("pick-rect"),this._overlay.append(this._pickRect),this._pickRect.addEventListener("pointerdown",this._pickRectPointerDown),this._pickRect.addEventListener("pointermove",this._pickRectPointerMove),this._pickRect.addEventListener("pointerup",this._pickRectPointerUp),this._pickRectWhite=document.createElement("div"),this._pickRectWhite.classList.add("white"),this._pickRect.appendChild(this._pickRectWhite),this._pickRectBlack=document.createElement("div"),this._pickRectBlack.classList.add("black"),this._pickRect.appendChild(this._pickRectBlack),this._pickRectHandle=document.createElement("div"),this._pickRectHandle.classList.add("handle"),this._pickRect.appendChild(this._pickRectHandle),this._pickHue=document.createElement("div"),this._pickHue.classList.add("pick-hue"),this._overlay.append(this._pickHue),this._pickHue.addEventListener("pointerdown",this._pickHuePointerDown),this._pickHue.addEventListener("pointermove",this._pickHuePointerMove),this._pickHue.addEventListener("pointerup",this._pickHuePointerUp),this._pickHueHandle=document.createElement("div"),this._pickHueHandle.classList.add("handle"),this._pickHue.appendChild(this._pickHueHandle),this._pickOpacity=document.createElement("div"),this._pickOpacity.classList.add("pick-opacity"),this._overlay.append(this._pickOpacity),this._pickOpacity.addEventListener("pointerdown",this._pickOpacityPointerDown),this._pickOpacity.addEventListener("pointermove",this._pickOpacityPointerMove),this._pickOpacity.addEventListener("pointerup",this._pickOpacityPointerUp),this._pickOpacityHandle=document.createElement("div"),this._pickOpacityHandle.classList.add("handle"),this._pickOpacity.appendChild(this._pickOpacityHandle),this._panelFields=document.createElement("div"),this._panelFields.classList.add("fields"),this._overlay.append(this._panelFields),this._overlay.on("hide",(()=>{this._evtColorPick.unbind(),this._evtColorPick=null,this._evtColorToPicker.unbind(),this._evtColorToPicker=null,this._evtColorPickStart.unbind(),this._evtColorPickStart=null,this._evtColorPickEnd.unbind(),this._evtColorPickEnd=null}));const n=e=>new vl({class:["field","field-"+e],precision:0,step:1,min:0,max:255,placeholder:e}),r=n("r");r.on("change",(()=>{this._onChangeRgb()})),this._pickerChannels.push(r),this._panelFields.appendChild(r.dom);const a=n("g");a.on("change",(()=>{this._onChangeRgb()})),this._pickerChannels.push(a),this._panelFields.appendChild(a.dom);const o=n("b");o.on("change",(()=>{this._onChangeRgb()})),this._pickerChannels.push(o),this._panelFields.appendChild(o.dom);const l=n("a");l.on("change",(e=>{this._onChangeAlpha(e)})),this._pickerChannels.push(l),this._panelFields.appendChild(l.dom),this._fieldHex=new ql({class:["field","field-hex"],placeholder:"#"}),this._fieldHex.on("change",(()=>{this._onChangeHex()})),this._panelFields.appendChild(this._fieldHex.dom)}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),this.dom.removeEventListener("focus",this._onFocus),this.dom.removeEventListener("blur",this._onBlur),this._pickRect.removeEventListener("pointerdown",this._pickRectPointerDown),this._pickRect.removeEventListener("pointermove",this._pickRectPointerMove),this._pickRect.removeEventListener("pointerup",this._pickRectPointerUp),this._pickHue.removeEventListener("pointerdown",this._pickHuePointerDown),this._pickHue.removeEventListener("pointermove",this._pickHuePointerMove),this._pickHue.removeEventListener("pointerup",this._pickHuePointerUp),this._pickOpacity.removeEventListener("pointerdown",this._pickOpacityPointerDown),this._pickOpacity.removeEventListener("pointermove",this._pickOpacityPointerMove),this._pickOpacity.removeEventListener("pointerup",this._pickOpacityPointerUp),super.destroy())}focus(){this.dom.focus()}blur(){this.dom.blur()}_setColorPickerPosition(e,t){this._overlay.position(e,t)}_setPickerColor(e){if(!this._changing&&!this._dragging){if(this._channelsNumber>=3){const t=Kl(e);this._colorHSV[0]=t[0],this._colorHSV[1]=t[1],this._colorHSV[2]=t[2]}this._directInput=!1;for(let t=0;t<e.length;t++)this._pickerChannels[t].value=e[t];this._fieldHex.value=this._getHex(),this._directInput=!0}}_openColorPicker(){this._callPicker(this.value.map((e=>Math.floor(255*e)))),this._evtColorPick=this.on("picker:color",(e=>{this.value=e.map((e=>e/255))})),this._evtColorPickStart=this.on("picker:color:start",(()=>{this.binding?(this._historyCombine=this.binding.historyCombine,this._historyPostfix=this.binding.historyPostfix,this.binding.historyCombine=!0,this._binding.historyPostfix=`(${Date.now()})`):(this._historyCombine=!1,this._historyPostfix=null)})),this._evtColorPickEnd=this.on("picker:color:end",(()=>{this.binding&&(this.binding.historyCombine=this._historyCombine,this.binding.historyPostfix=this._historyPostfix)}));const e=this._overlay.dom.getBoundingClientRect(),t=this.dom.getBoundingClientRect();this._setColorPickerPosition(t.left-e.width,t.top+25),this._evtColorToPicker=this.on("change",(()=>{this._setPickerColor(this.value.map((e=>Math.floor(255*e))))}))}_callPicker(e){for(let t=0;t<4;t++)e.length-1<t?this._overlay.class.remove("c-"+(t+1)):this._overlay.class.add("c-"+(t+1));if(this._channelsNumber=e.length,this._channelsNumber>=3){const t=Kl(e);this._colorHSV[0]=t[0],this._colorHSV[1]=t[1],this._colorHSV[2]=t[2]}this._directInput=!1;for(let t=0;t<e.length;t++)this._pickerChannels[t].value=e[t];this._fieldHex.value=this._getHex(),this._directInput=!0,this._overlay.hidden=!1,this._fieldHex.dom.focus(),window.setTimeout((()=>{this._fieldHex.dom.focus()}),100)}_valueToColor(e){return e=Math.floor(255*e),Math.max(0,Math.min(e,255))}_setValue(e){const t=this._valueToColor(e[0]),s=this._valueToColor(e[1]),i=this._valueToColor(e[2]),n=e[3];1===this._channels?this._domColor.style.backgroundColor=`rgb(${t}, ${t}, ${t})`:3===this._channels?this._domColor.style.backgroundColor=`rgb(${t}, ${s}, ${i})`:4===this._channels&&(this._domColor.style.backgroundColor=`rgba(${t}, ${s}, ${i}, ${n})`)}_updateValue(e){let t=!1;for(let s=0;s<e.length;s++)this._value[s]!==e[s]&&(t=!0,this._value[s]=e[s]);return this.class.remove(Oo),t&&(this._setValue(e),this.emit("change",e)),t}_getHex(){let e="";for(let t=0;t<this._channelsNumber;t++)e+=("00"+this._pickerChannels[t].value.toString(16)).slice(-2).toUpperCase();return e}_onChangeHex(){if(!this._directInput)return;this._changing=!0;const e=this._fieldHex.value.trim().toLowerCase();if(/^([0-9a-f]{2}){3,4}$/.test(e))for(let t=0;t<this._channelsNumber;t++)this._pickerChannels[t].value=parseInt(e.slice(2*t,2*t+2),16);this._changing=!1}_onChangeRgb(){const e=this._pickerChannels.map((function(e){return e.value||0})).slice(0,this._channelsNumber),t=Kl(e);if(this._directInput){const s=e[0]+e[1]+e[2];765!==s&&0!==s&&(this._colorHSV[0]=t[0]),this._colorHSV[1]=t[1],this._colorHSV[2]=t[2],this._dragging=!0,this.emit("picker:color:start")}if(this._pickHueHandle.style.top=Math.floor(this._size*this._colorHSV[0])+"px",this._pickRectHandle.style.left=Math.max(4,Math.min(this._size-4,this._size*this._colorHSV[1]))+"px",this._pickRectHandle.style.top=Math.max(4,Math.min(this._size-4,this._size*(1-this._colorHSV[2])))+"px",this._channelsNumber>=3){const t=Xl([this._colorHSV[0],1,1]).join(",");this._pickRect.style.backgroundColor="rgb("+t+")",this._pickRectHandle.style.backgroundColor="rgb("+e.slice(0,3).join(",")+")",this._pickHueHandle.style.backgroundColor="rgb("+t+")"}this.callCallback()}_onChangeAlpha(e){4===this._channelsNumber&&(this._pickOpacityHandle.style.top=Math.floor(this._size*(1-Math.max(0,Math.min(255,e))/255))+"px",this._pickOpacityHandle.style.backgroundColor=`rgb(${e}, ${e}, ${e})`,this.callCallback())}callbackHandle(){this._callingCallback=!1,this.emit("picker:color",this._pickerChannels.map((function(e){return e.value||0})).slice(0,this._channelsNumber))}callCallback(){this._callingCallback||(this._callingCallback=!0,window.setTimeout((()=>{this.callbackHandle()}),1e3/60))}set value(e){e=e||[0,0,0,0];this._updateValue(e)&&this._binding&&this._binding.setValue(e)}get value(){return this._value.slice(0,this._channels)}set values(e){let t=!1;const s=e[0];for(let i=1;i<e.length;i++)if(Array.isArray(s)){if(!s.equals(e[i])){t=!0;break}}else if(s!==e[i]){t=!0;break}t?(this.value=null,this.class.add(Oo)):this.value=e[0]}set channels(e){this._channels!==e&&(this._channels=Math.max(0,Math.min(e,4)),this._setValue(this.value))}get channels(){return this._channels}set renderChanges(e){this._renderChanges=e}get renderChanges(){return this._renderChanges}}Go.register("rgb",Yl),Go.register("rgba",Yl,{channels:4});var Zl=Yl;class $l extends Go{constructor(e={}){super(e),this.class.add("pcui-divider")}}Go.register("divider",$l);var Ql=$l;const Jl=(e,t)=>{if(0===e.length)return t.length;if(0===t.length)return e.length;if(e===t)return 0;const s=[];for(let e=0;e<=t.length;e++)s[e]=[e];for(let t=0;t<=e.length;t++)s[0][t]=t;for(let i=1;i<=t.length;i++)for(let n=1;n<=e.length;n++)t.charAt(i-1)===e.charAt(n-1)?s[i][n]=s[i-1][n-1]:s[i][n]=Math.min(s[i-1][n-1]+1,Math.min(s[i][n-1]+1,s[i-1][n]+1));return s[t.length][e.length]},eh=(e,t)=>{if(e===t)return e.length;let s=0;const i=new Set;for(let e=0;e<t.length;e++)i.add(t.charAt(e));for(let t=0;t<e.length;t++)i.has(e.charAt(t))&&s++;return s},th=e=>{const t=[],s=e.replace(/([^A-Z])([A-Z][^A-Z])/g,"$1 $2").replace(/([A-Z0-9]{2,})/g," $1").split(/(\s|\-|_)/g);for(let e=0;e<s.length;e++)s[e]=s[e].toLowerCase().trim(),s[e]&&"-"!==s[e]&&"_"!==s[e]&&t.push(s[e]);return t},sh=(e,t,s)=>{const i=[];for(const n of e){if(n.subFull!==1/0){i.push(n),n.edits===1/0&&(n.edits=0),n.sub===1/0&&(n.sub=n.subFull);continue}if(n.name===t||0===n.name.indexOf(t)){i.push(n),n.edits===1/0&&(n.edits=0),n.sub===1/0&&(n.sub=0);continue}if(eh(t,n.name)/t.length<s.containsCharsTolerance)continue;let e=1/0,r=1/0;for(let i=0;i<n.tokens.length;i++){if(n.tokens[i]===t){e=0,r=i;break}const a=Jl(t,n.tokens[i]);(r===1/0||a<e)&&-1!==n.tokens[i].indexOf(t)?(r=i,e=a):r===1/0&&a<e&&a/Math.max(t.length,n.tokens[i].length)<=s.editsDistanceTolerance&&(e=a)}e!==1/0&&(i.push(n),n.edits=n.edits===1/0?e:n.edits+e,n.sub=n.sub===1/0?r:n.sub+r)}return i},ih=(e,t="",s={})=>{if(!(t=t.toLowerCase().trim()))return[];const i=th(t);if(!i.length)return[];s.containsCharsTolerance=s.containsCharsTolerance||.5,s.editsDistanceTolerance=s.editsDistanceTolerance||.5;let n=[];for(const s of e){const e=s[0].toLowerCase().trim().indexOf(t);n.push({name:s[0],item:s[1],tokens:th(s[0]),edits:1/0,subFull:-1!==e?e:1/0,sub:1/0})}for(let e=0;e<i.length;e++)n=sh(n,i[e],s);n.sort(((e,t)=>e.subFull!==t.subFull?e.subFull-t.subFull:e.sub!==t.sub?e.sub-t.sub:e.edits!==t.edits?e.edits-t.edits:e.name.length-t.name.length));let r=n.map((e=>e.item));return s.hasOwnProperty("limitResults")&&r.length>s.limitResults&&(r=r.slice(0,s.limitResults)),r},nh="pcui-select-input",rh=nh+"-container-value",ah=nh+"-multi",oh=nh+"-disabled-value",lh=nh+"-has-disabled-value",hh=nh+"-value",ch=nh+"-icon",dh=nh+"-textinput",uh=nh+"-list",ph=nh+"-tags",mh=nh+"-tags-empty",_h=nh+"-tag",fh=nh+"-tag-not-everywhere",gh=nh+"-shadow",vh=nh+"-fit-height",yh="pcui-selected",bh=nh+"-label-highlighted",xh=nh+"-create-new",wh="pcui-open";class Sh extends Go{constructor(e={}){var t,s,i,n;const r=new $o({dom:e.dom});super(Object.assign(Object.assign({},e),{dom:r.dom})),this._timeoutLabelValueTabIndex=null,this._valueToText={},this._valueToLabel={},this._labelToValue=new Map,this._labelHighlighted=null,this._disabledOptions={},this._prefix="",this._onInputChange=e=>{this._suspendInputChange||this._lastInputValue!==e&&(this.open(),this._lastInputValue=e,this._filterOptions(e))},this._onInputKeyDown=e=>{if("Enter"===e.key&&this.enabled&&!this.readOnly){let t;if(e.stopPropagation(),e.preventDefault(),t=this._labelHighlighted&&this._labelToValue.has(this._labelHighlighted)?this._labelToValue.get(this._labelHighlighted):this._input.value,void 0!==t)return this.focus(),this.close(),void(this._valueToText[t]?this._onSelectValue(t):this._allowCreate&&(this._createFn?this._createFn(t):this._onSelectValue(t)))}this._onKeyDown(e)},this._onWindowMouseDown=e=>{this.dom.contains(e.target)||this.close()},this._onKeyDown=e=>{if("Escape"!==e.key)if("Tab"!==e.key){if(this.enabled&&!this.readOnly)if("Enter"!==e.key||this._allowInput){if("ArrowUp"===e.key||"ArrowDown"===e.key)if(e.stopPropagation(),e.preventDefault(),(this._allowInput||this.multiSelect)&&this._containerOptions.hidden)this.open();else if(this._containerOptions.hidden){if(!this._options.length)return;let t=-1;for(let e=0;e<this._options.length;e++)if(this._options[e].v===this.value){t=e;break}"ArrowUp"===e.key?t--:"ArrowDown"===e.key&&t++,t>=0&&t<this._options.length&&this._onSelectValue(this._options[t].v)}else{if(!this._containerOptions.dom.childNodes.length)return;if(this._labelHighlighted){let t=this._labelHighlighted.dom;do{"ArrowUp"===e.key?t=t.previousSibling:"ArrowDown"===e.key&&(t=t.nextSibling)}while(t&&t.ui.hidden);t&&this._highlightLabel(t.ui)}else this._highlightLabel(this._containerOptions.dom.childNodes[0].ui)}}else this._labelHighlighted&&this._labelToValue.has(this._labelHighlighted)&&(this._onSelectValue(this._labelToValue.get(this._labelHighlighted)),this.close())}else this.close();else this.close()},this._onMouseDown=()=>{this._allowInput||this.focus()},this._onFocus=()=>{this.class.add(Ro),this.emit("focus"),this._input.hidden||this.open()},this._onBlur=()=>{this.class.remove(Ro),this.emit("blur")},this._onWheel=e=>{e.stopPropagation()},this._container=r,this._container.parent=this,this.class.add(nh),this._containerValue=new $o({class:rh}),this._container.append(this._containerValue),this._domShadow=document.createElement("div"),this._domShadow.classList.add(gh),this._containerValue.append(this._domShadow),this._allowInput=e.allowInput,this._allowInput&&this.class.add("pcui-select-input-allow-input"),this._allowCreate=e.allowCreate,this._createFn=e.createFn,this._createLabelText=e.createLabelText,this._labelValue=new Jo({class:hh,tabIndex:0}),this._labelValue.on("click",(()=>{this.enabled&&!this.readOnly&&this.toggle()})),this._containerValue.append(this._labelValue),this._labelIcon=new Jo({class:ch,hidden:e.allowInput&&e.multiSelect}),this._containerValue.append(this._labelIcon),this._input=new ql({class:dh,blurOnEnter:!1,keyChange:!0}),this._containerValue.append(this._input),this._lastInputValue="",this._suspendInputChange=!1,this._input.on("change",this._onInputChange),this._input.on("keydown",this._onInputKeyDown),this._input.on("focus",this._onFocus),this._input.on("blur",this._onBlur),e.placeholder&&(this.placeholder=e.placeholder),this._containerOptions=new $o({class:uh,hidden:!0}),this._containerValue.append(this._containerOptions),this._containerTags=new $o({class:ph,flex:!0,flexDirection:"row",hidden:!0}),this._container.append(this._containerTags),e.multiSelect&&(this.class.add(ah),this._containerTags.hidden=!1),this._labelValue.dom.addEventListener("keydown",this._onKeyDown),this._labelValue.dom.addEventListener("focus",this._onFocus),this._labelValue.dom.addEventListener("blur",this._onBlur),this._labelValue.dom.addEventListener("mousedown",this._onMouseDown),this._containerOptions.dom.addEventListener("wheel",this._onWheel,{passive:!0}),this.on("hide",(()=>{this.close()})),this._type=null!==(t=e.type)&&void 0!==t?t:"string",this.invalidOptions=null!==(s=e.invalidOptions)&&void 0!==s?s:[],this.options=null!==(i=e.options)&&void 0!==i?i:[],this._optionsFn=e.optionsFn,this._allowNull=e.allowNull,this._values=null,void 0!==e.value?this.value=e.value:e.defaultValue?this.value=e.defaultValue:this.value=null,this._renderChanges=e.renderChanges,this.on("change",(()=>{this._updateInputFieldsVisibility(),this.renderChanges&&!this.multiSelect&&this._labelValue.flash()})),this._updateInputFieldsVisibility(!1),this._onSelect=e.onSelect,this.fallbackOrder=e.fallbackOrder,this.disabledOptions=e.disabledOptions,this._prefix=null!==(n=e.prefix)&&void 0!==n?n:""}destroy(){this._destroyed||(this._labelValue.dom.removeEventListener("keydown",this._onKeyDown),this._labelValue.dom.removeEventListener("mousedown",this._onMouseDown),this._labelValue.dom.removeEventListener("focus",this._onFocus),this._labelValue.dom.removeEventListener("blur",this._onBlur),this._containerOptions.dom.removeEventListener("wheel",this._onWheel),window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("mousedown",this._onWindowMouseDown),this._timeoutLabelValueTabIndex&&(cancelAnimationFrame(this._timeoutLabelValueTabIndex),this._timeoutLabelValueTabIndex=null),super.destroy())}_initializeCreateLabel(){const e=new $o({class:xh,flex:!0,flexDirection:"row"}),t=new Jo({text:this._input.value,tabIndex:-1});e.append(t);let s=this._input.on("change",(s=>{t.destroyed||(t.text=s,this.invalidOptions&&-1!==this.invalidOptions.indexOf(s)?e.hidden||(e.hidden=!0,this._resizeShadow()):e.hidden&&(e.hidden=!1,this._resizeShadow()))}));e.on("click",(e=>{e.stopPropagation();const s=t.text;this.focus(),this.close(),this._createFn?this._createFn(s):s&&this._onSelectValue(s)})),t.on("destroy",(()=>{s.unbind(),s=null}));const i=new Jo({text:this._createLabelText});return e.append(i),this._containerOptions.append(e),e}_convertSingleValue(e){if(null===e&&this._allowNull)return e;if("string"===this._type)e=e?e.toString():"";else if("number"===this._type)e=e?parseInt(e,10):0;else if("boolean"===this._type)return!!e;return e}_convertValue(e){return null===e&&this._allowNull?e:this.multiSelect?Array.isArray(e)?e.map((e=>this._convertSingleValue(e))):e:this._convertSingleValue(e)}_onSelectValue(e){if(e=this._convertSingleValue(e),this.multiSelect)if(this._values){let t=!1;this._values.forEach((s=>{s?-1===s.indexOf(e)&&(s.push(e),t=!0):(s=[e],t=!0)})),t&&(this._onMultipleValuesChange(this._values),this.emit("change",this.value),this._binding&&this._binding.addValues([e]))}else this._value&&Array.isArray(this._value)?-1===this._value.indexOf(e)&&(this._value.push(e),this._addTag(e),this.emit("change",this.value),this._binding&&this._binding.addValues([e])):this.value=[e];else this.value=e}_highlightLabel(e){if(this._labelHighlighted!==e&&(this._labelHighlighted&&this._labelHighlighted.class.remove(bh),this._labelHighlighted=e,this._labelHighlighted)){this._labelHighlighted.class.add(bh);const e=this._labelHighlighted.dom.offsetTop,t=this._containerOptions.dom.scrollTop;e<t?this._containerOptions.dom.scrollTop=e:e+this._labelHighlighted.height>this._containerOptions.height+t&&(this._containerOptions.dom.scrollTop=e+this._labelHighlighted.height-this._containerOptions.height)}}_onValueChange(e){if(this.multiSelect){if(this._labelValue.value="",this._containerTags.clear(),this._containerTags.class.add(mh),e&&Array.isArray(e)){for(const t of e){this._addTag(t);const e=this._valueToLabel[t];e&&e.class.add(yh)}for(const t in this._valueToLabel){const s=this._valueToLabel[t];-1!==e.indexOf(this._convertSingleValue(t))?s.class.add(yh):s.class.remove(yh)}}}else{this._labelValue.value=this._prefix+(this._valueToText[e]||""),e=""+e;for(const t in this._valueToLabel){const s=this._valueToLabel[t];t===e?s.class.add(yh):s.class.remove(yh)}}}_onMultipleValuesChange(e){this._labelValue.value="",this._containerTags.clear(),this._containerTags.class.add(mh);const t={},s={};e.forEach((e=>{e&&e.forEach((e=>{t[e]?s[e]++:(t[e]=this._addTag(e),s[e]=1)}))}));for(const i in s)if(s[i]!==e.length){t[i].class.add(fh);const e=this._valueToLabel[i];e&&e.class.remove(yh)}}_addTag(e){const t=new $o({flex:!0,flexDirection:"row",class:_h});t.append(new Jo({text:this._valueToText[e]||e}));const s=new tl({size:"small",icon:"E132",tabIndex:-1});t.append(s),s.on("click",(()=>this._removeTag(t,e))),this._containerTags.append(t),this._containerTags.class.remove(mh);const i=this._valueToLabel[e];return i&&i.class.add(yh),t.value=e,t}_removeTag(e,t){e.destroy();const s=this._valueToLabel[t];if(s&&s.class.remove(yh),this._values)this._values.forEach((e=>{if(!e)return;const s=e.indexOf(t);-1!==s&&e.splice(s,1)}));else if(this._value&&Array.isArray(this._value)){const e=this._value.indexOf(t);-1!==e&&this._value.splice(e,1)}this.emit("change",this.value),this._binding&&this._binding.removeValues([t])}_filterOptions(e){const t=this._containerOptions.dom;for(;t.firstChild;)t.removeChild(t.lastChild);if(e){const s=this.options.map((e=>[e.t,e.v]));ih(s,e).forEach((e=>{const s=this._valueToLabel[e];t.appendChild(s.dom)}))}else for(const e of this._options){const s=this._valueToLabel[e.v];t.appendChild(s.dom)}this._createLabelContainer&&t.appendChild(this._createLabelContainer.dom),t.firstChild&&this._highlightLabel(t.firstChild.ui),this._resizeShadow()}_resizeShadow(){this._domShadow.style.height=this._containerValue.height+this._containerOptions.height+"px"}_updateInputFieldsVisibility(e){let t=!1,s=!1;this._allowInput&&(e?(t=!0,s=!0):t=this.multiSelect||!this._valueToLabel[this.value]),this._labelValue.hidden=t,this._labelIcon.hidden=t,this._input.hidden=!t,s&&this._input.focus(),this._labelValue.hidden||(this._labelValue.tabIndex=-1,this._timeoutLabelValueTabIndex||(this._timeoutLabelValueTabIndex=requestAnimationFrame((()=>{this._timeoutLabelValueTabIndex=null,this._labelValue.tabIndex=0}))))}focus(){this._input.hidden?this._labelValue.dom.focus():this._input.focus()}blur(){this._allowInput?this._input.blur():this._labelValue.dom.blur()}open(){if(!this._containerOptions.hidden||!this.enabled||this.readOnly)return;if(this._updateInputFieldsVisibility(!0),this._optionsFn&&(this.options=this._optionsFn()),0===this._containerOptions.dom.childNodes.length)return;this._containerOptions.forEachChild((e=>{e.hidden=!1,this._labelToValue.get(e)===this.value&&this._highlightLabel(e)})),this._labelHighlighted||this._highlightLabel(this._containerOptions.dom.childNodes[0].ui),this._containerOptions.hidden=!1,this.class.add(wh),window.addEventListener("keydown",this._onKeyDown),window.addEventListener("mousedown",this._onWindowMouseDown);const e=(this._allowInput?this._input.dom:this._labelValue.dom).getBoundingClientRect();let t=e.bottom+this._containerOptions.height+25>=window.innerHeight;t&&e.top-this._containerOptions.height<0&&(t=!1,this._containerOptions.style.maxHeight=window.innerHeight-e.bottom-25+"px"),t?this.class.add(vh):this.class.remove(vh),this._resizeShadow()}close(){this._containerOptions.style.maxHeight="",this._highlightLabel(null),this._updateInputFieldsVisibility(!1),this._suspendInputChange=!0,this._input.value="",this._lastInputValue&&(this._lastInputValue="",this._filterOptions(null)),this._suspendInputChange=!1,this._containerOptions.hidden||(this._containerOptions.hidden=!0,this._domShadow.style.height="",this.class.remove(wh),window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("mousedown",this._onWindowMouseDown))}toggle(){this._containerOptions.hidden?this.open():this.close()}unlink(){super.unlink(),this._containerOptions.hidden||this.close()}_updateValue(e){e!==this._value&&(this._value=e,this._onValueChange(e),this._suppressChange||this.emit("change",e),this._binding&&this._binding.setValue(e))}_updateDisabledValue(e){const t={};this._containerOptions.forEachChild((e=>{t[e.dom.id]=e,this._disabledOptions[e.dom.id]?(e.enabled=!1,e.text=this._disabledOptions[e.dom.id]):(e.enabled=!0,e.text=this._valueToText[e.dom.id]),e.class.remove(oh)}));const s=this._disabledOptions[e]?e:null;let i=null;if(s){if(this._fallbackOrder)for(let t=0;t<this._fallbackOrder.length;t++)if(this._fallbackOrder[t]!==e){i=this._fallbackOrder[t];break}this.disabledValue=s,t[s].class.add(oh)}else this._disabledValue?(i=this._disabledValue,this.disabledValue=null):(i=e,this.disabledValue=null);return i}set options(e){if(!this._options||JSON.stringify(this._options)!==JSON.stringify(e)){this._containerOptions.clear(),this._labelHighlighted=null,this._valueToText={},this._valueToLabel={},this._options=e;for(const e of this._options){if(this._valueToText[e.v]=e.t,""===e.v)return;const t=new Jo({text:e.t,tabIndex:-1,id:e.v});this._labelToValue.set(t,e.v),this._valueToLabel[e.v]=t,t.on("click",(t=>{t.stopPropagation(),this._onSelectValue(e.v),this.close(),this._onSelect&&this._onSelect(this.value)})),this._containerOptions.append(t)}this._createLabelContainer=null,this._createLabelText&&(this._createLabelContainer=this._initializeCreateLabel()),this.multiSelect&&this._values?this._onMultipleValuesChange(this._values):this._onValueChange(this.value),this._lastInputValue&&this._filterOptions(this._lastInputValue)}}get options(){return this._options.slice()}set invalidOptions(e){this._invalidOptions=e||null}get invalidOptions(){return this._invalidOptions}set disabledValue(e){this._disabledValue=e,null!==this._disabledValue?this.class.add(lh):this.class.remove(lh)}set disabledOptions(e){if(JSON.stringify(this._disabledOptions)===JSON.stringify(e))return;this._disabledOptions=e||{};const t=this._updateDisabledValue(this._value);this._updateValue(t)}set fallbackOrder(e){this._fallbackOrder=e||null}get multiSelect(){return this.class.contains(ah)}set value(e){this._values=null,this._suspendInputChange=!0,this._input.value="",this._lastInputValue&&(this._lastInputValue="",this._filterOptions(null)),this._suspendInputChange=!1,this.class.remove(Oo),e=this._convertValue(e),(!(this._value===e||this.multiSelect&&this._value&&this._value.equals(e))||null===e&&this._allowNull&&this.class.contains(Oo))&&(this.disabledValue=null,this._updateValue(e))}get value(){if(!this.multiSelect)return this._value;const e=[];return this._containerTags.dom.childNodes.forEach((t=>{e.push(t.ui.value)})),e}set values(e){e=e.map((e=>this._convertValue(e)));let t=!1;const s=e[0],i=this.multiSelect;this._values=null;for(let n=1;n<e.length;n++)if(!(e[n]===s||i&&e[n]&&e[n].equals(s))){t=!0;break}t?(this._labelValue.values=e,i?(this._values=e,this._value=null,this._onMultipleValuesChange(this._values),this.emit("change",this.value)):null!==this._value&&(this._value=null,this.emit("change",null)),this.class.add(Oo)):this.value=e[0]}set placeholder(e){this._input.placeholder=e}get placeholder(){return this._input.placeholder}set renderChanges(e){this._renderChanges=e}get renderChanges(){return this._renderChanges}}Go.register("select",Sh,{renderChanges:!0}),Go.register("multiselect",Sh,{multiSelect:!0,renderChanges:!0}),Go.register("tags",Sh,{allowInput:!0,allowCreate:!0,multiSelect:!0,renderChanges:!0});var Ch=Sh;const Th={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:function(e,t,s){return e>=s?s:e<=t?t:e},intToBytes24:function(e){return[e>>16&255,e>>8&255,255&e]},intToBytes32:function(e){return[e>>24&255,e>>16&255,e>>8&255,255&e]},bytesToInt24:function(e,t,s){return e.length&&(s=e[2],t=e[1],e=e[0]),e<<16|t<<8|s},bytesToInt32:function(e,t,s,i){return e.length&&(i=e[3],s=e[2],t=e[1],e=e[0]),(e<<24|t<<16|s<<8|i)>>>0},lerp:function(e,t,s){return e+(t-e)*Th.clamp(s,0,1)},lerpAngle:function(e,t,s){return t-e>180&&(t-=360),t-e<-180&&(t+=360),Th.lerp(e,t,Th.clamp(s,0,1))},powerOfTwo:function(e){return 0!==e&&!(e&e-1)},nextPowerOfTwo:function(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e},nearestPowerOfTwo:function(e){return Math.pow(2,Math.round(Math.log(e)/Math.log(2)))},random:function(e,t){const s=t-e;return Math.random()*s+e},smoothstep:function(e,t,s){return s<=e?0:s>=t?1:(s=(s-e)/(t-e))*s*(3-2*s)},smootherstep:function(e,t,s){return s<=e?0:s>=t?1:(s=(s-e)/(t-e))*s*s*(s*(6*s-15)+10)},roundUp:function(e,t){return 0===t?e:Math.ceil(e/t)*t},between:function(e,t,s,i){const n=Math.min(t,s),r=Math.max(t,s);return i?e>=n&&e<=r:e>n&&e<r}},Ah=function(){const e={},t=["Array","Object","Function","Date","RegExp","Float32Array"];for(let s=0;s<t.length;s++)e["[object "+t[s]+"]"]=t[s].toLowerCase();return e}();function Eh(e){if(null===e)return"null";const t=typeof e;return"undefined"===t||"number"===t||"string"===t||"boolean"===t?t:Ah[Object.prototype.toString.call(e)]}function Ph(e,t){for(const s in t){const i=t[s];"object"===Eh(i)?e[s]=Ph({},i):"array"===Eh(i)?e[s]=Ph([],i):e[s]=i}return e}class Mh{constructor(e,t=0){this._curve=void 0,this._left=-1/0,this._right=1/0,this._recip=0,this._p0=0,this._p1=0,this._m0=0,this._m1=0,this._curve=e,this._reset(t)}evaluate(e,t=!1){let s;(t||e<this._left||e>=this._right)&&this._reset(e);const i=this._curve.type;if(5===i)s=this._p0;else{const t=0===this._recip?0:(e-this._left)*this._recip;s=0===i?Th.lerp(this._p0,this._p1,t):1===i?Th.lerp(this._p0,this._p1,t*t*(3-2*t)):this._evaluateHermite(this._p0,this._p1,this._m0,this._m1,t)}return s}_reset(e){const t=this._curve.keys,s=t.length;if(s)if(e<t[0][0])this._left=-1/0,this._right=t[0][0],this._recip=0,this._p0=this._p1=t[0][1],this._m0=this._m1=0;else if(e>=t[s-1][0])this._left=t[s-1][0],this._right=1/0,this._recip=0,this._p0=this._p1=t[s-1][1],this._m0=this._m1=0;else{let s=0;for(;e>=t[s+1][0];)s++;this._left=t[s][0],this._right=t[s+1][0];const i=1/(this._right-this._left);this._recip=isFinite(i)?i:0,this._p0=t[s][1],this._p1=t[s+1][1],this._isHermite()&&this._calcTangents(t,s)}else this._left=-1/0,this._right=1/0,this._recip=0,this._p0=this._p1=this._m0=this._m1=0}_isHermite(){return 2===this._curve.type||3===this._curve.type||4===this._curve.type}_calcTangents(e,t){let s;const i=e[t],n=e[t+1];let r;if(s=0===t?[e[0][0]+(e[0][0]-e[1][0]),e[0][1]+(e[0][1]-e[1][1])]:e[t-1],r=t===e.length-2?[e[t+1][0]+(e[t+1][0]-e[t][0]),e[t+1][1]+(e[t+1][1]-e[t][1])]:e[t+2],4===this._curve.type){const e=2*(n[0]-i[0])/(n[0]-s[0]),t=2*(n[0]-i[0])/(r[0]-i[0]);this._m0=this._curve.tension*(isFinite(e)?e:0)*(n[1]-s[1]),this._m1=this._curve.tension*(isFinite(t)?t:0)*(r[1]-i[1])}else{const e=(n[0]-i[0])/(i[0]-s[0]),t=(n[0]-i[0])/(r[0]-n[0]),a=i[1]+(s[1]-i[1])*(isFinite(e)?e:0),o=n[1]+(r[1]-n[1])*(isFinite(t)?t:0),l=2===this._curve.type?.5:this._curve.tension;this._m0=l*(n[1]-a),this._m1=l*(o-i[1])}}_evaluateHermite(e,t,s,i,n){const r=n*n,a=n+n,o=1-n,l=o*o;return e*((1+a)*l)+s*(n*l)+t*(r*(3-a))+i*(r*(n-1))}}class Lh{constructor(e){if(this.keys=[],this.type=1,this.tension=.5,this._eval=new Mh(this),e)for(let t=0;t<e.length-1;t+=2)this.keys.push([e[t],e[t+1]]);this.sort()}get length(){return this.keys.length}add(e,t){const s=this.keys,i=s.length;let n=0;for(;n<i&&!(s[n][0]>e);n++);const r=[e,t];return this.keys.splice(n,0,r),r}get(e){return this.keys[e]}sort(){this.keys.sort((function(e,t){return e[0]-t[0]}))}value(e){return this._eval.evaluate(e,!0)}closest(e){const t=this.keys,s=t.length;let i=2,n=null;for(let r=0;r<s;r++){const s=Math.abs(e-t[r][0]);if(!(i>=s))break;i=s,n=t[r]}return n}clone(){const e=new this.constructor;return e.keys=Ph(e.keys,this.keys),e.type=this.type,e.tension=this.tension,e}quantize(e){e=Math.max(e,2);const t=new Float32Array(e),s=1/(e-1);t[0]=this._eval.evaluate(0,!0);for(let i=1;i<e;i++)t[i]=this._eval.evaluate(s*i);return t}quantizeClamped(e,t,s){const i=this.quantize(e);for(let e=0;e<i.length;++e)i[e]=Math.min(s,Math.max(t,i[e]));return i}}class Dh{constructor(){if(this.curves=[],this._type=1,arguments.length>1)for(let e=0;e<arguments.length;e++)this.curves.push(new Lh(arguments[e]));else if(0===arguments.length)this.curves.push(new Lh);else{const e=arguments[0];if("number"==typeof e)for(let t=0;t<e;t++)this.curves.push(new Lh);else for(let t=0;t<e.length;t++)this.curves.push(new Lh(e[t]))}}get length(){return this.curves.length}set type(e){this._type=e;for(let t=0;t<this.curves.length;t++)this.curves[t].type=e}get type(){return this._type}get(e){return this.curves[e]}value(e,t=[]){const s=this.curves.length;t.length=s;for(let i=0;i<s;i++)t[i]=this.curves[i].value(e);return t}clone(){const e=new this.constructor;e.curves=[];for(let t=0;t<this.curves.length;t++)e.curves.push(this.curves[t].clone());return e._type=this._type,e}quantize(e){e=Math.max(e,2);const t=this.curves.length,s=new Float32Array(e*t),i=1/(e-1);for(let n=0;n<t;n++){const r=new Mh(this.curves[n]);for(let a=0;a<e;a++)s[a*t+n]=r.evaluate(i*a)}return s}quantizeClamped(e,t,s){const i=this.quantize(e);for(let e=0;e<i.length;++e)i[e]=Math.min(s,Math.max(t,i[e]));return i}}const kh="pcui-multiple-values",Ih=/keys/,Rh=/type/;class Oh extends Go{constructor(e={}){var t;super(e),this._onKeyDown=e=>{"Escape"===e.key&&this.blur(),"Enter"!==e.key||!this.enabled||this.readOnly||this.class.contains(kh)||(e.stopPropagation(),e.preventDefault(),this._openGradientPicker())},this._onFocus=e=>{this.emit("focus")},this._onBlur=e=>{this.emit("blur")},this._onAnchorsMouseDown=e=>{if(-1===this.STATE.hoveredAnchor){const t=this.calcNormalizedCoord(e.clientX,e.clientY,this.getClientRect(this.UI.anchors.dom));this.insertAnchor(t[0],this.evaluateGradient(t[0])),this.STATE.anchors=this.calcAnchorTimes(),this.selectAnchor(this.STATE.anchors.indexOf(t[0]))}else this.STATE.hoveredAnchor!==this.STATE.selectedAnchor&&this.selectAnchor(this.STATE.hoveredAnchor);this.UI.anchors.dom.style.cursor="grabbing",this.UI.anchorAddCrossHair.style.visibility="hidden",this.dragStart(),this.UI.draggingAnchor=!0},this._onAnchorsMouseMove=e=>{const t=this.calcNormalizedCoord(e.clientX,e.clientY,this.getClientRect(this.UI.anchors.dom));if(this.UI.draggingAnchor)this.dragUpdate(Th.clamp(t[0],0,1)),this.UI.anchorAddCrossHair.style.visibility="hidden";else if(t[0]>=0&&t[0]<=1&&t[1]>=0&&t[1]<=1){let e=-1,s=0;for(let i=0;i<this.STATE.anchors.length;++i){const n=Math.abs(this.STATE.anchors[i]-t[0]);(-1===e||n<s)&&(e=i,s=n)}const i=-1!==e&&s<.02?e:-1;i!==this.STATE.hoveredAnchor&&(this.selectHovered(i),this.render()),-1===i?(this.UI.anchorAddCrossHair.style.visibility="visible",this.UI.anchors.dom.style.cursor="none"):this.UI.anchorAddCrossHair.style.visibility="hidden",this.UI.showCrosshairPosition.innerText=Math.round(100*t[0]).toString(),this.UI.anchorAddCrossHair.style.left=(2.5+320*t[0]).toString()+"px"}else-1!==this.STATE.hoveredAnchor?(this.UI.anchorAddCrossHair.style.visibility="hidden",this.selectHovered(-1),this.render()):this.UI.anchorAddCrossHair.style.visibility="hidden"},this._onAnchorsMouseUp=e=>{this.UI.draggingAnchor&&(this.dragEnd(),this.UI.draggingAnchor=!1),this.UI.anchors.dom.style.cursor="pointer"},this.class.add("pcui-gradient"),this._canvas=new Il({useDevicePixelRatio:!0}),this.dom.appendChild(this._canvas.dom),this._canvas.parent=this,this._canvas.on("resize",(()=>{this._renderGradient()}));const s=this._canvas.dom;function i(e,t){return function(s){t.apply(e,[s])}}function n(e){const t=new vl({precision:1,step:1,min:0,max:255});return t.renderChanges=!1,t.placeholder=e,t.on("change",this.fieldChangeHandler),this._fields.appendChild(t.dom),t}this._checkerboardPattern=this._createCheckerboardPattern(s.getContext("2d")),this._resizeInterval=window.setInterval((()=>{this._canvas.resize(this.width,this.height)}),50),this.dom.addEventListener("keydown",this._onKeyDown),this.dom.addEventListener("focus",this._onFocus),this.dom.addEventListener("blur",this._onBlur),this.on("click",(()=>{!this.enabled||this.readOnly||this.class.contains(kh)||this._openGradientPicker()})),this.renderChanges=null===(t=e.renderChanges)||void 0===t||t,this.on("change",(()=>{this.renderChanges&&this.flash()})),this.Helpers={rgbaStr:function(e,t){t||(t=1);let s=e.map((function(e,s){return s<3?Math.round(e*t):e})).join(",");for(let i=e.length;i<4;++i)s+=","+(i<3?t:1);return"rgba("+s+")"},hexStr:function(e){return e.map((function(e){return("00"+e.toString(16)).slice(-2).toUpperCase()})).join("")},toHsva:function(e){const t=Kl(e.map((function(e){return 255*e})));return t.push(e.length>3?e[3]:1),t},toRgba:function(e){const t=Xl(e).map((function(e){return e/255}));return t.push(e.length>3?e[3]:1),t},normalizedCoord:function(e,t,s){const i=e.dom.getBoundingClientRect();return[(t-i.left)/i.width,(s-i.top)/i.height]}},this._panel=new cl,this._panel.class.add("color-panel"),this.dom.appendChild(this._panel.dom),this._colorRect=new Il({useDevicePixelRatio:!0}),this._colorRect.class.add("color-rect"),this._panel.append(this._colorRect.dom),this._colorRect.resize(140,140),this._colorHandle=document.createElement("div"),this._colorHandle.classList.add("color-handle"),this._panel.append(this._colorHandle),this._hueRect=new Il({useDevicePixelRatio:!0}),this._hueRect.class.add("hue-rect"),this._panel.append(this._hueRect.dom),this._hueRect.resize(20,140),this._hueHandle=document.createElement("div"),this._hueHandle.classList.add("hue-handle"),this._panel.append(this._hueHandle),this._alphaRect=new Il({useDevicePixelRatio:!0}),this._alphaRect.class.add("alpha-rect"),this._panel.append(this._alphaRect.dom),this._alphaRect.resize(20,140),this._alphaHandle=document.createElement("div"),this._alphaHandle.classList.add("alpha-handle"),this._panel.append(this._alphaHandle),this._fields=document.createElement("div"),this._fields.classList.add("fields"),this._panel.append(this._fields),this.fieldChangeHandler=i(this,this._onFieldChanged),this.hexChangeHandler=i(this,this._onHexChanged),this.downHandler=i(this,this._onMouseDown),this.moveHandler=i(this,this._onMouseMove),this.upHandler=i(this,this._onMouseUp),this._rField=n.call(this,"r"),this._gField=n.call(this,"g"),this._bField=n.call(this,"b"),this._aField=n.call(this,"a"),this._hexField=new ql,this._hexField.renderChanges=!1,this._hexField.placeholder="#",this._hexField.on("change",this.hexChangeHandler),this._fields.appendChild(this._hexField.dom),this._colorRect.dom.addEventListener("mousedown",this.downHandler),this._hueRect.dom.addEventListener("mousedown",this.downHandler),this._alphaRect.dom.addEventListener("mousedown",this.downHandler),this._generateHue(this._hueRect),this._generateAlpha(this._alphaRect),this._hsva=[-1,-1,-1,1],this._storeHsva=[0,0,0,1],this._dragMode=0,this._changing=!1,this.CONSTANTS={bg:"#2c393c",anchorRadius:5,selectedRadius:7},this.UI={root:this.dom,overlay:new Gl,panel:document.createElement("div"),gradient:new Il({useDevicePixelRatio:!0}),checkerPattern:this.createCheckerPattern(),anchors:new Il({useDevicePixelRatio:!0}),footer:new cl,typeLabel:new Jo({text:"Type"}),typeCombo:new Ch({options:[{t:"0",v:"placeholder"}],type:"number"}),positionLabel:new Jo({text:"Position"}),positionEdit:new vl({min:0,max:100,step:1}),copyButton:new tl,pasteButton:new tl,deleteButton:new tl,showSelectedPosition:new vl({min:0,max:100,step:1,hideSlider:!0}),showCrosshairPosition:document.createElement("div"),anchorAddCrossHair:document.createElement("div"),colorPicker:null},this.STATE={curves:[],keystore:[],anchors:[],hoveredAnchor:-1,selectedAnchor:-1,selectedValue:[],changing:!1,draggingAnchor:!1,typeMap:{}},this.UI.root.appendChild(this.UI.overlay.dom),this.UI.overlay.class.add("picker-gradient"),this.UI.overlay.center=!1,this.UI.overlay.transparent=!0,this.UI.overlay.hidden=!0,this.UI.overlay.clickable=!0,this.UI.overlay.dom.style.position="fixed",this.UI.overlay.on("show",(()=>{this.onOpen()})),this.UI.overlay.on("hide",(()=>{this.onClose()})),this.UI.panel.classList.add("picker-gradient-panel"),this.UI.overlay.append(this.UI.panel),this.UI.panel.appendChild(this.UI.gradient.dom),this.UI.gradient.class.add("picker-gradient-gradient"),this.UI.gradient.resize(320,28),this.UI.panel.appendChild(this.UI.anchors.dom),this.UI.anchors.class.add("picker-gradient-anchors"),this.UI.anchors.resize(320,28),this.UI.panel.appendChild(this.UI.footer.dom),this.UI.footer.append(this.UI.typeLabel),this.UI.footer.class.add("picker-gradient-footer"),this.UI.footer.append(this.UI.typeCombo),this.UI.typeCombo.value=-1,this.UI.typeCombo.on("change",(e=>{this._onTypeChanged(e)})),this.UI.positionEdit.style.width="40px",this.UI.positionEdit.renderChanges=!1,this.UI.showSelectedPosition.on("change",(e=>{this.STATE.changing||this.moveSelectedAnchor(e/100)})),this.UI.copyButton.on("click",(()=>{this.doCopy()})),this.UI.copyButton.class.add("copy-curve-button"),this.UI.footer.append(this.UI.copyButton),this.UI.pasteButton.on("click",(()=>{this.doPaste()})),this.UI.pasteButton.class.add("paste-curve-button"),this.UI.footer.append(this.UI.pasteButton),this.UI.deleteButton.on("click",(()=>{this.doDelete()})),this.UI.deleteButton.class.add("delete-curve-button"),this.UI.footer.append(this.UI.deleteButton),this.UI.panel.appendChild(this._panel.dom),this.UI.panel.append(this.UI.showSelectedPosition.dom),this.UI.showSelectedPosition.class.add("show-selected-position"),this.UI.showSelectedPosition._domInput.classList.add("show-selected-position-input");const r=document.createElementNS("http://www.w3.org/2000/svg","path");r.setAttribute("fill-rule","evenodd"),r.setAttribute("clip-rule","evenodd"),r.setAttribute("d","M8.5 17C7.35596 17 6.26043 16.7741 5.2134 16.3222C4.16637 15.8703 3.26152 15.2629 2.49882 14.4997C1.73612 13.7366 1.12899 12.8312 0.677391 11.7835C0.225795 10.7359 0 9.6397 0 8.49498C0 7.35026 0.225795 6.25409 0.677391 5.20644C1.12899 4.15879 1.73612 3.25507 2.49882 2.49527C3.26152 1.73548 4.16637 1.12965 5.2134 0.677791C6.26043 0.225928 7.35596 0 8.5 0C9.64404 0 10.7396 0.225928 11.7866 0.677791C12.8336 1.12965 13.7385 1.73548 14.5012 2.49527C15.2639 3.25507 15.871 4.15879 16.3226 5.20644C16.7742 6.25409 17 7.35026 17 8.49498C17 9.6397 16.7742 10.7359 16.3226 11.7835C15.871 12.8312 15.2639 13.7366 14.5012 14.4997C13.7385 15.2629 12.8336 15.8703 11.7866 16.3222C10.7396 16.7741 9.64404 17 8.5 17ZM8.5 2.2593C7.64364 2.2593 6.82576 2.42498 6.04634 2.75635C5.26692 3.08772 4.59622 3.53288 4.03424 4.09185C3.47225 4.65082 3.02568 5.31354 2.69451 6.08004C2.36334 6.84653 2.19776 7.6515 2.19776 8.49498C2.19776 9.6397 2.47875 10.6957 3.04073 11.663C3.60272 12.6303 4.36707 13.3952 5.33383 13.9575C6.30058 14.5198 7.35596 14.8009 8.5 14.8009C9.34298 14.8009 10.1475 14.6353 10.9135 14.3039C11.6796 13.9725 12.3419 13.5257 12.9005 12.9634C13.4592 12.4011 13.9041 11.73 14.2352 10.9501C14.5664 10.1702 14.732 9.35184 14.732 8.49498C14.732 7.6515 14.5664 6.84653 14.2352 6.08004C13.9041 5.31354 13.4592 4.65082 12.9005 4.09185C12.3419 3.53288 11.6796 3.08772 10.9135 2.75635C10.1475 2.42498 9.34298 2.2593 8.5 2.2593ZM9.52361 9.73007V12.9533H7.40614V9.73007H4.11452V7.61134H7.40614V4.31778H9.52361V7.61134H12.745V9.73007H9.52361Z"),r.setAttribute("fill","#FF6600");const a=document.createElementNS("http://www.w3.org/2000/svg","svg"),o=document.createElement("div");a.appendChild(r),a.setAttribute("width","17"),a.setAttribute("height","17"),a.setAttribute("viewBox","0 0 17 17"),this.UI.showCrosshairPosition.classList.add("show-crosshair-position"),o.classList.add("crosshair-bar"),this.UI.anchorAddCrossHair.appendChild(a),this.UI.anchorAddCrossHair.appendChild(o),this.UI.anchorAddCrossHair.appendChild(this.UI.showCrosshairPosition),this.UI.anchorAddCrossHair.classList.add("anchor-crosshair"),this.UI.anchorAddCrossHair.style.visibility="hidden",this.UI.panel.append(this.UI.anchorAddCrossHair),this.on("changing",(function(e){this.colorSelectedAnchor(e,!0)})),this._copiedData=null,this._channels=e.channels||3,this._value=this._getDefaultValue(),e.value&&(this.value=e.value)}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),this.dom.removeEventListener("focus",this._onFocus),this.dom.removeEventListener("blur",this._onBlur),window.clearInterval(this._resizeInterval),super.destroy())}_createCheckerboardPattern(e){const t=document.createElement("canvas"),s=12;t.width=24,t.height=24;const i=t.getContext("2d");return i.fillStyle="#",i.fillStyle="#949a9c",i.fillRect(0,0,s,s),i.fillRect(s,s,s,s),i.fillStyle="#657375",i.fillRect(s,0,s,s),i.fillRect(0,s,s,s),e.createPattern(t,"repeat")}_getDefaultValue(){return{type:4,keys:new Array(this._channels).fill([0,0]),betweenCurves:!1}}_openGradientPicker(){this.callOpenGradientPicker([this.value||this._getDefaultValue()]);const e=this.getGradientPickerRect(),t=this.dom.getBoundingClientRect();this.positionGradientPicker(t.right-e.width,t.bottom),this._evtPickerChanged=this.on("picker:curve:change",this._onPickerChange.bind(this)),this._evtRefreshPicker=this.on("change",(()=>this.setGradientPicker([this.value])))}_onPickerChange(e,t){const s=this.value||this._getDefaultValue();Ih.test(e[0])?this.value={type:s.type,keys:t,betweenCurves:!1}:Rh.test(e[0])&&(this.value={type:t[0],keys:s.keys,betweenCurves:!1})}_renderGradient(){const e=this._canvas.dom.getContext("2d"),t=this._canvas.width,s=this._canvas.height,i=this._canvas.pixelRatio;if(e.setTransform(i,0,0,i,0,0),e.fillStyle=this._checkerboardPattern,e.fillRect(0,0,t,s),!this.value||!this.value.keys||!this.value.keys.length)return;const n=[],r=1===this.channels?new Dh([this.value.keys]):new Dh(this.value.keys);r.type=this.value.type;const a=e.createLinearGradient(0,0,t,0);for(let e=2;e<t;e+=2){r.value(e/t,n);const s=Math.round(255*(n[0]||0)),i=Math.round(255*(n[1]||0)),o=Math.round(255*(n[2]||0)),l=4===this.channels?n[3]||0:1;a.addColorStop(e/t,`rgba(${s}, ${i}, ${o}, ${l})`)}e.fillStyle=a,e.fillRect(0,0,t,s)}focus(){this.dom.focus()}blur(){this.dom.blur()}set channels(e){this._channels!==e&&(this._channels=Math.max(1,Math.min(e,4)),this.value&&this._renderGradient())}get channels(){return this._channels}set value(e){this._value=e,this.class.remove(kh),this._renderGradient(),this.emit("change",e),this.setValue([e])}get value(){return this._value}set values(e){this.class.add(kh),this._renderGradient()}_generateHue(e){const t=e.dom.getContext("2d"),s=e.pixelWidth,i=e.pixelHeight,n=t.createLinearGradient(0,0,0,i);for(let e=0;e<=6;e+=1)n.addColorStop(e/6,this.Helpers.rgbaStr(Xl([e/6,1,1])));t.fillStyle=n,t.fillRect(0,0,s,i)}_generateAlpha(e){const t=e.dom.getContext("2d"),s=e.pixelWidth,i=e.pixelHeight,n=t.createLinearGradient(0,0,0,i);n.addColorStop(0,"rgb(255, 255, 255)"),n.addColorStop(1,"rgb(0, 0, 0)"),t.fillStyle=n,t.fillRect(0,0,s,i)}_generateGradient(e,t){const s=e.dom.getContext("2d"),i=e.pixelWidth,n=e.pixelHeight;let r=s.createLinearGradient(0,0,i,0);r.addColorStop(0,this.Helpers.rgbaStr([255,255,255,255])),r.addColorStop(1,this.Helpers.rgbaStr([t[0],t[1],t[2],255])),s.fillStyle=r,s.fillRect(0,0,i,n),r=s.createLinearGradient(0,0,0,n),r.addColorStop(0,"rgba(0, 0, 0, 0)"),r.addColorStop(1,"rgba(0, 0, 0, 255)"),s.fillStyle=r,s.fillRect(0,0,i,n)}_onFieldChanged(){if(!this._changing){const e=[this._rField.value,this._gField.value,this._bField.value,this._aField.value].map((function(e){return e/255}));this.hsva=this.Helpers.toHsva(e),this.colorSelectedAnchor(this.color)}}_onHexChanged(){if(!this._changing){const e=this._hexField.value.trim().toLowerCase();if(/^([0-9a-f]{2}){3,4}$/.test(e)){const t=[parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16)];this.hsva=Kl(t).concat([this.hsva[3]]),this.colorSelectedAnchor(this.color)}}}_onMouseDown(e){e.currentTarget===this._colorRect.dom?this._dragMode=1:e.currentTarget===this._hueRect.dom?this._dragMode=2:this._dragMode=3,this._storeHsva=this._hsva.slice(),this._onMouseMove(e),window.addEventListener("mousemove",this.moveHandler),window.addEventListener("mouseup",this.upHandler)}_onMouseMove(e){let t;if(1===this._dragMode){const s=this.Helpers.normalizedCoord(this._colorRect,e.pageX,e.pageY),i=Th.clamp(s[0],0,1),n=Th.clamp(s[1],0,1);t=[this.hsva[0],i,1-n,this._hsva[3]]}else if(2===this._dragMode){const s=this.Helpers.normalizedCoord(this._hueRect,e.pageX,e.pageY);t=[Th.clamp(s[1],0,1),this.hsva[1],this.hsva[2],this.hsva[3]]}else{const s=this.Helpers.normalizedCoord(this._alphaRect,e.pageX,e.pageY),i=Th.clamp(s[1],0,1);t=[this.hsva[0],this.hsva[1],this.hsva[2],1-i]}t[0]===this._hsva[0]&&t[1]===this._hsva[1]&&t[2]===this._hsva[2]&&t[3]===this._hsva[3]||(this.hsva=t,this.emit("changing",this.color))}_onMouseUp(e){window.removeEventListener("mousemove",this.moveHandler),window.removeEventListener("mouseup",this.upHandler),this._storeHsva[0]===this._hsva[0]&&this._storeHsva[1]===this._hsva[1]&&this._storeHsva[2]===this._hsva[2]&&this._storeHsva[3]===this._hsva[3]||this.colorSelectedAnchor(this.color)}set hsva(e){const t=Xl(e),s=Xl([e[0],1,1]);e[0]!==this._hsva[0]&&this._generateGradient(this._colorRect,s);const i=this._colorRect.dom,n=i.getBoundingClientRect(),r=n.width-2,a=n.height-2;this._colorHandle.style.backgroundColor=this.Helpers.rgbaStr(t),this._colorHandle.style.left=i.offsetLeft-7+Math.floor(r*e[1])+"px",this._colorHandle.style.top=i.offsetTop-7+Math.floor(a*(1-e[2]))+"px",this._hueHandle.style.backgroundColor=this.Helpers.rgbaStr(s),this._hueHandle.style.top=i.offsetTop-3+Math.floor(140*e[0])+"px",this._hueHandle.style.left="162px",this._alphaHandle.style.backgroundColor=this.Helpers.rgbaStr(Xl([0,0,e[3]])),this._alphaHandle.style.top=i.offsetTop-3+Math.floor(140*(1-e[3]))+"px",this._alphaHandle.style.left="194px",this._changing=!0,this._rField.value=t[0],this._gField.value=t[1],this._bField.value=t[2],this._aField.value=Math.round(255*e[3]),this._hexField.value=this.Helpers.hexStr(t),this._changing=!1,this._hsva=e}get hsva(){return this._hsva}set color(e){const t=this.Helpers.toHsva(e);0===t[0]&&0===t[1]&&-1!==this._hsva[0]&&(t[0]=this._hsva[0]),this.hsva=t}get color(){return this.Helpers.toRgba(this._hsva)}set editAlpha(e){e?(this._alphaRect.dom.style.display="inline",this._alphaHandle.style.display="block",this._aField.dom.style.display="inline-block"):(this._alphaRect.dom.style.display="none",this._alphaHandle.style.display="none",this._aField.dom.style.display="none")}get editAlpha(){return this.editAlpha}open(){this.UI.overlay.hidden=!1}close(){this.UI.overlay.hidden=!0}onOpen(){window.addEventListener("mousemove",this._onAnchorsMouseMove),window.addEventListener("mouseup",this._onAnchorsMouseUp),this.UI.anchors.dom.addEventListener("mousedown",this._onAnchorsMouseDown)}onClose(){this.STATE.hoveredAnchor=-1,window.removeEventListener("mousemove",this._onAnchorsMouseMove),window.removeEventListener("mouseup",this._onAnchorsMouseUp),this.UI.anchors.dom.removeEventListener("mousedown",this._onAnchorsMouseDown),this._evtRefreshPicker.unbind(),this._evtRefreshPicker=null,this._evtPickerChanged.unbind(),this._evtPickerChanged=null}onDeleteKey(){if(!this.UI.overlay.hidden&&-1!==this.STATE.selectedAnchor){const e=this.STATE.anchors[this.STATE.selectedAnchor];this.STATE.selectedAnchor=-1,this.deleteAnchor(e)}}_onTypeChanged(e){e=this.STATE.typeMap[e];const t=[],s=[];for(let i=0;i<this.STATE.curves.length;++i)t.push(i.toString()+".type"),s.push(e);this.emit("picker:curve:change",t,s)}render(){this.renderGradient(),this.renderAnchors()}renderGradient(){const e=this.UI.gradient.dom.getContext("2d"),t=this.UI.gradient.width,s=this.UI.gradient.height,i=this.UI.gradient.pixelRatio;e.setTransform(i,0,0,i,0,0),e.fillStyle=this.UI.checkerPattern,e.fillRect(0,0,t,s);const n=e.createLinearGradient(0,0,t,0);for(let e=0;e<=t;e+=2){const s=e/t;n.addColorStop(s,this.Helpers.rgbaStr(this.evaluateGradient(s),255))}if(e.fillStyle=n,e.fillRect(0,0,t,s),-1!==this.STATE.selectedAnchor){const i=[this.STATE.anchors[this.STATE.selectedAnchor]*t,s],n=this.UI.draggingAnchor?-30:-6;e.beginPath(),e.rect(i[0]-.5,i[1],1,n),e.fillStyle="rgb(41, 53, 56)",e.fill()}}renderAnchors(){const e=this.UI.anchors.dom.getContext("2d"),t=this.UI.anchors.width,s=this.UI.anchors.height,i=this.UI.anchors.pixelRatio;e.setTransform(i,0,0,i,0,0),e.fillStyle=this.CONSTANTS.bg,e.fillRect(0,0,t,s);for(let t=0;t<this.STATE.anchors.length;++t)t!==this.STATE.hoveredAnchor&&t!==this.STATE.selectedAnchor&&this.renderAnchor(e,this.STATE.anchors[t]);-1!==this.STATE.hoveredAnchor&&this.STATE.hoveredAnchor!==this.STATE.selectedAnchor&&this.renderAnchor(e,this.STATE.anchors[this.STATE.hoveredAnchor],"hovered"),-1!==this.STATE.selectedAnchor&&this.renderAnchor(e,this.STATE.anchors[this.STATE.selectedAnchor],"selected")}renderAnchor(e,t,s){const i=[t*this.UI.anchors.width,this.UI.anchors.height/2],n="selected"===s?this.CONSTANTS.selectedRadius:this.CONSTANTS.anchorRadius;"selected"===s&&(e.beginPath(),e.rect(i[0]-.5,i[1],1,-i[1]),e.fillStyle="rgb(41, 53, 56)",e.fill()),"selected"!==s&&"hovered"!==s||(e.beginPath(),e.arc(i[0],i[1],n+2,0,2*Math.PI,!1),e.fillStyle="rgb(255, 255, 255)",e.fill()),e.beginPath(),e.arc(i[0],i[1],n+1,0,2*Math.PI,!1),e.fillStyle=this.Helpers.rgbaStr(this.evaluateGradient(t,1),255),e.fill()}evaluateGradient(e,t){const s=[];for(let t=0;t<3;++t)s.push(this.STATE.curves[t].value(e));return t?s.push(t):this.STATE.curves.length>3?s.push(this.STATE.curves[3].value(e)):s.push(1),s}calcAnchorTimes(){let e=[];for(let t=0;t<this.STATE.curves.length;t++){const s=this.STATE.curves[t];for(let t=0;t<s.keys.length;++t)e.push(s.keys[t][0])}return e.sort(),e=e.filter((function(e,t,s){return!t||e!==s[t-1]})),e}calcNormalizedCoord(e,t,s){return[(e-s.left)/s.width,(t-s.top)/s.height]}getClientRect(e){const t=window.getComputedStyle(e),s=parseFloat(t.paddingTop),i=parseFloat(t.paddingRight),n=parseFloat(t.paddingBottom),r=parseFloat(t.paddingLeft),a=e.getBoundingClientRect();return new DOMRect(a.x+r,a.y+s,a.width-i-r,a.height-s-n)}selectHovered(e){this.STATE.hoveredAnchor=e,this.UI.anchors.dom.style.cursor=-1===e?"":"pointer"}selectAnchor(e){if(this.STATE.selectedAnchor=e,this.STATE.changing=!0,-1===e)this.UI.positionEdit.value="",this.color=[0,0,0];else{const t=this.STATE.anchors[e];this.UI.positionEdit.value=Math.round(100*t),this.STATE.selectedValue=this.evaluateGradient(t),this.color=this.STATE.selectedValue,this.UI.showSelectedPosition.dom.style.left=(this.STATE.anchors[e]*this.UI.gradient.width-4).toString()+"px",this.UI.showSelectedPosition.value=Math.round(100*this.STATE.anchors[e])}this.STATE.changing=!1,this.render()}dragStart(){if(-1===this.STATE.selectedAnchor)return;const e=this.STATE.anchors[this.STATE.selectedAnchor];this.STATE.keystore=[];for(let t=0;t<this.STATE.curves.length;++t){const s=[];this.STATE.curves[t].keys.forEach((function(t){t[0]!==e&&s.push([t[0],t[1]])})),this.STATE.keystore.push(s)}}dragUpdate(e){if(-1!==this.STATE.selectedAnchor){for(let t=0;t<this.STATE.curves.length;++t){const s=this.STATE.curves[t],i=this.STATE.keystore[t];s.keys=i.map((function(e){return[e[0],e[1]]})).filter((function(t){return t[0]!==e})),s.keys.push([e,this.STATE.selectedValue[t]]),s.sort()}this.STATE.anchors=this.calcAnchorTimes(),this.selectAnchor(this.STATE.anchors.indexOf(e))}}dragEnd(){-1!==this.STATE.selectedAnchor&&this.emitCurveChange()}insertAnchor(e,t){for(let s=0;s<this.STATE.curves.length;++s){const i=this.STATE.curves[s].keys;let n=0;for(;n<i.length&&!(i[n][0]>=e);)++n;n<i.length&&i[n][0]===e?i[n][1]=t[s]:i.splice(n,0,[e,t[s]])}this.emitCurveChange()}deleteAnchor(e){for(let t=0;t<this.STATE.curves.length;++t){const s=this.STATE.curves[t];for(let t=0;t<s.keys.length;++t)if(s.keys[t][0]===e){s.keys.splice(t,1);break}}this.selectHovered(-1),this.emitCurveChange()}moveSelectedAnchor(e){-1!==this.STATE.selectedAnchor&&(this.dragStart(),this.dragUpdate(e),this.dragEnd())}colorSelectedAnchor(e,t){if(-1!==this.STATE.selectedAnchor){const s=this.STATE.anchors[this.STATE.selectedAnchor];for(let t=0;t<this.STATE.curves.length;++t){const i=this.STATE.curves[t];for(let n=0;n<i.keys.length;++n)if(i.keys[n][0]===s){i.keys[n][1]=e[t];break}}this.STATE.selectedValue=e,t?this.render():this.emitCurveChange()}}emitCurveChange(){const e=[],t=[];this.STATE.curves.forEach((function(s,i){e.push("0.keys."+i);const n=[];s.keys.forEach((function(e){n.push(e[0],e[1])})),t.push(n)})),this.emit("picker:curve:change",e,t)}doCopy(){const e={type:this.STATE.curves[0].type,keys:this.STATE.curves.map((function(e){return[].concat(...e.keys)}))};this._copiedData=e}doPaste(){const e=this._copiedData;if(null!==e){const t={type:e.type,keys:[]};for(let s=0;s<this.STATE.curves.length;++s)s<e.keys.length?t.keys.push(e.keys[s]):t.keys.push([].concat(...this.STATE.curves[s].keys));this.setValue([t]),this.emitCurveChange()}}doDelete(){const e=this.STATE.selectedAnchor;if(-1!==e&&1!==this.STATE.curves[0].keys.length){for(let t=0;t<this.STATE.curves.length;++t){this.STATE.curves[t].keys.splice(e,1)}this.emitCurveChange()}}createCheckerPattern(){const e=new Il;e.width=16,e.height=16;const t=e.dom,s=t.getContext("2d");return s.fillStyle="#949a9c",s.fillRect(0,0,8,8),s.fillRect(8,8,8,8),s.fillStyle="#657375",s.fillRect(8,0,8,8),s.fillRect(0,8,8,8),s.createPattern(t,"repeat")}setValue(e,t){if(!(e instanceof Array)||1!==e.length||void 0===e[0].keys||3!==e[0].keys.length&&4!==e[0].keys.length)return;this.STATE.typeMap={0:5,1:0,2:4};const s=Object.fromEntries(Object.entries(this.STATE.typeMap).map((([e,t])=>[t,e])));5!==e[0].type&&0!==e[0].type&&4!==e[0].type&&(this.STATE.typeMap[3]=e[0].type),this.UI.typeCombo.options=[{v:0,t:"Step"},{v:1,t:"Linear"},{v:2,t:"Spline"}],this.UI.typeCombo.value=-1===this.UI.typeCombo.value?s[this.value.type]:this.UI.typeCombo.value,this.STATE.curves=[],e[0].keys.forEach((t=>{const s=new Lh(t);s.type=e[0].type,this.STATE.curves.push(s)})),this.STATE.anchors=this.calcAnchorTimes(),0===this.STATE.anchors.length?this.selectAnchor(-1):this.selectAnchor(Th.clamp(this.STATE.selectedAnchor,0,this.STATE.anchors.length-1)),this.editAlpha=this.STATE.curves.length>3}callOpenGradientPicker(e,t){this.setValue(e,t),this.open()}getGradientPickerRect(){return this.UI.overlay.dom.getBoundingClientRect()}positionGradientPicker(e,t){t+this.UI.panel.clientHeight>window.innerHeight&&(t=window.innerHeight-this.UI.panel.clientHeight),this.UI.overlay.position(e,t)}setGradientPicker(e,t){this.setValue(e,t)}}Go.register("div",Oh);var zh=Oh;const Fh="pcui-radio-button",Vh=Fh+"-selected";class Nh extends Go{constructor(e={}){super(Object.assign({tabIndex:0},e)),this._onKeyDown=e=>{"Escape"!==e.key?this.enabled&&!this.readOnly&&" "===e.key&&(e.stopPropagation(),e.preventDefault(),this.value=!this.value):this.blur()},this._onFocus=e=>{this.emit("focus")},this._onBlur=e=>{this.emit("blur")},this.class.add(Fh),this.class.add(Vo),this.dom.addEventListener("keydown",this._onKeyDown),this.dom.addEventListener("focus",this._onFocus),this.dom.addEventListener("blur",this._onBlur),this.value=e.value,this._renderChanges=e.renderChanges}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),this.dom.removeEventListener("focus",this._onFocus),this.dom.removeEventListener("blur",this._onBlur),super.destroy())}_onClick(e){return this.enabled&&this.focus(),this.enabled&&!this.readOnly&&(this.value=!this.value),super._onClick(e)}_updateValue(e){return this.class.remove(Oo),e!==this.value&&(this._value=e,e?this.class.add(Vh):this.class.remove(Vh),this.renderChanges&&this.flash(),this.emit("change",e),!0)}focus(){this.dom.focus()}blur(){this.dom.blur()}set value(e){this._updateValue(e)&&this._binding&&this._binding.setValue(e)}get value(){return this._value}set values(e){const t=e.some((t=>t!==e[0]));t?(this._updateValue(null),this.class.add(Oo)):this._updateValue(e[0])}set renderChanges(e){this._renderChanges=e}get renderChanges(){return this._renderChanges}}Go.register("radio",Nh,{renderChanges:!0});var Bh=Nh;const Uh="pcui-gridview-item",Hh=Uh+"-selected",Wh=Uh+"-text";class Gh extends $o{constructor(e={}){var t,s,i;super(Object.assign({tabIndex:0},e)),this._onRadioButtonClick=()=>{this._radioButton.value=this.selected},this._onFocus=()=>{this.emit("focus")},this._onBlur=()=>{this.emit("blur")},this.allowSelect=null===(t=e.allowSelect)||void 0===t||t,this._type=null!==(s=e.type)&&void 0!==s?s:null,this._selected=!1,"radio"===e.type?(this.class.add("pcui-gridview-radio-container"),this._radioButton=new Bh({class:"pcui-gridview-radiobtn",binding:new bo}),this._radioButton.dom.removeEventListener("click",this._radioButton._onClick),this._radioButton.dom.addEventListener("click",this._onRadioButtonClick),this.append(this._radioButton)):this.class.add(Uh),this._labelText=new Jo({class:Wh,binding:new bo,text:null!==(i=e.text)&&void 0!==i?i:""}),this.append(this._labelText),this.dom.addEventListener("focus",this._onFocus),this.dom.addEventListener("blur",this._onBlur)}destroy(){this._destroyed||(this.dom.removeEventListener("focus",this._onFocus),this.dom.removeEventListener("blur",this._onBlur),super.destroy())}focus(){this.dom.focus()}blur(){this.dom.blur()}link(e,t){this._labelText.link(e,t)}unlink(){this._labelText.unlink()}set allowSelect(e){this._allowSelect=e}get allowSelect(){return this._allowSelect}set selected(e){e&&this.focus(),this._selected!==e&&(this._selected=e,e?(this._radioButton?this._radioButton.value=e:this.class.add(Hh),this.emit("select",this)):(this._radioButton?this._radioButton.value=!1:this.class.remove(Hh),this.emit("deselect",this)))}get selected(){return this._selected}set text(e){this._labelText.text=e}get text(){return this._labelText.text}get nextSibling(){let e=this.dom.nextSibling;for(;e;){if(e.ui instanceof Gh&&!e.ui.hidden)return e.ui;e=e.nextSibling}return null}get previousSibling(){let e=this.dom.previousSibling;for(;e;){if(e.ui instanceof Gh&&!e.ui.hidden)return e.ui;e=e.previousSibling}return null}}var jh=Gh;const qh="pcui-gridview",Kh=qh+"-vertical";var Xh=class extends $o{constructor(e={}){var t,s;super(e),this._filterAnimationFrame=null,this._filterCanceled=!1,this._selected=[],this._vertical=!!e.vertical,this.class.add(this._vertical?Kh:qh),this.on("append",(e=>{this._onAppendGridViewItem(e)})),this.on("remove",(e=>{this._onRemoveGridViewItem(e)})),this._filterFn=e.filterFn,this._multiSelect=null===(t=e.multiSelect)||void 0===t||t,this._allowDeselect=null===(s=e.allowDeselect)||void 0===s||s}_onAppendGridViewItem(e){if(!(e instanceof jh))return;let t;t=this._clickFn?e.on("click",(t=>this._clickFn(t,e))):e.on("click",(t=>this._onClickItem(t,e)));let s,i=e.on("select",(()=>this._onSelectItem(e)));this._allowDeselect&&(s=e.on("deselect",(()=>this._onDeselectItem(e)))),this._filterFn&&!this._filterFn(e)&&(e.hidden=!0),e.once("griditem:remove",(()=>{t.unbind(),t=null,i.unbind(),i=null,this._allowDeselect&&(s.unbind(),s=null)}))}_onRemoveGridViewItem(e){e instanceof jh&&(e.selected=!1,e.emit("griditem:remove"),e.unbind("griditem:remove"))}_onClickItem(e,t){if((e.ctrlKey||e.metaKey)&&this._multiSelect)t.selected=!t.selected;else if(e.shiftKey&&this._multiSelect){const e=this._selected[this._selected.length-1];if(e){if(e.dom.compareDocumentPosition(t.dom)&Node.DOCUMENT_POSITION_FOLLOWING){let s=e.nextSibling;for(;s&&(s.selected=!0,s!==t);)s=s.nextSibling}else{let s=e.previousSibling;for(;s&&(s.selected=!0,s!==t);)s=s.previousSibling}}else t.selected=!0}else{let e=!1,s=this._selected.length;for(;s--;)this._selected[s]&&this._selected[s]!==t&&(this._selected[s].selected=!1,e=!0);t.selected=!!e||!t.selected}}_onSelectItem(e){this._selected.push(e),this.emit("select",e)}_onDeselectItem(e){const t=this._selected.indexOf(e);-1!==t&&(this._selected.splice(t,1),this.emit("deselect",e))}deselect(){let e=this._selected.length;for(;e--;)this._selected[e]&&(this._selected[e].selected=!1)}filter(){this.forEachChild((e=>{e instanceof jh&&(e.hidden=this._filterFn&&!this._filterFn(e))}))}filterAsync(e=100){let t=0;const s=this.dom.childNodes,i=s.length;this.emit("filter:start"),this._filterCanceled=!1;const n=()=>{this._filterAnimationFrame=null;let r=0;for(;t<i&&r<e;t++){if(this._filterCanceled)return this._filterCanceled=!1,void this.emit("filter:cancel");const e=s[t].ui;e instanceof jh&&(this._filterFn&&!this._filterFn(e)?e.hidden=!0:(e.hidden=!1,r++))}t<i?(this.emit("filter:delay"),this._filterAnimationFrame=requestAnimationFrame(n)):this.emit("filter:end")};n()}filterAsyncCancel(){this._filterAnimationFrame?(cancelAnimationFrame(this._filterAnimationFrame),this._filterAnimationFrame=null):this._filterCanceled=!0}destroy(){this._destroyed||(this._filterAnimationFrame&&(cancelAnimationFrame(this._filterAnimationFrame),this._filterAnimationFrame=null),super.destroy())}get selected(){return this._selected.slice()}get vertical(){return this._vertical}};class Yh extends $o{constructor(e={}){var t,s,i,n;super(e),this._titleElement=new Go,this._textElement=new Go,this.class.add("pcui-infobox"),this.append(this._titleElement),this.append(this._textElement),this._unsafe=null!==(t=e.unsafe)&&void 0!==t&&t,this.icon=null!==(s=e.icon)&&void 0!==s?s:"",this.title=null!==(i=e.title)&&void 0!==i?i:"",this.text=null!==(n=e.text)&&void 0!==n?n:""}set icon(e){this._icon!==e&&(this._icon=e,e?this.dom.setAttribute("data-icon",String.fromCodePoint(parseInt(e,16))):this.dom.removeAttribute("data-icon"))}get icon(){return this._icon}set title(e){this._title!==e&&(this._title=e,this._unsafe?this._titleElement.dom.innerHTML=e:this._titleElement.dom.textContent=e)}get title(){return this._title}set text(e){this._text!==e&&(this._text=e,this._unsafe?this._textElement.dom.innerHTML=e:this._textElement.dom.textContent=e)}get text(){return this._text}}Go.register("infobox",Yh);var Zh=Yh;const $h="pcui-label-group",Qh=$h+"-align-top";class Jh extends $o{constructor(e={}){var t,s;super(e),this.class.add($h),this._label=new Jo({text:null!==(t=e.text)&&void 0!==t?t:"Label",nativeTooltip:e.nativeTooltip}),this.append(this._label),this._field=null!==(s=e.field)&&void 0!==s?s:null,this._field&&this.append(this._field),this.labelAlignTop=e.labelAlignTop}get label(){return this._label}get field(){return this._field}set text(e){this._label.text=e}get text(){return this._label.text}set labelAlignTop(e){e?this.class.add(Qh):this.class.remove(Qh)}get labelAlignTop(){return this.class.contains(Qh)}}Go.register("labelgroup",Jh);var ec=Jh;const tc="pcui-menu-item",sc=tc+"-content",ic=tc+"-children",nc=tc+"-has-children";class rc extends $o{constructor(e={}){super(e),this._numChildren=0,this._icon=null,this._menu=null,this._onClickMenuItem=e=>{e.preventDefault(),e.stopPropagation(),this.enabled&&(this._onSelect&&this._onSelect(e),this.emit("select"),this.menu&&(this.menu.hidden=!0))},this.class.add(tc),this._containerContent=new $o({class:sc,flex:!0,flexDirection:"row"}),this.append(this._containerContent),this._labelText=new Jo,this._containerContent.append(this._labelText),this._containerItems=new $o({class:ic}),this.append(this._containerItems),this.domContent=this._containerItems.dom,this.text=e.text||"Untitled",this.dom.addEventListener("click",this._onClickMenuItem),e.value&&(this.value=e.value),e.icon&&(this.icon=e.icon),e.binding&&(this.binding=e.binding),this.onIsEnabled=e.onIsEnabled,this.onSelect=e.onSelect,this.onIsVisible=e.onIsVisible,e.items&&e.items.forEach((e=>{const t=new rc(e);this.append(t)}))}destroy(){this.destroyed||(this.dom.removeEventListener("click",this._onClickMenuItem),super.destroy())}_onAppendChild(e){super._onAppendChild(e),this._numChildren++,e instanceof rc&&(this.class.add(nc),e.menu=this.menu)}_onRemoveChild(e){e instanceof rc&&(this._numChildren--,0===this._numChildren&&this.class.remove(nc),e.menu=null),super._onRemoveChild(e)}link(e,t){super.link(e,t),this._labelText.link(e,t)}unlink(){super.unlink(),this._labelText.unlink()}select(){this.enabled&&(this._onSelect&&this._onSelect(),this.emit("select"),this.menu&&(this.menu.hidden=!0))}set text(e){this._labelText.text=e}get text(){return this._labelText.text}set value(e){this.text=e}get value(){return this.text}set values(e){this._labelText.values=e}set icon(e){this._icon!==e&&e.match(/^E[0-9]{0,4}$/)&&(this._icon=e,e?this._labelText.dom.setAttribute("data-icon",String.fromCodePoint(parseInt(e,16))):this._labelText.dom.removeAttribute("data-icon"))}get icon(){return this._icon}set binding(e){this._labelText.binding=e}get binding(){return this._labelText.binding}set menu(e){if(this._menu=e,!this._containerItems.destroyed)for(const t of this._containerItems.dom.childNodes)t.ui instanceof rc&&(t.ui.menu=e)}get menu(){return this._menu}set onSelect(e){this._onSelect=e}get onSelect(){return this._onSelect}set onIsEnabled(e){this._onIsEnabled=e}get onIsEnabled(){return this._onIsEnabled}set onIsVisible(e){this._onIsVisible=e}get onIsVisible(){return this._onIsVisible}get hasChildren(){return this._numChildren>0}set renderChanges(e){this._renderChanges=e}get renderChanges(){return this._renderChanges}}var ac=rc;const oc="pcui-menu",lc=oc+"-items";var hc=class extends $o{constructor(e={}){var t;super(Object.assign({tabIndex:1},e)),this._onClickMenu=e=>{this._containerMenuItems.dom.contains(e.target)||(this.hidden=!0)},this._onFocus=e=>{this.emit("focus")},this._onBlur=e=>{this.emit("blur")},this._onKeyDown=e=>{this.hidden||"Escape"===e.key&&(this.hidden=!0)},this.hidden=null===(t=e.hidden)||void 0===t||t,this.class.add(oc),this._containerMenuItems=new $o({class:lc,flex:!0,flexDirection:"column"}),this.append(this._containerMenuItems),this.domContent=this._containerMenuItems.dom,this.on("click",this._onClickMenu),this.on("show",(()=>{this._onShowMenu()})),this.dom.addEventListener("contextmenu",this._onClickMenu),this.dom.addEventListener("keydown",this._onKeyDown),e.items&&e.items.forEach((e=>{const t=new ac(e);this.append(t)}))}destroy(){this.destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),this.dom.removeEventListener("contextmenu",this._onClickMenu),this.dom.removeEventListener("focus",this._onFocus),this.dom.removeEventListener("blur",this._onBlur),super.destroy())}_onAppendChild(e){e instanceof ac&&(e.menu=this)}_onRemoveChild(e){e instanceof ac&&(e.menu=null)}_filterMenuItems(e){if(e instanceof ac){e.onIsEnabled&&(e.enabled=e.onIsEnabled()),e.onIsVisible&&(e.hidden=!e.onIsVisible());for(const t of e._containerItems.dom.childNodes)this._filterMenuItems(t.ui)}}_onShowMenu(){this.focus();for(const e of this._containerMenuItems.dom.childNodes)this._filterMenuItems(e.ui)}_limitSubmenuAtScreenEdges(e){if(!(e instanceof ac&&e.hasChildren))return;const t=e._containerItems;t.style.top="",t.style.left="",t.style.right="";const s=t.dom.getBoundingClientRect();s.bottom>window.innerHeight&&(t.style.top=-(s.bottom-window.innerHeight)+"px"),s.right>window.innerWidth&&(t.style.left="auto",t.style.right="100%");for(const e of t.dom.childNodes)this._limitSubmenuAtScreenEdges(e.ui)}focus(){this.dom.focus()}blur(){this.dom.blur()}position(e,t){const s=this._containerMenuItems.dom.getBoundingClientRect();let i=e||0,n=t||0;n+s.height>window.innerHeight?n=window.innerHeight-s.height:n<0&&(n=0),i+s.width>window.innerWidth?i=window.innerWidth-s.width:i<0&&(i=0),this._containerMenuItems.style.left=i+"px",this._containerMenuItems.style.top=n+"px";for(const e of this._containerMenuItems.dom.childNodes)this._limitSubmenuAtScreenEdges(e.ui)}clear(){this._containerMenuItems.clear()}};const cc="pcui-progress",dc=cc+"-inner";class uc extends $o{constructor(e={}){super(e),this._inner=new Go({class:dc}),this.class.add(cc),this.append(this._inner),void 0!==e.value&&(this.value=e.value)}set value(e){this._value!==e&&(this._value=e,this._inner.width=`${this._value}%`,this.emit("change",e))}get value(){return this._value}}Go.register("progress",uc);var pc,mc=uc;const _c="pcui-slider",fc=_c+"-container",gc=_c+"-bar",vc=_c+"-handle",yc=_c+"-active",bc=/Chrome\//.test(null===(pc=globalThis.navigator)||void 0===pc?void 0:pc.userAgent);class xc extends Go{constructor(e={}){var t,s,i,n,r;super(e),this._historyCombine=!1,this._historyPostfix=null,this._cursorHandleOffset=0,this._touchId=null,this._onMouseDown=e=>{0===e.button&&this.enabled&&!this.readOnly&&this._onSlideStart(e.pageX)},this._onMouseMove=e=>{e.stopPropagation(),e.preventDefault(),this._onSlideMove(e.pageX)},this._onMouseUp=e=>{e.stopPropagation(),e.preventDefault(),this._onSlideEnd(e.pageX)},this._onTouchStart=e=>{if(this.enabled&&!this.readOnly)for(let t=0;t<e.changedTouches.length;t++){const s=e.changedTouches[t],i=s.target;if(i.ui&&i.ui===this){this._touchId=s.identifier,this._onSlideStart(s.pageX);break}}},this._onTouchMove=e=>{for(let t=0;t<e.changedTouches.length;t++){const s=e.changedTouches[t];if(s.identifier===this._touchId){e.stopPropagation(),e.preventDefault(),this._onSlideMove(s.pageX);break}}},this._onTouchEnd=e=>{for(let t=0;t<e.changedTouches.length;t++){const s=e.changedTouches[t];if(s.identifier===this._touchId){e.stopPropagation(),e.preventDefault(),this._onSlideEnd(s.pageX),this._touchId=null;break}}},this._onKeyDown=e=>{if("Escape"===e.key)return void this.blur();if(!this.enabled||this.readOnly)return;if("ArrowLeft"!==e.key&&"ArrowRight"!==e.key)return;e.stopPropagation(),e.preventDefault();let t="ArrowLeft"===e.key?-1:1;e.shiftKey&&(t*=10),this.value+=t*this.step},this.class.add(_c);const a=new vl({allowNull:e.allowNull,hideSlider:!0,min:e.min,max:e.max,keyChange:e.keyChange,placeholder:e.placeholder,precision:null!==(t=e.precision)&&void 0!==t?t:2,renderChanges:e.renderChanges,step:e.step});a.on("change",(e=>{this._onValueChange(e)})),a.on("focus",(()=>{this.emit("focus")})),a.on("blur",(()=>{this.emit("blur")})),a.parent=this,this.dom.appendChild(a.dom),this._numericInput=a,this._sliderMin=null!==(i=null!==(s=e.sliderMin)&&void 0!==s?s:e.min)&&void 0!==i?i:0,this._sliderMax=null!==(r=null!==(n=e.sliderMax)&&void 0!==n?n:e.max)&&void 0!==r?r:1,this._domSlider=document.createElement("div"),this._domSlider.classList.add(fc),this.dom.appendChild(this._domSlider),this._domBar=document.createElement("div"),this._domBar.classList.add(gc),this._domBar.ui=this,this._domSlider.appendChild(this._domBar),this._domHandle=document.createElement("div"),this._domHandle.ui=this,this._domHandle.tabIndex=0,this._domHandle.classList.add(vc),this._domBar.appendChild(this._domHandle),this._domSlider.addEventListener("mousedown",this._onMouseDown),this._domSlider.addEventListener("touchstart",this._onTouchStart,{passive:!0}),this._domHandle.addEventListener("keydown",this._onKeyDown),void 0!==e.value&&(this.value=e.value),void 0!==e.values&&(this.values=e.values),0===this.value&&this._updateHandle(0)}destroy(){this._destroyed||(this._domSlider.removeEventListener("mousedown",this._onMouseDown),this._domSlider.removeEventListener("touchstart",this._onTouchStart),this._domHandle.removeEventListener("keydown",this._onKeyDown),this.dom.removeEventListener("mouseup",this._onMouseUp),this.dom.removeEventListener("mousemove",this._onMouseMove),this.dom.removeEventListener("touchmove",this._onTouchMove),this.dom.removeEventListener("touchend",this._onTouchEnd),super.destroy())}_updateHandle(e){const t=100*Math.max(0,Math.min(1,((e||0)-this._sliderMin)/(this._sliderMax-this._sliderMin))),s=this._domHandle.getBoundingClientRect().width;this._domHandle.style.left=`calc(${t}% + ${s/2}px)`}_onValueChange(e){this._updateHandle(e),this._suppressChange||this.emit("change",e),this._binding&&this._binding.setValue(e)}_calculateCursorHandleOffset(e){const t=bc?2:0,s=this._domHandle.getBoundingClientRect(),i=s.left-t,n=s.right;return this._cursorHandleOffset=e>=i&&e<=n?e-(i+(n-i)/2):0,this._cursorHandleOffset}_onSlideStart(e){this._domHandle.focus(),null===this._touchId?(window.addEventListener("mousemove",this._onMouseMove),window.addEventListener("mouseup",this._onMouseUp)):(window.addEventListener("touchmove",this._onTouchMove),window.addEventListener("touchend",this._onTouchEnd)),this.class.add(yc),this._calculateCursorHandleOffset(e)||this._onSlideMove(e),this.binding&&(this._historyCombine=this.binding.historyCombine,this._historyPostfix=this.binding.historyPostfix,this.binding.historyCombine=!0,this.binding.historyPostfix=`(${Date.now()})`)}_onSlideMove(e){const t=this._domBar.getBoundingClientRect();e-=this._cursorHandleOffset;let s=Math.max(0,Math.min(1,(e-t.left)/t.width))*(this._sliderMax-this._sliderMin)+this._sliderMin;s=parseFloat(s.toFixed(this.precision)),this.value=s}_onSlideEnd(e){this._calculateCursorHandleOffset(e)||this._onSlideMove(e),this.class.remove(yc),null===this._touchId?(window.removeEventListener("mousemove",this._onMouseMove),window.removeEventListener("mouseup",this._onMouseUp)):(window.removeEventListener("touchmove",this._onTouchMove),window.removeEventListener("touchend",this._onTouchEnd)),this.binding&&(this.binding.historyCombine=this._historyCombine,this.binding.historyPostfix=this._historyPostfix,this._historyCombine=!1,this._historyPostfix=null)}focus(){this._numericInput.focus()}blur(){this._domHandle.blur(),this._numericInput.blur()}set sliderMin(e){this._sliderMin!==e&&(this._sliderMin=e,this._updateHandle(this.value))}get sliderMin(){return this._sliderMin}set sliderMax(e){this._sliderMax!==e&&(this._sliderMax=e,this._updateHandle(this.value))}get sliderMax(){return this._sliderMax}set value(e){this._numericInput.value=e,this._numericInput.class.contains(Oo)?this.class.add(Oo):this.class.remove(Oo)}get value(){return this._numericInput.value}set values(e){this._numericInput.values=e,this._numericInput.class.contains(Oo)?this.class.add(Oo):this.class.remove(Oo)}set renderChanges(e){this._numericInput.renderChanges=e}get renderChanges(){return this._numericInput.renderChanges}set min(e){this._numericInput.min=e}get min(){return this._numericInput.min}set max(e){this._numericInput.max=e}get max(){return this._numericInput.max}set step(e){this._numericInput.step=e}get step(){return this._numericInput.step}set precision(e){this._numericInput.precision=e}get precision(){return this._numericInput.precision}set keyChange(e){this._numericInput.keyChange=e}get keyChange(){return this._numericInput.keyChange}set placeholder(e){this._numericInput.placeholder=e}get placeholder(){return this._numericInput.placeholder}}Go.register("slider",xc,{renderChanges:!0});var wc=xc;class Sc extends Go{constructor(e={}){var t,s;if((null!==(t=e.type)&&void 0!==t?t:"small-thick")===Sc.TYPE_SMALL_THICK){const t=function(e,t){const s=t||document.createElementNS("http://www.w3.org/2000/svg","svg");return s.classList.add("spin"),s.setAttribute("width",e),s.setAttribute("height",e),s.setAttribute("viewBox","0 0 14 14"),s.setAttribute("fill","none"),s.innerHTML='<path d="M7 14C3.13871 14 0 10.8613 0 7C0 3.13871 3.13871 0 7 0C10.8613 0 14 3.13871 14 7C14 10.8613 10.8613 14 7 14ZM7 2.25806C4.38064 2.25806 2.25806 4.38064 2.25806 7C2.25806 9.61935 4.38064 11.7419 7 11.7419C9.61935 11.7419 11.7419 9.61935 11.7419 7C11.7419 4.38064 9.61935 2.25806 7 2.25806Z" fill="#773417"/><path class="pcui-spinner-highlight" d="M7 14V11.7419C9.61935 11.7419 11.7419 9.61935 11.7419 7H14C14 10.8613 10.8613 14 7 14Z" fill="#FF6600"/>',s}(null!==(s=e.size)&&void 0!==s?s:12,e.dom);e=Object.assign(Object.assign({},e),{dom:t})}super(e),this.class.add("pcui-spinner")}}Sc.TYPE_SMALL_THICK="small-thick";var Cc=Sc;const Tc="pcui-text-area-input",Ac=Tc+"-resizable",Ec=Ac+"-none",Pc=Ac+"-both",Mc=Ac+"-horizontal",Lc=Ac+"-vertical";class Dc extends ql{constructor(e={}){switch(super(e=Object.assign({input:document.createElement("textarea")},e)),this.class.add(Tc),e.resizable){case"both":this.class.add(Pc);break;case"horizontal":this.class.add(Mc);break;case"vertical":this.class.add(Lc);break;default:this.class.add(Ec)}}_onInputKeyDown(e){("Escape"===e.key&&this.blurOnEscape||"Enter"===e.key&&this.blurOnEnter&&!e.shiftKey)&&this._domInput.blur(),this.emit("keydown",e)}}Go.register("text",Dc,{renderChanges:!0});var kc=Dc;const Ic="pcui-treeview-item",Rc=Ic+"-icon",Oc=Ic+"-text",zc=Ic+"-selected",Fc=Ic+"-open",Vc=Ic+"-contents",Nc=Ic+"-empty",Bc=Ic+"-rename";class Uc extends $o{constructor(e={}){var t,s,i,n;super(e),this._numChildren=0,this._onContentKeyDown=e=>{"INPUT"!==e.target.tagName&&this.allowSelect&&this._treeView&&this._treeView._onChildKeyDown(e,this)},this._onContentMouseDown=e=>{this._treeView&&this._treeView.allowDrag&&this._allowDrag&&(this._treeView._updateModifierKeys(e),e.stopPropagation())},this._onContentMouseUp=e=>{e.stopPropagation(),e.preventDefault(),window.removeEventListener("mouseup",this._onContentMouseUp),this._treeView&&this._treeView._onChildDragEnd(e,this)},this._onContentMouseOver=e=>{e.stopPropagation(),this._treeView&&this._treeView._onChildDragOver(e,this),this.emit("hover",e)},this._onContentDragStart=e=>{e.stopPropagation(),e.preventDefault(),this._treeView&&this._treeView.allowDrag&&(this.class.contains(Bc)||(this._treeView._onChildDragStart(e,this),window.addEventListener("mouseup",this._onContentMouseUp)))},this._onContentClick=e=>{if(!this.allowSelect||0!==e.button)return;if("INPUT"===e.target.tagName)return;e.stopPropagation();const t=this._containerContents.dom.getBoundingClientRect();this._numChildren>0&&e.clientX-t.left<0?(this.open=!this.open,e.altKey&&this._dfs((e=>{e.open=this.open})),this.focus()):this._treeView&&this._treeView._onChildClick(e,this)},this._onContentDblClick=e=>{if(!this._treeView||!this._treeView.allowRenaming||0!==e.button)return;if("INPUT"===e.target.tagName)return;e.stopPropagation();const t=this._containerContents.dom.getBoundingClientRect();this.numChildren&&e.clientX-t.left<0||(this.allowSelect&&(this._treeView.deselect(),this._treeView._onChildClick(e,this)),this.rename())},this._onContentContextMenu=e=>{this._treeView&&this._treeView._onContextMenu&&this._treeView._onContextMenu(e,this)},this._onContentFocus=e=>{this.emit("focus")},this._onContentBlur=e=>{this.emit("blur")},this.class.add(Ic,Nc),this._containerContents=new $o({class:Vc,flex:!0,flexDirection:"row",tabIndex:0}),this.append(this._containerContents),this._containerContents.dom.draggable=!0,this._labelIcon=new Jo({class:Rc}),this._containerContents.append(this._labelIcon),this.icon=null!==(t=e.icon)&&void 0!==t?t:"E360",this._labelText=new Jo({class:Oc}),this._containerContents.append(this._labelText),this.allowSelect=null===(s=e.allowSelect)||void 0===s||s,this.allowDrop=null===(i=e.allowDrop)||void 0===i||i,this.allowDrag=null===(n=e.allowDrag)||void 0===n||n,e.text&&(this.text=e.text),e.selected&&(this.selected=e.selected);const r=this._containerContents.dom;r.addEventListener("focus",this._onContentFocus),r.addEventListener("blur",this._onContentBlur),r.addEventListener("keydown",this._onContentKeyDown),r.addEventListener("dragstart",this._onContentDragStart),r.addEventListener("mousedown",this._onContentMouseDown),r.addEventListener("mouseover",this._onContentMouseOver),r.addEventListener("click",this._onContentClick),r.addEventListener("dblclick",this._onContentDblClick),r.addEventListener("contextmenu",this._onContentContextMenu)}destroy(){if(this._destroyed)return;const e=this._containerContents.dom;e.removeEventListener("focus",this._onContentFocus),e.removeEventListener("blur",this._onContentBlur),e.removeEventListener("keydown",this._onContentKeyDown),e.removeEventListener("dragstart",this._onContentDragStart),e.removeEventListener("mousedown",this._onContentMouseDown),e.removeEventListener("mouseover",this._onContentMouseOver),e.removeEventListener("click",this._onContentClick),e.removeEventListener("dblclick",this._onContentDblClick),e.removeEventListener("contextmenu",this._onContentContextMenu),window.removeEventListener("mouseup",this._onContentMouseUp),super.destroy()}_onAppendChild(e){super._onAppendChild(e),e instanceof Uc&&(this._numChildren++,this._parent!==this._treeView&&this.class.remove(Nc),this._treeView&&this._treeView._onAppendTreeViewItem(e))}_onRemoveChild(e){e instanceof Uc&&(this._numChildren--,0===this._numChildren&&this.class.add(Nc),this._treeView&&this._treeView._onRemoveTreeViewItem(e)),super._onRemoveChild(e)}_dfs(e){e(this);let t=this.firstChild;for(;t;)t._dfs(e),t=t.nextSibling}rename(){this.class.add(Bc);const e=new ql({renderChanges:!1,value:this.text,class:No});e.on("blur",(()=>{e.destroy()})),e.on("destroy",(()=>{this.class.remove(Bc),this.focus()})),e.on("change",(t=>{(t=t.trim())&&(this.text=t,e.destroy())})),e.on("disable",(()=>{e.input.removeAttribute("readonly")})),this._containerContents.append(e),e.focus(!0)}focus(){this._containerContents.dom.focus()}blur(){this._containerContents.dom.blur()}set selected(e){e!==this.selected?e?(this._containerContents.class.add(zc),this.emit("select",this),this._treeView&&this._treeView._onChildSelected(this),this.focus()):(this._containerContents.class.remove(zc),this.blur(),this.emit("deselect",this),this._treeView&&this._treeView._onChildDeselected(this)):e&&this.focus()}get selected(){return this._containerContents.class.contains(zc)}set text(e){this._labelText.value!==e&&(this._labelText.value=e,this._treeView&&this._treeView._onChildRename(this,e))}get text(){return this._labelText.value}get textLabel(){return this._labelText}get iconLabel(){return this._labelIcon}set open(e){if(this.open!==e)if(e){if(!this.numChildren)return;this.class.add(Fc),this.emit("open",this)}else this.class.remove(Fc),this.emit("close",this)}get open(){return this.class.contains(Fc)||this.parent===this._treeView}set parentsOpen(e){let t=this.parent;for(;t&&t instanceof Uc;)t.open=e,t=t.parent}get parentsOpen(){let e=this.parent;for(;e&&e instanceof Uc;){if(!e.open)return!1;e=e.parent}return!0}set allowDrop(e){this._allowDrop=e}get allowDrop(){return this._allowDrop}set allowDrag(e){this._allowDrag=e}get allowDrag(){return this._allowDrag}set allowSelect(e){this._allowSelect=e}get allowSelect(){return this._allowSelect}set treeView(e){this._treeView=e}get treeView(){return this._treeView}get numChildren(){return this._numChildren}get firstChild(){if(this._numChildren)for(const e of this.dom.childNodes)if(e.ui instanceof Uc)return e.ui;return null}get lastChild(){if(this._numChildren)for(let e=this.dom.childNodes.length-1;e>=0;e--)if(this.dom.childNodes[e].ui instanceof Uc)return this.dom.childNodes[e].ui;return null}get nextSibling(){let e=this.dom.nextSibling;for(;e&&!(e.ui instanceof Uc);)e=e.nextSibling;return e&&e.ui}get previousSibling(){let e=this.dom.previousSibling;for(;e&&!(e.ui instanceof Uc);)e=e.previousSibling;return e&&e.ui}set icon(e){this._icon!==e&&e.match(/^E[0-9]{0,4}$/)&&(this._icon=e,e?this._labelIcon.dom.setAttribute("data-icon",String.fromCodePoint(parseInt(e,16))):this._labelIcon.dom.removeAttribute("data-icon"))}get icon(){return this._icon}}Uc.EVENT_SELECT="select",Uc.EVENT_DESELECT="deselect",Uc.EVENT_OPEN="open",Uc.EVENT_CLOSE="close";var Hc=Uc;const Wc="pcui-treeview",Gc=Wc+"-item-dragged",jc=Wc+"-drag-handle",qc=Wc+"-filtering",Kc=qc+"-result",Xc="inside",Yc="before",Zc="after";class $c extends $o{constructor(e={}){var t,s,i;super(e),this._selectedItems=[],this._dragItems=[],this._dragging=!1,this._dragOverItem=null,this._dragArea=Xc,this._dragScroll=0,this._dragScrollInterval=null,this._pressedCtrl=!1,this._pressedShift=!1,this._filter=null,this._filterResults=[],this._updateModifierKeys=e=>{this._pressedCtrl=e.ctrlKey||e.metaKey,this._pressedShift=e.shiftKey},this._onMouseLeave=e=>{this._allowDrag&&this._dragging&&(this._dragOverItem=null,this._updateDragHandle())},this._onMouseMove=e=>{if(!this._dragging)return;const t=this.dom.getBoundingClientRect();this._dragScroll=0;let s=t.top,i=t.bottom;if(this._dragScrollElement!==this){const e=this._dragScrollElement.dom.getBoundingClientRect();s=Math.max(s+this._dragScrollElement.dom.scrollTop,e.top),i=Math.min(i+this._dragScrollElement.dom.scrollTop,e.bottom)}s=Math.max(0,s),i=Math.min(i,document.body.clientHeight),e.pageY<s+32&&this._dragScrollElement.dom.scrollTop>0?this._dragScroll=-1:e.pageY>i-32&&this._dragScrollElement.dom.scrollHeight>this._dragScrollElement.height+this._dragScrollElement.dom.scrollTop&&(this._dragScroll=1)},this._onDragMove=e=>{if(e.preventDefault(),e.stopPropagation(),!this._allowDrag||!this._dragOverItem)return;const t=this._dragHandle.dom.getBoundingClientRect(),s=Math.floor((e.clientY-t.top)/t.height*5),i=this._dragArea,n=this._dragOverItem;if(this._dragOverItem.parent===this){let e=!1;for(let t=0;t<this._dragItems.length;t++)if(this._dragItems[t].parent===this._dragOverItem){e=!0,this._dragOverItem=null;break}e||(this._dragArea=Xc)}else{let e=!1;for(let t=0;t<this._dragItems.length;t++)if(this._dragItems[t].dom.contains(this._dragOverItem.dom)){e=!0;break}if(e)this._dragOverItem=null;else if(this._allowReordering&&s<=1&&-1===this._dragItems.indexOf(this._dragOverItem.previousSibling))this._dragArea=Yc;else if(this._allowReordering&&s>=4&&-1===this._dragItems.indexOf(this._dragOverItem.nextSibling)&&(0===this._dragOverItem.numChildren||!this._dragOverItem.open))this._dragArea=Zc;else{let e=!1;if(this._allowReordering&&this._dragOverItem.open)for(let t=0;t<this._dragItems.length;t++)if(this._dragItems[t].parent===this._dragOverItem){e=!0,this._dragArea=Yc;break}e||(this._dragArea=Xc)}}i===this._dragArea&&n===this._dragOverItem||this._updateDragHandle()},this.class.add(Wc),this._allowDrag=null===(t=e.allowDrag)||void 0===t||t,this._allowReordering=null===(s=e.allowReordering)||void 0===s||s,this._allowRenaming=null!==(i=e.allowRenaming)&&void 0!==i&&i,this._dragHandle=new Go({class:jc}),this._dragScrollElement=e.dragScrollElement||this,this.append(this._dragHandle),this._onContextMenu=e.onContextMenu,this._onReparentFn=e.onReparent,this._wasDraggingAllowedBeforeFiltering=this._allowDrag,window.addEventListener("keydown",this._updateModifierKeys),window.addEventListener("keyup",this._updateModifierKeys),window.addEventListener("mousedown",this._updateModifierKeys),this.dom.addEventListener("mouseleave",this._onMouseLeave),this._dragHandle.dom.addEventListener("mousemove",this._onDragMove),this._dragHandle.on("destroy",(e=>{e.removeEventListener("mousemove",this._onDragMove)}))}destroy(){this._destroyed||(window.removeEventListener("keydown",this._updateModifierKeys),window.removeEventListener("keyup",this._updateModifierKeys),window.removeEventListener("mousedown",this._updateModifierKeys),window.removeEventListener("mousemove",this._onMouseMove),this.dom.removeEventListener("mouseleave",this._onMouseLeave),this._dragScrollInterval&&(window.clearInterval(this._dragScrollInterval),this._dragScrollInterval=null),super.destroy())}_findNextVisibleTreeItem(e){if(e.numChildren>0&&e.open)return e.firstChild;const t=e.nextSibling;if(t)return t;let s=e.parent;if(!(s instanceof Hc))return null;let i=s.nextSibling;for(;!i&&(s=s.parent,s instanceof Hc);)i=s.nextSibling;return i}_findLastVisibleChildTreeItem(e){if(!e.numChildren||!e.open)return null;let t=e.lastChild;for(;t&&t.numChildren&&t.open;)t=t.lastChild;return t}_findPreviousVisibleTreeItem(e){const t=e.previousSibling;if(t)return t.numChildren>0&&t.open?this._findLastVisibleChildTreeItem(t):t;const s=e.parent;return s instanceof Hc?s:null}_getChildrenRange(e,t){const s=[];if(this._filterResults.length){const i=this.dom.querySelectorAll(`.${Wc}-item.${Kc}`);let n=-1,r=-1;for(let a=0;a<i.length;a++){const o=i[a].ui;if(o===e?n=a:o===t&&(r=a),-1!==n&&-1!==r){const e=n<r?r:n;for(let t=n<r?n:r;t<=e;t++)s.push(i[t].ui);break}}}else{let i=e;const n=e.dom.getBoundingClientRect(),r=t.dom.getBoundingClientRect();if(n.top<r.top)for(;i&&i!==t;)i=this._findNextVisibleTreeItem(i),i&&i!==t&&s.push(i);else for(;i&&i!==t;)i=this._findPreviousVisibleTreeItem(i),i&&i!==t&&s.push(i);s.push(t)}return s}_onAppendChild(e){super._onAppendChild(e),e instanceof Hc&&this._onAppendTreeViewItem(e)}_onRemoveChild(e){e instanceof Hc&&this._onRemoveTreeViewItem(e),super._onRemoveChild(e)}_onAppendTreeViewItem(e){e.treeView=this,this._filter&&this._searchItems([[e.text,e]],this._filter),e.forEachChild((e=>{e instanceof Hc&&this._onAppendTreeViewItem(e)}))}_onRemoveTreeViewItem(e){e.selected=!1,e.forEachChild((e=>{e instanceof Hc&&this._onRemoveTreeViewItem(e)}))}_onChildKeyDown(e,t){if(-1!==["Tab","ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].indexOf(e.key))if(e.preventDefault(),e.stopPropagation(),"ArrowDown"===e.key){if(this._selectedItems.length){const e=this._findNextVisibleTreeItem(t);e&&(this._pressedShift||this._pressedCtrl?e.selected=!0:this._selectSingleItem(e))}}else if("ArrowUp"===e.key){if(this._selectedItems.length){const e=this._findPreviousVisibleTreeItem(t);e&&(this._pressedShift||this._pressedCtrl?e.selected=!0:this._selectSingleItem(e))}}else"ArrowLeft"===e.key?t.parent!==this&&(t.open=!1):"ArrowRight"===e.key&&(t.open=!0)}_onChildClick(e,t){if(0===e.button&&t.allowSelect)if(this._pressedCtrl)t.selected=!t.selected;else if(this._pressedShift){if(!this._selectedItems.length||1===this._selectedItems.length&&this._selectedItems[0]===t)return void(t.selected=!0);const e=this._selectedItems[this._selectedItems.length-1];this._openHierarchy(e);this._getChildrenRange(e,t).forEach((e=>{e.allowSelect&&(e.selected=!0)}))}else this._selectSingleItem(t)}_traverseDepthFirst(e){function t(s){if(s&&s instanceof Hc&&(e(s),s.numChildren))for(const e of s.dom.childNodes)t(e.ui)}for(const e of this.dom.childNodes)t(e.ui)}_getTreeOrder(){const e=new Map;let t=0;return this._traverseDepthFirst((s=>{e.set(s,t++)})),e}_getChildIndex(e,t){return Array.prototype.indexOf.call(t.dom.childNodes,e.dom)-1}_onChildDragStart(e,t){if(this.allowDrag&&!this._dragging){if(this._dragItems=[],-1!==this._selectedItems.indexOf(t)){const e=[];let t=-1;for(let s=0;s<this._selectedItems.length;s++){let i=this._selectedItems[s].parent,n=0,r=!1;for(;i&&i instanceof Hc;){if(-1!==this._selectedItems.indexOf(i)){r=!0;break}n++,i=i.parent}if(!r){if(-1===t)t=n;else if(t!==n)return;e.push(this._selectedItems[s])}}this._dragItems=e}else t.class.add(Gc),this._dragItems.push(t);this._dragItems.length&&(this._dragItems.forEach((e=>{e.class.add(Gc)})),this.isDragging=!0,this.emit("dragstart",this._dragItems.slice()))}}_onChildDragEnd(e,t){if(!this.allowDrag||!this._dragging)return;this._dragItems.forEach((e=>e.class.remove(Gc)));let s=!1;for(let e=0;e<this._dragItems.length;e++)if(this._dragItems[e].parent===this){s=!0;break}if(!s&&this._dragOverItem){if(this._dragItems.length>1){const e=this._getTreeOrder();this._dragItems.sort(((t,s)=>e.get(t)-e.get(s)))}if(this._dragItems.length){const e=[];if(this._onReparentFn){const t=[],s=e=>{let s=t.findIndex((t=>t.parent===e));return-1===s&&(t.push({parent:e,children:[...e.dom.childNodes]}),s=t.length-1),t[s].children};this._dragItems.forEach((t=>{if(t.parent===this._dragOverItem&&this._dragArea===Xc)return;e.push({item:t,oldParent:t.parent});const i=s(t.parent),n=i.indexOf(t.dom);i.splice(n,1)})),e.forEach(((t,i)=>{if(this._dragArea===Yc){t.newParent=this._dragOverItem.parent;const e=s(this._dragOverItem.parent),i=e.indexOf(this._dragOverItem.dom);e.splice(i,0,t.item.dom),t.newChildIndex=i}else if(this._dragArea===Xc){t.newParent=this._dragOverItem;const e=s(this._dragOverItem);e.push(t.item.dom),t.newChildIndex=e.length-1}else if(this._dragArea===Zc){t.newParent=this._dragOverItem.parent;const n=s(this._dragOverItem.parent),r=i>0?e[i-1].item:this._dragOverItem,a=n.indexOf(r.dom);n.splice(a+1,0,t.item.dom),t.newChildIndex=a+1}t.newChildIndex--}))}else this._dragItems.forEach((t=>{t.parent===this._dragOverItem&&this._dragArea===Xc||(e.push({item:t,oldParent:t.parent}),t.parent.remove(t))})),e.forEach(((t,s)=>{this._dragArea===Yc?(t.newParent=this._dragOverItem.parent,t.newParent.appendBefore(t.item,this._dragOverItem),t.newChildIndex=this._getChildIndex(t.item,t.newParent)):this._dragArea===Xc?(t.newParent=this._dragOverItem,t.newParent.append(t.item),t.newParent.open=!0,t.newChildIndex=this._getChildIndex(t.item,t.newParent)):this._dragArea===Zc&&(t.newParent=this._dragOverItem.parent,t.newParent.appendAfter(t.item,s>0?e[s-1].item:this._dragOverItem),t.newChildIndex=this._getChildIndex(t.item,t.newParent))}));e.length&&(this._onReparentFn&&this._onReparentFn(e),this.emit("reparent",e))}}this._dragItems=[],this.isDragging=!1,this.emit("dragend")}_onChildDragOver(e,t){this._allowDrag&&this._dragging&&(t.allowDrop&&-1===this._dragItems.indexOf(t)?this._dragOverItem=t:this._dragOverItem=null,this._updateDragHandle(),this._onDragMove(e))}_scrollWhileDragging(){this._dragging&&0!==this._dragScroll&&(this._dragScrollElement.dom.scrollTop+=8*this._dragScroll,this._dragOverItem=null,this._updateDragHandle())}_updateDragHandle(e,t){if(t||this._allowDrag&&this._dragging)if(e||(e=this._dragOverItem),e&&!e.hidden&&e.parentsOpen){const t=e._containerContents.dom.getBoundingClientRect();this._dragHandle.hidden=!1,this._dragHandle.class.remove(Zc,Yc,Xc),this._dragHandle.class.add(this._dragArea);const s=t.top;let i=t.left,n=t.width;if(this.dom.parentElement){const e=this.dom.parentElement.getBoundingClientRect();i=Math.max(i,e.left),n=Math.min(n,this.dom.parentElement.clientWidth-i+e.left)}this._dragHandle.style.top=s+"px",this._dragHandle.style.left=i+"px",this._dragHandle.style.width=n-7+"px"}else this._dragHandle.hidden=!0}_openHierarchy(e){e.parentsOpen=!0}_selectSingleItem(e){let t=this._selectedItems.length,s=!1;for(;t--;)this._selectedItems[t]&&this._selectedItems[t]!==e&&(this._selectedItems[t].selected=!1,s=!0);e.selected=!!s||!e.selected}_onChildSelected(e){this._selectedItems.push(e),this._openHierarchy(e),this.emit("select",e)}_onChildDeselected(e){const t=this._selectedItems.indexOf(e);-1!==t&&(this._selectedItems.splice(t,1),this.emit("deselect",e))}_onChildRename(e,t){if(this._filter){e.class.remove(Kc);const t=this._filterResults.indexOf(e);-1!==t&&this._filterResults.splice(t,1),this._searchItems([[e.text,e]],this._filter)}this.emit("rename",e,t)}_searchItems(e,t){const s=ih(e,t);s.length&&s.forEach((e=>{this._filterResults.push(e),e.class.add(Kc)}))}_applyFilter(e){this._clearFilter(),this._wasDraggingAllowedBeforeFiltering=this._allowDrag,this._allowDrag=!1,this.class.add(qc);const t=[];this._traverseDepthFirst((e=>{t.push([e.text,e])})),this._searchItems(t,e)}_clearFilter(){this._filterResults.forEach((e=>{e.destroyed||e.class.remove(Kc)})),this._filterResults.length=0,this.class.remove(qc),this._allowDrag=this._wasDraggingAllowedBeforeFiltering}showDragHandle(e){this._updateDragHandle(e,!0)}deselect(){let e=this._selectedItems.length;for(;e--;)this._selectedItems[e]&&(this._selectedItems[e].selected=!1)}clearTreeItems(){let e=this.dom.childNodes.length;for(;e--;){const t=this.dom.childNodes[e];if(!t)continue;const s=t.ui;s instanceof Hc&&s.destroy()}this._selectedItems=[],this._dragItems=[],this._allowDrag=this._wasDraggingAllowedBeforeFiltering}set allowDrag(e){this._allowDrag=e,this._filter&&(this._wasDraggingAllowedBeforeFiltering=e)}get allowDrag(){return this._allowDrag}set allowReordering(e){this._allowReordering=e}get allowReordering(){return this._allowReordering}set allowRenaming(e){this._allowRenaming=e}get allowRenaming(){return this._allowRenaming}set isDragging(e){this._dragging!==e&&(e?(this._dragging=!0,this._updateDragHandle(),(this.scrollable||this._dragScrollElement!==this)&&(window.removeEventListener("mousemove",this._onMouseMove),window.addEventListener("mousemove",this._onMouseMove),this._dragScrollInterval||(this._dragScrollInterval=window.setInterval((()=>{this._scrollWhileDragging()}),1e3/60)))):(this._dragOverItem=null,this._updateDragHandle(),this._dragging=!1,window.removeEventListener("mousemove",this._onMouseMove),this._dragScrollInterval&&(window.clearInterval(this._dragScrollInterval),this._dragScrollInterval=null)))}get isDragging(){return this._dragging}get selected(){return this._selectedItems.slice()}set filter(e){this._filter!==e&&(this._filter=e,e?this._applyFilter(e):this._clearFilter())}get filter(){return this._filter}get pressedCtrl(){return this._pressedCtrl}get pressedShift(){return this._pressedShift}}$c.EVENT_DRAGSTART="dragstart",$c.EVENT_DRAGEND="dragend",$c.EVENT_REPARENT="reparent",$c.EVENT_SELECT="select",$c.EVENT_DESELECT="deselect",$c.EVENT_RENAME="rename";var Qc=$c;class Jc extends Go{constructor(e={}){var t,s,i;const n=Object.assign({},e);delete n.binding,super(n),this._inputs=[],this._applyingChange=!1,this.class.add("pcui-vector-input");const r=Math.max(2,Math.min(4,null!==(t=e.dimensions)&&void 0!==t?t:3));for(let t=0;t<r;t++){const n=new vl({min:e.min,max:e.max,precision:null!==(s=e.precision)&&void 0!==s?s:7,step:null!==(i=e.step)&&void 0!==i?i:1,stepPrecision:e.stepPrecision,renderChanges:e.renderChanges,placeholder:e.placeholder?Array.isArray(e.placeholder)?e.placeholder[t]:e.placeholder:null});n.on("change",(()=>{this._onInputChange()})),n.on("focus",(()=>{this.emit("focus")})),n.on("blur",(()=>{this.emit("blur")})),this.dom.appendChild(n.dom),n.parent=this,this._inputs.push(n)}e.binding&&(this.binding=e.binding),void 0!==e.value&&(this.value=e.value)}_onInputChange(){if(this._applyingChange)return;this._inputs.some((e=>e.class.contains(Oo)))?this.class.add(Oo):this.class.remove(Oo),this.emit("change",this.value)}_updateValue(e){return this.class.remove(Oo),JSON.stringify(this.value)!==JSON.stringify(e)&&(this._applyingChange=!0,this._inputs.forEach(((t,s)=>{const i=t.binding;let n=!1;i&&(n=i.applyingChange,i.applyingChange=!0),t.value=e&&void 0!==e[s]?e[s]:null,i&&(i.applyingChange=n)})),this.emit("change",this.value),this._applyingChange=!1,!0)}link(e,t){super.link(e,t),e=Array.isArray(e)?e:[e];if(1===(t=Array.isArray(t)?t:[t]).length||e.length!==t.length)for(let s=0;s<this._inputs.length;s++)this._inputs[s].link(e,t[0]+`.${s}`);else for(let s=0;s<this._inputs.length;s++)this._inputs[s].link(e,t.map((e=>`${e}.${s}`)))}unlink(){super.unlink();for(const e of this._inputs)e.unlink()}focus(){this._inputs[0].focus()}blur(){for(const e of this._inputs)e.blur()}set value(e){if("string"==typeof e)try{if(e=JSON.parse(e),Array.isArray(e)&&e.some((e=>!Number.isFinite(e))))throw new Error("VectorInput value set to string which doesn't contain an array of numbers")}catch(t){console.error(t),e=[]}Array.isArray(e)||(e=[]);this._updateValue(e)&&this._binding&&this._binding.setValue(e)}get value(){return this._inputs.map((e=>e.value))}set values(e){e=this._inputs.map(((t,s)=>e.map((e=>e?e[s]:void 0)))),this._inputs.forEach(((t,s)=>{t.values=e[s]}))}set binding(e){super.binding=e;for(const t of this._inputs)t.binding=e?e.clone():null}get binding(){return super.binding}set placeholder(e){for(let t=0;t<this._inputs.length;t++)this._inputs[t].placeholder=e[t]||e||null}get placeholder(){return this._inputs.map((e=>e.placeholder))}get inputs(){return this._inputs.slice()}set renderChanges(e){for(const t of this._inputs)t.renderChanges=e}get renderChanges(){return this._inputs[0].renderChanges}set min(e){for(const t of this._inputs)t.min=e}get min(){return this._inputs[0].min}set max(e){for(const t of this._inputs)t.max=e}get max(){return this._inputs[0].max}set precision(e){for(const t of this._inputs)t.precision=e}get precision(){return this._inputs[0].precision}set step(e){for(const t of this._inputs)t.step=e}get step(){return this._inputs[0].step}}Go.register("vec2",Jc,{dimensions:2,renderChanges:!0}),Go.register("vec3",Jc,{dimensions:3,renderChanges:!0}),Go.register("vec4",Jc,{dimensions:4,renderChanges:!0});var ed=Jc;var td=Object.freeze({__proto__:null,revision:"6c69a4b",version:"4.1.1",BindingBase:fo,BindingElementToObservers:vo,BindingObserversToElement:bo,BindingTwoWay:wo,ArrayInput:Al,BooleanInput:Dl,Button:tl,Canvas:Il,Code:Fl,ColorPicker:Zl,Container:$o,Divider:Ql,Element:Go,GradientPicker:zh,GridView:Xh,GridViewItem:jh,InfoBox:Zh,InputElement:dl,Label:Jo,LabelGroup:ec,Menu:hc,MenuItem:ac,NumericInput:vl,Overlay:Gl,Panel:cl,Progress:mc,RadioButton:Bh,SelectInput:Ch,SliderInput:wc,Spinner:Cc,TextAreaInput:kc,TextInput:ql,TreeView:Qc,TreeViewItem:Hc,VectorInput:ed});
/**
	 * @license
	 * PlayCanvas Engine v1.69.0 revision 29eb79929 (RELEASE)
	 * Copyright 2011-2024 PlayCanvas Ltd. All rights reserved.
	 *
	 * This source code is licensed under the MIT license found in the
	 * LICENSE file in the root directory of this source tree.
	 */const sd=["undefined","number","string","boolean"],id={"[object Array]":"array","[object Object]":"object","[object Function]":"function","[object Date]":"date","[object RegExp]":"regexp","[object Float32Array]":"float32array"};function nd(e){if(null===e)return"null";const t=typeof e;return sd.includes(t)?t:id[Object.prototype.toString.call(e)]}function rd(e,t){for(const s in t){const i=t[s];"object"===nd(i)?e[s]=rd({},i):"array"===nd(i)?e[s]=rd([],i):e[s]=i}return e}class ad{constructor(e,t,s,i,n=!1){this.handler=void 0,this.name=void 0,this.callback=void 0,this.scope=void 0,this._once=void 0,this._removed=!1,this.handler=e,this.name=t,this.callback=s,this.scope=i,this._once=n}off(){this._removed||this.handler.off(this.name,this.callback,this.scope)}on(e,t,s=this){return this.handler._addCallback(e,t,s,!1)}once(e,t,s=this){return this.handler._addCallback(e,t,s,!0)}set removed(e){e&&(this._removed=!0)}get removed(){return this._removed}}class od{constructor(){this._callbacks=new Map,this._callbackActive=new Map}initEventHandler(){this._callbacks=new Map,this._callbackActive=new Map}_addCallback(e,t,s,i){if(this._callbacks.has(e)||this._callbacks.set(e,[]),this._callbackActive.has(e)){const t=this._callbackActive.get(e);t&&t===this._callbacks.get(e)&&this._callbackActive.set(e,t.slice())}const n=new ad(this,e,t,s,i);return this._callbacks.get(e).push(n),n}on(e,t,s=this){return this._addCallback(e,t,s,!1)}once(e,t,s=this){return this._addCallback(e,t,s,!0)}off(e,t,s){if(e)this._callbackActive.has(e)&&this._callbackActive.get(e)===this._callbacks.get(e)&&this._callbackActive.set(e,this._callbackActive.get(e).slice());else for(const[e,t]of this._callbackActive)this._callbacks.has(e)&&this._callbacks.get(e)===t&&this._callbackActive.set(e,t.slice());if(e)if(t){const i=this._callbacks.get(e);if(!i)return this;for(let e=0;e<i.length;e++)i[e].callback===t&&(s&&i[e].scope!==s||(i[e].removed=!0,i.splice(e,1),e--));0===i.length&&this._callbacks.delete(e)}else{const t=this._callbacks.get(e);if(t){for(let e=0;e<t.length;e++)t[e].removed=!0;this._callbacks.delete(e)}}else{for(const e of this._callbacks.values())for(let t=0;t<e.length;t++)e[t].removed=!0;this._callbacks.clear()}return this}fire(e,t,s,i,n,r,a,o,l){if(!e)return this;const h=this._callbacks.get(e);if(!h)return this;let c;this._callbackActive.has(e)?this._callbackActive.get(e)!==h&&(c=h.slice()):this._callbackActive.set(e,h);for(let h=0;(c||this._callbackActive.get(e))&&h<(c||this._callbackActive.get(e)).length;h++){const d=(c||this._callbackActive.get(e))[h];if(d.callback&&(d.callback.call(d.scope,t,s,i,n,r,a,o,l),d._once)){const t=this._callbacks.get(e),s=t?t.indexOf(d):-1;if(-1!==s){this._callbackActive.get(e)===t&&this._callbackActive.set(e,this._callbackActive.get(e).slice());const i=this._callbacks.get(e);if(!i)continue;i[s].removed=!0,i.splice(s,1),0===i.length&&this._callbacks.delete(e)}}}return c||this._callbackActive.delete(e),this}hasEvent(e){var t;return!(null==(t=this._callbacks.get(e))||!t.length)}}const ld={attach(e){const t=ld;return e._addCallback=t._addCallback,e.on=t.on,e.off=t.off,e.fire=t.fire,e.once=t.once,e.hasEvent=t.hasEvent,od.prototype.initEventHandler.call(e),e},_addCallback:od.prototype._addCallback,on:od.prototype.on,off:od.prototype.off,fire:od.prototype.fire,once:od.prototype.once,hasEvent:od.prototype.hasEvent},hd={create:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))},cd={delimiter:"/",join(...e){let t=e[0];for(let s=0;s<e.length-1;s++){const i=e[s],n=e[s+1];n[0]!==cd.delimiter?i&&n&&i[i.length-1]!==cd.delimiter&&n[0]!==cd.delimiter?t+=cd.delimiter+n:t+=n:t=n}return t},normalize(e){const t=e.startsWith(cd.delimiter),s=e.endsWith(cd.delimiter),i=e.split("/");let n="",r=[];for(let e=0;e<i.length;e++)""!==i[e]&&"."!==i[e]&&(".."===i[e]&&r.length>0?r=r.slice(0,r.length-2):(e>0&&r.push(cd.delimiter),r.push(i[e])));return n=r.join(""),t||n[0]!==cd.delimiter||(n=n.slice(1)),s&&n[n.length-1]!==cd.delimiter&&(n+=cd.delimiter),n},split(e){const t=e.lastIndexOf(cd.delimiter);return-1!==t?[e.substring(0,t),e.substring(t+1)]:["",e]},getBasename:e=>cd.split(e)[1],getDirectory:e=>cd.split(e)[0],getExtension(e){const t=e.split("?")[0].split(".").pop();return t!==e?"."+t:""},isRelativePath:e=>"/"!==e.charAt(0)&&null===e.match(/:\/\//),extractPath(e){let t="";const s=e.split("/");let i=0;if(s.length>1)if(cd.isRelativePath(e))if("."===s[0])for(i=0;i<s.length-1;++i)t+=0===i?s[i]:"/"+s[i];else if(".."===s[0])for(i=0;i<s.length-1;++i)t+=0===i?s[i]:"/"+s[i];else for(t=".",i=0;i<s.length-1;++i)t+="/"+s[i];else for(i=0;i<s.length-1;++i)t+=0===i?s[i]:"/"+s[i];return t}};var dd,ud,pd;const md="undefined"!=typeof navigator?navigator.userAgent:"",_d="undefined"!=typeof window?"browser":"undefined"!=typeof global?"node":"worker",fd=/android/i.test(md)?"android":/ip([ao]d|hone)/i.test(md)?"ios":/windows/i.test(md)?"windows":/mac os/i.test(md)?"osx":/linux/i.test(md)?"linux":/cros/i.test(md)?"cros":null,gd="browser"!==_d?null:/(Chrome\/|Chromium\/|Edg.*\/)/.test(md)?"chrome":/Safari\//.test(md)?"safari":/Firefox\//.test(md)?"firefox":"other",vd=/xbox/i.test(md),yd="browser"===_d&&("ontouchstart"in window||"maxTouchPoints"in navigator&&navigator.maxTouchPoints>0),bd=!("browser"!==_d||!navigator.getGamepads&&!navigator.webkitGetGamepads),xd="undefined"!=typeof Worker,wd=(()=>{let e=!1;try{const t=Object.defineProperty({},"passive",{get:function(){return e=!0,!1}});window.addEventListener("testpassive",null,t),window.removeEventListener("testpassive",null,t)}catch(e){}return e})(),Sd={name:fd,environment:_d,global:null!=(dd=null!=(ud=null!=(pd="undefined"!=typeof globalThis&&globalThis)?pd:"browser"===_d&&window)?ud:"node"===_d&&global)?dd:"worker"===_d&&self,browser:"browser"===_d,desktop:["windows","osx","linux","cros"].includes(fd),mobile:["android","ios"].includes(fd),ios:"ios"===fd,android:"android"===fd,xbox:vd,gamepads:bd,touch:yd,workers:xd,passiveEvents:wd,browserName:gd},Cd="abcdefghijklmnopqrstuvwxyz",Td="ABCDEFGHIJKLMNOPQRSTUVWXYZ",Ad=55296,Ed=56319,Pd=56320,Md=57343,Ld=127462,Dd=127487,kd=65024,Id=65039;function Rd(e,t=0){const s=e.length;if(t<0||t>=s)return null;const i=e.charCodeAt(t);if(s>1&&i>=Ad&&i<=Ed){const s=e.charCodeAt(t+1);if(s>=Pd&&s<=Md)return{code:1024*(i-Ad)+s-Pd+65536,long:!0}}return{code:i,long:!1}}function Od(e,t,s){if(!e)return!1;const i=Rd(e);if(i){const e=i.code;return e>=t&&e<=s}return!1}function zd(e,t){if(t===e.length-1)return 1;if(Od(e[t],Ad,Ed)){const s=e.substring(t,t+2),i=e.substring(t+2,t+4);return Od(i,127995,127999)||Od(s,Ld,Dd)&&Od(i,Ld,Dd)?4:Od(i,kd,Id)?3:2}return Od(e[t+1],kd,Id)?2:1}const Fd={ASCII_LOWERCASE:Cd,ASCII_UPPERCASE:Td,ASCII_LETTERS:Cd+Td,format(e,...t){for(let s=0;s<t.length;s++)e=e.replace(`{${s}}`,t[s]);return e},getCodePoint(e,t){const s=Rd(e,t);return s&&s.code},getCodePoints(e){if("string"!=typeof e)throw new TypeError("Not a string");let t=0;const s=[];let i;for(;i=Rd(e,t);)s.push(i.code),t+=i.long?2:1;return s},getSymbols(e){if("string"!=typeof e)throw new TypeError("Not a string");let t=0;const s=e.length,i=[];let n,r=0;for(;t<s;){if(r+=zd(e,t+r),n=e[t+r],Od(n,8400,8447)&&(n=e[t+r++]),Od(n,kd,Id)&&(n=e[t+r++]),n&&8205===n.charCodeAt(0)){n=e[t+r++];continue}const s=e.substring(t,t+r);i.push(s),t+=r,r=0}return i},fromCodePoint(){const e=[];let t,s,i;for(let n=0;n<arguments.length;++n)t=Number(arguments[n]),s=t-65536,i=t>65535?[55296+(s>>10),s%1024+56320]:[t],e.push(String.fromCharCode.apply(null,i));return e.join("")}};class Vd{constructor(e){this.items=[],this.length=0,this.loopIndex=-1,this._sortBy=void 0,this._sortHandler=void 0,this._sortBy=e.sortBy,this._sortHandler=this._doSort.bind(this)}_binarySearch(e){let t=0,s=this.items.length-1;const i=e[this._sortBy];let n,r;for(;t<=s;)n=Math.floor((t+s)/2),r=this.items[n][this._sortBy],r<=i?t=n+1:r>i&&(s=n-1);return t}_doSort(e,t){const s=this._sortBy;return e[s]-t[s]}insert(e){const t=this._binarySearch(e);this.items.splice(t,0,e),this.length++,this.loopIndex>=t&&this.loopIndex++}append(e){this.items.push(e),this.length++}remove(e){const t=this.items.indexOf(e);t<0||(this.items.splice(t,1),this.length--,this.loopIndex>=t&&this.loopIndex--)}sort(){const e=this.loopIndex>=0?this.items[this.loopIndex]:null;this.items.sort(this._sortHandler),null!==e&&(this.loopIndex=this.items.indexOf(e))}}class Nd extends od{constructor(e){super(),this._index={},this._list=[],this._parent=e}add(){let e=!1;const t=this._processArguments(arguments,!0);if(!t.length)return e;for(let s=0;s<t.length;s++)this._index[t[s]]||(e=!0,this._index[t[s]]=!0,this._list.push(t[s]),this.fire("add",t[s],this._parent));return e&&this.fire("change",this._parent),e}remove(){let e=!1;if(!this._list.length)return e;const t=this._processArguments(arguments,!0);if(!t.length)return e;for(let s=0;s<t.length;s++)this._index[t[s]]&&(e=!0,delete this._index[t[s]],this._list.splice(this._list.indexOf(t[s]),1),this.fire("remove",t[s],this._parent));return e&&this.fire("change",this._parent),e}clear(){if(!this._list.length)return;const e=this._list.slice(0);this._list=[],this._index={};for(let t=0;t<e.length;t++)this.fire("remove",e[t],this._parent);this.fire("change",this._parent)}has(){return!!this._list.length&&this._has(this._processArguments(arguments))}_has(e){if(!this._list.length||!e.length)return!1;for(let t=0;t<e.length;t++)if(1===e[t].length){if(this._index[e[t][0]])return!0}else{let s=!0;for(let i=0;i<e[t].length;i++)if(!this._index[e[t][i]]){s=!1;break}if(s)return!0}return!1}list(){return this._list.slice(0)}_processArguments(e,t){const s=[];let i=[];if(!e||!e.length)return s;for(let n=0;n<e.length;n++)if(e[n]instanceof Array){t||(i=[]);for(let r=0;r<e[n].length;r++)"string"==typeof e[n][r]&&(t?s.push(e[n][r]):i.push(e[n][r]));!t&&i.length&&s.push(i)}else"string"==typeof e[n]&&(t?s.push(e[n]):s.push([e[n]]));return s}get size(){return this._list.length}}Nd.EVENT_ADD="add",Nd.EVENT_REMOVE="remove",Nd.EVENT_CHANGE="change";const Bd="undefined"!=typeof window&&window.performance&&window.performance.now?performance.now.bind(performance):Date.now,Ud=/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/;class Hd{constructor(e){this.scheme=void 0,this.authority=void 0,this.path=void 0,this.query=void 0,this.fragment=void 0;const t=e.match(Ud);this.scheme=t[2],this.authority=t[4],this.path=t[5],this.query=t[7],this.fragment=t[9]}toString(){let e="";return this.scheme&&(e+=this.scheme+":"),this.authority&&(e+="//"+this.authority),e+=this.path,this.query&&(e+="?"+this.query),this.fragment&&(e+="#"+this.fragment),e}getQuery(){const e={};if(this.query){const t=decodeURIComponent(this.query).split("&");for(const s of t){const t=s.split("=");e[t[0]]=t[1]}}return e}setQuery(e){let t="";for(const s in e)e.hasOwnProperty(s)&&(""!==t&&(t+="&"),t+=encodeURIComponent(s)+"="+encodeURIComponent(e[s]));this.query=t}}const Wd={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:(e,t,s)=>e>=s?s:e<=t?t:e,intToBytes24:e=>[e>>16&255,e>>8&255,255&e],intToBytes32:e=>[e>>24&255,e>>16&255,e>>8&255,255&e],bytesToInt24:(e,t,s)=>(e.length&&(s=e[2],t=e[1],e=e[0]),e<<16|t<<8|s),bytesToInt32:(e,t,s,i)=>(e.length&&(i=e[3],s=e[2],t=e[1],e=e[0]),(e<<24|t<<16|s<<8|i)>>>0),lerp:(e,t,s)=>e+(t-e)*Wd.clamp(s,0,1),lerpAngle:(e,t,s)=>(t-e>180&&(t-=360),t-e<-180&&(t+=360),Wd.lerp(e,t,Wd.clamp(s,0,1))),powerOfTwo:e=>0!==e&&!(e&e-1),nextPowerOfTwo:e=>(e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e),nearestPowerOfTwo:e=>Math.pow(2,Math.round(Math.log(e)/Math.log(2))),random(e,t){const s=t-e;return Math.random()*s+e},smoothstep:(e,t,s)=>s<=e?0:s>=t?1:(s=(s-e)/(t-e))*s*(3-2*s),smootherstep:(e,t,s)=>s<=e?0:s>=t?1:(s=(s-e)/(t-e))*s*s*(s*(6*s-15)+10),roundUp:(e,t)=>0===t?e:Math.ceil(e/t)*t,between(e,t,s,i){const n=Math.min(t,s),r=Math.max(t,s);return i?e>=n&&e<=r:e>n&&e<r}};var Gd;class jd{constructor(e=0,t=0,s=0,i=1){this.r=void 0,this.g=void 0,this.b=void 0,this.a=void 0;const n=e.length;3===n||4===n?(this.r=e[0],this.g=e[1],this.b=e[2],this.a=void 0!==e[3]?e[3]:1):(this.r=e,this.g=t,this.b=s,this.a=i)}clone(){return new(0,this.constructor)(this.r,this.g,this.b,this.a)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}equals(e){return this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}set(e,t,s,i=1){return this.r=e,this.g=t,this.b=s,this.a=i,this}lerp(e,t,s){return this.r=e.r+s*(t.r-e.r),this.g=e.g+s*(t.g-e.g),this.b=e.b+s*(t.b-e.b),this.a=e.a+s*(t.a-e.a),this}fromString(e){const t=parseInt(e.replace("#","0x"),16);let s;return e.length>7?s=Wd.intToBytes32(t):(s=Wd.intToBytes24(t),s[3]=255),this.set(s[0]/255,s[1]/255,s[2]/255,s[3]/255),this}toString(e){let t="#"+((1<<24)+(Math.round(255*this.r)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.b)).toString(16).slice(1);if(!0===e){const e=Math.round(255*this.a).toString(16);this.a<16/255?t+="0"+e:t+=e}return t}}Gd=jd,jd.BLACK=Object.freeze(new Gd(0,0,0,1)),jd.BLUE=Object.freeze(new Gd(0,0,1,1)),jd.CYAN=Object.freeze(new Gd(0,1,1,1)),jd.GRAY=Object.freeze(new Gd(.5,.5,.5,1)),jd.GREEN=Object.freeze(new Gd(0,1,0,1)),jd.MAGENTA=Object.freeze(new Gd(1,0,1,1)),jd.RED=Object.freeze(new Gd(1,0,0,1)),jd.WHITE=Object.freeze(new Gd(1,1,1,1)),jd.YELLOW=Object.freeze(new Gd(1,1,0,1));class qd{constructor(e,t=0){this._curve=void 0,this._left=-1/0,this._right=1/0,this._recip=0,this._p0=0,this._p1=0,this._m0=0,this._m1=0,this._curve=e,this._reset(t)}evaluate(e,t=!1){let s;(t||e<this._left||e>=this._right)&&this._reset(e);const i=this._curve.type;if(5===i)s=this._p0;else{const t=0===this._recip?0:(e-this._left)*this._recip;s=0===i?Wd.lerp(this._p0,this._p1,t):1===i?Wd.lerp(this._p0,this._p1,t*t*(3-2*t)):this._evaluateHermite(this._p0,this._p1,this._m0,this._m1,t)}return s}_reset(e){const t=this._curve.keys,s=t.length;if(s)if(e<t[0][0])this._left=-1/0,this._right=t[0][0],this._recip=0,this._p0=this._p1=t[0][1],this._m0=this._m1=0;else if(e>=t[s-1][0])this._left=t[s-1][0],this._right=1/0,this._recip=0,this._p0=this._p1=t[s-1][1],this._m0=this._m1=0;else{let s=0;for(;e>=t[s+1][0];)s++;this._left=t[s][0],this._right=t[s+1][0];const i=1/(this._right-this._left);this._recip=isFinite(i)?i:0,this._p0=t[s][1],this._p1=t[s+1][1],this._isHermite()&&this._calcTangents(t,s)}else this._left=-1/0,this._right=1/0,this._recip=0,this._p0=this._p1=this._m0=this._m1=0}_isHermite(){return 2===this._curve.type||3===this._curve.type||4===this._curve.type}_calcTangents(e,t){let s;const i=e[t],n=e[t+1];let r;if(s=0===t?[e[0][0]+(e[0][0]-e[1][0]),e[0][1]+(e[0][1]-e[1][1])]:e[t-1],r=t===e.length-2?[e[t+1][0]+(e[t+1][0]-e[t][0]),e[t+1][1]+(e[t+1][1]-e[t][1])]:e[t+2],4===this._curve.type){const e=2*(n[0]-i[0])/(n[0]-s[0]),t=2*(n[0]-i[0])/(r[0]-i[0]);this._m0=this._curve.tension*(isFinite(e)?e:0)*(n[1]-s[1]),this._m1=this._curve.tension*(isFinite(t)?t:0)*(r[1]-i[1])}else{const e=(n[0]-i[0])/(i[0]-s[0]),t=(n[0]-i[0])/(r[0]-n[0]),a=i[1]+(s[1]-i[1])*(isFinite(e)?e:0),o=n[1]+(r[1]-n[1])*(isFinite(t)?t:0),l=2===this._curve.type?.5:this._curve.tension;this._m0=l*(n[1]-a),this._m1=l*(o-i[1])}}_evaluateHermite(e,t,s,i,n){const r=n*n,a=n+n,o=1-n,l=o*o;return e*((1+a)*l)+s*(n*l)+t*(r*(3-a))+i*(r*(n-1))}}class Kd{constructor(e){if(this.keys=[],this.type=1,this.tension=.5,this._eval=new qd(this),e)for(let t=0;t<e.length-1;t+=2)this.keys.push([e[t],e[t+1]]);this.sort()}get length(){return this.keys.length}add(e,t){const s=this.keys,i=s.length;let n=0;for(;n<i&&!(s[n][0]>e);n++);const r=[e,t];return this.keys.splice(n,0,r),r}get(e){return this.keys[e]}sort(){this.keys.sort((function(e,t){return e[0]-t[0]}))}value(e){return this._eval.evaluate(e,!0)}closest(e){const t=this.keys,s=t.length;let i=2,n=null;for(let r=0;r<s;r++){const s=Math.abs(e-t[r][0]);if(!(i>=s))break;i=s,n=t[r]}return n}clone(){const e=new this.constructor;return e.keys=rd(e.keys,this.keys),e.type=this.type,e.tension=this.tension,e}quantize(e){e=Math.max(e,2);const t=new Float32Array(e),s=1/(e-1);t[0]=this._eval.evaluate(0,!0);for(let i=1;i<e;i++)t[i]=this._eval.evaluate(s*i);return t}quantizeClamped(e,t,s){const i=this.quantize(e);for(let e=0;e<i.length;++e)i[e]=Math.min(s,Math.max(t,i[e]));return i}}class Xd{constructor(){if(this.curves=[],this._type=1,arguments.length>1)for(let e=0;e<arguments.length;e++)this.curves.push(new Kd(arguments[e]));else if(0===arguments.length)this.curves.push(new Kd);else{const e=arguments[0];if("number"==typeof e)for(let t=0;t<e;t++)this.curves.push(new Kd);else for(let t=0;t<e.length;t++)this.curves.push(new Kd(e[t]))}}get length(){return this.curves.length}set type(e){this._type=e;for(let t=0;t<this.curves.length;t++)this.curves[t].type=e}get type(){return this._type}get(e){return this.curves[e]}value(e,t=[]){const s=this.curves.length;t.length=s;for(let i=0;i<s;i++)t[i]=this.curves[i].value(e);return t}clone(){const e=new this.constructor;e.curves=[];for(let t=0;t<this.curves.length;t++)e.curves.push(this.curves[t].clone());return e._type=this._type,e}quantize(e){e=Math.max(e,2);const t=this.curves.length,s=new Float32Array(e*t),i=1/(e-1);for(let n=0;n<t;n++){const r=new qd(this.curves[n]);for(let a=0;a<e;a++)s[a*t+n]=r.evaluate(i*a)}return s}quantizeClamped(e,t,s){const i=this.quantize(e);for(let e=0;e<i.length;++e)i[e]=Math.min(s,Math.max(t,i[e]));return i}}const Yd=1/255,Zd=new Float32Array(1),$d=new Int32Array(Zd.buffer);class Qd{static float2Half(e){Zd[0]=e;const t=$d[0];let s=t>>16&32768,i=t>>12&2047;const n=t>>23&255;return n<103?s:n>142?(s|=31744,s|=(255===n?0:1)&&8388607&t,s):n<113?(i|=2048,s|=(i>>114-n)+(i>>113-n&1),s):(s|=n-112<<10|i>>1,s+=1&i,s)}static float2Bytes(e,t,s,i){const n=255*e%1;if(t[s+0]=Math.round(255*(e%1-Yd*n)),i>1){const r=65025*e%1;if(t[s+1]=Math.round(255*(n-Yd*r)),i>2){const n=16581375*e%1;t[s+2]=Math.round(255*(r-Yd*n)),i>3&&(t[s+3]=Math.round(255*n))}}}static float2BytesRange(e,t,s,i,n,r){e=Wd.clamp((e-i)/(n-i),0,1),Qd.float2Bytes(e,t,s,r)}static float2MantissaExponent(e,t,s,i){const n=Math.floor(Math.log2(Math.abs(e)))+1;e/=Math.pow(2,n),Qd.float2BytesRange(e,t,s,-1,1,i-1),t[s+i-1]=Math.round(n+127)}}var Jd,eu,tu,su,iu;class nu{constructor(e=0,t=0,s=0){this.x=void 0,this.y=void 0,this.z=void 0,3===e.length?(this.x=e[0],this.y=e[1],this.z=e[2]):(this.x=e,this.y=t,this.z=s)}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}clone(){return new(0,this.constructor)(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}cross(e,t){const s=e.x,i=e.y,n=e.z,r=t.x,a=t.y,o=t.z;return this.x=i*o-a*n,this.y=n*r-o*s,this.z=s*a-r*i,this}distance(e){const t=this.x-e.x,s=this.y-e.y,i=this.z-e.z;return Math.sqrt(t*t+s*s+i*i)}div(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this.z=e.z/t.z,this}divScalar(e){return this.x/=e,this.y/=e,this.z/=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z}equalsApprox(e,t=1e-6){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}lerp(e,t,s){return this.x=e.x+s*(t.x-e.x),this.y=e.y+s*(t.y-e.y),this.z=e.z+s*(t.z-e.z),this}mul(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}mulScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}normalize(e=this){const t=e.x*e.x+e.y*e.y+e.z*e.z;if(t>0){const s=1/Math.sqrt(t);this.x=e.x*s,this.y=e.y*s,this.z=e.z*s}return this}floor(e=this){return this.x=Math.floor(e.x),this.y=Math.floor(e.y),this.z=Math.floor(e.z),this}ceil(e=this){return this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this.z=Math.ceil(e.z),this}round(e=this){return this.x=Math.round(e.x),this.y=Math.round(e.y),this.z=Math.round(e.z),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),this}project(e){const t=(this.x*e.x+this.y*e.y+this.z*e.z)/(e.x*e.x+e.y*e.y+e.z*e.z);return this.x=e.x*t,this.y=e.y*t,this.z=e.z*t,this}set(e,t,s){return this.x=e,this.y=t,this.z=s,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}toString(){return`[${this.x}, ${this.y}, ${this.z}]`}}Jd=nu,nu.ZERO=Object.freeze(new Jd(0,0,0)),nu.ONE=Object.freeze(new Jd(1,1,1)),nu.UP=Object.freeze(new Jd(0,1,0)),nu.DOWN=Object.freeze(new Jd(0,-1,0)),nu.RIGHT=Object.freeze(new Jd(1,0,0)),nu.LEFT=Object.freeze(new Jd(-1,0,0)),nu.FORWARD=Object.freeze(new Jd(0,0,-1)),nu.BACK=Object.freeze(new Jd(0,0,1));class ru{constructor(){this.data=new Float32Array(9),this.data[0]=this.data[4]=this.data[8]=1}clone(){return(new(0,this.constructor)).copy(this)}copy(e){const t=e.data,s=this.data;return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8],this}set(e){const t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],this}getX(e=new nu){return e.set(this.data[0],this.data[1],this.data[2])}getY(e=new nu){return e.set(this.data[3],this.data[4],this.data[5])}getZ(e=new nu){return e.set(this.data[6],this.data[7],this.data[8])}equals(e){const t=this.data,s=e.data;return t[0]===s[0]&&t[1]===s[1]&&t[2]===s[2]&&t[3]===s[3]&&t[4]===s[4]&&t[5]===s[5]&&t[6]===s[6]&&t[7]===s[7]&&t[8]===s[8]}isIdentity(){const e=this.data;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&1===e[4]&&0===e[5]&&0===e[6]&&0===e[7]&&1===e[8]}setIdentity(){const e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,this}toString(){return"["+this.data.join(", ")+"]"}transpose(e=this){const t=e.data,s=this.data;if(t===s){let e;e=t[1],s[1]=t[3],s[3]=e,e=t[2],s[2]=t[6],s[6]=e,e=t[5],s[5]=t[7],s[7]=e}else s[0]=t[0],s[1]=t[3],s[2]=t[6],s[3]=t[1],s[4]=t[4],s[5]=t[7],s[6]=t[2],s[7]=t[5],s[8]=t[8];return this}setFromMat4(e){const t=e.data,s=this.data;return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[4],s[4]=t[5],s[5]=t[6],s[6]=t[8],s[7]=t[9],s[8]=t[10],this}invertMat4(e){const t=e.data,s=t[0],i=t[1],n=t[2],r=t[4],a=t[5],o=t[6],l=t[8],h=t[9],c=t[10],d=c*a-o*h,u=-c*i+n*h,p=o*i-n*a,m=-c*r+o*l,_=c*s-n*l,f=-o*s+n*r,g=h*r-a*l,v=-h*s+i*l,y=a*s-i*r,b=s*d+i*m+n*g;if(0===b)this.setIdentity();else{const e=1/b,t=this.data;t[0]=d*e,t[1]=u*e,t[2]=p*e,t[3]=m*e,t[4]=_*e,t[5]=f*e,t[6]=g*e,t[7]=v*e,t[8]=y*e}return this}transformVector(e,t=new nu){const s=this.data,i=e.x,n=e.y,r=e.z;return t.x=i*s[0]+n*s[3]+r*s[6],t.y=i*s[1]+n*s[4]+r*s[7],t.z=i*s[2]+n*s[5]+r*s[8],t}}eu=ru,ru.IDENTITY=Object.freeze(new eu),ru.ZERO=Object.freeze((new eu).set([0,0,0,0,0,0,0,0,0]));class au{constructor(e=0,t=0){this.x=void 0,this.y=void 0,2===e.length?(this.x=e[0],this.y=e[1]):(this.x=e,this.y=t)}add(e){return this.x+=e.x,this.y+=e.y,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}clone(){return new(0,this.constructor)(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}cross(e){return this.x*e.y-this.y*e.x}distance(e){const t=this.x-e.x,s=this.y-e.y;return Math.sqrt(t*t+s*s)}div(e){return this.x/=e.x,this.y/=e.y,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this}divScalar(e){return this.x/=e,this.y/=e,this}dot(e){return this.x*e.x+this.y*e.y}equals(e){return this.x===e.x&&this.y===e.y}equalsApprox(e,t=1e-6){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSq(){return this.x*this.x+this.y*this.y}lerp(e,t,s){return this.x=e.x+s*(t.x-e.x),this.y=e.y+s*(t.y-e.y),this}mul(e){return this.x*=e.x,this.y*=e.y,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this}mulScalar(e){return this.x*=e,this.y*=e,this}normalize(e=this){const t=e.x*e.x+e.y*e.y;if(t>0){const s=1/Math.sqrt(t);this.x=e.x*s,this.y=e.y*s}return this}rotate(e){const t=Math.atan2(this.x,this.y)+e*Wd.DEG_TO_RAD,s=Math.sqrt(this.x*this.x+this.y*this.y);return this.x=Math.sin(t)*s,this.y=Math.cos(t)*s,this}angle(){return Math.atan2(this.x,this.y)*Wd.RAD_TO_DEG}angleTo(e){return Math.atan2(this.x*e.y+this.y*e.x,this.x*e.x+this.y*e.y)*Wd.RAD_TO_DEG}floor(e=this){return this.x=Math.floor(e.x),this.y=Math.floor(e.y),this}ceil(e=this){return this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this}round(e=this){return this.x=Math.round(e.x),this.y=Math.round(e.y),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),this}set(e,t){return this.x=e,this.y=t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}subScalar(e){return this.x-=e,this.y-=e,this}toString(){return`[${this.x}, ${this.y}]`}static angleRad(e,t){return Math.atan2(e.x*t.y-e.y*t.x,e.x*t.x+e.y*t.y)}}tu=au,au.ZERO=Object.freeze(new tu(0,0)),au.ONE=Object.freeze(new tu(1,1)),au.UP=Object.freeze(new tu(0,1)),au.DOWN=Object.freeze(new tu(0,-1)),au.RIGHT=Object.freeze(new tu(1,0)),au.LEFT=Object.freeze(new tu(-1,0));class ou{constructor(e=0,t=0,s=0,i=0){this.x=void 0,this.y=void 0,this.z=void 0,this.w=void 0,4===e.length?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=e,this.y=t,this.z=s,this.w=i)}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}clone(){return new(0,this.constructor)(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}div(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this.z=e.z/t.z,this.w=e.w/t.w,this}divScalar(e){return this.x/=e,this.y/=e,this.z/=e,this.w/=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsApprox(e,t=1e-6){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t&&Math.abs(this.w-e.w)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}lerp(e,t,s){return this.x=e.x+s*(t.x-e.x),this.y=e.y+s*(t.y-e.y),this.z=e.z+s*(t.z-e.z),this.w=e.w+s*(t.w-e.w),this}mul(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this.w=e.w*t.w,this}mulScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}normalize(e=this){const t=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w;if(t>0){const s=1/Math.sqrt(t);this.x=e.x*s,this.y=e.y*s,this.z=e.z*s,this.w=e.w*s}return this}floor(e=this){return this.x=Math.floor(e.x),this.y=Math.floor(e.y),this.z=Math.floor(e.z),this.w=Math.floor(e.w),this}ceil(e=this){return this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this.z=Math.ceil(e.z),this.w=Math.ceil(e.w),this}round(e=this){return this.x=Math.round(e.x),this.y=Math.round(e.y),this.z=Math.round(e.z),this.w=Math.round(e.w),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this}set(e,t,s,i){return this.x=e,this.y=t,this.z=s,this.w=i,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}toString(){return`[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}}su=ou,ou.ZERO=Object.freeze(new su(0,0,0,0)),ou.ONE=Object.freeze(new su(1,1,1,1));const lu=new au,hu=new nu,cu=new nu,du=new nu,uu=new nu;class pu{constructor(){this.data=new Float32Array(16),this.data[0]=this.data[5]=this.data[10]=this.data[15]=1}static _getPerspectiveHalfSize(e,t,s,i,n){n?(e.x=i*Math.tan(t*Math.PI/360),e.y=e.x/s):(e.y=i*Math.tan(t*Math.PI/360),e.x=e.y*s)}add2(e,t){const s=e.data,i=t.data,n=this.data;return n[0]=s[0]+i[0],n[1]=s[1]+i[1],n[2]=s[2]+i[2],n[3]=s[3]+i[3],n[4]=s[4]+i[4],n[5]=s[5]+i[5],n[6]=s[6]+i[6],n[7]=s[7]+i[7],n[8]=s[8]+i[8],n[9]=s[9]+i[9],n[10]=s[10]+i[10],n[11]=s[11]+i[11],n[12]=s[12]+i[12],n[13]=s[13]+i[13],n[14]=s[14]+i[14],n[15]=s[15]+i[15],this}add(e){return this.add2(this,e)}clone(){return(new(0,this.constructor)).copy(this)}copy(e){const t=e.data,s=this.data;return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8],s[9]=t[9],s[10]=t[10],s[11]=t[11],s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15],this}equals(e){const t=this.data,s=e.data;return t[0]===s[0]&&t[1]===s[1]&&t[2]===s[2]&&t[3]===s[3]&&t[4]===s[4]&&t[5]===s[5]&&t[6]===s[6]&&t[7]===s[7]&&t[8]===s[8]&&t[9]===s[9]&&t[10]===s[10]&&t[11]===s[11]&&t[12]===s[12]&&t[13]===s[13]&&t[14]===s[14]&&t[15]===s[15]}isIdentity(){const e=this.data;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]}mul2(e,t){const s=e.data,i=t.data,n=this.data,r=s[0],a=s[1],o=s[2],l=s[3],h=s[4],c=s[5],d=s[6],u=s[7],p=s[8],m=s[9],_=s[10],f=s[11],g=s[12],v=s[13],y=s[14],b=s[15];let x,w,S,C;return x=i[0],w=i[1],S=i[2],C=i[3],n[0]=r*x+h*w+p*S+g*C,n[1]=a*x+c*w+m*S+v*C,n[2]=o*x+d*w+_*S+y*C,n[3]=l*x+u*w+f*S+b*C,x=i[4],w=i[5],S=i[6],C=i[7],n[4]=r*x+h*w+p*S+g*C,n[5]=a*x+c*w+m*S+v*C,n[6]=o*x+d*w+_*S+y*C,n[7]=l*x+u*w+f*S+b*C,x=i[8],w=i[9],S=i[10],C=i[11],n[8]=r*x+h*w+p*S+g*C,n[9]=a*x+c*w+m*S+v*C,n[10]=o*x+d*w+_*S+y*C,n[11]=l*x+u*w+f*S+b*C,x=i[12],w=i[13],S=i[14],C=i[15],n[12]=r*x+h*w+p*S+g*C,n[13]=a*x+c*w+m*S+v*C,n[14]=o*x+d*w+_*S+y*C,n[15]=l*x+u*w+f*S+b*C,this}mulAffine2(e,t){const s=e.data,i=t.data,n=this.data,r=s[0],a=s[1],o=s[2],l=s[4],h=s[5],c=s[6],d=s[8],u=s[9],p=s[10],m=s[12],_=s[13],f=s[14];let g,v,y;return g=i[0],v=i[1],y=i[2],n[0]=r*g+l*v+d*y,n[1]=a*g+h*v+u*y,n[2]=o*g+c*v+p*y,n[3]=0,g=i[4],v=i[5],y=i[6],n[4]=r*g+l*v+d*y,n[5]=a*g+h*v+u*y,n[6]=o*g+c*v+p*y,n[7]=0,g=i[8],v=i[9],y=i[10],n[8]=r*g+l*v+d*y,n[9]=a*g+h*v+u*y,n[10]=o*g+c*v+p*y,n[11]=0,g=i[12],v=i[13],y=i[14],n[12]=r*g+l*v+d*y+m,n[13]=a*g+h*v+u*y+_,n[14]=o*g+c*v+p*y+f,n[15]=1,this}mul(e){return this.mul2(this,e)}transformPoint(e,t=new nu){const s=this.data,i=e.x,n=e.y,r=e.z;return t.x=i*s[0]+n*s[4]+r*s[8]+s[12],t.y=i*s[1]+n*s[5]+r*s[9]+s[13],t.z=i*s[2]+n*s[6]+r*s[10]+s[14],t}transformVector(e,t=new nu){const s=this.data,i=e.x,n=e.y,r=e.z;return t.x=i*s[0]+n*s[4]+r*s[8],t.y=i*s[1]+n*s[5]+r*s[9],t.z=i*s[2]+n*s[6]+r*s[10],t}transformVec4(e,t=new ou){const s=this.data,i=e.x,n=e.y,r=e.z,a=e.w;return t.x=i*s[0]+n*s[4]+r*s[8]+a*s[12],t.y=i*s[1]+n*s[5]+r*s[9]+a*s[13],t.z=i*s[2]+n*s[6]+r*s[10]+a*s[14],t.w=i*s[3]+n*s[7]+r*s[11]+a*s[15],t}setLookAt(e,t,s){du.sub2(e,t).normalize(),cu.copy(s).normalize(),hu.cross(cu,du).normalize(),cu.cross(du,hu);const i=this.data;return i[0]=hu.x,i[1]=hu.y,i[2]=hu.z,i[3]=0,i[4]=cu.x,i[5]=cu.y,i[6]=cu.z,i[7]=0,i[8]=du.x,i[9]=du.y,i[10]=du.z,i[11]=0,i[12]=e.x,i[13]=e.y,i[14]=e.z,i[15]=1,this}setFrustum(e,t,s,i,n,r){const a=2*n,o=t-e,l=i-s,h=r-n,c=this.data;return c[0]=a/o,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=a/l,c[6]=0,c[7]=0,c[8]=(t+e)/o,c[9]=(i+s)/l,c[10]=(-r-n)/h,c[11]=-1,c[12]=0,c[13]=0,c[14]=-a*r/h,c[15]=0,this}setPerspective(e,t,s,i,n){return pu._getPerspectiveHalfSize(lu,e,t,s,n),this.setFrustum(-lu.x,lu.x,-lu.y,lu.y,s,i)}setOrtho(e,t,s,i,n,r){const a=this.data;return a[0]=2/(t-e),a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/(i-s),a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-2/(r-n),a[11]=0,a[12]=-(t+e)/(t-e),a[13]=-(i+s)/(i-s),a[14]=-(r+n)/(r-n),a[15]=1,this}setFromAxisAngle(e,t){t*=Wd.DEG_TO_RAD;const s=e.x,i=e.y,n=e.z,r=Math.cos(t),a=Math.sin(t),o=1-r,l=o*s,h=o*i,c=this.data;return c[0]=l*s+r,c[1]=l*i+a*n,c[2]=l*n-a*i,c[3]=0,c[4]=l*i-a*n,c[5]=h*i+r,c[6]=h*n+a*s,c[7]=0,c[8]=l*n+a*i,c[9]=h*n-s*a,c[10]=o*n*n+r,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,this}setTranslate(e,t,s){const i=this.data;return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=e,i[13]=t,i[14]=s,i[15]=1,this}setScale(e,t,s){const i=this.data;return i[0]=e,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=t,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=s,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,this}setViewport(e,t,s,i){const n=this.data;return n[0]=.5*s,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=.5*i,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=.5,n[11]=0,n[12]=e+.5*s,n[13]=t+.5*i,n[14]=.5,n[15]=1,this}setReflection(e,t){const s=e.x,i=e.y,n=e.z,r=this.data;return r[0]=1-2*s*s,r[1]=-2*s*i,r[2]=-2*s*n,r[3]=0,r[4]=-2*s*i,r[5]=1-2*i*i,r[6]=-2*i*n,r[7]=0,r[8]=-2*s*n,r[9]=-2*i*n,r[10]=1-2*n*n,r[11]=0,r[12]=-2*s*t,r[13]=-2*i*t,r[14]=-2*n*t,r[15]=1,this}invert(e=this){const t=e.data,s=t[0],i=t[1],n=t[2],r=t[3],a=t[4],o=t[5],l=t[6],h=t[7],c=t[8],d=t[9],u=t[10],p=t[11],m=t[12],_=t[13],f=t[14],g=t[15],v=s*o-i*a,y=s*l-n*a,b=s*h-r*a,x=i*l-n*o,w=i*h-r*o,S=n*h-r*l,C=c*_-d*m,T=c*f-u*m,A=c*g-p*m,E=d*f-u*_,P=d*g-p*_,M=u*g-p*f,L=v*M-y*P+b*E+x*A-w*T+S*C;if(0===L)this.setIdentity();else{const e=1/L,t=this.data;t[0]=(o*M-l*P+h*E)*e,t[1]=(-i*M+n*P-r*E)*e,t[2]=(_*S-f*w+g*x)*e,t[3]=(-d*S+u*w-p*x)*e,t[4]=(-a*M+l*A-h*T)*e,t[5]=(s*M-n*A+r*T)*e,t[6]=(-m*S+f*b-g*y)*e,t[7]=(c*S-u*b+p*y)*e,t[8]=(a*P-o*A+h*C)*e,t[9]=(-s*P+i*A-r*C)*e,t[10]=(m*w-_*b+g*v)*e,t[11]=(-c*w+d*b-p*v)*e,t[12]=(-a*E+o*T-l*C)*e,t[13]=(s*E-i*T+n*C)*e,t[14]=(-m*x+_*y-f*v)*e,t[15]=(c*x-d*y+u*v)*e}return this}set(e){const t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],this}setIdentity(){const e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}setTRS(e,t,s){const i=t.x,n=t.y,r=t.z,a=t.w,o=s.x,l=s.y,h=s.z,c=i+i,d=n+n,u=r+r,p=i*c,m=i*d,_=i*u,f=n*d,g=n*u,v=r*u,y=a*c,b=a*d,x=a*u,w=this.data;return w[0]=(1-(f+v))*o,w[1]=(m+x)*o,w[2]=(_-b)*o,w[3]=0,w[4]=(m-x)*l,w[5]=(1-(p+v))*l,w[6]=(g+y)*l,w[7]=0,w[8]=(_+b)*h,w[9]=(g-y)*h,w[10]=(1-(p+f))*h,w[11]=0,w[12]=e.x,w[13]=e.y,w[14]=e.z,w[15]=1,this}transpose(e=this){const t=e.data,s=this.data;if(t===s){let e;e=t[1],s[1]=t[4],s[4]=e,e=t[2],s[2]=t[8],s[8]=e,e=t[3],s[3]=t[12],s[12]=e,e=t[6],s[6]=t[9],s[9]=e,e=t[7],s[7]=t[13],s[13]=e,e=t[11],s[11]=t[14],s[14]=e}else s[0]=t[0],s[1]=t[4],s[2]=t[8],s[3]=t[12],s[4]=t[1],s[5]=t[5],s[6]=t[9],s[7]=t[13],s[8]=t[2],s[9]=t[6],s[10]=t[10],s[11]=t[14],s[12]=t[3],s[13]=t[7],s[14]=t[11],s[15]=t[15];return this}getTranslation(e=new nu){return e.set(this.data[12],this.data[13],this.data[14])}getX(e=new nu){return e.set(this.data[0],this.data[1],this.data[2])}getY(e=new nu){return e.set(this.data[4],this.data[5],this.data[6])}getZ(e=new nu){return e.set(this.data[8],this.data[9],this.data[10])}getScale(e=new nu){return this.getX(hu),this.getY(cu),this.getZ(du),e.set(hu.length(),cu.length(),du.length()),e}get scaleSign(){return this.getX(hu),this.getY(cu),this.getZ(du),hu.cross(hu,cu),hu.dot(du)<0?-1:1}setFromEulerAngles(e,t,s){e*=Wd.DEG_TO_RAD,t*=Wd.DEG_TO_RAD,s*=Wd.DEG_TO_RAD;const i=Math.sin(-e),n=Math.cos(-e),r=Math.sin(-t),a=Math.cos(-t),o=Math.sin(-s),l=Math.cos(-s),h=this.data;return h[0]=a*l,h[1]=-a*o,h[2]=r,h[3]=0,h[4]=n*o+l*i*r,h[5]=n*l-i*r*o,h[6]=-a*i,h[7]=0,h[8]=i*o-n*l*r,h[9]=l*i+n*r*o,h[10]=n*a,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,this}getEulerAngles(e=new nu){this.getScale(uu);const t=uu.x,s=uu.y,i=uu.z;if(0===t||0===s||0===i)return e.set(0,0,0);const n=this.data,r=Math.asin(-n[2]/t),a=.5*Math.PI;let o,l;return r<a?r>-a?(o=Math.atan2(n[6]/s,n[10]/i),l=Math.atan2(n[1]/t,n[0]/t)):(l=0,o=-Math.atan2(n[4]/s,n[5]/s)):(l=0,o=Math.atan2(n[4]/s,n[5]/s)),e.set(o,r,l).mulScalar(Wd.RAD_TO_DEG)}toString(){return"["+this.data.join(", ")+"]"}}var mu;iu=pu,pu.IDENTITY=Object.freeze(new iu),pu.ZERO=Object.freeze((new iu).set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]));class _u{constructor(e=0,t=0,s=0,i=1){this.x=void 0,this.y=void 0,this.z=void 0,this.w=void 0,4===e.length?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=e,this.y=t,this.z=s,this.w=i)}clone(){return new(0,this.constructor)(this.x,this.y,this.z,this.w)}conjugate(e=this){return this.x=-1*e.x,this.y=-1*e.y,this.z=-1*e.z,this.w=e.w,this}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsApprox(e,t=1e-6){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t&&Math.abs(this.w-e.w)<t}getAxisAngle(e){let t=2*Math.acos(this.w);const s=Math.sin(t/2);return 0!==s?(e.x=this.x/s,e.y=this.y/s,e.z=this.z/s,(e.x<0||e.y<0||e.z<0)&&(e.x*=-1,e.y*=-1,e.z*=-1,t*=-1)):(e.x=1,e.y=0,e.z=0),t*Wd.RAD_TO_DEG}getEulerAngles(e=new nu){let t,s,i;const n=this.x,r=this.y,a=this.z,o=this.w,l=2*(o*r-n*a);return l<=-.99999?(t=2*Math.atan2(n,o),s=-Math.PI/2,i=0):l>=.99999?(t=2*Math.atan2(n,o),s=Math.PI/2,i=0):(t=Math.atan2(2*(o*n+r*a),1-2*(n*n+r*r)),s=Math.asin(l),i=Math.atan2(2*(o*a+n*r),1-2*(r*r+a*a))),e.set(t,s,i).mulScalar(Wd.RAD_TO_DEG)}invert(e=this){return this.conjugate(e).normalize()}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}mul(e){const t=this.x,s=this.y,i=this.z,n=this.w,r=e.x,a=e.y,o=e.z,l=e.w;return this.x=n*r+t*l+s*o-i*a,this.y=n*a+s*l+i*r-t*o,this.z=n*o+i*l+t*a-s*r,this.w=n*l-t*r-s*a-i*o,this}mul2(e,t){const s=e.x,i=e.y,n=e.z,r=e.w,a=t.x,o=t.y,l=t.z,h=t.w;return this.x=r*a+s*h+i*l-n*o,this.y=r*o+i*h+n*a-s*l,this.z=r*l+n*h+s*o-i*a,this.w=r*h-s*a-i*o-n*l,this}normalize(e=this){let t=e.length();return 0===t?(this.x=this.y=this.z=0,this.w=1):(t=1/t,this.x=e.x*t,this.y=e.y*t,this.z=e.z*t,this.w=e.w*t),this}set(e,t,s,i){return this.x=e,this.y=t,this.z=s,this.w=i,this}setFromAxisAngle(e,t){t*=.5*Wd.DEG_TO_RAD;const s=Math.sin(t),i=Math.cos(t);return this.x=s*e.x,this.y=s*e.y,this.z=s*e.z,this.w=i,this}setFromEulerAngles(e,t,s){if(e instanceof nu){const i=e;e=i.x,t=i.y,s=i.z}const i=.5*Wd.DEG_TO_RAD;e*=i,t*=i,s*=i;const n=Math.sin(e),r=Math.cos(e),a=Math.sin(t),o=Math.cos(t),l=Math.sin(s),h=Math.cos(s);return this.x=n*o*h-r*a*l,this.y=r*a*h+n*o*l,this.z=r*o*l-n*a*h,this.w=r*o*h+n*a*l,this}setFromMat4(e){let t,s,i,n,r,a,o,l,h,c,d,u,p,m;if(t=(e=e.data)[0],s=e[1],i=e[2],n=e[4],r=e[5],a=e[6],o=e[8],l=e[9],h=e[10],u=t*t+s*s+i*i,0===u)return this;if(u=1/Math.sqrt(u),p=n*n+r*r+a*a,0===p)return this;if(p=1/Math.sqrt(p),m=o*o+l*l+h*h,0===m)return this;m=1/Math.sqrt(m),t*=u,s*=u,i*=u,n*=p,r*=p,a*=p,o*=m,l*=m,h*=m;const _=t+r+h;return _>=0?(c=Math.sqrt(_+1),this.w=.5*c,c=.5/c,this.x=(a-l)*c,this.y=(o-i)*c,this.z=(s-n)*c):t>r?t>h?(d=t-(r+h)+1,d=Math.sqrt(d),this.x=.5*d,d=.5/d,this.w=(a-l)*d,this.y=(s+n)*d,this.z=(i+o)*d):(d=h-(t+r)+1,d=Math.sqrt(d),this.z=.5*d,d=.5/d,this.w=(s-n)*d,this.x=(o+i)*d,this.y=(l+a)*d):r>h?(d=r-(h+t)+1,d=Math.sqrt(d),this.y=.5*d,d=.5/d,this.w=(o-i)*d,this.z=(a+l)*d,this.x=(n+s)*d):(d=h-(t+r)+1,d=Math.sqrt(d),this.z=.5*d,d=.5/d,this.w=(s-n)*d,this.x=(o+i)*d,this.y=(l+a)*d),this}setFromDirections(e,t){const s=1+e.dot(t);return s<Number.EPSILON?Math.abs(e.x)>Math.abs(e.y)?(this.x=-e.z,this.y=0,this.z=e.x,this.w=0):(this.x=0,this.y=-e.z,this.z=e.y,this.w=0):(this.x=e.y*t.z-e.z*t.y,this.y=e.z*t.x-e.x*t.z,this.z=e.x*t.y-e.y*t.x,this.w=s),this.normalize()}slerp(e,t,s){const i=e.x,n=e.y,r=e.z,a=e.w;let o=t.x,l=t.y,h=t.z,c=t.w,d=a*c+i*o+n*l+r*h;if(d<0&&(c=-c,o=-o,l=-l,h=-h,d=-d),Math.abs(d)>=1)return this.w=a,this.x=i,this.y=n,this.z=r,this;const u=Math.acos(d),p=Math.sqrt(1-d*d);if(Math.abs(p)<.001)return this.w=.5*a+.5*c,this.x=.5*i+.5*o,this.y=.5*n+.5*l,this.z=.5*r+.5*h,this;const m=Math.sin((1-s)*u)/p,_=Math.sin(s*u)/p;return this.w=a*m+c*_,this.x=i*m+o*_,this.y=n*m+l*_,this.z=r*m+h*_,this}transformVector(e,t=new nu){const s=e.x,i=e.y,n=e.z,r=this.x,a=this.y,o=this.z,l=this.w,h=l*s+a*n-o*i,c=l*i+o*s-r*n,d=l*n+r*i-a*s,u=-r*s-a*i-o*n;return t.x=h*l+u*-r+c*-o-d*-a,t.y=c*l+u*-a+d*-r-h*-o,t.z=d*l+u*-o+h*-a-c*-r,t}toString(){return`[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}}mu=_u,_u.IDENTITY=Object.freeze(new mu(0,0,0,1)),_u.ZERO=Object.freeze(new mu(0,0,0,0));const fu=new nu,gu=new nu,vu=new nu,yu=new nu,bu=new nu;class xu{constructor(e=new nu,t=new nu(.5,.5,.5)){this.center=void 0,this.halfExtents=void 0,this._min=new nu,this._max=new nu,this.center=e,this.halfExtents=t}add(e){const t=this.center,s=t.x,i=t.y,n=t.z,r=this.halfExtents,a=r.x,o=r.y,l=r.z;let h=s-a,c=s+a,d=i-o,u=i+o,p=n-l,m=n+l;const _=e.center,f=_.x,g=_.y,v=_.z,y=e.halfExtents,b=y.x,x=y.y,w=y.z,S=f-b,C=f+b,T=g-x,A=g+x,E=v-w,P=v+w;S<h&&(h=S),C>c&&(c=C),T<d&&(d=T),A>u&&(u=A),E<p&&(p=E),P>m&&(m=P),t.x=.5*(h+c),t.y=.5*(d+u),t.z=.5*(p+m),r.x=.5*(c-h),r.y=.5*(u-d),r.z=.5*(m-p)}copy(e){this.center.copy(e.center),this.halfExtents.copy(e.halfExtents)}clone(){return new xu(this.center.clone(),this.halfExtents.clone())}intersects(e){const t=this.getMax(),s=this.getMin(),i=e.getMax(),n=e.getMin();return s.x<=i.x&&t.x>=n.x&&s.y<=i.y&&t.y>=n.y&&s.z<=i.z&&t.z>=n.z}_intersectsRay(e,t){const s=fu.copy(this.getMin()).sub(e.origin),i=gu.copy(this.getMax()).sub(e.origin),n=e.direction;0===n.x?(s.x=s.x<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.x=i.x<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.x/=n.x,i.x/=n.x),0===n.y?(s.y=s.y<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.y=i.y<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.y/=n.y,i.y/=n.y),0===n.z?(s.z=s.z<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.z=i.z<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.z/=n.z,i.z/=n.z);const r=vu.set(Math.min(s.x,i.x),Math.min(s.y,i.y),Math.min(s.z,i.z)),a=yu.set(Math.max(s.x,i.x),Math.max(s.y,i.y),Math.max(s.z,i.z)),o=Math.min(Math.min(a.x,a.y),a.z),l=Math.max(Math.max(r.x,r.y),r.z),h=o>=l&&l>=0;return h&&t.copy(e.direction).mulScalar(l).add(e.origin),h}_fastIntersectsRay(e){const t=fu,s=gu,i=vu,n=yu,r=bu,a=e.direction;return t.sub2(e.origin,this.center),n.set(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z)),i.mul2(t,a),!(n.x>this.halfExtents.x&&i.x>=0)&&(!(n.y>this.halfExtents.y&&i.y>=0)&&(!(n.z>this.halfExtents.z&&i.z>=0)&&(r.set(Math.abs(a.x),Math.abs(a.y),Math.abs(a.z)),s.cross(a,t),s.set(Math.abs(s.x),Math.abs(s.y),Math.abs(s.z)),!(s.x>this.halfExtents.y*r.z+this.halfExtents.z*r.y)&&(!(s.y>this.halfExtents.x*r.z+this.halfExtents.z*r.x)&&!(s.z>this.halfExtents.x*r.y+this.halfExtents.y*r.x)))))}intersectsRay(e,t){return t?this._intersectsRay(e,t):this._fastIntersectsRay(e)}setMinMax(e,t){this.center.add2(t,e).mulScalar(.5),this.halfExtents.sub2(t,e).mulScalar(.5)}getMin(){return this._min.copy(this.center).sub(this.halfExtents)}getMax(){return this._max.copy(this.center).add(this.halfExtents)}containsPoint(e){const t=this.getMin(),s=this.getMax();return!(e.x<t.x||e.x>s.x||e.y<t.y||e.y>s.y||e.z<t.z||e.z>s.z)}setFromTransformedAabb(e,t,s=!1){const i=e.center,n=e.halfExtents,r=t.data;let a=r[0],o=r[4],l=r[8],h=r[1],c=r[5],d=r[9],u=r[2],p=r[6],m=r[10];if(s){let e=a*a+o*o+l*l;if(e>0){const t=1/Math.sqrt(e);a*=t,o*=t,l*=t}if(e=h*h+c*c+d*d,e>0){const t=1/Math.sqrt(e);h*=t,c*=t,d*=t}if(e=u*u+p*p+m*m,e>0){const t=1/Math.sqrt(e);u*=t,p*=t,m*=t}}this.center.set(r[12]+a*i.x+o*i.y+l*i.z,r[13]+h*i.x+c*i.y+d*i.z,r[14]+u*i.x+p*i.y+m*i.z),this.halfExtents.set(Math.abs(a)*n.x+Math.abs(o)*n.y+Math.abs(l)*n.z,Math.abs(h)*n.x+Math.abs(c)*n.y+Math.abs(d)*n.z,Math.abs(u)*n.x+Math.abs(p)*n.y+Math.abs(m)*n.z)}static computeMinMax(e,t,s,i=e.length/3){if(i>0){let n=e[0],r=e[1],a=e[2],o=n,l=r,h=a;const c=3*i;for(let t=3;t<c;t+=3){const s=e[t],i=e[t+1],c=e[t+2];s<n&&(n=s),i<r&&(r=i),c<a&&(a=c),s>o&&(o=s),i>l&&(l=i),c>h&&(h=c)}t.set(n,r,a),s.set(o,l,h)}}compute(e,t){xu.computeMinMax(e,fu,gu,t),this.setMinMax(fu,gu)}intersectsBoundingSphere(e){return this._distanceToBoundingSphereSq(e)<=e.radius*e.radius}_distanceToBoundingSphereSq(e){const t=this.getMin(),s=this.getMax();let i=0;const n=["x","y","z"];for(let r=0;r<3;++r){let a=0;const o=e.center[n[r]],l=t[n[r]],h=s[n[r]];let c=0;o<l&&(c=l-o,a+=c*c),o>h&&(c=o-h,a+=c*c),i+=a}return i}_expand(e,t){fu.add2(this.getMin(),e),gu.add2(this.getMax(),t),this.setMinMax(fu,gu)}}const wu=new nu,Su=new nu;class Cu{constructor(e=new nu,t=.5){this.center=void 0,this.radius=void 0,this.center=e,this.radius=t}containsPoint(e){const t=wu.sub2(e,this.center).lengthSq(),s=this.radius;return t<s*s}intersectsRay(e,t){const s=wu.copy(e.origin).sub(this.center),i=s.dot(Su.copy(e.direction).normalize()),n=s.dot(s)-this.radius*this.radius;if(n>0&&i>0)return!1;const r=i*i-n;if(r<0)return!1;const a=Math.abs(-i-Math.sqrt(r));return t&&t.copy(e.direction).mulScalar(a).add(e.origin),!0}intersectsBoundingSphere(e){wu.sub2(e.center,this.center);const t=e.radius+this.radius;return wu.lengthSq()<=t*t}}class Tu{constructor(){this.planes=[];for(let e=0;e<6;e++)this.planes[e]=[]}setFromMat4(e){const t=e.data;let s;const i=this.planes;s=i[0],s[0]=t[3]-t[0],s[1]=t[7]-t[4],s[2]=t[11]-t[8],s[3]=t[15]-t[12];let n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]);s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[1],s[0]=t[3]+t[0],s[1]=t[7]+t[4],s[2]=t[11]+t[8],s[3]=t[15]+t[12],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[2],s[0]=t[3]+t[1],s[1]=t[7]+t[5],s[2]=t[11]+t[9],s[3]=t[15]+t[13],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[3],s[0]=t[3]-t[1],s[1]=t[7]-t[5],s[2]=t[11]-t[9],s[3]=t[15]-t[13],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[4],s[0]=t[3]-t[2],s[1]=t[7]-t[6],s[2]=t[11]-t[10],s[3]=t[15]-t[14],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[5],s[0]=t[3]+t[2],s[1]=t[7]+t[6],s[2]=t[11]+t[10],s[3]=t[15]+t[14],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n}containsPoint(e){let t,s;for(t=0;t<6;t++)if(s=this.planes[t],s[0]*e.x+s[1]*e.y+s[2]*e.z+s[3]<=0)return!1;return!0}containsSphere(e){let t,s,i=0;const n=e.radius,r=e.center,a=r.x,o=r.y,l=r.z,h=this.planes;let c;for(s=0;s<6;s++){if(c=h[s],t=c[0]*a+c[1]*o+c[2]*l+c[3],t<=-n)return 0;t>n&&i++}return 6===i?2:1}}class Au{constructor(e,t){this.origin=new nu,this.direction=nu.FORWARD.clone(),e&&this.origin.copy(e),t&&this.direction.copy(t)}set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.set(e.origin,e.direction)}clone(){return new this.constructor(this.origin,this.direction)}}new Au,new nu,new Cu,new pu;const Eu="linear",Pu="inverse",Mu="exponential",Lu=12,Du=14,ku=15,Iu=new Map([[0,{name:"A8",size:1}],[1,{name:"L8",size:1}],[2,{name:"LA8",size:2}],[3,{name:"RGB565",size:2}],[4,{name:"RGBA5551",size:2}],[5,{name:"RGBA4",size:2}],[6,{name:"RGB8",size:4}],[7,{name:"RGBA8",size:4}],[50,{name:"R16F",size:2}],[51,{name:"RG16F",size:4}],[11,{name:"RGB16F",size:8}],[Lu,{name:"RGBA16F",size:8}],[13,{name:"RGB32F",size:16}],[Du,{name:"RGBA32F",size:16}],[ku,{name:"R32F",size:4}],[16,{name:"DEPTH",size:4}],[17,{name:"DEPTHSTENCIL",size:4}],[18,{name:"111110F",size:4}],[19,{name:"SRGB",size:4}],[20,{name:"SRGBA",size:4}],[31,{name:"BGRA8",size:4}],[8,{name:"DXT1",blockSize:8}],[9,{name:"DXT3",blockSize:16}],[10,{name:"DXT5",blockSize:16}],[21,{name:"ETC1",blockSize:8}],[22,{name:"ETC2_RGB",blockSize:8}],[23,{name:"ETC2_RGBA",blockSize:16}],[24,{name:"PVRTC_2BPP_RGB_1",blockSize:8}],[25,{name:"PVRTC_2BPP_RGBA_1",blockSize:8}],[26,{name:"PVRTC_4BPP_RGB_1",blockSize:8}],[27,{name:"PVRTC_4BPP_RGBA_1",blockSize:8}],[28,{name:"ASTC_4x4",blockSize:16}],[29,{name:"ATC_RGB",blockSize:8}],[30,{name:"ATC_RGBA",blockSize:16}],[32,{name:"R8I",size:1,isInt:!0}],[33,{name:"R8U",size:1,isInt:!0}],[34,{name:"R16I",size:2,isInt:!0}],[35,{name:"R16U",size:2,isInt:!0}],[36,{name:"R32I",size:4,isInt:!0}],[37,{name:"R32U",size:4,isInt:!0}],[38,{name:"RG8I",size:2,isInt:!0}],[39,{name:"RG8U",size:2,isInt:!0}],[40,{name:"RG16I",size:4,isInt:!0}],[41,{name:"RG16U",size:4,isInt:!0}],[42,{name:"RG32I",size:8,isInt:!0}],[43,{name:"RG32U",size:8,isInt:!0}],[44,{name:"RGBA8I",size:4,isInt:!0}],[45,{name:"RGBA8U",size:4,isInt:!0}],[46,{name:"RGBA16I",size:8,isInt:!0}],[47,{name:"RGBA16U",size:8,isInt:!0}],[48,{name:"RGBA32I",size:16,isInt:!0}],[49,{name:"RGBA32U",size:16,isInt:!0}]]),Ru=e=>{var t;return!0===(null==(t=Iu.get(e))?void 0:t.isInt)},Ou="POSITION",zu="NORMAL",Fu="TANGENT",Vu="BLENDWEIGHT",Nu="BLENDINDICES",Bu="COLOR",Uu="TEXCOORD",Hu="TEXCOORD0",Wu="TEXCOORD1",Gu="ATTR0",ju="ATTR1",qu="ATTR8",Ku="ATTR9",Xu="ATTR10",Yu="ATTR11",Zu="ATTR12",$u="ATTR13",Qu="ATTR14",Ju="ATTR15",ep="default",tp="rgbm",sp="rgbp",ip="swizzleGGGR",np="2d",rp="cube",ap="equirect",op=1,lp=["bool","int","float","vec2","vec3","vec4","ivec2","ivec3","ivec4","bvec2","bvec3","bvec4","mat2","mat3","mat4","sampler2D","samplerCube","","sampler2DShadow","samplerCubeShadow","sampler3D","","","","","sampler2DArray","uint","uvec2","uvec3","uvec4","","","","","","","","","","","","","isampler2D","usampler2D","isamplerCube","usamplerCube","isampler3D","usampler3D","isampler2DArray","usampler2DArray"],hp="webgl1",cp="webgl2",dp="webgpu",up="null",pp=["mesh","view"],mp="default",_p=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Uint16Array],fp=[1,1,2,2,4,4,4,2],gp=[Uint8Array,Uint16Array,Uint32Array],vp=[1,2,4];function yp(){return yp=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i])}return e},yp.apply(this,arguments)}const bp={set:(e,t,s,i=1)=>e&~(i<<s)|t<<s,get:(e,t,s=1)=>e>>t&s,all(e,t,s=1){const i=s<<t;return(e&i)===i},any:(e,t,s=1)=>0!=(e&s<<t)};var xp;const wp=15;class Sp{constructor(e=!1,t=0,s=1,i=0,n,r,a,o=!0,l=!0,h=!0,c=!0){this.target0=0,this.setColorBlend(t,s,i),this.setAlphaBlend(null!=n?n:t,null!=r?r:s,null!=a?a:i),this.setColorWrite(o,l,h,c),this.blend=e}set blend(e){this.target0=bp.set(this.target0,e?1:0,26)}get blend(){return bp.all(this.target0,26)}setColorBlend(e,t,s){this.target0=bp.set(this.target0,e,0,7),this.target0=bp.set(this.target0,t,3,wp),this.target0=bp.set(this.target0,s,7,wp)}setAlphaBlend(e,t,s){this.target0=bp.set(this.target0,e,11,7),this.target0=bp.set(this.target0,t,14,wp),this.target0=bp.set(this.target0,s,18,wp)}setColorWrite(e,t,s,i){this.redWrite=e,this.greenWrite=t,this.blueWrite=s,this.alphaWrite=i}get colorOp(){return bp.get(this.target0,0,7)}get colorSrcFactor(){return bp.get(this.target0,3,wp)}get colorDstFactor(){return bp.get(this.target0,7,wp)}get alphaOp(){return bp.get(this.target0,11,7)}get alphaSrcFactor(){return bp.get(this.target0,14,wp)}get alphaDstFactor(){return bp.get(this.target0,18,wp)}set redWrite(e){this.target0=bp.set(this.target0,e?1:0,22)}get redWrite(){return bp.all(this.target0,22)}set greenWrite(e){this.target0=bp.set(this.target0,e?1:0,23)}get greenWrite(){return bp.all(this.target0,23)}set blueWrite(e){this.target0=bp.set(this.target0,e?1:0,24)}get blueWrite(){return bp.all(this.target0,24)}set alphaWrite(e){this.target0=bp.set(this.target0,e?1:0,25)}get alphaWrite(){return bp.all(this.target0,25)}get allWrite(){return bp.get(this.target0,22,15)}copy(e){return this.target0=e.target0,this}clone(){return(new this.constructor).copy(this)}get key(){return this.target0}equals(e){return this.target0===e.target0}}xp=Sp,Sp.NOBLEND=Object.freeze(new xp),Sp.NOWRITE=Object.freeze(new xp(void 0,void 0,void 0,void 0,void 0,void 0,void 0,!1,!1,!1,!1)),Sp.ALPHABLEND=Object.freeze(new xp(!0,0,6,8)),Sp.ADDBLEND=Object.freeze(new xp(!0,0,1,1));class Cp{constructor(){this.map=new Map,this.id=0}get(e){let t=this.map.get(e);return void 0===t&&(t=this.id++,this.map.set(e,t)),t}}var Tp;const Ap=new Cp;class Ep{constructor(e=3,t=!0){this.data=0,this._depthBias=0,this._depthBiasSlope=0,this.key=0,this.func=e,this.write=t}set test(e){this.func=e?3:7,this.updateKey()}get test(){return 7!==this.func}set write(e){this.data=bp.set(this.data,e?1:0,3),this.updateKey()}get write(){return bp.all(this.data,3)}set func(e){this.data=bp.set(this.data,e,0,7),this.updateKey()}get func(){return bp.get(this.data,0,7)}set depthBias(e){this._depthBias=e,this.updateKey()}get depthBias(){return this._depthBias}set depthBiasSlope(e){this._depthBiasSlope=e,this.updateKey()}get depthBiasSlope(){return this._depthBiasSlope}copy(e){return this.data=e.data,this._depthBias=e._depthBias,this._depthBiasSlope=e._depthBiasSlope,this.key=e.key,this}clone(){return(new this.constructor).copy(this)}updateKey(){const{data:e,_depthBias:t,_depthBiasSlope:s}=this,i=`${e}-${t}-${s}`;this.key=Ap.get(i)}equals(e){return this.key===e.key}}Tp=Ep,Ep.DEFAULT=Object.freeze(new Tp),Ep.NODEPTH=Object.freeze(new Tp(7,!1)),Ep.WRITEDEPTH=Object.freeze(new Tp(7,!0));class Pp{constructor(){this.globalId=0,this.revision=0}equals(e){return this.globalId===e.globalId&&this.revision===e.revision}copy(e){this.globalId=e.globalId,this.revision=e.revision}reset(){this.globalId=0,this.revision=0}}let Mp=0;class Lp{constructor(){Mp++,this.version=new Pp,this.version.globalId=Mp}increment(){this.version.revision++}}class Dp{constructor(e){this.name=e,this.value=null,this.versionObject=new Lp}toJSON(e){}setValue(e){this.value=e,this.versionObject.increment()}getValue(){return this.value}}class kp{constructor(e){this.name=e,this.variables=new Map}resolve(e){return this.variables.has(e)||this.variables.set(e,new Dp(e)),this.variables.get(e)}removeValue(e){for(const t in this.variables){const s=this.variables[t];s.value===e&&(s.value=null)}}}let Ip=0;class Rp{constructor(e,t,s,i=0,n){this.device=e,this.format=t,this.numVertices=s,this.usage=i,this.id=Ip++,this.impl=e.createVertexBufferImpl(this,t),this.numBytes=t.verticesByteSize?t.verticesByteSize:t.size*s,this.adjustVramSizeTracking(e._vram,this.numBytes),n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),this.device.buffers.push(this)}destroy(){const e=this.device,t=e.buffers.indexOf(this);-1!==t&&e.buffers.splice(t,1),this.impl.initialized&&(this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this.storage.byteLength))}adjustVramSizeTracking(e,t){e.vb+=t}loseContext(){this.impl.loseContext()}getFormat(){return this.format}getUsage(){return this.usage}getNumVertices(){return this.numVertices}lock(){return this.storage}unlock(){this.impl.unlock(this)}setData(e){return e.byteLength===this.numBytes&&(this.storage=e,this.unlock(),!0)}}function Op(e){let t=0;for(let s=0,i=e.length;s<i;s++)t=(t<<5)-t+e.charCodeAt(s),t|=0;return t}class zp{constructor(){this._cache=new Map}get(e,t){return this._cache.has(e)||(this._cache.set(e,t()),e.on("destroy",(()=>{this.remove(e)})),e.on("devicelost",(()=>{var t;null==(t=this._cache.get(e))||null==t.loseContext||t.loseContext(e)}))),this._cache.get(e)}remove(e){var t;null==(t=this._cache.get(e))||null==t.destroy||t.destroy(e),this._cache.delete(e)}}const Fp=new Cp,Vp=[2,4,8,12,16],Np=new zp;class Bp{constructor(e,t,s){this.device=e,this._elements=[],this.hasUv0=!1,this.hasUv1=!1,this.hasColor=!1,this.hasTangents=!1,this.verticesByteSize=0,this.vertexCount=s,this.interleaved=void 0===s,this.instancing=!1,this.size=t.reduce(((e,t)=>e+4*Math.ceil(t.components*fp[t.type]/4)),0);let i,n=0;for(let e=0,o=t.length;e<o;e++){var r,a;const o=t[e];i=o.components*fp[o.type],s&&(n=Wd.roundUp(n,i));const l=null!=(r=o.asInt)&&r,h=!l&&(null!=(a=o.normalize)&&a),c={name:o.semantic,offset:s?n:o.hasOwnProperty("offset")?o.offset:n,stride:s?i:o.hasOwnProperty("stride")?o.stride:this.size,dataType:o.type,numComponents:o.components,normalize:h,size:i,asInt:l};this._elements.push(c),n+=s?i*s:4*Math.ceil(i/4),o.semantic===Hu?this.hasUv0=!0:o.semantic===Wu?this.hasUv1=!0:o.semantic===Bu?this.hasColor=!0:o.semantic===Fu&&(this.hasTangents=!0)}s&&(this.verticesByteSize=n),this._evaluateHash()}get elements(){return this._elements}static getDefaultInstancingFormat(e){return Np.get(e,(()=>new Bp(e,[{semantic:Zu,components:4,type:6},{semantic:$u,components:4,type:6},{semantic:Qu,components:4,type:6},{semantic:Ju,components:4,type:6}])))}static isElementValid(e,t){const s=t.components*fp[t.type];return!(e.isWebGPU&&!Vp.includes(s))}update(){this._evaluateHash()}_evaluateHash(){const e=[],t=[],s=this._elements.length;for(let i=0;i<s;i++){const{name:s,dataType:n,numComponents:r,normalize:a,offset:o,stride:l,size:h,asInt:c}=this._elements[i],d=s+n+r+a+c;e.push(d);const u=d+o+l+h;t.push(u)}e.sort();const i=e.join();this.batchingHash=Op(i),this.shaderProcessingHashString=i,this.renderingHashString=t.join("_"),this.renderingHash=Fp.get(this.renderingHashString)}}var Up;const Hp=new Cp;class Wp{set func(e){this._func=e,this._dirty=!0}get func(){return this._func}set ref(e){this._ref=e,this._dirty=!0}get ref(){return this._ref}set fail(e){this._fail=e,this._dirty=!0}get fail(){return this._fail}set zfail(e){this._zfail=e,this._dirty=!0}get zfail(){return this._zfail}set zpass(e){this._zpass=e,this._dirty=!0}get zpass(){return this._zpass}set readMask(e){this._readMask=e,this._dirty=!0}get readMask(){return this._readMask}set writeMask(e){this._writeMask=e,this._dirty=!0}get writeMask(){return this._writeMask}constructor(e={}){var t,s,i,n,r,a,o;this._func=void 0,this._ref=void 0,this._fail=void 0,this._zfail=void 0,this._zpass=void 0,this._readMask=void 0,this._writeMask=void 0,this._dirty=!0,this._key=void 0,this._func=null!=(t=e.func)?t:7,this._ref=null!=(s=e.ref)?s:0,this._readMask=null!=(i=e.readMask)?i:255,this._writeMask=null!=(n=e.writeMask)?n:255,this._fail=null!=(r=e.fail)?r:0,this._zfail=null!=(a=e.zfail)?a:0,this._zpass=null!=(o=e.zpass)?o:0,this._evalKey()}_evalKey(){const{_func:e,_ref:t,_fail:s,_zfail:i,_zpass:n,_readMask:r,_writeMask:a}=this,o=`${e},${t},${s},${i},${n},${r},${a}`;this._key=Hp.get(o),this._dirty=!1}get key(){return this._dirty&&this._evalKey(),this._key}copy(e){return this._func=e._func,this._ref=e._ref,this._readMask=e._readMask,this._writeMask=e._writeMask,this._fail=e._fail,this._zfail=e._zfail,this._zpass=e._zpass,this._dirty=e._dirty,this._key=e._key,this}clone(){return(new this.constructor).copy(this)}}Up=Wp,Wp.DEFAULT=Object.freeze(new Up);class Gp extends od{constructor(e,t){var s,i,n,r;super(),this.canvas=void 0,this.backBuffer=null,this.backBufferSize=new au,this.backBufferFormat=void 0,this.backBufferAntialias=!1,this.isWebGPU=!1,this.isWebGL1=!1,this.isWebGL2=!1,this.scope=void 0,this.boneLimit=void 0,this.maxAnisotropy=void 0,this.maxCubeMapSize=void 0,this.maxTextureSize=void 0,this.maxVolumeSize=void 0,this.maxColorAttachments=1,this.precision=void 0,this.samples=void 0,this.supportsStencil=void 0,this.supportsMrt=!1,this.supportsVolumeTextures=!1,this.supportsCompute=!1,this.renderTarget=null,this.shaders=[],this.textures=[],this.targets=new Set,this.renderVersion=0,this.renderPassIndex=void 0,this.insideRenderPass=!1,this.supportsInstancing=void 0,this.supportsUniformBuffers=!1,this.textureFloatRenderable=void 0,this.textureHalfFloatRenderable=void 0,this.textureFloatFilterable=!1,this.textureHalfFloatFilterable=!1,this.quadVertexBuffer=void 0,this.blendState=new Sp,this.depthState=new Ep,this.stencilEnabled=!1,this.stencilFront=new Wp,this.stencilBack=new Wp,this.dynamicBuffers=void 0,this.gpuProfiler=void 0,this.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:3},this.canvas=e,this.initOptions=yp({},t),null!=(s=this.initOptions).depth||(s.depth=!0),null!=(i=this.initOptions).stencil||(i.stencil=!0),null!=(n=this.initOptions).antialias||(n.antialias=!0),null!=(r=this.initOptions).powerPreference||(r.powerPreference="high-performance"),this._maxPixelRatio=Sd.browser?Math.min(1,window.devicePixelRatio):1,this.buffers=[],this._vram={tex:0,vb:0,ib:0,ub:0},this._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0},this.initializeContextCaches(),this._drawCallsPerFrame=0,this._shaderSwitchesPerFrame=0,this._primsPerFrame=[];for(let e=0;e<=6;e++)this._primsPerFrame[e]=0;this._renderTargetCreationTime=0,this.scope=new kp("Device"),this.textureBias=this.scope.resolve("textureBias"),this.textureBias.setValue(0)}postInit(){const e=new Bp(this,[{semantic:Ou,components:2,type:6}]),t=new Float32Array([-1,-1,1,-1,-1,1,1,1]);this.quadVertexBuffer=new Rp(this,e,4,0,t)}destroy(){var e,t,s;this.fire("destroy"),null==(e=this.quadVertexBuffer)||e.destroy(),this.quadVertexBuffer=null,null==(t=this.dynamicBuffers)||t.destroy(),this.dynamicBuffers=null,null==(s=this.gpuProfiler)||s.destroy(),this.gpuProfiler=null}onDestroyShader(e){this.fire("destroy:shader",e);const t=this.shaders.indexOf(e);-1!==t&&this.shaders.splice(t,1)}postDestroy(){this.scope=null,this.canvas=null}toJSON(e){}initializeContextCaches(){this.indexBuffer=null,this.vertexBuffers=[],this.shader=null,this.shaderValid=void 0,this.shaderAsyncCompile=!1,this.renderTarget=null}initializeRenderState(){this.blendState=new Sp,this.depthState=new Ep,this.cullMode=1,this.vx=this.vy=this.vw=this.vh=0,this.sx=this.sy=this.sw=this.sh=0,this.blendColor=new jd(0,0,0,0)}setStencilState(e,t){}setBlendState(e){}setBlendColor(e,t,s,i){}setDepthState(e){}setCullMode(e){}setRenderTarget(e){this.renderTarget=e}setIndexBuffer(e){this.indexBuffer=e}setVertexBuffer(e){e&&this.vertexBuffers.push(e)}getRenderTarget(){return this.renderTarget}initRenderTarget(e){e.initialized||(e.init(),this.targets.add(e))}_isBrowserInterface(e){return this._isImageBrowserInterface(e)||this._isImageCanvasInterface(e)||this._isImageVideoInterface(e)}_isImageBrowserInterface(e){return"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement}_isImageCanvasInterface(e){return"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement}_isImageVideoInterface(e){return"undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement}resizeCanvas(e,t){const s=Math.min(this._maxPixelRatio,Sd.browser?window.devicePixelRatio:1),i=Math.floor(e*s),n=Math.floor(t*s);i===this.canvas.width&&n===this.canvas.height||this.setResolution(i,n)}setResolution(e,t){this.canvas.width=e,this.canvas.height=t,this.fire(Gp.EVENT_RESIZE,e,t)}updateClientRect(){this.clientRect=this.canvas.getBoundingClientRect()}get width(){return this.canvas.width}get height(){return this.canvas.height}set fullscreen(e){}get fullscreen(){return!1}set maxPixelRatio(e){this._maxPixelRatio=e}get maxPixelRatio(){return this._maxPixelRatio}get deviceType(){return this._deviceType}getBoneLimit(){return this.boneLimit}setBoneLimit(e){this.boneLimit=e}startRenderPass(e){}endRenderPass(e){}startComputePass(){}endComputePass(){}frameStart(){this.renderPassIndex=0,this.renderVersion++}frameEnd(){}getRenderableHdrFormat(e=[18,Lu,Du],t=!0){for(let s=0;s<e.length;s++){const i=e[s];switch(i){case 18:if(this.textureRG11B10Renderable)return i;break;case Lu:if(this.textureHalfFloatRenderable&&(!t||this.textureHalfFloatFilterable))return i;break;case Du:if(this.textureFloatRenderable&&(!t||this.textureFloatFilterable))return i}}}}Gp.EVENT_RESIZE="resizecanvas";let jp=0;class qp{constructor(e={}){var t,s,i,n,r,a;this.name=void 0,this._device=void 0,this._colorBuffer=void 0,this._colorBuffers=void 0,this._depthBuffer=void 0,this._depth=void 0,this._stencil=void 0,this._samples=void 0,this.autoResolve=void 0,this._face=void 0,this.flipY=void 0,this.id=jp++;const o=arguments[1],l=arguments[2];if(e instanceof Gp?(this._colorBuffer=o,e=l):this._colorBuffer=e.colorBuffer,this._colorBuffer&&(this._colorBuffers=[this._colorBuffer]),this._depthBuffer=e.depthBuffer,this._face=null!=(t=e.face)?t:0,this._depthBuffer){const e=this._depthBuffer._format;16===e?(this._depth=!0,this._stencil=!1):17===e?(this._depth=!0,this._stencil=!0):(this._depth=!1,this._stencil=!1)}else{var h,c;this._depth=null==(h=e.depth)||h,this._stencil=null!=(c=e.stencil)&&c}e.colorBuffers&&(this._colorBuffers||(this._colorBuffers=[...e.colorBuffers],this._colorBuffer=e.colorBuffers[0]));const d=(null==(s=this._colorBuffer)?void 0:s.device)||(null==(i=this._depthBuffer)?void 0:i.device)||e.graphicsDevice;this._device=d;const{maxSamples:u}=this._device;var p,m;(this._samples=Math.min(null!=(n=e.samples)?n:1,u),d.isWebGPU&&(this._samples=this._samples>1?u:1),this.autoResolve=null==(r=e.autoResolve)||r,this.name=e.name,this.name)||(this.name=null==(p=this._colorBuffer)?void 0:p.name);this.name||(this.name=null==(m=this._depthBuffer)?void 0:m.name);this.name||(this.name="Untitled"),this.flipY=null!=(a=e.flipY)&&a,this.validateMrt(),this.impl=d.createRenderTargetImpl(this)}destroy(){const e=this._device;e&&(e.targets.delete(this),e.renderTarget===this&&e.setRenderTarget(null),this.destroyFrameBuffers())}destroyFrameBuffers(){const e=this._device;e&&this.impl.destroy(e)}destroyTextureBuffers(){var e,t;null==(e=this._depthBuffer)||e.destroy(),this._depthBuffer=null,null==(t=this._colorBuffers)||t.forEach((e=>{e.destroy()})),this._colorBuffers=null,this._colorBuffer=null}resize(e,t){if(this.width!==e||this.height!==t){var s,i;const n=this._device;this.destroyFrameBuffers(),n.renderTarget===this&&n.setRenderTarget(null),null==(s=this._depthBuffer)||s.resize(e,t),null==(i=this._colorBuffers)||i.forEach((s=>{s.resize(e,t)})),this.validateMrt(),this.impl=n.createRenderTargetImpl(this)}}validateMrt(){}init(){this.impl.init(this._device,this)}get initialized(){return this.impl.initialized}get device(){return this._device}loseContext(){this.impl.loseContext()}resolve(e=!0,t=!!this._depthBuffer){this._device&&this._samples>1&&this.impl.resolve(this._device,this,e,t)}copy(e,t,s){if(!this._device){if(!e._device)return!1;this._device=e._device}return this._device.copyRenderTarget(e,this,t,s)}get samples(){return this._samples}get depth(){return this._depth}get stencil(){return this._stencil}get colorBuffer(){return this._colorBuffer}getColorBuffer(e){var t;return null==(t=this._colorBuffers)?void 0:t[e]}get depthBuffer(){return this._depthBuffer}get face(){return this._face}get width(){var e,t;return(null==(e=this._colorBuffer)?void 0:e.width)||(null==(t=this._depthBuffer)?void 0:t.width)||this._device.width}get height(){var e,t;return(null==(e=this._colorBuffer)?void 0:e.height)||(null==(t=this._depthBuffer)?void 0:t.height)||this._device.height}}new Cp,new Cp;const Kp=[];Kp[2]=1,Kp[3]=2,Kp[4]=3,Kp[5]=4,Kp[1]=1,Kp[6]=2,Kp[7]=3,Kp[8]=4,Kp[0]=1,Kp[9]=2,Kp[10]=3,Kp[11]=4,Kp[12]=8,Kp[13]=12,Kp[14]=16,Kp[26]=1,Kp[27]=2,Kp[28]=3,Kp[29]=4;class Xp{get isArrayType(){return this.count>0}constructor(e,t,s=0){if(this.name=void 0,this.type=void 0,this.byteSize=void 0,this.offset=void 0,this.scopeId=void 0,this.count=void 0,this.numComponents=void 0,this.shortName=e,this.name=s?`${e}[0]`:e,this.type=t,this.numComponents=Kp[t],this.updateType=t,s>0)switch(t){case 2:this.updateType=17;break;case 1:this.updateType=30;break;case 26:this.updateType=31;break;case 0:this.updateType=32;break;case 3:this.updateType=21;break;case 6:this.updateType=33;break;case 27:this.updateType=34;break;case 9:this.updateType=35;break;case 4:this.updateType=22;break;case 7:this.updateType=36;break;case 28:this.updateType=37;break;case 10:this.updateType=38;break;case 5:this.updateType=23;break;case 8:this.updateType=39;break;case 29:this.updateType=40;break;case 11:this.updateType=41;break;case 14:this.updateType=24}this.count=s;let i=this.numComponents;s&&(i=Wd.roundUp(i,4)),this.byteSize=4*i,s&&(this.byteSize*=s)}calculateOffset(e){let t=this.byteSize<=8?this.byteSize:16;this.count&&(t=16),e=Wd.roundUp(e,t),this.offset=e/4}}class Yp{constructor(e,t){this.byteSize=0,this.map=new Map,this.scope=e.scope,this.uniforms=t;let s=0;for(let e=0;e<t.length;e++){const i=t[e];i.calculateOffset(s),s=4*i.offset+i.byteSize,i.scopeId=this.scope.resolve(i.name),this.map.set(i.name,i)}this.byteSize=Wd.roundUp(s,16)}get(e){return this.map.get(e)}getShaderDeclaration(e,t){let s=`layout(set = ${e}, binding = ${t}, std140) uniform ub_${pp[e]} {\n`;return this.uniforms.forEach((e=>{const t=lp[e.type];s+=`    ${t} ${e.shortName}${e.count?`[${e.count}]`:""};\n`})),s+"};\n"}}let Zp=0;const $p={[np]:"texture2D",cube:"textureCube","3d":"texture3D","2d-array":"texture2DArray"};class Qp{constructor(e,t){this.name=e,this.visibility=t}}class Jp{constructor(e,t,s=np,i=0){this.scopeId=void 0,this.name=e,this.visibility=t,this.textureDimension=s,this.sampleType=i}}class em{constructor(e,t=[],s=[],i=[],n={}){var r;this.compute=!1,this.id=Zp++,this.compute=null!=(r=n.compute)&&r,this.device=e;const a=e.scope;this.bufferFormats=t,this.bufferFormatsMap=new Map,t.forEach(((e,t)=>this.bufferFormatsMap.set(e.name,t))),this.textureFormats=s,this.textureFormatsMap=new Map,s.forEach(((e,t)=>{this.textureFormatsMap.set(e.name,t),e.scopeId=a.resolve(e.name)})),this.storageTextureFormats=i,this.storageTextureFormatsMap=new Map,i.forEach(((e,t)=>{this.storageTextureFormatsMap.set(e.name,t),e.scopeId=a.resolve(e.name)})),this.impl=e.createBindGroupFormatImpl(this)}destroy(){this.impl.destroy()}getTexture(e){const t=this.textureFormatsMap.get(e);return void 0!==t?this.textureFormats[t]:null}getStorageTexture(e){const t=this.storageTextureFormatsMap.get(e);return void 0!==t?this.storageTextureFormats[t]:null}getShaderDeclarationTextures(e){let t="",s=this.bufferFormats.length;return this.textureFormats.forEach((i=>{let n=$p[i.textureDimension],r="",a="";"texture2DArray"===n&&(r="_texture",a=`#define ${i.name} sampler2DArray(${i.name}${r}, ${i.name}_sampler)\n`),3===i.sampleType?n=`i${n}`:4===i.sampleType&&(n=`u${n}`),t+=`layout(set = ${e}, binding = ${s++}) uniform ${n} ${i.name}${r};\nlayout(set = ${e}, binding = ${s++}) uniform sampler ${i.name}_sampler;\n`+a})),t}loseContext(){}}class tm{static calcLevelDimension(e,t){return Math.max(e>>t,1)}static calcMipLevelsCount(e,t,s=1){return 1+Math.floor(Math.log2(Math.max(e,t,s)))}static calcLevelGpuSize(e,t,s,i){var n,r,a;const o=Iu.get(i),l=null!=(n=null==(r=Iu.get(i))?void 0:r.size)?n:0;if(l>0)return e*t*s*l;const h=null!=(a=o.blockSize)?a:0;let c=Math.floor((e+3)/4);const d=Math.floor((t+3)/4),u=Math.floor((s+3)/4);return 24!==i&&25!==i||(c=Math.max(Math.floor(c/2),1)),c*d*u*h}static calcGpuSize(e,t,s,i,n,r){let a=0;for(;a+=tm.calcLevelGpuSize(e,t,s,i),n&&(1!==e||1!==t||1!==s);)e=Math.max(e>>1,1),t=Math.max(t>>1,1),s=Math.max(s>>1,1);return a*(r?6:1)}}const sm=/[ \t]*#(ifn?def|if|endif|else|elif|define|undef|extension)/g,im=/define[ \t]+([^\n]+)\r?(?:\n|$)/g,nm=/extension[ \t]+([\w-]+)[ \t]*:[ \t]*(enable|require)/g,rm=/undef[ \t]+([^\n]+)\r?(?:\n|$)/g,am=/(ifdef|ifndef|if)[ \t]*([^\r\n]+)\r?\n/g,om=/(endif|else|elif)([ \t]+[^\r\n]+)?\r?(?:\n|$)/g,lm=/([\w-]+)/,hm=/(!|\s)?defined\(([\w-]+)\)/,cm=/[><=|&+-]/g;class dm{static run(e,t=!1){e=(e=e.replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm,"$1")).split(/\r?\n/).map((e=>e.trimEnd())).join("\n");const s=new Map;if(t){const t=new Map,i=/(pcFragColor[1-8])\b/g,n=e.match(i);null==n||n.forEach((e=>{var s;const i=parseInt(e.charAt(e.length-1),10);t.set(i,(null!=(s=t.get(i))?s:0)+1)})),t.forEach(((e,t)=>{1===e&&s.set(`REMOVE_COLOR_ATTACHMENT_${t}`,"")}))}e=this._preprocess(e,s);const i=new Map;return s.forEach(((e,t)=>{Number.isInteger(parseFloat(e))&&!e.includes(".")&&i.set(t,e)})),e=this.RemoveEmptyLines(e),e=this.processArraySize(e,i)}static processArraySize(e,t){return null!==e&&t.forEach(((t,s)=>{e=e.replace(new RegExp(`\\[${s}\\]`,"g"),`[${t}]`)})),e}static RemoveEmptyLines(e){return null!==e&&(e=(e=e.split(/\r?\n/).map((e=>""===e.trim()?"":e)).join("\n")).replace(/(\n\n){3,}/gm,"\n\n")),e}static _preprocess(e,t=new Map){const s=e,i=[];let n,r=!1;for(;null!==(n=sm.exec(e));){const s=n[1];switch(s){case"define":{im.lastIndex=n.index;const s=im.exec(e);r||(r=null===s);const a=s[1];lm.lastIndex=s.index;const o=lm.exec(a)[1];let l=a.substring(o.length).trim();""===l&&(l="true");dm._keep(i)&&t.set(o,l),sm.lastIndex=s.index+s[0].length;break}case"undef":{rm.lastIndex=n.index;const s=rm.exec(e),r=s[1].trim();dm._keep(i)&&t.delete(r),sm.lastIndex=s.index+s[0].length;break}case"extension":{nm.lastIndex=n.index;const s=nm.exec(e);if(r||(r=null===s),s){const e=s[1];dm._keep(i)&&t.set(e,"true")}sm.lastIndex=s.index+s[0].length;break}case"ifdef":case"ifndef":case"if":{am.lastIndex=n.index;const a=am.exec(e),o=a[2],l=dm.evaluate(o,t);r||(r=l.error);let h=l.result;"ifndef"===s&&(h=!h),i.push({anyKeep:h,keep:h,start:n.index,end:am.lastIndex}),sm.lastIndex=a.index+a[0].length;break}case"endif":case"else":case"elif":{om.lastIndex=n.index;const s=om.exec(e),a=i.pop(),o=a.keep?e.substring(a.end,n.index):"";e=e.substring(0,a.start)+o+e.substring(om.lastIndex),sm.lastIndex=a.start+o.length;const l=s[1];if("else"===l||"elif"===l){let e=!1;if(!a.anyKeep)if("else"===l)e=!a.keep;else{const i=dm.evaluate(s[2],t);e=i.result,r||(r=i.error)}i.push({anyKeep:a.anyKeep||e,keep:e,start:sm.lastIndex,end:sm.lastIndex})}break}}}return r?(console.warn("Failed to preprocess shader: ",{source:s}),s):e}static _keep(e){for(let t=0;t<e.length;t++)if(!e[t].keep)return!1;return!0}static evaluate(e,t){const s=null===cm.exec(e);let i=!1;const n=hm.exec(e);n&&(i="!"===n[1],e=n[2]),e=e.trim();let r=t.has(e);return i&&(r=!r),{result:r,error:!s}}}let um=0;class pm{constructor(e,t){if(this.meshUniformBufferFormat=void 0,this.meshBindGroupFormat=void 0,this.id=um++,this.device=e,this.definition=t,this.name=t.name||"Untitled",this.init(),t.cshader);else{t.vshader=dm.run(t.vshader);const s=e.isWebGL2&&("osx"===Sd.name||"ios"===Sd.name);t.fshader=dm.run(t.fshader,s)}this.impl=e.createShaderImpl(this)}init(){this.ready=!1,this.failed=!1}get label(){return`Shader Id ${this.id} ${this.name}`}destroy(){this.device.onDestroyShader(this),this.impl.destroy(this)}loseContext(){this.init(),this.impl.loseContext()}restoreContext(){this.impl.restoreContext(this.device,this)}}let mm=0;class _m{constructor(e,t,s){this.renderVersionUpdated=-1,this.uniformBuffers=void 0,this.uniformBufferOffsets=[],this.id=mm++,this.device=e,this.format=t,this.dirty=!0,this.impl=e.createBindGroupImpl(this),this.textures=[],this.storageTextures=[],this.uniformBuffers=[],this.defaultUniformBuffer=s,s&&this.setUniformBuffer(mp,s)}destroy(){this.impl.destroy(),this.impl=null,this.format=null,this.defaultUniformBuffer=null}setUniformBuffer(e,t){const s=this.format.bufferFormatsMap.get(e);this.uniformBuffers[s]!==t&&(this.uniformBuffers[s]=t,this.dirty=!0)}setTexture(e,t){const s=this.format.textureFormatsMap.get(e);this.textures[s]!==t?(this.textures[s]=t,this.dirty=!0):this.renderVersionUpdated<t.renderVersionDirty&&(this.dirty=!0)}setStorageTexture(e,t){const s=this.format.storageTextureFormatsMap.get(e);this.storageTextures[s]!==t?(this.storageTextures[s]=t,this.dirty=!0):this.renderVersionUpdated<t.renderVersionDirty&&(this.dirty=!0)}update(){const{textureFormats:e,storageTextureFormats:t}=this.format;for(let t=0;t<e.length;t++){const s=e[t],i=s.scopeId.value;this.setTexture(s.name,i)}for(let e=0;e<t.length;e++){const s=t[e],i=s.scopeId.value;this.setStorageTexture(s.name,i)}this.uniformBufferOffsets.length=this.uniformBuffers.length;for(let e=0;e<this.uniformBuffers.length;e++){const t=this.uniformBuffers[e];this.uniformBufferOffsets[e]=t.offset,this.renderVersionUpdated<t.renderVersionDirty&&(this.dirty=!0)}this.dirty&&(this.dirty=!1,this.renderVersionUpdated=this.device.renderVersion,this.impl.update(this))}}class fm{constructor(){this.storage=void 0,this.gpuBuffer=void 0,this.offset=void 0}}const gm=[];gm[2]=function(e,t,s){e.storageFloat32[s]=t},gm[3]=(e,t,s)=>{const i=e.storageFloat32;i[s]=t[0],i[s+1]=t[1]},gm[4]=(e,t,s)=>{const i=e.storageFloat32;i[s]=t[0],i[s+1]=t[1],i[s+2]=t[2]},gm[5]=(e,t,s)=>{const i=e.storageFloat32;i[s]=t[0],i[s+1]=t[1],i[s+2]=t[2],i[s+3]=t[3]},gm[1]=function(e,t,s){e.storageInt32[s]=t},gm[6]=function(e,t,s){const i=e.storageInt32;i[s]=t[0],i[s+1]=t[1]},gm[7]=function(e,t,s){const i=e.storageInt32;i[s]=t[0],i[s+1]=t[1],i[s+2]=t[2]},gm[8]=function(e,t,s){const i=e.storageInt32;i[s]=t[0],i[s+1]=t[1],i[s+2]=t[2],i[s+3]=t[3]},gm[12]=(e,t,s)=>{const i=e.storageFloat32;i[s]=t[0],i[s+1]=t[1],i[s+4]=t[2],i[s+5]=t[3],i[s+8]=t[4],i[s+9]=t[5]},gm[13]=(e,t,s)=>{const i=e.storageFloat32;i[s]=t[0],i[s+1]=t[1],i[s+2]=t[2],i[s+4]=t[3],i[s+5]=t[4],i[s+6]=t[5],i[s+8]=t[6],i[s+9]=t[7],i[s+10]=t[8]},gm[17]=function(e,t,s,i){const n=e.storageFloat32;for(let e=0;e<i;e++)n[s+4*e]=t[e]},gm[21]=(e,t,s,i)=>{const n=e.storageFloat32;for(let e=0;e<i;e++)n[s+4*e]=t[2*e],n[s+4*e+1]=t[2*e+1]},gm[22]=(e,t,s,i)=>{const n=e.storageFloat32;for(let e=0;e<i;e++)n[s+4*e]=t[3*e],n[s+4*e+1]=t[3*e+1],n[s+4*e+2]=t[3*e+2]},gm[26]=(e,t,s,i)=>{e.storageUint32[s]=t},gm[27]=(e,t,s,i)=>{const n=e.storageUint32;n[s]=t[0],n[s+1]=t[1]},gm[28]=(e,t,s,i)=>{const n=e.storageUint32;n[s]=t[0],n[s+1]=t[1],n[s+2]=t[2]},gm[29]=(e,t,s,i)=>{const n=e.storageUint32;n[s]=t[0],n[s+1]=t[1],n[s+2]=t[2],n[s+3]=t[3]},gm[30]=function(e,t,s,i){const n=e.storageInt32;for(let e=0;e<i;e++)n[s+4*e]=t[e]},gm[32]=gm[30],gm[31]=function(e,t,s,i){const n=e.storageUint32;for(let e=0;e<i;e++)n[s+4*e]=t[e]},gm[33]=(e,t,s,i)=>{const n=e.storageInt32;for(let e=0;e<i;e++)n[s+4*e]=t[2*e],n[s+4*e+1]=t[2*e+1]},gm[35]=gm[33],gm[34]=(e,t,s,i)=>{const n=e.storageUint32;for(let e=0;e<i;e++)n[s+4*e]=t[2*e],n[s+4*e+1]=t[2*e+1]},gm[36]=(e,t,s,i)=>{const n=e.storageInt32;for(let e=0;e<i;e++)n[s+4*e]=t[3*e],n[s+4*e+1]=t[3*e+1],n[s+4*e+2]=t[3*e+2]},gm[38]=gm[36],gm[37]=(e,t,s,i)=>{const n=e.storageUint32;for(let e=0;e<i;e++)n[s+4*e]=t[3*e],n[s+4*e+1]=t[3*e+1],n[s+4*e+2]=t[3*e+2]};class vm{constructor(e,t,s=!0){if(this.device=void 0,this.persistent=void 0,this.allocation=void 0,this.storageFloat32=void 0,this.storageInt32=void 0,this.storageUint32=void 0,this.renderVersionDirty=0,this.device=e,this.format=t,this.persistent=s,s){this.impl=e.createUniformBufferImpl(this);const s=new ArrayBuffer(t.byteSize);this.assignStorage(new Int32Array(s)),e._vram.ub+=this.format.byteSize}else this.allocation=new fm}destroy(){if(this.persistent){const e=this.device;this.impl.destroy(e),e._vram.ub-=this.format.byteSize}}get offset(){return this.persistent?0:this.allocation.offset}assignStorage(e){this.storageInt32=e,this.storageUint32=new Uint32Array(e.buffer,e.byteOffset,e.byteLength/4),this.storageFloat32=new Float32Array(e.buffer,e.byteOffset,e.byteLength/4)}loseContext(){var e;null==(e=this.impl)||e.loseContext()}setUniform(e){const t=e.offset,s=e.scopeId.value;if(null!=s){const i=gm[e.updateType];i?i(this,s,t,e.count):this.storageFloat32.set(s,t)}}set(e){const t=this.format.map.get(e);t&&this.setUniform(t)}update(){const e=this.persistent;if(!e){const e=this.allocation,t=e.gpuBuffer;this.device.dynamicBuffers.alloc(e,this.format.byteSize),this.assignStorage(e.storage),t!==e.gpuBuffer&&(this.renderVersionDirty=this.device.renderVersion)}const t=this.format.uniforms;for(let e=0;e<t.length;e++)this.setUniform(t[e]);e?this.impl.unlock(this):(this.storageFloat32=null,this.storageInt32=null)}}let ym=0;class bm{constructor(e,t={}){var s,i,n,r,a,o,l,h,c,d,u,p,m,_,f,g,v,y,b,x,w,S,C,T;(this.name=void 0,this._gpuSize=0,this.id=ym++,this._invalid=!1,this._lockedLevel=-1,this._lockedMode=0,this.renderVersionDirty=0,this._storage=!1,this.device=e,this.name=null!=(s=t.name)?s:"",this._width=Math.floor(null!=(i=t.width)?i:4),this._height=Math.floor(null!=(n=t.height)?n:4),this._format=null!=(r=t.format)?r:7,this._compressed=(x=this._format,void 0!==(null==(w=Iu.get(x))?void 0:w.blockSize)),this._integerFormat=Ru(this._format),this._integerFormat&&(t.mipmaps=!1,t.minFilter=0,t.magFilter=0),e.supportsVolumeTextures)?(this._volume=null!=(S=t.volume)&&S,this._depth=Math.floor(null!=(C=t.depth)?C:1),this._arrayLength=Math.floor(null!=(T=t.arrayLength)?T:0)):(this._volume=!1,this._depth=1,this._arrayLength=0);this._storage=null!=(a=t.storage)&&a,this._cubemap=null!=(o=t.cubemap)&&o,this.fixCubemapSeams=null!=(l=t.fixCubemapSeams)&&l,this._flipY=null!=(h=t.flipY)&&h,this._premultiplyAlpha=null!=(c=t.premultiplyAlpha)&&c,this._mipmaps=null==(d=null!=(u=t.mipmaps)?u:t.autoMipmap)||d,this._minFilter=null!=(p=t.minFilter)?p:5,this._magFilter=null!=(m=t.magFilter)?m:1,this._anisotropy=null!=(_=t.anisotropy)?_:1,this._addressU=null!=(f=t.addressU)?f:0,this._addressV=null!=(g=t.addressV)?g:0,this._addressW=null!=(v=t.addressW)?v:0,this._compareOnRead=null!=(y=t.compareOnRead)&&y,this._compareFunc=null!=(b=t.compareFunc)?b:1,this.type=ep,t.hasOwnProperty("type")?this.type=t.type:t.hasOwnProperty("rgbm")?this.type=t.rgbm?tp:ep:t.hasOwnProperty("swizzleGGGR")&&(this.type=t.swizzleGGGR?ip:ep),this.projection="none",this._cubemap?this.projection=rp:t.projection&&t.projection!==rp&&(this.projection=t.projection),this.impl=e.createTextureImpl(this),this.dirtyAll(),this._levels=t.levels,this._levels?this.upload():this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null],e.textures.push(this)}destroy(){const e=this.device;if(e){const t=e.textures.indexOf(this);-1!==t&&e.textures.splice(t,1),e.scope.removeValue(this),this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this._gpuSize),this._levels=null,this.device=null}}resize(e,t,s=1){const i=this.device;this.adjustVramSizeTracking(i._vram,-this._gpuSize),this.impl.destroy(i),this._width=Math.floor(e),this._height=Math.floor(t),this._depth=Math.floor(s),this.impl=i.createTextureImpl(this),this.dirtyAll()}loseContext(){this.impl.loseContext(),this.dirtyAll()}adjustVramSizeTracking(e,t){e.tex+=t}propertyChanged(e){this.impl.propertyChanged(e),this.renderVersionDirty=this.device.renderVersion}get requiredMipLevels(){return this.mipmaps?tm.calcMipLevelsCount(this.width,this.height):1}get lockedMode(){return this._lockedMode}set minFilter(e){this._minFilter!==e&&(Ru(this._format)||(this._minFilter=e,this.propertyChanged(1)))}get minFilter(){return this._minFilter}set magFilter(e){this._magFilter!==e&&(Ru(this._format)||(this._magFilter=e,this.propertyChanged(2)))}get magFilter(){return this._magFilter}set addressU(e){this._addressU!==e&&(this._addressU=e,this.propertyChanged(4))}get addressU(){return this._addressU}set addressV(e){this._addressV!==e&&(this._addressV=e,this.propertyChanged(8))}get addressV(){return this._addressV}set addressW(e){this.device.supportsVolumeTextures&&this._volume&&e!==this._addressW&&(this._addressW=e,this.propertyChanged(16))}get addressW(){return this._addressW}set compareOnRead(e){this._compareOnRead!==e&&(this._compareOnRead=e,this.propertyChanged(32))}get compareOnRead(){return this._compareOnRead}set compareFunc(e){this._compareFunc!==e&&(this._compareFunc=e,this.propertyChanged(64))}get compareFunc(){return this._compareFunc}set anisotropy(e){this._anisotropy!==e&&(this._anisotropy=e,this.propertyChanged(128))}get anisotropy(){return this._anisotropy}set mipmaps(e){this._mipmaps!==e&&(this.device.isWebGPU||Ru(this._format)||(this._mipmaps=e),e&&(this._needsMipmapsUpload=!0))}get mipmaps(){return this._mipmaps}get storage(){return this._storage}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get format(){return this._format}get cubemap(){return this._cubemap}get gpuSize(){const e=this.pot&&this._mipmaps&&!(this._compressed&&1===this._levels.length);return tm.calcGpuSize(this._width,this._height,this._depth,this._format,e,this._cubemap)}get array(){return this._arrayLength>0}get arrayLength(){return this._arrayLength}get volume(){return this._volume}set flipY(e){this._flipY!==e&&(this._flipY=e,this._needsUpload=!0)}get flipY(){return this._flipY}set premultiplyAlpha(e){this._premultiplyAlpha!==e&&(this._premultiplyAlpha=e,this._needsUpload=!0)}get premultiplyAlpha(){return this._premultiplyAlpha}get pot(){return Wd.powerOfTwo(this._width)&&Wd.powerOfTwo(this._height)}get encoding(){switch(this.type){case tp:return"rgbm";case"rgbe":return"rgbe";case sp:return"rgbp";default:return 11===this.format||13===this.format||this.format===Lu||this.format===Du||Ru(this.format)?"linear":"srgb"}}dirtyAll(){this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0],this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this._mipmapsUploaded=!1,this.propertyChanged(255)}lock(e={}){null!=e.level||(e.level=0),null!=e.face||(e.face=0),null!=e.mode||(e.mode=2),this._lockedMode=e.mode,this._lockedLevel=e.level;const t=this.cubemap?this._levels[e.face]:this._levels;if(null===t[e.level]){const s=Math.max(1,this._width>>e.level),i=Math.max(1,this._height>>e.level),n=Math.max(1,this._depth>>e.level),r=new ArrayBuffer(tm.calcLevelGpuSize(s,i,n,this._format));t[e.level]=new((e=>{switch(e){case ku:case 13:case Du:return Float32Array;case 36:case 42:case 48:return Int32Array;case 37:case 43:case 49:return Uint32Array;case 34:case 40:case 46:return Int16Array;case 35:case 41:case 47:case 3:case 4:case 5:case 50:case 51:case 11:case Lu:return Uint16Array;case 32:case 38:case 44:return Int8Array;default:return Uint8Array}})(this._format))(r)}return t[e.level]}setSource(e,t=0){let s,i,n=!1;if(this._cubemap){if(e[0]){s=e[0].width||0,i=e[0].height||0;for(let t=0;t<6;t++){const r=e[t];if(!r||r.width!==s||r.height!==i||!this.device._isBrowserInterface(r)){n=!0;break}}}else n=!0;if(!n)for(let s=0;s<6;s++)this._levels[t][s]!==e[s]&&(this._levelsUpdated[t][s]=!0)}else this.device._isBrowserInterface(e)||(n=!0),n||(e!==this._levels[t]&&(this._levelsUpdated[t]=!0),s=e.width,i=e.height);if(n)if(this._width=4,this._height=4,this._cubemap)for(let e=0;e<6;e++)this._levels[t][e]=null,this._levelsUpdated[t][e]=!0;else this._levels[t]=null,this._levelsUpdated[t]=!0;else 0===t&&(this._width=s,this._height=i),this._levels[t]=e;this._invalid===n&&n||(this._invalid=n,this.upload())}getSource(e=0){return this._levels[e]}unlock(){this._lockedMode,2===this._lockedMode&&this.upload(),this._lockedLevel=-1,this._lockedMode=0}upload(){var e,t;this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,null==(e=(t=this.impl).uploadImmediate)||e.call(t,this.device,this)}async downloadAsync(){const e=[];for(let i=0;i<(this.cubemap?6:1);i++){var t,s;const n=new qp({colorBuffer:this,depth:!1,face:i});this.device.setRenderTarget(n),this.device.initRenderTarget(n);const r=this.cubemap?this._levels[i]:this._levels;let a=r[0];r[0]&&this.device._isBrowserInterface(r[0])&&(r[0]=null),a=this.lock({face:i});const o=null==(t=(s=this.device).readPixelsAsync)?void 0:t.call(s,0,0,this.width,this.height,a).then((()=>n.destroy()));e.push(o)}await Promise.all(e)}}new zp,new zp;var xm="\n#define pcFragColor0 gl_FragData[0]\n#if COLOR_ATTACHMENT_1\n#define pcFragColor1 gl_FragData[1]\n#endif\n#if COLOR_ATTACHMENT_2\n#define pcFragColor2 gl_FragData[2]\n#endif\n#if COLOR_ATTACHMENT_3\n#define pcFragColor3 gl_FragData[3]\n#endif\n#if COLOR_ATTACHMENT_4\n#define pcFragColor4 gl_FragData[4]\n#endif\n#if COLOR_ATTACHMENT_5\n#define pcFragColor5 gl_FragData[5]\n#endif\n#if COLOR_ATTACHMENT_6\n#define pcFragColor6 gl_FragData[6]\n#endif\n#if COLOR_ATTACHMENT_7\n#define pcFragColor7 gl_FragData[7]\n#endif\n#define texture2DBias texture2D\n#define itexture2D texture2D\n#define utexture2D texture2D\n#define SHADOWMAP_PASS(name) name\n#define SHADOWMAP_ACCEPT(name) sampler2D name\n#define TEXTURE_PASS(name) name\n#define TEXTURE_ACCEPT(name) sampler2D name\n#ifndef SUPPORTS_TEXLOD\n\t#define texture2DLodEXT texture2D\n\t#define texture2DProjLodEXT textureProj\n\t#define textureCubeLodEXT textureCube\n\t#define textureShadow texture2D\n#else\n\t#define textureShadow(res, uv) texture2DGradEXT(res, uv, vec2(1, 1), vec2(1, 1))\n#endif\n#ifdef SUPPORTS_MRT\n\t#define gl_FragColor pcFragColor0\n#endif\n",wm="\n#ifndef outType_0\n#define outType_0 vec4\n#endif\nlayout(location = 0) out highp outType_0 pc_fragColor;\n#ifndef REMOVE_COLOR_ATTACHMENT_1\n#if COLOR_ATTACHMENT_1\nlayout(location = 1) out highp outType_1 pc_fragColor1;\n#endif\n#endif\n#ifndef REMOVE_COLOR_ATTACHMENT_2\n#if COLOR_ATTACHMENT_2\nlayout(location = 2) out highp outType_2 pc_fragColor2;\n#endif\n#endif\n#ifndef REMOVE_COLOR_ATTACHMENT_3\n#if COLOR_ATTACHMENT_3\nlayout(location = 3) out highp outType_3 pc_fragColor3;\n#endif\n#endif\n#ifndef REMOVE_COLOR_ATTACHMENT_4\n#if COLOR_ATTACHMENT_4\nlayout(location = 4) out highp outType_4 pc_fragColor4;\n#endif\n#endif\n#ifndef REMOVE_COLOR_ATTACHMENT_5\n#if COLOR_ATTACHMENT_5\nlayout(location = 5) out highp outType_5 pc_fragColor5;\n#endif\n#endif\n#ifndef REMOVE_COLOR_ATTACHMENT_6\n#if COLOR_ATTACHMENT_6\nlayout(location = 6) out highp outType_6 pc_fragColor6;\n#endif\n#endif\n#ifndef REMOVE_COLOR_ATTACHMENT_7\n#if COLOR_ATTACHMENT_7\nlayout(location = 7) out highp outType_7 pc_fragColor7;\n#endif\n#endif\n#define gl_FragColor pc_fragColor\n#define pcFragColor0 pc_fragColor\n#define pcFragColor1 pc_fragColor1\n#define pcFragColor2 pc_fragColor2\n#define pcFragColor3 pc_fragColor3\n#define pcFragColor4 pc_fragColor4\n#define pcFragColor5 pc_fragColor5\n#define pcFragColor6 pc_fragColor6\n#define pcFragColor7 pc_fragColor7\n#define varying in\n#define texture2D texture\n#define texture2DBias texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n#define utexture2D texture\n#define itexture2D texture\n#define textureShadow(res, uv) textureGrad(res, uv, vec2(1, 1), vec2(1, 1))\n#define SHADOWMAP_PASS(name) name\n#define SHADOWMAP_ACCEPT(name) sampler2DShadow name\n#define TEXTURE_PASS(name) name\n#define TEXTURE_ACCEPT(name) sampler2D name\n#define GL2\n#define SUPPORTS_TEXLOD\n#define SUPPORTS_MRT\n",Sm="\n#define attribute in\n#define varying out\n#define texture2D texture\n#define utexture2D texture\n#define itexture2D texture\n#define GL2\n#define VERTEXSHADER\n",Cm="\n#extension GL_EXT_samplerless_texture_functions : require\n#ifndef outType_0\n#define outType_0 vec4\n#endif\n#ifndef outType_1\n#define outType_1 vec4\n#endif\n#ifndef outType_2\n#define outType_2 vec4\n#endif\n#ifndef outType_3\n#define outType_3 vec4\n#endif\n#ifndef outType_4\n#define outType_4 vec4\n#endif\n#ifndef outType_5\n#define outType_5 vec4\n#endif\n#ifndef outType_6\n#define outType_6 vec4\n#endif\n#ifndef outType_7\n#define outType_7 vec4\n#endif\nlayout(location = 0) out highp outType_0 pc_fragColor;\nlayout(location = 1) out highp outType_1 pc_fragColor1;\nlayout(location = 2) out highp outType_2 pc_fragColor2;\nlayout(location = 3) out highp outType_3 pc_fragColor3;\nlayout(location = 4) out highp outType_4 pc_fragColor4;\nlayout(location = 5) out highp outType_5 pc_fragColor5;\nlayout(location = 6) out highp outType_6 pc_fragColor6;\nlayout(location = 7) out highp outType_7 pc_fragColor7;\n#define gl_FragColor pc_fragColor\n#define pcFragColor0 pc_fragColor\n#define pcFragColor1 pc_fragColor1\n#define pcFragColor2 pc_fragColor2\n#define pcFragColor3 pc_fragColor3\n#define pcFragColor4 pc_fragColor4\n#define pcFragColor5 pc_fragColor5\n#define pcFragColor6 pc_fragColor6\n#define pcFragColor7 pc_fragColor7\n#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)\n#define texture2DBias(res, uv, bias) texture(sampler2D(res, res ## _sampler), uv, bias)\n#define texture2DLodEXT(res, uv, lod) textureLod(sampler2D(res, res ## _sampler), uv, lod)\n#define textureCube(res, uv) texture(samplerCube(res, res ## _sampler), uv)\n#define textureCubeLodEXT(res, uv, lod) textureLod(samplerCube(res, res ## _sampler), uv, lod)\n#define textureShadow(res, uv) textureLod(sampler2DShadow(res, res ## _sampler), uv, 0.0)\n#define itexture2D(res, uv) texture(isampler2D(res, res ## _sampler), uv)\n#define utexture2D(res, uv) texture(usampler2D(res, res ## _sampler), uv)\n#define SHADOWMAP_PASS(name) name, name ## _sampler\n#define SHADOWMAP_ACCEPT(name) texture2D name, sampler name ## _sampler\n#define TEXTURE_PASS(name) name, name ## _sampler\n#define TEXTURE_ACCEPT(name) texture2D name, sampler name ## _sampler\n#define GL2\n#define WEBGPU\n#define SUPPORTS_TEXLOD\n#define SUPPORTS_MRT\n",Tm="\n#extension GL_EXT_samplerless_texture_functions : require\n#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)\n#define itexture2D(res, uv) texture(isampler2D(res, res ## _sampler), uv)\n#define utexture2D(res, uv) texture(usampler2D(res, res ## _sampler), uv)\n#define GL2\n#define WEBGPU\n#define VERTEXSHADER\n",Am="\nvec2 getGrabScreenPos(vec4 clipPos) {\n\tvec2 uv = (clipPos.xy / clipPos.w) * 0.5 + 0.5;\n\t#ifdef WEBGPU\n\t\tuv.y = 1.0 - uv.y;\n\t#endif\n\treturn uv;\n}\nvec2 getImageEffectUV(vec2 uv) {\n\t#ifdef WEBGPU\n\t\tuv.y = 1.0 - uv.y;\n\t#endif\n\treturn uv;\n}\n";const Em={vertex_position:Ou,vertex_normal:zu,vertex_tangent:Fu,vertex_texCoord0:Hu,vertex_texCoord1:Wu,vertex_texCoord2:"TEXCOORD2",vertex_texCoord3:"TEXCOORD3",vertex_texCoord4:"TEXCOORD4",vertex_texCoord5:"TEXCOORD5",vertex_texCoord6:"TEXCOORD6",vertex_texCoord7:"TEXCOORD7",vertex_color:Bu,vertex_boneIndices:Nu,vertex_boneWeights:Vu};class Pm{static createDefinition(e,t){var s,i;const n=(t,s,i,n,r)=>{const a=e.isWebGPU?t:e.isWebGL2?s:Pm.gl1Extensions(e,r)+i;let o="";if(!n){var l;let t=null!=(l=r.fragmentOutputTypes)?l:"vec4";Array.isArray(t)||(t=[t]);for(let s=0;s<e.maxColorAttachments;s++){var h;o+=`#define COLOR_ATTACHMENT_${s}\n`;o+=`#define outType_${s} ${null!=(h=t[s])?h:"vec4"}\n`}}return o+a},r=null!=(s=t.name)?s:"Untitled",a=t.vertexDefines||n(Tm,Sm,"",!0,t),o=Pm.versionCode(e)+a+Am+Pm.getShaderNameCode(r)+t.vertexCode,l=t.fragmentDefines||n(Cm,wm,xm,!1,t),h=(t.fragmentPreamble||"")+Pm.versionCode(e)+l+Pm.precisionCode(e)+"\n"+Am+Pm.getShaderNameCode(r)+(t.fragmentCode||Pm.dummyFragmentCode());return{name:r,attributes:null!=(i=t.attributes)?i:Pm.collectAttributes(t.vertexCode),vshader:o,fshader:h,useTransformFeedback:t.useTransformFeedback}}static getShaderNameCode(e){return`#define SHADER_NAME ${e}\n`}static gl1Extensions(e,t,s){let i;return s?i=t.vertexExtensions?`${t.vertexExtensions}\n`:"":(i=t.fragmentExtensions?`${t.fragmentExtensions}\n`:"",e.extStandardDerivatives&&(i+="#extension GL_OES_standard_derivatives : enable\n"),e.extTextureLod&&(i+="#extension GL_EXT_shader_texture_lod : enable\n",i+="#define SUPPORTS_TEXLOD\n"),e.extDrawBuffers&&(i+="#extension GL_EXT_draw_buffers : require\n",i+="#define SUPPORTS_MRT\n")),i}static dummyFragmentCode(){return"void main(void) {gl_FragColor = vec4(0.0);}"}static versionCode(e){return e.isWebGPU?"#version 450\n":e.isWebGL2?"#version 300 es\n":""}static precisionCode(e,t){let s="";t&&"highp"!==t&&"mediump"!==t&&"lowp"!==t&&(t=null),t&&("highp"===t&&"highp"!==e.maxPrecision&&(t="mediump"),"mediump"===t&&"lowp"===e.maxPrecision&&(t="lowp"));const i=t||e.precision;return e.isWebGPU?s=`precision ${i} float;\nprecision ${i} int;\n`:(s=`precision ${i} float;\n`,e.isWebGL2&&(s+=`precision ${i} sampler2DShadow;\n`)),s}static collectAttributes(e){const t={};let s=0,i=e.indexOf("attribute");for(;i>=0&&!(i>0&&"/"===e[i-1]);){const n=e.indexOf(";",i),r=e.lastIndexOf(" ",n),a=e.substring(r+1,n),o=Em[a];void 0!==o?t[a]=o:(t[a]="ATTR"+s,s++),i=e.indexOf("attribute",i+1)}return t}}let Mm=0;class Lm{constructor(e,t,s,i=0,n){this.device=e,this.format=t,this.numIndices=s,this.usage=i,this.id=Mm++,this.impl=e.createIndexBufferImpl(this);const r=vp[t];this.bytesPerIndex=r,this.numBytes=this.numIndices*r,n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),this.adjustVramSizeTracking(e._vram,this.numBytes),this.device.buffers.push(this)}destroy(){const e=this.device,t=e.buffers.indexOf(this);-1!==t&&e.buffers.splice(t,1),this.device.indexBuffer===this&&(this.device.indexBuffer=null),this.impl.initialized&&(this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this.storage.byteLength))}adjustVramSizeTracking(e,t){e.ib+=t}loseContext(){this.impl.loseContext()}getFormat(){return this.format}getNumIndices(){return this.numIndices}lock(){return this.storage}unlock(){this.impl.unlock(this)}setData(e){return e.byteLength===this.numBytes&&(this.storage=e,this.unlock(),!0)}_lockTypedArray(){const e=this.lock();return 2===this.format?new Uint32Array(e):1===this.format?new Uint16Array(e):new Uint8Array(e)}writeData(e,t){const s=this._lockTypedArray();if(e.length>t)if(ArrayBuffer.isView(e))e=e.subarray(0,t),s.set(e);else for(let i=0;i<t;i++)s[i]=e[i];else s.set(e);this.unlock()}readData(e){const t=this._lockTypedArray(),s=this.numIndices;if(ArrayBuffer.isView(e))e.set(t);else{e.length=0;for(let i=0;i<s;i++)e[i]=t[i]}return s}}class Dm{constructor(){this.clearValue=new jd(0,0,0,1),this.clear=!1,this.store=!1,this.resolve=!0,this.mipmaps=!1}}class km{constructor(){this.clearDepthValue=1,this.clearStencilValue=0,this.clearDepth=!1,this.clearStencil=!1,this.storeDepth=!1,this.storeStencil=!1}}class Im{get colorOps(){return this.colorArrayOps[0]}constructor(e){this._name=void 0,this.device=void 0,this._enabled=!0,this.executeEnabled=!0,this.renderTarget=void 0,this._options=void 0,this.samples=0,this.colorArrayOps=[],this.depthStencilOps=void 0,this.requiresCubemaps=!0,this.fullSizeClearRect=!0,this.beforePasses=[],this.afterPasses=[],this.device=e}set name(e){this._name=e}get name(){return this._name||(this._name=this.constructor.name),this._name}set options(e){var t,s;(this._options=e,e)&&(this._options.scaleX=null!=(t=this._options.scaleX)?t:1,this._options.scaleY=null!=(s=this._options.scaleY)?s:1)}get options(){return this._options}init(e=null,t=null){var s;this.options=t,this.renderTarget=e,this.samples=Math.max(this.renderTarget?this.renderTarget.samples:this.device.samples,1),this.depthStencilOps=new km;const i=e?null==(s=e._colorBuffers)?void 0:s.length:1;this.colorArrayOps.length=0;for(let e=0;e<i;e++){var n;const t=new Dm;this.colorArrayOps[e]=t,1===this.samples&&(t.store=!0,t.resolve=!1),null!=(n=this.renderTarget)&&null!=(n=n._colorBuffers)&&n[e].mipmaps&&(t.mipmaps=!0)}this.postInit()}destroy(){}postInit(){}frameUpdate(){if(this._options&&this.renderTarget){var e;const t=null!=(e=this._options.resizeSource)?e:this.device.backBuffer,s=Math.floor(t.width*this._options.scaleX),i=Math.floor(t.height*this._options.scaleY);this.renderTarget.resize(s,i)}}before(){}execute(){}after(){}onEnable(){}onDisable(){}set enabled(e){this._enabled!==e&&(this._enabled=e,e?this.onEnable():this.onDisable())}get enabled(){return this._enabled}setClearColor(e){const t=this.colorArrayOps.length;for(let s=0;s<t;s++){const t=this.colorArrayOps[s];e&&t.clearValue.copy(e),t.clear=!!e}}setClearDepth(e){e&&(this.depthStencilOps.clearDepthValue=e),this.depthStencilOps.clearDepth=void 0!==e}setClearStencil(e){e&&(this.depthStencilOps.clearStencilValue=e),this.depthStencilOps.clearStencil=void 0!==e}render(){if(this.enabled){const e=this.device,t=void 0!==this.renderTarget;this.before(),this.executeEnabled&&(t&&e.startRenderPass(this),this.execute(),t&&e.endRenderPass(this)),this.after(),e.renderPassIndex++}}}class Rm{constructor(e,t,s){this.uniformFormats=[],this.bindGroupFormats=[],this.vertexFormat=void 0,this.uniformFormats[1]=e,this.bindGroupFormats[1]=t,this.vertexFormat=s}hasUniform(e){for(let t=0;t<this.uniformFormats.length;t++){const s=this.uniformFormats[t];if(null!=s&&s.get(e))return!0}return!1}hasTexture(e){for(let t=0;t<this.bindGroupFormats.length;t++){const s=this.bindGroupFormats[t];if(null!=s&&s.getTexture(e))return!0}return!1}getVertexElement(e){var t;return null==(t=this.vertexFormat)?void 0:t.elements.find((t=>t.name===e))}generateKey(e){let t=JSON.stringify(this.uniformFormats)+JSON.stringify(this.bindGroupFormats);var s;e.isWebGPU&&(t+=null==(s=this.vertexFormat)?void 0:s.shaderProcessingHashString);return t}}function Om(e){this.array[this.index]=e}function zm(e,t){this.array[this.index]=e,this.array[this.index+1]=t}function Fm(e,t,s){this.array[this.index]=e,this.array[this.index+1]=t,this.array[this.index+2]=s}function Vm(e,t,s,i){this.array[this.index]=e,this.array[this.index+1]=t,this.array[this.index+2]=s,this.array[this.index+3]=i}function Nm(e,t,s){this.array[e]=t[s]}function Bm(e,t,s){this.array[e]=t[s],this.array[e+1]=t[s+1]}function Um(e,t,s){this.array[e]=t[s],this.array[e+1]=t[s+1],this.array[e+2]=t[s+2]}function Hm(e,t,s){this.array[e]=t[s],this.array[e+1]=t[s+1],this.array[e+2]=t[s+2],this.array[e+3]=t[s+3]}function Wm(e,t,s){t[s]=this.array[e]}function Gm(e,t,s){t[s]=this.array[e],t[s+1]=this.array[e+1]}function jm(e,t,s){t[s]=this.array[e],t[s+1]=this.array[e+1],t[s+2]=this.array[e+2]}function qm(e,t,s){t[s]=this.array[e],t[s+1]=this.array[e+1],t[s+2]=this.array[e+2],t[s+3]=this.array[e+3]}class Km{constructor(e,t,s){switch(this.index=0,this.numComponents=t.numComponents,s.interleaved?this.array=new _p[t.dataType](e,t.offset):this.array=new _p[t.dataType](e,t.offset,s.vertexCount*t.numComponents),this.stride=t.stride/this.array.constructor.BYTES_PER_ELEMENT,t.numComponents){case 1:this.set=Om,this.getToArray=Wm,this.setFromArray=Nm;break;case 2:this.set=zm,this.getToArray=Gm,this.setFromArray=Bm;break;case 3:this.set=Fm,this.getToArray=jm,this.setFromArray=Um;break;case 4:this.set=Vm,this.getToArray=qm,this.setFromArray=Hm}}get(e){return this.array[this.index+e]}set(e,t,s,i){}getToArray(e,t,s){}setFromArray(e,t,s){}}class Xm{constructor(e){this.vertexBuffer=e,this.vertexFormatSize=e.getFormat().size,this.buffer=this.vertexBuffer.lock(),this.accessors=[],this.element={};const t=this.vertexBuffer.getFormat();for(let e=0;e<t.elements.length;e++){const s=t.elements[e];this.accessors[e]=new Km(this.buffer,s,t),this.element[s.name]=this.accessors[e]}}next(e=1){let t=0;const s=this.accessors,i=this.accessors.length;for(;t<i;){const i=s[t++];i.index+=e*i.stride}}end(){this.vertexBuffer.unlock()}writeData(e,t,s){const i=this.element[e];if(i){s>this.vertexBuffer.numVertices&&(s=this.vertexBuffer.numVertices);const e=i.numComponents;if(this.vertexBuffer.getFormat().interleaved){let n=0;for(let r=0;r<s;r++)i.setFromArray(n,t,r*e),n+=i.stride}else if(t.length>s*e){const n=s*e;if(ArrayBuffer.isView(t))t=t.subarray(0,n),i.array.set(t);else for(let e=0;e<n;e++)i.array[e]=t[e]}else i.array.set(t)}}readData(e,t){const s=this.element[e];let i=0;if(s){let e;i=this.vertexBuffer.numVertices;const n=s.numComponents;if(this.vertexBuffer.getFormat().interleaved){Array.isArray(t)&&(t.length=0),s.index=0;let r=0;for(e=0;e<i;e++)s.getToArray(r,t,e*n),r+=s.stride}else if(ArrayBuffer.isView(t))t.set(s.array);else{t.length=0;const r=i*n;for(e=0;e<r;e++)t[e]=s.array[e]}}return i}}const Ym="mousedown",Zm="mousemove",$m="mouseup",Qm="mousewheel";const Jm=new class{constructor(e,t){t?(this.key=t.keyCode,this.element=t.target,this.event=t):(this.key=null,this.element=null,this.event=null)}};function e_(e){return Jm.key=e.keyCode,Jm.element=e.target,Jm.event=e,Jm}function t_(e){return"string"==typeof e?e.toUpperCase().charCodeAt(0):e}const s_={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"};class i_ extends od{constructor(e,t={}){super(),this._element=null,this._keyDownHandler=this._handleKeyDown.bind(this),this._keyUpHandler=this._handleKeyUp.bind(this),this._keyPressHandler=this._handleKeyPress.bind(this),this._visibilityChangeHandler=this._handleVisibilityChange.bind(this),this._windowBlurHandler=this._handleWindowBlur.bind(this),this._keymap={},this._lastmap={},e&&this.attach(e),this.preventDefault=t.preventDefault||!1,this.stopPropagation=t.stopPropagation||!1}attach(e){this._element&&this.detach(),this._element=e,this._element.addEventListener("keydown",this._keyDownHandler,!1),this._element.addEventListener("keypress",this._keyPressHandler,!1),this._element.addEventListener("keyup",this._keyUpHandler,!1),document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.addEventListener("blur",this._windowBlurHandler,!1)}detach(){this._element&&(this._element.removeEventListener("keydown",this._keyDownHandler),this._element.removeEventListener("keypress",this._keyPressHandler),this._element.removeEventListener("keyup",this._keyUpHandler),this._element=null,document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.removeEventListener("blur",this._windowBlurHandler,!1))}toKeyIdentifier(e){e=t_(e);const t=s_[e.toString()];if(t)return t;let s=e.toString(16).toUpperCase();const i=s.length;for(let e=0;e<4-i;e++)s="0"+s;return"U+"+s}_handleKeyDown(e){const t=e.keyCode||e.charCode;if(void 0===t)return;const s=this.toKeyIdentifier(t);this._keymap[s]=!0,this.fire("keydown",e_(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation()}_handleKeyUp(e){const t=e.keyCode||e.charCode;if(void 0===t)return;const s=this.toKeyIdentifier(t);delete this._keymap[s],this.fire("keyup",e_(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation()}_handleKeyPress(e){this.fire("keypress",e_(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation()}_handleVisibilityChange(){"hidden"===document.visibilityState&&this._handleWindowBlur()}_handleWindowBlur(){this._keymap={},this._lastmap={}}update(){for(const e in this._lastmap)delete this._lastmap[e];for(const e in this._keymap)this._keymap.hasOwnProperty(e)&&(this._lastmap[e]=this._keymap[e])}isPressed(e){const t=t_(e),s=this.toKeyIdentifier(t);return!!this._keymap[s]}wasPressed(e){const t=t_(e),s=this.toKeyIdentifier(t);return!!this._keymap[s]&&!this._lastmap[s]}wasReleased(e){const t=t_(e),s=this.toKeyIdentifier(t);return!this._keymap[s]&&!!this._lastmap[s]}}function n_(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)}i_.EVENT_KEYDOWN="keydown",i_.EVENT_KEYUP="keyup";class r_{constructor(e,t){let s={x:0,y:0};if(t){if(t instanceof r_)throw Error("Expected MouseEvent");s=e._getTargetCoords(t)}else t={};if(s)this.x=s.x,this.y=s.y;else{if(!n_())return;this.x=0,this.y=0}this.wheelDelta=0,"wheel"===t.type&&(t.deltaY>0?this.wheelDelta=1:t.deltaY<0&&(this.wheelDelta=-1)),n_()?(this.dx=t.movementX||t.webkitMovementX||t.mozMovementX||0,this.dy=t.movementY||t.webkitMovementY||t.mozMovementY||0):(this.dx=this.x-e._lastX,this.dy=this.y-e._lastY),"mousedown"===t.type||"mouseup"===t.type?this.button=t.button:this.button=-1,this.buttons=e._buttons.slice(0),this.element=t.target,this.ctrlKey=t.ctrlKey||!1,this.altKey=t.altKey||!1,this.shiftKey=t.shiftKey||!1,this.metaKey=t.metaKey||!1,this.event=t}}class a_ extends od{constructor(e){super(),this._lastX=0,this._lastY=0,this._buttons=[!1,!1,!1],this._lastbuttons=[!1,!1,!1],this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._contextMenuHandler=e=>{e.preventDefault()},this._target=null,this._attached=!1,this.attach(e)}static isPointerLocked(){return n_()}attach(e){if(this._target=e,this._attached)return;this._attached=!0;const t=!!Sd.passiveEvents&&{passive:!1};window.addEventListener("mouseup",this._upHandler,t),window.addEventListener("mousedown",this._downHandler,t),window.addEventListener("mousemove",this._moveHandler,t),window.addEventListener("wheel",this._wheelHandler,t)}detach(){if(!this._attached)return;this._attached=!1,this._target=null;const e=!!Sd.passiveEvents&&{passive:!1};window.removeEventListener("mouseup",this._upHandler,e),window.removeEventListener("mousedown",this._downHandler,e),window.removeEventListener("mousemove",this._moveHandler,e),window.removeEventListener("wheel",this._wheelHandler,e)}disableContextMenu(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler)}enableContextMenu(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)}enablePointerLock(e,t){if(!document.body.requestPointerLock)return void(t&&t());const s=()=>{e(),document.removeEventListener("pointerlockchange",s)},i=()=>{t(),document.removeEventListener("pointerlockerror",i)};e&&document.addEventListener("pointerlockchange",s,!1),t&&document.addEventListener("pointerlockerror",i,!1),document.body.requestPointerLock()}disablePointerLock(e){if(!document.exitPointerLock)return;const t=()=>{e(),document.removeEventListener("pointerlockchange",t)};e&&document.addEventListener("pointerlockchange",t,!1),document.exitPointerLock()}update(){this._lastbuttons[0]=this._buttons[0],this._lastbuttons[1]=this._buttons[1],this._lastbuttons[2]=this._buttons[2]}isPressed(e){return this._buttons[e]}wasPressed(e){return this._buttons[e]&&!this._lastbuttons[e]}wasReleased(e){return!this._buttons[e]&&this._lastbuttons[e]}_handleUp(e){this._buttons[e.button]=!1;const t=new r_(this,e);t.event&&this.fire($m,t)}_handleDown(e){this._buttons[e.button]=!0;const t=new r_(this,e);t.event&&this.fire(Ym,t)}_handleMove(e){const t=new r_(this,e);t.event&&(this.fire(Zm,t),this._lastX=t.x,this._lastY=t.y)}_handleWheel(e){const t=new r_(this,e);t.event&&this.fire(Qm,t)}_getTargetCoords(e){const t=this._target.getBoundingClientRect(),s=Math.floor(t.left),i=Math.floor(t.top);return e.clientX<s||e.clientX>=s+this._target.clientWidth||e.clientY<i||e.clientY>=i+this._target.clientHeight?null:{x:e.clientX-s,y:e.clientY-i}}}a_.EVENT_MOUSEMOVE=Zm,a_.EVENT_MOUSEDOWN=Ym,a_.EVENT_MOUSEUP=$m,a_.EVENT_MOUSEWHEEL=Qm;const o_=Object.freeze([]);let l_=function(){return o_};"undefined"!=typeof navigator&&(l_=(navigator.getGamepads||navigator.webkitGetGamepads||l_).bind(navigator));const h_={buttons:{PAD_FACE_1:0,PAD_FACE_2:1,PAD_FACE_3:2,PAD_FACE_4:3,PAD_L_SHOULDER_1:4,PAD_R_SHOULDER_1:5,PAD_L_SHOULDER_2:6,PAD_R_SHOULDER_2:7,PAD_SELECT:8,PAD_START:9,PAD_L_STICK_BUTTON:10,PAD_R_STICK_BUTTON:11,PAD_UP:12,PAD_DOWN:13,PAD_LEFT:14,PAD_RIGHT:15,PAD_VENDOR:16,XRPAD_TRIGGER:0,XRPAD_SQUEEZE:1,XRPAD_TOUCHPAD_BUTTON:2,XRPAD_STICK_BUTTON:3,XRPAD_A:4,XRPAD_B:5},axes:{PAD_L_STICK_X:0,PAD_L_STICK_Y:1,PAD_R_STICK_X:2,PAD_R_STICK_Y:3,XRPAD_TOUCHPAD_X:0,XRPAD_TOUCHPAD_Y:1,XRPAD_STICK_X:2,XRPAD_STICK_Y:3}},c_={DEFAULT:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_3","PAD_FACE_4","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_UP","PAD_DOWN","PAD_LEFT","PAD_RIGHT","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]},DEFAULT_DUAL:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_3","PAD_FACE_4","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"],synthesizedButtons:{PAD_UP:{axis:0,min:0,max:1},PAD_DOWN:{axis:0,min:-1,max:0},PAD_LEFT:{axis:0,min:-1,max:0},PAD_RIGHT:{axis:0,min:0,max:1}}},PS3:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_4","PAD_FACE_3","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_UP","PAD_DOWN","PAD_LEFT","PAD_RIGHT","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"],mapping:"standard"},DEFAULT_XR:{buttons:["XRPAD_TRIGGER","XRPAD_SQUEEZE","XRPAD_TOUCHPAD_BUTTON","XRPAD_STICK_BUTTON","XRPAD_A","XRPAD_B"],axes:["XRPAD_TOUCHPAD_X","XRPAD_TOUCHPAD_Y","XRPAD_STICK_X","XRPAD_STICK_Y"],mapping:"xr-standard"}},d_={"Product: 0268":"PS3"},u_={};function p_(e){const t=u_[e.id];if(t)return t;for(const t in d_)if(-1!==e.id.indexOf(t)){const s=d_[t];if(!e.mapping){const e=c_["RAW_"+s];if(e)return e}return c_[s]}if("xr-standard"===e.mapping)return c_.DEFAULT_XR;const s=c_.DEFAULT,i=e.buttons.length<s.buttons.length?c_.DEFAULT_DUAL:s;return i.mapping=e.mapping,i}let m_=.25;class __{constructor(e,t){var s,i;(this.value=0,this.pressed=!1,this.touched=!1,this.wasPressed=!1,this.wasReleased=!1,this.wasTouched=!1,"number"==typeof e)?(this.value=e,this.pressed=1===e,this.touched=e>0):(this.value=e.value,this.pressed=e.pressed,this.touched=null!=(s=e.touched)?s:e.value>0);t&&("number"==typeof t?(this.wasPressed=1!==t&&this.pressed,this.wasReleased=1===t&&!this.pressed,this.wasTouched=0===t&&this.touched):(this.wasPressed=!t.pressed&&this.pressed,this.wasReleased=t.pressed&&!this.pressed,this.wasTouched=!(null!=(i=t.touched)?i:t.value>0)&&this.touched))}update(e){var t;const{value:s,pressed:i}=e,n=null!=(t=e.touched)?t:s>0;this.wasPressed=!this.pressed&&i,this.wasReleased=this.pressed&&!i,this.wasTouched=!this.touched&&n,this.value=s,this.pressed=i,this.touched=n}}const f_=Object.freeze(new __(0));class g_{constructor(e,t){this._compiledMapping={buttons:[],axes:[]},this.id=e.id,this.index=e.index,this._buttons=e.buttons.map((e=>new __(e))),this._axes=[...e.axes],this._previousAxes=[...e.axes],this.mapping=t.mapping,this.map=t,this.hand=e.hand||"none",this.pad=e,this._compileMapping()}get connected(){return this.pad.connected}_compileMapping(){const{axes:e,buttons:t}=this._compiledMapping,s=h_.axes,i=h_.buttons;e.length=0,t.length=0;this.map.axes&&this.map.axes.forEach(((t,i)=>{e[s[t]]=()=>this.pad.axes[i]||0}));for(let t=0,s=e.length;t<s;t++)e[t]||(e[t]=()=>0);const n=this.map.buttons;n&&n.forEach(((e,s)=>{t[i[e]]=()=>this._buttons[s]||f_}));const r=this.map.synthesizedButtons;r&&Object.entries(r).forEach((e=>{const{axis:s,max:n,min:r}=e[1];t[i[e[0]]]=()=>{var e,t;return new __(Math.abs(Wd.clamp(null!=(e=this._axes[s])?e:0,r,n)),Math.abs(Wd.clamp(null!=(t=this._previousAxes[s])?t:0,r,n)))}}));for(let e=0,s=t.length;e<s;e++)t[e]||(t[e]=()=>f_)}update(e){this.pad=e;const t=this._previousAxes,s=this._axes;t.length=0,t.push(...s),s.length=0,s.push(...e.axes);const i=this._buttons;for(let t=0,s=i.length;t<s;t++)i[t].update(e.buttons[t]);return this}updateMap(e){e.mapping="custom",u_[this.id]=e,this.map=e,this.mapping="custom",this._compileMapping()}resetMap(){if(u_[this.id]){delete u_[this.id];const e=p_(this.pad);this.map=e,this.mapping=e.mapping,this._compileMapping()}}get axes(){return this._compiledMapping.axes.map((e=>e()))}get buttons(){return this._compiledMapping.buttons.map((e=>e()))}async pulse(e,t,s){const i=this.pad.vibrationActuator?[this.pad.vibrationActuator]:this.pad.hapticActuators||o_;if(i.length){var n,r,a;const o=null!=(n=null==s?void 0:s.startDelay)?n:0,l=null!=(r=null==s?void 0:s.strongMagnitude)?r:e,h=null!=(a=null==s?void 0:s.weakMagnitude)?a:e;return(await Promise.all(i.map((async function(s){return!s||(s.playEffect?s.playEffect(s.type,{duration:t,startDelay:o,strongMagnitude:l,weakMagnitude:h}):!!s.pulse&&(await(i=o,new Promise((e=>{setTimeout(e,i)}))),s.pulse(e,t)));var i})))).some((e=>!0===e||"complete"===e))}return!1}getButton(e){const t=this._compiledMapping.buttons[e];return t?t():f_}isPressed(e){return this.getButton(e).pressed}wasPressed(e){return this.getButton(e).wasPressed}wasReleased(e){return this.getButton(e).wasReleased}isTouched(e){return this.getButton(e).touched}wasTouched(e){return this.getButton(e).wasTouched}getValue(e){return this.getButton(e).value}getAxis(e){const t=this.axes[e];return t&&Math.abs(t)>m_?t:0}}class v_ extends od{constructor(){super(),this.gamepadsSupported=Sd.gamepads,this.current=[],this._previous=[],this._ongamepadconnectedHandler=this._ongamepadconnected.bind(this),this._ongamepaddisconnectedHandler=this._ongamepaddisconnected.bind(this),window.addEventListener("gamepadconnected",this._ongamepadconnectedHandler,!1),window.addEventListener("gamepaddisconnected",this._ongamepaddisconnectedHandler,!1),this.poll()}set deadZone(e){m_=e}get deadZone(){return m_}get previous(){const e=this.current;for(let t=0,s=e.length;t<s;t++){const s=e[t]._buttons;this._previous[t]||(this._previous[t]=[]);for(let e=0,i=s.length;e<i;e++){const i=s[t];this.previous[t][e]=!!i&&(!i.wasPressed&&i.pressed||i.wasReleased)}}return this._previous.length=this.current.length,this._previous}_ongamepadconnected(e){const t=new g_(e.gamepad,this.getMap(e.gamepad)),s=this.current;let i=s.findIndex((e=>e.index===t.index));for(;-1!==i;)s.splice(i,1),i=s.findIndex((e=>e.index===t.index));s.push(t),this.fire("gamepadconnected",t)}_ongamepaddisconnected(e){const t=this.current,s=t.findIndex((t=>t.index===e.gamepad.index));-1!==s&&(this.fire("gamepaddisconnected",t[s]),t.splice(s,1))}update(){this.poll()}poll(e=[]){e.length>0&&(e.length=0);const t=l_();for(let s=0,i=t.length;s<i;s++)if(t[s]){const i=this.findByIndex(t[s].index);if(i)e.push(i.update(t[s]));else{const i=new g_(t[s],this.getMap(t[s]));this.current.push(i),e.push(i)}}return e}destroy(){window.removeEventListener("gamepadconnected",this._ongamepadconnectedHandler,!1),window.removeEventListener("gamepaddisconnected",this._ongamepaddisconnectedHandler,!1)}getMap(e){return p_(e)}isPressed(e,t){var s;return(null==(s=this.current[e])?void 0:s.isPressed(t))||!1}wasPressed(e,t){var s;return(null==(s=this.current[e])?void 0:s.wasPressed(t))||!1}wasReleased(e,t){var s;return(null==(s=this.current[e])?void 0:s.wasReleased(t))||!1}getAxis(e,t){var s;return(null==(s=this.current[e])?void 0:s.getAxis(t))||0}pulse(e,t,s,i){const n=this.current[e];return n?n.pulse(t,s,i):Promise.resolve(!1)}pulseAll(e,t,s){return Promise.all(this.current.map((i=>i.pulse(e,t,s))))}findById(e){return this.current.find((t=>t&&t.id===e))||null}findByIndex(e){return this.current.find((t=>t&&t.index===e))||null}}v_.EVENT_GAMEPADCONNECTED="gamepadconnected",v_.EVENT_GAMEPADDISCONNECTED="gamepaddisconnected";class y_{get(e,t,s){return"function"==typeof t&&(s=t,t={}),this.request("GET",e,t,s)}post(e,t,s,i){return"function"==typeof s&&(i=s,s={}),s.postdata=t,this.request("POST",e,s,i)}put(e,t,s,i){return"function"==typeof s&&(i=s,s={}),s.postdata=t,this.request("PUT",e,s,i)}del(e,t,s){return"function"==typeof t&&(s=t,t={}),this.request("DELETE",e,t,s)}request(e,t,s,i){let n,r,a,o=!1;if("function"==typeof s&&(i=s,s={}),s.retry&&(s=Object.assign({retries:0,maxRetries:5},s)),s.callback=i,null==s.async&&(s.async=!0),null==s.headers&&(s.headers={}),null!=s.postdata)if(s.postdata instanceof Document)a=s.postdata;else if(s.postdata instanceof FormData)a=s.postdata;else if(s.postdata instanceof Object){let e=s.headers["Content-Type"];switch(void 0===e&&(s.headers["Content-Type"]=y_.ContentType.FORM_URLENCODED,e=s.headers["Content-Type"]),e){case y_.ContentType.FORM_URLENCODED:{a="";let e=!0;for(const t in s.postdata)if(s.postdata.hasOwnProperty(t)){e?e=!1:a+="&";a+=`${encodeURIComponent(t)}=${encodeURIComponent(s.postdata[t])}`}break}default:case y_.ContentType.JSON:null==e&&(s.headers["Content-Type"]=y_.ContentType.JSON),a=JSON.stringify(s.postdata)}}else a=s.postdata;if(!1===s.cache){const e=Bd();n=new Hd(t),n.query?n.query=n.query+"&ts="+e:n.query="ts="+e,t=n.toString()}s.query&&(n=new Hd(t),r=rd(n.getQuery(),s.query),n.setQuery(r),t=n.toString());const l=new XMLHttpRequest;l.open(e,t,s.async),l.withCredentials=void 0!==s.withCredentials&&s.withCredentials,l.responseType=s.responseType||this._guessResponseType(t);for(const e in s.headers)s.headers.hasOwnProperty(e)&&l.setRequestHeader(e,s.headers[e]);l.onreadystatechange=()=>{this._onReadyStateChange(e,t,s,l)},l.onerror=()=>{this._onError(e,t,s,l),o=!0};try{l.send(a)}catch(e){o||s.error(l.status,l,e)}return l}_guessResponseType(e){const t=new Hd(e),s=cd.getExtension(t.path).toLowerCase();return y_.binaryExtensions.indexOf(s)>=0?y_.ResponseType.ARRAY_BUFFER:".json"===s?y_.ResponseType.JSON:".xml"===s?y_.ResponseType.DOCUMENT:y_.ResponseType.TEXT}_isBinaryContentType(e){return[y_.ContentType.BASIS,y_.ContentType.BIN,y_.ContentType.DDS,y_.ContentType.GLB,y_.ContentType.MP3,y_.ContentType.MP4,y_.ContentType.OGG,y_.ContentType.OPUS,y_.ContentType.WAV].indexOf(e)>=0}_isBinaryResponseType(e){return e===y_.ResponseType.ARRAY_BUFFER||e===y_.ResponseType.BLOB||e===y_.ResponseType.JSON}_onReadyStateChange(e,t,s,i){if(4===i.readyState)switch(i.status){case 0:i.responseURL&&i.responseURL.startsWith("file:///")?this._onSuccess(e,t,s,i):this._onError(e,t,s,i);break;case 200:case 201:case 206:case 304:this._onSuccess(e,t,s,i);break;default:this._onError(e,t,s,i)}}_onSuccess(e,t,s,i){let n,r;const a=i.getResponseHeader("Content-Type");if(a){r=a.split(";")[0].trim()}try{n=this._isBinaryContentType(r)||this._isBinaryResponseType(i.responseType)?i.response:r===y_.ContentType.JSON||t.split("?")[0].endsWith(".json")?JSON.parse(i.responseText):i.responseType===y_.ResponseType.DOCUMENT||r===y_.ContentType.XML?i.responseXML:i.responseText,s.callback(null,n)}catch(e){s.callback(e)}}_onError(e,t,s,i){if(!s.retrying)if(s.retry&&s.retries<s.maxRetries){s.retries++,s.retrying=!0;const n=Wd.clamp(Math.pow(2,s.retries)*y_.retryDelay,0,s.maxRetryDelay||5e3);console.log(`${e}: ${t} - Error ${i.status}. Retrying in ${n} ms`),setTimeout((()=>{s.retrying=!1,this.request(e,t,s,s.callback)}),n)}else s.callback(0===i.status?"Network error":i.status,null)}}y_.ContentType={AAC:"audio/aac",BASIS:"image/basis",BIN:"application/octet-stream",DDS:"image/dds",FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",GLB:"model/gltf-binary",JPEG:"image/jpeg",JSON:"application/json",MP3:"audio/mpeg",MP4:"audio/mp4",OGG:"audio/ogg",OPUS:'audio/ogg; codecs="opus"',PNG:"image/png",TEXT:"text/plain",WAV:"audio/x-wav",XML:"application/xml"},y_.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"},y_.binaryExtensions=[".model",".wav",".ogg",".mp3",".mp4",".m4a",".aac",".dds",".basis",".glb",".opus"],y_.retryDelay=100;const b_=new y_;function x_(){return!("undefined"==typeof AudioContext&&"undefined"==typeof webkitAudioContext)}class w_{constructor(e,t,s={}){var i,n,r;if(this.volume=null!=(i=s.volume)?i:1,this.loop=null!=(n=s.loop)&&n,this.pitch=null!=(r=s.pitch)?r:1,this.sound=t,this.paused=!1,this.suspended=!1,this.manager=e,this.source=null,x_()){this.startTime=0,this.startOffset=0;const t=e.context;this.gain=t.createGain()}else t.audio&&(this.source=t.audio.cloneNode(!1),this.source.pause())}getVolume(){return this.volume}getLoop(){return this.loop}setLoop(e){this.loop=e,this.source&&(this.source.loop=e)}getPitch(){return this.pitch}onManagerVolumeChange(){this.setVolume(this.getVolume())}onManagerSuspend(){this.isPlaying()&&!this.suspended&&(this.suspended=!0,this.pause())}onManagerResume(){this.suspended&&(this.suspended=!1,this.unpause())}play(){if(this.source)throw new Error("Call stop() before calling play()");this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend())}pause(){this.source&&(this.paused=!0,this.startOffset+=this.manager.context.currentTime-this.startTime,this.source.stop(0),this.source=null)}unpause(){!this.source&&this.paused?(this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.paused=!1)):console.warn("Call pause() before unpausing.")}stop(){this.source&&(this.source.stop(0),this.source=null),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)}setVolume(e){e=Wd.clamp(e,0,1),this.volume=e,this.gain&&(this.gain.gain.value=e*this.manager.volume)}setPitch(e){this.pitch=e,this.source&&(this.source.playbackRate.value=e)}isPlaying(){return!this.paused&&this.source.playbackState===this.source.PLAYING_STATE}getDuration(){return this.source?this.source.buffer.duration:0}_createSource(){const e=this.manager.context;this.sound.buffer&&(this.source=e.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.gain),this.gain.connect(e.destination),this.loop||(this.source.onended=this.pause.bind(this)))}}x_()||Object.assign(w_.prototype,{play:function(){this.source&&(this.paused=!1,this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.source.play()),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.source.pause())},unpause:function(){this.source&&(this.paused=!1,this.source.play())},stop:function(){this.source&&this.source.pause(),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)},setVolume:function(e){e=Wd.clamp(e,0,1),this.volume=e,this.source&&(this.source.volume=e*this.manager.volume)},setPitch:function(e){this.pitch=e,this.source&&(this.source.playbackRate=e)},getDuration:function(){return this.source&&!isNaN(this.source.duration)?this.source.duration:0},isPlaying:function(){return!this.source.paused}});class S_ extends w_{constructor(e,t,s){super(e,t,s),this.position=new nu,this.velocity=new nu,x_()?this.panner=e.context.createPanner():(this.maxDistance=1e4,this.minDistance=1,this.rollOffFactor=1,this.distanceModel=Pu)}getPosition(){return this.position}setPosition(e){this.position.copy(e);const t=this.panner;"positionX"in t?(t.positionX.value=e.x,t.positionY.value=e.y,t.positionZ.value=e.z):t.setPosition&&t.setPosition(e.x,e.y,e.z)}getVelocity(){return this.velocity}setVelocity(e){this.velocity.copy(e)}getMaxDistance(){return this.panner.maxDistance}setMaxDistance(e){this.panner.maxDistance=e}getMinDistance(){return this.panner.refDistance}setMinDistance(e){this.panner.refDistance=e}getRollOffFactor(){return this.panner.rolloffFactor}setRollOffFactor(e){this.panner.rolloffFactor=e}getDistanceModel(){return this.panner.distanceModel}setDistanceModel(e){this.panner.distanceModel=e}_createSource(){const e=this.manager.context;this.source=e.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.panner),this.panner.connect(this.gain),this.gain.connect(e.destination),this.loop||(this.source.onended=this.pause.bind(this))}}if(!x_()){let e=new nu;const t=function(t,s,i,n,r,a){e=e.sub2(t,s);const o=e.length();if(o<i)return 1;if(o>n)return 0;let l=0;return a===Eu?l=1-r*(o-i)/(n-i):a===Pu?l=i/(i+r*(o-i)):a===Mu&&(l=Math.pow(o/i,-r)),Wd.clamp(l,0,1)};Object.assign(S_.prototype,{setPosition:function(e){if(this.position.copy(e),this.source){const e=this.manager.listener.getPosition(),s=t(e,this.position,this.minDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),i=this.getVolume();this.source.volume=i*s}},getMaxDistance:function(){return this.maxDistance},setMaxDistance:function(e){this.maxDistance=e},getMinDistance:function(){return this.minDistance},setMinDistance:function(e){this.minDistance=e},getRollOffFactor:function(){return this.rollOffFactor},setRollOffFactor:function(e){this.rollOffFactor=e},getDistanceModel:function(){return this.distanceModel},setDistanceModel:function(e){this.distanceModel=e}})}class C_{constructor(e){this._manager=e,this.position=new nu,this.velocity=new nu,this.orientation=new pu}getPosition(){return this.position}setPosition(e){this.position.copy(e);const t=this.listener;t&&("positionX"in t?(t.positionX.value=e.x,t.positionY.value=e.y,t.positionZ.value=e.z):t.setPosition&&t.setPosition(e.x,e.y,e.z))}getVelocity(){return this.velocity}setVelocity(e){}setOrientation(e){this.orientation.copy(e);const t=this.listener;if(t){const s=e.data;"forwardX"in t?(t.forwardX.value=-s[8],t.forwardY.value=-s[9],t.forwardZ.value=-s[10],t.upX.value=s[4],t.upY.value=s[5],t.upZ.value=s[6]):t.setOrientation&&t.setOrientation(-s[8],-s[9],-s[10],s[4],s[5],s[6])}}getOrientation(){return this.orientation}get listener(){const e=this._manager.context;return e?e.listener:null}}const T_="running",A_=["click","touchstart","mousedown"];class E_ extends od{constructor(){super(),this._context=null,this.AudioContext="undefined"!=typeof AudioContext&&AudioContext||"undefined"!=typeof webkitAudioContext&&webkitAudioContext,this.AudioContext,this._unlockHandlerFunc=this._unlockHandler.bind(this),this._userSuspended=!1,this.listener=new C_(this),this._volume=1}set volume(e){e=Wd.clamp(e,0,1),this._volume=e,this.fire("volumechange",e)}get volume(){return this._volume}get suspended(){return this._userSuspended}get context(){return!this._context&&this.AudioContext&&(this._context=new this.AudioContext,this._context.state!==T_&&this._registerUnlockListeners()),this._context}suspend(){this._userSuspended||(this._userSuspended=!0,this._context&&this._context.state===T_&&this._suspend())}resume(){this._userSuspended&&(this._userSuspended=!1,this._context&&this._context.state!==T_&&this._resume())}destroy(){var e;(this.fire("destroy"),this._context)&&(this._removeUnlockListeners(),null==(e=this._context)||e.close(),this._context=null)}playSound(e,t={}){let s=null;return w_&&(s=new w_(this,e,t),s.play()),s}playSound3d(e,t,s={}){let i=null;return S_&&(i=new S_(this,e,s),i.setPosition(t),s.volume&&i.setVolume(s.volume),s.loop&&i.setLoop(s.loop),s.maxDistance&&i.setMaxDistance(s.maxDistance),s.minDistance&&i.setMinDistance(s.minDistance),s.rollOffFactor&&i.setRollOffFactor(s.rollOffFactor),s.distanceModel&&i.setDistanceModel(s.distanceModel),i.play()),i}_resume(){this._context.resume().then((()=>{const e=this._context.createBufferSource();e.buffer=this._context.createBuffer(1,1,this._context.sampleRate),e.connect(this._context.destination),e.start(0),e.onended=t=>{e.disconnect(0),this.fire("resume")}}),(e=>{})).catch((e=>{}))}_suspend(){this._context.suspend().then((()=>{this.fire("suspend")}),(e=>{})).catch((e=>{}))}_unlockHandler(){this._removeUnlockListeners(),this._userSuspended||this._context.state===T_||this._resume()}_registerUnlockListeners(){A_.forEach((e=>{window.addEventListener(e,this._unlockHandlerFunc,!1)}))}_removeUnlockListeners(){A_.forEach((e=>{window.removeEventListener(e,this._unlockHandlerFunc,!1)}))}}function P_(e,t){return e%t||0}class M_ extends od{constructor(e,t,s){super(),this.source=null,this._manager=e,this._volume=void 0!==s.volume?Wd.clamp(Number(s.volume)||0,0,1):1,this._pitch=void 0!==s.pitch?Math.max(.01,Number(s.pitch)||0):1,this._loop=!(void 0===s.loop||!s.loop),this._sound=t,this._state=2,this._suspended=!1,this._suspendEndEvent=0,this._suspendInstanceEvents=!1,this._playWhenLoaded=!0,this._startTime=Math.max(0,Number(s.startTime)||0),this._duration=Math.max(0,Number(s.duration)||0),this._startOffset=null,this._onPlayCallback=s.onPlay,this._onPauseCallback=s.onPause,this._onResumeCallback=s.onResume,this._onStopCallback=s.onStop,this._onEndCallback=s.onEnd,x_()?(this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._inputNode=null,this._connectorNode=null,this._firstNode=null,this._lastNode=null,this._waitingContextSuspension=!1,this._initializeNodes(),this._endedHandler=this._onEnded.bind(this)):(this._isReady=!1,this._loadedMetadataHandler=this._onLoadedMetadata.bind(this),this._timeUpdateHandler=this._onTimeUpdate.bind(this),this._endedHandler=this._onEnded.bind(this),this._createSource())}set currentTime(e){if(!(e<0))if(0===this._state){const t=this._suspendInstanceEvents;this._suspendInstanceEvents=!0,this.stop(),this._startOffset=e,this.play(),this._suspendInstanceEvents=t}else this._startOffset=e,this._currentTime=e}get currentTime(){return null!==this._startOffset?this._startOffset:1===this._state?this._currentTime:2!==this._state&&this.source?(this._updateCurrentTime(),this._currentTime):0}set duration(e){this._duration=Math.max(0,Number(e)||0);const t=0===this._state;this.stop(),t&&this.play()}get duration(){return this._sound?this._duration?P_(this._duration,this._sound.duration):this._sound.duration:0}get isPaused(){return 1===this._state}get isPlaying(){return 0===this._state}get isStopped(){return 2===this._state}get isSuspended(){return this._suspended}set loop(e){this._loop=!!e,this.source&&(this.source.loop=this._loop)}get loop(){return this._loop}set pitch(e){this._currentOffset=this.currentTime,this._startedAt=this._manager.context.currentTime,this._pitch=Math.max(Number(e)||0,.01),this.source&&(this.source.playbackRate.value=this._pitch)}get pitch(){return this._pitch}set sound(e){this._sound=e,2!==this._state?this.stop():this._createSource()}get sound(){return this._sound}set startTime(e){this._startTime=Math.max(0,Number(e)||0);const t=0===this._state;this.stop(),t&&this.play()}get startTime(){return this._startTime}set volume(e){e=Wd.clamp(e,0,1),this._volume=e,this.gain&&(this.gain.gain.value=e*this._manager.volume)}get volume(){return this._volume}_onPlay(){this.fire("play"),this._onPlayCallback&&this._onPlayCallback(this)}_onPause(){this.fire("pause"),this._onPauseCallback&&this._onPauseCallback(this)}_onResume(){this.fire("resume"),this._onResumeCallback&&this._onResumeCallback(this)}_onStop(){this.fire("stop"),this._onStopCallback&&this._onStopCallback(this)}_onEnded(){this._suspendEndEvent>0?this._suspendEndEvent--:(this.fire("end"),this._onEndCallback&&this._onEndCallback(this),this.stop())}_onManagerVolumeChange(){this.volume=this._volume}_onManagerSuspend(){0!==this._state||this._suspended||(this._suspended=!0,this.pause())}_onManagerResume(){this._suspended&&(this._suspended=!1,this.resume())}_initializeNodes(){this.gain=this._manager.context.createGain(),this._inputNode=this.gain,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)}play(){return 2!==this._state&&this.stop(),this._state=0,this._playWhenLoaded=!1,!this._waitingContextSuspension&&(this._manager.suspended?(this._manager.once("resume",this._playAudioImmediate,this),this._waitingContextSuspension=!0,!1):(this._playAudioImmediate(),!0))}_playAudioImmediate(){if(this._waitingContextSuspension=!1,0!==this._state)return;this.source||this._createSource();let e=P_(this._startOffset,this.duration);e=P_(this._startTime+e,this._sound.duration),this._startOffset=null,this._duration?this.source.start(0,e,this._duration):this.source.start(0,e),this._startedAt=this._manager.context.currentTime,this._currentTime=0,this._currentOffset=e,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._suspendInstanceEvents||this._onPlay()}pause(){return this._playWhenLoaded=!1,0===this._state&&(this._state=1,this._waitingContextSuspension||(this._updateCurrentTime(),this._suspendEndEvent++,this.source.stop(0),this.source=null,this._startOffset=null,this._suspendInstanceEvents||this._onPause()),!0)}resume(){if(1!==this._state)return!1;let e=this.currentTime;return this._state=0,this._waitingContextSuspension||(this.source||this._createSource(),null!==this._startOffset&&(e=P_(this._startOffset,this.duration),e=P_(this._startTime+e,this._sound.duration),this._startOffset=null),this._duration?this.source.start(0,e,this._duration):this.source.start(0,e),this._startedAt=this._manager.context.currentTime,this._currentOffset=e,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._playWhenLoaded=!1,this._suspendInstanceEvents||this._onResume()),!0}stop(){if(this._playWhenLoaded=!1,2===this._state)return!1;const e=0===this._state;return this._state=2,this._waitingContextSuspension||(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._startOffset=null,this._suspendEndEvent++,e&&this.source&&this.source.stop(0),this.source=null,this._suspendInstanceEvents||this._onStop()),!0}setExternalNodes(e,t){if(!e)return void console.error("The firstNode must be a valid Audio Node");t||(t=e);const s=this._manager.context.destination;this._firstNode!==e&&(this._firstNode?this._connectorNode.disconnect(this._firstNode):this._connectorNode.disconnect(s),this._firstNode=e,this._connectorNode.connect(e)),this._lastNode!==t&&(this._lastNode&&this._lastNode.disconnect(s),this._lastNode=t,this._lastNode.connect(s))}clearExternalNodes(){const e=this._manager.context.destination;this._firstNode&&(this._connectorNode.disconnect(this._firstNode),this._firstNode=null),this._lastNode&&(this._lastNode.disconnect(e),this._lastNode=null),this._connectorNode.connect(e)}getExternalNodes(){return[this._firstNode,this._lastNode]}_createSource(){if(!this._sound)return null;const e=this._manager.context;return this._sound.buffer&&(this.source=e.createBufferSource(),this.source.buffer=this._sound.buffer,this.source.connect(this._inputNode),this.source.onended=this._endedHandler,this.source.loopStart=P_(this._startTime,this.source.buffer.duration),this._duration&&(this.source.loopEnd=Math.max(this.source.loopStart,P_(this._startTime+this._duration,this.source.buffer.duration)))),this.source}_updateCurrentTime(){this._currentTime=P_((this._manager.context.currentTime-this._startedAt)*this._pitch+this._currentOffset,this.duration)}_onManagerDestroy(){this.source&&0===this._state&&(this.source.stop(0),this.source=null)}}M_.EVENT_PLAY="play",M_.EVENT_PAUSE="pause",M_.EVENT_RESUME="resume",M_.EVENT_STOP="stop",M_.EVENT_END="end",x_()||(Object.assign(M_.prototype,{play:function(){return 2!==this._state&&this.stop(),!(!this.source&&!this._createSource())&&(this.volume=this._volume,this.pitch=this._pitch,this.loop=this._loop,this.source.play(),this._state=0,this._playWhenLoaded=!1,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),!0)},pause:function(){return!(!this.source||0!==this._state)&&(this._suspendEndEvent++,this.source.pause(),this._playWhenLoaded=!1,this._state=1,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),!0)},resume:function(){return!(!this.source||1!==this._state)&&(this._state=0,this._playWhenLoaded=!1,this.source.paused&&(this.source.play(),this._suspendInstanceEvents||this._onResume()),!0)},stop:function(){return!(!this.source||2===this._state)&&(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._suspendEndEvent++,this.source.pause(),this._playWhenLoaded=!1,this._state=2,this._startOffset=null,this._suspendInstanceEvents||this._onStop(),!0)},setExternalNodes:function(){},clearExternalNodes:function(){},getExternalNodes:function(){return[null,null]},_onLoadedMetadata:function(){this.source.removeEventListener("loadedmetadata",this._loadedMetadataHandler),this._isReady=!0;let e=P_(this._startOffset,this.duration);e=P_(this._startTime+e,this._sound.duration),this._startOffset=null,this.source.currentTime=e},_createSource:function(){return this._sound&&this._sound.audio&&(this._isReady=!1,this.source=this._sound.audio.cloneNode(!0),this.source.addEventListener("loadedmetadata",this._loadedMetadataHandler),this.source.addEventListener("timeupdate",this._timeUpdateHandler),this.source.onended=this._endedHandler),this.source},_onTimeUpdate:function(){this._duration&&this.source.currentTime>P_(this._startTime+this._duration,this.source.duration)&&(this.loop?this.source.currentTime=P_(this._startTime,this.source.duration):(this.source.removeEventListener("timeupdate",this._timeUpdateHandler),this.source.pause(),this._onEnded()))},_onManagerDestroy:function(){this.source&&this.source.pause()}}),Object.defineProperty(M_.prototype,"volume",{get:function(){return this._volume},set:function(e){e=Wd.clamp(e,0,1),this._volume=e,this.source&&(this.source.volume=e*this._manager.volume)}}),Object.defineProperty(M_.prototype,"pitch",{get:function(){return this._pitch},set:function(e){this._pitch=Math.max(Number(e)||0,.01),this.source&&(this.source.playbackRate=this._pitch)}}),Object.defineProperty(M_.prototype,"sound",{get:function(){return this._sound},set:function(e){this.stop(),this._sound=e}}),Object.defineProperty(M_.prototype,"currentTime",{get:function(){return null!==this._startOffset?this._startOffset:2!==this._state&&this.source?this.source.currentTime-this._startTime:0},set:function(e){e<0||(this._startOffset=e,this.source&&this._isReady&&(this.source.currentTime=P_(this._startTime+P_(e,this.duration),this._sound.duration),this._startOffset=null))}}));class L_ extends M_{constructor(e,t,s={}){super(e,t,s),this._position=new nu,this._velocity=new nu,s.position&&(this.position=s.position),this.maxDistance=void 0!==s.maxDistance?Number(s.maxDistance):1e4,this.refDistance=void 0!==s.refDistance?Number(s.refDistance):1,this.rollOffFactor=void 0!==s.rollOffFactor?Number(s.rollOffFactor):1,this.distanceModel=void 0!==s.distanceModel?s.distanceModel:Eu}_initializeNodes(){this.gain=this._manager.context.createGain(),this.panner=this._manager.context.createPanner(),this.panner.connect(this.gain),this._inputNode=this.panner,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)}set position(e){this._position.copy(e);const t=this.panner;"positionX"in t?(t.positionX.value=e.x,t.positionY.value=e.y,t.positionZ.value=e.z):t.setPosition&&t.setPosition(e.x,e.y,e.z)}get position(){return this._position}set velocity(e){this._velocity.copy(e)}get velocity(){return this._velocity}set maxDistance(e){this.panner.maxDistance=e}get maxDistance(){return this.panner.maxDistance}set refDistance(e){this.panner.refDistance=e}get refDistance(){return this.panner.refDistance}set rollOffFactor(e){this.panner.rolloffFactor=e}get rollOffFactor(){return this.panner.rolloffFactor}set distanceModel(e){this.panner.distanceModel=e}get distanceModel(){return this.panner.distanceModel}}if(!x_()){let e=new nu;const t=function(t,s,i,n,r,a){e=e.sub2(t,s);const o=e.length();if(o<i)return 1;if(o>n)return 0;let l=0;return a===Eu?l=1-r*(o-i)/(n-i):a===Pu?l=i/(i+r*(o-i)):a===Mu&&(l=Math.pow(o/i,-r)),Wd.clamp(l,0,1)};Object.defineProperty(L_.prototype,"position",{get:function(){return this._position},set:function(e){if(this._position.copy(e),this.source){const e=this._manager.listener.getPosition(),s=t(e,this._position,this.refDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),i=this.volume;this.source.volume=i*s*this._manager.volume}}}),Object.defineProperty(L_.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(e){this._maxDistance=e}}),Object.defineProperty(L_.prototype,"refDistance",{get:function(){return this._refDistance},set:function(e){this._refDistance=e}}),Object.defineProperty(L_.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(e){this._rollOffFactor=e}}),Object.defineProperty(L_.prototype,"distanceModel",{get:function(){return this._distanceModel},set:function(e){this._distanceModel=e}})}const D_="none",k_={0:"PCF3",1:"VSM8",2:"VSM16",3:"VSM32",4:"PCF5",5:"PCF1",6:"PCSS"},I_=256,R_=1024,O_=2048,z_=4096,F_="infinite",V_="none",N_="bayer8";class B_{constructor(){this._refCount=0}incRefCount(){this._refCount++}decRefCount(){this._refCount--}get refCount(){return this._refCount}}let U_=0;class H_{constructor(){this.initDefaults()}initDefaults(){this.recreate=!1,this.verticesUsage=0,this.indicesUsage=0,this.maxVertices=0,this.maxIndices=0,this.vertexCount=0,this.indexCount=0,this.vertexStreamsUpdated=!1,this.indexStreamUpdated=!1,this.vertexStreamDictionary={},this.indices=null}_changeVertexCount(e,t){this.vertexCount||(this.vertexCount=e)}}H_.DEFAULT_COMPONENTS_POSITION=3,H_.DEFAULT_COMPONENTS_NORMAL=3,H_.DEFAULT_COMPONENTS_UV=2,H_.DEFAULT_COMPONENTS_COLORS=4;class W_{constructor(e,t,s,i){this.data=e,this.componentCount=t,this.dataType=s,this.dataTypeNormalize=i}}class G_ extends B_{constructor(e){super(),this._aabbVer=0,this._aabb=new xu,this.id=U_++,this.device=e,this.vertexBuffer=null,this.indexBuffer=[null],this.primitive=[{type:0,base:0,count:0}],this.skin=null,this._morph=null,this._geometryData=null,this.boneAabb=null}set morph(e){e!==this._morph&&(this._morph&&this._morph.decRefCount(),this._morph=e,e&&e.incRefCount())}get morph(){return this._morph}set aabb(e){this._aabb=e,this._aabbVer++}get aabb(){return this._aabb}destroy(){const e=this.morph;e&&(this.morph=null,e.refCount<1&&e.destroy()),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);for(let e=0;e<this.indexBuffer.length;e++)this._destroyIndexBuffer(e);this.indexBuffer.length=0,this._geometryData=null}_destroyIndexBuffer(e){this.indexBuffer[e]&&(this.indexBuffer[e].destroy(),this.indexBuffer[e]=null)}_initBoneAabbs(e){let t,s,i,n,r;this.boneAabb=[],this.boneUsed=[];const a=[],o=[],l=this.boneUsed,h=this.skin.boneNames.length;let c,d,u;for(let e=0;e<h;e++)a[e]=new nu(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o[e]=new nu(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);const p=new Xm(this.vertexBuffer),m=p.element[Ou],_=p.element[Vu],f=p.element[Nu],g=this.vertexBuffer.numVertices;for(let h=0;h<g;h++){for(let p=0;p<4;p++){if(_.array[_.index+p]>0){const _=f.array[f.index+p];if(l[_]=!0,t=m.array[m.index],s=m.array[m.index+1],i=m.array[m.index+2],n=o[_],r=a[_],r.x>t&&(r.x=t),r.y>s&&(r.y=s),r.z>i&&(r.z=i),n.x<t&&(n.x=t),n.y<s&&(n.y=s),n.z<i&&(n.z=i),e){let a=c=t,o=d=s,l=u=i;for(let t=0;t<e.length;t++){const s=e[t],i=s.deltaPositions[3*h],n=s.deltaPositions[3*h+1],r=s.deltaPositions[3*h+2];i<0?a+=i:c+=i,n<0?o+=n:d+=n,r<0?l+=r:u+=r}r.x>a&&(r.x=a),r.y>o&&(r.y=o),r.z>l&&(r.z=l),n.x<c&&(n.x=c),n.y<d&&(n.y=d),n.z<u&&(n.z=u)}}}p.next()}const v=this.vertexBuffer.getFormat().elements.find((e=>e.name===Ou));if(v&&v.normalize){const e=(()=>{switch(v.dataType){case 0:return e=>Math.max(e/127,-1);case op:return e=>e/255;case 2:return e=>Math.max(e/32767,-1);case 3:return e=>e/65535;default:return e=>e}})();for(let t=0;t<h;t++)if(l[t]){const s=a[t],i=o[t];s.set(e(s.x),e(s.y),e(s.z)),i.set(e(i.x),e(i.y),e(i.z))}}for(let e=0;e<h;e++){const t=new xu;t.setMinMax(a[e],o[e]),this.boneAabb.push(t)}}_initGeometryData(){this._geometryData||(this._geometryData=new H_,this.vertexBuffer&&(this._geometryData.vertexCount=this.vertexBuffer.numVertices,this._geometryData.maxVertices=this.vertexBuffer.numVertices),this.indexBuffer.length>0&&this.indexBuffer[0]&&(this._geometryData.indexCount=this.indexBuffer[0].numIndices,this._geometryData.maxIndices=this.indexBuffer[0].numIndices))}clear(e,t,s=0,i=0){this._initGeometryData(),this._geometryData.initDefaults(),this._geometryData.recreate=!0,this._geometryData.maxVertices=s,this._geometryData.maxIndices=i,this._geometryData.verticesUsage=e?0:1,this._geometryData.indicesUsage=t?0:1}setVertexStream(e,t,s,i,n=6,r=!1){this._initGeometryData();const a=i||t.length/s;this._geometryData._changeVertexCount(a,e),this._geometryData.vertexStreamsUpdated=!0,this._geometryData.vertexStreamDictionary[e]=new W_(t,s,n,r)}getVertexStream(e,t){let s=0,i=!1;if(this._geometryData){const n=this._geometryData.vertexStreamDictionary[e];n&&(i=!0,s=this._geometryData.vertexCount,ArrayBuffer.isView(t)?t.set(n.data):(t.length=0,t.push(n.data)))}if(!i&&this.vertexBuffer){s=new Xm(this.vertexBuffer).readData(e,t)}return s}setPositions(e,t=H_.DEFAULT_COMPONENTS_POSITION,s){this.setVertexStream(Ou,e,t,s,6,!1)}setNormals(e,t=H_.DEFAULT_COMPONENTS_NORMAL,s){this.setVertexStream(zu,e,t,s,6,!1)}setUvs(e,t,s=H_.DEFAULT_COMPONENTS_UV,i){this.setVertexStream(Uu+e,t,s,i,6,!1)}setColors(e,t=H_.DEFAULT_COMPONENTS_COLORS,s){this.setVertexStream(Bu,e,t,s,6,!1)}setColors32(e,t){this.setVertexStream(Bu,e,H_.DEFAULT_COMPONENTS_COLORS,t,op,!0)}setIndices(e,t){this._initGeometryData(),this._geometryData.indexStreamUpdated=!0,this._geometryData.indices=e,this._geometryData.indexCount=t||e.length}getPositions(e){return this.getVertexStream(Ou,e)}getNormals(e){return this.getVertexStream(zu,e)}getUvs(e,t){return this.getVertexStream(Uu+e,t)}getColors(e){return this.getVertexStream(Bu,e)}getIndices(e){let t=0;if(this._geometryData&&this._geometryData.indices){const s=this._geometryData.indices;if(t=this._geometryData.indexCount,ArrayBuffer.isView(e))e.set(s);else{e.length=0;for(let t=0,i=s.length;t<i;t++)e.push(s[t])}}else if(this.indexBuffer.length>0&&this.indexBuffer[0]){t=this.indexBuffer[0].readData(e)}return t}update(e=4,t=!0){if(this._geometryData){if(t){const e=this._geometryData.vertexStreamDictionary[Ou];e&&3===e.componentCount&&(this._aabb.compute(e.data,this._geometryData.vertexCount),this._aabbVer++)}let s=this._geometryData.recreate;this._geometryData.vertexCount>this._geometryData.maxVertices&&(s=!0,this._geometryData.maxVertices=this._geometryData.vertexCount),s&&this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);let i=this._geometryData.recreate;this._geometryData.indexCount>this._geometryData.maxIndices&&(i=!0,this._geometryData.maxIndices=this._geometryData.indexCount),i&&this.indexBuffer.length>0&&this.indexBuffer[0]&&(this.indexBuffer[0].destroy(),this.indexBuffer[0]=null),this._geometryData.vertexStreamsUpdated&&this._updateVertexBuffer(),this._geometryData.indexStreamUpdated&&this._updateIndexBuffer(),this.primitive[0].type=e,this.indexBuffer.length>0&&this.indexBuffer[0]?this._geometryData.indexStreamUpdated&&(this.primitive[0].count=this._geometryData.indexCount,this.primitive[0].indexed=!0):this._geometryData.vertexStreamsUpdated&&(this.primitive[0].count=this._geometryData.vertexCount,this.primitive[0].indexed=!1),this._geometryData.vertexCount=0,this._geometryData.indexCount=0,this._geometryData.vertexStreamsUpdated=!1,this._geometryData.indexStreamUpdated=!1,this._geometryData.recreate=!1,this.updateRenderStates()}}_buildVertexFormat(e){const t=[];for(const e in this._geometryData.vertexStreamDictionary){const s=this._geometryData.vertexStreamDictionary[e];t.push({semantic:e,components:s.componentCount,type:s.dataType,normalize:s.dataTypeNormalize})}return new Bp(this.device,t,e)}_updateVertexBuffer(){if(!this.vertexBuffer){const e=this._geometryData.maxVertices,t=this._buildVertexFormat(e);this.vertexBuffer=new Rp(this.device,t,e,this._geometryData.verticesUsage)}const e=new Xm(this.vertexBuffer),t=this._geometryData.vertexCount;for(const s in this._geometryData.vertexStreamDictionary){const i=this._geometryData.vertexStreamDictionary[s];e.writeData(s,i.data,t),delete this._geometryData.vertexStreamDictionary[s]}e.end()}_updateIndexBuffer(){if(this.indexBuffer.length<=0||!this.indexBuffer[0]){const e=this._geometryData.maxVertices>65535?2:1;this.indexBuffer[0]=new Lm(this.device,e,this._geometryData.maxIndices,this._geometryData.indicesUsage)}const e=this._geometryData.indices;if(e){this.indexBuffer[0].writeData(e,this._geometryData.indexCount),this._geometryData.indices=null}}prepareRenderState(e){1===e?this.generateWireframe():2===e&&(this.primitive[2]={type:0,base:0,count:this.vertexBuffer?this.vertexBuffer.numVertices:0,indexed:!1})}updateRenderStates(){this.primitive[2]&&this.prepareRenderState(2),this.primitive[1]&&this.prepareRenderState(1)}generateWireframe(){this._destroyIndexBuffer(1);const e=this.vertexBuffer.numVertices,t=[];let s;if(this.indexBuffer.length>0&&this.indexBuffer[0]){const i=[[0,1],[1,2],[2,0]],n=this.primitive[0].base,r=this.primitive[0].count,a=this.indexBuffer[0],o=new gp[a.format](a.storage),l=new Set;for(let s=n;s<n+r;s+=3)for(let n=0;n<3;n++){const r=o[s+i[n][0]],a=o[s+i[n][1]],h=r>a?a*e+r:r*e+a;l.has(h)||(l.add(h),t.push(r,a))}s=a.format}else{for(let s=0;s<e;s+=3)t.push(s,s+1,s+1,s+2,s+2,s);s=t.length>65535?2:1}const i=new Lm(this.vertexBuffer.device,s,t.length);new gp[i.format](i.storage).set(t),i.unlock(),this.primitive[1]={type:1,base:0,count:t.length,indexed:!0},this.indexBuffer[1]=i}}const j_=4/64,q_=1-2*j_,K_=[];function X_(e,t,s,i){const n=i.length/3,r=e.length/3,a=new nu,o=new nu,l=new nu,h=new au,c=new au,d=new au,u=new nu,p=new nu,m=new Float32Array(3*r),_=new Float32Array(3*r),f=[];for(let t=0;t<n;t++){const n=i[3*t],r=i[3*t+1],f=i[3*t+2];a.set(e[3*n],e[3*n+1],e[3*n+2]),o.set(e[3*r],e[3*r+1],e[3*r+2]),l.set(e[3*f],e[3*f+1],e[3*f+2]),h.set(s[2*n],s[2*n+1]),c.set(s[2*r],s[2*r+1]),d.set(s[2*f],s[2*f+1]);const g=o.x-a.x,v=l.x-a.x,y=o.y-a.y,b=l.y-a.y,x=o.z-a.z,w=l.z-a.z,S=c.x-h.x,C=d.x-h.x,T=c.y-h.y,A=d.y-h.y,E=S*A-C*T;if(0===E)u.set(0,1,0),p.set(1,0,0);else{const e=1/E;u.set((A*g-T*v)*e,(A*y-T*b)*e,(A*x-T*w)*e),p.set((S*v-C*g)*e,(S*b-C*y)*e,(S*w-C*x)*e)}m[3*n+0]+=u.x,m[3*n+1]+=u.y,m[3*n+2]+=u.z,m[3*r+0]+=u.x,m[3*r+1]+=u.y,m[3*r+2]+=u.z,m[3*f+0]+=u.x,m[3*f+1]+=u.y,m[3*f+2]+=u.z,_[3*n+0]+=p.x,_[3*n+1]+=p.y,_[3*n+2]+=p.z,_[3*r+0]+=p.x,_[3*r+1]+=p.y,_[3*r+2]+=p.z,_[3*f+0]+=p.x,_[3*f+1]+=p.y,_[3*f+2]+=p.z}const g=new nu,v=new nu,y=new nu,b=new nu;for(let e=0;e<r;e++){y.set(t[3*e],t[3*e+1],t[3*e+2]),g.set(m[3*e],m[3*e+1],m[3*e+2]),v.set(_[3*e],_[3*e+1],_[3*e+2]);const s=y.dot(g);b.copy(y).mulScalar(s),b.sub2(g,b).normalize(),f[4*e]=b.x,f[4*e+1]=b.y,f[4*e+2]=b.z,b.cross(y,g),f[4*e+3]=b.dot(v)<0?-1:1}return f}function Y_(e,t,s){const i=new G_(e);return i.setPositions(t),s&&(s.normals&&i.setNormals(s.normals),s.tangents&&i.setVertexStream(Fu,s.tangents,4),s.colors&&i.setColors32(s.colors),s.uvs&&i.setUvs(0,s.uvs),s.uvs1&&i.setUvs(1,s.uvs1),s.blendIndices&&i.setVertexStream(Nu,s.blendIndices,4,s.blendIndices.length/4,op),s.blendWeights&&i.setVertexStream(Vu,s.blendWeights,4),s.indices&&i.setIndices(s.indices)),i.update(),i}function Z_(e,t,s,i,n,r){const a=new nu,o=new nu,l=new nu,h=new nu,c=new nu,d=new nu,u=[],p=[],m=[],_=[],f=[];let g;if(s>0)for(let r=0;r<=i;r++)for(let g=0;g<=n;g++){const v=g/n*2*Math.PI-Math.PI,y=Math.sin(v),b=Math.cos(v);c.set(y*e,-s/2,b*e),h.set(y*t,s/2,b*t),a.lerp(c,h,r/i),o.sub2(h,c).normalize(),d.set(b,0,-y),l.cross(d,o).normalize(),u.push(a.x,a.y,a.z),p.push(l.x,l.y,l.z);let x=g/n,w=r/i;m.push(x,1-w);const S=w;if(w=x,x=S,x=x*q_+j_,w=w*q_+j_,x/=3,_.push(x,1-w),r<i&&g<n){const e=r*(n+1)+g,t=r*(n+1)+(g+1),s=(r+1)*(n+1)+g,i=(r+1)*(n+1)+(g+1);f.push(e,t,s),f.push(t,i,s)}}if(r){const e=Math.floor(n/2),r=n,a=s/2;for(let s=0;s<=e;s++){const i=s*Math.PI*.5/e,n=Math.sin(i),o=Math.cos(i);for(let i=0;i<=r;i++){const l=2*i*Math.PI/r-Math.PI/2,h=Math.sin(l),c=Math.cos(l)*n,d=o,f=h*n;let g=1-i/r,v=1-s/e;u.push(c*t,d*t+a,f*t),p.push(c,d,f),m.push(g,1-v),g=g*q_+j_,v=v*q_+j_,g/=3,v/=3,g+=1/3,_.push(g,1-v)}}g=(i+1)*(n+1);for(let t=0;t<e;++t)for(let e=0;e<r;++e){const s=t*(r+1)+e,i=s+r+1;f.push(g+s+1,g+i,g+s),f.push(g+s+1,g+i+1,g+i)}for(let s=0;s<=e;s++){const i=.5*Math.PI+s*Math.PI*.5/e,n=Math.sin(i),o=Math.cos(i);for(let i=0;i<=r;i++){const l=2*i*Math.PI/r-Math.PI/2,h=Math.sin(l),c=Math.cos(l)*n,d=o,f=h*n;let g=1-i/r,v=1-s/e;u.push(c*t,d*t-a,f*t),p.push(c,d,f),m.push(g,1-v),g=g*q_+j_,v=v*q_+j_,g/=3,v/=3,g+=2/3,_.push(g,1-v)}}g=(i+1)*(n+1)+(r+1)*(e+1);for(let t=0;t<e;++t)for(let e=0;e<r;++e){const s=t*(r+1)+e,i=s+r+1;f.push(g+s+1,g+i,g+s),f.push(g+s+1,g+i+1,g+i)}}else{if(g=(i+1)*(n+1),e>0)for(let t=0;t<n;t++){const i=t/n*2*Math.PI,r=Math.sin(i),a=-s/2,o=Math.cos(i);let l=1-(r+1)/2,h=(o+1)/2;u.push(r*e,a,o*e),p.push(0,-1,0),m.push(l,1-h),l=l*q_+j_,h=h*q_+j_,l/=3,h/=3,l+=1/3,_.push(l,1-h),t>1&&f.push(g,g+t,g+t-1)}if(g+=n,t>0)for(let e=0;e<n;e++){const i=e/n*2*Math.PI,r=Math.sin(i),a=s/2,o=Math.cos(i);let l=1-(r+1)/2,h=(o+1)/2;u.push(r*t,a,o*t),p.push(0,1,0),m.push(l,1-h),l=l*q_+j_,h=h*q_+j_,l/=3,h/=3,l+=2/3,_.push(l,1-h),e>1&&f.push(g,g+e-1,g+e)}}return{positions:u,normals:p,uvs:m,uvs1:_,indices:f}}function $_(e,t={}){var s,i,n,r,a,o;const l=null!=(s=t.halfExtents)?s:new nu(.5,.5,.5),h=null!=(i=t.widthSegments)?i:1,c=null!=(n=t.lengthSegments)?n:1,d=null!=(r=t.heightSegments)?r:1,u=null!=(a=t.calculateTangents)&&a,p=null!=(o=t.yOffset)?o:0,m=-l.y+p,_=l.y+p,f=[new nu(-l.x,m,l.z),new nu(l.x,m,l.z),new nu(l.x,_,l.z),new nu(-l.x,_,l.z),new nu(l.x,m,-l.z),new nu(-l.x,m,-l.z),new nu(-l.x,_,-l.z),new nu(l.x,_,-l.z)],g=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],v=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],y=1,b=2,x=3,w=4,S=5,C=[],T=[],A=[],E=[],P=[];let M=0;const L=(e,t,s)=>{const i=new nu,n=new nu,r=new nu,a=new nu;for(let o=0;o<=t;o++)for(let l=0;l<=s;l++){i.lerp(f[g[e][0]],f[g[e][1]],o/t),n.lerp(f[g[e][0]],f[g[e][2]],l/s),r.sub2(n,f[g[e][0]]),a.add2(i,r);let h=o/t,c=l/s;C.push(a.x,a.y,a.z),T.push(v[e][0],v[e][1],v[e][2]),A.push(h,1-c),h=h*q_+j_,c=c*q_+j_,h/=3,c/=3,h+=e%3/3,c+=Math.floor(e/3)/3,E.push(h,1-c),o<t&&l<s&&(P.push(M+s+1,M+1,M),P.push(M+s+1,M+s+2,M+1)),M++}};L(0,h,d),L(y,h,d),L(b,h,c),L(x,h,c),L(w,c,d),L(S,c,d);const D={normals:T,uvs:A,uvs1:E,indices:P};return u&&(D.tangents=X_(C,T,A,P)),Y_(e,C,D)}function Q_(e,t){let s=null;for(let i=0;i<K_.length;i++)K_[i].type===t&&K_[i].device===e&&(s=K_[i].primData);if(!s){let i,n;switch(t){case"box":i=$_(e),n={x:2,y:2,z:2,uv:2/3};break;case"capsule":i=function(e,t={}){var s,i,n,r,a;const o=null!=(s=t.radius)?s:.3,l=null!=(i=t.height)?i:1,h=null!=(n=t.heightSegments)?n:1,c=null!=(r=t.sides)?r:20,d=null!=(a=t.calculateTangents)&&a,u=Z_(o,o,l-2*o,h,c,!0);return d&&(u.tangents=X_(u.positions,u.normals,u.uvs,u.indices)),Y_(e,u.positions,u)}(e,{radius:.5,height:2}),n={x:2*Math.PI,y:Math.PI,z:2*Math.PI,uv:1/3+1/3/3*2};break;case"cone":i=function(e,t={}){var s,i,n,r,a,o;const l=null!=(s=t.baseRadius)?s:.5,h=null!=(i=t.peakRadius)?i:0,c=null!=(n=t.height)?n:1,d=null!=(r=t.heightSegments)?r:5,u=null!=(a=t.capSegments)?a:18,p=null!=(o=t.calculateTangents)&&o,m=Z_(l,h,c,d,u,!1);return p&&(m.tangents=X_(m.positions,m.normals,m.uvs,m.indices)),Y_(e,m.positions,m)}(e,{baseRadius:.5,peakRadius:0,height:1}),n={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case"cylinder":i=function(e,t={}){var s,i,n,r,a;const o=null!=(s=t.radius)?s:.5,l=null!=(i=t.height)?i:1,h=null!=(n=t.heightSegments)?n:5,c=null!=(r=t.capSegments)?r:20,d=null!=(a=t.calculateTangents)&&a,u=Z_(o,o,l,h,c,!1);return d&&(u.tangents=X_(u.positions,u.normals,u.uvs,u.indices)),Y_(e,u.positions,u)}(e,{radius:.5,height:1}),n={x:Math.PI,y:1.58,z:Math.PI,uv:1/3+1/3/3*2};break;case"plane":i=function(e,t={}){var s,i,n,r;const a=null!=(s=t.halfExtents)?s:new au(.5,.5),o=null!=(i=t.widthSegments)?i:5,l=null!=(n=t.lengthSegments)?n:5,h=null!=(r=t.calculateTangents)&&r,c=[],d=[],u=[],p=[];let m=0;for(let e=0;e<=o;e++)for(let t=0;t<=l;t++){const s=-a.x+2*a.x*e/o,i=0,n=-(-a.y+2*a.y*t/l),r=e/o,h=t/l;c.push(s,i,n),d.push(0,1,0),u.push(r,1-h),e<o&&t<l&&(p.push(m+l+1,m+1,m),p.push(m+l+1,m+l+2,m+1)),m++}const _={normals:d,uvs:u,uvs1:u,indices:p};return h&&(_.tangents=X_(c,d,u,p)),Y_(e,c,_)}(e,{halfExtents:new au(.5,.5),widthSegments:1,lengthSegments:1}),n={x:0,y:1,z:0,uv:1};break;case"sphere":i=function(e,t={}){var s,i,n,r;const a=null!=(s=t.radius)?s:.5,o=null!=(i=t.latitudeBands)?i:16,l=null!=(n=t.longitudeBands)?n:16,h=null!=(r=t.calculateTangents)&&r,c=[],d=[],u=[],p=[];for(let e=0;e<=o;e++){const t=e*Math.PI/o,s=Math.sin(t),i=Math.cos(t);for(let t=0;t<=l;t++){const n=2*t*Math.PI/l-Math.PI/2,r=Math.sin(n),h=Math.cos(n)*s,p=i,m=r*s,_=1-t/l,f=1-e/o;c.push(h*a,p*a,m*a),d.push(h,p,m),u.push(_,1-f)}}for(let e=0;e<o;++e)for(let t=0;t<l;++t){const s=e*(l+1)+t,i=s+l+1;p.push(s+1,i,s),p.push(s+1,i+1,i)}const m={normals:d,uvs:u,uvs1:u,indices:p};return h&&(m.tangents=X_(c,d,u,p)),Y_(e,c,m)}(e,{radius:.5}),n={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;case"torus":i=function(e,t={}){var s,i,n,r,a,o;const l=null!=(s=t.tubeRadius)?s:.2,h=null!=(i=t.ringRadius)?i:.3,c=(null!=(n=t.sectorAngle)?n:360)*Wd.DEG_TO_RAD,d=null!=(r=t.segments)?r:30,u=null!=(a=t.sides)?a:20,p=null!=(o=t.calculateTangents)&&o,m=[],_=[],f=[],g=[];for(let e=0;e<=u;e++)for(let t=0;t<=d;t++){const s=Math.cos(c*t/d)*(h+l*Math.cos(2*Math.PI*e/u)),i=Math.sin(2*Math.PI*e/u)*l,n=Math.sin(c*t/d)*(h+l*Math.cos(2*Math.PI*e/u)),r=Math.cos(c*t/d)*Math.cos(2*Math.PI*e/u),a=Math.sin(2*Math.PI*e/u),o=Math.sin(c*t/d)*Math.cos(2*Math.PI*e/u),p=e/u,v=1-t/d;if(m.push(s,i,n),_.push(r,a,o),f.push(p,1-v),e<u&&t<d){const s=e*(d+1)+t,i=(e+1)*(d+1)+t,n=e*(d+1)+(t+1),r=(e+1)*(d+1)+(t+1);g.push(s,i,n),g.push(i,r,n)}}const v={normals:_,uvs:f,uvs1:f,indices:g};return p&&(v.tangents=X_(m,_,f,g)),Y_(e,m,v)}(e,{tubeRadius:.2,ringRadius:.3}),n={x:.5*Math.PI*.5-.1*Math.PI*.1,y:.4,z:.4,uv:1};break;default:throw new Error("Invalid primitive type: "+t)}i.incRefCount(),s={mesh:i,area:n},K_.push({type:t,device:e,primData:s})}return s}var J_="\nvec3 decodeLinear(vec4 raw) {\n\treturn raw.rgb;\n}\nfloat decodeGamma(float raw) {\n\treturn pow(raw, 2.2);\n}\nvec3 decodeGamma(vec3 raw) {\n\treturn pow(raw, vec3(2.2));\n}\nvec3 decodeGamma(vec4 raw) {\n\treturn pow(raw.xyz, vec3(2.2));\n}\nvec3 decodeRGBM(vec4 raw) {\n\tvec3 color = (8.0 * raw.a) * raw.rgb;\n\treturn color * color;\n}\nvec3 decodeRGBP(vec4 raw) {\n\tvec3 color = raw.rgb * (-raw.a * 7.0 + 8.0);\n\treturn color * color;\n}\nvec3 decodeRGBE(vec4 raw) {\n\tif (raw.a == 0.0) {\n\t\treturn vec3(0.0, 0.0, 0.0);\n\t} else {\n\t\treturn raw.xyz * pow(2.0, raw.w * 255.0 - 128.0);\n\t}\n}\nvec4 passThrough(vec4 raw) {\n\treturn raw;\n}\n",ef="\nvec4 encodeLinear(vec3 source) {\n\treturn vec4(source, 1.0);\n}\nvec4 encodeGamma(vec3 source) {\n\treturn vec4(pow(source + 0.0000001, vec3(1.0 / 2.2)), 1.0);\n}\nvec4 encodeRGBM(vec3 source) {\n\tvec4 result;\n\tresult.rgb = pow(source.rgb, vec3(0.5));\n\tresult.rgb *= 1.0 / 8.0;\n\tresult.a = saturate( max( max( result.r, result.g ), max( result.b, 1.0 / 255.0 ) ) );\n\tresult.a = ceil(result.a * 255.0) / 255.0;\n\tresult.rgb /= result.a;\n\treturn result;\n}\nvec4 encodeRGBP(vec3 source) {\n\tvec3 gamma = pow(source, vec3(0.5));\n\tfloat maxVal = min(8.0, max(1.0, max(gamma.x, max(gamma.y, gamma.z))));\n\tfloat v = 1.0 - ((maxVal - 1.0) / 7.0);\n\tv = ceil(v * 255.0) / 255.0;\n\treturn vec4(gamma / (-v * 7.0 + 8.0), v);\t\n}\nvec4 encodeRGBE(vec3 source) {\n\tfloat maxVal = max(source.x, max(source.y, source.z));\n\tif (maxVal < 1e-32) {\n\t\treturn vec4(0, 0, 0, 0);\n\t} else {\n\t\tfloat e = ceil(log2(maxVal));\n\t\treturn vec4(source / pow(2.0, e), (e + 128.0) / 255.0);\n\t}\n}\n";const tf={alphaTestPS:"\nuniform float alpha_ref;\nvoid alphaTest(float a) {\n\tif (a < alpha_ref) discard;\n}\n",ambientConstantPS:"\nvoid addAmbient(vec3 worldNormal) {\n\tdDiffuseLight += light_globalAmbient;\n}\n",ambientEnvPS:"\n#ifndef ENV_ATLAS\n#define ENV_ATLAS\nuniform sampler2D texture_envAtlas;\n#endif\nvoid addAmbient(vec3 worldNormal) {\n\tvec3 dir = normalize(cubeMapRotate(worldNormal) * vec3(-1.0, 1.0, 1.0));\n\tvec2 uv = mapUv(toSphericalUv(dir), vec4(128.0, 256.0 + 128.0, 64.0, 32.0) / atlasSize);\n\tvec4 raw = texture2D(texture_envAtlas, uv);\n\tvec3 linear = $DECODE(raw);\n\tdDiffuseLight += processEnvironment(linear);\n}\n",ambientSHPS:"\nuniform vec3 ambientSH[9];\nvoid addAmbient(vec3 worldNormal) {\n\tvec3 n = cubeMapRotate(worldNormal);\n\tvec3 color =\n\t\tambientSH[0] +\n\t\tambientSH[1] * n.x +\n\t\tambientSH[2] * n.y +\n\t\tambientSH[3] * n.z +\n\t\tambientSH[4] * n.x * n.z +\n\t\tambientSH[5] * n.z * n.y +\n\t\tambientSH[6] * n.y * n.x +\n\t\tambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n\t\tambientSH[8] * (n.x * n.x - n.y * n.y);\n\tdDiffuseLight += processEnvironment(max(color, vec3(0.0)));\n}\n",aoPS:"\nvoid getAO() {\n\tdAo = 1.0;\n\t#ifdef MAPTEXTURE\n\tfloat aoBase = texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\tdAo *= addAoDetail(aoBase);\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAo *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",aoDetailMapPS:"\nfloat addAoDetail(float ao) {\n#ifdef MAPTEXTURE\n\tfloat aoDetail = texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\treturn detailMode_$DETAILMODE(vec3(ao), vec3(aoDetail)).r;\n#else\n\treturn ao;\n#endif\n}\n",aoDiffuseOccPS:"\nvoid occludeDiffuse(float ao) {\n\tdDiffuseLight *= ao;\n}\n",aoSpecOccPS:"\nuniform float material_occludeSpecularIntensity;\nvoid occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {\n\tfloat specPow = exp2(gloss * 11.0);\n\tfloat specOcc = saturate(pow(dot(worldNormal, viewDir) + ao, 0.01*specPow) - 1.0 + ao);\n\tspecOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n\t\n#ifdef LIT_SHEEN\n\tsSpecularLight *= specOcc;\n\tsReflection *= specOcc;\n#endif\n}\n",aoSpecOccConstPS:"\nvoid occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {\n\tfloat specPow = exp2(gloss * 11.0);\n\tfloat specOcc = saturate(pow(dot(worldNormal, viewDir) + ao, 0.01*specPow) - 1.0 + ao);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n\t\n#ifdef LIT_SHEEN\n\tsSpecularLight *= specOcc;\n\tsReflection *= specOcc;\n#endif\n}\n",aoSpecOccConstSimplePS:"\nvoid occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {\n\tdSpecularLight *= ao;\n\tdReflection *= ao;\n#ifdef LIT_SHEEN\n\tsSpecularLight *= ao;\n\tsReflection *= ao;\n#endif\n}\n",aoSpecOccSimplePS:"\nuniform float material_occludeSpecularIntensity;\nvoid occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {\n\tfloat specOcc = mix(1.0, ao, material_occludeSpecularIntensity);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n#ifdef LIT_SHEEN\n\tsSpecularLight *= specOcc;\n\tsReflection *= specOcc;\n#endif\n}\n",basePS:"\nuniform vec3 view_position;\nuniform vec3 light_globalAmbient;\nfloat square(float x) {\n\treturn x*x;\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 saturate(vec3 x) {\n\treturn clamp(x, vec3(0.0), vec3(1.0));\n}\n",baseVS:"\nattribute vec3 vertex_position;\nattribute vec3 vertex_normal;\nattribute vec4 vertex_tangent;\nattribute vec2 vertex_texCoord0;\nattribute vec2 vertex_texCoord1;\nattribute vec4 vertex_color;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nvec3 dPositionW;\nmat4 dModelMatrix;\nmat3 dNormalMatrix;\n",baseNineSlicedPS:"\n#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",baseNineSlicedVS:"\n#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\n",baseNineSlicedTiledPS:"\n#define NINESLICED\n#define NINESLICETILED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",bayerPS:"\nfloat bayer2(vec2 p) {\n\treturn mod(2.0 * p.y + p.x + 1.0, 4.0);\n}\nfloat bayer4(vec2 p) {\n\tvec2 p1 = mod(p, 2.0);\n\tvec2 p2 = floor(0.5 * mod(p, 4.0));\n\treturn 4.0 * bayer2(p1) + bayer2(p2);\n}\nfloat bayer8(vec2 p) {\n\tvec2 p1 = mod(p, 2.0);\n\tvec2 p2 = floor(0.5 * mod(p, 4.0));\n\tvec2 p4 = floor(0.25 * mod(p, 8.0));\n\treturn 4.0 * (4.0 * bayer2(p1) + bayer2(p2)) + bayer2(p4);\n}\n",biasConstPS:"\n#define SHADOWBIAS\n#define SHADOW_SAMPLE_Z_BIAS\nfloat getShadowBias(float resolution, float maxBias) {\n\treturn maxBias;\n}\n",blurVSMPS:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\n#ifdef GAUSS\nuniform float weight[SAMPLES];\n#endif\n#ifdef PACKED\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nvec2 encodeFloatRG( float v ) {\n\tvec2 enc = vec2(1.0, 255.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n\treturn enc;\n}\n#endif\nvoid main(void) {\n\tvec3 moments = vec3(0.0);\n\tvec2 uv = vUv0 - pixelOffset * (float(SAMPLES) * 0.5);\n\tfor (int i=0; i<SAMPLES; i++) {\n\t\tvec4 c = texture2D(source, uv + pixelOffset * float(i));\n\t\t#ifdef PACKED\n\t\tc.xy = vec2(decodeFloatRG(c.xy), decodeFloatRG(c.zw));\n\t\t#endif\n\t\t#ifdef GAUSS\n\t\tmoments += c.xyz * weight[i];\n\t\t#else\n\t\tmoments += c.xyz;\n\t\t#endif\n\t}\n\t#ifndef GAUSS\n\tmoments /= float(SAMPLES);\n\t#endif\n\t#ifdef PACKED\n\tgl_FragColor = vec4(encodeFloatRG(moments.x), encodeFloatRG(moments.y));\n\t#else\n\tgl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);\n\t#endif\n}\n",clearCoatPS:"\n#ifdef MAPFLOAT\nuniform float material_clearCoat;\n#endif\nvoid getClearCoat() {\n\tccSpecularity = 1.0;\n\t#ifdef MAPFLOAT\n\tccSpecularity *= material_clearCoat;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tccSpecularity *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tccSpecularity *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",clearCoatGlossPS:"\n#ifdef MAPFLOAT\nuniform float material_clearCoatGloss;\n#endif\nvoid getClearCoatGlossiness() {\n\tccGlossiness = 1.0;\n\t#ifdef MAPFLOAT\n\tccGlossiness *= material_clearCoatGloss;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tccGlossiness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tccGlossiness *= saturate(vVertexColor.$VC);\n\t#endif\n\t#ifdef MAPINVERT\n\tccGlossiness = 1.0 - ccGlossiness;\n\t#endif\n\tccGlossiness += 0.0000001;\n}\n",clearCoatNormalPS:"\n#ifdef MAPTEXTURE\nuniform float material_clearCoatBumpiness;\n#endif\nvoid getClearCoatNormal() {\n#ifdef MAPTEXTURE\n\tvec3 normalMap = unpackNormal(texture2DBias($SAMPLER, $UV, textureBias));\n\tnormalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_clearCoatBumpiness);\n\tccNormalW = normalize(dTBN * normalMap);\n#else\n\tccNormalW = dVertexNormalW;\n#endif\n}\n",clusteredLightCookiesPS:"\nvec3 _getCookieClustered(TEXTURE_ACCEPT(tex), vec2 uv, float intensity, bool isRgb, vec4 cookieChannel) {\n\tvec4 pixel = mix(vec4(1.0), texture2DLodEXT(tex, uv, 0.0), intensity);\n\treturn isRgb == true ? pixel.rgb : vec3(dot(pixel, cookieChannel));\n}\nvec3 getCookie2DClustered(TEXTURE_ACCEPT(tex), mat4 transform, vec3 worldPosition, float intensity, bool isRgb, vec4 cookieChannel) {\n\tvec4 projPos = transform * vec4(worldPosition, 1.0);\n\treturn _getCookieClustered(TEXTURE_PASS(tex), projPos.xy / projPos.w, intensity, isRgb, cookieChannel);\n}\nvec3 getCookieCubeClustered(TEXTURE_ACCEPT(tex), vec3 dir, float intensity, bool isRgb, vec4 cookieChannel, float shadowTextureResolution, float shadowEdgePixels, vec3 omniAtlasViewport) {\n\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\treturn _getCookieClustered(TEXTURE_PASS(tex), uv, intensity, isRgb, cookieChannel);\n}\n",clusteredLightShadowsPS:"\nvoid _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tprojPos.xyz /= projPos.w;\n\tdShadowCoord = projPos.xyz;\n}\nvoid getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams, vec3 normal) {\n\tvec3 wPos = vPositionW + normal * shadowParams.y;\n\t_getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);\n}\nvec3 normalOffsetPointShadow(vec4 shadowParams, vec3 lightPos, inout vec3 lightDir, vec3 lightDirNorm, vec3 normal) {\n\tfloat distScale = length(lightDir);\n\tvec3 wPos = vPositionW + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n\tvec3 dir = wPos - lightPos;\n\treturn dir;\n}\n#ifdef GL2\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\tfloat getShadowOmniClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n\t\tfloat shadowTextureResolution = shadowParams.x;\n\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\t\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\t\treturn textureShadow(shadowMap, vec3(uv, shadowZ));\n\t}\n\t#endif\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF3)\n\tfloat getShadowOmniClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n\t\tfloat shadowTextureResolution = shadowParams.x;\n\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\t\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\t\tvec3 shadowCoord = vec3(uv, shadowZ);\n\t\treturn getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n\t}\n\t#endif\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF5)\n\tfloat getShadowOmniClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n\t\tfloat shadowTextureResolution = shadowParams.x;\n\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\t\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\t\tvec3 shadowCoord = vec3(uv, shadowZ);\n\t\treturn getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n\t}\n\t#endif\n#else\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\tfloat getShadowOmniClusteredPCF1(sampler2D shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n\t\tfloat shadowTextureResolution = shadowParams.x;\n\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\t\tfloat depth = unpackFloat(textureShadow(shadowMap, uv));\n\t\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\t\treturn depth > shadowZ ? 1.0 : 0.0;\n\t}\n\t#endif\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF3)\n\tfloat getShadowOmniClusteredPCF3(sampler2D shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n\t\tfloat shadowTextureResolution = shadowParams.x;\n\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\t\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\t\tvec3 shadowCoord = vec3(uv, shadowZ);\n\t\treturn getShadowPCF3x3(shadowMap, shadowCoord, shadowParams);\n\t}\n\t#endif\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF5)\n\tfloat getShadowOmniClusteredPCF5(sampler2D shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n\t\tfloat shadowTextureResolution = shadowParams.x;\n\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\t\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\t\tvec3 shadowCoord = vec3(uv, shadowZ);\n\t\treturn getShadowPCF3x3(shadowMap, shadowCoord, shadowParams);\n\t}\n\t#endif\n#endif\n#ifdef GL2\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\tfloat getShadowSpotClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\t\treturn textureShadow(shadowMap, shadowCoord);\n\t}\n\t#endif\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF3)\n\tfloat getShadowSpotClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\t\treturn getShadowSpotPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n\t}\n\t#endif\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF5)\n\tfloat getShadowSpotClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\t\treturn getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n\t}\n\t#endif\n#else\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\tfloat getShadowSpotClusteredPCF1(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams) {\n\t\tfloat depth = unpackFloat(textureShadow(shadowMap, shadowCoord.xy));\n\t\treturn depth > shadowCoord.z ? 1.0 : 0.0;\n\t}\n\t#endif\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF3)\n\tfloat getShadowSpotClusteredPCF3(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams) {\n\t\treturn getShadowSpotPCF3x3(shadowMap, shadowCoord, shadowParams);\n\t}\n\t#endif\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF5)\n\tfloat getShadowSpotClusteredPCF5(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams) {\n\t\treturn getShadowSpotPCF3x3(shadowMap, shadowCoord, shadowParams);\n\t}\n\t#endif\n#endif\n",clusteredLightUtilsPS:"\nvec2 getCubemapFaceCoordinates(const vec3 dir, out float faceIndex, out vec2 tileOffset)\n{\n\tvec3 vAbs = abs(dir);\n\tfloat ma;\n\tvec2 uv;\n\tif (vAbs.z >= vAbs.x && vAbs.z >= vAbs.y) {\n\t\tfaceIndex = dir.z < 0.0 ? 5.0 : 4.0;\n\t\tma = 0.5 / vAbs.z;\n\t\tuv = vec2(dir.z < 0.0 ? -dir.x : dir.x, -dir.y);\n\t\ttileOffset.x = 2.0;\n\t\ttileOffset.y = dir.z < 0.0 ? 1.0 : 0.0;\n\t} else if(vAbs.y >= vAbs.x) {\n\t\tfaceIndex = dir.y < 0.0 ? 3.0 : 2.0;\n\t\tma = 0.5 / vAbs.y;\n\t\tuv = vec2(dir.x, dir.y < 0.0 ? -dir.z : dir.z);\n\t\ttileOffset.x = 1.0;\n\t\ttileOffset.y = dir.y < 0.0 ? 1.0 : 0.0;\n\t} else {\n\t\tfaceIndex = dir.x < 0.0 ? 1.0 : 0.0;\n\t\tma = 0.5 / vAbs.x;\n\t\tuv = vec2(dir.x < 0.0 ? dir.z : -dir.z, -dir.y);\n\t\ttileOffset.x = 0.0;\n\t\ttileOffset.y = dir.x < 0.0 ? 1.0 : 0.0;\n\t}\n\treturn uv * ma + 0.5;\n}\nvec2 getCubemapAtlasCoordinates(const vec3 omniAtlasViewport, float shadowEdgePixels, float shadowTextureResolution, const vec3 dir) {\n\tfloat faceIndex;\n\tvec2 tileOffset;\n\tvec2 uv = getCubemapFaceCoordinates(dir, faceIndex, tileOffset);\n\tfloat atlasFaceSize = omniAtlasViewport.z;\n\tfloat tileSize = shadowTextureResolution * atlasFaceSize;\n\tfloat offset = shadowEdgePixels / tileSize;\n\tuv = uv * vec2(1.0 - offset * 2.0) + vec2(offset * 1.0);\n\tuv *= atlasFaceSize;\n\tuv += tileOffset * atlasFaceSize;\n\tuv += omniAtlasViewport.xy;\n\treturn uv;\n}\n",clusteredLightPS:"\nuniform highp sampler2D clusterWorldTexture;\nuniform highp sampler2D lightsTexture8;\nuniform highp sampler2D lightsTextureFloat;\n#if defined(CLUSTER_COOKIES)\n\t#define CLUSTER_COOKIES_OR_SHADOWS\n#endif\n#if defined(CLUSTER_SHADOWS)\n\t#define CLUSTER_COOKIES_OR_SHADOWS\n#endif\n#ifdef CLUSTER_SHADOWS\n\t#ifdef GL2\n\t\tuniform sampler2DShadow shadowAtlasTexture;\n\t#else\n\t\tuniform sampler2D shadowAtlasTexture;\n\t#endif\n#endif\n#ifdef CLUSTER_COOKIES\n\tuniform sampler2D cookieAtlasTexture;\n#endif\n#ifdef GL2\n\tuniform int clusterMaxCells;\n#else\n\tuniform float clusterMaxCells;\n\tuniform vec4 lightsTextureInvSize;\n#endif\nuniform float clusterSkip;\nuniform vec3 clusterCellsCountByBoundsSize;\nuniform vec3 clusterTextureSize;\nuniform vec3 clusterBoundsMin;\nuniform vec3 clusterBoundsDelta;\nuniform vec3 clusterCellsDot;\nuniform vec3 clusterCellsMax;\nuniform vec2 clusterCompressionLimit0;\nuniform vec2 shadowAtlasParams;\nstruct ClusterLightData {\n\tvec3 halfWidth;\n\tfloat lightType;\n\tvec3 halfHeight;\n\t#ifdef GL2\n\t\tint lightIndex;\n\t#else\n\t\tfloat lightV;\n\t#endif\n\tvec3 position;\n\tfloat shape;\n\tvec3 direction;\n\tfloat falloffMode;\n\tvec3 color;\n\tfloat shadowIntensity;\n\tvec3 omniAtlasViewport;\n\tfloat range;\n\tvec4 cookieChannelMask;\n\tfloat shadowBias;\n\tfloat shadowNormalBias;\n\tfloat innerConeAngleCos;\n\tfloat outerConeAngleCos;\n\tfloat cookie;\n\tfloat cookieRgb;\n\tfloat cookieIntensity;\n\tfloat mask;\n};\nmat4 lightProjectionMatrix;\n#define isClusteredLightCastShadow(light) ( light.shadowIntensity > 0.0 )\n#define isClusteredLightCookie(light) (light.cookie > 0.5 )\n#define isClusteredLightCookieRgb(light) (light.cookieRgb > 0.5 )\n#define isClusteredLightSpot(light) ( light.lightType > 0.5 )\n#define isClusteredLightFalloffLinear(light) ( light.falloffMode < 0.5 )\n#define isClusteredLightArea(light) ( light.shape > 0.1 )\n#define isClusteredLightRect(light) ( light.shape < 0.3 )\n#define isClusteredLightDisk(light) ( light.shape < 0.6 )\n#ifdef CLUSTER_MESH_DYNAMIC_LIGHTS\n\t#define acceptLightMask(light) ( light.mask < 0.75)\n#else\n\t#define acceptLightMask(light) ( light.mask > 0.25)\n#endif\nvec4 decodeClusterLowRange4Vec4(vec4 d0, vec4 d1, vec4 d2, vec4 d3) {\n\treturn vec4(\n\t\tbytes2floatRange4(d0, -2.0, 2.0),\n\t\tbytes2floatRange4(d1, -2.0, 2.0),\n\t\tbytes2floatRange4(d2, -2.0, 2.0),\n\t\tbytes2floatRange4(d3, -2.0, 2.0)\n\t);\n}\n#ifdef GL2\n\tvec4 sampleLightsTexture8(const ClusterLightData clusterLightData, int index) {\n\t\treturn texelFetch(lightsTexture8, ivec2(index, clusterLightData.lightIndex), 0);\n\t}\n\tvec4 sampleLightTextureF(const ClusterLightData clusterLightData, int index) {\n\t\treturn texelFetch(lightsTextureFloat, ivec2(index, clusterLightData.lightIndex), 0);\n\t}\n#else\n\tvec4 sampleLightsTexture8(const ClusterLightData clusterLightData, float index) {\n\t\treturn texture2DLodEXT(lightsTexture8, vec2(index * lightsTextureInvSize.z, clusterLightData.lightV), 0.0);\n\t}\n\tvec4 sampleLightTextureF(const ClusterLightData clusterLightData, float index) {\n\t\treturn texture2DLodEXT(lightsTextureFloat, vec2(index * lightsTextureInvSize.x, clusterLightData.lightV), 0.0);\n\t}\n#endif\nvoid decodeClusterLightCore(inout ClusterLightData clusterLightData, float lightIndex) {\n\t#ifdef GL2\n\t\tclusterLightData.lightIndex = int(lightIndex);\n\t#else\n\t\tclusterLightData.lightV = (lightIndex + 0.5) * lightsTextureInvSize.w;\n\t#endif\n\tvec4 lightInfo = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_FLAGS);\n\tclusterLightData.lightType = lightInfo.x;\n\tclusterLightData.shape = lightInfo.y;\n\tclusterLightData.falloffMode = lightInfo.z;\n\tclusterLightData.shadowIntensity = lightInfo.w;\n\tvec4 colorA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COLOR_A);\n\tvec4 colorB = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COLOR_B);\n\tclusterLightData.color = vec3(bytes2float2(colorA.xy), bytes2float2(colorA.zw), bytes2float2(colorB.xy)) * clusterCompressionLimit0.y;\n\tclusterLightData.cookie = colorB.z;\n\tclusterLightData.mask = colorB.w;\n\t#ifdef CLUSTER_TEXTURE_FLOAT\n\t\tvec4 lightPosRange = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_POSITION_RANGE);\n\t\tclusterLightData.position = lightPosRange.xyz;\n\t\tclusterLightData.range = lightPosRange.w;\n\t\tvec4 lightDir_Unused = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_SPOT_DIRECTION);\n\t\tclusterLightData.direction = lightDir_Unused.xyz;\n\t#else\n\t\tvec4 encPosX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_POSITION_X);\n\t\tvec4 encPosY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_POSITION_Y);\n\t\tvec4 encPosZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_POSITION_Z);\n\t\tclusterLightData.position = vec3(bytes2float4(encPosX), bytes2float4(encPosY), bytes2float4(encPosZ)) * clusterBoundsDelta + clusterBoundsMin;\n\t\tvec4 encRange = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_RANGE);\n\t\tclusterLightData.range = bytes2float4(encRange) * clusterCompressionLimit0.x;\n\t\tvec4 encDirX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_DIRECTION_X);\n\t\tvec4 encDirY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_DIRECTION_Y);\n\t\tvec4 encDirZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_DIRECTION_Z);\n\t\tclusterLightData.direction = vec3(bytes2float4(encDirX), bytes2float4(encDirY), bytes2float4(encDirZ)) * 2.0 - 1.0;\n\t#endif\n}\nvoid decodeClusterLightSpot(inout ClusterLightData clusterLightData) {\n\tvec4 coneAngle = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_ANGLES);\n\tclusterLightData.innerConeAngleCos = bytes2float2(coneAngle.xy) * 2.0 - 1.0;\n\tclusterLightData.outerConeAngleCos = bytes2float2(coneAngle.zw) * 2.0 - 1.0;\n}\nvoid decodeClusterLightOmniAtlasViewport(inout ClusterLightData clusterLightData) {\n\t#ifdef CLUSTER_TEXTURE_FLOAT\n\t\tclusterLightData.omniAtlasViewport = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_0).xyz;\n\t#else\n\t\tvec4 viewportA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_ATLAS_VIEWPORT_A);\n\t\tvec4 viewportB = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_ATLAS_VIEWPORT_B);\n\t\tclusterLightData.omniAtlasViewport = vec3(bytes2float2(viewportA.xy), bytes2float2(viewportA.zw), bytes2float2(viewportB.xy));\n\t#endif\n}\nvoid decodeClusterLightAreaData(inout ClusterLightData clusterLightData) {\n\t#ifdef CLUSTER_TEXTURE_FLOAT\n\t\tclusterLightData.halfWidth = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_AREA_DATA_WIDTH).xyz;\n\t\tclusterLightData.halfHeight = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_AREA_DATA_HEIGHT).xyz;\n\t#else\n\t\tvec4 areaWidthX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_WIDTH_X);\n\t\tvec4 areaWidthY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_WIDTH_Y);\n\t\tvec4 areaWidthZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_WIDTH_Z);\n\t\tclusterLightData.halfWidth = vec3(mantissaExponent2Float(areaWidthX), mantissaExponent2Float(areaWidthY), mantissaExponent2Float(areaWidthZ));\n\t\tvec4 areaHeightX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_HEIGHT_X);\n\t\tvec4 areaHeightY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_HEIGHT_Y);\n\t\tvec4 areaHeightZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_HEIGHT_Z);\n\t\tclusterLightData.halfHeight = vec3(mantissaExponent2Float(areaHeightX), mantissaExponent2Float(areaHeightY), mantissaExponent2Float(areaHeightZ));\n\t#endif\n}\nvoid decodeClusterLightProjectionMatrixData(inout ClusterLightData clusterLightData) {\n\t\n\t#ifdef CLUSTER_TEXTURE_FLOAT\n\t\tvec4 m0 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_0);\n\t\tvec4 m1 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_1);\n\t\tvec4 m2 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_2);\n\t\tvec4 m3 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_3);\n\t#else\n\t\tvec4 m00 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_00);\n\t\tvec4 m01 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_01);\n\t\tvec4 m02 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_02);\n\t\tvec4 m03 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_03);\n\t\tvec4 m0 = decodeClusterLowRange4Vec4(m00, m01, m02, m03);\n\t\tvec4 m10 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_10);\n\t\tvec4 m11 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_11);\n\t\tvec4 m12 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_12);\n\t\tvec4 m13 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_13);\n\t\tvec4 m1 = decodeClusterLowRange4Vec4(m10, m11, m12, m13);\n\t\tvec4 m20 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_20);\n\t\tvec4 m21 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_21);\n\t\tvec4 m22 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_22);\n\t\tvec4 m23 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_23);\n\t\tvec4 m2 = decodeClusterLowRange4Vec4(m20, m21, m22, m23);\n\t\tvec4 m30 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_30);\n\t\tvec4 m31 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_31);\n\t\tvec4 m32 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_32);\n\t\tvec4 m33 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_33);\n\t\tvec4 m3 = vec4(mantissaExponent2Float(m30), mantissaExponent2Float(m31), mantissaExponent2Float(m32), mantissaExponent2Float(m33));\n\t#endif\n\t\n\tlightProjectionMatrix = mat4(m0, m1, m2, m3);\n}\nvoid decodeClusterLightShadowData(inout ClusterLightData clusterLightData) {\n\t\n\tvec4 biases = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SHADOW_BIAS);\n\tclusterLightData.shadowBias = bytes2floatRange2(biases.xy, -1.0, 20.0),\n\tclusterLightData.shadowNormalBias = bytes2float2(biases.zw);\n}\nvoid decodeClusterLightCookieData(inout ClusterLightData clusterLightData) {\n\tvec4 cookieA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COOKIE_A);\n\tclusterLightData.cookieIntensity = cookieA.x;\n\tclusterLightData.cookieRgb = cookieA.y;\n\tclusterLightData.cookieChannelMask = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COOKIE_B);\n}\nvoid evaluateLight(\n\tClusterLightData light, \n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tvec3 reflectionDir,\n#if defined(LIT_CLEARCOAT)\n\tvec3 clearcoatReflectionDir,\n#endif\n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 geometricNormal, \n\tmat3 tbn, \n#if defined(LIT_IRIDESCENCE)\n\tvec3 iridescenceFresnel,\n#endif\n\tvec3 clearcoat_worldNormal,\n\tfloat clearcoat_gloss,\n\tfloat sheen_gloss,\n\tfloat iridescence_intensity\n) {\n\tvec3 cookieAttenuation = vec3(1.0);\n\tfloat diffuseAttenuation = 1.0;\n\tfloat falloffAttenuation = 1.0;\n\tgetLightDirPoint(light.position);\n\t#ifdef CLUSTER_AREALIGHTS\n\tif (isClusteredLightArea(light)) {\n\t\tdecodeClusterLightAreaData(light);\n\t\tif (isClusteredLightRect(light)) {\n\t\t\tcalcRectLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t} else if (isClusteredLightDisk(light)) {\n\t\t\tcalcDiskLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t} else {\n\t\t\tcalcSphereLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t}\n\t\tfalloffAttenuation = getFalloffWindow(light.range, dLightDirW);\n\t} else\n\t#endif\n\t{\n\t\tif (isClusteredLightFalloffLinear(light))\n\t\t\tfalloffAttenuation = getFalloffLinear(light.range, dLightDirW);\n\t\telse\n\t\t\tfalloffAttenuation = getFalloffInvSquared(light.range, dLightDirW);\n\t}\n\tif (falloffAttenuation > 0.00001) {\n\t\t#ifdef CLUSTER_AREALIGHTS\n\t\tif (isClusteredLightArea(light)) {\n\t\t\tif (isClusteredLightRect(light)) {\n\t\t\t\tdiffuseAttenuation = getRectLightDiffuse(worldNormal, viewDir, dLightDirW, dLightDirNormW) * 16.0;\n\t\t\t} else if (isClusteredLightDisk(light)) {\n\t\t\t\tdiffuseAttenuation = getDiskLightDiffuse(worldNormal, viewDir, dLightDirW, dLightDirNormW) * 16.0;\n\t\t\t} else {\n\t\t\t\tdiffuseAttenuation = getSphereLightDiffuse(worldNormal, viewDir, dLightDirW, dLightDirNormW) * 16.0;\n\t\t\t}\n\t\t} else\n\t\t#endif\n\t\t{\n\t\t\tfalloffAttenuation *= getLightDiffuse(worldNormal, viewDir, dLightDirW, dLightDirNormW); \n\t\t}\n\t\tif (isClusteredLightSpot(light)) {\n\t\t\tdecodeClusterLightSpot(light);\n\t\t\tfalloffAttenuation *= getSpotEffect(light.direction, light.innerConeAngleCos, light.outerConeAngleCos, dLightDirNormW);\n\t\t}\n\t\t#if defined(CLUSTER_COOKIES_OR_SHADOWS)\n\t\tif (falloffAttenuation > 0.00001) {\n\t\t\tif (isClusteredLightCastShadow(light) || isClusteredLightCookie(light)) {\n\t\t\t\tif (isClusteredLightSpot(light)) {\n\t\t\t\t\tdecodeClusterLightProjectionMatrixData(light);\n\t\t\t\t} else {\n\t\t\t\t\tdecodeClusterLightOmniAtlasViewport(light);\n\t\t\t\t}\n\t\t\t\tfloat shadowTextureResolution = shadowAtlasParams.x;\n\t\t\t\tfloat shadowEdgePixels = shadowAtlasParams.y;\n\t\t\t\t#ifdef CLUSTER_COOKIES\n\t\t\t\tif (isClusteredLightCookie(light)) {\n\t\t\t\t\tdecodeClusterLightCookieData(light);\n\t\t\t\t\tif (isClusteredLightSpot(light)) {\n\t\t\t\t\t\tcookieAttenuation = getCookie2DClustered(TEXTURE_PASS(cookieAtlasTexture), lightProjectionMatrix, vPositionW, light.cookieIntensity, isClusteredLightCookieRgb(light), light.cookieChannelMask);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tcookieAttenuation = getCookieCubeClustered(TEXTURE_PASS(cookieAtlasTexture), dLightDirW, light.cookieIntensity, isClusteredLightCookieRgb(light), light.cookieChannelMask, shadowTextureResolution, shadowEdgePixels, light.omniAtlasViewport);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t\t#ifdef CLUSTER_SHADOWS\n\t\t\t\tif (isClusteredLightCastShadow(light)) {\n\t\t\t\t\tdecodeClusterLightShadowData(light);\n\t\t\t\t\tvec4 shadowParams = vec4(shadowTextureResolution, light.shadowNormalBias, light.shadowBias, 1.0 / light.range);\n\t\t\t\t\tif (isClusteredLightSpot(light)) {\n\t\t\t\t\t\tgetShadowCoordPerspZbufferNormalOffset(lightProjectionMatrix, shadowParams, geometricNormal);\n\t\t\t\t\t\t\n\t\t\t\t\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\t\t\t\t\t\t\tfloat shadow = getShadowSpotClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), dShadowCoord, shadowParams);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n\t\t\t\t\t\t\tfloat shadow = getShadowSpotClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), dShadowCoord, shadowParams);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n\t\t\t\t\t\t\tfloat shadow = getShadowSpotClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), dShadowCoord, shadowParams);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCSS)\n\t\t\t\t\t\t\tfloat shadow = getShadowSpotClusteredPCSS(SHADOWMAP_PASS(shadowAtlasTexture), dShadowCoord, shadowParams);\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\tfalloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tvec3 dir = normalOffsetPointShadow(shadowParams, dLightPosW, dLightDirW, dLightDirNormW, geometricNormal);\n\t\t\t\t\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\t\t\t\t\t\t\tfloat shadow = getShadowOmniClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n\t\t\t\t\t\t\tfloat shadow = getShadowOmniClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n\t\t\t\t\t\t\tfloat shadow = getShadowOmniClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\tfalloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t}\n\t\t}\n\t\t#endif\n\t\t#ifdef CLUSTER_AREALIGHTS\n\t\tif (isClusteredLightArea(light)) {\n\t\t\t{\n\t\t\t\tvec3 areaDiffuse = (diffuseAttenuation * falloffAttenuation) * light.color * cookieAttenuation;\n\t\t\t\t#if defined(LIT_SPECULAR)\n\t\t\t\t\t#if defined(LIT_CONSERVE_ENERGY)\n\t\t\t\t\t\tareaDiffuse = mix(areaDiffuse, vec3(0), dLTCSpecFres);\n\t\t\t\t\t#endif\n\t\t\t\t#endif\n\t\t\t\tdDiffuseLight += areaDiffuse;\n\t\t\t}\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tfloat areaLightSpecular;\n\t\t\t\tif (isClusteredLightRect(light)) {\n\t\t\t\t\tareaLightSpecular = getRectLightSpecular(worldNormal, viewDir);\n\t\t\t\t} else if (isClusteredLightDisk(light)) {\n\t\t\t\t\tareaLightSpecular = getDiskLightSpecular(worldNormal, viewDir);\n\t\t\t\t} else {\n\t\t\t\t\tareaLightSpecular = getSphereLightSpecular(worldNormal, viewDir);\n\t\t\t\t}\n\t\t\t\tdSpecularLight += dLTCSpecFres * areaLightSpecular * falloffAttenuation * light.color * cookieAttenuation;\n\t\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\t\tfloat areaLightSpecularCC;\n\t\t\t\t\tif (isClusteredLightRect(light)) {\n\t\t\t\t\t\tareaLightSpecularCC = getRectLightSpecular(clearcoat_worldNormal, viewDir);\n\t\t\t\t\t} else if (isClusteredLightDisk(light)) {\n\t\t\t\t\t\tareaLightSpecularCC = getDiskLightSpecular(clearcoat_worldNormal, viewDir);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tareaLightSpecularCC = getSphereLightSpecular(clearcoat_worldNormal, viewDir);\n\t\t\t\t\t}\n\t\t\t\t\tccSpecularLight += ccLTCSpecFres * areaLightSpecularCC * falloffAttenuation * light.color  * cookieAttenuation;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t} else\n\t\t#endif\n\t\t{\n\t\t\t{\n\t\t\t\tvec3 punctualDiffuse = falloffAttenuation * light.color * cookieAttenuation;\n\t\t\t\t#if defined(CLUSTER_AREALIGHTS)\n\t\t\t\t#if defined(LIT_SPECULAR)\n\t\t\t\t#if defined(LIT_CONSERVE_ENERGY)\n\t\t\t\t\tpunctualDiffuse = mix(punctualDiffuse, vec3(0), specularity);\n\t\t\t\t#endif\n\t\t\t\t#endif\n\t\t\t\t#endif\n\t\t\t\tdDiffuseLight += punctualDiffuse;\n\t\t\t}\n\t \n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tvec3 halfDir = normalize(-dLightDirNormW + viewDir);\n\t\t\t\t\n\t\t\t\t#ifdef LIT_SPECULAR_FRESNEL\n\t\t\t\t\tdSpecularLight += \n\t\t\t\t\t\tgetLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dLightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * \n\t\t\t\t\t\tgetFresnel(\n\t\t\t\t\t\t\tdot(viewDir, halfDir), \n\t\t\t\t\t\t\tgloss, \n\t\t\t\t\t\t\tspecularity\n\t\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t\t, iridescenceFresnel,\n\t\t\t\t\t\t\tiridescence_intensity\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t);\n\t\t\t\t#else\n\t\t\t\t\tdSpecularLight += getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dLightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * specularity;\n\t\t\t\t#endif\n\t\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\t\t#ifdef LIT_SPECULAR_FRESNEL\n\t\t\t\t\t\tccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, dLightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * getFresnelCC(dot(viewDir, halfDir));\n\t\t\t\t\t#else\n\t\t\t\t\t\tccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, dLightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation; \n\t\t\t\t\t#endif\n\t\t\t\t#endif\n\t\t\t\t#ifdef LIT_SHEEN\n\t\t\t\t\tsSpecularLight += getLightSpecularSheen(halfDir, worldNormal, viewDir, dLightDirNormW, sheen_gloss) * falloffAttenuation * light.color * cookieAttenuation;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t}\n\t}\n\tdAtten = falloffAttenuation;\n\tdAttenD = diffuseAttenuation;\n\tdAtten3 = cookieAttenuation;\n}\nvoid evaluateClusterLight(\n\tfloat lightIndex, \n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tvec3 reflectionDir, \n#if defined(LIT_CLEARCOAT)\n\tvec3 clearcoatReflectionDir,\n#endif\n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 geometricNormal, \n\tmat3 tbn, \n#if defined(LIT_IRIDESCENCE)\n\tvec3 iridescenceFresnel,\n#endif\n\tvec3 clearcoat_worldNormal,\n\tfloat clearcoat_gloss,\n\tfloat sheen_gloss,\n\tfloat iridescence_intensity\n) {\n\tClusterLightData clusterLightData;\n\tdecodeClusterLightCore(clusterLightData, lightIndex);\n\tif (acceptLightMask(clusterLightData))\n\t\tevaluateLight(\n\t\t\tclusterLightData, \n\t\t\tworldNormal, \n\t\t\tviewDir, \n\t\t\treflectionDir, \n#if defined(LIT_CLEARCOAT)\n\t\t\tclearcoatReflectionDir, \n#endif\n\t\t\tgloss, \n\t\t\tspecularity, \n\t\t\tgeometricNormal, \n\t\t\ttbn, \n#if defined(LIT_IRIDESCENCE)\n\t\t\tiridescenceFresnel,\n#endif\n\t\t\tclearcoat_worldNormal,\n\t\t\tclearcoat_gloss,\n\t\t\tsheen_gloss,\n\t\t\tiridescence_intensity\n\t\t);\n}\nvoid addClusteredLights(\n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tvec3 reflectionDir, \n#if defined(LIT_CLEARCOAT)\n\tvec3 clearcoatReflectionDir,\n#endif\n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 geometricNormal, \n\tmat3 tbn, \n#if defined(LIT_IRIDESCENCE)\n\tvec3 iridescenceFresnel,\n#endif\n\tvec3 clearcoat_worldNormal,\n\tfloat clearcoat_gloss,\n\tfloat sheen_gloss,\n\tfloat iridescence_intensity\n) {\n\tif (clusterSkip > 0.5)\n\t\treturn;\n\tvec3 cellCoords = floor((vPositionW - clusterBoundsMin) * clusterCellsCountByBoundsSize);\n\tif (!(any(lessThan(cellCoords, vec3(0.0))) || any(greaterThanEqual(cellCoords, clusterCellsMax)))) {\n\t\tfloat cellIndex = dot(clusterCellsDot, cellCoords);\n\t\tfloat clusterV = floor(cellIndex * clusterTextureSize.y);\n\t\tfloat clusterU = cellIndex - (clusterV * clusterTextureSize.x);\n\t\t#ifdef GL2\n\t\t\tfor (int lightCellIndex = 0; lightCellIndex < clusterMaxCells; lightCellIndex++) {\n\t\t\t\tfloat lightIndex = texelFetch(clusterWorldTexture, ivec2(int(clusterU) + lightCellIndex, clusterV), 0).x;\n\t\t\t\tif (lightIndex <= 0.0)\n\t\t\t\t\t\treturn;\n\t\t\t\tevaluateClusterLight(\n\t\t\t\t\tlightIndex * 255.0, \n\t\t\t\t\tworldNormal, \n\t\t\t\t\tviewDir, \n\t\t\t\t\treflectionDir,\n#if defined(LIT_CLEARCOAT)\n\t\t\t\t\tclearcoatReflectionDir,\n#endif\n\t\t\t\t\tgloss, \n\t\t\t\t\tspecularity, \n\t\t\t\t\tgeometricNormal, \n\t\t\t\t\ttbn, \n#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\tiridescenceFresnel,\n#endif\n\t\t\t\t\tclearcoat_worldNormal,\n\t\t\t\t\tclearcoat_gloss,\n\t\t\t\t\tsheen_gloss,\n\t\t\t\t\tiridescence_intensity\n\t\t\t\t); \n\t\t\t}\n\t\t#else\n\t\t\tclusterV = (clusterV + 0.5) * clusterTextureSize.z;\n\t\t\tconst float maxLightCells = 256.0;\n\t\t\tfor (float lightCellIndex = 0.5; lightCellIndex < maxLightCells; lightCellIndex++) {\n\t\t\t\tfloat lightIndex = texture2DLodEXT(clusterWorldTexture, vec2(clusterTextureSize.y * (clusterU + lightCellIndex), clusterV), 0.0).x;\n\t\t\t\tif (lightIndex <= 0.0)\n\t\t\t\t\treturn;\n\t\t\t\t\n\t\t\t\tevaluateClusterLight(\n\t\t\t\t\tlightIndex * 255.0, \n\t\t\t\t\tworldNormal, \n\t\t\t\t\tviewDir, \n\t\t\t\t\treflectionDir,\n#if defined(LIT_CLEARCOAT)\n\t\t\t\t\tclearcoatReflectionDir,\n#endif\n\t\t\t\t\tgloss, \n\t\t\t\t\tspecularity, \n\t\t\t\t\tgeometricNormal, \n\t\t\t\t\ttbn, \n#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\tiridescenceFresnel,\n#endif\n\t\t\t\t\tclearcoat_worldNormal,\n\t\t\t\t\tclearcoat_gloss,\n\t\t\t\t\tsheen_gloss,\n\t\t\t\t\tiridescence_intensity\n\t\t\t\t); \n\t\t\t\tif (lightCellIndex >= clusterMaxCells) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t#endif\n\t}\n}\n",combinePS:"\nvec3 combineColor(vec3 albedo, vec3 sheenSpecularity, float clearcoatSpecularity) {\n\tvec3 ret = vec3(0);\n#ifdef LIT_OLD_AMBIENT\n\tret += (dDiffuseLight - light_globalAmbient) * albedo + material_ambient * light_globalAmbient;\n#else\n\tret += albedo * dDiffuseLight;\n#endif\n#ifdef LIT_SPECULAR\n\tret += dSpecularLight;\n#endif\n#ifdef LIT_REFLECTIONS\n\tret += dReflection.rgb * dReflection.a;\n#endif\n#ifdef LIT_SHEEN\n\tfloat sheenScaling = 1.0 - max(max(sheenSpecularity.r, sheenSpecularity.g), sheenSpecularity.b) * 0.157;\n\tret = ret * sheenScaling + (sSpecularLight + sReflection.rgb) * sheenSpecularity;\n#endif\n#ifdef LIT_CLEARCOAT\n\tfloat clearCoatScaling = 1.0 - ccFresnel * clearcoatSpecularity;\n\tret = ret * clearCoatScaling + (ccSpecularLight + ccReflection.rgb) * clearcoatSpecularity;\n#endif\n\treturn ret;\n}\n",cookiePS:"\nvec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {\n\treturn mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);\n}\n",cubeMapProjectBoxPS:"\nuniform vec3 envBoxMin;\nuniform vec3 envBoxMax;\nvec3 cubeMapProject(vec3 nrdir) {\n\tnrdir = cubeMapRotate(nrdir);\n\tvec3 rbmax = (envBoxMax - vPositionW) / nrdir;\n\tvec3 rbmin = (envBoxMin - vPositionW) / nrdir;\n\tvec3 rbminmax;\n\trbminmax.x = nrdir.x>0.0? rbmax.x : rbmin.x;\n\trbminmax.y = nrdir.y>0.0? rbmax.y : rbmin.y;\n\trbminmax.z = nrdir.z>0.0? rbmax.z : rbmin.z;\n\tfloat fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n\tvec3 posonbox = vPositionW + nrdir * fa;\n\tvec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;\n\treturn normalize(posonbox - envBoxPos);\n}\n",cubeMapProjectNonePS:"\nvec3 cubeMapProject(vec3 dir) {\n\treturn cubeMapRotate(dir);\n}\n",cubeMapRotatePS:"\n#ifdef CUBEMAP_ROTATION\nuniform mat3 cubeMapRotationMatrix;\n#endif\nvec3 cubeMapRotate(vec3 refDir) {\n#ifdef CUBEMAP_ROTATION\n\treturn refDir * cubeMapRotationMatrix;\n#else\n\treturn refDir;\n#endif\n}\n",debugOutputPS:"\n#ifdef DEBUG_ALBEDO_PASS\ngl_FragColor = vec4(gammaCorrectOutput(litArgs_albedo), 1.0);\n#endif\n#ifdef DEBUG_UV0_PASS\ngl_FragColor = vec4(litArgs_albedo , 1.0);\n#endif\n#ifdef DEBUG_WORLD_NORMAL_PASS\ngl_FragColor = vec4(litArgs_worldNormal * 0.5 + 0.5, 1.0);\n#endif\n#ifdef DEBUG_OPACITY_PASS\ngl_FragColor = vec4(vec3(litArgs_opacity) , 1.0);\n#endif\n#ifdef DEBUG_SPECULARITY_PASS\ngl_FragColor = vec4(litArgs_specularity, 1.0);\n#endif\n#ifdef DEBUG_GLOSS_PASS\ngl_FragColor = vec4(vec3(litArgs_gloss) , 1.0);\n#endif\n#ifdef DEBUG_METALNESS_PASS\ngl_FragColor = vec4(vec3(litArgs_metalness) , 1.0);\n#endif\n#ifdef DEBUG_AO_PASS\ngl_FragColor = vec4(vec3(litArgs_ao) , 1.0);\n#endif\n#ifdef DEBUG_EMISSION_PASS\ngl_FragColor = vec4(gammaCorrectOutput(litArgs_emission), 1.0);\n#endif\n",debugProcessFrontendPS:"\n#ifdef DEBUG_LIGHTING_PASS\nlitArgs_albedo = vec3(0.5);\n#endif\n#ifdef DEBUG_UV0_PASS\n#ifdef VARYING_VUV0\nlitArgs_albedo = vec3(vUv0, 0);\n#else\nlitArgs_albedo = vec3(0);\n#endif\n#endif\n",detailModesPS:"\nvec3 detailMode_mul(vec3 c1, vec3 c2) {\n\treturn c1 * c2;\n}\nvec3 detailMode_add(vec3 c1, vec3 c2) {\n\treturn c1 + c2;\n}\nvec3 detailMode_screen(vec3 c1, vec3 c2) {\n\treturn 1.0 - (1.0 - c1)*(1.0 - c2);\n}\nvec3 detailMode_overlay(vec3 c1, vec3 c2) {\n\treturn mix(1.0 - 2.0*(1.0 - c1)*(1.0 - c2), 2.0*c1*c2, step(c1, vec3(0.5)));\n}\nvec3 detailMode_min(vec3 c1, vec3 c2) {\n\treturn min(c1, c2);\n}\nvec3 detailMode_max(vec3 c1, vec3 c2) {\n\treturn max(c1, c2);\n}\n",diffusePS:"\n#ifdef MAPCOLOR\nuniform vec3 material_diffuse;\n#endif\nvoid getAlbedo() {\n\tdAlbedo = vec3(1.0);\n#ifdef MAPCOLOR\n\tdAlbedo *= material_diffuse.rgb;\n#endif\n#ifdef MAPTEXTURE\n\tvec3 albedoBase = $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;\n\tdAlbedo *= addAlbedoDetail(albedoBase);\n#endif\n#ifdef MAPVERTEX\n\tdAlbedo *= gammaCorrectInput(saturate(vVertexColor.$VC));\n#endif\n}\n",diffuseDetailMapPS:"\nvec3 addAlbedoDetail(vec3 albedo) {\n#ifdef MAPTEXTURE\n\tvec3 albedoDetail = $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;\n\treturn detailMode_$DETAILMODE(albedo, albedoDetail);\n#else\n\treturn albedo;\n#endif\n}\n",decodePS:J_,emissivePS:"\n#ifdef MAPCOLOR\nuniform vec3 material_emissive;\n#endif\n#ifdef MAPFLOAT\nuniform float material_emissiveIntensity;\n#endif\nvoid getEmission() {\n\tdEmission = vec3(1.0);\n\t#ifdef MAPFLOAT\n\tdEmission *= material_emissiveIntensity;\n\t#endif\n\t#ifdef MAPCOLOR\n\tdEmission *= material_emissive;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdEmission *= $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdEmission *= gammaCorrectInput(saturate(vVertexColor.$VC));\n\t#endif\n}\n",encodePS:ef,endPS:"\n\tgl_FragColor.rgb = combineColor(litArgs_albedo, litArgs_sheen_specularity, litArgs_clearcoat_specularity);\n\tgl_FragColor.rgb += litArgs_emission;\n\tgl_FragColor.rgb = addFog(gl_FragColor.rgb);\n\t#ifndef HDR\n\tgl_FragColor.rgb = toneMap(gl_FragColor.rgb);\n\tgl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n\t#endif\n",endVS:"\n",envAtlasPS:"\nconst float atlasSize = 512.0;\nconst float seamSize = 1.0 / atlasSize;\nvec2 mapUv(vec2 uv, vec4 rect) {\n\treturn vec2(mix(rect.x + seamSize, rect.x + rect.z - seamSize, uv.x),\n\t\t\t\tmix(rect.y + seamSize, rect.y + rect.w - seamSize, uv.y));\n}\nvec2 mapRoughnessUv(vec2 uv, float level) {\n\tfloat t = 1.0 / exp2(level);\n\treturn mapUv(uv, vec4(0, 1.0 - t, t, t * 0.5));\n}\nvec2 mapShinyUv(vec2 uv, float level) {\n\tfloat t = 1.0 / exp2(level);\n\treturn mapUv(uv, vec4(1.0 - t, 1.0 - t, t, t * 0.5));\n}\n",envConstPS:"\nvec3 processEnvironment(vec3 color) {\n\treturn color;\n}\n",envMultiplyPS:"\nuniform float skyboxIntensity;\nvec3 processEnvironment(vec3 color) {\n\treturn color * skyboxIntensity;\n}\n",extensionPS:"\n",extensionVS:"\n",falloffInvSquaredPS:"\nfloat getFalloffWindow(float lightRadius, vec3 lightDir) {\n\tfloat sqrDist = dot(lightDir, lightDir);\n\tfloat invRadius = 1.0 / lightRadius;\n\treturn square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n}\nfloat getFalloffInvSquared(float lightRadius, vec3 lightDir) {\n\tfloat sqrDist = dot(lightDir, lightDir);\n\tfloat falloff = 1.0 / (sqrDist + 1.0);\n\tfloat invRadius = 1.0 / lightRadius;\n\tfalloff *= 16.0;\n\tfalloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n\treturn falloff;\n}\n",falloffLinearPS:"\nfloat getFalloffLinear(float lightRadius, vec3 lightDir) {\n\tfloat d = length(lightDir);\n\treturn max(((lightRadius - d) / lightRadius), 0.0);\n}\n",fixCubemapSeamsNonePS:"\nvec3 fixSeams(vec3 vec, float mipmapIndex) {\n\treturn vec;\n}\nvec3 fixSeams(vec3 vec) {\n\treturn vec;\n}\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n\treturn vec;\n}\nvec3 calcSeam(vec3 vec) {\n\treturn vec3(0);\n}\nvec3 applySeam(vec3 vec, vec3 seam, float scale) {\n\treturn vec;\n}\n",fixCubemapSeamsStretchPS:"\nvec3 fixSeams(vec3 vec, float mipmapIndex) {\n\tvec3 avec = abs(vec);\n\tfloat scale = 1.0 - exp2(mipmapIndex) / 128.0;\n\tfloat M = max(max(avec.x, avec.y), avec.z);\n\tif (avec.x != M) vec.x *= scale;\n\tif (avec.y != M) vec.y *= scale;\n\tif (avec.z != M) vec.z *= scale;\n\treturn vec;\n}\nvec3 fixSeams(vec3 vec) {\n\tvec3 avec = abs(vec);\n\tfloat scale = 1.0 - 1.0 / 128.0;\n\tfloat M = max(max(avec.x, avec.y), avec.z);\n\tif (avec.x != M) vec.x *= scale;\n\tif (avec.y != M) vec.y *= scale;\n\tif (avec.z != M) vec.z *= scale;\n\treturn vec;\n}\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n\tvec3 avec = abs(vec);\n\tfloat scale = invRecMipSize;\n\tfloat M = max(max(avec.x, avec.y), avec.z);\n\tif (avec.x != M) vec.x *= scale;\n\tif (avec.y != M) vec.y *= scale;\n\tif (avec.z != M) vec.z *= scale;\n\treturn vec;\n}\nvec3 calcSeam(vec3 vec) {\n\tvec3 avec = abs(vec);\n\tfloat M = max(avec.x, max(avec.y, avec.z));\n\treturn vec3(avec.x != M ? 1.0 : 0.0,\n\t\t\t\tavec.y != M ? 1.0 : 0.0,\n\t\t\t\tavec.z != M ? 1.0 : 0.0);\n}\nvec3 applySeam(vec3 vec, vec3 seam, float scale) {\n\treturn vec * (seam * -scale + vec3(1.0));\n}\n",floatUnpackingPS:"\nfloat bytes2float2(vec2 data) {\n\treturn dot(data, vec2(1.0, 1.0 / 255.0));\n}\nfloat bytes2float3(vec3 data) {\n\treturn dot(data, vec3(1.0, 1.0 / 255.0, 1.0 / 65025.0));\n}\nfloat bytes2float4(vec4 data) {\n\treturn dot(data, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\nfloat bytes2floatRange2(vec2 data, float min, float max) {\n\treturn mix(min, max, bytes2float2(data));\n}\nfloat bytes2floatRange3(vec3 data, float min, float max) {\n\treturn mix(min, max, bytes2float3(data));\n}\nfloat bytes2floatRange4(vec4 data, float min, float max) {\n\treturn mix(min, max, bytes2float4(data));\n}\nfloat mantissaExponent2Float(vec4 pack)\n{\n\tfloat value = bytes2floatRange3(pack.xyz, -1.0, 1.0);\n\tfloat exponent = floor(pack.w * 255.0 - 127.0);\n\treturn value * exp2(exponent);\n}\n",fogExpPS:"\nuniform vec3 fog_color;\nuniform float fog_density;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = exp(-depth * fog_density);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogExp2PS:"\nuniform vec3 fog_color;\nuniform float fog_density;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = exp(-depth * depth * fog_density * fog_density);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogLinearPS:"\nuniform vec3 fog_color;\nuniform float fog_start;\nuniform float fog_end;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = (fog_end - depth) / (fog_end - fog_start);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogNonePS:"\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\treturn color;\n}\n",fresnelSchlickPS:"\nvec3 getFresnel(\n\t\tfloat cosTheta, \n\t\tfloat gloss, \n\t\tvec3 specularity\n#if defined(LIT_IRIDESCENCE)\n\t\t, vec3 iridescenceFresnel, \n\t\tfloat iridescenceIntensity\n#endif\n\t) {\n\tfloat fresnel = pow(1.0 - max(cosTheta, 0.0), 5.0);\n\tfloat glossSq = gloss * gloss;\n\tvec3 ret = specularity + (max(vec3(glossSq), specularity) - specularity) * fresnel;\n#if defined(LIT_IRIDESCENCE)\n\treturn mix(ret, iridescenceFresnel, iridescenceIntensity);\n#else\n\treturn ret;\n#endif\t\n}\nfloat getFresnelCC(float cosTheta) {\n\tfloat fresnel = pow(1.0 - max(cosTheta, 0.0), 5.0);\n\treturn 0.04 + (1.0 - 0.04) * fresnel;\n}\n",fullscreenQuadPS:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\tgl_FragColor = texture2D(source, vUv0);\n}\n",fullscreenQuadVS:"\nattribute vec2 vertex_position;\nvarying vec2 vUv0;\nvoid main(void)\n{\n\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\tvUv0 = vertex_position.xy*0.5+0.5;\n}\n",gamma1_0PS:"\nfloat gammaCorrectInput(float color) {\n\treturn color;\n}\nvec3 gammaCorrectInput(vec3 color) {\n\treturn color;\n}\nvec4 gammaCorrectInput(vec4 color) {\n\treturn color;\n}\nvec3 gammaCorrectOutput(vec3 color) {\n\treturn color;\n}\n",gamma2_2PS:"\nfloat gammaCorrectInput(float color) {\n\treturn decodeGamma(color);\n}\nvec3 gammaCorrectInput(vec3 color) {\n\treturn decodeGamma(color);\n}\nvec4 gammaCorrectInput(vec4 color) {\n\treturn vec4(decodeGamma(color.xyz), color.w);\n}\nvec3 gammaCorrectOutput(vec3 color) {\n#ifdef HDR\n\treturn color;\n#else\n\treturn pow(color + 0.0000001, vec3(1.0 / 2.2));\n#endif\n}\n",gles2PS:xm,gles3PS:wm,gles3VS:Sm,glossPS:"\n#ifdef MAPFLOAT\nuniform float material_gloss;\n#endif\nvoid getGlossiness() {\n\tdGlossiness = 1.0;\n\t#ifdef MAPFLOAT\n\tdGlossiness *= material_gloss;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdGlossiness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdGlossiness *= saturate(vVertexColor.$VC);\n\t#endif\n\t#ifdef MAPINVERT\n\tdGlossiness = 1.0 - dGlossiness;\n\t#endif\n\tdGlossiness += 0.0000001;\n}\n",iridescenceDiffractionPS:"\nuniform float material_iridescenceRefractionIndex;\n#ifndef PI\n#define PI 3.14159265\n#endif\nfloat iridescence_iorToFresnel(float transmittedIor, float incidentIor) {\n\treturn pow((transmittedIor - incidentIor) / (transmittedIor + incidentIor), 2.0);\n}\nvec3 iridescence_iorToFresnel(vec3 transmittedIor, float incidentIor) {\n\treturn pow((transmittedIor - vec3(incidentIor)) / (transmittedIor + vec3(incidentIor)), vec3(2.0));\n}\nvec3 iridescence_fresnelToIor(vec3 f0) {\n\tvec3 sqrtF0 = sqrt(f0);\n\treturn (vec3(1.0) + sqrtF0) / (vec3(1.0) - sqrtF0);\n}\nvec3 iridescence_sensitivity(float opd, vec3 shift) {\n\tfloat phase = 2.0 * PI * opd * 1.0e-9;\n\tconst vec3 val = vec3(5.4856e-13, 4.4201e-13, 5.2481e-13);\n\tconst vec3 pos = vec3(1.6810e+06, 1.7953e+06, 2.2084e+06);\n\tconst vec3 var = vec3(4.3278e+09, 9.3046e+09, 6.6121e+09);\n\tvec3 xyz = val * sqrt(2.0 * PI * var) * cos(pos * phase + shift) * exp(-pow(phase, 2.0) * var);\n\txyz.x += 9.7470e-14 * sqrt(2.0 * PI * 4.5282e+09) * cos(2.2399e+06 * phase + shift[0]) * exp(-4.5282e+09 * pow(phase, 2.0));\n\txyz /= vec3(1.0685e-07);\n\tconst mat3 XYZ_TO_REC709 = mat3(\n\t\t3.2404542, -0.9692660,  0.0556434,\n\t   -1.5371385,  1.8760108, -0.2040259,\n\t   -0.4985314,  0.0415560,  1.0572252\n\t);\n\treturn XYZ_TO_REC709 * xyz;\n}\nfloat iridescence_fresnel(float cosTheta, float f0) {\n\tfloat x = clamp(1.0 - cosTheta, 0.0, 1.0);\n\tfloat x2 = x * x;\n\tfloat x5 = x * x2 * x2;\n\treturn f0 + (1.0 - f0) * x5;\n} \nvec3 iridescence_fresnel(float cosTheta, vec3 f0) {\n\tfloat x = clamp(1.0 - cosTheta, 0.0, 1.0);\n\tfloat x2 = x * x;\n\tfloat x5 = x * x2 * x2; \n\treturn f0 + (vec3(1.0) - f0) * x5;\n}\nvec3 calcIridescence(float outsideIor, float cosTheta, vec3 base_f0, float iridescenceThickness) {\n\tfloat iridescenceIor = mix(outsideIor, material_iridescenceRefractionIndex, smoothstep(0.0, 0.03, iridescenceThickness));\n\tfloat sinTheta2Sq = pow(outsideIor / iridescenceIor, 2.0) * (1.0 - pow(cosTheta, 2.0));\n\tfloat cosTheta2Sq = 1.0 - sinTheta2Sq;\n\tif (cosTheta2Sq < 0.0) {\n\t\treturn vec3(1.0);\n\t}\n\tfloat cosTheta2 = sqrt(cosTheta2Sq);\n\tfloat r0 = iridescence_iorToFresnel(iridescenceIor, outsideIor);\n\tfloat r12 = iridescence_fresnel(cosTheta, r0);\n\tfloat r21 = r12;\n\tfloat t121 = 1.0 - r12;\n\tfloat phi12 = iridescenceIor < outsideIor ? PI : 0.0;\n\tfloat phi21 = PI - phi12;\n\tvec3 baseIor = iridescence_fresnelToIor(base_f0 + vec3(0.0001));\n\tvec3 r1 = iridescence_iorToFresnel(baseIor, iridescenceIor);\n\tvec3 r23 = iridescence_fresnel(cosTheta2, r1);\n\tvec3 phi23 = vec3(0.0);\n\tif (baseIor[0] < iridescenceIor) phi23[0] = PI;\n\tif (baseIor[1] < iridescenceIor) phi23[1] = PI;\n\tif (baseIor[2] < iridescenceIor) phi23[2] = PI;\n\tfloat opd = 2.0 * iridescenceIor * iridescenceThickness * cosTheta2;\n\tvec3 phi = vec3(phi21) + phi23; \n\tvec3 r123Sq = clamp(r12 * r23, 1e-5, 0.9999);\n\tvec3 r123 = sqrt(r123Sq);\n\tvec3 rs = pow(t121, 2.0) * r23 / (1.0 - r123Sq);\n\tvec3 c0 = r12 + rs;\n\tvec3 i = c0;\n\tvec3 cm = rs - t121;\n\tfor (int m = 1; m <= 2; m++) {\n\t\tcm *= r123;\n\t\tvec3 sm = 2.0 * iridescence_sensitivity(float(m) * opd, float(m) * phi);\n\t\ti += cm * sm;\n\t}\n\treturn max(i, vec3(0.0));\n}\nvec3 getIridescence(float cosTheta, vec3 specularity, float iridescenceThickness) {\n\treturn calcIridescence(1.0, cosTheta, specularity, iridescenceThickness);\n}\n",iridescencePS:"\n#ifdef MAPFLOAT\nuniform float material_iridescence;\n#endif\nvoid getIridescence() {\n\tfloat iridescence = 1.0;\n\t#ifdef MAPFLOAT\n\tiridescence *= material_iridescence;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tiridescence *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\tdIridescence = iridescence; \n}\n",iridescenceThicknessPS:"\nuniform float material_iridescenceThicknessMax;\n#ifdef MAPTEXTURE\nuniform float material_iridescenceThicknessMin;\n#endif\nvoid getIridescenceThickness() {\n\t#ifdef MAPTEXTURE\n\tfloat blend = texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\tfloat iridescenceThickness = mix(material_iridescenceThicknessMin, material_iridescenceThicknessMax, blend);\n\t#else\n\tfloat iridescenceThickness = material_iridescenceThicknessMax;\n\t#endif\n\tdIridescenceThickness = iridescenceThickness; \n}\n",instancingVS:"\nattribute vec4 instance_line1;\nattribute vec4 instance_line2;\nattribute vec4 instance_line3;\nattribute vec4 instance_line4;\n",iorPS:"\n#ifdef MAPFLOAT\nuniform float material_refractionIndex;\n#endif\nvoid getIor() {\n#ifdef MAPFLOAT\n\tdIor = material_refractionIndex;\n#else\n\tdIor = 1.0 / 1.5;\n#endif\n}\n",lightDiffuseLambertPS:"\nfloat getLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n\treturn max(dot(worldNormal, -lightDirNorm), 0.0);\n}\n",lightDirPointPS:"\nvoid getLightDirPoint(vec3 lightPosW) {\n\tdLightDirW = vPositionW - lightPosW;\n\tdLightDirNormW = normalize(dLightDirW);\n\tdLightPosW = lightPosW;\n}\n",lightmapAddPS:"\nvoid addLightMap(\n\tvec3 lightmap, \n\tvec3 dir, \n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tvec3 reflectionDir, \n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 vertexNormal, \n\tmat3 tbn\n#if defined(LIT_IRIDESCENCE)\n\tvec3 iridescenceFresnel, \n\tfloat iridescenceIntensity\n#endif\n) {\n\tdDiffuseLight += lightmap;\n}\n",lightmapDirAddPS:"\nvoid addLightMap(\n\tvec3 lightmap, \n\tvec3 dir, \n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tvec3 reflectionDir, \n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 vertexNormal, \n\tmat3 tbn\n#if defined(LIT_IRIDESCENCE)\n\tvec3 iridescenceFresnel, \n\tfloat iridescenceIntensity\n#endif\n) {\n\tif (dot(dir, dir) < 0.0001) {\n\t\tdDiffuseLight += lightmap;\n\t} else {\n\t\tfloat vlight = saturate(dot(dir, -vertexNormal));\n\t\tfloat flight = saturate(dot(dir, -worldNormal));\n\t\tfloat nlight = (flight / max(vlight, 0.01)) * 0.5;\n\t\tdDiffuseLight += lightmap * nlight * 2.0;\n\t\tvec3 halfDir = normalize(-dir + viewDir);\n\t\tvec3 specularLight = lightmap * getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dir, gloss, tbn);\n#ifdef LIT_SPECULAR_FRESNEL\n\t\tspecularLight *= \n\t\t\tgetFresnel(dot(viewDir, halfDir), \n\t\t\tgloss, \n\t\t\tspecularity\n\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t, iridescenceFresnel,\n\t\t\tiridescenceIntensity\n\t\t#endif\n\t\t\t);\n#endif\n\t\tdSpecularLight += specularLight;\n\t}\n}\n",lightmapDirPS:"\nuniform sampler2D texture_lightMap;\nuniform sampler2D texture_dirLightMap;\nvoid getLightMap() {\n\tdLightmap = $DECODE(texture2DBias(texture_lightMap, $UV, textureBias)).$CH;\n\tvec3 dir = texture2DBias(texture_dirLightMap, $UV, textureBias).xyz * 2.0 - 1.0;\n\tfloat dirDot = dot(dir, dir);\n\tdLightmapDir = (dirDot > 0.001) ? dir / sqrt(dirDot) : vec3(0.0);\n}\n",lightmapSinglePS:"\nvoid getLightMap() {\n\tdLightmap = vec3(1.0);\n\t#ifdef MAPTEXTURE\n\tdLightmap *= $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdLightmap *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",lightSpecularAnisoGGXPS:"\nfloat calcLightSpecular(float gloss, vec3 worldNormal, vec3 viewDir, vec3 h, vec3 lightDirNorm, mat3 tbn) {\n\tfloat PI = 3.141592653589793;\n\tfloat roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);\n\tfloat anisotropy = material_anisotropy * roughness;\n \n\tfloat at = max((roughness + anisotropy), roughness / 4.0);\n\tfloat ab = max((roughness - anisotropy), roughness / 4.0);\n\tfloat NoH = dot(worldNormal, h);\n\tfloat ToH = dot(tbn[0], h);\n\tfloat BoH = dot(tbn[1], h);\n\tfloat a2 = at * ab;\n\tvec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);\n\tfloat v2 = dot(v, v);\n\tfloat w2 = a2 / v2;\n\tfloat D = a2 * w2 * w2 * (1.0 / PI);\n\tfloat ToV = dot(tbn[0], viewDir);\n\tfloat BoV = dot(tbn[1], viewDir);\n\tfloat ToL = dot(tbn[0], -lightDirNorm);\n\tfloat BoL = dot(tbn[1], -lightDirNorm);\n\tfloat NoV = dot(worldNormal, viewDir);\n\tfloat NoL = dot(worldNormal, -lightDirNorm);\n\tfloat lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));\n\tfloat lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));\n\tfloat G = 0.5 / (lambdaV + lambdaL);\n\treturn D * G;\n}\nfloat getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {\n\treturn calcLightSpecular(gloss, worldNormal, viewDir, h, lightDirNorm, tbn);\n}\n",lightSpecularBlinnPS:"\nfloat calcLightSpecular(float gloss, vec3 worldNormal, vec3 h) {\n\tfloat nh = max( dot( h, worldNormal ), 0.0 );\n\tfloat specPow = exp2(gloss * 11.0);\n\tspecPow = max(specPow, 0.0001);\n\treturn pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\nfloat getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {\n\treturn calcLightSpecular(gloss, worldNormal, h);\n}\n",lightSpecularPhongPS:"\nfloat calcLightSpecular(float gloss, vec3 reflDir, vec3 lightDirNorm) {\n\tfloat specPow = gloss;\n\treturn pow(max(dot(reflDir, -lightDirNorm), 0.0), specPow + 0.0001);\n}\nfloat getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {\n\treturn calcLightSpecular(gloss, reflDir, lightDirNorm);\n}\n",lightSheenPS:"\nfloat sheenD(vec3 normal, vec3 h, float roughness) {\n\tfloat invR = 1.0 / (roughness * roughness);\n\tfloat cos2h = max(dot(normal, h), 0.0);\n\tcos2h *= cos2h;\n\tfloat sin2h = max(1.0 - cos2h, 0.0078125);\n\treturn (2.0 + invR) * pow(sin2h, invR * 0.5) / (2.0 * PI);\n}\nfloat sheenV(vec3 normal, vec3 viewDir, vec3 light) {\n\tfloat NoV = max(dot(normal, viewDir), 0.000001);\n\tfloat NoL = max(dot(normal, light), 0.000001);\n\treturn 1.0 / (4.0 * (NoL + NoV - NoL * NoV));\n}\nfloat getLightSpecularSheen(vec3 h, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float sheenGloss) {\n\tfloat D = sheenD(worldNormal, h, sheenGloss);\n\tfloat V = sheenV(worldNormal, viewDir, -lightDirNorm);\n\treturn D * V;\n}\n",linearizeDepthPS:"\n#ifndef LINEARIZE_DEPTH\n#define LINEARIZE_DEPTH\nfloat linearizeDepth(float z, vec4 cameraParams) {\n\tif (cameraParams.w == 0.0)\n\t\treturn (cameraParams.z * cameraParams.y) / (cameraParams.y + z * (cameraParams.z - cameraParams.y));\n\telse\n\t\treturn cameraParams.z + z * (cameraParams.y - cameraParams.z);\n}\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\n#ifdef GL2\nfloat linearizeDepth(float z) {\n\treturn linearizeDepth(z, camera_params);\n}\n#else\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\treturn dot(rgbaDepth, bitShift);\n}\n#endif\n#endif\n#endif\n",litShaderArgsPS:"\nvec3 litArgs_albedo;\nfloat litArgs_opacity;\nvec3 litArgs_emission;\nvec3 litArgs_worldNormal;\nfloat litArgs_ao;\nvec3 litArgs_lightmap;\nvec3 litArgs_lightmapDir;\nfloat litArgs_metalness;\nvec3 litArgs_specularity;\nfloat litArgs_specularityFactor;\nfloat litArgs_gloss;\nfloat litArgs_sheen_gloss;\nvec3 litArgs_sheen_specularity;\nfloat litArgs_transmission;\nfloat litArgs_thickness;\nfloat litArgs_ior;\nfloat litArgs_iridescence_intensity;\nfloat litArgs_iridescence_thickness;\nvec3 litArgs_clearcoat_worldNormal;\nfloat litArgs_clearcoat_specularity;\nfloat litArgs_clearcoat_gloss;\n",ltcPS:"\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nstruct Coords {\n\tvec3 coord0;\n\tvec3 coord1;\n\tvec3 coord2;\n\tvec3 coord3;\n};\nfloat LTC_EvaluateRect( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in Coords rectCoords) {\n\tvec3 v1 = rectCoords.coord1 - rectCoords.coord0;\n\tvec3 v2 = rectCoords.coord3 - rectCoords.coord0;\n\t\n\tvec3 lightNormal = cross( v1, v2 );\n\tfloat factor = sign(-dot( lightNormal, P - rectCoords.coord0 ));\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 =  factor * cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords.coord0 - P );\n\tcoords[ 1 ] = mat * ( rectCoords.coord1 - P );\n\tcoords[ 2 ] = mat * ( rectCoords.coord2 - P );\n\tcoords[ 3 ] = mat * ( rectCoords.coord3 - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn result;\n}\nCoords dLTCCoords;\nCoords getLTCLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\tCoords coords;\n\tcoords.coord0 = lightPos + halfWidth - halfHeight;\n\tcoords.coord1 = lightPos - halfWidth - halfHeight;\n\tcoords.coord2 = lightPos - halfWidth + halfHeight;\n\tcoords.coord3 = lightPos + halfWidth + halfHeight;\n\treturn coords;\n}\nfloat dSphereRadius;\nCoords getSphereLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\tdSphereRadius = max(length(halfWidth), length(halfHeight));\n\tvec3 f = reflect(normalize(lightPos - view_position), vNormalW);\n\tvec3 w = normalize(cross(f, halfHeight));\n\tvec3 h = normalize(cross(f, w));\n\treturn getLTCLightCoords(lightPos, w * dSphereRadius, h * dSphereRadius);\n}\nvec2 dLTCUV;\n#ifdef LIT_CLEARCOAT\nvec2 ccLTCUV;\n#endif\nvec2 getLTCLightUV(float gloss, vec3 worldNormal, vec3 viewDir)\n{\n\tfloat roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);\n\treturn LTC_Uv( worldNormal, viewDir, roughness );\n}\nvec3 dLTCSpecFres;\n#ifdef LIT_CLEARCOAT\nvec3 ccLTCSpecFres;\n#endif\nvec3 getLTCLightSpecFres(vec2 uv, vec3 specularity)\n{\n\tvec4 t2 = texture2DLodEXT(areaLightsLutTex2, uv, 0.0);\n\t#ifdef AREA_R8_G8_B8_A8_LUTS\n\tt2 *= vec4(0.693103,1,1,1);\n\tt2 += vec4(0.306897,0,0,0);\n\t#endif\n\treturn specularity * t2.x + ( vec3( 1.0 ) - specularity) * t2.y;\n}\nvoid calcLTCLightValues(float gloss, vec3 worldNormal, vec3 viewDir, vec3 specularity, float clearcoatGloss, vec3 clearcoatWorldNormal, float clearcoatSpecularity)\n{\n\tdLTCUV = getLTCLightUV(gloss, worldNormal, viewDir);\n\tdLTCSpecFres = getLTCLightSpecFres(dLTCUV, specularity); \n#ifdef LIT_CLEARCOAT\n\tccLTCUV = getLTCLightUV(clearcoatGloss, clearcoatWorldNormal, viewDir);\n\tccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, vec3(clearcoatSpecularity));\n#endif\n}\nvoid calcRectLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tdLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);\n}\nvoid calcDiskLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tcalcRectLightValues(lightPos, halfWidth, halfHeight);\n}\nvoid calcSphereLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tdLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);\n}\nvec3 SolveCubic(vec4 Coefficient)\n{\n\tfloat pi = 3.14159;\n\tCoefficient.xyz /= Coefficient.w;\n\tCoefficient.yz /= 3.0;\n\tfloat A = Coefficient.w;\n\tfloat B = Coefficient.z;\n\tfloat C = Coefficient.y;\n\tfloat D = Coefficient.x;\n\tvec3 Delta = vec3(\n\t\t-Coefficient.z * Coefficient.z + Coefficient.y,\n\t\t-Coefficient.y * Coefficient.z + Coefficient.x,\n\t\tdot(vec2(Coefficient.z, -Coefficient.y), Coefficient.xy)\n\t);\n\tfloat Discriminant = dot(vec2(4.0 * Delta.x, -Delta.y), Delta.zy);\n\tvec3 RootsA, RootsD;\n\tvec2 xlc, xsc;\n\t{\n\t\tfloat A_a = 1.0;\n\t\tfloat C_a = Delta.x;\n\t\tfloat D_a = -2.0 * B * Delta.x + Delta.y;\n\t\tfloat Theta = atan(sqrt(Discriminant), -D_a) / 3.0;\n\t\tfloat x_1a = 2.0 * sqrt(-C_a) * cos(Theta);\n\t\tfloat x_3a = 2.0 * sqrt(-C_a) * cos(Theta + (2.0 / 3.0) * pi);\n\t\tfloat xl;\n\t\tif ((x_1a + x_3a) > 2.0 * B)\n\t\t\txl = x_1a;\n\t\telse\n\t\t\txl = x_3a;\n\t\txlc = vec2(xl - B, A);\n\t}\n\t{\n\t\tfloat A_d = D;\n\t\tfloat C_d = Delta.z;\n\t\tfloat D_d = -D * Delta.y + 2.0 * C * Delta.z;\n\t\tfloat Theta = atan(D * sqrt(Discriminant), -D_d) / 3.0;\n\t\tfloat x_1d = 2.0 * sqrt(-C_d) * cos(Theta);\n\t\tfloat x_3d = 2.0 * sqrt(-C_d) * cos(Theta + (2.0 / 3.0) * pi);\n\t\tfloat xs;\n\t\tif (x_1d + x_3d < 2.0 * C)\n\t\t\txs = x_1d;\n\t\telse\n\t\t\txs = x_3d;\n\t\txsc = vec2(-D, xs + C);\n\t}\n\tfloat E =  xlc.y * xsc.y;\n\tfloat F = -xlc.x * xsc.y - xlc.y * xsc.x;\n\tfloat G =  xlc.x * xsc.x;\n\tvec2 xmc = vec2(C * F - B * G, -B * F + C * E);\n\tvec3 Root = vec3(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);\n\tif (Root.x < Root.y && Root.x < Root.z)\n\t\tRoot.xyz = Root.yxz;\n\telse if (Root.z < Root.x && Root.z < Root.y)\n\t\tRoot.xyz = Root.xzy;\n\treturn Root;\n}\nfloat LTC_EvaluateDisk(vec3 N, vec3 V, vec3 P, mat3 Minv, Coords points)\n{\n\tvec3 T1, T2;\n\tT1 = normalize(V - N * dot(V, N));\n\tT2 = cross(N, T1);\n\tmat3 R = transposeMat3( mat3( T1, T2, N ) );\n\tvec3 L_[ 3 ];\n\tL_[ 0 ] = R * ( points.coord0 - P );\n\tL_[ 1 ] = R * ( points.coord1 - P );\n\tL_[ 2 ] = R * ( points.coord2 - P );\n\tvec3 Lo_i = vec3(0);\n\tvec3 C  = 0.5 * (L_[0] + L_[2]);\n\tvec3 V1 = 0.5 * (L_[1] - L_[2]);\n\tvec3 V2 = 0.5 * (L_[1] - L_[0]);\n\tC  = Minv * C;\n\tV1 = Minv * V1;\n\tV2 = Minv * V2;\n\tfloat a, b;\n\tfloat d11 = dot(V1, V1);\n\tfloat d22 = dot(V2, V2);\n\tfloat d12 = dot(V1, V2);\n\tif (abs(d12) / sqrt(d11 * d22) > 0.0001)\n\t{\n\t\tfloat tr = d11 + d22;\n\t\tfloat det = -d12 * d12 + d11 * d22;\n\t\tdet = sqrt(det);\n\t\tfloat u = 0.5 * sqrt(tr - 2.0 * det);\n\t\tfloat v = 0.5 * sqrt(tr + 2.0 * det);\n\t\tfloat e_max = (u + v) * (u + v);\n\t\tfloat e_min = (u - v) * (u - v);\n\t\tvec3 V1_, V2_;\n\t\tif (d11 > d22)\n\t\t{\n\t\t\tV1_ = d12 * V1 + (e_max - d11) * V2;\n\t\t\tV2_ = d12 * V1 + (e_min - d11) * V2;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tV1_ = d12*V2 + (e_max - d22)*V1;\n\t\t\tV2_ = d12*V2 + (e_min - d22)*V1;\n\t\t}\n\t\ta = 1.0 / e_max;\n\t\tb = 1.0 / e_min;\n\t\tV1 = normalize(V1_);\n\t\tV2 = normalize(V2_);\n\t}\n\telse\n\t{\n\t\ta = 1.0 / dot(V1, V1);\n\t\tb = 1.0 / dot(V2, V2);\n\t\tV1 *= sqrt(a);\n\t\tV2 *= sqrt(b);\n\t}\n\tvec3 V3 = cross(V1, V2);\n\tif (dot(C, V3) < 0.0)\n\t\tV3 *= -1.0;\n\tfloat L  = dot(V3, C);\n\tfloat x0 = dot(V1, C) / L;\n\tfloat y0 = dot(V2, C) / L;\n\tfloat E1 = inversesqrt(a);\n\tfloat E2 = inversesqrt(b);\n\ta *= L * L;\n\tb *= L * L;\n\tfloat c0 = a * b;\n\tfloat c1 = a * b * (1.0 + x0 * x0 + y0 * y0) - a - b;\n\tfloat c2 = 1.0 - a * (1.0 + x0 * x0) - b * (1.0 + y0 * y0);\n\tfloat c3 = 1.0;\n\tvec3 roots = SolveCubic(vec4(c0, c1, c2, c3));\n\tfloat e1 = roots.x;\n\tfloat e2 = roots.y;\n\tfloat e3 = roots.z;\n\tvec3 avgDir = vec3(a * x0 / (a - e2), b * y0 / (b - e2), 1.0);\n\tmat3 rotate = mat3(V1, V2, V3);\n\tavgDir = rotate * avgDir;\n\tavgDir = normalize(avgDir);\n\tfloat L1 = sqrt(-e2 / e3);\n\tfloat L2 = sqrt(-e2 / e1);\n\tfloat formFactor = L1 * L2 * inversesqrt((1.0 + L1 * L1) * (1.0 + L2 * L2));\n\t\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tvec2 uv = vec2(avgDir.z * 0.5 + 0.5, formFactor);\n\tuv = uv*LUT_SCALE + LUT_BIAS;\n\tfloat scale = texture2DLodEXT(areaLightsLutTex2, uv, 0.0).w;\n\treturn formFactor*scale;\n}\nfloat getRectLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n\treturn LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\nfloat getDiskLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n\treturn LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\nfloat getSphereLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n\tfloat falloff = dSphereRadius / (dot(lightDir, lightDir) + dSphereRadius);\n\treturn getLightDiffuse(worldNormal, viewDir, lightDir, lightDirNorm) * falloff;\n}\nmat3 getLTCLightInvMat(vec2 uv)\n{\n\tvec4 t1 = texture2DLodEXT(areaLightsLutTex1, uv, 0.0);\n\t#ifdef AREA_R8_G8_B8_A8_LUTS\n\tt1 *= vec4(1.001, 0.3239, 0.60437568, 1.0);\n\tt1 += vec4(0.0, -0.2976, -0.01381, 0.0);\n\t#endif\n\treturn mat3(\n\t\tvec3( t1.x, 0, t1.y ),\n\t\tvec3(\t0, 1,\t0 ),\n\t\tvec3( t1.z, 0, t1.w )\n\t);\n}\nfloat calcRectLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {\n\tmat3 mInv = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );\n}\nfloat getRectLightSpecular(vec3 worldNormal, vec3 viewDir) {\n\treturn calcRectLightSpecular(worldNormal, viewDir, dLTCUV);\n}\nfloat calcDiskLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {\n\tmat3 mInv = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );\n}\nfloat getDiskLightSpecular(vec3 worldNormal, vec3 viewDir) {\n\treturn calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);\n}\nfloat getSphereLightSpecular(vec3 worldNormal, vec3 viewDir) {\n\treturn calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);\n}\n",metalnessPS:"\n#ifdef MAPFLOAT\nuniform float material_metalness;\n#endif\nvoid getMetalness() {\n\tfloat metalness = 1.0;\n\t#ifdef MAPFLOAT\n\tmetalness *= material_metalness;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tmetalness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tmetalness *= saturate(vVertexColor.$VC);\n\t#endif\n\tdMetalness = metalness;\n}\n",metalnessModulatePS:"\nvec3 getSpecularModulate(in vec3 specularity, in vec3 albedo, in float metalness, in float f0) {\n\tvec3 dielectricF0 = f0 * specularity;\n\treturn mix(dielectricF0, albedo, metalness);\n}\nvec3 getAlbedoModulate(in vec3 albedo, in float metalness) {\n\treturn albedo * (1.0 - metalness);\n}\n",msdfPS:"\nuniform sampler2D texture_msdfMap;\n#ifdef GL_OES_standard_derivatives\n#define USE_FWIDTH\n#endif\n#ifdef GL2\n#define USE_FWIDTH\n#endif\nfloat median(float r, float g, float b) {\n\treturn max(min(r, g), min(max(r, g), b));\n}\nfloat map (float min, float max, float v) {\n\treturn (v - min) / (max - min);\n}\nuniform float font_sdfIntensity;\nuniform float font_pxrange;\nuniform float font_textureWidth;\n#ifdef UNIFORM_TEXT_PARAMETERS\nuniform vec4 outline_color;\nuniform float outline_thickness;\nuniform vec4 shadow_color;\nuniform vec2 shadow_offset;\n#else\nvarying vec4 outline_color;\nvarying float outline_thickness;\nvarying vec4 shadow_color;\nvarying vec2 shadow_offset;\n#endif\nvec4 applyMsdf(vec4 color) {\n\tvec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;\n\tvec2 uvShdw = vUv0 - shadow_offset;\n\tvec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;\n\tfloat sigDist = median(tsample.r, tsample.g, tsample.b);\n\tfloat sigDistShdw = median(ssample.r, ssample.g, ssample.b);\n\tfloat smoothingMax = 0.2;\n\t#ifdef USE_FWIDTH\n\tvec2 w = fwidth(vUv0);\n\tfloat smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, smoothingMax);\n\t#else\n\tfloat font_size = 16.0;\n\tfloat smoothing = clamp(font_pxrange / font_size, 0.0, smoothingMax);\n\t#endif\n\tfloat mapMin = 0.05;\n\tfloat mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);\n\tfloat sigDistInner = map(mapMin, mapMax, sigDist);\n\tfloat sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);\n\tsigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);\n\tfloat center = 0.5;\n\tfloat inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);\n\tfloat outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);\n\tfloat shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);\n\tvec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);\n\ttcolor = mix(tcolor, color, inside);\n\tvec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;\n\ttcolor = mix(scolor, tcolor, outline);\n\t\n\treturn tcolor;\n}\n",msdfVS:"\nattribute vec3 vertex_outlineParameters;\nattribute vec3 vertex_shadowParameters;\nvarying vec4 outline_color;\nvarying float outline_thickness;\nvarying vec4 shadow_color;\nvarying vec2 shadow_offset;\nvoid unpackMsdfParams() {\n\tvec3 little = mod(vertex_outlineParameters, 256.);\n\tvec3 big = (vertex_outlineParameters - little) / 256.;\n\toutline_color.rb = little.xy / 255.;\n\toutline_color.ga = big.xy / 255.;\n\toutline_thickness = little.z / 255. * 0.2;\n\tlittle = mod(vertex_shadowParameters, 256.);\n\tbig = (vertex_shadowParameters - little) / 256.;\n\tshadow_color.rb = little.xy / 255.;\n\tshadow_color.ga = big.xy / 255.;\n\tshadow_offset = (vec2(little.z, big.z) / 127. - 1.) * 0.005;\n}\n",normalVS:"\n#ifdef MORPHING_TEXTURE_BASED_NORMAL\nuniform highp sampler2D morphNormalTex;\n#endif\nvec3 getNormal() {\n\t#ifdef SKIN\n\tdNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n\t#elif defined(INSTANCING)\n\tdNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n\t#else\n\tdNormalMatrix = matrix_normal;\n\t#endif\n\tvec3 tempNormal = vertex_normal;\n\t#ifdef MORPHING\n\t#ifdef MORPHING_NRM03\n\ttempNormal += morph_weights_a[0] * morph_nrm0;\n\ttempNormal += morph_weights_a[1] * morph_nrm1;\n\ttempNormal += morph_weights_a[2] * morph_nrm2;\n\ttempNormal += morph_weights_a[3] * morph_nrm3;\n\t#endif\n\t#ifdef MORPHING_NRM47\n\ttempNormal += morph_weights_b[0] * morph_nrm4;\n\ttempNormal += morph_weights_b[1] * morph_nrm5;\n\ttempNormal += morph_weights_b[2] * morph_nrm6;\n\ttempNormal += morph_weights_b[3] * morph_nrm7;\n\t#endif\n\t#endif\n\t#ifdef MORPHING_TEXTURE_BASED_NORMAL\n\t\t#ifdef WEBGPU\n\t\t\tivec2 morphUV = getTextureMorphCoords();\n\t\t\tvec3 morphNormal = texelFetch(morphNormalTex, ivec2(morphUV), 0).xyz;\n\t\t#else\n\t\t\tvec2 morphUV = getTextureMorphCoords();\n\t\t\tvec3 morphNormal = texture2D(morphNormalTex, morphUV).xyz;\n\t\t#endif\n\ttempNormal += morphNormal;\n\t#endif\n\treturn normalize(dNormalMatrix * tempNormal);\n}\n",normalDetailMapPS:"\n#ifdef MAPTEXTURE\nuniform float material_normalDetailMapBumpiness;\nvec3 blendNormals(vec3 n1, vec3 n2) {\n\tn1 += vec3(0, 0, 1);\n\tn2 *= vec3(-1, -1, 1);\n\treturn n1 * dot(n1, n2) / n1.z - n2;\n}\n#endif\nvec3 addNormalDetail(vec3 normalMap) {\n#ifdef MAPTEXTURE\n\tvec3 normalDetailMap = unpackNormal(texture2DBias($SAMPLER, $UV, textureBias));\n\tnormalDetailMap = mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness);\n\treturn blendNormals(normalMap, normalDetailMap);\n#else\n\treturn normalMap;\n#endif\n}\n",normalInstancedVS:"\nvec3 getNormal() {\n\tdNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n\treturn normalize(dNormalMatrix * vertex_normal);\n}\n",normalMapPS:"\n#ifdef MAPTEXTURE\nuniform float material_bumpiness;\n#endif\nvoid getNormal() {\n#ifdef MAPTEXTURE\n\tvec3 normalMap = unpackNormal(texture2DBias($SAMPLER, $UV, textureBias));\n\tnormalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness);\n\tdNormalW = normalize(dTBN * addNormalDetail(normalMap));\n#else\n\tdNormalW = dVertexNormalW;\n#endif\n}\n",normalSkinnedVS:"\nvec3 getNormal() {\n\tdNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n\treturn normalize(dNormalMatrix * vertex_normal);\n}\n",normalXYPS:"\nvec3 unpackNormal(vec4 nmap) {\n\tvec3 normal;\n\tnormal.xy = nmap.wy * 2.0 - 1.0;\n\tnormal.z = sqrt(1.0 - saturate(dot(normal.xy, normal.xy)));\n\treturn normal;\n}\n",normalXYZPS:"\nvec3 unpackNormal(vec4 nmap) {\n\treturn nmap.xyz * 2.0 - 1.0;\n}\n",opacityPS:"\n#ifdef MAPFLOAT\nuniform float material_opacity;\n#endif\nvoid getOpacity() {\n\tdAlpha = 1.0;\n\t#ifdef MAPFLOAT\n\tdAlpha *= material_opacity;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdAlpha *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAlpha *= clamp(vVertexColor.$VC, 0.0, 1.0);\n\t#endif\n}\n",opacityDitherPS:"\nuniform vec4 blueNoiseJitter;\n#ifndef DITHER_BAYER8\n\tuniform sampler2D blueNoiseTex32;\n#endif\nvoid opacityDither(float alpha, float id) {\n\t#ifdef DITHER_BAYER8\n\t\tfloat noise = bayer8(floor(mod(gl_FragCoord.xy + blueNoiseJitter.xy + id, 8.0))) / 64.0;\n\t#else\n\t\tvec2 uv = fract(gl_FragCoord.xy / 32.0 + blueNoiseJitter.xy + id);\n\t\tfloat noise = texture2DLodEXT(blueNoiseTex32, uv, 0.0).y;\n\t#endif\n\tif (alpha < noise)\n\t\tdiscard;\n}\n",outputPS:"\n",outputAlphaPS:"\ngl_FragColor.a = litArgs_opacity;\n",outputAlphaOpaquePS:"\n\tgl_FragColor.a = 1.0;\n",outputAlphaPremulPS:"\ngl_FragColor.rgb *= litArgs_opacity;\ngl_FragColor.a = litArgs_opacity;\n",outputTex2DPS:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\tgl_FragColor = texture2D(source, vUv0);\n}\n",packDepthPS:"\nvec4 packFloat(float depth) {\n\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\tconst vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\tres -= res.xxyz * bit_mask;\n\treturn res;\n}\n",sheenPS:"\n#ifdef MAPCOLOR\nuniform vec3 material_sheen;\n#endif\nvoid getSheen() {\n\tvec3 sheenColor = vec3(1, 1, 1);\n\t#ifdef MAPCOLOR\n\tsheenColor *= material_sheen;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tsheenColor *= $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tsheenColor *= saturate(vVertexColor.$VC);\n\t#endif\n\tsSpecularity = sheenColor;\n}\n",sheenGlossPS:"\n#ifdef MAPFLOAT\nuniform float material_sheenGloss;\n#endif\nvoid getSheenGlossiness() {\n\tfloat sheenGlossiness = 1.0;\n\t#ifdef MAPFLOAT\n\tsheenGlossiness *= material_sheenGloss;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tsheenGlossiness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tsheenGlossiness *= saturate(vVertexColor.$VC);\n\t#endif\n\t#ifdef MAPINVERT\n\tsheenGlossiness = 1.0 - sheenGlossiness;\n\t#endif\n\tsheenGlossiness += 0.0000001;\n\tsGlossiness = sheenGlossiness;\n}\n",parallaxPS:"\nuniform float material_heightMapFactor;\nvoid getParallax() {\n\tfloat parallaxScale = material_heightMapFactor;\n\tfloat height = texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\theight = height * parallaxScale - parallaxScale*0.5;\n\tvec3 viewDirT = dViewDirW * dTBN;\n\tviewDirT.z += 0.42;\n\tdUvOffset = height * (viewDirT.xy / viewDirT.z);\n}\n",particlePS:"\nvarying vec4 texCoordsAlphaLife;\nuniform sampler2D colorMap;\nuniform sampler2D colorParam;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nuniform float softening;\nuniform float colorMult;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\tfloat depth = dot(rgbaDepth, bitShift);\n\treturn depth;\n}\n#endif\nvoid main(void) {\n\tvec4 tex  = gammaCorrectInput(texture2D(colorMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y)));\n\tvec4 ramp = gammaCorrectInput(texture2D(colorParam, vec2(texCoordsAlphaLife.w, 0.0)));\n\tramp.rgb *= colorMult;\n\tramp.a += texCoordsAlphaLife.z;\n\tvec3 rgb = tex.rgb * ramp.rgb;\n\tfloat a  = tex.a * ramp.a;\n",particleVS:"\nvec3 unpack3NFloats(float src) {\n\tfloat r = fract(src);\n\tfloat g = fract(src * 256.0);\n\tfloat b = fract(src * 65536.0);\n\treturn vec3(r, g, b);\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc) {\n\treturn mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );\n}\nvec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {\n\tvec4 a = texture2D(tex,tc);\n\tvec4 b = texture2D(tex,tc + graphSampleSize);\n\tfloat c = fract(tc.x*graphNumSamples);\n\tvec3 unpackedA = unpack3NFloats(a.w);\n\tvec3 unpackedB = unpack3NFloats(b.w);\n\tw = mix(unpackedA, unpackedB, c);\n\treturn mix(a, b, c);\n}\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {\n\tfloat c = cos(pRotation);\n\tfloat s = sin(pRotation);\n\tmat2 m = mat2(c, -s, s, c);\n\trotMatrix = m;\n\treturn m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY) {\n\t#ifdef SCREEN_SPACE\n\t\tvec3 pos = vec3(-1, 0, 0) * quadXY.x + vec3(0, -1, 0) * quadXY.y;\n\t#else\n\t\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\t#endif\n\treturn pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY) {\n\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\treturn pos;\n}\nvec2 safeNormalize(vec2 v) {\n\tfloat l = length(v);\n\treturn (l > 1e-06) ? v / l : v;\n}\nvoid main(void) {\n\tvec3 meshLocalPos = particle_vertexData.xyz;\n\tfloat id = floor(particle_vertexData.w);\n\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n\tfloat uv = id / numParticlesPot;\n\treadInput(uv);\n#ifdef LOCAL_SPACE\n\tinVel = mat3(matrix_model) * inVel;\n#endif\n\tvec2 velocityV = safeNormalize((mat3(matrix_view) * inVel).xy);\n\tfloat particleLifetime = lifetime;\n\tif (inLife <= 0.0 || inLife > particleLifetime || !inShow) meshLocalPos = vec3(0.0);\n\tvec2 quadXY = meshLocalPos.xy;\n\tfloat nlife = clamp(inLife / particleLifetime, 0.0, 1.0);\n\tvec3 paramDiv;\n\tvec4 params = tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n\tfloat scale = params.y;\n\tfloat scaleDiv = paramDiv.x;\n\tfloat alphaDiv = paramDiv.z;\n\tscale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);\n#ifndef USE_MESH\n\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#else\n\ttexCoordsAlphaLife = vec4(particle_uv, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#endif\n\tvec3 particlePos = inPos;\n\tvec3 particlePosMoved = vec3(0.0);\n\tmat2 rotMatrix;\n",particleAnimFrameClampVS:"\n\tfloat animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.y) + animTexParams.x, animTexParams.z);\n",particleAnimFrameLoopVS:"\n\tfloat animFrame = floor(mod(texCoordsAlphaLife.w * animTexParams.y + animTexParams.x, animTexParams.z + 1.0));\n",particleAnimTexVS:"\n\tfloat animationIndex;\n\tif (animTexIndexParams.y == 1.0) {\n\t\tanimationIndex = floor((animTexParams.w + 1.0) * rndFactor3.z) * (animTexParams.z + 1.0);\n\t} else {\n\t\tanimationIndex = animTexIndexParams.x * (animTexParams.z + 1.0);\n\t}\n\tfloat atlasX = (animationIndex + animFrame) * animTexTilesParams.x;\n\tfloat atlasY = 1.0 - floor(atlasX + 1.0) * animTexTilesParams.y;\n\tatlasX = fract(atlasX);\n\ttexCoordsAlphaLife.xy *= animTexTilesParams.xy;\n\ttexCoordsAlphaLife.xy += vec2(atlasX, atlasY);\n",particleInputFloatPS:"\nvoid readInput(float uv) {\n\tvec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));\n\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));\n\tinPos = tex.xyz;\n\tinVel = tex2.xyz;\n\tinAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;\n\tinShow = tex.w >= 0.0;\n\tinLife = tex2.w;\n}\n",particleInputRgba8PS:"\n#define PI2 6.283185307179586\nuniform vec3 inBoundsSize;\nuniform vec3 inBoundsCenter;\nuniform float maxVel;\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nfloat decodeFloatRGBA( vec4 rgba ) {\n\treturn dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );\n}\nvoid readInput(float uv) {\n\tvec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));\n\tvec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));\n\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));\n\tvec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));\n\tinPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));\n\tinPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;\n\tinVel = tex2.xyz;\n\tinVel = (inVel - vec3(0.5)) * maxVel;\n\tinAngle = decodeFloatRG(tex1.ba) * PI2;\n\tinShow = tex2.a > 0.5;\n\tinLife = decodeFloatRGBA(tex3);\n\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\tfloat maxPosLife = lifetime+1.0;\n\tinLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;\n}\n",particleOutputFloatPS:"\nvoid writeOutput() {\n\tif (gl_FragCoord.y<1.0) {\n\t\tgl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);\n\t} else {\n\t\tgl_FragColor = vec4(outVel, outLife);\n\t}\n}\n",particleOutputRgba8PS:"\nuniform vec3 outBoundsMul;\nuniform vec3 outBoundsAdd;\nvec2 encodeFloatRG( float v ) {\n\tvec2 enc = vec2(1.0, 255.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n\treturn enc;\n}\nvec4 encodeFloatRGBA( float v ) {\n\tvec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n\treturn enc;\n}\nvoid writeOutput() {\n\toutPos = outPos * outBoundsMul + outBoundsAdd;\n\toutAngle = fract(outAngle / PI2);\n\toutVel = (outVel / maxVel) + vec3(0.5);\n\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\tfloat maxPosLife = lifetime+1.0;\n\toutLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);\n\tif (gl_FragCoord.y < 1.0) {\n\t\tgl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));\n\t} else if (gl_FragCoord.y < 2.0) {\n\t\tgl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));\n\t} else if (gl_FragCoord.y < 3.0) {\n\t\tgl_FragColor = vec4(outVel, visMode*0.5+0.5);\n\t} else {\n\t\tgl_FragColor = encodeFloatRGBA(outLife);\n\t}\n}\n",particleUpdaterAABBPS:"\nuniform mat3 spawnBounds;\nuniform vec3 spawnPosInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\tvec3 pos = inBounds - vec3(0.5);\n\tvec3 posAbs = abs(pos);\n\tvec3 maxPos = vec3(max(posAbs.x, max(posAbs.y, posAbs.z)));\n\tvec3 edge = maxPos + (vec3(0.5) - maxPos) * spawnPosInnerRatio;\n\tpos.x = edge.x * (maxPos.x == posAbs.x ? sign(pos.x) : 2.0 * pos.x);\n\tpos.y = edge.y * (maxPos.y == posAbs.y ? sign(pos.y) : 2.0 * pos.y);\n\tpos.z = edge.z * (maxPos.z == posAbs.z ? sign(pos.z) : 2.0 * pos.z);\n#ifndef LOCAL_SPACE\n\treturn emitterPos + spawnBounds * pos;\n#else\n\treturn spawnBounds * pos;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\tlocalVelocity -= vec3(0, 0, initialVelocity);\n}\n",particleUpdaterEndPS:"\n\twriteOutput();\n}\n",particleUpdaterInitPS:"\nvarying vec2 vUv0;\nuniform highp sampler2D particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform highp sampler2D internalTex3;\nuniform mat3 emitterMatrix, emitterMatrixInv;\nuniform vec3 emitterScale;\nuniform vec3 emitterPos, frameRandom, localVelocityDivMult, velocityDivMult;\nuniform float delta, rate, rateDiv, lifetime, numParticles, rotSpeedDivMult, radialSpeedDivMult, seed;\nuniform float startAngle, startAngle2;\nuniform float initialVelocity;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\nfloat visMode;\nvec3 outPos;\nvec3 outVel;\nfloat outAngle;\nbool outShow;\nfloat outLife;\n",particleUpdaterNoRespawnPS:"\n\tif (outLife >= lifetime) {\n\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\tvisMode = -1.0;\n\t}\n",particleUpdaterOnStopPS:"\n\tvisMode = outLife < 0.0? -1.0: visMode;\n",particleUpdaterRespawnPS:"\n\tif (outLife >= lifetime) {\n\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\tvisMode = 1.0;\n\t}\n\tvisMode = outLife < 0.0? 1.0: visMode;\n",particleUpdaterSpherePS:"\nuniform float spawnBoundsSphere;\nuniform float spawnBoundsSphereInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\tfloat rnd4 = fract(rndFactor * 1000.0);\n\tvec3 norm = normalize(inBounds.xyz - vec3(0.5));\n\tfloat r = rnd4 * (1.0 - spawnBoundsSphereInnerRatio) + spawnBoundsSphereInnerRatio;\n#ifndef LOCAL_SPACE\n\treturn emitterPos + norm * r * spawnBoundsSphere;\n#else\n\treturn norm * r * spawnBoundsSphere;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\tlocalVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;\n}\n",particleUpdaterStartPS:"\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 unpack3NFloats(float src) {\n\tfloat r = fract(src);\n\tfloat g = fract(src * 256.0);\n\tfloat b = fract(src * 65536.0);\n\treturn vec3(r, g, b);\n}\nvec3 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {\n\tvec4 a = texture2D(tex, tc);\n\tvec4 b = texture2D(tex, tc + graphSampleSize);\n\tfloat c = fract(tc.x * graphNumSamples);\n\tvec3 unpackedA = unpack3NFloats(a.w);\n\tvec3 unpackedB = unpack3NFloats(b.w);\n\tw = mix(unpackedA, unpackedB, c);\n\treturn mix(a.xyz, b.xyz, c);\n}\n#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)\nvec4 hash41(float p) {\n\tvec4 p4 = fract(vec4(p) * HASHSCALE4);\n\tp4 += dot(p4, p4.wzxy+19.19);\n\treturn fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));\n}\nvoid main(void) {\n\tif (gl_FragCoord.x > numParticles) discard;\n\treadInput(vUv0.x);\n\tvisMode = inShow? 1.0 : -1.0;\n\tvec4 rndFactor = hash41(gl_FragCoord.x + seed);\n\tfloat particleRate = rate + rateDiv * rndFactor.x;\n\toutLife = inLife + delta;\n\tfloat nlife = clamp(outLife / lifetime, 0.0, 1.0);\n\tvec3 localVelocityDiv;\n\tvec3 velocityDiv;\n\tvec3 paramDiv;\n\tvec3 localVelocity = tex1Dlod_lerp(internalTex0, vec2(nlife, 0), localVelocityDiv);\n\tvec3 velocity =\t  tex1Dlod_lerp(internalTex1, vec2(nlife, 0), velocityDiv);\n\tvec3 params =\t\ttex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n\tfloat rotSpeed = params.x;\n\tfloat rotSpeedDiv = paramDiv.y;\n\tvec3 radialParams = tex1Dlod_lerp(internalTex3, vec2(nlife, 0), paramDiv);\n\tfloat radialSpeed = radialParams.x;\n\tfloat radialSpeedDiv = radialParams.y;\n\tbool respawn = inLife <= 0.0 || outLife >= lifetime;\n\tinPos = respawn ? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : inPos;\n\tinAngle = respawn ? mix(startAngle, startAngle2, rndFactor.x) : inAngle;\n#ifndef LOCAL_SPACE\n\tvec3 radialVel = inPos - emitterPos;\n#else\n\tvec3 radialVel = inPos;\n#endif\n\tradialVel = (dot(radialVel, radialVel) > 1.0E-8) ? radialSpeed * normalize(radialVel) : vec3(0.0);\n\tradialVel += (radialSpeedDiv * vec3(2.0) - vec3(1.0)) * radialSpeedDivMult * rndFactor.xyz;\n\tlocalVelocity +=\t(localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;\n\tvelocity +=\t\t (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;\n\trotSpeed +=\t\t (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;\n\taddInitialVelocity(localVelocity, rndFactor.xyz);\n#ifndef LOCAL_SPACE\n\toutVel = emitterMatrix * localVelocity + (radialVel + velocity) * emitterScale;\n#else\n\toutVel = (localVelocity + radialVel) / emitterScale + emitterMatrixInv * velocity;\n#endif\n\toutPos = inPos + outVel * delta;\n\toutAngle = inAngle + rotSpeed * delta;\n",particle_billboardVS:"\n\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\tvec3 localPos = billboard(particlePos, quadXY);\n",particle_blendAddPS:"\n\tdBlendModeFogFactor = 0.0;\n\trgb *= saturate(gammaCorrectInput(max(a, 0.0)));\n\tif ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;\n",particle_blendMultiplyPS:"\n\trgb = mix(vec3(1.0), rgb, vec3(a));\n\tif (rgb.r + rgb.g + rgb.b > 2.99) discard;\n",particle_blendNormalPS:"\n\tif (a < 0.01) discard;\n",particle_cpuVS:"\nattribute vec4 particle_vertexData;\nattribute vec4 particle_vertexData2;\nattribute vec4 particle_vertexData3;\nattribute float particle_vertexData4;\n#ifndef USE_MESH\nattribute vec2 particle_vertexData5;\n#else\nattribute vec4 particle_vertexData5;\n#endif\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\nuniform float numParticles;\nuniform float lifetime;\nuniform float stretch;\nuniform float seed;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale;\nuniform vec3 faceTangent;\nuniform vec3 faceBinorm;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform vec3 emitterPos;\nvarying vec4 texCoordsAlphaLife;\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)\n{\n\tfloat c = cos(pRotation);\n\tfloat s = sin(pRotation);\n\tmat2 m = mat2(c, -s, s, c);\n\trotMatrix = m;\n\treturn m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY)\n{\n\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\treturn pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY)\n{\n\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\treturn pos;\n}\nvoid main(void)\n{\n\tvec3 particlePos = particle_vertexData.xyz;\n\tvec3 inPos = particlePos;\n\tvec3 vertPos = particle_vertexData3.xyz;\n\tvec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData5.x);\n\tfloat id = floor(particle_vertexData4);\n\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n#ifdef LOCAL_SPACE\n\tinVel = mat3(matrix_model) * inVel;\n#endif\n\tvec2 velocityV = normalize((mat3(matrix_view) * inVel).xy);\n\tvec2 quadXY = vertPos.xy;\n#ifdef USE_MESH\n\ttexCoordsAlphaLife = vec4(particle_vertexData5.zw, particle_vertexData2.z, particle_vertexData.w);\n#else\n\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);\n#endif\n\tmat2 rotMatrix;\n\tfloat inAngle = particle_vertexData2.x;\n\tvec3 particlePosMoved = vec3(0.0);\n\tvec3 meshLocalPos = particle_vertexData3.xyz;\n",particle_cpu_endVS:"\n\tlocalPos *= particle_vertexData2.y * emitterScale;\n\tlocalPos += particlePos;\n\tgl_Position = matrix_viewProjection * vec4(localPos, 1.0);\n",particle_customFaceVS:"\n\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\tvec3 localPos = customFace(particlePos, quadXY);\n",particle_endPS:"\n\trgb = addFog(rgb);\n\trgb = toneMap(rgb);\n\trgb = gammaCorrectOutput(rgb);\n\tgl_FragColor = vec4(rgb, a);\n}\n",particle_endVS:"\n\tlocalPos *= scale * emitterScale;\n\tlocalPos += particlePos;\n\t#ifdef SCREEN_SPACE\n\tgl_Position = vec4(localPos.x, localPos.y, 0.0, 1.0);\n\t#else\n\tgl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);\n\t#endif\n",particle_halflambertPS:"\n\tvec3 negNormal = normal*0.5+0.5;\n\tvec3 posNormal = -normal*0.5+0.5;\n\tnegNormal *= negNormal;\n\tposNormal *= posNormal;\n",particle_initVS:"\nattribute vec4 particle_vertexData;\n#ifdef USE_MESH\nattribute vec2 particle_uv;\n#endif\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform float numParticles, numParticlesPot;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float stretch;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale, emitterPos, faceTangent, faceBinorm;\nuniform float rate, rateDiv, lifetime, deltaRandomnessStatic, scaleDivMult, alphaDivMult, seed, delta;\nuniform sampler2D particleTexOUT, particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nvarying vec4 texCoordsAlphaLife;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\n",particle_lambertPS:"\n\tvec3 negNormal = max(normal, vec3(0.0));\n\tvec3 posNormal = max(-normal, vec3(0.0));\n",particle_lightingPS:"\n\tvec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +\n\t\t\t\t\t\tnegNormal.y*lightCube[2] + posNormal.y*lightCube[3] +\n\t\t\t\t\t\tnegNormal.z*lightCube[4] + posNormal.z*lightCube[5];\n\trgb *= light;\n",particle_localShiftVS:"\n\tparticlePos = (matrix_model * vec4(particlePos, 1.0)).xyz;\n",particle_meshVS:"\n\tvec3 localPos = meshLocalPos;\n\tlocalPos.xy = rotate(localPos.xy, inAngle, rotMatrix);\n\tlocalPos.yz = rotate(localPos.yz, inAngle, rotMatrix);\n\tbillboard(particlePos, quadXY);\n",particle_normalVS:"\n\tNormal = normalize(localPos + matrix_viewInverse[2].xyz);\n",particle_normalMapPS:"\n\tvec3 normalMap = normalize(texture2D(normalMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y)).xyz * 2.0 - 1.0);\n\tvec3 normal = ParticleMat * normalMap;\n",particle_pointAlongVS:"\n\tinAngle = atan(velocityV.x, velocityV.y);\n",particle_softPS:"\n\tfloat depth = getLinearScreenDepth();\n\tfloat particleDepth = vDepth;\n\tfloat depthDiff = saturate(abs(particleDepth - depth) * softening);\n\ta *= depthDiff;\n",particle_softVS:"\n\tvDepth = getLinearDepth(localPos);\n",particle_stretchVS:"\n\tvec3 moveDir = inVel * stretch;\n\tvec3 posPrev = particlePos - moveDir;\n\tposPrev += particlePosMoved;\n\tvec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);\n\tfloat interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;\n\tparticlePos = mix(particlePos, posPrev, interpolation);\n",particle_TBNVS:"\n\tmat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0, rotMatrix[1][0], rotMatrix[1][1], 0.0, 0.0, 0.0, 1.0);\n\tParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;\n",particle_wrapVS:"\n\tvec3 origParticlePos = particlePos;\n\tparticlePos -= matrix_model[3].xyz;\n\tparticlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;\n\tparticlePos += matrix_model[3].xyz;\n\tparticlePosMoved = particlePos - origParticlePos;\n",reflDirPS:"\nvoid getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {\n\tdReflDirW = normalize(-reflect(viewDir, worldNormal));\n}\n",reflDirAnisoPS:"\nvoid getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {\n\tfloat roughness = sqrt(1.0 - min(gloss, 1.0));\n\tfloat anisotropy = material_anisotropy * roughness;\n\tvec3 anisotropicDirection = anisotropy >= 0.0 ? tbn[1] : tbn[0];\n\tvec3 anisotropicTangent = cross(anisotropicDirection, viewDir);\n\tvec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);\n\tvec3 bentNormal = normalize(mix(normalize(worldNormal), normalize(anisotropicNormal), anisotropy));\n\tdReflDirW = reflect(-viewDir, bentNormal);\n}\n",reflectionCCPS:"\n#ifdef LIT_CLEARCOAT\nvoid addReflectionCC(vec3 reflDir, float gloss) {\n\tccReflection += calcReflection(reflDir, gloss);\n}\n#endif\n",reflectionCubePS:"\nuniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 reflDir, float gloss) {\n\tvec3 lookupVec = fixSeams(cubeMapProject(reflDir));\n\tlookupVec.x *= -1.0;\n\treturn $DECODE(textureCube(texture_cubeMap, lookupVec));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n\tdReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionEnvHQPS:"\n#ifndef ENV_ATLAS\n#define ENV_ATLAS\nuniform sampler2D texture_envAtlas;\n#endif\nuniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 reflDir, float gloss) {\n\tvec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);\n\tvec2 uv = toSphericalUv(dir);\n\tfloat level = saturate(1.0 - gloss) * 5.0;\n\tfloat ilevel = floor(level);\n\tfloat flevel = level - ilevel;\n\tvec3 sharp = $DECODE_CUBEMAP(textureCube(texture_cubeMap, fixSeams(dir)));\n\tvec3 roughA = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel)));\n\tvec3 roughB = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));\n\treturn processEnvironment(mix(sharp, mix(roughA, roughB, flevel), min(level, 1.0)));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n\tdReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionEnvPS:"\n#ifndef ENV_ATLAS\n#define ENV_ATLAS\nuniform sampler2D texture_envAtlas;\n#endif\nuniform float material_reflectivity;\nfloat shinyMipLevel(vec2 uv) {\n\tvec2 dx = dFdx(uv);\n\tvec2 dy = dFdy(uv);\n\tvec2 uv2 = vec2(fract(uv.x + 0.5), uv.y);\n\tvec2 dx2 = dFdx(uv2);\n\tvec2 dy2 = dFdy(uv2);\n\tfloat maxd = min(max(dot(dx, dx), dot(dy, dy)), max(dot(dx2, dx2), dot(dy2, dy2)));\n\treturn clamp(0.5 * log2(maxd) - 1.0 + textureBias, 0.0, 5.0);\n}\nvec3 calcReflection(vec3 reflDir, float gloss) {\n\tvec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);\n\tvec2 uv = toSphericalUv(dir);\n\tfloat level = saturate(1.0 - gloss) * 5.0;\n\tfloat ilevel = floor(level);\n\tfloat level2 = shinyMipLevel(uv * atlasSize);\n\tfloat ilevel2 = floor(level2);\n\tvec2 uv0, uv1;\n\tfloat weight;\n\tif (ilevel == 0.0) {\n\t\tuv0 = mapShinyUv(uv, ilevel2);\n\t\tuv1 = mapShinyUv(uv, ilevel2 + 1.0);\n\t\tweight = level2 - ilevel2;\n\t} else {\n\t\tuv0 = uv1 = mapRoughnessUv(uv, ilevel);\n\t\tweight = 0.0;\n\t}\n\tvec3 linearA = $DECODE(texture2D(texture_envAtlas, uv0));\n\tvec3 linearB = $DECODE(texture2D(texture_envAtlas, uv1));\n\tvec3 linear0 = mix(linearA, linearB, weight);\n\tvec3 linear1 = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));\n\treturn processEnvironment(mix(linear0, linear1, level - ilevel));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n\tdReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionSpherePS:"\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 reflDir, float gloss) {\n\tvec3 reflDirV = (mat3(matrix_view) * reflDir).xyz;\n\tfloat m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );\n\tvec2 sphereMapUv = reflDirV.xy / m + 0.5;\n\treturn $DECODE(texture2D(texture_sphereMap, sphereMapUv));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n\tdReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionSheenPS:"\nvoid addReflectionSheen(vec3 worldNormal, vec3 viewDir, float gloss) {\n\tfloat NoV = dot(worldNormal, viewDir);\n\tfloat alphaG = gloss * gloss;\n\tfloat a = gloss < 0.25 ? -339.2 * alphaG + 161.4 * gloss - 25.9 : -8.48 * alphaG + 14.3 * gloss - 9.95;\n\tfloat b = gloss < 0.25 ? 44.0 * alphaG - 23.7 * gloss + 3.26 : 1.97 * alphaG - 3.27 * gloss + 0.72;\n\tfloat DG = exp( a * NoV + b ) + ( gloss < 0.25 ? 0.0 : 0.1 * ( gloss - 0.25 ) );\n\tsReflection += calcReflection(worldNormal, 0.0) * saturate(DG);\n}\n",refractionCubePS:"\nvec3 refract2(vec3 viewVec, vec3 normal, float IOR) {\n\tfloat vn = dot(viewVec, normal);\n\tfloat k = 1.0 - IOR * IOR * (1.0 - vn * vn);\n\tvec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * normal;\n\treturn refrVec;\n}\nvoid addRefraction(\n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tfloat thickness, \n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 albedo, \n\tfloat transmission,\n\tfloat refractionIndex\n#if defined(LIT_IRIDESCENCE)\n\t, vec3 iridescenceFresnel,\n\tfloat iridescenceIntensity\n#endif \n) {\n\tvec4 tmpRefl = dReflection;\n\tvec3 reflectionDir = refract2(-viewDir, worldNormal, refractionIndex);\n\tdReflection = vec4(0);\n\taddReflection(reflectionDir, gloss);\n\tdDiffuseLight = mix(dDiffuseLight, dReflection.rgb * albedo, transmission);\n\tdReflection = tmpRefl;\n}\n",refractionDynamicPS:"\nuniform float material_invAttenuationDistance;\nuniform vec3 material_attenuation;\nvoid addRefraction(\n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tfloat thickness, \n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 albedo, \n\tfloat transmission,\n\tfloat refractionIndex\n#if defined(LIT_IRIDESCENCE)\n\t, vec3 iridescenceFresnel,\n\tfloat iridescenceIntensity\n#endif\n) {\n\tvec3 modelScale;\n\tmodelScale.x = length(vec3(matrix_model[0].xyz));\n\tmodelScale.y = length(vec3(matrix_model[1].xyz));\n\tmodelScale.z = length(vec3(matrix_model[2].xyz));\n\tvec3 refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndex)) * thickness * modelScale;\n\tvec4 pointOfRefraction = vec4(vPositionW + refractionVector, 1.0);\n\tvec4 projectionPoint = matrix_viewProjection * pointOfRefraction;\n\tvec2 uv = getGrabScreenPos(projectionPoint);\n\t#ifdef SUPPORTS_TEXLOD\n\t\tfloat iorToRoughness = (1.0 - gloss) * clamp((1.0 / refractionIndex) * 2.0 - 2.0, 0.0, 1.0);\n\t\tfloat refractionLod = log2(uScreenSize.x) * iorToRoughness;\n\t\tvec3 refraction = texture2DLodEXT(uSceneColorMap, uv, refractionLod).rgb;\n\t#else\n\t\tvec3 refraction = texture2D(uSceneColorMap, uv).rgb;\n\t#endif\n\tvec3 transmittance;\n\tif (material_invAttenuationDistance != 0.0)\n\t{\n\t\tvec3 attenuation = -log(material_attenuation) * material_invAttenuationDistance;\n\t\ttransmittance = exp(-attenuation * length(refractionVector));\n\t}\n\telse\n\t{\n\t\ttransmittance = refraction;\n\t}\n\tvec3 fresnel = vec3(1.0) - \n\t\tgetFresnel(\n\t\t\tdot(viewDir, worldNormal), \n\t\t\tgloss, \n\t\t\tspecularity\n\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t, iridescenceFresnel,\n\t\t\tiridescenceIntensity\n\t\t#endif\n\t\t);\n\tdDiffuseLight = mix(dDiffuseLight, refraction * transmittance * fresnel, transmission);\n}\n",reprojectPS:`\nvarying vec2 vUv0;\n#ifdef CUBEMAP_SOURCE\n\tuniform samplerCube sourceCube;\n#else\n\tuniform sampler2D sourceTex;\n#endif\n#ifdef USE_SAMPLES_TEX\n\tuniform sampler2D samplesTex;\n\tuniform vec2 samplesTexInverseSize;\n#endif\nuniform vec4 params;\nuniform vec2 params2;\nfloat targetFace() { return params.x; }\nfloat specularPower() { return params.y; }\nfloat sourceCubeSeamScale() { return params.z; }\nfloat targetCubeSeamScale() { return params.w; }\nfloat targetTotalPixels() { return params2.x; }\nfloat sourceTotalPixels() { return params2.y; }\nfloat PI = 3.141592653589793;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\n${J_}\n${ef}\nvec3 modifySeams(vec3 dir, float scale) {\n\tvec3 adir = abs(dir);\n\tfloat M = max(max(adir.x, adir.y), adir.z);\n\treturn dir / M * vec3(\n\t\tadir.x == M ? 1.0 : scale,\n\t\tadir.y == M ? 1.0 : scale,\n\t\tadir.z == M ? 1.0 : scale\n\t);\n}\nvec2 toSpherical(vec3 dir) {\n\treturn vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));\n}\nvec3 fromSpherical(vec2 uv) {\n\treturn vec3(cos(uv.y) * sin(uv.x),\n\t\t\t\tsin(uv.y),\n\t\t\t\tcos(uv.y) * cos(uv.x));\n}\nvec3 getDirectionEquirect() {\n\treturn fromSpherical((vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0) * vec2(PI, PI * 0.5));\n}\nfloat signNotZero(float k){\n\treturn(k >= 0.0) ? 1.0 : -1.0;\n}\nvec2 signNotZero(vec2 v) {\n\treturn vec2(signNotZero(v.x), signNotZero(v.y));\n}\nvec3 octDecode(vec2 o) {\n\tvec3 v = vec3(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);\n\tif (v.y < 0.0) {\n\t\tv.xz = (1.0 - abs(v.zx)) * signNotZero(v.xz);\n\t}\n\treturn normalize(v);\n}\nvec3 getDirectionOctahedral() {\n\treturn octDecode(vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0);\n}\nvec2 octEncode(in vec3 v) {\n\tfloat l1norm = abs(v.x) + abs(v.y) + abs(v.z);\n\tvec2 result = v.xz * (1.0 / l1norm);\n\tif (v.y < 0.0) {\n\t\tresult = (1.0 - abs(result.yx)) * signNotZero(result.xy);\n\t}\n\treturn result;\n}\n#ifdef CUBEMAP_SOURCE\n\tvec4 sampleCubemap(vec3 dir) {\n\t\treturn textureCube(sourceCube, modifySeams(dir, 1.0 - sourceCubeSeamScale()));\n\t}\n\tvec4 sampleCubemap(vec2 sph) {\n\treturn sampleCubemap(fromSpherical(sph));\n}\n\tvec4 sampleCubemap(vec3 dir, float mipLevel) {\n\t\treturn textureCubeLodEXT(sourceCube, modifySeams(dir, 1.0 - exp2(mipLevel) * sourceCubeSeamScale()), mipLevel);\n\t}\n\tvec4 sampleCubemap(vec2 sph, float mipLevel) {\n\t\treturn sampleCubemap(fromSpherical(sph), mipLevel);\n\t}\n#else\n\tvec4 sampleEquirect(vec2 sph) {\n\t\tvec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;\n\t\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n\t}\n\tvec4 sampleEquirect(vec3 dir) {\n\t\treturn sampleEquirect(toSpherical(dir));\n\t}\n\tvec4 sampleEquirect(vec2 sph, float mipLevel) {\n\t\tvec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;\n\t\treturn texture2DLodEXT(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);\n\t}\n\tvec4 sampleEquirect(vec3 dir, float mipLevel) {\n\t\treturn sampleEquirect(toSpherical(dir), mipLevel);\n\t}\n\tvec4 sampleOctahedral(vec3 dir) {\n\t\tvec2 uv = octEncode(dir) * 0.5 + 0.5;\n\t\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n\t}\n\tvec4 sampleOctahedral(vec2 sph) {\n\t\treturn sampleOctahedral(fromSpherical(sph));\n\t}\n\tvec4 sampleOctahedral(vec3 dir, float mipLevel) {\n\t\tvec2 uv = octEncode(dir) * 0.5 + 0.5;\n\t\treturn texture2DLodEXT(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);\n\t}\n\tvec4 sampleOctahedral(vec2 sph, float mipLevel) {\n\t\treturn sampleOctahedral(fromSpherical(sph), mipLevel);\n\t}\n#endif\nvec3 getDirectionCubemap() {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tfloat face = targetFace();\n\tvec3 vec;\n\tif (face == 0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face == 1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face == 2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face == 3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face == 4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\treturn normalize(modifySeams(vec, 1.0 / (1.0 - targetCubeSeamScale())));\n}\nmat3 matrixFromVector(vec3 n) {\n\tfloat a = 1.0 / (1.0 + n.z);\n\tfloat b = -n.x * n.y * a;\n\tvec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n\tvec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n\treturn mat3(b1, b2, n);\n}\nmat3 matrixFromVectorSlow(vec3 n) {\n\tvec3 up = (1.0 - abs(n.y) <= 0.0000001) ? vec3(0.0, 0.0, n.y > 0.0 ? 1.0 : -1.0) : vec3(0.0, 1.0, 0.0);\n\tvec3 x = normalize(cross(up, n));\n\tvec3 y = cross(n, x);\n\treturn mat3(x, y, n);\n}\nvec4 reproject() {\n\tif (NUM_SAMPLES <= 1) {\n\t\treturn ENCODE_FUNC(DECODE_FUNC(SOURCE_FUNC(TARGET_FUNC())));\n\t} else {\n\t\tvec3 t = TARGET_FUNC();\n\t\tvec3 tu = dFdx(t);\n\t\tvec3 tv = dFdy(t);\n\t\tvec3 result = vec3(0.0);\n\t\tfor (float u = 0.0; u < NUM_SAMPLES_SQRT; ++u) {\n\t\t\tfor (float v = 0.0; v < NUM_SAMPLES_SQRT; ++v) {\n\t\t\t\tresult += DECODE_FUNC(SOURCE_FUNC(normalize(t +\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttu * (u / NUM_SAMPLES_SQRT - 0.5) +\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttv * (v / NUM_SAMPLES_SQRT - 0.5))));\n\t\t\t}\n\t\t}\n\t\treturn ENCODE_FUNC(result / (NUM_SAMPLES_SQRT * NUM_SAMPLES_SQRT));\n\t}\n}\nvec4 unpackFloat = vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0);\n#ifdef USE_SAMPLES_TEX\n\tvoid unpackSample(int i, out vec3 L, out float mipLevel) {\n\t\tfloat u = (float(i * 4) + 0.5) * samplesTexInverseSize.x;\n\t\tfloat v = (floor(u) + 0.5) * samplesTexInverseSize.y;\n\t\tvec4 raw;\n\t\traw.x = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\t\traw.y = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\t\traw.z = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\t\traw.w = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat);\n\t\tL.xyz = raw.xyz * 2.0 - 1.0;\n\t\tmipLevel = raw.w * 8.0;\n\t}\n\tvec4 prefilterSamples() {\n\t\tmat3 vecSpace = matrixFromVectorSlow(TARGET_FUNC());\n\t\tvec3 L;\n\t\tfloat mipLevel;\n\t\tvec3 result = vec3(0.0);\n\t\tfloat totalWeight = 0.0;\n\t\tfor (int i = 0; i < NUM_SAMPLES; ++i) {\n\t\t\tunpackSample(i, L, mipLevel);\n\t\t\tresult += DECODE_FUNC(SOURCE_FUNC(vecSpace * L, mipLevel)) * L.z;\n\t\t\ttotalWeight += L.z;\n\t\t}\n\t\treturn ENCODE_FUNC(result / totalWeight);\n\t}\n\tvec4 prefilterSamplesUnweighted() {\n\t\tmat3 vecSpace = matrixFromVectorSlow(TARGET_FUNC());\n\t\tvec3 L;\n\t\tfloat mipLevel;\n\t\tvec3 result = vec3(0.0);\n\t\tfloat totalWeight = 0.0;\n\t\tfor (int i = 0; i < NUM_SAMPLES; ++i) {\n\t\t\tunpackSample(i, L, mipLevel);\n\t\t\tresult += DECODE_FUNC(SOURCE_FUNC(vecSpace * L, mipLevel));\n\t\t}\n\t\treturn ENCODE_FUNC(result / float(NUM_SAMPLES));\n\t}\n#endif\nvoid main(void) {\n\tgl_FragColor = PROCESS_FUNC();\n}\n`,sampleCatmullRomPS:"\nvec4 SampleTextureCatmullRom(TEXTURE_ACCEPT(tex), vec2 uv, vec2 texSize) {\n\tvec2 samplePos = uv * texSize;\n\tvec2 texPos1 = floor(samplePos - 0.5) + 0.5;\n\tvec2 f = samplePos - texPos1;\n\tvec2 w0 = f * (-0.5 + f * (1.0 - 0.5 * f));\n\tvec2 w1 = 1.0 + f * f * (-2.5 + 1.5 * f);\n\tvec2 w2 = f * (0.5 + f * (2.0 - 1.5 * f));\n\tvec2 w3 = f * f * (-0.5 + 0.5 * f);\n\tvec2 w12 = w1 + w2;\n\tvec2 offset12 = w2 / (w1 + w2);\n\tvec2 texPos0 = (texPos1 - 1.0) / texSize;\n\tvec2 texPos3 = (texPos1 + 2.0) / texSize;\n\tvec2 texPos12 = (texPos1 + offset12) / texSize;\n\tvec4 result = vec4(0.0);\n\tresult += texture2DLodEXT(tex, vec2(texPos0.x, texPos0.y), 0.0) * w0.x * w0.y;\n\tresult += texture2DLodEXT(tex, vec2(texPos12.x, texPos0.y), 0.0) * w12.x * w0.y;\n\tresult += texture2DLodEXT(tex, vec2(texPos3.x, texPos0.y), 0.0) * w3.x * w0.y;\n\tresult += texture2DLodEXT(tex, vec2(texPos0.x, texPos12.y), 0.0) * w0.x * w12.y;\n\tresult += texture2DLodEXT(tex, vec2(texPos12.x, texPos12.y), 0.0) * w12.x * w12.y;\n\tresult += texture2DLodEXT(tex, vec2(texPos3.x, texPos12.y), 0.0) * w3.x * w12.y;\n\tresult += texture2DLodEXT(tex, vec2(texPos0.x, texPos3.y), 0.0) * w0.x * w3.y;\n\tresult += texture2DLodEXT(tex, vec2(texPos12.x, texPos3.y), 0.0) * w12.x * w3.y;\n\tresult += texture2DLodEXT(tex, vec2(texPos3.x, texPos3.y), 0.0) * w3.x * w3.y;\n\treturn result;\n}\n",screenDepthPS:"\nuniform highp sampler2D uSceneDepthMap;\n#ifndef SCREENSIZE\n#define SCREENSIZE\nuniform vec4 uScreenSize;\n#endif\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef LINEARIZE_DEPTH\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\n#define LINEARIZE_DEPTH\n#ifdef GL2\nfloat linearizeDepth(float z) {\n\tif (camera_params.w == 0.0)\n\t\treturn (camera_params.z * camera_params.y) / (camera_params.y + z * (camera_params.z - camera_params.y));\n\telse\n\t\treturn camera_params.z + z * (camera_params.y - camera_params.z);\n}\n#else\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\treturn dot(rgbaDepth, bitShift);\n}\n#endif\n#endif\n#endif\nfloat getLinearScreenDepth(vec2 uv) {\n\t#ifdef GL2\n\t\treturn linearizeDepth(texture2D(uSceneDepthMap, uv).r);\n\t#else\n\t\treturn unpackFloat(texture2D(uSceneDepthMap, uv)) * camera_params.y;\n\t#endif\n}\n#ifndef VERTEXSHADER\nfloat getLinearScreenDepth() {\n\tvec2 uv = gl_FragCoord.xy * uScreenSize.zw;\n\treturn getLinearScreenDepth(uv);\n}\n#endif\nfloat getLinearDepth(vec3 pos) {\n\treturn -(matrix_view * vec4(pos, 1.0)).z;\n}\n",shadowCascadesPS:"\nconst float maxCascades = 4.0;\nmat4 cascadeShadowMat;\nvoid getShadowCascadeMatrix(mat4 shadowMatrixPalette[4], float shadowCascadeDistances[4], float shadowCascadeCount) {\n\tfloat depth = 1.0 / gl_FragCoord.w;\n\tfloat cascadeIndex = 0.0;\n\tfor (float i = 0.0; i < maxCascades; i++) {\n\t\tif (depth < shadowCascadeDistances[int(i)]) {\n\t\t\tcascadeIndex = i;\n\t\t\tbreak;\n\t\t}\n\t}\n\tcascadeIndex = min(cascadeIndex, shadowCascadeCount - 1.0);\n\t#ifdef GL2\n\t\tcascadeShadowMat = shadowMatrixPalette[int(cascadeIndex)];\n\t#else\n\t\tif (cascadeIndex == 0.0) {\n\t\t\tcascadeShadowMat = shadowMatrixPalette[0];\n\t\t}\n\t\telse if (cascadeIndex == 1.0) {\n\t\t\tcascadeShadowMat = shadowMatrixPalette[1];\n\t\t}\n\t\telse if (cascadeIndex == 2.0) {\n\t\t\tcascadeShadowMat = shadowMatrixPalette[2];\n\t\t}\n\t\telse {\n\t\t\tcascadeShadowMat = shadowMatrixPalette[3];\n\t\t}\n\t#endif\n}\nvoid fadeShadow(float shadowCascadeDistances[4]) {\t\t\t\t  \n\tfloat depth = 1.0 / gl_FragCoord.w;\n\tif (depth > shadowCascadeDistances[int(maxCascades - 1.0)]) {\n\t\tdShadowCoord.z = -9999999.0;\n\t}\n}\n",shadowEVSMPS:"\nfloat VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tvec3 moments = texture2D(tex, texCoords).xyz;\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n\treturn VSM$(shadowMap, shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n\treturn VSM$(shadowMap, shadowCoord.xy, shadowParams.x, length(lightDir) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",shadowEVSMnPS:"\nfloat VSM$(TEXTURE_ACCEPT(tex), vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tfloat pixelSize = 1.0 / resolution;\n\ttexCoords -= vec2(pixelSize);\n\tvec3 s00 = texture2D(tex, texCoords).xyz;\n\tvec3 s10 = texture2D(tex, texCoords + vec2(pixelSize, 0)).xyz;\n\tvec3 s01 = texture2D(tex, texCoords + vec2(0, pixelSize)).xyz;\n\tvec3 s11 = texture2D(tex, texCoords + vec2(pixelSize)).xyz;\n\tvec2 fr = fract(texCoords * resolution);\n\tvec3 h0 = mix(s00, s10, fr.x);\n\tvec3 h1 = mix(s01, s11, fr.x);\n\tvec3 moments = mix(h0, h1, fr.y);\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n\treturn VSM$(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n\treturn VSM$(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, length(lightDir) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",shadowPCSSPS:"\n#define PCSS_SAMPLE_COUNT 16\nuniform float pcssDiskSamples[PCSS_SAMPLE_COUNT];\nuniform float pcssSphereSamples[PCSS_SAMPLE_COUNT];\nvec2 vogelDisk(int sampleIndex, float count, float phi, float r) {\n\tconst float GoldenAngle = 2.4;\n\tfloat theta = float(sampleIndex) * GoldenAngle + phi;\n\tfloat sine = sin(theta);\n\tfloat cosine = cos(theta);\n\treturn vec2(r * cosine, r * sine);\n}\nvec3 vogelSphere(int sampleIndex, float count, float phi, float r) {\n\tconst float GoldenAngle = 2.4;\n\tfloat theta = float(sampleIndex) * GoldenAngle + phi;\n\tfloat weight = float(sampleIndex) / count;\n\treturn vec3(cos(theta) * r, weight, sin(theta) * r);\n}\nfloat noise(vec2 screenPos) {\n\tconst float PHI = 1.61803398874989484820459;\n\treturn fract(sin(dot(screenPos * PHI, screenPos)) * screenPos.x);\n}\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\treturn dot(rgbaDepth, bitShift);\n}\n#endif\nfloat viewSpaceDepth(float depth, mat4 invProjection) {\n\tfloat z = depth * 2.0 - 1.0;\n\tvec4 clipSpace = vec4(0.0, 0.0, z, 1.0);\n\tvec4 viewSpace = invProjection * clipSpace;\n\treturn viewSpace.z;\n}\nfloat PCSSBlockerDistance(TEXTURE_ACCEPT(shadowMap), vec2 sampleCoords[PCSS_SAMPLE_COUNT], vec2 shadowCoords, vec2 searchSize, float z) {\n\tfloat blockers = 0.0;\n\tfloat averageBlocker = 0.0;\n\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n\t\tvec2 offset = sampleCoords[i] * searchSize;\n\t\tvec2 sampleUV = shadowCoords + offset;\n\t#ifdef GL2\n\t\tfloat blocker = textureLod(shadowMap, sampleUV, 0.0).r;\n\t#else\n\t\tfloat blocker = unpackFloat(texture2D(shadowMap, sampleUV));\n\t#endif\t\t\n\t\tfloat isBlocking = step(blocker, z);\n\t\tblockers += isBlocking;\n\t\taverageBlocker += blocker * isBlocking;\n\t}\n\tif (blockers > 0.0)\n\t\treturn averageBlocker /= blockers;\n\treturn -1.0;\n}\nfloat PCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoords, vec4 cameraParams, vec2 shadowSearchArea) {\n\tfloat receiverDepth = shadowCoords.z;\n#ifndef GL2\n\treceiverDepth *= 1.0 / (cameraParams.y - cameraParams.z);\n#endif\n\tvec2 samplePoints[PCSS_SAMPLE_COUNT];\n\tfloat noise = noise( gl_FragCoord.xy ) * 2.0 * PI;\n\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n\t\tfloat pcssPresample = pcssDiskSamples[i];\n\t\tsamplePoints[i] = vogelDisk(i, float(PCSS_SAMPLE_COUNT), noise, pcssPresample);\n\t}\n\tfloat averageBlocker = PCSSBlockerDistance(TEXTURE_PASS(shadowMap), samplePoints, shadowCoords.xy, shadowSearchArea, receiverDepth);\n\tif (averageBlocker == -1.0) {\n\t\treturn 1.0;\n\t} else {\n\t\tvec2 filterRadius = ((receiverDepth - averageBlocker) / averageBlocker) * shadowSearchArea * cameraParams.x;\n\t\tfloat shadow = 0.0;\n\t\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i ++)\n\t\t{\n\t\t\tvec2 sampleUV = samplePoints[i] * filterRadius;\n\t\t\tsampleUV = shadowCoords.xy + sampleUV;\n\t\t#ifdef GL2\n\t\t\tfloat depth = textureLod(shadowMap, sampleUV, 0.0).r;\n\t\t#else\n\t\t\tfloat depth = unpackFloat(texture2D(shadowMap, sampleUV));\n\t\t#endif\n\t\t\tshadow += step(receiverDepth, depth);\n\t\t}\n\t\treturn shadow / float(PCSS_SAMPLE_COUNT);\n\t} \n}\nfloat PCSSCubeBlockerDistance(samplerCube shadowMap, vec3 lightDirNorm, vec3 samplePoints[PCSS_SAMPLE_COUNT], float z, float shadowSearchArea) {\n\tfloat blockers = 0.0;\n\tfloat averageBlocker = 0.0;\n\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n\t\tvec3 sampleDir = lightDirNorm + samplePoints[i] * shadowSearchArea;\n\t\tsampleDir = normalize(sampleDir);\n\t#ifdef GL2\n\t\tfloat blocker = textureCubeLodEXT(shadowMap, sampleDir, 0.0).r;\n\t#else\n\t\tfloat blocker = unpackFloat(textureCube(shadowMap, sampleDir));\n\t#endif\n\t\tfloat isBlocking = step(blocker, z);\n\t\tblockers += isBlocking;\n\t\taverageBlocker += blocker * isBlocking;\n\t}\n\tif (blockers > 0.0)\n\t\treturn averageBlocker /= float(blockers);\n\treturn -1.0;\n}\nfloat PCSSCube(samplerCube shadowMap, vec4 shadowParams, vec3 shadowCoords, vec4 cameraParams, float shadowSearchArea, vec3 lightDir) {\n\t\n\tvec3 samplePoints[PCSS_SAMPLE_COUNT];\n\tfloat noise = noise( gl_FragCoord.xy ) * 2.0 * PI;\n\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n\t\tfloat r = pcssSphereSamples[i];\n\t\tsamplePoints[i] = vogelSphere(i, float(PCSS_SAMPLE_COUNT), noise, r);\n\t}\n\tfloat receiverDepth = length(lightDir) * shadowParams.w + shadowParams.z;\n\tvec3 lightDirNorm = normalize(lightDir);\n\t\n\tfloat averageBlocker = PCSSCubeBlockerDistance(shadowMap, lightDirNorm, samplePoints, receiverDepth, shadowSearchArea);\n\tif (averageBlocker == -1.0) {\n\t\treturn 1.0;\n\t} else {\n\t\tfloat filterRadius = ((receiverDepth - averageBlocker) / averageBlocker) * shadowSearchArea;\n\t\tfloat shadow = 0.0;\n\t\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++)\n\t\t{\n\t\t\tvec3 offset = samplePoints[i] * filterRadius;\n\t\t\tvec3 sampleDir = lightDirNorm + offset;\n\t\t\tsampleDir = normalize(sampleDir);\n\t\t\t#ifdef GL2\n\t\t\t\tfloat depth = textureCubeLodEXT(shadowMap, sampleDir, 0.0).r;\n\t\t\t#else\n\t\t\t\tfloat depth = unpackFloat(textureCube(shadowMap, sampleDir));\n\t\t\t#endif\n\t\t\tshadow += step(receiverDepth, depth);\n\t\t}\n\t\treturn shadow / float(PCSS_SAMPLE_COUNT);\n\t}\n}\nfloat getShadowPointPCSS(samplerCube shadowMap, vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {\n\treturn PCSSCube(shadowMap, shadowParams, shadowCoord, cameraParams, shadowSearchArea.x, lightDir);\n}\nfloat getShadowSpotPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {\n\treturn PCSS(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, shadowSearchArea);\n}\nfloat getShadowPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {\n\treturn PCSS(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, shadowSearchArea);\n}\n",shadowSampleCoordPS:"\nvec3 getShadowSampleCoord$LIGHT(mat4 shadowTransform, vec4 shadowParams, vec3 worldPosition, vec3 lightPos, inout vec3 lightDir, vec3 lightDirNorm, vec3 normal) {\n\tvec3 surfacePosition = worldPosition;\n#ifdef SHADOW_SAMPLE_POINT\n\t#ifdef SHADOW_SAMPLE_NORMAL_OFFSET\n\t\tfloat distScale = length(lightDir);\n\t\tsurfacePosition = worldPosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n\t\tlightDir = surfacePosition - lightPos;\n\t\treturn lightDir;\n\t#endif\n#else\n\t#ifdef SHADOW_SAMPLE_SOURCE_ZBUFFER\n\t\t#ifdef SHADOW_SAMPLE_NORMAL_OFFSET\n\t\t\tsurfacePosition = worldPosition + normal * shadowParams.y;\n\t\t#endif\n\t#else\n\t\t#ifdef SHADOW_SAMPLE_NORMAL_OFFSET\n\t\t\t#ifdef SHADOW_SAMPLE_ORTHO\n\t\t\t\tfloat distScale = 1.0;\n\t\t\t#else\n\t\t\t\tfloat distScale = abs(dot(vPositionW - lightPos, lightDirNorm));\n\t\t\t#endif\n\t\t\tsurfacePosition = worldPosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n\t\t#endif\n\t#endif\n\tvec4 positionInShadowSpace = shadowTransform * vec4(surfacePosition, 1.0);\n\t#ifdef SHADOW_SAMPLE_ORTHO\n\t\tpositionInShadowSpace.z = saturate(positionInShadowSpace.z) - 0.0001;\n\t#else\n\t\t#ifdef SHADOW_SAMPLE_SOURCE_ZBUFFER\n\t\t\tpositionInShadowSpace.xyz /= positionInShadowSpace.w;\n\t\t#else\n\t\t\tpositionInShadowSpace.xy /= positionInShadowSpace.w;\n\t\t\tpositionInShadowSpace.z = length(lightDir) * shadowParams.w;\n\t\t#endif\n\t#endif\n\t#ifdef SHADOW_SAMPLE_Z_BIAS\n\t\tpositionInShadowSpace.z += getShadowBias(shadowParams.x, shadowParams.z);\n\t#endif\n\tsurfacePosition = positionInShadowSpace.xyz;\n#endif\n\treturn surfacePosition;\n}\n",shadowStandardPS:"\nvec3 lessThan2(vec3 a, vec3 b) {\n\treturn clamp((b - a)*1000.0, 0.0, 1.0);\n}\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\n\tfloat unpackFloat(vec4 rgbaDepth) {\n\t\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\t\treturn dot(rgbaDepth, bitShift);\n\t}\n#endif\n#ifdef GL2\nfloat _getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {\n\tfloat z = shadowCoord.z;\n\tvec2 uv = shadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y);\n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat sum = 0.0;\n\tfloat uw0 = (3.0 - 2.0 * s);\n\tfloat uw1 = (1.0 + 2.0 * s);\n\tfloat u0 = (2.0 - s) / uw0 - 1.0;\n\tfloat u1 = s / uw1 + 1.0;\n\tfloat vw0 = (3.0 - 2.0 * t);\n\tfloat vw1 = (1.0 + 2.0 * t);\n\tfloat v0 = (2.0 - t) / vw0 - 1.0;\n\tfloat v1 = t / vw1 + 1.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));\n\tsum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));\n\tsum *= 1.0f / 16.0;\n\treturn sum;\n}\nfloat getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\nfloat getShadowSpotPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\nfloat getShadowPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn textureShadow(shadowMap, shadowCoord);\n}\nfloat getShadowSpotPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn textureShadow(shadowMap, shadowCoord);\n}\n#else\nfloat _xgetShadowPCF3x3(mat3 depthKernel, vec3 shadowCoord, sampler2D shadowMap, vec3 shadowParams) {\n\tmat3 shadowKernel;\n\tvec3 shadowZ = vec3(shadowCoord.z);\n\tshadowKernel[0] = vec3(greaterThan(depthKernel[0], shadowZ));\n\tshadowKernel[1] = vec3(greaterThan(depthKernel[1], shadowZ));\n\tshadowKernel[2] = vec3(greaterThan(depthKernel[2], shadowZ));\n\tvec2 fractionalCoord = fract( shadowCoord.xy * shadowParams.x );\n\tshadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n\tshadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\tvec4 shadowValues;\n\tshadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n\tshadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n\tshadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n\tshadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\treturn dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\nfloat _getShadowPCF3x3(sampler2D shadowMap, vec3 shadowCoord, vec3 shadowParams) {\n\tfloat xoffset = 1.0 / shadowParams.x;\n\tfloat dx0 = -xoffset;\n\tfloat dx1 = xoffset;\n\tmat3 depthKernel;\n\tdepthKernel[0][0] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(dx0, dx0)));\n\tdepthKernel[0][1] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(dx0, 0.0)));\n\tdepthKernel[0][2] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(dx0, dx1)));\n\tdepthKernel[1][0] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(0.0, dx0)));\n\tdepthKernel[1][1] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy));\n\tdepthKernel[1][2] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(0.0, dx1)));\n\tdepthKernel[2][0] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(dx1, dx0)));\n\tdepthKernel[2][1] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(dx1, 0.0)));\n\tdepthKernel[2][2] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(dx1, dx1)));\n\treturn _xgetShadowPCF3x3(depthKernel, shadowCoord, shadowMap, shadowParams);\n}\nfloat getShadowPCF3x3(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowCoord, shadowParams.xyz);\n}\nfloat getShadowSpotPCF3x3(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowCoord, shadowParams.xyz);\n}\nfloat _getShadowPCF1x1(sampler2D shadowMap, vec3 shadowCoord) {\n\tfloat shadowSample = unpackFloat(textureShadow(shadowMap, shadowCoord.xy));\n\treturn shadowSample > shadowCoord.z ? 1.0 : 0.0;\n}\nfloat getShadowPCF1x1(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams) {\n\treturn _getShadowPCF1x1(shadowMap, shadowCoord);\n}\nfloat getShadowSpotPCF1x1(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams) {\n\treturn _getShadowPCF1x1(shadowMap, shadowCoord);\n}\n#endif\n#ifndef WEBGPU\nfloat _getShadowPoint(samplerCube shadowMap, vec4 shadowParams, vec3 dir) {\n\tvec3 tc = normalize(dir);\n\tvec3 tcAbs = abs(tc);\n\tvec4 dirX = vec4(1,0,0, tc.x);\n\tvec4 dirY = vec4(0,1,0, tc.y);\n\tfloat majorAxisLength = tc.z;\n\tif ((tcAbs.x > tcAbs.y) && (tcAbs.x > tcAbs.z)) {\n\t\tdirX = vec4(0,0,1, tc.z);\n\t\tdirY = vec4(0,1,0, tc.y);\n\t\tmajorAxisLength = tc.x;\n\t} else if ((tcAbs.y > tcAbs.x) && (tcAbs.y > tcAbs.z)) {\n\t\tdirX = vec4(1,0,0, tc.x);\n\t\tdirY = vec4(0,0,1, tc.z);\n\t\tmajorAxisLength = tc.y;\n\t}\n\tfloat shadowParamsInFaceSpace = ((1.0/shadowParams.x) * 2.0) * abs(majorAxisLength);\n\tvec3 xoffset = (dirX.xyz * shadowParamsInFaceSpace);\n\tvec3 yoffset = (dirY.xyz * shadowParamsInFaceSpace);\n\tvec3 dx0 = -xoffset;\n\tvec3 dy0 = -yoffset;\n\tvec3 dx1 = xoffset;\n\tvec3 dy1 = yoffset;\n\tmat3 shadowKernel;\n\tmat3 depthKernel;\n\tdepthKernel[0][0] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy0));\n\tdepthKernel[0][1] = unpackFloat(textureCube(shadowMap, tc + dx0));\n\tdepthKernel[0][2] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy1));\n\tdepthKernel[1][0] = unpackFloat(textureCube(shadowMap, tc + dy0));\n\tdepthKernel[1][1] = unpackFloat(textureCube(shadowMap, tc));\n\tdepthKernel[1][2] = unpackFloat(textureCube(shadowMap, tc + dy1));\n\tdepthKernel[2][0] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy0));\n\tdepthKernel[2][1] = unpackFloat(textureCube(shadowMap, tc + dx1));\n\tdepthKernel[2][2] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy1));\n\tvec3 shadowZ = vec3(length(dir) * shadowParams.w + shadowParams.z);\n\tshadowKernel[0] = vec3(lessThan2(depthKernel[0], shadowZ));\n\tshadowKernel[1] = vec3(lessThan2(depthKernel[1], shadowZ));\n\tshadowKernel[2] = vec3(lessThan2(depthKernel[2], shadowZ));\n\tvec2 uv = (vec2(dirX.w, dirY.w) / abs(majorAxisLength)) * 0.5;\n\tvec2 fractionalCoord = fract( uv * shadowParams.x );\n\tshadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n\tshadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\tvec4 shadowValues;\n\tshadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n\tshadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n\tshadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n\tshadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\treturn 1.0 - dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\nfloat getShadowPointPCF3x3(samplerCube shadowMap, vec3 shadowCoord, vec4 shadowParams, vec3 lightDir) {\n\treturn _getShadowPoint(shadowMap, shadowParams, lightDir);\n}\n#endif\n",shadowStandardGL2PS:"\nfloat _getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {\n\tfloat z = shadowCoord.z;\n\tvec2 uv = shadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y);\n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat uw0 = (4.0 - 3.0 * s);\n\tfloat uw1 = 7.0;\n\tfloat uw2 = (1.0 + 3.0 * s);\n\tfloat u0 = (3.0 - 2.0 * s) / uw0 - 2.0;\n\tfloat u1 = (3.0 + s) / uw1;\n\tfloat u2 = s / uw2 + 2.0;\n\tfloat vw0 = (4.0 - 3.0 * t);\n\tfloat vw1 = 7.0;\n\tfloat vw2 = (1.0 + 3.0 * t);\n\tfloat v0 = (3.0 - 2.0 * t) / vw0 - 2.0;\n\tfloat v1 = (3.0 + t) / vw1;\n\tfloat v2 = t / vw2 + 2.0;\n\tfloat sum = 0.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tu2 = u2 * shadowMapSizeInv + base_uv.x;\n\tv2 = v2 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));\n\tsum += uw2 * vw0 * textureShadow(shadowMap, vec3(u2, v0, z));\n\tsum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));\n\tsum += uw2 * vw1 * textureShadow(shadowMap, vec3(u2, v1, z));\n\tsum += uw0 * vw2 * textureShadow(shadowMap, vec3(u0, v2, z));\n\tsum += uw1 * vw2 * textureShadow(shadowMap, vec3(u1, v2, z));\n\tsum += uw2 * vw2 * textureShadow(shadowMap, vec3(u2, v2, z));\n\tsum *= 1.0f / 144.0;\n\tsum = saturate(sum);\n\treturn sum;\n}\nfloat getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\nfloat getShadowSpotPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\n",shadowVSM8PS:"\nfloat calculateVSM8(vec3 moments, float Z, float vsmBias) {\n\tfloat VSMBias = vsmBias;\n\tfloat depthScale = VSMBias * Z;\n\tfloat minVariance1 = depthScale * depthScale;\n\treturn chebyshevUpperBound(moments.xy, Z, minVariance1, 0.1);\n}\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nfloat VSM8(TEXTURE_ACCEPT(tex), vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tvec4 c = texture2D(tex, texCoords);\n\tvec3 moments = vec3(decodeFloatRG(c.xy), decodeFloatRG(c.zw), 0.0);\n\treturn calculateVSM8(moments, Z, vsmBias);\n}\nfloat getShadowVSM8(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n\treturn VSM8(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, 0.0);\n}\nfloat getShadowSpotVSM8(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n\treturn VSM8(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, length(lightDir) * shadowParams.w + shadowParams.z, shadowParams.y, 0.0);\n}\n",shadowVSM_commonPS:"\nfloat linstep(float a, float b, float v) {\n\treturn saturate((v - a) / (b - a));\n}\nfloat reduceLightBleeding(float pMax, float amount) {\n\t return linstep(amount, 1.0, pMax);\n}\nfloat chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {\n\tfloat variance = moments.y - (moments.x * moments.x);\n\tvariance = max(variance, minVariance);\n\tfloat d = mean - moments.x;\n\tfloat pMax = variance / (variance + (d * d));\n\tpMax = reduceLightBleeding(pMax, lightBleedingReduction);\n\treturn (mean <= moments.x ? 1.0 : pMax);\n}\nfloat calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {\n\tZ = 2.0 * Z - 1.0;\n\tfloat warpedDepth = exp(exponent * Z);\n\tmoments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);\n\tfloat VSMBias = vsmBias;\n\tfloat depthScale = VSMBias * exponent * warpedDepth;\n\tfloat minVariance1 = depthScale * depthScale;\n\treturn chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);\n}\n",skinBatchConstVS:"\nattribute float vertex_boneIndices;\nuniform vec4 matrix_pose[BONE_LIMIT * 3];\nmat4 getBoneMatrix(const in float i) {\n\tvec4 v1 = matrix_pose[int(3.0 * i)];\n\tvec4 v2 = matrix_pose[int(3.0 * i + 1.0)];\n\tvec4 v3 = matrix_pose[int(3.0 * i + 2.0)];\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, 1\n\t);\n}\n",skinBatchTexVS:"\nattribute float vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\nmat4 getBoneMatrix(const in float i) {\n\tfloat j = i * 3.0;\n\tfloat dx = texture_poseMapSize.z;\n\tfloat dy = texture_poseMapSize.w;\n\tfloat y = floor(j * dx);\n\tfloat x = j - (y * texture_poseMapSize.x);\n\ty = dy * (y + 0.5);\n\tvec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n\tvec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n\tvec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, 1\n\t);\n}\n",skinConstVS:"\nattribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform vec4 matrix_pose[BONE_LIMIT * 3];\nvoid getBoneMatrix(const in float i, out vec4 v1, out vec4 v2, out vec4 v3) {\n\tv1 = matrix_pose[int(3.0 * i)];\n\tv2 = matrix_pose[int(3.0 * i + 1.0)];\n\tv3 = matrix_pose[int(3.0 * i + 2.0)];\n}\nmat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {\n\tvec4 a1, a2, a3;\n\tgetBoneMatrix(indices.x, a1, a2, a3);\n\tvec4 b1, b2, b3;\n\tgetBoneMatrix(indices.y, b1, b2, b3);\n\tvec4 c1, c2, c3;\n\tgetBoneMatrix(indices.z, c1, c2, c3);\n\tvec4 d1, d2, d3;\n\tgetBoneMatrix(indices.w, d1, d2, d3);\n\tvec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n\tvec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n\tvec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\tfloat one = dot(weights, vec4(1.0));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, one\n\t);\n}\n",skinTexVS:"\nattribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\nvoid getBoneMatrix(const in float index, out vec4 v1, out vec4 v2, out vec4 v3) {\n\tfloat i = float(index);\n\tfloat j = i * 3.0;\n\tfloat dx = texture_poseMapSize.z;\n\tfloat dy = texture_poseMapSize.w;\n\t\n\tfloat y = floor(j * dx);\n\tfloat x = j - (y * texture_poseMapSize.x);\n\ty = dy * (y + 0.5);\n\tv1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n\tv2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n\tv3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n}\nmat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {\n\tvec4 a1, a2, a3;\n\tgetBoneMatrix(indices.x, a1, a2, a3);\n\tvec4 b1, b2, b3;\n\tgetBoneMatrix(indices.y, b1, b2, b3);\n\tvec4 c1, c2, c3;\n\tgetBoneMatrix(indices.z, c1, c2, c3);\n\tvec4 d1, d2, d3;\n\tgetBoneMatrix(indices.w, d1, d2, d3);\n\tvec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n\tvec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n\tvec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\tfloat one = dot(weights, vec4(1.0));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, one\n\t);\n}\n",skyboxEnvPS:"\nvarying vec3 vViewDir;\nuniform sampler2D texture_envAtlas;\nuniform float mipLevel;\nvoid main(void) {\n\tvec3 dir = vViewDir * vec3(-1.0, 1.0, 1.0);\n\tvec2 uv = toSphericalUv(normalize(dir));\n\tvec3 linear = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, mipLevel)));\n\tgl_FragColor = vec4(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);\n}\n",skyboxHDRPS:"\nvarying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\n#ifdef SKYMESH\n\tvarying vec3 vWorldPos;\n\tuniform mat3 cubeMapRotationMatrix;\n\tuniform vec3 projectedSkydomeCenter;\n#endif\nvoid main(void) {\n\t#ifdef SKYMESH\n\t\tvec3 envDir = normalize(vWorldPos - projectedSkydomeCenter);\n\t\tvec3 dir = envDir * cubeMapRotationMatrix;\n\t#else\n\t\tvec3 dir = vViewDir;\n\t#endif\n\tdir.x *= -1.0;\n\tvec3 linear = $DECODE(textureCube(texture_cubeMap, fixSeamsStatic(dir, $FIXCONST)));\n\tgl_FragColor = vec4(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);\n}\n",skyboxVS:"\nattribute vec3 aPosition;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat4 matrix_projectionSkybox;\nuniform mat3 cubeMapRotationMatrix;\nvarying vec3 vViewDir;\n#ifdef SKYMESH\n\tuniform mat4 matrix_model;\n\tvarying vec3 vWorldPos;\n#endif\nvoid main(void) {\n\tmat4 view = matrix_view;\n\t#ifdef SKYMESH\n\t\tvec4 worldPos = matrix_model * vec4(aPosition, 1.0);\n\t\tvWorldPos = worldPos.xyz;\n\t\tgl_Position = matrix_projectionSkybox * view * worldPos;\n\t#else\n\t\tview[3][0] = view[3][1] = view[3][2] = 0.0;\n\t\tgl_Position = matrix_projectionSkybox * view * vec4(aPosition, 1.0);\n\t\tvViewDir = aPosition * cubeMapRotationMatrix;\n\t#endif\n\tgl_Position.z = gl_Position.w - 0.00001;\n}\n",specularPS:"\n#ifdef MAPCOLOR\nuniform vec3 material_specular;\n#endif\nvoid getSpecularity() {\n\tvec3 specularColor = vec3(1,1,1);\n\t#ifdef MAPCOLOR\n\tspecularColor *= material_specular;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tspecularColor *= $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tspecularColor *= saturate(vVertexColor.$VC);\n\t#endif\n\tdSpecularity = specularColor;\n}\n",sphericalPS:"\nconst float PI = 3.141592653589793;\nvec2 toSpherical(vec3 dir) {\n\treturn vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));\n}\nvec2 toSphericalUv(vec3 dir) {\n\tvec2 uv = toSpherical(dir) / vec2(PI * 2.0, PI) + 0.5;\n\treturn vec2(uv.x, 1.0 - uv.y);\n}\n",specularityFactorPS:"\n#ifdef MAPFLOAT\nuniform float material_specularityFactor;\n#endif\nvoid getSpecularityFactor() {\n\tfloat specularityFactor = 1.0;\n\t#ifdef MAPFLOAT\n\tspecularityFactor *= material_specularityFactor;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tspecularityFactor *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tspecularityFactor *= saturate(vVertexColor.$VC);\n\t#endif\n\tdSpecularityFactor = specularityFactor;\n}\n",spotPS:"\nfloat getSpotEffect(vec3 lightSpotDir, float lightInnerConeAngle, float lightOuterConeAngle, vec3 lightDirNorm) {\n\tfloat cosAngle = dot(lightDirNorm, lightSpotDir);\n\treturn smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n",startPS:"\nvoid main(void) {\n\tdReflection = vec4(0);\n\t#ifdef LIT_CLEARCOAT\n\tccSpecularLight = vec3(0);\n\tccReflection = vec3(0);\n\t#endif\n",startVS:"\nvoid main(void) {\n\tgl_Position = getPosition();\n",startNineSlicedPS:"\n\tnineSlicedUv = vUv0;\n\tnineSlicedUv.y = 1.0 - nineSlicedUv.y;\n",startNineSlicedTiledPS:"\n\tvec2 tileMask = step(vMask, vec2(0.99999));\n\tvec2 tileSize = 0.5 * (innerOffset.xy + innerOffset.zw);\n\tvec2 tileScale = vec2(1.0) / (vec2(1.0) - tileSize);\n\tvec2 clampedUv = mix(innerOffset.xy * 0.5, vec2(1.0) - innerOffset.zw * 0.5, fract((vTiledUv - tileSize) * tileScale));\n\tclampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\n\tnineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);\n\tnineSlicedUv.y = 1.0 - nineSlicedUv.y;\n\t\n",storeEVSMPS:"\nfloat exponent = VSM_EXPONENT;\ndepth = 2.0 * depth - 1.0;\ndepth =  exp(exponent * depth);\ngl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);\n",tangentBinormalVS:"\nvec3 getTangent() {\n\treturn normalize(dNormalMatrix * vertex_tangent.xyz);\n}\nvec3 getBinormal() {\n\treturn cross(vNormalW, vTangentW) * vertex_tangent.w;\n}\n",TBNPS:"\nvoid getTBN(vec3 tangent, vec3 binormal, vec3 normal) {\n\tdTBN = mat3(normalize(tangent), normalize(binormal), normalize(normal));\n}\n",TBNderivativePS:"\nuniform float tbnBasis;\nvoid getTBN(vec3 tangent, vec3 binormal, vec3 normal) {\n\tvec2 uv = $UV;\n\tvec3 dp1 = dFdx( vPositionW );\n\tvec3 dp2 = dFdy( vPositionW );\n\tvec2 duv1 = dFdx( uv );\n\tvec2 duv2 = dFdy( uv );\n\tvec3 dp2perp = cross( dp2, normal );\n\tvec3 dp1perp = cross( normal, dp1 );\n\tvec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n\tvec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\tfloat denom = max( dot(T,T), dot(B,B) );\n\tfloat invmax = (denom == 0.0) ? 0.0 : tbnBasis / sqrt( denom );\n\tdTBN = mat3(T * invmax, -B * invmax, normal );\n}\n",TBNfastPS:"\nvoid getTBN(vec3 tangent, vec3 binormal, vec3 normal) {\n\tdTBN = mat3(tangent, binormal, normal);\n}\n",TBNObjectSpacePS:"\nvoid getTBN(vec3 tangent, vec3 binormal, vec3 normal) {\n\tvec3 B = cross(normal, vObjectSpaceUpW);\n\tvec3 T = cross(normal, B);\n\tif (dot(B,B)==0.0)\n\t{\n\t\tfloat major=max(max(normal.x, normal.y), normal.z);\n\t\tif (normal.x == major)\n\t\t{\n\t\t\tB=cross(normal, vec3(0,1,0));\n\t\t\tT=cross(normal, B);\n\t\t}\n\t\telse if (normal.y == major)\n\t\t{\n\t\t\tB=cross(normal, vec3(0,0,1));\n\t\t\tT=cross(normal, B);\n\t\t}\n\t\telse if (normal.z == major)\n\t\t{\n\t\t\tB=cross(normal, vec3(1,0,0));\n\t\t\tT=cross(normal, B);\n\t\t}\n\t}\n\tdTBN = mat3(normalize(T), normalize(B), normalize(normal));\n}\n",textureSamplePS:"\nvec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n\treturn gammaCorrectInput(texture2D(tex, uv));\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n\treturn gammaCorrectInput(texture2D(tex, uv, bias));\n}\nvec3 texture2DRGBM(sampler2D tex, vec2 uv) {\n\treturn decodeRGBM(texture2D(tex, uv));\n}\nvec3 texture2DRGBM(sampler2D tex, vec2 uv, float bias) {\n\treturn decodeRGBM(texture2D(tex, uv, bias));\n}\nvec3 texture2DRGBE(sampler2D tex, vec2 uv) {\n\treturn decodeRGBM(texture2D(tex, uv));\n}\nvec3 texture2DRGBE(sampler2D tex, vec2 uv, float bias) {\n\treturn decodeRGBM(texture2D(tex, uv, bias));\n}\n",thicknessPS:"\n#ifdef MAPFLOAT\nuniform float material_thickness;\n#endif\nvoid getThickness() {\n\tdThickness = 1.0;\n\t#ifdef MAPFLOAT\n\tdThickness *= material_thickness;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdThickness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdThickness *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",tonemappingAcesPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n\tfloat tA = 2.51;\n\tfloat tB = 0.03;\n\tfloat tC = 2.43;\n\tfloat tD = 0.59;\n\tfloat tE = 0.14;\n\tvec3 x = color * exposure;\n\treturn (x*(tA*x+tB))/(x*(tC*x+tD)+tE);\n}\n",tonemappingAces2PS:"\nuniform float exposure;\nconst mat3 ACESInputMat = mat3(\n\t0.59719, 0.35458, 0.04823,\n\t0.07600, 0.90834, 0.01566,\n\t0.02840, 0.13383, 0.83777\n);\nconst mat3 ACESOutputMat = mat3(\n\t 1.60475, -0.53108, -0.07367,\n\t-0.10208,  1.10813, -0.00605,\n\t-0.00327, -0.07276,  1.07602\n);\nvec3 RRTAndODTFit(vec3 v) {\n\tvec3 a = v * (v + 0.0245786) - 0.000090537;\n\tvec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;\n\treturn a / b;\n}\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure / 0.6;\n\tcolor = color * ACESInputMat;\n\tcolor = RRTAndODTFit(color);\n\tcolor = color * ACESOutputMat;\n\tcolor = clamp(color, 0.0, 1.0);\n\treturn color;\n}\n",tonemappingFilmicPS:"\nconst float A =  0.15;\nconst float B =  0.50;\nconst float C =  0.10;\nconst float D =  0.20;\nconst float E =  0.02;\nconst float F =  0.30;\nconst float W =  11.2;\nuniform float exposure;\nvec3 uncharted2Tonemap(vec3 x) {\n\t return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\nvec3 toneMap(vec3 color) {\n\tcolor = uncharted2Tonemap(color * exposure);\n\tvec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));\n\tcolor = color * whiteScale;\n\treturn color;\n}\n",tonemappingHejlPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure;\n\tconst float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;\n\tconst float Scl = 1.25;\n\tvec3 h = max( vec3(0.0), color - vec3(0.004) );\n\treturn (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);\n}\n",tonemappingLinearPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n\treturn color * exposure;\n}\n",tonemappingNonePS:"\nvec3 toneMap(vec3 color) {\n\treturn color;\n}\n",transformVS:"\n#ifdef PIXELSNAP\nuniform vec4 uScreenSize;\n#endif\n#ifdef SCREENSPACE\nuniform float projectionFlipY;\n#endif\n#ifdef MORPHING\nuniform vec4 morph_weights_a;\nuniform vec4 morph_weights_b;\n#endif\n#ifdef MORPHING_TEXTURE_BASED\n\tuniform vec4 morph_tex_params;\n\t#ifdef WEBGPU\n\t\tivec2 getTextureMorphCoords() {\n\t\t\tivec2 textureSize = ivec2(morph_tex_params.xy);\n\t\t\tint morphGridV = int(morph_vertex_id / textureSize.x);\n\t\t\tint morphGridU = int(morph_vertex_id - (morphGridV * textureSize.x));\n\t\t\tmorphGridV = textureSize.y - morphGridV - 1;\n\t\t\treturn ivec2(morphGridU, morphGridV);\n\t\t}\n\t#else\n\t\tvec2 getTextureMorphCoords() {\n\t\t\tvec2 textureSize = morph_tex_params.xy;\n\t\t\tvec2 invTextureSize = morph_tex_params.zw;\n\t\t\tfloat morphGridV = floor(morph_vertex_id * invTextureSize.x);\n\t\t\tfloat morphGridU = morph_vertex_id - (morphGridV * textureSize.x);\n\t\t\treturn vec2(morphGridU, morphGridV) * invTextureSize + (0.5 * invTextureSize);\n\t\t}\n\t#endif\n#endif\n#ifdef MORPHING_TEXTURE_BASED_POSITION\nuniform highp sampler2D morphPositionTex;\n#endif\nmat4 getModelMatrix() {\n\t#ifdef DYNAMICBATCH\n\treturn getBoneMatrix(vertex_boneIndices);\n\t#elif defined(SKIN)\n\treturn matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);\n\t#elif defined(INSTANCING)\n\treturn mat4(instance_line1, instance_line2, instance_line3, instance_line4);\n\t#else\n\treturn matrix_model;\n\t#endif\n}\nvec4 getPosition() {\n\tdModelMatrix = getModelMatrix();\n\tvec3 localPos = vertex_position;\n\t#ifdef NINESLICED\n\tlocalPos.xz *= outerScale;\n\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\tlocalPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\tvTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0;\n\tlocalPos.xz *= -0.5;\n\tlocalPos = localPos.xzy;\n\t#endif\n\t#ifdef MORPHING\n\t#ifdef MORPHING_POS03\n\tlocalPos.xyz += morph_weights_a[0] * morph_pos0;\n\tlocalPos.xyz += morph_weights_a[1] * morph_pos1;\n\tlocalPos.xyz += morph_weights_a[2] * morph_pos2;\n\tlocalPos.xyz += morph_weights_a[3] * morph_pos3;\n\t#endif\n\t#ifdef MORPHING_POS47\n\tlocalPos.xyz += morph_weights_b[0] * morph_pos4;\n\tlocalPos.xyz += morph_weights_b[1] * morph_pos5;\n\tlocalPos.xyz += morph_weights_b[2] * morph_pos6;\n\tlocalPos.xyz += morph_weights_b[3] * morph_pos7;\n\t#endif\n\t#endif\n\t#ifdef MORPHING_TEXTURE_BASED_POSITION\n\t\t#ifdef WEBGPU\n\t\t\tivec2 morphUV = getTextureMorphCoords();\n\t\t\tvec3 morphPos = texelFetch(morphPositionTex, ivec2(morphUV), 0).xyz;\n\t\t#else\n\t\t\tvec2 morphUV = getTextureMorphCoords();\n\t\t\tvec3 morphPos = texture2D(morphPositionTex, morphUV).xyz;\n\t\t#endif\n\t\tlocalPos += morphPos;\n\t#endif\n\tvec4 posW = dModelMatrix * vec4(localPos, 1.0);\n\t#ifdef SCREENSPACE\n\tposW.zw = vec2(0.0, 1.0);\n\t#endif\n\tdPositionW = posW.xyz;\n\tvec4 screenPos;\n\t#ifdef UV1LAYOUT\n\tscreenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);\n\t\t#ifdef WEBGPU\n\t\tscreenPos.y *= -1.0;\n\t\t#endif\n\t#else\n\t#ifdef SCREENSPACE\n\tscreenPos = posW;\n\tscreenPos.y *= projectionFlipY;\n\t#else\n\tscreenPos = matrix_viewProjection * posW;\n\t#endif\n\t#ifdef PIXELSNAP\n\tscreenPos.xy = (screenPos.xy * 0.5) + 0.5;\n\tscreenPos.xy *= uScreenSize.xy;\n\tscreenPos.xy = floor(screenPos.xy);\n\tscreenPos.xy *= uScreenSize.zw;\n\tscreenPos.xy = (screenPos.xy * 2.0) - 1.0;\n\t#endif\n\t#endif\n\treturn screenPos;\n}\nvec3 getWorldPosition() {\n\treturn dPositionW;\n}\n",transformDeclVS:"\nattribute vec3 vertex_position;\nuniform mat4 matrix_model;\nuniform mat4 matrix_viewProjection;\nvec3 dPositionW;\nmat4 dModelMatrix;\n",transmissionPS:"\n#ifdef MAPFLOAT\nuniform float material_refraction;\n#endif\nvoid getRefraction() {\n\tfloat refraction = 1.0;\n\t#ifdef MAPFLOAT\n\trefraction = material_refraction;\n\t#endif\n\t#ifdef MAPTEXTURE\n\trefraction *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\trefraction *= saturate(vVertexColor.$VC);\n\t#endif\n\tdTransmission = refraction;\n}\n",uv0VS:"\n#ifdef NINESLICED\nvec2 getUv0() {\n\tvec2 uv = vertex_position.xz;\n\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\tuv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\tuv = uv * -0.5 + 0.5;\n\tuv = uv * atlasRect.zw + atlasRect.xy;\n\tvMask = vertex_texCoord0.xy;\n\treturn uv;\n}\n#else\nvec2 getUv0() {\n\treturn vertex_texCoord0;\n}\n#endif\n",uv1VS:"\nvec2 getUv1() {\n\treturn vertex_texCoord1;\n}\n",viewDirPS:"\nvoid getViewDir() {\n\tdViewDirW = normalize(view_position - vPositionW);\n}\n",viewNormalVS:"\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nvec3 getViewNormal() {\n\treturn mat3(matrix_view) * vNormalW;\n}\n",webgpuPS:Cm,webgpuVS:Tm},sf=new zp;function nf(e){return sf.get(e)}function rf(e,t){sf.get(e,(()=>t))}class af{static begin(){return"void main(void)\n{\n"}static end(){return"}\n"}static skinCode(e,t=tf){return e.supportsBoneTextures?t.skinTexVS:"#define BONE_LIMIT "+e.getBoneLimit()+"\n"+t.skinConstVS}static fogCode(e,t=tf){return"linear"===e?t.fogLinearPS?t.fogLinearPS:tf.fogLinearPS:"exp"===e?t.fogExpPS?t.fogExpPS:tf.fogExpPS:"exp2"===e?t.fogExp2PS?t.fogExp2PS:tf.fogExp2PS:t.fogNonePS?t.fogNonePS:tf.fogNonePS}static gammaCode(e,t=tf){return 1===e||2===e?t.gamma2_2PS?t.gamma2_2PS:tf.gamma2_2PS:3===e?"#define HDR\n"+(t.gamma2_2PS?t.gamma2_2PS:tf.gamma2_2PS):t.gamma1_0PS?t.gamma1_0PS:tf.gamma1_0PS}static tonemapCode(e,t=tf){return 1===e?t.tonemappingFilmicPS?t.tonemappingFilmicPS:tf.tonemappingFilmicPS:0===e?t.tonemappingLinearPS?t.tonemappingLinearPS:tf.tonemappingLinearPS:2===e?t.tonemappingHejlPS?t.tonemappingHejlPS:tf.tonemappingHejlPS:3===e?t.tonemappingAcesPS?t.tonemappingAcesPS:tf.tonemappingAcesPS:4===e?t.tonemappingAces2PS?t.tonemappingAces2PS:tf.tonemappingAces2PS:t.tonemapingNonePS?t.tonemapingNonePS:tf.tonemappingNonePS}}function of(e,t,s,i,n,r=!1,a={}){"boolean"==typeof r?a.useTransformFeedback=r:"object"==typeof r&&(a=yp({},a,r));const o=nf(e);let l=o.getCachedShader(i);return l||(l=new pm(e,Pm.createDefinition(e,yp({},a,{name:i,vertexCode:t,fragmentCode:s,attributes:n}))),o.setCachedShader(i,l)),l}class lf extends af{constructor(e,t){super(),this.key=e,this.shaderDefinition=t}generateKey(e){return this.key}createShaderDefinition(e,t){return this.shaderDefinition}}function hf(e,t){var s;const i=e.definition,n=`${null!=(s=i.name)?s:"shader"}-id-${e.id}`,r=new lf(n,i),a="shader",o=nf(e.device);o.register(a,r);const l=o.getProgram(a,{},t);return"wgsl"===e.definition.shaderLanguage&&(l.meshUniformBufferFormat=i.meshUniformBufferFormat,l.meshBindGroupFormat=i.meshBindGroupFormat),o.unregister(a),l}tf.createShader=function(e,t,s,i=!1,n={}){return"boolean"==typeof i?n.useTransformFeedback=i:"object"==typeof i&&(n=yp({},n,i)),new pm(e,Pm.createDefinition(e,yp({},n,{name:`${t}_${s}`,vertexCode:tf[t],fragmentCode:tf[s]})))},tf.createShaderFromCode=of;const cf={type:5,base:0,count:4,indexed:!1},df=new ou,uf=new ou;class pf{constructor(e){this.uniformBuffer=void 0,this.bindGroup=void 0;const t=e.device;if(this.shader=e,t.supportsUniformBuffers){const s=new Rm;this.shader=hf(e,s);const i=this.shader.meshUniformBufferFormat;i&&(this.uniformBuffer=new vm(t,i,!1));const n=this.shader.meshBindGroupFormat;this.bindGroup=new _m(t,n,this.uniformBuffer)}}destroy(){var e,t;null==(e=this.uniformBuffer)||e.destroy(),this.uniformBuffer=null,null==(t=this.bindGroup)||t.destroy(),this.bindGroup=null}render(e,t){const s=this.shader.device;var i;e&&(df.set(s.vx,s.vy,s.vw,s.vh),uf.set(s.sx,s.sy,s.sw,s.sh),t=null!=(i=t)?i:e,s.setViewport(e.x,e.y,e.z,e.w),s.setScissor(t.x,t.y,t.z,t.w));s.setVertexBuffer(s.quadVertexBuffer,0);const n=this.shader;if(s.setShader(n),s.supportsUniformBuffers){var r;const e=this.bindGroup;null==(r=e.defaultUniformBuffer)||r.update(),e.update(),s.setBindGroup(0,e)}s.draw(cf),e&&(s.setViewport(df.x,df.y,df.z,df.w),s.setScissor(uf.x,uf.y,uf.z,uf.w))}}class mf extends Im{constructor(e,t,s,i){super(e),this.quad=t,this.rect=s,this.scissorRect=i}execute(){const{device:e}=this;e.setCullMode(0),e.setDepthState(Ep.NODEPTH),e.setStencilState(null,null),this.quad.render(this.rect,this.scissorRect)}}const _f=new ou;function ff(e,t,s,i,n){const r=new pf(s);i||((i=_f).x=0,i.y=0,i.z=t?t.width:e.width,i.w=t?t.height:e.height);const a=new mf(e,r,i,n);a.init(t),a.colorOps.clear=!1,a.depthStencilOps.clearDepth=!1,e.isWebGPU&&null===t&&e.samples>1&&(a.colorOps.store=!0),a.render(),r.destroy()}const gf=new zp;class vf{constructor(e,t,s={}){this.index=void 0,this.name=void 0,this.shaderDefines=void 0,this.name=e,this.index=t,Object.assign(this,s),this.shaderDefines=this.buildShaderDefines()}buildShaderDefines(){let e;this.isShadow?e="SHADOW":this.isForward?e="FORWARD":2===this.index?e="DEPTH":3===this.index&&(e="PICK");return(e?`#define ${e}_PASS\n`:"")+`#define ${this.name.toUpperCase()}_PASS\n`}}class yf{constructor(){this.passesNamed=new Map,this.passesIndexed=[],this.nextIndex=0;const e=(e,t,s)=>{this.allocate(e,s)};e("forward",0,{isForward:!0}),e("forward_hdr",0,{isForward:!0}),e("depth"),e("pick"),e("shadow"),e("prepass")}static get(e){return gf.get(e,(()=>new yf))}allocate(e,t){let s=this.passesNamed.get(e);return void 0===s&&(s=new vf(e,this.nextIndex,t),this.passesNamed.set(s.name,s),this.passesIndexed[s.index]=s,this.nextIndex++),s}getByIndex(e){return this.passesIndexed[e]}getByName(e){return this.passesNamed.get(e)}}const bf=new class extends af{generateKey(e){let t="basic";return e.fog&&(t+="_fog"),e.alphaTest&&(t+="_atst"),e.vertexColors&&(t+="_vcol"),e.diffuseMap&&(t+="_diff"),e.skin&&(t+="_skin"),e.screenSpace&&(t+="_ss"),e.useInstancing&&(t+="_inst"),e.useMorphPosition&&(t+="_morphp"),e.useMorphNormal&&(t+="_morphn"),e.useMorphTextureBased&&(t+="_morpht"),t+="_"+e.pass,t}createShaderDefinition(e,t){const s={vertex_position:Ou};t.skin&&(s.vertex_boneWeights=Vu,s.vertex_boneIndices=Nu),t.vertexColors&&(s.vertex_color=Bu),t.diffuseMap&&(s.vertex_texCoord0=Hu);const i=yf.get(e).getByIndex(t.pass).shaderDefines;let n=i;n+=tf.transformDeclVS,t.skin?(n+=af.skinCode(e),n+=tf.transformSkinnedVS):n+=tf.transformVS,t.vertexColors&&(n+="attribute vec4 vertex_color;\n",n+="varying vec4 vColor;\n"),t.diffuseMap&&(n+="attribute vec2 vertex_texCoord0;\n",n+="varying vec2 vUv0;\n"),2===t.pass&&(n+="varying float vDepth;\n",n+="#ifndef VIEWMATRIX\n",n+="#define VIEWMATRIX\n",n+="uniform mat4 matrix_view;\n",n+="#endif\n",n+="#ifndef CAMERAPLANES\n",n+="#define CAMERAPLANES\n",n+="uniform vec4 camera_params;\n\n",n+="#endif\n"),n+=af.begin(),n+="   gl_Position = getPosition();\n",2===t.pass&&(n+="    vDepth = -(matrix_view * vec4(getWorldPosition(),1.0)).z * camera_params.x;\n"),t.vertexColors&&(n+="    vColor = vertex_color;\n"),t.diffuseMap&&(n+="    vUv0 = vertex_texCoord0;\n"),n+=af.end();let r=i;return t.vertexColors?r+="varying vec4 vColor;\n":r+="uniform vec4 uColor;\n",t.diffuseMap&&(r+="varying vec2 vUv0;\n",r+="uniform sampler2D texture_diffuseMap;\n"),t.fog&&(r+=af.fogCode(t.fog)),t.alphaTest&&(r+=tf.alphaTestPS),2===t.pass&&(r+="varying float vDepth;\n",r+=tf.packDepthPS),r+=af.begin(),t.vertexColors?r+="    gl_FragColor = vColor;\n":r+="    gl_FragColor = uColor;\n",t.diffuseMap&&(r+="    gl_FragColor *= texture2D(texture_diffuseMap, vUv0);\n"),t.alphaTest&&(r+="   alphaTest(gl_FragColor.a);\n"),3!==t.pass&&(2===t.pass?r+="    gl_FragColor = packFloat(vDepth);\n":t.fog&&(r+="   glFragColor.rgb = addFog(gl_FragColor.rgb);\n")),r+=af.end(),Pm.createDefinition(e,{name:"BasicShader",attributes:s,vertexCode:n,fragmentCode:r})}},xf=new zp;function wf(e){return xf.get(e)}const Sf=[];Sf[0]={src:1,dst:1,op:2},Sf[3]={src:1,dst:0,op:0},Sf[2]={src:6,dst:8,op:0},Sf[4]={src:1,dst:8,op:0},Sf[1]={src:1,dst:1,op:0},Sf[6]={src:6,dst:1,op:0},Sf[7]={src:4,dst:2,op:0},Sf[8]={src:5,dst:1,op:0},Sf[5]={src:4,dst:0,op:0},Sf[9]={src:1,dst:1,op:3},Sf[10]={src:1,dst:1,op:4};let Cf=0;class Tf{constructor(){this._shader=null,this.meshInstances=[],this.name="Untitled",this.userId="",this.id=Cf++,this.variants=new Map,this.parameters={},this.alphaTest=0,this.alphaToCoverage=!1,this._blendState=new Sp,this._depthState=new Ep,this.cull=1,this.stencilFront=null,this.stencilBack=null,this._shaderVersion=0,this._scene=null,this.dirty=!0}set depthBias(e){this._depthState.depthBias=e}get depthBias(){return this._depthState.depthBias}set slopeDepthBias(e){this._depthState.depthBiasSlope=e}get slopeDepthBias(){return this._depthState.depthBiasSlope}set redWrite(e){this._blendState.redWrite=e}get redWrite(){return this._blendState.redWrite}set greenWrite(e){this._blendState.greenWrite=e}get greenWrite(){return this._blendState.greenWrite}set blueWrite(e){this._blendState.blueWrite=e}get blueWrite(){return this._blendState.blueWrite}set alphaWrite(e){this._blendState.alphaWrite=e}get alphaWrite(){return this._blendState.alphaWrite}set shader(e){this._shader=e}get shader(){return this._shader}get transparent(){return this._blendState.blend}_updateTransparency(){const e=this.transparent,t=this.meshInstances;for(let s=0;s<t.length;s++)t[s].transparent=e}set blendState(e){this._blendState.copy(e),this._updateTransparency()}get blendState(){return this._blendState}set blendType(e){const t=Sf[e];this._blendState.setColorBlend(t.op,t.src,t.dst),this._blendState.setAlphaBlend(t.op,t.src,t.dst);const s=3!==e;this._blendState.blend!==s&&(this._blendState.blend=s,this._updateTransparency()),this._updateMeshInstanceKeys()}get blendType(){if(!this.transparent)return 3;const{colorOp:e,colorSrcFactor:t,colorDstFactor:s,alphaOp:i,alphaSrcFactor:n,alphaDstFactor:r}=this._blendState;for(let a=0;a<Sf.length;a++){const o=Sf[a];if(o.src===t&&o.dst===s&&o.op===e&&o.src===n&&o.dst===r&&o.op===i)return a}return 2}set depthState(e){this._depthState.copy(e)}get depthState(){return this._depthState}set depthTest(e){this._depthState.test=e}get depthTest(){return this._depthState.test}set depthFunc(e){this._depthState.func=e}get depthFunc(){return this._depthState.func}set depthWrite(e){this._depthState.write=e}get depthWrite(){return this._depthState.write}copy(e){var t;return this.name=e.name,this._shader=e._shader,this.alphaTest=e.alphaTest,this.alphaToCoverage=e.alphaToCoverage,this._blendState.copy(e._blendState),this._depthState.copy(e._depthState),this.cull=e.cull,this.stencilFront=null==(t=e.stencilFront)?void 0:t.clone(),e.stencilBack&&(this.stencilBack=e.stencilFront===e.stencilBack?this.stencilFront:e.stencilBack.clone()),this}clone(){return(new this.constructor).copy(this)}_updateMeshInstanceKeys(){const e=this.meshInstances;for(let t=0;t<e.length;t++)e[t].updateKey()}updateUniforms(e,t){}getShaderVariant(e,t,s,i,n,r,a,o,l){const h=new Rm(a,o,l);return hf(this._shader,h)}update(){this.dirty=!0,this._shader&&(this._shader.failed=!1)}clearParameters(){this.parameters={}}getParameters(){return this.parameters}clearVariants(){this.variants.clear();const e=this.meshInstances,t=e.length;for(let s=0;s<t;s++)e[s].clearShaders()}getParameter(e){return this.parameters[e]}setParameter(e,t){if(void 0===t&&"object"==typeof e){const s=e;if(s.length){for(let e=0;e<s.length;e++)this.setParameter(s[e]);return}e=s.name,t=s.value}const s=this.parameters[e];s?s.data=t:this.parameters[e]={scopeId:null,data:t}}deleteParameter(e){this.parameters[e]&&delete this.parameters[e]}setParameters(e,t){const s=this.parameters;void 0===t&&(t=s);for(const i in t){const t=s[i];t&&(t.scopeId||(t.scopeId=e.scope.resolve(i)),t.scopeId.setValue(t.data))}}destroy(){this.variants.clear(),this._shader=null;for(let e=0;e<this.meshInstances.length;e++){const t=this.meshInstances[e];if(t.clearShaders(),t._material=null,t.mesh){const e=wf(t.mesh.device);this!==e&&(t.material=e)}}this.meshInstances.length=0}addMeshInstanceRef(e){this.meshInstances.push(e)}removeMeshInstanceRef(e){const t=this.meshInstances,s=t.indexOf(e);-1!==s&&t.splice(s,1)}}class Af extends Tf{constructor(...e){super(...e),this.color=new jd(1,1,1,1),this.colorUniform=new Float32Array(4),this.colorMap=null,this.vertexColors=!1}copy(e){return super.copy(e),this.color.copy(e.color),this.colorMap=e.colorMap,this.vertexColors=e.vertexColors,this}updateUniforms(e,t){this.clearParameters(),this.colorUniform[0]=this.color.r,this.colorUniform[1]=this.color.g,this.colorUniform[2]=this.color.b,this.colorUniform[3]=this.color.a,this.setParameter("uColor",this.colorUniform),this.colorMap&&this.setParameter("texture_diffuseMap",this.colorMap)}getShaderVariant(e,t,s,i,n,r,a,o,l){const h={skin:s&&0!=(2&s),screenSpace:s&&0!=(s&I_),useInstancing:s&&0!=(32&s),useMorphPosition:s&&0!=(s&R_),useMorphNormal:s&&0!=(s&O_),useMorphTextureBased:s&&0!=(s&z_),alphaTest:this.alphaTest>0,vertexColors:this.vertexColors,diffuseMap:!!this.colorMap,pass:n},c=new Rm(a,o,l),d=nf(e);return d.register("basic",bf),d.getProgram("basic",h,c,this.userId)}}class Ef{constructor(e,t,s,i,n=[0]){this._ui=!1,this._sprite=!1,this._obj={model:[],element:[],sprite:[],render:[]},this.id=void 0,this.name=void 0,this.dynamic=void 0,this.maxAabbSize=void 0,this.layers=void 0,this.id=e,this.name=t,this.dynamic=s,this.maxAabbSize=i,this.layers=n}}Ef.MODEL="model",Ef.ELEMENT="element",Ef.SPRITE="sprite",Ef.RENDER="render";const Pf=new pu;class Mf{constructor(e){this.bones=void 0,this.boneTextureSize=void 0,this._dirty=!0,this._rootBone=null,this._skinUpdateIndex=-1,this._updateBeforeCull=!0,e&&this.initSkin(e)}set rootBone(e){this._rootBone=e}get rootBone(){return this._rootBone}init(e,t){if(e.supportsBoneTextures){const s=3*t;let i=Math.ceil(Math.sqrt(s));i=Wd.roundUp(i,3);const n=Math.ceil(s/i);this.boneTexture=new bm(e,{width:i,height:n,format:Du,mipmaps:!1,minFilter:0,magFilter:0,name:"skin"}),this.boneTextureSize=[i,n,1/i,1/n],this.matrixPalette=this.boneTexture.lock({mode:1}),this.boneTexture.unlock()}else this.matrixPalette=new Float32Array(12*t)}destroy(){this.boneTexture&&(this.boneTexture.destroy(),this.boneTexture=null)}resolve(e,t){this.rootBone=e;const s=this.skin,i=[];for(let n=0;n<s.boneNames.length;n++){const r=s.boneNames[n];let a=e.findByName(r);a||(a=t),i.push(a)}this.bones=i}initSkin(e){this.skin=e,this.bones=[];const t=e.inverseBindPose.length;this.init(e.device,t),this.matrices=[];for(let e=0;e<t;e++)this.matrices[e]=new pu}uploadBones(e){e.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())}_updateMatrices(e,t){if(this._skinUpdateIndex!==t){this._skinUpdateIndex=t,Pf.copy(e.getWorldTransform()).invert();for(let e=this.bones.length-1;e>=0;e--)this.matrices[e].mulAffine2(Pf,this.bones[e].getWorldTransform()),this.matrices[e].mulAffine2(this.matrices[e],this.skin.inverseBindPose[e])}}updateMatrices(e,t){this._updateBeforeCull&&this._updateMatrices(e,t)}updateMatrixPalette(e,t){this._updateMatrices(e,t);const s=this.matrixPalette,i=this.bones.length;for(let e=0;e<i;e++){const t=this.matrices[e].data,i=12*e;s[i]=t[0],s[i+1]=t[4],s[i+2]=t[8],s[i+3]=t[12],s[i+4]=t[1],s[i+5]=t[5],s[i+6]=t[9],s[i+7]=t[13],s[i+8]=t[2],s[i+9]=t[6],s[i+10]=t[10],s[i+11]=t[14]}this.uploadBones(this.skin.device)}}const Lf=new pu,Df=new nu,kf=new _u,If=new _u,Rf=new nu,Of=new nu,zf=new pu,Ff=new _u,Vf=new nu,Nf=new pu,Bf=new _u,Uf=new _u,Hf=new pu,Wf=new nu,Gf=new nu;function jf(e,t){return e instanceof Function?e:s=>{let i=s[e];return i instanceof Function&&(i=i()),i===t}}function qf(e,t){if(t(e))return e;const s=e._children,i=s.length;for(let e=0;e<i;++e){const i=qf(s[e],t);if(i)return i}return null}class Kf extends od{constructor(e="Untitled"){super(),this.name=void 0,this.tags=new Nd(this),this._labels={},this.localPosition=new nu,this.localRotation=new _u,this.localScale=new nu(1,1,1),this.localEulerAngles=new nu,this.position=new nu,this.rotation=new _u,this.eulerAngles=new nu,this._scale=null,this.localTransform=new pu,this._dirtyLocal=!1,this._aabbVer=0,this._frozen=!1,this.worldTransform=new pu,this._dirtyWorld=!1,this._worldScaleSign=0,this._normalMatrix=new ru,this._dirtyNormal=!0,this._right=null,this._up=null,this._forward=null,this._parent=null,this._children=[],this._graphDepth=0,this._enabled=!0,this._enabledInHierarchy=!1,this.scaleCompensation=!1,this.name=e}get right(){return this._right||(this._right=new nu),this.getWorldTransform().getX(this._right).normalize()}get up(){return this._up||(this._up=new nu),this.getWorldTransform().getY(this._up).normalize()}get forward(){return this._forward||(this._forward=new nu),this.getWorldTransform().getZ(this._forward).normalize().mulScalar(-1)}get normalMatrix(){const e=this._normalMatrix;return this._dirtyNormal&&(e.invertMat4(this.getWorldTransform()).transpose(),this._dirtyNormal=!1),e}set enabled(e){var t;this._enabled!==e&&(this._enabled=e,(e&&null!=(t=this._parent)&&t.enabled||!e)&&this._notifyHierarchyStateChanged(this,e))}get enabled(){return this._enabled&&this._enabledInHierarchy}get parent(){return this._parent}get path(){let e=this._parent;if(!e)return"";let t=this.name;for(;e&&e._parent;)t=`${e.name}/${t}`,e=e._parent;return t}get root(){let e=this;for(;e._parent;)e=e._parent;return e}get children(){return this._children}get graphDepth(){return this._graphDepth}_notifyHierarchyStateChanged(e,t){e._onHierarchyStateChanged(t);const s=e._children;for(let e=0,i=s.length;e<i;e++)s[e]._enabled&&this._notifyHierarchyStateChanged(s[e],t)}_onHierarchyStateChanged(e){this._enabledInHierarchy=e,e&&!this._frozen&&this._unfreezeParentToRoot()}_cloneInternal(e){e.name=this.name;const t=this.tags._list;e.tags.clear();for(let s=0;s<t.length;s++)e.tags.add(t[s]);e._labels=Object.assign({},this._labels),e.localPosition.copy(this.localPosition),e.localRotation.copy(this.localRotation),e.localScale.copy(this.localScale),e.localEulerAngles.copy(this.localEulerAngles),e.position.copy(this.position),e.rotation.copy(this.rotation),e.eulerAngles.copy(this.eulerAngles),e.localTransform.copy(this.localTransform),e._dirtyLocal=this._dirtyLocal,e.worldTransform.copy(this.worldTransform),e._dirtyWorld=this._dirtyWorld,e._dirtyNormal=this._dirtyNormal,e._aabbVer=this._aabbVer+1,e._enabled=this._enabled,e.scaleCompensation=this.scaleCompensation,e._enabledInHierarchy=!1}clone(){const e=new this.constructor;return this._cloneInternal(e),e}copy(e){return e._cloneInternal(this),this}destroy(){this.remove();const e=this._children;for(;e.length;){const t=e.pop();t._parent=null,t.destroy()}this.fire("destroy",this),this.off()}find(e,t){const s=[],i=jf(e,t);return this.forEach((e=>{i(e)&&s.push(e)})),s}findOne(e,t){return qf(this,jf(e,t))}findByTag(){const e=arguments,t=[],s=(i,n)=>{n&&i.tags.has(...e)&&t.push(i);for(let e=0;e<i._children.length;e++)s(i._children[e],!0)};return s(this,!1),t}findByName(e){return this.findOne("name",e)}findByPath(e){const t=Array.isArray(e)?e:e.split("/");let s=this;for(let e=0,i=t.length;e<i;++e)if(s=s.children.find((s=>s.name===t[e])),!s)return null;return s}forEach(e,t){e.call(t,this);const s=this._children,i=s.length;for(let n=0;n<i;++n)s[n].forEach(e,t)}isDescendantOf(e){let t=this._parent;for(;t;){if(t===e)return!0;t=t._parent}return!1}isAncestorOf(e){return e.isDescendantOf(this)}getEulerAngles(){return this.getWorldTransform().getEulerAngles(this.eulerAngles),this.eulerAngles}getLocalEulerAngles(){return this.localRotation.getEulerAngles(this.localEulerAngles),this.localEulerAngles}getLocalPosition(){return this.localPosition}getLocalRotation(){return this.localRotation}getLocalScale(){return this.localScale}getLocalTransform(){return this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this.localTransform}getPosition(){return this.getWorldTransform().getTranslation(this.position),this.position}getRotation(){return this.rotation.setFromMat4(this.getWorldTransform()),this.rotation}getScale(){return this._scale||(this._scale=new nu),this.getWorldTransform().getScale(this._scale)}getWorldTransform(){return this._dirtyLocal||this._dirtyWorld?(this._parent&&this._parent.getWorldTransform(),this._sync(),this.worldTransform):this.worldTransform}get worldScaleSign(){return 0===this._worldScaleSign&&(this._worldScaleSign=this.getWorldTransform().scaleSign),this._worldScaleSign}remove(){var e;null==(e=this._parent)||e.removeChild(this)}reparent(e,t){this.remove(),e&&(t>=0?e.insertChild(this,t):e.addChild(this))}setLocalEulerAngles(e,t,s){this.localRotation.setFromEulerAngles(e,t,s),this._dirtyLocal||this._dirtifyLocal()}setLocalPosition(e,t,s){e instanceof nu?this.localPosition.copy(e):this.localPosition.set(e,t,s),this._dirtyLocal||this._dirtifyLocal()}setLocalRotation(e,t,s,i){e instanceof _u?this.localRotation.copy(e):this.localRotation.set(e,t,s,i),this._dirtyLocal||this._dirtifyLocal()}setLocalScale(e,t,s){e instanceof nu?this.localScale.copy(e):this.localScale.set(e,t,s),this._dirtyLocal||this._dirtifyLocal()}_dirtifyLocal(){this._dirtyLocal||(this._dirtyLocal=!0,this._dirtyWorld||this._dirtifyWorld())}_unfreezeParentToRoot(){let e=this._parent;for(;e;)e._frozen=!1,e=e._parent}_dirtifyWorld(){this._dirtyWorld||this._unfreezeParentToRoot(),this._dirtifyWorldInternal()}_dirtifyWorldInternal(){if(!this._dirtyWorld){this._frozen=!1,this._dirtyWorld=!0;for(let e=0;e<this._children.length;e++)this._children[e]._dirtyWorld||this._children[e]._dirtifyWorldInternal()}this._dirtyNormal=!0,this._worldScaleSign=0,this._aabbVer++}setPosition(e,t,s){e instanceof nu?Vf.copy(e):Vf.set(e,t,s),null===this._parent?this.localPosition.copy(Vf):(Nf.copy(this._parent.getWorldTransform()).invert(),Nf.transformPoint(Vf,this.localPosition)),this._dirtyLocal||this._dirtifyLocal()}setRotation(e,t,s,i){if(e instanceof _u?Bf.copy(e):Bf.set(e,t,s,i),null===this._parent)this.localRotation.copy(Bf);else{const e=this._parent.getRotation();Uf.copy(e).invert(),this.localRotation.copy(Uf).mul(Bf)}this._dirtyLocal||this._dirtifyLocal()}setEulerAngles(e,t,s){if(this.localRotation.setFromEulerAngles(e,t,s),null!==this._parent){const e=this._parent.getRotation();Uf.copy(e).invert(),this.localRotation.mul2(Uf,this.localRotation)}this._dirtyLocal||this._dirtifyLocal()}addChild(e){this._prepareInsertChild(e),this._children.push(e),this._onInsertChild(e)}addChildAndSaveTransform(e){const t=e.getPosition(),s=e.getRotation();this._prepareInsertChild(e),e.setPosition(zf.copy(this.worldTransform).invert().transformPoint(t)),e.setRotation(Ff.copy(this.getRotation()).invert().mul(s)),this._children.push(e),this._onInsertChild(e)}insertChild(e,t){this._prepareInsertChild(e),this._children.splice(t,0,e),this._onInsertChild(e)}_prepareInsertChild(e){e.remove()}_fireOnHierarchy(e,t,s){this.fire(e,s);for(let e=0;e<this._children.length;e++)this._children[e]._fireOnHierarchy(t,t,s)}_onInsertChild(e){e._parent=this;const t=e._enabled&&this.enabled;e._enabledInHierarchy!==t&&(e._enabledInHierarchy=t,e._notifyHierarchyStateChanged(e,t)),e._updateGraphDepth(),e._dirtifyWorld(),this._frozen&&e._unfreezeParentToRoot(),e._fireOnHierarchy("insert","inserthierarchy",this),this.fire&&this.fire("childinsert",e)}_updateGraphDepth(){this._graphDepth=this._parent?this._parent._graphDepth+1:0;for(let e=0,t=this._children.length;e<t;e++)this._children[e]._updateGraphDepth()}removeChild(e){const t=this._children.indexOf(e);-1!==t&&(this._children.splice(t,1),e._parent=null,e._fireOnHierarchy("remove","removehierarchy",this),this.fire("childremove",e))}_sync(){if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){let e;const t=this._parent;let s=this.localScale,i=t;if(i){for(;i&&i.scaleCompensation;)i=i._parent;i&&(i=i._parent,i&&(e=i.worldTransform.getScale(),Rf.mul2(e,this.localScale),s=Rf))}If.setFromMat4(t.worldTransform),kf.mul2(If,this.localRotation);let n=t.worldTransform;t.scaleCompensation&&(Of.mul2(e,t.getLocalScale()),Lf.setTRS(t.worldTransform.getTranslation(Df),If,Of),n=Lf),n.transformPoint(this.localPosition,Df),this.worldTransform.setTRS(Df,kf,s)}else this.worldTransform.mulAffine2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=!1}}syncHierarchy(){if(!this._enabled)return;if(this._frozen)return;this._frozen=!0,(this._dirtyLocal||this._dirtyWorld)&&this._sync();const e=this._children;for(let t=0,s=e.length;t<s;t++)e[t].syncHierarchy()}lookAt(e,t,s,i=0,n=1,r=0){if(e instanceof nu)Wf.copy(e),t instanceof nu?Gf.copy(t):Gf.copy(nu.UP);else{if(void 0===s)return;Wf.set(e,t,s),Gf.set(i,n,r)}Hf.setLookAt(this.getPosition(),Wf,Gf),Bf.setFromMat4(Hf),this.setRotation(Bf)}translate(e,t,s){e instanceof nu?Vf.copy(e):Vf.set(e,t,s),Vf.add(this.getPosition()),this.setPosition(Vf)}translateLocal(e,t,s){e instanceof nu?Vf.copy(e):Vf.set(e,t,s),this.localRotation.transformVector(Vf,Vf),this.localPosition.add(Vf),this._dirtyLocal||this._dirtifyLocal()}rotate(e,t,s){if(Bf.setFromEulerAngles(e,t,s),null===this._parent)this.localRotation.mul2(Bf,this.localRotation);else{const e=this.getRotation(),t=this._parent.getRotation();Uf.copy(t).invert(),Bf.mul2(Uf,Bf),this.localRotation.mul2(Bf,e)}this._dirtyLocal||this._dirtifyLocal()}rotateLocal(e,t,s){Bf.setFromEulerAngles(e,t,s),this.localRotation.mul(Bf),this._dirtyLocal||this._dirtifyLocal()}}class Xf{static incRef(e){this.cache.incRef(e)}static decRef(e){this.cache.decRef(e)}static destroy(){this.cache.destroy()}}Xf.cache=new class{constructor(){this.cache=new Map}destroy(){this.cache.forEach(((e,t)=>{t.destroy()})),this.cache.clear()}incRef(e){const t=(this.cache.get(e)||0)+1;this.cache.set(e,t)}decRef(e){if(e){let t=this.cache.get(e);t&&(t--,0===t?(this.cache.delete(e),e.destroy()):this.cache.set(e,t))}}};let Yf=0;const Zf=new xu,$f=new xu,Qf=new Cu,Jf=new Set;class eg{constructor(e){this.vertexBuffer=null,this.count=e}}class tg{constructor(){this.shader=void 0,this.bindGroup=null}getBindGroup(e){if(!this.bindGroup){const t=this.shader,s=t.meshUniformBufferFormat,i=new vm(e,s,!1),n=t.meshBindGroupFormat;this.bindGroup=new _m(e,n,i)}return this.bindGroup}destroy(){const e=this.bindGroup;var t;e&&(null==(t=e.defaultUniformBuffer)||t.destroy(),e.destroy(),this.bindGroup=null)}}class sg{constructor(){this.shaderInstances=new Map}destroy(){this.shaderInstances.forEach((e=>e.destroy())),this.shaderInstances.clear()}}class ig{constructor(e,t,s=null){if(this.visible=!0,this.castShadow=!1,this.transparent=!1,this._material=null,this._shaderCache=[],this.id=Yf++,this.pick=!0,e instanceof Kf){const i=e;e=t,t=s,s=i}this._key=[0,0],this.node=s,this._mesh=e,e.incRefCount(),this.material=t,this._shaderDefs=65536,this._shaderDefs|=e.vertexBuffer.format.hasUv0?4:0,this._shaderDefs|=e.vertexBuffer.format.hasUv1?8:0,this._shaderDefs|=e.vertexBuffer.format.hasColor?16:0,this._shaderDefs|=e.vertexBuffer.format.hasTangents?512:0,this.layer=15,this._renderStyle=0,this._receiveShadow=!0,this._screenSpace=!1,this.cull=!0,this._updateAabb=!0,this._updateAabbFunc=null,this._calculateSortDistance=null,this.updateKey(),this._skinInstance=null,this._morphInstance=null,this.gsplatInstance=null,this.instancingData=null,this._customAabb=null,this.aabb=new xu,this._aabbVer=-1,this._aabbMeshVer=-1,this.drawOrder=0,this.visibleThisFrame=!1,this.isVisibleFunc=null,this.parameters={},this.stencilFront=null,this.stencilBack=null,this.flipFacesFactor=1}set renderStyle(e){this._renderStyle=e,this.mesh.prepareRenderState(e)}get renderStyle(){return this._renderStyle}set mesh(e){e!==this._mesh&&(this._mesh&&this._mesh.decRefCount(),this._mesh=e,e&&e.incRefCount())}get mesh(){return this._mesh}set aabb(e){this._aabb=e}get aabb(){if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);let e=this._customAabb,t=!!e;if(!e)if(e=Zf,this.skinInstance){if(!this.mesh.boneAabb){const e=this._morphInstance?this._morphInstance.morph._targets:null;this.mesh._initBoneAabbs(e)}const s=this.mesh.boneUsed;let i=!0;for(let t=0;t<this.mesh.boneAabb.length;t++)s[t]&&($f.setFromTransformedAabb(this.mesh.boneAabb[t],this.skinInstance.matrices[t]),i?(i=!1,e.center.copy($f.center),e.halfExtents.copy($f.halfExtents)):e.add($f));t=!0}else if(this.node._aabbVer!==this._aabbVer||this.mesh._aabbVer!==this._aabbMeshVer){if(this.mesh?(e.center.copy(this.mesh.aabb.center),e.halfExtents.copy(this.mesh.aabb.halfExtents)):(e.center.set(0,0,0),e.halfExtents.set(0,0,0)),this.mesh&&this.mesh.morph){const t=this.mesh.morph.aabb;e._expand(t.getMin(),t.getMax())}t=!0,this._aabbVer=this.node._aabbVer,this._aabbMeshVer=this.mesh._aabbVer}return t&&this._aabb.setFromTransformedAabb(e,this.node.getWorldTransform()),this._aabb}clearShaders(){const e=this._shaderCache;for(let s=0;s<e.length;s++){var t;null==(t=e[s])||t.destroy(),e[s]=null}}getShaderInstance(e,t,s,i,n,r){let a,o=this._shaderCache[e];if(o?a=o.shaderInstances.get(t):(o=new sg,this._shaderCache[e]=o),!a){const l=this._material,h=this._shaderDefs,c=e+"_"+h+"_"+t;if(a=new tg,a.shader=l.variants.get(c),!a.shader){const t=l.getShaderVariant(this.mesh.device,s,h,null,e,r,i,n,this._mesh.vertexBuffer.format);l.variants.set(c,t),a.shader=t}o.shaderInstances.set(t,a)}return a}set material(e){this.clearShaders();const t=this._material;t&&t.removeMeshInstanceRef(this),this._material=e,e&&(e.addMeshInstanceRef(this),this.transparent=e.transparent,this.updateKey())}get material(){return this._material}set layer(e){this._layer=e,this.updateKey()}get layer(){return this._layer}_updateShaderDefs(e){e!==this._shaderDefs&&(this._shaderDefs=e,this.clearShaders())}set calculateSortDistance(e){this._calculateSortDistance=e}get calculateSortDistance(){return this._calculateSortDistance}set receiveShadow(e){this._receiveShadow!==e&&(this._receiveShadow=e,this._updateShaderDefs(e?-2&this._shaderDefs:1|this._shaderDefs))}get receiveShadow(){return this._receiveShadow}set skinInstance(e){this._skinInstance=e,this._updateShaderDefs(e?2|this._shaderDefs:-3&this._shaderDefs),this._setupSkinUpdate()}get skinInstance(){return this._skinInstance}set morphInstance(e){var t;null==(t=this._morphInstance)||t.destroy(),this._morphInstance=e;let s=this._shaderDefs;s=e&&e.morph.useTextureMorph?s|z_:-4097&s,s=e&&e.morph.morphPositions?s|R_:-1025&s,s=e&&e.morph.morphNormals?s|O_:-2049&s,this._updateShaderDefs(s)}get morphInstance(){return this._morphInstance}set screenSpace(e){this._screenSpace!==e&&(this._screenSpace=e,this._updateShaderDefs(e?this._shaderDefs|I_:-257&this._shaderDefs))}get screenSpace(){return this._screenSpace}set key(e){this._key[0]=e}get key(){return this._key[0]}set mask(e){const t=65535&this._shaderDefs;this._updateShaderDefs(t|e<<16)}get mask(){return this._shaderDefs>>16}set instancingCount(e){this.instancingData&&(this.instancingData.count=e)}get instancingCount(){return this.instancingData?this.instancingData.count:0}destroy(){var e,t;const s=this.mesh;s&&(this.mesh=null,s.refCount<1&&s.destroy()),this.setRealtimeLightmap(ig.lightmapParamNames[0],null),this.setRealtimeLightmap(ig.lightmapParamNames[1],null),null==(e=this._skinInstance)||e.destroy(),this._skinInstance=null,null==(t=this.morphInstance)||t.destroy(),this.morphInstance=null,this.clearShaders(),this.material=null}static _prepareRenderStyleForArray(e,t){if(e){for(let s=0;s<e.length;s++){e[s]._renderStyle=t;const i=e[s].mesh;Jf.has(i)||(Jf.add(i),i.prepareRenderState(t))}Jf.clear()}}_isVisible(e){return!!this.visible&&(this.isVisibleFunc?this.isVisibleFunc(e):(Qf.center=this.aabb.center,Qf.radius=this._aabb.halfExtents.length(),e.frustum.containsSphere(Qf)))}updateKey(){const e=this.material,t=e.alphaToCoverage||e.alphaTest?2:e.blendType;this._key[0]=(15&this.layer)<<27|(3===t?1:0)<<26|(33554431&e.id)<<0}setInstancing(e,t=!1){e?(this.instancingData=new eg(e.numVertices),this.instancingData.vertexBuffer=e,e.format.instancing=!0,this.cull=t):(this.instancingData=null,this.cull=!0),this._updateShaderDefs(e?32|this._shaderDefs:-33&this._shaderDefs)}ensureMaterial(e){this.material||(this.material=wf(e))}clearParameters(){this.parameters={}}getParameters(){return this.parameters}getParameter(e){return this.parameters[e]}setParameter(e,t,s=-262141){if(void 0===t&&"object"==typeof e){const s=e;if(s.length){for(let e=0;e<s.length;e++)this.setParameter(s[e]);return}e=s.name,t=s.value}const i=this.parameters[e];i?(i.data=t,i.passFlags=s):this.parameters[e]={scopeId:null,data:t,passFlags:s}}setRealtimeLightmap(e,t){const s=this.getParameter(e);s!==t&&(s&&Xf.decRef(s.data),t?(Xf.incRef(t),this.setParameter(e,t)):this.deleteParameter(e))}deleteParameter(e){this.parameters[e]&&delete this.parameters[e]}setParameters(e,t){const s=this.parameters;for(const i in s){const n=s[i];n.passFlags&t&&(n.scopeId||(n.scopeId=e.scope.resolve(i)),n.scopeId.setValue(n.data))}}setLightmapped(e){e?this.mask=-6&(2|this.mask):(this.setRealtimeLightmap(ig.lightmapParamNames[0],null),this.setRealtimeLightmap(ig.lightmapParamNames[1],null),this._shaderDefs&=-8385,this.mask=-7&(1|this.mask))}setCustomAabb(e){e?this._customAabb?this._customAabb.copy(e):this._customAabb=e.clone():(this._customAabb=null,this._aabbVer=-1),this._setupSkinUpdate()}_setupSkinUpdate(){this._skinInstance&&(this._skinInstance._updateBeforeCull=!this._customAabb)}}ig.lightmapParamNames=["texture_lightMap","texture_dirLightMap"],new ru;const ng=["uSceneColorMap","texture_grabPass"];class rg extends Im{constructor(...e){super(...e),this.colorRenderTarget=null,this.source=null}destroy(){super.destroy(),this.releaseRenderTarget(this.colorRenderTarget)}shouldReallocate(e,t,s){if((null==e?void 0:e.colorBuffer.format)!==s)return!0;const i=(null==t?void 0:t.width)||this.device.width,n=(null==t?void 0:t.height)||this.device.height;return!e||i!==e.width||n!==e.height}allocateRenderTarget(e,t,s,i){const n=s.isWebGL2,r=new bm(s,{name:ng[0],format:i,width:t?t.colorBuffer.width:s.width,height:t?t.colorBuffer.height:s.height,mipmaps:n,minFilter:n?5:1,magFilter:1,addressU:1,addressV:1});return e?(e.destroyFrameBuffers(),e._colorBuffer=r,e._colorBuffers=[r]):e=new qp({name:"ColorGrabRT",colorBuffer:r,depth:!1,stencil:!1,autoResolve:!1}),e}releaseRenderTarget(e){e&&(e.destroyTextureBuffers(),e.destroy())}frameUpdate(){var e;const t=this.device,s=this.source,i=null!=(e=null==s?void 0:s.colorBuffer.format)?e:this.device.backBufferFormat;this.shouldReallocate(this.colorRenderTarget,null==s?void 0:s.colorBuffer,i)&&(this.releaseRenderTarget(this.colorRenderTarget),this.colorRenderTarget=this.allocateRenderTarget(this.colorRenderTarget,s,t,i));const n=this.colorRenderTarget.colorBuffer;ng.forEach((e=>t.scope.resolve(e).setValue(n)))}execute(){const e=this.device,t=this.source,s=this.colorRenderTarget.colorBuffer;if(e.isWebGPU)e.copyRenderTarget(t,this.colorRenderTarget,!0,!1),e.mipmapRenderer.generate(this.colorRenderTarget.colorBuffer.impl);else if(e.isWebGL2)e.copyRenderTarget(t,this.colorRenderTarget,!0,!1),e.activeTexture(e.maxCombinedTextures-1),e.bindTexture(s),e.gl.generateMipmap(s.impl._glTarget);else{s.impl._glTexture||s.impl.initialize(e,s),e.bindTexture(s);const t=e.gl;t.copyTexImage2D(t.TEXTURE_2D,0,s.impl._glFormat,0,0,s.width,s.height,0),s._needsUpload=!1,s._needsMipmapsUpload=!1}}}const ag=["uSceneDepthMap","uDepthMap"];class og extends Im{constructor(e,t){super(e),this.depthRenderTarget=null,this.camera=null,this.camera=t}destroy(){super.destroy(),this.releaseRenderTarget(this.depthRenderTarget)}shouldReallocate(e,t){const s=(null==t?void 0:t.width)||this.device.width,i=(null==t?void 0:t.height)||this.device.height;return!e||s!==e.width||i!==e.height}allocateRenderTarget(e,t,s,i,n){const r=new bm(s,{name:ag[0],format:i,width:t?t.colorBuffer.width:s.width,height:t?t.colorBuffer.height:s.height,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1});return e?(e.destroyFrameBuffers(),n?e._depthBuffer=r:(e._colorBuffer=r,e._colorBuffers=[r])):e=new qp({name:"DepthGrabRT",colorBuffer:n?null:r,depthBuffer:n?r:null,depth:!n,stencil:s.supportsStencil,autoResolve:!1}),e}releaseRenderTarget(e){e&&(e.destroyTextureBuffers(),e.destroy())}before(){var e,t,s,i;const n=this.camera,r=this.device,a=null!=(e=null==n?void 0:n.renderTarget)?e:r.backBuffer;let o=!0,l=a.stencil?17:16;if(r.isWebGPU){a.samples>1&&(l=ku,o=!1)}const h=null!=(t=null==(s=n.renderTarget)?void 0:s.depthBuffer)?t:null==(i=n.renderTarget)?void 0:i.colorBuffer;this.shouldReallocate(this.depthRenderTarget,h)&&(this.releaseRenderTarget(this.depthRenderTarget),this.depthRenderTarget=this.allocateRenderTarget(this.depthRenderTarget,n.renderTarget,r,l,o));const c=o?this.depthRenderTarget.depthBuffer:this.depthRenderTarget.colorBuffer;ag.forEach((e=>r.scope.resolve(e).setValue(c)))}execute(){const e=this.device;if(e.isWebGL2&&e.renderTarget.samples>1){const t=e.renderTarget.impl._glFrameBuffer,s=this.depthRenderTarget;e.renderTarget=s,e.updateBegin(),this.depthRenderTarget.impl.internalResolve(e,t,s.impl._glFrameBuffer,this.depthRenderTarget,e.gl.DEPTH_BUFFER_BIT)}else e.copyRenderTarget(e.renderTarget,this.depthRenderTarget,!1,!0)}}const lg=new jd(254/255,254/255,254/255,254/255),hg=[],cg=[[],[],[]],dg=["uSceneDepthMap","uDepthMap"];class ug extends Im{constructor(e,t,s){super(e),this.renderer=t,this.camera=s,this.setupRenderTarget()}destroy(){super.destroy(),this.renderTarget&&(this.renderTarget.destroyTextureBuffers(),this.renderTarget.destroy(),this.renderTarget=null)}update(e){this.scene=e}setupRenderTarget(){const e=new bm(this.device,{name:dg[0],format:7,width:4,height:4,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1}),t=new qp({name:`${dg[0]}RT}`,colorBuffer:e,depth:!0,stencil:!1});this.init(t,{}),this.setClearColor(lg),this.setClearDepth(1)}before(){const e=this.device,t=this.renderTarget.colorBuffer;dg.forEach((s=>e.scope.resolve(s).setValue(t)))}execute(){const{device:e,renderer:t,camera:s,scene:i,renderTarget:n}=this,r=i.layers.layerList,a=i.layers.subLayerEnabled,o=i.layers.subLayerList;for(let i=0;i<r.length;i++){const h=r[i];if(h.enabled&&a[i]&&h.camerasSet.has(s)){if(1===h.id)break;const r=h.getCulledInstances(s),a=o[i]?r.transparent:r.opaque;for(let e=0;e<a.length;e++){var l;const t=a[e];null!=(l=t.material)&&l.depthWrite&&hg.push(t)}t.setCameraUniforms(s,n),t.renderForward(s,hg,cg,2,(t=>{e.setBlendState(Sp.NOBLEND)}),h),hg.length=0}}}}const pg=new nu,mg=new nu,_g=new nu,fg=new pu,gg=[new nu,new nu,new nu,new nu,new nu,new nu,new nu,new nu];class vg{constructor(){this.shaderPassInfo=null,this.renderPassColorGrab=null,this.renderPassDepthGrab=null,this.renderPasses=[],this.jitter=0,this._aspectRatio=16/9,this._aspectRatioMode=0,this._calculateProjection=null,this._calculateTransform=null,this._clearColor=new jd(.75,.75,.75,1),this._clearColorBuffer=!0,this._clearDepth=1,this._clearDepthBuffer=!0,this._clearStencil=0,this._clearStencilBuffer=!0,this._cullFaces=!0,this._farClip=1e3,this._flipFaces=!1,this._fov=45,this._frustumCulling=!0,this._horizontalFov=!1,this._layers=[0,1,2,4,3],this._layersSet=new Set(this._layers),this._nearClip=.1,this._node=null,this._orthoHeight=10,this._projection=0,this._rect=new ou(0,0,1,1),this._renderTarget=null,this._scissorRect=new ou(0,0,1,1),this._scissorRectClear=!1,this._aperture=16,this._shutter=.001,this._sensitivity=1e3,this._projMat=new pu,this._projMatDirty=!0,this._projMatSkybox=new pu,this._viewMat=new pu,this._viewMatDirty=!0,this._viewProjMat=new pu,this._viewProjMatDirty=!0,this._shaderMatricesVersion=0,this._viewProjInverse=new pu,this._viewProjCurrent=null,this._viewProjPrevious=new pu,this._jitters=[0,0,0,0],this.frustum=new Tu,this._xr=null,this._xrProperties={horizontalFov:this._horizontalFov,fov:this._fov,aspectRatio:this._aspectRatio,farClip:this._farClip,nearClip:this._nearClip}}destroy(){var e,t;null==(e=this.renderPassColorGrab)||e.destroy(),this.renderPassColorGrab=null,null==(t=this.renderPassDepthGrab)||t.destroy(),this.renderPassDepthGrab=null,this.renderPasses.length=0}_storeShaderMatrices(e,t,s,i){var n;this._shaderMatricesVersion!==i&&(this._shaderMatricesVersion=i,this._viewProjPrevious.copy(null!=(n=this._viewProjCurrent)?n:e),null!=this._viewProjCurrent||(this._viewProjCurrent=new pu),this._viewProjCurrent.copy(e),this._viewProjInverse.invert(e),this._jitters[2]=this._jitters[0],this._jitters[3]=this._jitters[1],this._jitters[0]=t,this._jitters[1]=s)}get fullSizeClearRect(){const e=this._scissorRectClear?this.scissorRect:this._rect;return 0===e.x&&0===e.y&&1===e.z&&1===e.w}set aspectRatio(e){this._aspectRatio!==e&&(this._aspectRatio=e,this._projMatDirty=!0)}get aspectRatio(){var e;return null!=(e=this.xr)&&e.active?this._xrProperties.aspectRatio:this._aspectRatio}set aspectRatioMode(e){this._aspectRatioMode!==e&&(this._aspectRatioMode=e,this._projMatDirty=!0)}get aspectRatioMode(){return this._aspectRatioMode}set calculateProjection(e){this._calculateProjection=e,this._projMatDirty=!0}get calculateProjection(){return this._calculateProjection}set calculateTransform(e){this._calculateTransform=e}get calculateTransform(){return this._calculateTransform}set clearColor(e){this._clearColor.copy(e)}get clearColor(){return this._clearColor}set clearColorBuffer(e){this._clearColorBuffer=e}get clearColorBuffer(){return this._clearColorBuffer}set clearDepth(e){this._clearDepth=e}get clearDepth(){return this._clearDepth}set clearDepthBuffer(e){this._clearDepthBuffer=e}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencil(e){this._clearStencil=e}get clearStencil(){return this._clearStencil}set clearStencilBuffer(e){this._clearStencilBuffer=e}get clearStencilBuffer(){return this._clearStencilBuffer}set cullFaces(e){this._cullFaces=e}get cullFaces(){return this._cullFaces}set farClip(e){this._farClip!==e&&(this._farClip=e,this._projMatDirty=!0)}get farClip(){var e;return null!=(e=this.xr)&&e.active?this._xrProperties.farClip:this._farClip}set flipFaces(e){this._flipFaces=e}get flipFaces(){return this._flipFaces}set fov(e){this._fov!==e&&(this._fov=e,this._projMatDirty=!0)}get fov(){var e;return null!=(e=this.xr)&&e.active?this._xrProperties.fov:this._fov}set frustumCulling(e){this._frustumCulling=e}get frustumCulling(){return this._frustumCulling}set horizontalFov(e){this._horizontalFov!==e&&(this._horizontalFov=e,this._projMatDirty=!0)}get horizontalFov(){var e;return null!=(e=this.xr)&&e.active?this._xrProperties.horizontalFov:this._horizontalFov}set layers(e){this._layers=e.slice(0),this._layersSet=new Set(this._layers)}get layers(){return this._layers}get layersSet(){return this._layersSet}set nearClip(e){this._nearClip!==e&&(this._nearClip=e,this._projMatDirty=!0)}get nearClip(){var e;return null!=(e=this.xr)&&e.active?this._xrProperties.nearClip:this._nearClip}set node(e){this._node=e}get node(){return this._node}set orthoHeight(e){this._orthoHeight!==e&&(this._orthoHeight=e,this._projMatDirty=!0)}get orthoHeight(){return this._orthoHeight}set projection(e){this._projection!==e&&(this._projection=e,this._projMatDirty=!0)}get projection(){return this._projection}get projectionMatrix(){return this._evaluateProjectionMatrix(),this._projMat}set rect(e){this._rect.copy(e)}get rect(){return this._rect}set renderTarget(e){this._renderTarget=e}get renderTarget(){return this._renderTarget}set scissorRect(e){this._scissorRect.copy(e)}get scissorRect(){return this._scissorRect}get viewMatrix(){if(this._viewMatDirty){const e=this._node.getWorldTransform();this._viewMat.copy(e).invert(),this._viewMatDirty=!1}return this._viewMat}set aperture(e){this._aperture=e}get aperture(){return this._aperture}set sensitivity(e){this._sensitivity=e}get sensitivity(){return this._sensitivity}set shutter(e){this._shutter=e}get shutter(){return this._shutter}set xr(e){this._xr!==e&&(this._xr=e,this._projMatDirty=!0)}get xr(){return this._xr}clone(){return(new vg).copy(this)}copy(e){return this._aspectRatio=e._aspectRatio,this._farClip=e._farClip,this._fov=e._fov,this._horizontalFov=e._horizontalFov,this._nearClip=e._nearClip,this._xrProperties.aspectRatio=e._xrProperties.aspectRatio,this._xrProperties.farClip=e._xrProperties.farClip,this._xrProperties.fov=e._xrProperties.fov,this._xrProperties.horizontalFov=e._xrProperties.horizontalFov,this._xrProperties.nearClip=e._xrProperties.nearClip,this.aspectRatioMode=e.aspectRatioMode,this.calculateProjection=e.calculateProjection,this.calculateTransform=e.calculateTransform,this.clearColor=e.clearColor,this.clearColorBuffer=e.clearColorBuffer,this.clearDepth=e.clearDepth,this.clearDepthBuffer=e.clearDepthBuffer,this.clearStencil=e.clearStencil,this.clearStencilBuffer=e.clearStencilBuffer,this.cullFaces=e.cullFaces,this.flipFaces=e.flipFaces,this.frustumCulling=e.frustumCulling,this.layers=e.layers,this.orthoHeight=e.orthoHeight,this.projection=e.projection,this.rect=e.rect,this.renderTarget=e.renderTarget,this.scissorRect=e.scissorRect,this.aperture=e.aperture,this.shutter=e.shutter,this.sensitivity=e.sensitivity,this.shaderPassInfo=e.shaderPassInfo,this.jitter=e.jitter,this._projMatDirty=!0,this}_enableRenderPassColorGrab(e,t){var s;t?this.renderPassColorGrab||(this.renderPassColorGrab=new rg(e)):(null==(s=this.renderPassColorGrab)||s.destroy(),this.renderPassColorGrab=null)}_enableRenderPassDepthGrab(e,t,s){var i;s?this.renderPassDepthGrab||(this.renderPassDepthGrab=e.isWebGL1?new ug(e,t,this):new og(e,this)):(null==(i=this.renderPassDepthGrab)||i.destroy(),this.renderPassDepthGrab=null)}_updateViewProjMat(){(this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty)&&(this._viewProjMat.mul2(this.projectionMatrix,this.viewMatrix),this._viewProjMatDirty=!1)}worldToScreen(e,t,s,i=new nu){this._updateViewProjMat(),this._viewProjMat.transformPoint(e,i);const n=this._viewProjMat.data,r=e.x*n[3]+e.y*n[7]+e.z*n[11]+1*n[15];return i.x=.5*(i.x/r+1)*t,i.y=.5*(1-i.y/r)*s,i}screenToWorld(e,t,s,i,n,r=new nu){const a=this.farClip-this.nearClip;if(pg.set(e/i,(n-t)/n,s/a),pg.mulScalar(2),pg.sub(nu.ONE),0===this._projection){pu._getPerspectiveHalfSize(mg,this.fov,this.aspectRatio,this.nearClip,this.horizontalFov),mg.x*=pg.x,mg.y*=pg.y;const e=this._node.getWorldTransform();mg.z=-this.nearClip,e.transformPoint(mg,_g);const t=this._node.getPosition();r.sub2(_g,t),r.normalize(),r.mulScalar(s),r.add(t)}else this._updateViewProjMat(),fg.copy(this._viewProjMat).invert(),fg.transformPoint(pg,r);return r}_evaluateProjectionMatrix(){if(this._projMatDirty){if(0===this._projection)this._projMat.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip,this.horizontalFov),this._projMatSkybox.copy(this._projMat);else{const e=this._orthoHeight,t=e*this.aspectRatio;this._projMat.setOrtho(-t,t,-e,e,this.nearClip,this.farClip),this._projMatSkybox.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip)}this._projMatDirty=!1}}getProjectionMatrixSkybox(){return this._evaluateProjectionMatrix(),this._projMatSkybox}getExposure(){const e=Math.log2(this._aperture*this._aperture/this._shutter*100/this._sensitivity);return 1/(1.2*Math.pow(2,e))}getScreenSize(e){if(0===this._projection){const t=this._node.getPosition().distance(e.center);if(t<e.radius)return 1;const s=Math.asin(e.radius/t),i=Math.tan(s),n=Math.tan(this.fov/2*Wd.DEG_TO_RAD);return Math.min(i/n,1)}return Wd.clamp(e.radius/this._orthoHeight,0,1)}getFrustumCorners(e=this.nearClip,t=this.farClip){const s=this.fov*Math.PI/180;let i=0===this._projection?Math.tan(s/2)*e:this._orthoHeight,n=i*this.aspectRatio;const r=gg;return r[0].x=n,r[0].y=-i,r[0].z=-e,r[1].x=n,r[1].y=i,r[1].z=-e,r[2].x=-n,r[2].y=i,r[2].z=-e,r[3].x=-n,r[3].y=-i,r[3].z=-e,0===this._projection&&(i=Math.tan(s/2)*t,n=i*this.aspectRatio),r[4].x=n,r[4].y=-i,r[4].z=-t,r[5].x=n,r[5].y=i,r[5].z=-t,r[6].x=-n,r[6].y=i,r[6].z=-t,r[7].x=-n,r[7].y=-i,r[7].z=-t,r}setXrProperties(e){Object.assign(this._xrProperties,e),this._projMatDirty=!0}}class yg{constructor(){this.hasTangents=!1,this.chunks={},this.pass=0,this.alphaTest=!1,this.blendType=3,this.separateAmbient=!1,this.screenSpace=!1,this.skin=!1,this.useInstancing=!1,this.useMorphPosition=!1,this.useMorphNormal=!1,this.useMorphTextureBased=!1,this.nineSlicedMode=0,this.clusteredLightingEnabled=!0,this.clusteredLightingCookiesEnabled=!1,this.clusteredLightingShadowsEnabled=!1,this.clusteredLightingShadowType=0,this.clusteredLightingAreaLightsEnabled=!1,this.vertexColors=!1,this.lightMapEnabled=!1,this.dirLightMapEnabled=!1,this.useHeights=!1,this.useNormals=!1,this.useClearCoatNormals=!1,this.useAo=!1,this.diffuseMapEnabled=!1,this.useAmbientTint=!1,this.customFragmentShader=null,this.pixelSnap=!1,this.shadingModel=0,this.ambientSH=!1,this.fastTbn=!1,this.twoSidedLighting=!1,this.occludeDirect=!1,this.occludeSpecular=0,this.occludeSpecularFloat=!1,this.useMsdf=!1,this.msdfTextAttribute=!1,this.alphaToCoverage=!1,this.opacityFadesSpecular=!1,this.opacityDither=V_,this.opacityShadowDither=V_,this.cubeMapProjection=0,this.conserveEnergy=!1,this.useSpecular=!1,this.useSpecularityFactor=!1,this.enableGGXSpecular=!1,this.fresnelModel=0,this.useRefraction=!1,this.useClearCoat=!1,this.useSheen=!1,this.useIridescence=!1,this.useMetalness=!1,this.useDynamicRefraction=!1,this.fog=D_,this.gamma=0,this.toneMap=-1,this.fixSeams=!1,this.reflectionSource=null,this.reflectionEncoding=null,this.reflectionCubemapEncoding=null,this.ambientSource="constant",this.ambientEncoding=null,this.skyboxIntensity=1,this.useCubeMapRotation=!1,this.lightMapWithoutAmbient=!1,this.lights=[],this.noShadow=!1,this.lightMaskDynamic=0,this.userAttributes={}}}class bg{static update(e,t,s,i,n,r){bg.updateSharedOptions(e,t,s,i,n),bg.updateMaterialOptions(e,t),bg.updateEnvOptions(e,t,s),bg.updateLightingOptions(e,t,i,r),1===n&&(e.gamma=3,e.toneMap=0)}static updateSharedOptions(e,t,s,i,n){e.chunks=t.chunks,e.pass=n,e.alphaTest=t.alphaTest>0,e.blendType=t.blendType,e.screenSpace=i&&0!=(i&I_),e.skin=i&&0!=(2&i),e.useInstancing=i&&0!=(32&i),e.useMorphPosition=i&&0!=(i&R_),e.useMorphNormal=i&&0!=(i&O_),e.useMorphTextureBased=i&&0!=(i&z_),e.hasTangents=i&&0!=(512&i),e.nineSlicedMode=t.nineSlicedMode||0,t.useLighting&&s.clusteredLightingEnabled?(e.clusteredLightingEnabled=!0,e.clusteredLightingCookiesEnabled=s.lighting.cookiesEnabled,e.clusteredLightingShadowsEnabled=s.lighting.shadowsEnabled,e.clusteredLightingShadowType=s.lighting.shadowType,e.clusteredLightingAreaLightsEnabled=s.lighting.areaLightsEnabled):(e.clusteredLightingEnabled=!1,e.clusteredLightingCookiesEnabled=!1,e.clusteredLightingShadowsEnabled=!1,e.clusteredLightingAreaLightsEnabled=!1)}static updateMaterialOptions(e,t){e.useAmbientTint=!1,e.separateAmbient=!1,e.customFragmentShader=null,e.pixelSnap=t.pixelSnap,e.shadingModel=t.shadingModel,e.ambientSH=t.ambientSH,e.fastTbn=t.fastTbn,e.twoSidedLighting=t.twoSidedLighting,e.occludeDirect=t.occludeDirect,e.occludeSpecular=t.occludeSpecular,e.occludeSpecularFloat=1!==t.occludeSpecularIntensity,e.useMsdf=!1,e.msdfTextAttribute=!1,e.alphaToCoverage=t.alphaToCoverage,e.opacityFadesSpecular=t.opacityFadesSpecular,e.opacityDither=t.opacityDither,e.opacityShadowDither=t.opacityShadowDither,e.cubeMapProjection=0,e.conserveEnergy=t.conserveEnergy&&1===t.shadingModel,e.useSpecular=t.hasSpecular,e.useSpecularityFactor=t.hasSpecularityFactor,e.enableGGXSpecular=t.ggxSpecular,e.fresnelModel=t.fresnelModel,e.useRefraction=t.hasRefraction,e.useClearCoat=t.hasClearCoat,e.useSheen=t.hasSheen,e.useIridescence=t.hasIrridescence,e.useMetalness=t.hasMetalness,e.useDynamicRefraction=t.dynamicRefraction,e.vertexColors=!1,e.lightMapEnabled=t.hasLighting,e.dirLightMapEnabled=t.dirLightMap,e.useHeights=t.hasHeights,e.useNormals=t.hasNormals,e.useClearCoatNormals=t.hasClearCoatNormals,e.useAo=t.hasAo,e.diffuseMapEnabled=t.hasDiffuseMap}static updateEnvOptions(e,t,s){e.fog=t.useFog?s.fog:"none",e.gamma=t.useGammaTonemap?s.gammaCorrection:0,e.toneMap=t.useGammaTonemap?s.toneMapping:-1,e.fixSeams=!1,t.useSkybox&&s.envAtlas&&s.skybox?(e.reflectionSource="envAtlasHQ",e.reflectionEncoding=s.envAtlas.encoding,e.reflectionCubemapEncoding=s.skybox.encoding):t.useSkybox&&s.envAtlas?(e.reflectionSource="envAtlas",e.reflectionEncoding=s.envAtlas.encoding):t.useSkybox&&s.skybox?(e.reflectionSource="cubeMap",e.reflectionEncoding=s.skybox.encoding):(e.reflectionSource=null,e.reflectionEncoding=null),t.ambientSH?(e.ambientSource="ambientSH",e.ambientEncoding=null):e.reflectionSource&&s.envAtlas?(e.ambientSource="envAtlas",e.ambientEncoding=s.envAtlas.encoding):(e.ambientSource="constant",e.ambientEncoding=null);const i=!!e.reflectionSource;e.skyboxIntensity=i&&(1!==s.skyboxIntensity||s.physicalUnits),e.useCubeMapRotation=i&&s._skyboxRotationShaderInclude}static updateLightingOptions(e,t,s,i){if(e.lightMapWithoutAmbient=!1,t.useLighting){const t=[],n=s?s>>16:1;e.lightMaskDynamic=!!(1&n),e.lightMapWithoutAmbient=!1,i&&(bg.collectLights(0,i[0],t,n),bg.collectLights(1,i[1],t,n),bg.collectLights(2,i[2],t,n)),e.lights=t}else e.lights=[];0!==e.lights.length&&0==(1&s)||(e.noShadow=!0)}static collectLights(e,t,s,i){for(let e=0;e<t.length;e++){const n=t[e];n.enabled&&n.mask&i&&s.push(n)}}}class xg{constructor(){this.code=""}append(...e){e.forEach((e=>{e.endsWith("\n")?this.code+=e:this.code+=e+"\n"}))}prepend(...e){e.forEach((e=>{e.endsWith("\n")?this.code=e+this.code:this.code=e+"\n"+this.code}))}}const wg={linear:"decodeLinear",srgb:"decodeGamma",rgbm:"decodeRGBM",rgbe:"decodeRGBE",rgbp:"decodeRGBP"},Sg={linear:"encodeLinear",srgb:"encodeGamma",rgbm:"encodeRGBM",rgbe:"encodeRGBE",rgbp:"encodeRGBP"};class Cg{static decodeFunc(e){return wg[e]||"decodeGamma"}static encodeFunc(e){return Sg[e]||"encodeGamma"}}const Tg=new pu,Ag=new pu,Eg=new pu;class Pg{static create(e,t,s){const i=new vg;switch(i.node=new Kf(e),i.aspectRatio=1,i.aspectRatioMode=1,i._scissorRectClear=!0,t){case 1:i.node.setRotation(Pg.pointLightRotations[s]),i.fov=90,i.projection=0;break;case 2:i.projection=0;break;case 0:i.projection=1}return i}static evalSpotCookieMatrix(e){let t=Pg._spotCookieCamera;t||(t=Pg.create("SpotCookieCamera",2),Pg._spotCookieCamera=t),t.fov=2*e._outerConeAngle;const s=t._node;s.setPosition(e._node.getPosition()),s.setRotation(e._node.getRotation()),s.rotateLocal(-90,0,0),Tg.setTRS(s.getPosition(),s.getRotation(),nu.ONE).invert(),Ag.mul2(t.projectionMatrix,Tg);const i=e.cookieMatrix,n=e.atlasViewport;return Eg.setViewport(n.x,n.y,n.z,n.w),i.mul2(Eg,Ag),i}}Pg.pointLightRotations=[(new _u).setFromEulerAngles(0,90,180),(new _u).setFromEulerAngles(0,-90,180),(new _u).setFromEulerAngles(90,0,0),(new _u).setFromEulerAngles(-90,0,0),(new _u).setFromEulerAngles(0,180,180),(new _u).setFromEulerAngles(0,0,180)],Pg._spotCookieCamera=null;const Mg=new nu,Lg=new Float32Array(6),Dg=new nu(-.5,0,0),kg=new nu(0,0,.5),Ig={FLAGS:0,COLOR_A:1,COLOR_B:2,SPOT_ANGLES:3,SHADOW_BIAS:4,COOKIE_A:5,COOKIE_B:6,COUNT_ALWAYS:7,POSITION_X:7,POSITION_Y:8,POSITION_Z:9,RANGE:10,SPOT_DIRECTION_X:11,SPOT_DIRECTION_Y:12,SPOT_DIRECTION_Z:13,PROJ_MAT_00:14,ATLAS_VIEWPORT_A:14,PROJ_MAT_01:15,ATLAS_VIEWPORT_B:15,PROJ_MAT_02:16,PROJ_MAT_03:17,PROJ_MAT_10:18,PROJ_MAT_11:19,PROJ_MAT_12:20,PROJ_MAT_13:21,PROJ_MAT_20:22,PROJ_MAT_21:23,PROJ_MAT_22:24,PROJ_MAT_23:25,PROJ_MAT_30:26,PROJ_MAT_31:27,PROJ_MAT_32:28,PROJ_MAT_33:29,AREA_DATA_WIDTH_X:30,AREA_DATA_WIDTH_Y:31,AREA_DATA_WIDTH_Z:32,AREA_DATA_HEIGHT_X:33,AREA_DATA_HEIGHT_Y:34,AREA_DATA_HEIGHT_Z:35,COUNT:36},Rg={POSITION_RANGE:0,SPOT_DIRECTION:1,PROJ_MAT_0:2,ATLAS_VIEWPORT:2,PROJ_MAT_1:3,PROJ_MAT_2:4,PROJ_MAT_3:5,AREA_DATA_WIDTH:6,AREA_DATA_HEIGHT:7,COUNT:8},Og=new zp;class zg{static getLightTextureFormat(e){return e.extTextureFloat&&e.maxTextures>8?0:1}static getShaderDefines(e){return Og.get(e,(()=>{const t=(e,t,s,i)=>Object.keys(t).map((e=>`#define ${s}${e} ${t[e]}${i}`)).join("\n"),s=0===zg.getLightTextureFormat(e)?"FLOAT":"8BIT",i=e.supportsTextureFetch?"":".5";return`\n\t\t\t\t\t\t\t\t\n#define CLUSTER_TEXTURE_${s}\n\t\t\t\t\t\t\t\t${t(0,Ig,"CLUSTER_TEXTURE_8_",i)}\n\t\t\t\t\t\t\t\t${t(0,Rg,"CLUSTER_TEXTURE_F_",i)}\n\t\t\t\t\t\t`}))}constructor(e){this.device=e,this.cookiesEnabled=!1,this.shadowsEnabled=!1,this.areaLightsEnabled=!1,this.maxLights=255;let t=Ig.COUNT_ALWAYS,s=0;this.lightTextureFormat=zg.getLightTextureFormat(e),0===this.lightTextureFormat?s=Rg.COUNT:t=Ig.COUNT,this.lights8=new Uint8ClampedArray(4*t*this.maxLights),this.lightsTexture8=this.createTexture(this.device,t,this.maxLights,7,"LightsTexture8"),this._lightsTexture8Id=this.device.scope.resolve("lightsTexture8"),s?(this.lightsFloat=new Float32Array(4*s*this.maxLights),this.lightsTextureFloat=this.createTexture(this.device,s,this.maxLights,Du,"LightsTextureFloat"),this._lightsTextureFloatId=this.device.scope.resolve("lightsTextureFloat")):(this.lightsFloat=null,this.lightsTextureFloat=null,this._lightsTextureFloatId=void 0),this._lightsTextureInvSizeId=this.device.scope.resolve("lightsTextureInvSize"),this._lightsTextureInvSizeData=new Float32Array(4),this._lightsTextureInvSizeData[0]=s?1/this.lightsTextureFloat.width:0,this._lightsTextureInvSizeData[1]=s?1/this.lightsTextureFloat.height:0,this._lightsTextureInvSizeData[2]=1/this.lightsTexture8.width,this._lightsTextureInvSizeData[3]=1/this.lightsTexture8.height,this.invMaxColorValue=0,this.invMaxAttenuation=0,this.boundsMin=new nu,this.boundsDelta=new nu}destroy(){this.lightsTexture8&&(this.lightsTexture8.destroy(),this.lightsTexture8=null),this.lightsTextureFloat&&(this.lightsTextureFloat.destroy(),this.lightsTextureFloat=null)}createTexture(e,t,s,i,n){return new bm(e,{name:n,width:t,height:s,mipmaps:!1,format:i,addressU:1,addressV:1,type:ep,magFilter:0,minFilter:0,anisotropy:1})}setCompressionRanges(e,t){this.invMaxColorValue=1/t,this.invMaxAttenuation=1/e}setBounds(e,t){this.boundsMin.copy(e),this.boundsDelta.copy(t)}uploadTextures(){this.lightsTextureFloat&&(this.lightsTextureFloat.lock().set(this.lightsFloat),this.lightsTextureFloat.unlock()),this.lightsTexture8.lock().set(this.lights8),this.lightsTexture8.unlock()}updateUniforms(){this._lightsTexture8Id.setValue(this.lightsTexture8),0===this.lightTextureFormat&&this._lightsTextureFloatId.setValue(this.lightsTextureFloat),this._lightsTextureInvSizeId.setValue(this._lightsTextureInvSizeData)}getSpotDirection(e,t){t._node.getWorldTransform().getY(e).mulScalar(-1),e.normalize()}getLightAreaSizes(e){const t=e._node.getWorldTransform();return t.transformVector(Dg,Mg),Lg[0]=Mg.x,Lg[1]=Mg.y,Lg[2]=Mg.z,t.transformVector(kg,Mg),Lg[3]=Mg.x,Lg[4]=Mg.y,Lg[5]=Mg.z,Lg}addLightDataFlags(e,t,s,i,n,r){e[t+0]=i?255:0,e[t+1]=64*s._shape,e[t+2]=255*s._falloffMode,e[t+3]=n?255*r:0}addLightDataColor(e,t,s,i,n){const r=this.invMaxColorValue,a=i?s._linearFinalColor:s._finalColor;Qd.float2Bytes(a[0]*r,e,t+0,2),Qd.float2Bytes(a[1]*r,e,t+2,2),Qd.float2Bytes(a[2]*r,e,t+4,2),e[t+6]=n?255:0;const o=!!(1&s.mask),l=!!(2&s.mask);e[t+7]=o&&l?127:l?255:0}addLightDataSpotAngles(e,t,s){Qd.float2Bytes(.499999*s._innerConeAngleCos+.5,e,t+0,2),Qd.float2Bytes(.499999*s._outerConeAngleCos+.5,e,t+2,2)}addLightDataShadowBias(e,t,s){const i=s.getRenderData(null,0),n=s._getUniformBiasValues(i);Qd.float2BytesRange(n.bias,e,t,-1,20,2),Qd.float2Bytes(n.normalBias,e,t+2,2)}addLightDataPositionRange(e,t,s,i){const n=Mg.sub2(i,this.boundsMin).div(this.boundsDelta);Qd.float2Bytes(n.x,e,t+0,4),Qd.float2Bytes(n.y,e,t+4,4),Qd.float2Bytes(n.z,e,t+8,4),Qd.float2Bytes(s.attenuationEnd*this.invMaxAttenuation,e,t+12,4)}addLightDataSpotDirection(e,t,s){this.getSpotDirection(Mg,s),Qd.float2Bytes(.499999*Mg.x+.5,e,t+0,4),Qd.float2Bytes(.499999*Mg.y+.5,e,t+4,4),Qd.float2Bytes(.499999*Mg.z+.5,e,t+8,4)}addLightDataLightProjMatrix(e,t,s){const i=s.data;for(let s=0;s<12;s++)Qd.float2BytesRange(i[s],e,t+4*s,-2,2,4);for(let s=12;s<16;s++)Qd.float2MantissaExponent(i[s],e,t+4*s,4)}addLightDataCookies(e,t,s){const i="rgb"===s._cookieChannel;if(e[t+0]=Math.floor(255*s.cookieIntensity),e[t+1]=i?255:0,!i){const i=s._cookieChannel;e[t+4]="rrr"===i?255:0,e[t+5]="ggg"===i?255:0,e[t+6]="bbb"===i?255:0,e[t+7]="aaa"===i?255:0}}addLightAtlasViewport(e,t,s){Qd.float2Bytes(s.x,e,t+0,2),Qd.float2Bytes(s.y,e,t+2,2),Qd.float2Bytes(s.z/3,e,t+4,2)}addLightAreaSizes(e,t,s){const i=this.getLightAreaSizes(s);for(let s=0;s<6;s++)Qd.float2MantissaExponent(i[s],e,t+4*s,4)}addLightData(e,t,s){const i=2===e._type,n=e.atlasViewportAllocated,r=this.cookiesEnabled&&!!e._cookie&&n,a=this.areaLightsEnabled&&0!==e.shape,o=this.shadowsEnabled&&e.castShadows&&n,l=e._node.getPosition();let h=null,c=null;if(i)if(o){h=e.getRenderData(null,0).shadowMatrix}else r&&(h=Pg.evalSpotCookieMatrix(e));else(o||r)&&(c=e.atlasViewport);const d=this.lights8,u=t*this.lightsTexture8.width*4;if(this.addLightDataFlags(d,u+4*Ig.FLAGS,e,i,o,e.shadowIntensity),this.addLightDataColor(d,u+4*Ig.COLOR_A,e,s,r),i&&this.addLightDataSpotAngles(d,u+4*Ig.SPOT_ANGLES,e),e.castShadows&&this.addLightDataShadowBias(d,u+4*Ig.SHADOW_BIAS,e),r&&this.addLightDataCookies(d,u+4*Ig.COOKIE_A,e),0===this.lightTextureFormat){const s=this.lightsFloat,n=t*this.lightsTextureFloat.width*4;if(s[n+4*Rg.POSITION_RANGE+0]=l.x,s[n+4*Rg.POSITION_RANGE+1]=l.y,s[n+4*Rg.POSITION_RANGE+2]=l.z,s[n+4*Rg.POSITION_RANGE+3]=e.attenuationEnd,i&&(this.getSpotDirection(Mg,e),s[n+4*Rg.SPOT_DIRECTION+0]=Mg.x,s[n+4*Rg.SPOT_DIRECTION+1]=Mg.y,s[n+4*Rg.SPOT_DIRECTION+2]=Mg.z),h){const e=h.data;for(let t=0;t<16;t++)s[n+4*Rg.PROJ_MAT_0+t]=e[t]}if(c&&(s[n+4*Rg.ATLAS_VIEWPORT+0]=c.x,s[n+4*Rg.ATLAS_VIEWPORT+1]=c.y,s[n+4*Rg.ATLAS_VIEWPORT+2]=c.z/3),a){const t=this.getLightAreaSizes(e);s[n+4*Rg.AREA_DATA_WIDTH+0]=t[0],s[n+4*Rg.AREA_DATA_WIDTH+1]=t[1],s[n+4*Rg.AREA_DATA_WIDTH+2]=t[2],s[n+4*Rg.AREA_DATA_HEIGHT+0]=t[3],s[n+4*Rg.AREA_DATA_HEIGHT+1]=t[4],s[n+4*Rg.AREA_DATA_HEIGHT+2]=t[5]}}else this.addLightDataPositionRange(d,u+4*Ig.POSITION_X,e,l),i&&this.addLightDataSpotDirection(d,u+4*Ig.SPOT_DIRECTION_X,e),h&&this.addLightDataLightProjMatrix(d,u+4*Ig.PROJ_MAT_00,h),c&&this.addLightAtlasViewport(d,u+4*Ig.ATLAS_VIEWPORT_A,c),a&&this.addLightAreaSizes(d,u+4*Ig.AREA_DATA_WIDTH_X,e)}}const Fg={vertex_normal:zu,vertex_tangent:Fu,vertex_texCoord0:Hu,vertex_texCoord1:Wu,vertex_color:Bu,vertex_boneWeights:Vu,vertex_boneIndices:Nu},Vg={vVertexColor:"vec4",vPositionW:"vec3",vNormalV:"vec3",vNormalW:"vec3",vTangentW:"vec3",vBinormalW:"vec3",vObjectSpaceUpW:"vec3",vUv0:"vec2",vUv1:"vec2"};class Ng{constructor(e,t){if(this.device=e,this.options=t,this.attributes={vertex_position:Ou},t.userAttributes)for(const[e,s]of Object.entries(t.userAttributes))this.attributes[s]=e;if(t.chunks){const e=t.chunks;this.chunks=Object.create(tf);for(const t in tf)if(e.hasOwnProperty(t)){const s=e[t];for(const e in Fg)Fg.hasOwnProperty(e)&&s.indexOf(e)>=0&&(this.attributes[e]=Fg[e]);this.chunks[t]=s}}else this.chunks=tf;this.shaderPassInfo=yf.get(this.device).getByIndex(t.pass),this.shadowPass=this.shaderPassInfo.isShadow,this.lighting=t.lights.length>0||t.dirLightMapEnabled||t.clusteredLightingEnabled,this.reflections=!!t.reflectionSource,this.needsNormal=this.lighting||this.reflections||t.useSpecular||t.ambientSH||t.useHeights||t.enableGGXSpecular||t.clusteredLightingEnabled&&!this.shadowPass||t.useClearCoatNormals,this.needsNormal=this.needsNormal&&!this.shadowPass,this.needsSceneColor=t.useDynamicRefraction,this.needsScreenSize=t.useDynamicRefraction,this.needsTransforms=t.useDynamicRefraction,this.varyings="",this.varyingDefines="",this.vshader=null,this.frontendDecl=null,this.frontendCode=null,this.frontendFunc=null,this.lightingUv=null,this.defines=[],this.fshader=null}_vsAddBaseCode(e,t,s){return e+=t.baseVS,1!==s.nineSlicedMode&&2!==s.nineSlicedMode||(e+=t.baseNineSlicedVS),e}_vsAddTransformCode(e,t,s,i){return e+=this.chunks.transformVS}_setMapTransform(e,t,s,i){const n=s+100*i;if(!e[3][n]){const r=`texture_${t}MapTransform`;e[0]+=`uniform vec3 ${r}0;\n`,e[0]+=`uniform vec3 ${r}1;\n`,e[1]+=`varying vec2 vUV${i}_${s};\n`,e[2]+=`   vUV${i}_${s} = vec2(dot(vec3(uv${i}, 1), ${r}0), dot(vec3(uv${i}, 1), ${r}1));\n`,e[3][n]=!0}return e}_fsGetBaseCode(){const e=this.options,t=this.chunks;let s=this.chunks.basePS;return 1===e.nineSlicedMode?s+=t.baseNineSlicedPS:2===e.nineSlicedMode&&(s+=t.baseNineSlicedTiledPS),s}_fsGetStartCode(e,t,s,i){let n=s.startPS;return 1===i.nineSlicedMode?n+=s.startNineSlicedPS:2===i.nineSlicedMode&&(n+=s.startNineSlicedTiledPS),n}_getLightSourceShapeString(e){switch(e){case 1:return"Rect";case 2:return"Disk";case 3:return"Sphere";default:return""}}generateVertexShader(e,t,s){const i=this.device,n=this.options,r=this.chunks;let a="",o="";a=this._vsAddBaseCode(a,r,n),o+="   vPositionW    = getWorldPosition();\n",2===this.options.pass&&(a+="varying float vDepth;\n",a+="#ifndef VIEWMATRIX\n",a+="#define VIEWMATRIX\n",a+="uniform mat4 matrix_view;\n",a+="#endif\n",a+="#ifndef CAMERAPLANES\n",a+="#define CAMERAPLANES\n",a+="uniform vec4 camera_params;\n\n",a+="#endif\n",o+="    vDepth = -(matrix_view * vec4(vPositionW,1.0)).z * camera_params.x;\n"),this.options.pass,this.options.useInstancing&&(this.attributes.instance_line1=Zu,this.attributes.instance_line2=$u,this.attributes.instance_line3=Qu,this.attributes.instance_line4=Ju,a+=r.instancingVS),this.needsNormal&&(this.attributes.vertex_normal=zu,o+="   vNormalW = getNormal();\n","sphereMap"===n.reflectionSource&&i.fragmentUniformsCount<=16&&(a+=r.viewNormalVS,o+="   vNormalV    = getViewNormal();\n"),n.hasTangents&&(n.useHeights||n.useNormals||n.enableGGXSpecular)?(this.attributes.vertex_tangent=Fu,a+=r.tangentBinormalVS,o+="   vTangentW   = getTangent();\n",o+="   vBinormalW  = getBinormal();\n"):!n.enableGGXSpecular&&i.extStandardDerivatives||(o+="   vObjectSpaceUpW = normalize(dNormalMatrix * vec3(0, 1, 0));\n"));for(let s=0;s<2;s++)e[s]&&(this.attributes["vertex_texCoord"+s]="TEXCOORD"+s,a+=r["uv"+s+"VS"],o+="   vec2 uv"+s+" = getUv"+s+"();\n"),t[s]&&(o+="   vUv"+s+" = uv"+s+";\n");const l=[a,this.varyings,o,[]];if(s.forEach((e=>{this._setMapTransform(l,e.name,e.id,e.uv)})),a=l[0],this.varyings=l[1],o=l[2],n.vertexColors&&(this.attributes.vertex_color=Bu,o+="   vVertexColor = vertex_color;\n"),n.useMsdf&&n.msdfTextAttribute&&(this.attributes.vertex_outlineParameters=qu,this.attributes.vertex_shadowParameters=Ku,o+="    unpackMsdfParams();\n",a+=r.msdfVS),n.useMorphPosition||n.useMorphNormal)if(n.useMorphTextureBased){a+="#define MORPHING_TEXTURE_BASED\n",n.useMorphPosition&&(a+="#define MORPHING_TEXTURE_BASED_POSITION\n"),n.useMorphNormal&&(a+="#define MORPHING_TEXTURE_BASED_NORMAL\n"),this.attributes.morph_vertex_id=Ju;const e=i.isWebGPU?"uint":"float";a+=`attribute ${e} morph_vertex_id;\n`}else a+="#define MORPHING\n",n.useMorphPosition?(this.attributes.morph_pos0=qu,this.attributes.morph_pos1=Ku,this.attributes.morph_pos2=Xu,this.attributes.morph_pos3=Yu,a+="#define MORPHING_POS03\n",a+="attribute vec3 morph_pos0;\n",a+="attribute vec3 morph_pos1;\n",a+="attribute vec3 morph_pos2;\n",a+="attribute vec3 morph_pos3;\n"):n.useMorphNormal&&(this.attributes.morph_nrm0=qu,this.attributes.morph_nrm1=Ku,this.attributes.morph_nrm2=Xu,this.attributes.morph_nrm3=Yu,a+="#define MORPHING_NRM03\n",a+="attribute vec3 morph_nrm0;\n",a+="attribute vec3 morph_nrm1;\n",a+="attribute vec3 morph_nrm2;\n",a+="attribute vec3 morph_nrm3;\n"),n.useMorphNormal?(this.attributes.morph_nrm4=Zu,this.attributes.morph_nrm5=$u,this.attributes.morph_nrm6=Qu,this.attributes.morph_nrm7=Ju,a+="#define MORPHING_NRM47\n",a+="attribute vec3 morph_nrm4;\n",a+="attribute vec3 morph_nrm5;\n",a+="attribute vec3 morph_nrm6;\n",a+="attribute vec3 morph_nrm7;\n"):(this.attributes.morph_pos4=Zu,this.attributes.morph_pos5=$u,this.attributes.morph_pos6=Qu,this.attributes.morph_pos7=Ju,a+="#define MORPHING_POS47\n",a+="attribute vec3 morph_pos4;\n",a+="attribute vec3 morph_pos5;\n",a+="attribute vec3 morph_pos6;\n",a+="attribute vec3 morph_pos7;\n");n.skin?(this.attributes.vertex_boneWeights=Vu,this.attributes.vertex_boneIndices=Nu,a+=af.skinCode(i,r),a+="#define SKIN\n"):n.useInstancing&&(a+="#define INSTANCING\n"),n.screenSpace&&(a+="#define SCREENSPACE\n"),n.pixelSnap&&(a+="#define PIXELSNAP\n"),a=this._vsAddTransformCode(a,i,r,n),this.needsNormal&&(a+=r.normalVS),a+="\n",a+=r.startVS,a+=o,a+=r.endVS,a+="}",Object.keys(Vg).forEach((e=>{a.indexOf(e)>=0&&(this.varyings+=`varying ${Vg[e]} ${e};\n`,this.varyingDefines+=`#define VARYING_${e.toUpperCase()}\n`)}));const h=this.shaderPassInfo.shaderDefines;this.vshader=h+this.varyings+a}_fsGetBeginCode(){let e=this.shaderPassInfo.shaderDefines;for(let t=0;t<this.defines.length;t++)e+=`#define ${this.defines[t]}\n`;return e}_fsGetPickPassCode(){let e=this._fsGetBeginCode();return e+="uniform vec4 uColor;\n",e+=this.varyings,e+=this.varyingDefines,e+=this.frontendDecl,e+=this.frontendCode,e+=af.begin(),e+=this.frontendFunc,e+="    gl_FragColor = uColor;\n",e+=af.end(),e}_fsGetDepthPassCode(){const e=this.chunks;let t=this._fsGetBeginCode();return t+="varying float vDepth;\n",t+=this.varyings,t+=this.varyingDefines,t+=e.packDepthPS,t+=this.frontendDecl,t+=this.frontendCode,t+=af.begin(),t+=this.frontendFunc,t+="    gl_FragColor = packFloat(vDepth);\n",t+=af.end(),t}_fsGetPrePassVelocityCode(){return"\n\t\t\t\t\t\tvoid main(void)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tgl_FragColor = vec4(1, 0, 0, 1);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t"}_fsGetShadowPassCode(){const e=this.device,t=this.options,s=this.chunks,i=this.varyings,n=this.shaderPassInfo.lightType;let r=this.shaderPassInfo.shadowType;0!==n&&t.clusteredLightingEnabled&&(1!==r&&2!==r&&3!==r&&6!==r||(r=0));let a=this._fsGetBeginCode();e.extStandardDerivatives&&e.isWebGL1&&(a+="uniform vec2 polygonOffset;\n"),3===r?e.textureFloatHighPrecision?a+="#define VSM_EXPONENT 15.0\n\n":a+="#define VSM_EXPONENT 5.54\n\n":2===r&&(a+="#define VSM_EXPONENT 5.54\n\n"),0!==n&&(a+="uniform vec3 view_position;\n",a+="uniform float light_radius;\n"),a+=i,a+=this.varyingDefines,a+=this.frontendDecl,a+=this.frontendCode;const o=5===r||0===r||4===r||6===r,l=1===n&&6!==r&&!t.clusteredLightingEnabled,h=o&&!e.supportsDepthShadow||l;h?a+=s.packDepthPS:1===r&&(a+="vec2 encodeFloatRG( float v ) {\n",a+="    vec2 enc = vec2(1.0, 255.0) * v;\n",a+="    enc = fract(enc);\n",a+="    enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n",a+="    return enc;\n",a+="}\n\n"),6===r&&(a+=tf.linearizeDepthPS),a+=af.begin(),a+=this.frontendFunc;const c=1===r||2===r||3===r;let d=!1;if(0===n||!c&&2===n?a+="    float depth = gl_FragCoord.z;\n":(a+="    float depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);\n",d=!0),e.isWebGL1&&e.extStandardDerivatives&&(a+="    float minValue = 2.3374370500153186e-10; //(1.0 / 255.0) / (256.0 * 256.0 * 256.0);\n",a+="    depth += polygonOffset.x * max(abs(dFdx(depth)), abs(dFdy(depth))) + minValue * polygonOffset.y;\n",d=!0),h)a+="    gl_FragColor = packFloat(depth);\n";else if(c)a+=1===r?"    gl_FragColor = vec4(encodeFloatRG(depth), encodeFloatRG(depth*depth));\n":s.storeEVSMPS;else{6===r?a+="    gl_FragColor.r = depth;\n":(d&&(a+="    gl_FragDepth = depth;\n"),a+="    gl_FragColor = vec4(1.0);\n")}return a+=af.end(),a}_fsGetLitPassCode(){const e=this.device,t=this.options,s=this.chunks,i=new xg,n=new xg,r=new xg,a=new xg;!1===t.opacityFadesSpecular&&i.append("uniform float material_alphaFade;"),t.useSpecular&&(this.defines.push("LIT_SPECULAR"),this.reflections&&this.defines.push("LIT_REFLECTIONS"),t.useClearCoat&&this.defines.push("LIT_CLEARCOAT"),t.fresnelModel>0&&this.defines.push("LIT_SPECULAR_FRESNEL"),t.conserveEnergy&&this.defines.push("LIT_CONSERVE_ENERGY"),t.useSheen&&this.defines.push("LIT_SHEEN"),t.useIridescence&&this.defines.push("LIT_IRIDESCENCE"));const o=[];let l=0,h=!1,c=!1,d=!1,u=t.lights.some((function(e){return e._shape&&0!==e._shape}));t.clusteredLightingEnabled&&t.clusteredLightingAreaLightsEnabled&&(u=!0);let p="highp";7===e.areaLightLutFormat&&(i.append("#define AREA_R8_G8_B8_A8_LUTS"),p="lowp"),(u||t.clusteredLightingEnabled)&&(i.append("#define AREA_LIGHTS"),i.append(`uniform ${p} sampler2D areaLightsLutTex1;`),i.append(`uniform ${p} sampler2D areaLightsLutTex2;`));for(let s=0;s<t.lights.length;s++){const n=t.lights[s],r=n._type;if(t.clusteredLightingEnabled&&0!==r)continue;const a=u&&n._shape?n._shape:0;i.append("uniform vec3 light"+s+"_color;"),6===n._shadowType&&n.castShadows&&!t.noShadow&&(i.append(`uniform float light${s}_shadowSearchArea;`),i.append(`uniform vec4 light${s}_cameraParams;`)),0===r?i.append("uniform vec3 light"+s+"_direction;"):(i.append("uniform vec3 light"+s+"_position;"),i.append("uniform float light"+s+"_radius;"),2===r&&(i.append("uniform vec3 light"+s+"_direction;"),i.append("uniform float light"+s+"_innerConeAngle;"),i.append("uniform float light"+s+"_outerConeAngle;"))),0!==a&&(0===r&&i.append("uniform vec3 light"+s+"_position;"),i.append("uniform vec3 light"+s+"_halfWidth;"),i.append("uniform vec3 light"+s+"_halfHeight;")),n.castShadows&&!t.noShadow&&(i.append("uniform mat4 light"+s+"_shadowMatrix;"),i.append("uniform float light"+s+"_shadowIntensity;"),0===r&&(i.append("uniform mat4 light"+s+"_shadowMatrixPalette[4];"),i.append("uniform float light"+s+"_shadowCascadeDistances[4];"),i.append("uniform float light"+s+"_shadowCascadeCount;")),i.append("uniform vec4 light"+s+"_shadowParams;"),0===r&&(h=!0),1===r?i.append("uniform samplerCube light"+s+"_shadowMap;"):n._isPcf&&e.supportsDepthShadow?i.append("uniform sampler2DShadow light"+s+"_shadowMap;"):i.append("uniform sampler2D light"+s+"_shadowMap;"),l++,o[n._shadowType]=!0,n._isVsm&&(c=!0),6===n._shadowType&&(d=!0)),n._cookie&&(n._cookie._cubemap?1===r&&(i.append("uniform samplerCube light"+s+"_cookie;"),i.append("uniform float light"+s+"_cookieIntensity;"),n.castShadows&&!t.noShadow||i.append("uniform mat4 light"+s+"_shadowMatrix;")):2===r&&(i.append("uniform sampler2D light"+s+"_cookie;"),i.append("uniform float light"+s+"_cookieIntensity;"),n.castShadows&&!t.noShadow||i.append("uniform mat4 light"+s+"_shadowMatrix;"),n._cookieTransform&&(i.append("uniform vec4 light"+s+"_cookieMatrix;"),i.append("uniform vec2 light"+s+"_cookieOffset;"))))}const m=this.needsNormal&&(t.useNormals||t.useClearCoatNormals||t.enableGGXSpecular&&!t.useHeights);if(m&&(t.hasTangents?n.append(t.fastTbn?s.TBNfastPS:s.TBNPS):e.extStandardDerivatives&&(t.useNormals||t.useClearCoatNormals)?n.append(s.TBNderivativePS.replace(/\$UV/g,this.lightingUv)):n.append(s.TBNObjectSpacePS)),n.append(s.sphericalPS),n.append(s.decodePS),n.append(af.gammaCode(t.gamma,s)),n.append(af.tonemapCode(t.toneMap,s)),n.append(af.fogCode(t.fog,s)),n.append(this.frontendCode),t.useCubeMapRotation&&i.append("#define CUBEMAP_ROTATION"),this.needsNormal&&(n.append(s.cubeMapRotatePS),n.append(t.cubeMapProjection>0?s.cubeMapProjectBoxPS:s.cubeMapProjectNonePS),n.append(t.skyboxIntensity?s.envMultiplyPS:s.envConstPS)),(this.lighting&&t.useSpecular||this.reflections)&&(t.useMetalness&&n.append(s.metalnessModulatePS),2===t.fresnelModel&&n.append(s.fresnelSchlickPS),t.useIridescence&&n.append(s.iridescenceDiffractionPS)),t.useAo)switch(n.append(s.aoDiffuseOccPS),t.occludeSpecular){case 1:n.append(t.occludeSpecularFloat?s.aoSpecOccSimplePS:s.aoSpecOccConstSimplePS);break;case 2:n.append(t.occludeSpecularFloat?s.aoSpecOccPS:s.aoSpecOccConstPS)}"envAtlasHQ"===t.reflectionSource?(n.append(t.fixSeams?s.fixCubemapSeamsStretchPS:s.fixCubemapSeamsNonePS),n.append(s.envAtlasPS),n.append(s.reflectionEnvHQPS.replace(/\$DECODE_CUBEMAP/g,Cg.decodeFunc(t.reflectionCubemapEncoding)).replace(/\$DECODE/g,Cg.decodeFunc(t.reflectionEncoding)))):"envAtlas"===t.reflectionSource?(n.append(s.envAtlasPS),n.append(s.reflectionEnvPS.replace(/\$DECODE/g,Cg.decodeFunc(t.reflectionEncoding)))):"cubeMap"===t.reflectionSource?(n.append(t.fixSeams?s.fixCubemapSeamsStretchPS:s.fixCubemapSeamsNonePS),n.append(s.reflectionCubePS.replace(/\$DECODE/g,Cg.decodeFunc(t.reflectionEncoding)))):"sphereMap"===t.reflectionSource&&n.append(s.reflectionSpherePS.replace(/\$DECODE/g,Cg.decodeFunc(t.reflectionEncoding))),this.reflections&&(t.useClearCoat&&n.append(s.reflectionCCPS),t.useSheen&&n.append(s.reflectionSheenPS)),t.useRefraction&&(t.useDynamicRefraction?n.append(s.refractionDynamicPS):this.reflections&&n.append(s.refractionCubePS)),t.useSheen&&n.append(s.lightSheenPS),t.clusteredLightingEnabled&&(n.append(s.clusteredLightUtilsPS),t.clusteredLightingCookiesEnabled&&n.append(s.clusteredLightCookiesPS),t.clusteredLightingShadowsEnabled&&!t.noShadow&&(o[0]=!0,o[4]=!0,o[6]=!0)),(l>0||t.clusteredLightingEnabled)&&(h&&n.append(s.shadowCascadesPS),(o[5]||o[0])&&n.append(s.shadowStandardPS),o[4]&&!e.isWebGL1&&n.append(s.shadowStandardGL2PS),c&&(n.append(s.shadowVSM_commonPS),o[1]&&n.append(s.shadowVSM8PS),o[2]&&n.append(e.extTextureHalfFloatLinear?s.shadowEVSMPS.replace(/\$/g,"16"):s.shadowEVSMnPS.replace(/\$/g,"16")),o[3]&&n.append(e.extTextureFloatLinear?s.shadowEVSMPS.replace(/\$/g,"32"):s.shadowEVSMnPS.replace(/\$/g,"32"))),d&&(n.append(s.linearizeDepthPS),n.append(s.shadowPCSSPS)),e.isWebGL2||e.isWebGPU||e.extStandardDerivatives||n.append(s.biasConstPS)),t.enableGGXSpecular&&n.append("uniform float material_anisotropy;"),this.lighting&&(n.append(s.lightDiffuseLambertPS),(u||t.clusteredLightingAreaLightsEnabled)&&n.append(s.ltcPS));let _=!1;t.useSpecular&&(this.lighting&&n.append(0===t.shadingModel?s.lightSpecularPhongPS:t.enableGGXSpecular?s.lightSpecularAnisoGGXPS:s.lightSpecularBlinnPS),t.fresnelModel||this.reflections||t.diffuseMapEnabled||(i.append("uniform vec3 material_ambient;"),i.append("#define LIT_OLD_AMBIENT"),_=!0)),n.append(s.combinePS),t.lightMapEnabled&&n.append(t.useSpecular&&t.dirLightMapEnabled?s.lightmapDirAddPS:s.lightmapAddPS);const f=!t.lightMapEnabled||t.lightMapWithoutAmbient;f&&("ambientSH"===t.ambientSource?n.append(s.ambientSHPS):"envAtlas"===t.ambientSource?("envAtlas"!==t.reflectionSource&&"envAtlasHQ"!==t.reflectionSource&&n.append(s.envAtlasPS),n.append(s.ambientEnvPS.replace(/\$DECODE/g,Cg.decodeFunc(t.ambientEncoding)))):n.append(s.ambientConstantPS)),t.useAmbientTint&&!_&&i.append("uniform vec3 material_ambient;"),t.useMsdf&&(t.msdfTextAttribute||i.append("#define UNIFORM_TEXT_PARAMETERS"),n.append(s.msdfPS)),this.needsNormal&&(n.append(s.viewDirPS),t.useSpecular&&n.append(t.enableGGXSpecular?s.reflDirAnisoPS:s.reflDirPS));let g,v=!1,y=!1,b=!1,x=!1,w=!1;if(t.clusteredLightingEnabled&&this.lighting&&(x=!0,v=!0,y=!0,w=!0,n.append(s.floatUnpackingPS),t.lightMaskDynamic&&i.append("#define CLUSTER_MESH_DYNAMIC_LIGHTS"),t.clusteredLightingCookiesEnabled&&i.append("#define CLUSTER_COOKIES"),t.clusteredLightingShadowsEnabled&&!t.noShadow&&(i.append("#define CLUSTER_SHADOWS"),i.append("#define CLUSTER_SHADOW_TYPE_"+k_[t.clusteredLightingShadowType])),t.clusteredLightingAreaLightsEnabled&&i.append("#define CLUSTER_AREALIGHTS"),i.append(zg.getShaderDefines(e)),t.clusteredLightingShadowsEnabled&&!t.noShadow&&n.append(s.clusteredLightShadowsPS),n.append(s.clusteredLightPS)),t.twoSidedLighting&&i.append("uniform float twoSidedLightingNegScaleFactor;"),a.append(this._fsGetStartCode(a,e,s,t)),this.needsNormal&&(t.twoSidedLighting?a.append("    dVertexNormalW = normalize(gl_FrontFacing ? vNormalW * twoSidedLightingNegScaleFactor : -vNormalW * twoSidedLightingNegScaleFactor);"):a.append("    dVertexNormalW = normalize(vNormalW);"),(t.useHeights||t.useNormals)&&t.hasTangents&&(t.twoSidedLighting?(a.append("    dTangentW = gl_FrontFacing ? vTangentW * twoSidedLightingNegScaleFactor : -vTangentW * twoSidedLightingNegScaleFactor;"),a.append("    dBinormalW = gl_FrontFacing ? vBinormalW * twoSidedLightingNegScaleFactor : -vBinormalW * twoSidedLightingNegScaleFactor;")):(a.append("    dTangentW = vTangentW;"),a.append("    dBinormalW = vBinormalW;"))),a.append("    getViewDir();"),m&&a.append("    getTBN(dTangentW, dBinormalW, dVertexNormalW);")),a.append(this.frontendFunc),this.needsNormal&&(t.useSpecular&&r.append("    getReflDir(litArgs_worldNormal, dViewDirW, litArgs_gloss, dTBN);"),t.useClearCoat&&r.append("    ccReflDirW = normalize(-reflect(dViewDirW, litArgs_clearcoat_worldNormal));")),(this.lighting&&t.useSpecular||this.reflections)&&(t.useMetalness&&(r.append("    float f0 = 1.0 / litArgs_ior; f0 = (f0 - 1.0) / (f0 + 1.0); f0 *= f0;"),r.append("    litArgs_specularity = getSpecularModulate(litArgs_specularity, litArgs_albedo, litArgs_metalness, f0);"),r.append("    litArgs_albedo = getAlbedoModulate(litArgs_albedo, litArgs_metalness);")),t.useIridescence&&r.append("    vec3 iridescenceFresnel = getIridescence(saturate(dot(dViewDirW, litArgs_worldNormal)), litArgs_specularity, litArgs_iridescence_thickness);")),f&&(r.append("    addAmbient(litArgs_worldNormal);"),t.conserveEnergy&&t.useSpecular&&r.append("   dDiffuseLight = dDiffuseLight * (1.0 - litArgs_specularity);"),t.separateAmbient&&r.append("\n\t\t\t\t\t\t\t\t\t\tvec3 dAmbientLight = dDiffuseLight;\n\t\t\t\t\t\t\t\t\t\tdDiffuseLight = vec3(0);\n\t\t\t\t\t\t\t\t")),t.useAmbientTint&&!_&&r.append("    dDiffuseLight *= material_ambient;"),t.useAo&&!t.occludeDirect&&r.append("    occludeDiffuse(litArgs_ao);"),t.lightMapEnabled&&r.append("    addLightMap(\n\t\t\t\t\t\t\t\tlitArgs_lightmap, \n\t\t\t\t\t\t\t\tlitArgs_lightmapDir, \n\t\t\t\t\t\t\t\tlitArgs_worldNormal, \n\t\t\t\t\t\t\t\tdViewDirW, \n\t\t\t\t\t\t\t\tdReflDirW, \n\t\t\t\t\t\t\t\tlitArgs_gloss, \n\t\t\t\t\t\t\t\tlitArgs_specularity, \n\t\t\t\t\t\t\t\tdVertexNormalW,\n\t\t\t\t\t\t\t\tdTBN\n\t\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t\t\t, iridescenceFresnel,\n\t\t\t\t\t\t\t\tlitArgs_iridescence_intensity\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t);"),this.lighting||this.reflections){this.reflections&&(t.useClearCoat&&(r.append("    addReflectionCC(ccReflDirW, litArgs_clearcoat_gloss);"),t.fresnelModel>0?(r.append("    ccFresnel = getFresnelCC(dot(dViewDirW, litArgs_clearcoat_worldNormal));"),r.append("    ccReflection.rgb *= ccFresnel;")):r.append("    ccFresnel = 0.0;")),t.useSpecularityFactor&&r.append("    ccReflection.rgb *= litArgs_specularityFactor;"),t.useSheen&&r.append("    addReflectionSheen(litArgs_worldNormal, dViewDirW, litArgs_sheen_gloss);"),r.append("    addReflection(dReflDirW, litArgs_gloss);"),t.fresnelModel>0?r.append("    dReflection.rgb *= \n\t\t\t\t\t\t\t\t\t\t\t\tgetFresnel(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdot(dViewDirW, litArgs_worldNormal), \n\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_gloss, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_specularity\n\t\t\t\t\t\t\t\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t, iridescenceFresnel,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_iridescence_intensity\n\t\t\t\t\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t);"):r.append("    dReflection.rgb *= litArgs_specularity;"),t.useSpecularityFactor&&r.append("    dReflection.rgb *= litArgs_specularityFactor;")),u&&(r.append("    dSpecularLight *= litArgs_specularity;"),t.useSpecular&&r.append("    calcLTCLightValues(litArgs_gloss, litArgs_worldNormal, dViewDirW, litArgs_specularity, litArgs_clearcoat_gloss, litArgs_clearcoat_worldNormal, litArgs_clearcoat_specularity);"));for(let i=0;i<t.lights.length;i++){const a=t.lights[i],o=a._type;if(t.clusteredLightingEnabled&&0!==o)continue;g=!1;const l=u&&a._shape?a.shape:0,h=u&&a._shape?this._getLightSourceShapeString(l):"";if(0!==l&&r.append("    calc"+h+"LightValues(light"+i+"_position, light"+i+"_halfWidth, light"+i+"_halfHeight);"),0===o?(r.append("    dLightDirNormW = light"+i+"_direction;"),r.append("    dAtten = 1.0;")):(a._cookie&&(2!==o||a._cookie._cubemap?1===o&&a._cookie._cubemap&&(w=!0,g=!0):(w=!0,g=!0)),r.append("    getLightDirPoint(light"+i+"_position);"),v=!0,g&&(2===o?r.append("    dAtten3 = getCookie2D"+(a._cookieFalloff?"":"Clip")+(a._cookieTransform?"Xform":"")+"(light"+i+"_cookie, light"+i+"_shadowMatrix, light"+i+"_cookieIntensity"+(a._cookieTransform?", light"+i+"_cookieMatrix, light"+i+"_cookieOffset":"")+")."+a._cookieChannel+";"):r.append("    dAtten3 = getCookieCube(light"+i+"_cookie, light"+i+"_shadowMatrix, light"+i+"_cookieIntensity)."+a._cookieChannel+";")),0===l?0===a._falloffMode?(r.append("    dAtten = getFalloffLinear(light"+i+"_radius, dLightDirW);"),y=!0):(r.append("    dAtten = getFalloffInvSquared(light"+i+"_radius, dLightDirW);"),b=!0):(r.append("    dAtten = getFalloffWindow(light"+i+"_radius, dLightDirW);"),b=!0),r.append("    if (dAtten > 0.00001) {"),2===o&&(g&&!a._cookieFalloff||(r.append("    dAtten *= getSpotEffect(light"+i+"_direction, light"+i+"_innerConeAngle, light"+i+"_outerConeAngle, dLightDirNormW);"),x=!0))),0!==l?0===o?r.append("    dAttenD = getLightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirW, dLightDirNormW);"):r.append("    dAttenD = get"+h+"LightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirW, dLightDirNormW) * 16.0;"):r.append("    dAtten *= getLightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirW, dLightDirNormW);"),a.castShadows&&!t.noShadow){const t=6===a._shadowType,h=1===a._shadowType||2===a._shadowType||3===a._shadowType,c=5===a._shadowType||0===a._shadowType||4===a._shadowType;let d,u=null;switch(a._shadowType){case 1:u="VSM8",d="0.0";break;case 2:u="VSM16",d="5.54";break;case 3:u="VSM32",d=e.textureFloatHighPrecision?"15.0":"5.54";break;case 5:u="PCF1x1";break;case 4:u="PCF5x5";break;case 6:u="PCSS";break;default:u="PCF3x3"}if(null!==u){a._normalOffsetBias&&!a._isVsm&&n.append("#define SHADOW_SAMPLE_NORMAL_OFFSET"),0===o&&n.append("#define SHADOW_SAMPLE_ORTHO"),((c||t)&&e.isWebGL2||e.isWebGPU||e.extStandardDerivatives)&&n.append("#define SHADOW_SAMPLE_SOURCE_ZBUFFER"),1===o&&n.append("#define SHADOW_SAMPLE_POINT");const p=s.shadowSampleCoordPS;n.append(p.replace("$LIGHT",i)),n.append("#undef SHADOW_SAMPLE_NORMAL_OFFSET"),n.append("#undef SHADOW_SAMPLE_ORTHO"),n.append("#undef SHADOW_SAMPLE_SOURCE_ZBUFFER"),n.append("#undef SHADOW_SAMPLE_POINT");let m=`light${i}_shadowMatrix`;0===o&&a.numCascades>1&&(r.append(`    getShadowCascadeMatrix(light${i}_shadowMatrixPalette, light${i}_shadowCascadeDistances, light${i}_shadowCascadeCount);`),m="cascadeShadowMat"),r.append(`    dShadowCoord = getShadowSampleCoord${i}(${m}, light${i}_shadowParams, vPositionW, dLightPosW, dLightDirW, dLightDirNormW, dVertexNormalW);`),0===o&&r.append(`    fadeShadow(light${i}_shadowCascadeDistances);`);var S=`SHADOWMAP_PASS(light${i}_shadowMap), dShadowCoord, light${i}_shadowParams`;if(h)S=`${S}, ${d}, dLightDirW`;else if(t){let e=`vec2(light${i}_shadowSearchArea)`;0!==l&&(e=`vec2(length(light${i}_halfWidth), length(light${i}_halfHeight)) * light${i}_shadowSearchArea`),S=`${S}, light${i}_cameraParams, ${e}, dLightDirW`}1===o?(u=`Point${u}`,t||(S=`${S}, dLightDirW`)):2===o&&(u=`Spot${u}`),r.append(`    float shadow${i} = getShadow${u}(${S});`),r.append(`    dAtten *= mix(1.0, shadow${i}, light${i}_shadowIntensity);`)}}if(0!==l?t.conserveEnergy&&t.useSpecular?r.append("    dDiffuseLight += ((dAttenD * dAtten) * light"+i+"_color"+(g?" * dAtten3":"")+") * (1.0 - dLTCSpecFres);"):r.append("    dDiffuseLight += (dAttenD * dAtten) * light"+i+"_color"+(g?" * dAtten3":"")+";"):u&&t.conserveEnergy&&t.useSpecular?r.append("    dDiffuseLight += (dAtten * light"+i+"_color"+(g?" * dAtten3":"")+") * (1.0 - litArgs_specularity);"):r.append("    dDiffuseLight += dAtten * light"+i+"_color"+(g?" * dAtten3":"")+";"),t.useSpecular&&r.append("    dHalfDirW = normalize(-dLightDirNormW + dViewDirW);"),a.affectSpecularity)if(0!==l)t.useClearCoat&&r.append(`    ccSpecularLight += ccLTCSpecFres * get${h}LightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * light${i}_color`+(g?" * dAtten3":"")+";"),t.useSpecular&&r.append(`    dSpecularLight += dLTCSpecFres * get${h}LightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * light${i}_color`+(g?" * dAtten3":"")+";");else{var C=!1;0===o&&t.fresnelModel>0&&(C=!0),t.useClearCoat&&r.append(`    ccSpecularLight += getLightSpecular(dHalfDirW, ccReflDirW, litArgs_clearcoat_worldNormal, dViewDirW, dLightDirNormW, litArgs_clearcoat_gloss, dTBN) * dAtten * light${i}_color`+(g?" * dAtten3":"")+(C?" * getFresnelCC(dot(dViewDirW, dHalfDirW));":";")),t.useSheen&&r.append(`    sSpecularLight += getLightSpecularSheen(dHalfDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_sheen_gloss) * dAtten * light${i}_color`+(g?" * dAtten3;":";")),t.useSpecular&&r.append(`    dSpecularLight += getLightSpecular(dHalfDirW, dReflDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_gloss, dTBN) * dAtten * light${i}_color`+(g?" * dAtten3":"")+(C?" \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t* getFresnel(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdot(dViewDirW, dHalfDirW), \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_gloss, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_specularity\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t, iridescenceFresnel, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_iridescence_intensity\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t);":"* litArgs_specularity;"))}0!==o&&r.append("    }")}t.clusteredLightingEnabled&&this.lighting&&(y=!0,b=!0,v=!0,r.append("    addClusteredLights(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_worldNormal, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdViewDirW, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdReflDirW,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t#if defined(LIT_CLEARCOAT)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tccReflDirW,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_gloss, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_specularity, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdVertexNormalW, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdTBN, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tiridescenceFresnel,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_clearcoat_worldNormal, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_clearcoat_gloss,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_sheen_gloss,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_iridescence_intensity\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t);")),u&&(t.useClearCoat&&r.append("    litArgs_clearcoat_specularity = 1.0;"),t.useSpecular&&r.append("    litArgs_specularity = vec3(1);")),t.useRefraction&&r.append("    addRefraction(\n\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_worldNormal, \n\t\t\t\t\t\t\t\t\t\t\t\tdViewDirW, \n\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_thickness, \n\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_gloss, \n\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_specularity, \n\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_albedo, \n\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_transmission,\n\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_ior\n\t\t\t\t\t\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t\t\t\t\t\t\t, iridescenceFresnel, \n\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_iridescence_intensity\n\t\t\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t\t\t);")}t.useAo&&(t.occludeDirect&&r.append("    occludeDiffuse(litArgs_ao);"),1!==t.occludeSpecular&&2!==t.occludeSpecular||r.append("    occludeSpecular(litArgs_gloss, litArgs_ao, litArgs_worldNormal, dViewDirW);")),t.useSpecularityFactor&&r.append("    dSpecularLight *= litArgs_specularityFactor;"),!1===t.opacityFadesSpecular&&(2!==t.blendType&&4!==t.blendType||(r.append("float specLum = dot((dSpecularLight + dReflection.rgb * dReflection.a), vec3( 0.2126, 0.7152, 0.0722 ));"),r.append("#ifdef LIT_CLEARCOAT\n specLum += dot(ccSpecularLight * litArgs_clearcoat_specularity + ccReflection.rgb * litArgs_clearcoat_specularity, vec3( 0.2126, 0.7152, 0.0722 ));\n#endif"),r.append("litArgs_opacity = clamp(litArgs_opacity + gammaCorrectInput(specLum), 0.0, 1.0);")),r.append("litArgs_opacity *= material_alphaFade;")),r.append(s.endPS),2===t.blendType||6===t.blendType||t.alphaToCoverage?r.append(s.outputAlphaPS):4===t.blendType?r.append(s.outputAlphaPremulPS):r.append(s.outputAlphaOpaquePS),t.useMsdf&&r.append("    gl_FragColor = applyMsdf(gl_FragColor);"),r.append(s.outputPS),r.append(s.debugOutputPS),v&&n.prepend(s.lightDirPointPS),y&&n.prepend(s.falloffLinearPS),b&&n.prepend(s.falloffInvSquaredPS),x&&n.prepend(s.spotPS),w&&!t.clusteredLightingEnabled&&n.prepend(s.cookiePS);let T="";const A=`void evaluateBackend() {\n${r.code}\n}`;n.append(A),a.append(s.debugProcessFrontendPS),a.append("    evaluateBackend();"),a.append(af.end());const E=i.code+n.code+a.code;E.includes("dTBN")&&(T+="mat3 dTBN;\n"),E.includes("dVertexNormalW")&&(T+="vec3 dVertexNormalW;\n"),E.includes("dTangentW")&&(T+="vec3 dTangentW;\n"),E.includes("dBinormalW")&&(T+="vec3 dBinormalW;\n"),E.includes("dViewDirW")&&(T+="vec3 dViewDirW;\n"),E.includes("dReflDirW")&&(T+="vec3 dReflDirW;\n"),E.includes("dHalfDirW")&&(T+="vec3 dHalfDirW;\n"),E.includes("ccReflDirW")&&(T+="vec3 ccReflDirW;\n"),E.includes("dLightDirNormW")&&(T+="vec3 dLightDirNormW;\n"),E.includes("dLightDirW")&&(T+="vec3 dLightDirW;\n"),E.includes("dLightPosW")&&(T+="vec3 dLightPosW;\n"),E.includes("dShadowCoord")&&(T+="vec3 dShadowCoord;\n"),E.includes("dReflection")&&(T+="vec4 dReflection;\n"),E.includes("dDiffuseLight")&&(T+="vec3 dDiffuseLight;\n"),E.includes("dSpecularLight")&&(T+="vec3 dSpecularLight;\n"),E.includes("dAtten")&&(T+="float dAtten;\n"),E.includes("dAttenD")&&(T+="float dAttenD;\n"),E.includes("dAtten3")&&(T+="vec3 dAtten3;\n"),E.includes("dMsdf")&&(T+="vec4 dMsdf;\n"),E.includes("ccFresnel")&&(T+="float ccFresnel;\n"),E.includes("ccReflection")&&(T+="vec3 ccReflection;\n"),E.includes("ccSpecularLight")&&(T+="vec3 ccSpecularLight;\n"),E.includes("ccSpecularityNoFres")&&(T+="float ccSpecularityNoFres;\n"),E.includes("sSpecularLight")&&(T+="vec3 sSpecularLight;\n"),E.includes("sReflection")&&(T+="vec3 sReflection;\n");return this._fsGetBeginCode()+this.varyings+this.varyingDefines+this._fsGetBaseCode()+T+this.frontendDecl+E}generateFragmentShader(e,t,s,i){var n;const r=this.options;this.frontendDecl=e,this.frontendCode=t,this.frontendFunc=s,this.lightingUv=i,3===r.pass?this.fshader=this._fsGetPickPassCode():2===r.pass?this.fshader=this._fsGetDepthPassCode():5===r.pass?this.fshader=this._fsGetPrePassVelocityCode():this.shadowPass?this.fshader=this._fsGetShadowPassCode():r.customFragmentShader?this.fshader=this._fsGetBeginCode()+r.customFragmentShader:this.fshader=this._fsGetLitPassCode(),null==(n=this.handleCompatibility)||n.call(this)}getDefinition(){const e=Pm.createDefinition(this.device,{name:"LitShader",attributes:this.attributes,vertexCode:this.vshader,fragmentCode:this.fshader});return this.shaderPassInfo.isForward&&(e.tag=1),e}}const Bg={generateKey:e=>"lit"+Object.keys(e).sort().map((t=>"chunks"===t?Bg.generateChunksKey(e):"lights"===t?Bg.generateLightsKey(e):t+e[t])).join("\n"),generateLightsKey:e=>"lights:"+e.lights.map((t=>e.clusteredLightingEnabled&&0!==t._type?"":`${t.key},`)).join(""),generateChunksKey(e){var t;return"chunks:\n"+Object.keys(null!=(t=e.chunks)?t:{}).sort().map((t=>t+e.chunks[t])).join("")}};new class{constructor(){this.usedUvs=void 0,this.shaderChunk=void 0,this.litOptions=new yg}};const Ug=new nu,Hg=new nu,Wg=new nu,Gg=new xu,jg=1e-6;class qg{constructor(){this.light=null,this.min=new nu,this.max=new nu}}class Kg{constructor(e){this.clusterTexture=void 0,this.device=e,this.name="Untitled",this.reportCount=0,this.boundsMin=new nu,this.boundsMax=new nu,this.boundsDelta=new nu,this._cells=new nu(1,1,1),this._cellsLimit=new nu,this.cells=this._cells,this.maxCellLightCount=4,this._maxAttenuation=0,this._maxColorValue=0,this._usedLights=[],this._usedLights.push(new qg),this.lightsBuffer=new zg(e),this.registerUniforms(e)}set maxCellLightCount(e){e!==this._maxCellLightCount&&(this._maxCellLightCount=e,this._cellsDirty=!0)}get maxCellLightCount(){return this._maxCellLightCount}set cells(e){Ug.copy(e).floor(),this._cells.equals(Ug)||(this._cells.copy(Ug),this._cellsLimit.copy(Ug).sub(nu.ONE),this._cellsDirty=!0)}get cells(){return this._cells}destroy(){this.lightsBuffer.destroy(),this.releaseClusterTexture()}releaseClusterTexture(){this.clusterTexture&&(this.clusterTexture.destroy(),this.clusterTexture=null)}registerUniforms(e){this._clusterSkipId=e.scope.resolve("clusterSkip"),this._clusterMaxCellsId=e.scope.resolve("clusterMaxCells"),this._clusterWorldTextureId=e.scope.resolve("clusterWorldTexture"),this._clusterTextureSizeId=e.scope.resolve("clusterTextureSize"),this._clusterTextureSizeData=new Float32Array(3),this._clusterBoundsMinId=e.scope.resolve("clusterBoundsMin"),this._clusterBoundsMinData=new Float32Array(3),this._clusterBoundsDeltaId=e.scope.resolve("clusterBoundsDelta"),this._clusterBoundsDeltaData=new Float32Array(3),this._clusterCellsCountByBoundsSizeId=e.scope.resolve("clusterCellsCountByBoundsSize"),this._clusterCellsCountByBoundsSizeData=new Float32Array(3),this._clusterCellsDotId=e.scope.resolve("clusterCellsDot"),this._clusterCellsDotData=new Float32Array(3),this._clusterCellsMaxId=e.scope.resolve("clusterCellsMax"),this._clusterCellsMaxData=new Float32Array(3),this._clusterCompressionLimit0Id=e.scope.resolve("clusterCompressionLimit0"),this._clusterCompressionLimit0Data=new Float32Array(2)}updateParams(e){e&&(this.cells=e.cells,this.maxCellLightCount=e.maxLightsPerCell,this.lightsBuffer.cookiesEnabled=e.cookiesEnabled,this.lightsBuffer.shadowsEnabled=e.shadowsEnabled,this.lightsBuffer.areaLightsEnabled=e.areaLightsEnabled)}updateCells(){if(this._cellsDirty){this._cellsDirty=!1;const e=this._cells.x,t=this._cells.y,s=this._cells.z,i=e*t*s,n=this.maxCellLightCount*i;let r=Math.ceil(Math.sqrt(n));r=Wd.roundUp(r,this.maxCellLightCount);const a=Math.ceil(n/r);this._clusterCellsMaxData[0]=e,this._clusterCellsMaxData[1]=t,this._clusterCellsMaxData[2]=s,this._clusterCellsDotData[0]=this.maxCellLightCount,this._clusterCellsDotData[1]=e*s*this.maxCellLightCount,this._clusterCellsDotData[2]=e*this.maxCellLightCount,this.clusters=new Uint8ClampedArray(n),this.counts=new Int32Array(i),this._clusterTextureSizeData[0]=r,this._clusterTextureSizeData[1]=1/r,this._clusterTextureSizeData[2]=1/a,this.releaseClusterTexture(),this.clusterTexture=this.lightsBuffer.createTexture(this.device,r,a,1,"ClusterTexture")}}uploadTextures(){this.clusterTexture.lock().set(this.clusters),this.clusterTexture.unlock(),this.lightsBuffer.uploadTextures()}updateUniforms(){this._clusterSkipId.setValue(this._usedLights.length>1?0:1),this.lightsBuffer.updateUniforms(),this._clusterWorldTextureId.setValue(this.clusterTexture),this._clusterMaxCellsId.setValue(this.maxCellLightCount);const e=this.boundsDelta;this._clusterCellsCountByBoundsSizeData[0]=this._cells.x/e.x,this._clusterCellsCountByBoundsSizeData[1]=this._cells.y/e.y,this._clusterCellsCountByBoundsSizeData[2]=this._cells.z/e.z,this._clusterCellsCountByBoundsSizeId.setValue(this._clusterCellsCountByBoundsSizeData),this._clusterBoundsMinData[0]=this.boundsMin.x,this._clusterBoundsMinData[1]=this.boundsMin.y,this._clusterBoundsMinData[2]=this.boundsMin.z,this._clusterBoundsDeltaData[0]=e.x,this._clusterBoundsDeltaData[1]=e.y,this._clusterBoundsDeltaData[2]=e.z,this._clusterCompressionLimit0Data[0]=this._maxAttenuation,this._clusterCompressionLimit0Data[1]=this._maxColorValue,this._clusterTextureSizeId.setValue(this._clusterTextureSizeData),this._clusterBoundsMinId.setValue(this._clusterBoundsMinData),this._clusterBoundsDeltaId.setValue(this._clusterBoundsDeltaData),this._clusterCellsDotId.setValue(this._clusterCellsDotData),this._clusterCellsMaxId.setValue(this._clusterCellsMaxData),this._clusterCompressionLimit0Id.setValue(this._clusterCompressionLimit0Data)}evalLightCellMinMax(e,t,s){t.copy(e.min),t.sub(this.boundsMin),t.div(this.boundsDelta),t.mul2(t,this.cells),t.floor(),s.copy(e.max),s.sub(this.boundsMin),s.div(this.boundsDelta),s.mul2(s,this.cells),s.ceil(),t.max(nu.ZERO),s.min(this._cellsLimit)}collectLights(e){const t=this.lightsBuffer.maxLights,s=this._usedLights;let i=1;e.forEach((e=>{const n=!!(3&e.mask),r=2===e.type&&0===e._outerConeAngle;if(e.enabled&&0!==e.type&&e.visibleThisFrame&&e.intensity>0&&n&&!r&&i<t){let t;i<s.length?t=s[i]:(t=new qg,s.push(t)),t.light=e,e.getBoundingBox(Gg),t.min.copy(Gg.getMin()),t.max.copy(Gg.getMax()),i++}})),s.length=i}evaluateBounds(){const e=this._usedLights,t=this.boundsMin,s=this.boundsMax;if(e.length>1){t.copy(e[1].min),s.copy(e[1].max);for(let i=2;i<e.length;i++)t.min(e[i].min),s.max(e[i].max)}else t.set(0,0,0),s.set(1,1,1);this.boundsDelta.sub2(s,t),this.lightsBuffer.setBounds(t,this.boundsDelta)}evaluateCompressionLimits(e){let t=0,s=0;const i=this._usedLights;for(let n=1;n<i.length;n++){const r=i[n].light;t=Math.max(r.attenuationEnd,t);const a=e?r._linearFinalColor:r._finalColor;s=Math.max(a[0],s),s=Math.max(a[1],s),s=Math.max(a[2],s)}this._maxAttenuation=t+jg,this._maxColorValue=s+jg,this.lightsBuffer.setCompressionRanges(this._maxAttenuation,this._maxColorValue)}updateClusters(e){this.counts.fill(0),this.clusters.fill(0);const t=this._cells.x,s=this._cells.z,i=this.counts,n=this._maxCellLightCount,r=this.clusters,a=this.maxCellLightCount,o=this._usedLights;for(let l=1;l<o.length;l++){const h=o[l],c=h.light;this.lightsBuffer.addLightData(c,l,e),this.evalLightCellMinMax(h,Hg,Wg);const d=Hg.x,u=Wg.x,p=Hg.y,m=Wg.y,_=Hg.z,f=Wg.z;for(let e=d;e<=u;e++)for(let o=_;o<=f;o++)for(let h=p;h<=m;h++){const c=e+t*(o+h*s),d=i[c];d<n&&(r[a*c+d]=l,i[c]=d+1)}}}update(e,t,s){this.updateParams(s),this.updateCells(),this.collectLights(e),this.evaluateBounds(),this.evaluateCompressionLimits(t),this.updateClusters(t),this.uploadTextures()}activate(){this.updateUniforms()}}const Xg=2.399963229728653,Yg={circlePoint(e){const t=Math.sqrt(Math.random()),s=2*Math.random()*Math.PI;e.x=t*Math.cos(s),e.y=t*Math.sin(s)},circlePointDeterministic(e,t,s){const i=t*Xg,n=Math.sqrt(t)/Math.sqrt(s);e.x=n*Math.cos(i),e.y=n*Math.sin(i)},spherePointDeterministic(e,t,s,i=0,n=1){i=1-2*i,n=1-2*n;const r=Wd.lerp(i,n,t/s),a=Math.sqrt(1-r*r),o=Xg*t;e.x=Math.cos(o)*a,e.y=r,e.z=Math.sin(o)*a},radicalInverse(e){let t=(e<<16|e>>>16)>>>0;return t=((1431655765&t)<<1|(2863311530&t)>>>1)>>>0,t=((858993459&t)<<2|(3435973836&t)>>>2)>>>0,t=((252645135&t)<<4|(4042322160&t)>>>4)>>>0,t=((16711935&t)<<8|(4278255360&t)>>>8)>>>0,2.3283064365386963e-10*t}},Zg=e=>{switch(e){case rp:return"Cubemap";case"octahedral":return"Octahedral";default:return"Equirect"}},$g=(e,t,s)=>{if(e<=0)t[s+0]=0,t[s+1]=0,t[s+2]=0,t[s+3]=0;else if(e>=1)t[s+0]=255,t[s+1]=0,t[s+2]=0,t[s+3]=0;else{let i=1*e%1,n=255*e%1,r=65025*e%1;const a=16581375*e%1;i-=n/255,n-=r/255,r-=a/255,t[s+0]=Math.min(255,Math.floor(256*i)),t[s+1]=Math.min(255,Math.floor(256*n)),t[s+2]=Math.min(255,Math.floor(256*r)),t[s+3]=Math.min(255,Math.floor(256*a))}},Qg=(e,t,s,i)=>{const n=2*s*Math.PI,r=Math.pow(1-t,1/(i+1)),a=Math.sqrt(1-r*r);e.set(Math.cos(n)*a,Math.sin(n)*a,r).normalize()},Jg=(e,t,s)=>{const i=2*s*Math.PI,n=Math.sqrt(1-t),r=Math.sqrt(t);e.set(Math.cos(i)*r,Math.sin(i)*r,n).normalize()},ev=(e,t,s,i)=>{const n=2*s*Math.PI,r=Math.sqrt((1-t)/(1+(i*i-1)*t)),a=Math.sqrt(1-r*r);e.set(Math.cos(n)*a,Math.sin(n)*a,r).normalize()},tv=(e,t)=>{const s=e*t,i=t/(1-e*e+s*s);return i*i*(1/Math.PI)},sv={16:{2:26,8:20,32:17,128:16,512:16},32:{2:53,8:40,32:34,128:32,512:32},128:{2:214,8:163,32:139,128:130,512:128},1024:{2:1722,8:1310,32:1114,128:1041,512:1025}},iv=(e,t,s)=>{const i=s/e,n=1-Math.log2(t)/11,r=n*n,a=new nu,o=new nu,l=new nu(0,0,1),h=[],c=((e,t)=>{const s=sv[e];return s&&s[t]||e})(e,t);for(let e=0;e<c;++e){ev(a,e/c,Yg.radicalInverse(e),r);const t=a.z;if(o.set(a.x,a.y,a.z).mulScalar(2*t).sub(l),o.z>0){const e=tv(Math.min(1,t),r)/4+.001,s=.5*Math.log2(i/e);h.push(o.x,o.y,o.z,s)}}for(;h.length<4*e;)h.push(0,0,0,0);return h},nv=(e,t,s)=>{const i=(e=>{const t=e.length,s=Math.min(t,512),i=Math.ceil(t/s),n=new Uint8Array(s*i*4);let r=0;for(let s=0;s<t;s+=4)$g(.5*e[s+0]+.5,n,r+0),$g(.5*e[s+1]+.5,n,r+4),$g(.5*e[s+2]+.5,n,r+8),$g(e[s+3]/8,n,r+12),r+=16;return{width:s,height:i,data:n}})(s);return new bm(e,{name:t,width:i.width,height:i.height,mipmaps:!1,minFilter:0,magFilter:0,levels:[i.data]})};class rv{constructor(e=!0){this.map=new Map,this.destroyContent=e}destroy(){this.destroyContent&&this.map.forEach(((e,t)=>{e.destroy()}))}get(e,t){if(!this.map.has(e)){const s=t();return this.map.set(e,s),s}return this.map.get(e)}}const av=new rv(!1),ov=new zp,lv=(e,t,s)=>ov.get(e,(()=>new rv)).get(t,(()=>nv(e,t,av.get(t,s)))),hv=(e,t,s)=>lv(e,`lambert-samples-${t}-${s}`,(()=>((e,t)=>{const s=t/e,i=new nu,n=[];for(let t=0;t<e;++t){Jg(i,t/e,Yg.radicalInverse(t));const r=i.z/Math.PI,a=.5*Math.log2(s/r);n.push(i.x,i.y,i.z,a)}return n})(t,s))),cv=(e,t,s)=>lv(e,`phong-samples-${t}-${s}`,(()=>((e,t)=>{const s=new nu,i=[];for(let n=0;n<e;++n)Qg(s,n/e,Yg.radicalInverse(n),t),i.push(s.x,s.y,s.z,0);return i})(t,s)));function dv(e,t,s={}){var i,n,r,a,o;e instanceof Gp&&(e=arguments[1],t=arguments[2],s={},void 0!==arguments[3]&&(s.specularPower=arguments[3]),void 0!==arguments[4]&&(s.numSamples=arguments[4]));const l=null!=(i=s.seamPixels)?i:0,h=(null!=(n=null==(r=s.rect)?void 0:r.z)?n:t.width)-2*l,c=(null!=(a=null==(o=s.rect)?void 0:o.w)?a:t.height)-2*l;if(h<1||c<1)return!1;const d=s.hasOwnProperty("specularPower")?s.specularPower:1,u=s.hasOwnProperty("face")?s.face:null,p=s.hasOwnProperty("distribution")?s.distribution:1===d?"none":"phong",m={none:"reproject",lambert:"prefilterSamplesUnweighted",phong:"prefilterSamplesUnweighted",ggx:"prefilterSamples"}[p]||"reproject",_=m.startsWith("prefilterSamples"),f=Cg.decodeFunc(e.encoding),g=Cg.encodeFunc(t.encoding),v=`sample${Zg(e.projection)}`,y=`getDirection${Zg(t.projection)}`,b=s.hasOwnProperty("numSamples")?s.numSamples:1024,x=`${m}_${f}_${g}_${v}_${y}_${b}`,w=e.device;let S=nf(w).getCachedShader(x);if(!S){S=of(w,"\nattribute vec2 vertex_position;\n\nuniform vec4 uvMod;\n\nvarying vec2 vUv0;\n\nvoid main(void) {\n\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\tvUv0 = getImageEffectUV((vertex_position.xy * 0.5 + 0.5) * uvMod.xy + uvMod.zw);\n}\n",`${`#define PROCESS_FUNC ${m}\n`+(_?"#define USE_SAMPLES_TEX\n":"")+(e.cubemap?"#define CUBEMAP_SOURCE\n":"")+`#define DECODE_FUNC ${f}\n`+`#define ENCODE_FUNC ${g}\n`+`#define SOURCE_FUNC ${v}\n`+`#define TARGET_FUNC ${y}\n`+`#define NUM_SAMPLES ${b}\n`+`#define NUM_SAMPLES_SQRT ${Math.round(Math.sqrt(b)).toFixed(1)}\n`}\n${tf.reprojectPS}`,x)}w.setBlendState(Sp.NOBLEND);w.scope.resolve(e.cubemap?"sourceCube":"sourceTex").setValue(e);const C=w.scope.resolve("params"),T=w.scope.resolve("params2"),A=w.scope.resolve("uvMod");l>0?A.setValue([(h+2*l)/h,(c+2*l)/c,-l/h,-l/c]):A.setValue([1,1,0,0]);const E=[0,d,e.fixCubemapSeams?1/e.width:0,t.fixCubemapSeams?1/t.width:0],P=[t.width*t.height*(t.cubemap?6:1),e.width*e.height*(e.cubemap?6:1)];if(_){const t=e.width*e.height*(e.cubemap?6:1),s="ggx"===p?((e,t,s,i)=>lv(e,`ggx-samples-${t}-${s}-${i}`,(()=>iv(t,s,i))))(w,b,d,t):"lambert"===p?hv(w,b,t):cv(w,b,d);w.scope.resolve("samplesTex").setValue(s),w.scope.resolve("samplesTexInverseSize").setValue([1/s.width,1/s.height])}for(let e=0;e<(t.cubemap?6:1);e++)if(null===u||e===u){var M;const i=new qp({colorBuffer:t,face:e,depth:!1,flipY:w.isWebGPU});E[0]=e,C.setValue(E),T.setValue(P),ff(w,i,S,null==(M=s)?void 0:M.rect),i.destroy()}return!0}const uv=(e,t=0)=>1+Math.floor(Math.log2(Math.max(e,t)));class pv{static generateSkyboxCubemap(e,t){const s=((e,t,s,i)=>new bm(e,{name:`lighting-${t}`,cubemap:!0,width:t,height:t,format:s,type:7===s?sp:ep,addressU:1,addressV:1,fixCubemapSeams:!0,mipmaps:!!i}))(e.device,t||(e.cubemap?e.width:e.width/4),7,!1);return dv(e,s,{numSamples:1024}),s}static generateLightingSource(e,t){const s=e.device,i=(e=>(e=>e.extTextureHalfFloat&&e.textureHalfFloatRenderable)(e)?Lu:(e=>e.extTextureFloat&&e.textureFloatRenderable)(e)?Du:7)(s),n=(null==t?void 0:t.target)||new bm(s,{name:"lighting-source",cubemap:!0,width:(null==t?void 0:t.size)||128,height:(null==t?void 0:t.size)||128,format:i,type:7===i?sp:ep,addressU:1,addressV:1,fixCubemapSeams:!1,mipmaps:!0});return dv(e,n,{numSamples:e.mipmaps?1:1024}),n}static generateAtlas(e,t){const s=e.device,i=(null==t?void 0:t.target)||new bm(s,{name:"envAtlas",width:(null==t?void 0:t.size)||512,height:(null==t?void 0:t.size)||512,format:7,type:sp,projection:ap,addressU:1,addressV:1,mipmaps:!1}),n=i.width/512,r=new ou(0,0,512*n,256*n),a=uv(256)-uv(4);for(let t=0;t<a;++t)dv(e,i,{numSamples:1,rect:r,seamPixels:n}),r.x+=r.w,r.y+=r.w,r.z=Math.max(1,Math.floor(.5*r.z)),r.w=Math.max(1,Math.floor(.5*r.w));r.set(0,256*n,256*n,128*n);for(let s=1;s<7;++s)dv(e,i,{numSamples:(null==t?void 0:t.numReflectionSamples)||1024,distribution:(null==t?void 0:t.distribution)||"ggx",specularPower:Math.max(1,2048>>2*s),rect:r,seamPixels:n}),r.y+=r.w,r.z=Math.max(1,Math.floor(.5*r.z)),r.w=Math.max(1,Math.floor(.5*r.w));return r.set(128*n,384*n,64*n,32*n),dv(e,i,{numSamples:(null==t?void 0:t.numAmbientSamples)||2048,distribution:"lambert",rect:r,seamPixels:n}),i}static generatePrefilteredAtlas(e,t){const s=e[0].device,i=e[0].format,n=e[0].type,r=(null==t?void 0:t.target)||new bm(s,{name:"envPrefilteredAtlas",width:(null==t?void 0:t.size)||512,height:(null==t?void 0:t.size)||512,format:i,type:n,projection:ap,addressU:1,addressV:1,mipmaps:!1}),a=r.width/512,o=new ou(0,0,512*a,256*a),l=uv(512);for(let t=0;t<l;++t)dv(e[0],r,{numSamples:1,rect:o,seamPixels:a}),o.x+=o.w,o.y+=o.w,o.z=Math.max(1,Math.floor(.5*o.z)),o.w=Math.max(1,Math.floor(.5*o.w));o.set(0,256*a,256*a,128*a);for(let t=1;t<e.length;++t)dv(e[t],r,{numSamples:1,rect:o,seamPixels:a}),o.y+=o.w,o.z=Math.max(1,Math.floor(.5*o.z)),o.w=Math.max(1,Math.floor(.5*o.w));return o.set(128*a,384*a,64*a,32*a),null!=t&&t.legacyAmbient?dv(e[5],r,{numSamples:1,rect:o,seamPixels:a}):dv(e[0],r,{numSamples:(null==t?void 0:t.numSamples)||2048,distribution:"lambert",rect:o,seamPixels:a}),r}}class mv{constructor(){this.forceUv1=!1,this.ambientTint=!1,this.diffuseTint=!1,this.specularTint=!1,this.metalnessTint=!1,this.glossTint=!1,this.emissiveTint=!1,this.opacityTint=!1,this.emissiveEncoding="linear",this.lightMapEncoding="linear",this.packedNormal=!1,this.glossInvert=!1,this.sheenGlossInvert=!1,this.clearCoatGlossInvert=!1,this.litOptions=new yg}get pass(){return this.litOptions.pass}}const _v=[],fv=e=>Object.keys(e).filter((e=>"litOptions"!==e)).sort();const gv=new class extends af{constructor(...e){super(...e),this.optionsContext=new mv,this.optionsContextMin=new mv}generateKey(e){let t;e===this.optionsContextMin?(this.propsMin||(this.propsMin=fv(e)),t=this.propsMin):e===this.optionsContext?(this.props||(this.props=fv(e)),t=this.props):t=fv(e);return"standard:\n"+t.map((t=>t+e[t])).join("\n")+Bg.generateKey(e.litOptions)}_getUvSourceExpression(e,t,s){const i=s[e],n=s[t],r=0===s.litOptions.pass||1===s.litOptions.pass;let a;return r&&1===s.litOptions.nineSlicedMode||r&&2===s.litOptions.nineSlicedMode?a="nineSlicedUv":(a=0===i?"vUv"+n:"vUV"+n+"_"+i,s.heightMap&&"heightMapTransform"!==e&&(a+=" + dUvOffset")),a}_addMapDef(e,t){return t?`#define ${e}\n`:`#undef ${e}\n`}_addMapDefs(e,t,s,i,n){return this._addMapDef("MAPFLOAT",e)+this._addMapDef("MAPCOLOR",t)+this._addMapDef("MAPVERTEX",s)+this._addMapDef("MAPTEXTURE",i)+this._addMapDef("MAPINVERT",n)}_addMap(e,t,s,i,n,r=null){const a=e+"Map",o=a+"Uv",l=a+"Identifier",h=a+"Transform",c=a+"Channel",d=e+"VertexColorChannel",u=e+"VertexColor",p=e+"Mode",m=e+"Invert",_=s[e+"Tint"],f=s[u],g=s[a],v=s[l],y=s[p];let b=i[t];if(g){const e=this._getUvSourceExpression(h,o,s);if(b=b.replace(/\$UV/g,e).replace(/\$CH/g,s[c]),n&&-1!==b.search(/\$SAMPLER/g)){let e="texture_"+a;const t=n[v];t?e=t:n[v]=e,b=b.replace(/\$SAMPLER/g,e)}if(r&&(b="aaa"===s[c]?b.replace(/\$DECODE/g,"passThrough"):b.replace(/\$DECODE/g,Cg.decodeFunc(s.litOptions.gamma||"srgb"!==r?r:"linear")),b.indexOf("$texture2DSAMPLE"))){const e={linear:"texture2D",srgb:"texture2DSRGB",rgbm:"texture2DRGBM",rgbe:"texture2DRGBE"};b=b.replace(/\$texture2DSAMPLE/g,e[r]||"texture2D")}}f&&(b=b.replace(/\$VC/g,s[d])),y&&(b=b.replace(/\$DETAILMODE/g,y));const x=!!(1&_),w=!!(2&_),S=!!s[m];return b=this._addMapDefs(x,w,f,g,S)+b,b.replace(/\$/g,"")}_correctChannel(e,t,s){if(s[e]>0){if(s[e]<t.length)return t.substring(0,s[e]);if(s[e]>t.length){let i=t;const n=i.charAt(i.length-1),r=s[e]-i.length;for(let e=0;e<r;e++)i+=n;return i}return t}}createShaderDefinition(e,t){const s=yf.get(e).getByIndex(t.litOptions.pass).isForward,i=new Ng(e,t.litOptions),n=[],r=[],a=[],o={};for(const e in _v){const s=e+"Map";if(t[e+"VertexColor"]){const s=e+"VertexColorChannel";t[s]=this._correctChannel(e,t[s],_v)}if(t[s]){const i=s+"Channel",o=s+"Transform",l=s+"Uv";t[l]=Math.min(t[l],1),t[i]=this._correctChannel(e,t[i],_v);const h=t[l];n[h]=!0,r[h]=r[h]||t[s]&&!t[o],t[o]&&a.push({name:e,id:t[o],uv:t[l]})}}t.forceUv1&&(n[1]=!0,r[1]=void 0===r[1]||r[1]),i.generateVertexShader(n,r,a),0===t.litOptions.shadingModel?(t.litOptions.fresnelModel=0,t.litOptions.ambientSH=!1):t.litOptions.fresnelModel=0===t.litOptions.fresnelModel?2:t.litOptions.fresnelModel;const l=new xg,h=new xg,c=new xg,d=new xg;let u="";if(2===t.litOptions.nineSlicedMode?l.append("const float textureBias = -1000.0;"):l.append("uniform float textureBias;"),s){if(t.heightMap&&(l.append("vec2 dUvOffset;"),h.append(this._addMap("height","parallaxPS",t,i.chunks,o)),c.append("getParallax();")),3!==t.litOptions.blendType||t.litOptions.alphaTest||t.litOptions.alphaToCoverage||t.litOptions.opacityDither!==V_){l.append("float dAlpha;"),h.append(this._addMap("opacity","opacityPS",t,i.chunks,o)),c.append("getOpacity();"),d.append("litArgs_opacity = dAlpha;"),t.litOptions.alphaTest&&(h.append(i.chunks.alphaTestPS),c.append("alphaTest(dAlpha);"));const e=t.litOptions.opacityDither;e!==V_&&(e===N_&&l.append(i.chunks.bayerPS),l.append(`#define DITHER_${e.toUpperCase()}\n`),l.append(i.chunks.opacityDitherPS),c.append("opacityDither(dAlpha, 0.0);"))}else l.append("float dAlpha = 1.0;");if(i.needsNormal){if((t.normalMap||t.clearCoatNormalMap)&&(h.append(t.packedNormal?i.chunks.normalXYPS:i.chunks.normalXYZPS),!t.litOptions.hasTangents)){const e=t.normalMap?"normalMap":"clearCoatNormalMap";u=this._getUvSourceExpression(`${e}Transform`,`${e}Uv`,t)}l.append("vec3 dNormalW;"),h.append(this._addMap("normalDetail","normalDetailMapPS",t,i.chunks,o)),h.append(this._addMap("normal","normalMapPS",t,i.chunks,o)),c.append("getNormal();"),d.append("litArgs_worldNormal = dNormalW;")}if(i.needsSceneColor&&l.append("uniform sampler2D uSceneColorMap;"),i.needsScreenSize&&l.append("uniform vec4 uScreenSize;"),i.needsTransforms&&(l.append("uniform mat4 matrix_viewProjection;"),l.append("uniform mat4 matrix_model;")),(t.diffuseDetail||t.aoDetail)&&h.append(i.chunks.detailModesPS),l.append("vec3 dAlbedo;"),t.diffuseDetail&&h.append(this._addMap("diffuseDetail","diffuseDetailMapPS",t,i.chunks,o,t.diffuseDetailEncoding)),h.append(this._addMap("diffuse","diffusePS",t,i.chunks,o,t.diffuseEncoding)),c.append("getAlbedo();"),d.append("litArgs_albedo = dAlbedo;"),t.litOptions.useRefraction&&(l.append("float dTransmission;"),h.append(this._addMap("refraction","transmissionPS",t,i.chunks,o)),c.append("getRefraction();"),d.append("litArgs_transmission = dTransmission;"),l.append("float dThickness;"),h.append(this._addMap("thickness","thicknessPS",t,i.chunks,o)),c.append("getThickness();"),d.append("litArgs_thickness = dThickness;")),t.litOptions.useIridescence&&(l.append("float dIridescence;"),h.append(this._addMap("iridescence","iridescencePS",t,i.chunks,o)),c.append("getIridescence();"),d.append("litArgs_iridescence_intensity = dIridescence;"),l.append("float dIridescenceThickness;"),h.append(this._addMap("iridescenceThickness","iridescenceThicknessPS",t,i.chunks,o)),c.append("getIridescenceThickness();"),d.append("litArgs_iridescence_thickness = dIridescenceThickness;")),i.lighting&&t.litOptions.useSpecular||i.reflections?(l.append("vec3 dSpecularity;"),l.append("float dGlossiness;"),t.litOptions.useSheen&&(l.append("vec3 sSpecularity;"),h.append(this._addMap("sheen","sheenPS",t,i.chunks,o,t.sheenEncoding)),c.append("getSheen();"),d.append("litArgs_sheen_specularity = sSpecularity;"),l.append("float sGlossiness;"),h.append(this._addMap("sheenGloss","sheenGlossPS",t,i.chunks,o)),c.append("getSheenGlossiness();"),d.append("litArgs_sheen_gloss = sGlossiness;")),t.litOptions.useMetalness&&(l.append("float dMetalness;"),h.append(this._addMap("metalness","metalnessPS",t,i.chunks,o)),c.append("getMetalness();"),d.append("litArgs_metalness = dMetalness;"),l.append("float dIor;"),h.append(this._addMap("ior","iorPS",t,i.chunks,o)),c.append("getIor();"),d.append("litArgs_ior = dIor;")),t.litOptions.useSpecularityFactor&&(l.append("float dSpecularityFactor;"),h.append(this._addMap("specularityFactor","specularityFactorPS",t,i.chunks,o)),c.append("getSpecularityFactor();"),d.append("litArgs_specularityFactor = dSpecularityFactor;")),t.useSpecularColor?h.append(this._addMap("specular","specularPS",t,i.chunks,o,t.specularEncoding)):h.append("void getSpecularity() { dSpecularity = vec3(1); }"),h.append(this._addMap("gloss","glossPS",t,i.chunks,o)),c.append("getGlossiness();"),c.append("getSpecularity();"),d.append("litArgs_specularity = dSpecularity;"),d.append("litArgs_gloss = dGlossiness;")):(l.append("vec3 dSpecularity = vec3(0.0);"),l.append("float dGlossiness = 0.0;")),t.aoDetail&&h.append(this._addMap("aoDetail","aoDetailMapPS",t,i.chunks,o)),(t.aoMap||t.aoVertexColor)&&(l.append("float dAo;"),h.append(this._addMap("ao","aoPS",t,i.chunks,o)),c.append("getAO();"),d.append("litArgs_ao = dAo;")),l.append("vec3 dEmission;"),h.append(this._addMap("emissive","emissivePS",t,i.chunks,o,t.emissiveEncoding)),c.append("getEmission();"),d.append("litArgs_emission = dEmission;"),t.litOptions.useClearCoat&&(l.append("float ccSpecularity;"),l.append("float ccGlossiness;"),l.append("vec3 ccNormalW;"),h.append(this._addMap("clearCoat","clearCoatPS",t,i.chunks,o)),h.append(this._addMap("clearCoatGloss","clearCoatGlossPS",t,i.chunks,o)),h.append(this._addMap("clearCoatNormal","clearCoatNormalPS",t,i.chunks,o)),c.append("getClearCoat();"),c.append("getClearCoatGlossiness();"),c.append("getClearCoatNormal();"),d.append("litArgs_clearcoat_specularity = ccSpecularity;"),d.append("litArgs_clearcoat_gloss = ccGlossiness;"),d.append("litArgs_clearcoat_worldNormal = ccNormalW;")),t.lightMap||t.lightVertexColor){const e=t.dirLightMap&&t.litOptions.useSpecular,s=e?"lightmapDirPS":"lightmapSinglePS";l.append("vec3 dLightmap;"),e&&l.append("vec3 dLightmapDir;"),h.append(this._addMap("light",s,t,i.chunks,o,t.lightMapEncoding)),c.append("getLightMap();"),d.append("litArgs_lightmap = dLightmap;"),e&&d.append("litArgs_lightmapDir = dLightmapDir;")}-1===h.code.indexOf("texture2DSRGB")&&-1===h.code.indexOf("texture2DRGBM")&&-1===h.code.indexOf("texture2DRGBE")||h.prepend(i.chunks.textureSamplePS)}else{const e=t.litOptions.opacityShadowDither;(t.litOptions.alphaTest||e)&&(l.append("float dAlpha;"),h.append(this._addMap("opacity","opacityPS",t,i.chunks,o)),c.append("getOpacity();"),d.append("litArgs_opacity = dAlpha;"),t.litOptions.alphaTest&&(h.append(i.chunks.alphaTestPS),c.append("alphaTest(dAlpha);")),e!==V_&&(e===N_&&l.append(i.chunks.bayerPS),l.append(`#define DITHER_${e.toUpperCase()}\n`),l.append(i.chunks.opacityDitherPS),c.append("opacityDither(dAlpha, 0.0);")))}l.append(i.chunks.litShaderArgsPS),h.append(`void evaluateFrontend() { \n${c.code}\n${d.code}\n }\n`),c.code="evaluateFrontend();";for(const e in o)l.append(`uniform sampler2D ${o[e]};`);return c.code=`\n${c.code.split("\n").map((e=>`    ${e}`)).join("\n")}\n\n`,i.generateFragmentShader(l.code,h.code,c.code,u),i.getDefinition()}},vv=(e,t)=>{if(e.length!==t.length)return!1;for(let s=0;s<e.length;++s)if(e[s]!==t[s])return!1;return!0},yv=e=>1!==e.r||1!==e.g||1!==e.b;class bv{constructor(){this._mapXForms=null}updateMinRef(e,t,s,i,n,r){this._updateSharedOptions(e,t,s,i,n),this._updateMinOptions(e,s),this._updateUVOptions(e,s,i,!0)}updateRef(e,t,s,i,n,r){this._updateSharedOptions(e,t,s,i,n),this._updateEnvOptions(e,s,t),this._updateMaterialOptions(e,s),1===n&&(e.litOptions.gamma&&(e.litOptions.gamma=3),e.litOptions.toneMap=0),e.litOptions.hasTangents=i&&0!=(512&i),this._updateLightOptions(e,t,s,i,r),this._updateUVOptions(e,s,i,!1)}_updateSharedOptions(e,t,s,i,n){e.forceUv1=s.forceUv1,s.userAttributes&&(e.litOptions.userAttributes=Object.fromEntries(s.userAttributes.entries())),e.litOptions.chunks=s.chunks||{},e.litOptions.pass=n,e.litOptions.alphaTest=s.alphaTest>0,e.litOptions.blendType=s.blendType,e.litOptions.screenSpace=i&&0!=(i&I_),e.litOptions.skin=i&&0!=(2&i),e.litOptions.useInstancing=i&&0!=(32&i),e.litOptions.useMorphPosition=i&&0!=(i&R_),e.litOptions.useMorphNormal=i&&0!=(i&O_),e.litOptions.useMorphTextureBased=i&&0!=(i&z_),e.litOptions.nineSlicedMode=s.nineSlicedMode||0,t.clusteredLightingEnabled&&s.useLighting?(e.litOptions.clusteredLightingEnabled=!0,e.litOptions.clusteredLightingCookiesEnabled=t.lighting.cookiesEnabled,e.litOptions.clusteredLightingShadowsEnabled=t.lighting.shadowsEnabled,e.litOptions.clusteredLightingShadowType=t.lighting.shadowType,e.litOptions.clusteredLightingAreaLightsEnabled=t.lighting.areaLightsEnabled):(e.litOptions.clusteredLightingEnabled=!1,e.litOptions.clusteredLightingCookiesEnabled=!1,e.litOptions.clusteredLightingShadowsEnabled=!1,e.litOptions.clusteredLightingAreaLightsEnabled=!1)}_updateUVOptions(e,t,s,i){let n=!1,r=!1,a=!1;s&&(n=0!=(4&s),r=0!=(8&s),a=0!=(16&s)),e.litOptions.vertexColors=!1,this._mapXForms=[];const o={};for(const s in _v)this._updateTexOptions(e,t,s,n,r,a,i,o);this._mapXForms=null,e.litOptions.lightMapEnabled=e.lightMap,e.litOptions.dirLightMapEnabled=e.dirLightMap,e.litOptions.useHeights=e.heightMap,e.litOptions.useNormals=e.normalMap,e.litOptions.useClearCoatNormals=e.clearCoatNormalMap,e.litOptions.useAo=e.aoMap||e.aoVertexColor,e.litOptions.diffuseMapEnabled=e.diffuseMap}_updateTexOptions(e,t,s,i,n,r,a,o){const l="opacity"===s;if(!a||l){const a=s+"Map",h=s+"VertexColor",c=s+"VertexColorChannel",d=a+"Channel",u=a+"Transform",p=a+"Uv",m=a+"Identifier";if("light"!==s&&(e[a]=!1,e[m]=void 0,e[d]="",e[u]=0,e[p]=0),e[h]=!1,e[c]="",l&&3===t.blendType&&0===t.alphaTest&&!t.alphaToCoverage&&t.opacityDither===V_)return;if("height"!==s&&t[h]&&r&&(e[h]=t[h],e[c]=t[c],e.litOptions.vertexColors=!0),t[a]){let r=!0;if(0!==t[p]||i||(r=!1),1!==t[p]||n||(r=!1),r){const i=t[a].id;let n=o[i];void 0===n&&(o[i]=s,n=s),e[a]=!!t[a],e[m]=n,e[u]=this._getMapTransformID(t.getUniform(u),t[p]),e[d]=t[d],e[p]=t[p]}}}}_updateMinOptions(e,t){e.opacityTint=1!==t.opacity&&(3!==t.blendType||t.opacityShadowDither!==V_),e.litOptions.opacityShadowDither=t.opacityShadowDither,e.litOptions.lights=[]}_updateMaterialOptions(e,t){var s,i,n,r;const a=(t.diffuseTint||!t.diffuseMap&&!t.diffuseVertexColor)&&yv(t.diffuse),o=!!(t.useMetalness||t.specularMap||t.sphereMap||t.cubeMap||(l=t.specular,0!==l.r||0!==l.g||0!==l.b)||t.specularityFactor>0&&t.useMetalness||t.enableGGXSpecular||t.clearCoat>0);var l;const h=!t.useMetalness||t.useMetalnessSpecularColor,c=o&&(t.specularTint||!t.specularMap&&!t.specularVertexColor)&&yv(t.specular),d=o&&t.useMetalnessSpecularColor&&(t.specularityFactorTint||t.specularityFactor<1&&!t.specularityFactorMap),u=!t.emissiveMap||yv(t.emissive)&&t.emissiveTint,p=1!==t.emissiveIntensity,m=!!t.normalMap&&(10===t.normalMap.format||t.normalMap.type===ip);e.opacityTint=1!==t.opacity&&(3!==t.blendType||t.alphaTest>0||t.opacityDither!==V_)?1:0,e.ambientTint=t.ambientTint,e.diffuseTint=a?2:0,e.specularTint=c?2:0,e.specularityFactorTint=d?1:0,e.metalnessTint=t.useMetalness&&t.metalness<1?1:0,e.glossTint=1,e.emissiveTint=(u?2:0)+(p?1:0),e.diffuseEncoding=null==(s=t.diffuseMap)?void 0:s.encoding,e.diffuseDetailEncoding=null==(i=t.diffuseDetailMap)?void 0:i.encoding,e.emissiveEncoding=null==(n=t.emissiveMap)?void 0:n.encoding,e.lightMapEncoding=null==(r=t.lightMap)?void 0:r.encoding,e.packedNormal=m,e.refractionTint=1!==t.refraction?1:0,e.refractionIndexTint=t.refractionIndex!==1/1.5?1:0,e.thicknessTint=t.useDynamicRefraction&&1!==t.thickness?1:0,e.specularEncoding=t.specularEncoding||"linear",e.sheenEncoding=t.sheenEncoding||"linear",e.aoMapUv=t.aoUvSet,e.aoDetail=!!t.aoMap,e.diffuseDetail=!!t.diffuseMap,e.normalDetail=!!t.normalMap,e.diffuseDetailMode=t.diffuseDetailMode,e.aoDetailMode=t.aoDetailMode,e.clearCoatTint=1!==t.clearCoat?1:0,e.clearCoatGloss=!!t.clearCoatGloss,e.clearCoatGlossTint=1!==t.clearCoatGloss?1:0,e.iorTint=t.refractionIndex!==1/1.5?1:0,e.iridescenceTint=1!==t.iridescence?1:0,e.sheenTint=t.useSheen&&yv(t.sheen)?2:0,e.sheenGlossTint=1,e.glossInvert=t.glossInvert,e.sheenGlossInvert=t.sheenGlossInvert,e.clearCoatGlossInvert=t.clearCoatGlossInvert,e.useSpecularColor=h,e.litOptions.separateAmbient=!1,e.litOptions.useAmbientTint=t.ambientTint,e.litOptions.customFragmentShader=t.customFragmentShader,e.litOptions.pixelSnap=t.pixelSnap,e.litOptions.shadingModel=t.shadingModel,e.litOptions.ambientSH=!!t.ambientSH,e.litOptions.fastTbn=t.fastTbn,e.litOptions.twoSidedLighting=t.twoSidedLighting,e.litOptions.occludeSpecular=t.occludeSpecular,e.litOptions.occludeSpecularFloat=1!==t.occludeSpecularIntensity,e.litOptions.useMsdf=!!t.msdfMap,e.litOptions.msdfTextAttribute=!!t.msdfTextAttribute,e.litOptions.alphaToCoverage=t.alphaToCoverage,e.litOptions.opacityFadesSpecular=t.opacityFadesSpecular,e.litOptions.opacityDither=t.opacityDither,e.litOptions.cubeMapProjection=t.cubeMapProjection,e.litOptions.occludeDirect=t.occludeDirect,e.litOptions.conserveEnergy=t.conserveEnergy&&0!==t.shadingModel,e.litOptions.useSpecular=o,e.litOptions.useSpecularityFactor=(d||!!t.specularityFactorMap)&&t.useMetalnessSpecularColor,e.litOptions.enableGGXSpecular=t.enableGGXSpecular,e.litOptions.fresnelModel=t.fresnelModel,e.litOptions.useRefraction=(t.refraction||!!t.refractionMap)&&(t.useDynamicRefraction||!!e.litOptions.reflectionSource),e.litOptions.useClearCoat=!!t.clearCoat,e.litOptions.useSheen=t.useSheen,e.litOptions.useIridescence=t.useIridescence&&0!==t.iridescence,e.litOptions.useMetalness=t.useMetalness,e.litOptions.useDynamicRefraction=t.useDynamicRefraction}_updateEnvOptions(e,t,s){e.litOptions.fog=t.useFog?s.fog:"none",e.litOptions.gamma=t.useGammaTonemap?s.gammaCorrection:0,e.litOptions.toneMap=t.useGammaTonemap?s.toneMapping:-1,e.litOptions.fixSeams=!!t.cubeMap&&t.cubeMap.fixCubemapSeams;const i=0===t.shadingModel;let n=!1;if(t.envAtlas&&t.cubeMap&&!i?(e.litOptions.reflectionSource="envAtlasHQ",e.litOptions.reflectionEncoding=t.envAtlas.encoding,e.litOptions.reflectionCubemapEncoding=t.cubeMap.encoding):t.envAtlas&&!i?(e.litOptions.reflectionSource="envAtlas",e.litOptions.reflectionEncoding=t.envAtlas.encoding):t.cubeMap?(e.litOptions.reflectionSource="cubeMap",e.litOptions.reflectionEncoding=t.cubeMap.encoding):t.sphereMap?(e.litOptions.reflectionSource="sphereMap",e.litOptions.reflectionEncoding=t.sphereMap.encoding):t.useSkybox&&s.envAtlas&&s.skybox&&!i?(e.litOptions.reflectionSource="envAtlasHQ",e.litOptions.reflectionEncoding=s.envAtlas.encoding,e.litOptions.reflectionCubemapEncoding=s.skybox.encoding,n=!0):t.useSkybox&&s.envAtlas&&!i?(e.litOptions.reflectionSource="envAtlas",e.litOptions.reflectionEncoding=s.envAtlas.encoding,n=!0):t.useSkybox&&s.skybox?(e.litOptions.reflectionSource="cubeMap",e.litOptions.reflectionEncoding=s.skybox.encoding,n=!0):(e.litOptions.reflectionSource=null,e.litOptions.reflectionEncoding=null),t.ambientSH&&!i)e.litOptions.ambientSource="ambientSH",e.litOptions.ambientEncoding=null;else{const n=t.envAtlas||(t.useSkybox&&s.envAtlas?s.envAtlas:null);n&&!i?(e.litOptions.ambientSource="envAtlas",e.litOptions.ambientEncoding=n.encoding):(e.litOptions.ambientSource="constant",e.litOptions.ambientEncoding=null)}e.litOptions.skyboxIntensity=n&&(1!==s.skyboxIntensity||s.physicalUnits),e.litOptions.useCubeMapRotation=n&&s._skyboxRotationShaderInclude}_updateLightOptions(e,t,s,i,n){if(e.lightMap=!1,e.lightMapChannel="",e.lightMapUv=0,e.lightMapTransform=0,e.litOptions.lightMapWithoutAmbient=!1,e.dirLightMap=!1,i&&(e.litOptions.noShadow=0!=(1&i),0!=(64&i)&&(e.lightMapEncoding=7===t.lightmapPixelFormat?"rgbm":"linear",e.lightMap=!0,e.lightMapChannel="rgb",e.lightMapUv=1,e.lightMapTransform=0,e.litOptions.lightMapWithoutAmbient=!s.lightMap,0!=(128&i)&&(e.dirLightMap=!0),0!=(8192&i)&&(e.litOptions.lightMapWithoutAmbient=!1))),s.useLighting){const t=[],s=i?i>>16:1;e.litOptions.lightMaskDynamic=!!(1&s),n&&(bg.collectLights(0,n[0],t,s),bg.collectLights(1,n[1],t,s),bg.collectLights(2,n[2],t,s)),e.litOptions.lights=t}else e.litOptions.lights=[];0===e.litOptions.lights.length&&(e.litOptions.noShadow=!0)}_getMapTransformID(e,t){if(!e)return 0;let s=this._mapXForms[t];s||(s=[],this._mapXForms[t]=s);for(let t=0;t<s.length;t++)if(vv(s[t][0].value,e[0].value)&&vv(s[t][1].value,e[1].value))return t+1;return s.push(e)}}function xv(e,t=!0,s=!0){const i={};return i[`${e}Map`]="texture",i[`${e}MapTiling`]="vec2",i[`${e}MapOffset`]="vec2",i[`${e}MapRotation`]="number",i[`${e}MapUv`]="number",t&&(i[`${e}MapChannel`]="string",s&&(i[`${e}VertexColor`]="boolean",i[`${e}VertexColorChannel`]="string")),i}const wv=yp({name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb",ambientTint:"boolean"},xv("ao"),xv("aoDetail",!0,!1),{aoDetailMode:"string",diffuse:"rgb",diffuseTint:"boolean"},xv("diffuse"),xv("diffuseDetail",!0,!1),{diffuseDetailMode:"string",specular:"rgb",specularTint:"boolean"},xv("specular"),{occludeSpecular:"enum:occludeSpecular",specularityFactor:"number",specularityFactorTint:"boolean"},xv("specularityFactor"),{useMetalness:"boolean",metalness:"number",enableGGXSpecular:"boolean",anisotropy:"number",metalnessTint:"boolean"},xv("metalness"),{useMetalnessSpecularColor:"boolean",conserveEnergy:"boolean",shininess:"number",gloss:"number",glossInvert:"boolean"},xv("gloss"),{clearCoat:"number"},xv("clearCoat"),{clearCoatGloss:"number",clearCoatGlossInvert:"boolean"},xv("clearCoatGloss"),{clearCoatBumpiness:"number"},xv("clearCoatNormal",!1),{useSheen:"boolean",sheen:"rgb",sheenTint:"boolean"},xv("sheen"),{sheenGloss:"number",sheenGlossTint:"boolean",sheenGlossInvert:"boolean"},xv("sheenGloss"),{fresnelModel:"number",emissive:"rgb",emissiveTint:"boolean"},xv("emissive"),{emissiveIntensity:"number"},xv("normal",!1),{bumpiness:"number"},xv("normalDetail",!1),{normalDetailMapBumpiness:"number"},xv("height",!0,!1),{heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",alphaFade:"number",opacity:"number"},xv("opacity"),{opacityFadesSpecular:"boolean",opacityDither:"string",opacityShadowDither:"string",reflectivity:"number",refraction:"number",refractionTint:"boolean"},xv("refraction"),{refractionIndex:"number",thickness:"number",thicknessTint:"boolean"},xv("thickness"),{attenuation:"rgb",attenuationDistance:"number",useDynamicRefraction:"boolean",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",useIridescence:"boolean",iridescence:"number",iridescenceTint:"boolean"},xv("iridescence"),{iridescenceThicknessTint:"boolean",iridescenceThicknessMin:"number",iridescenceThicknessMax:"number",iridescenceRefractionIndex:"number"},xv("iridescenceThickness"),xv("light"),{depthTest:"boolean",depthFunc:"enum:depthFunc",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",shadingModel:"enum:shadingModel",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useGammaTonemap:"boolean",envAtlas:"texture",twoSidedLighting:"boolean"}),Sv=[];for(const e in wv){"texture"===wv[e]&&Sv.push(e)}const Cv=[];for(const e in wv){"cubemap"===wv[e]&&Cv.push(e)}const Tv={},Av={};let Ev=new Set;class Pv extends Tf{constructor(){super(),this.userAttributes=new Map,this._dirtyShader=!0,this._assetReferences={},this._activeParams=new Set,this._activeLightingParams=new Set,this.shaderOptBuilder=new bv,this.reset()}reset(){Object.keys(Tv).forEach((e=>{this[`_${e}`]=Tv[e].value()})),this._chunks={},this._uniformCache={}}set shader(e){}get shader(){return null}set chunks(e){this._dirtyShader=!0,this._chunks=e}get chunks(){return this._dirtyShader=!0,this._chunks}copy(e){super.copy(e),Object.keys(Tv).forEach((t=>{this[t]=e[t]}));for(const t in e._chunks)e._chunks.hasOwnProperty(t)&&(this._chunks[t]=e._chunks[t]);return this}setAttribute(e,t){this.userAttributes.set(t,e)}_setParameter(e,t){Ev.add(e),this.setParameter(e,t)}_setParameters(e){e.forEach((e=>{this._setParameter(e.name,e.value)}))}_processParameters(e){const t=this[e];t.forEach((e=>{Ev.has(e)||delete this.parameters[e]})),this[e]=Ev,Ev=t,Ev.clear()}_updateMap(e){const t=e+"Map",s=this[t];if(s){this._setParameter("texture_"+t,s);const e=t+"Transform",i=this.getUniform(e);i&&this._setParameters(i)}}_allocUniform(e,t){let s=this._uniformCache[e];return s||(s=t(),this._uniformCache[e]=s),s}getUniform(e,t,s){return Av[e](this,t,s)}updateUniforms(e,t){const s=s=>this.getUniform(s,e,t);this._setParameter("material_ambient",s("ambient")),this.diffuseMap&&!this.diffuseTint||this._setParameter("material_diffuse",s("diffuse")),this.useMetalness?((!this.metalnessMap||this.metalness<1)&&this._setParameter("material_metalness",this.metalness),this.specularMap&&!this.specularTint||this._setParameter("material_specular",s("specular")),this.specularityFactorMap&&!this.specularityFactorTint||this._setParameter("material_specularityFactor",this.specularityFactor),this.sheenMap&&!this.sheenTint||this._setParameter("material_sheen",s("sheen")),this.sheenGlossMap&&!this.sheenGlossTint||this._setParameter("material_sheenGloss",this.sheenGloss),this._setParameter("material_refractionIndex",this.refractionIndex)):this.specularMap&&!this.specularTint||this._setParameter("material_specular",s("specular")),this.enableGGXSpecular&&this._setParameter("material_anisotropy",this.anisotropy),this.clearCoat>0&&(this._setParameter("material_clearCoat",this.clearCoat),this._setParameter("material_clearCoatGloss",this.clearCoatGloss),this._setParameter("material_clearCoatBumpiness",this.clearCoatBumpiness)),this._setParameter("material_gloss",s("gloss")),this.emissiveMap&&!this.emissiveTint||this._setParameter("material_emissive",s("emissive")),1!==this.emissiveIntensity&&this._setParameter("material_emissiveIntensity",this.emissiveIntensity),this.refraction>0&&this._setParameter("material_refraction",this.refraction),this.useDynamicRefraction&&(this._setParameter("material_thickness",this.thickness),this._setParameter("material_attenuation",s("attenuation")),this._setParameter("material_invAttenuationDistance",0===this.attenuationDistance?0:1/this.attenuationDistance)),this.useIridescence&&(this._setParameter("material_iridescence",this.iridescence),this._setParameter("material_iridescenceRefractionIndex",this.iridescenceRefractionIndex),this._setParameter("material_iridescenceThicknessMin",this.iridescenceThicknessMin),this._setParameter("material_iridescenceThicknessMax",this.iridescenceThicknessMax)),this._setParameter("material_opacity",this.opacity),!1===this.opacityFadesSpecular&&this._setParameter("material_alphaFade",this.alphaFade),this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity),1===this.cubeMapProjection&&this._setParameter(s("cubeMapProjectionBox"));for(const e in _v)this._updateMap(e);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH),this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness),this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness),this.heightMap&&this._setParameter("material_heightMapFactor",s("heightMapFactor"));const i=0===this.shadingModel;this.envAtlas&&this.cubeMap&&!i?(this._setParameter("texture_envAtlas",this.envAtlas),this._setParameter("texture_cubeMap",this.cubeMap)):this.envAtlas&&!i?this._setParameter("texture_envAtlas",this.envAtlas):this.cubeMap?this._setParameter("texture_cubeMap",this.cubeMap):this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap),this._setParameter("material_reflectivity",this.reflectivity),this._processParameters("_activeParams"),this._dirtyShader&&this.clearVariants()}updateEnvUniforms(e,t){const s=0===this.shadingModel;!(this.envAtlas&&!s||this.cubeMap||this.sphereMap)&&this.useSkybox&&(t.envAtlas&&t.skybox&&!s?(this._setParameter("texture_envAtlas",t.envAtlas),this._setParameter("texture_cubeMap",t.skybox)):t.envAtlas&&!s?this._setParameter("texture_envAtlas",t.envAtlas):t.skybox&&this._setParameter("texture_cubeMap",t.skybox)),this._processParameters("_activeLightingParams")}getShaderVariant(e,t,s,i,n,r,a,o,l){this.updateEnvUniforms(e,t);const h=yf.get(e).getByIndex(n),c=2===n||3===n||5===n||h.isShadow;let d=c?gv.optionsContextMin:gv.optionsContext;c?this.shaderOptBuilder.updateMinRef(d,t,this,s,n,r):this.shaderOptBuilder.updateRef(d,t,this,s,n,r),this.onUpdateShader&&(d=this.onUpdateShader(d));const u=new Rm(a,o,l),p=nf(e);p.register("standard",gv);const m=p.getProgram("standard",d,u,this.userId);return this._dirtyShader=!1,m}destroy(){for(const e in this._assetReferences)this._assetReferences[e]._unbind();this._assetReferences=null,super.destroy()}}Pv.TEXTURE_PARAMETERS=Sv,Pv.CUBEMAP_PARAMETERS=Cv;const Mv=(e,t)=>{Av[e]=t},Lv=(e,t,s,i)=>{Object.defineProperty(Pv.prototype,e,{get:i||function(){return this[`_${e}`]},set:s}),Tv[e]={value:t}},Dv=e=>{const t=`_${e.name}`,s=e.dirtyShaderFunc||(()=>!0);Lv(e.name,(()=>e.defaultValue),(function(e){const i=this[t];i!==e&&(this._dirtyShader=this._dirtyShader||s(i,e),this[t]=e)}),e.getterFunc)},kv=e=>{const t=`_${e.name}`,s=e.dirtyShaderFunc||(()=>!0);Lv(e.name,(()=>e.defaultValue.clone()),(function(e){const i=this[t];i.equals(e)||(this._dirtyShader=this._dirtyShader||s(i,e),this[t]=i.copy(e))}),e.getterFunc)},Iv=e=>e.defaultValue&&e.defaultValue.clone?kv(e):Dv(e);function Rv(e,t="rgb",s=!0,i=0){_v[e]=t.length||-1,Iv({name:`${e}Map`,defaultValue:null,dirtyShaderFunc:(e,t)=>!!e!=!!t||e&&(e.type!==t.type||e.fixCubemapSeams!==t.fixCubemapSeams||e.format!==t.format)}),Iv({name:`${e}MapTiling`,defaultValue:new au(1,1)}),Iv({name:`${e}MapOffset`,defaultValue:new au(0,0)}),Iv({name:`${e}MapRotation`,defaultValue:0}),Iv({name:`${e}MapUv`,defaultValue:i}),t&&(Iv({name:`${e}MapChannel`,defaultValue:t}),s&&(Iv({name:`${e}VertexColor`,defaultValue:!1}),Iv({name:`${e}VertexColorChannel`,defaultValue:t})));const n=`${e}MapTiling`,r=`${e}MapOffset`,a=`${e}MapRotation`,o=`${e}MapTransform`;Mv(o,((e,t,s)=>{const i=e[n],l=e[r],h=e[a];if(1===i.x&&1===i.y&&0===l.x&&0===l.y&&0===h)return null;const c=e._allocUniform(o,(()=>[{name:`texture_${o}0`,value:new Float32Array(3)},{name:`texture_${o}1`,value:new Float32Array(3)}])),d=Math.cos(h*Wd.DEG_TO_RAD),u=Math.sin(h*Wd.DEG_TO_RAD),p=c[0].value;p[0]=d*i.x,p[1]=-u*i.y,p[2]=l.x;const m=c[1].value;return m[0]=u*i.x,m[1]=d*i.y,m[2]=1-i.y-l.y,c}))}function Ov(e,t){Iv({name:e,defaultValue:t,getterFunc:function(){return this._dirtyShader=!0,this[`_${e}`]}}),Mv(e,((t,s,i)=>{const n=t._allocUniform(e,(()=>new Float32Array(3))),r=t[e];return t.useGammaTonemap&&i.gammaCorrection?(n[0]=Math.pow(r.r,2.2),n[1]=Math.pow(r.g,2.2),n[2]=Math.pow(r.b,2.2)):(n[0]=r.r,n[1]=r.g,n[2]=r.b),n}))}function zv(e,t,s){Iv({name:e,defaultValue:t,dirtyShaderFunc:(e,t)=>(0===e||1===e)!=(0===t||1===t)}),Mv(e,s)}function Fv(e,t){Iv({name:e,defaultValue:null,dirtyShaderFunc:(e,t)=>!!e==!!t}),Mv(e,t)}function Vv(e,t){Iv({name:e,defaultValue:t})}!function(){Ov("ambient",new jd(.7,.7,.7)),Ov("diffuse",new jd(1,1,1)),Ov("specular",new jd(0,0,0)),Ov("emissive",new jd(0,0,0)),Ov("sheen",new jd(1,1,1)),Ov("attenuation",new jd(1,1,1)),zv("emissiveIntensity",1),zv("specularityFactor",1),zv("sheenGloss",0),zv("gloss",.25,((e,t,s)=>0===e.shadingModel?Math.pow(2,11*e.gloss):e.gloss)),zv("heightMapFactor",1,((e,t,s)=>.025*e.heightMapFactor)),zv("opacity",1),zv("alphaFade",1),zv("alphaTest",0),zv("bumpiness",1),zv("normalDetailMapBumpiness",1),zv("reflectivity",1),zv("occludeSpecularIntensity",1),zv("refraction",0),zv("refractionIndex",1/1.5),zv("thickness",0),zv("attenuationDistance",0),zv("metalness",1),zv("anisotropy",0),zv("clearCoat",0),zv("clearCoatGloss",1),zv("clearCoatBumpiness",1),zv("aoUvSet",0,null),zv("iridescence",0),zv("iridescenceRefractionIndex",1/1.5),zv("iridescenceThicknessMin",0),zv("iridescenceThicknessMax",0),Fv("ambientSH"),Fv("cubeMapProjectionBox",((e,t,s)=>{const i=e._allocUniform("cubeMapProjectionBox",(()=>[{name:"envBoxMin",value:new Float32Array(3)},{name:"envBoxMax",value:new Float32Array(3)}])),n=e.cubeMapProjectionBox.getMin(),r=i[0].value;r[0]=n.x,r[1]=n.y,r[2]=n.z;const a=e.cubeMapProjectionBox.getMax(),o=i[1].value;return o[0]=a.x,o[1]=a.y,o[2]=a.z,i})),Vv("ambientTint",!1),Vv("diffuseTint",!1),Vv("specularTint",!1),Vv("specularityFactorTint",!1),Vv("emissiveTint",!1),Vv("fastTbn",!1),Vv("useMetalness",!1),Vv("useMetalnessSpecularColor",!1),Vv("useSheen",!1),Vv("enableGGXSpecular",!1),Vv("occludeDirect",!1),Vv("normalizeNormalMap",!0),Vv("conserveEnergy",!0),Vv("opacityFadesSpecular",!0),Vv("occludeSpecular",1),Vv("shadingModel",1),Vv("fresnelModel",2),Vv("useDynamicRefraction",!1),Vv("cubeMapProjection",0),Vv("customFragmentShader",null),Vv("useFog",!0),Vv("useLighting",!0),Vv("useGammaTonemap",!0),Vv("useSkybox",!0),Vv("forceUv1",!1),Vv("pixelSnap",!1),Vv("twoSidedLighting",!1),Vv("nineSlicedMode",void 0),Vv("msdfTextAttribute",!1),Vv("useIridescence",!1),Vv("glossInvert",!1),Vv("sheenGlossInvert",!1),Vv("clearCoatGlossInvert",!1),Vv("opacityDither",V_),Vv("opacityShadowDither",V_),Rv("diffuse"),Rv("specular"),Rv("emissive"),Rv("thickness","g"),Rv("specularityFactor","g"),Rv("normal",""),Rv("metalness","g"),Rv("gloss","g"),Rv("opacity","a"),Rv("refraction","g"),Rv("height","g",!1),Rv("ao","g"),Rv("light","rgb",!0,1),Rv("msdf",""),Rv("diffuseDetail","rgb",!1),Rv("normalDetail",""),Rv("aoDetail","g",!1),Rv("clearCoat","g"),Rv("clearCoatGloss","g"),Rv("clearCoatNormal",""),Rv("sheen","rgb"),Rv("sheenGloss","g"),Rv("iridescence","g"),Rv("iridescenceThickness","g"),Vv("diffuseDetailMode","mul"),Vv("aoDetailMode","mul"),Fv("cubeMap"),Fv("sphereMap"),Fv("envAtlas");const e=[null,null,null,null,null,null];Lv("prefilteredCubemaps",(()=>e.slice()),(function(e){const t=this._prefilteredCubemaps;e=e||[];let s=!1,i=!0;for(let n=0;n<6;++n){const r=e[n]||null;t[n]!==r&&(t[n]=r,s=!0),i=i&&!!t[n]}s&&(i?this.envAtlas=pv.generatePrefilteredAtlas(t,{target:this.envAtlas}):this.envAtlas&&(this.envAtlas.destroy(),this.envAtlas=null),this._dirtyShader=!0)}),(function(){return this._prefilteredCubemaps}))}(),new nu(1,1,1),new nu(40,0,0);class Nv{constructor(e,t){this.texture=e,this.cached=!1,this.renderTargets=t}destroy(){this.texture&&(this.texture.destroy(),this.texture=null);const e=this.renderTargets;for(let t=0;t<e.length;t++)e[t].destroy();this.renderTargets.length=0}static getShadowFormat(e,t){return 3===t?Du:2===t?Lu:4===t?16:5!==t&&0!==t||!e.supportsDepthShadow?6!==t||e.isWebGL1?7:ku:16}static getShadowFiltering(e,t){return 5!==t&&0!==t&&6!==t||e.supportsDepthShadow?3===t?e.extTextureFloatLinear?1:0:2===t?e.extTextureHalfFloatLinear?1:0:1:0}static create(e,t){let s=null;return s=1===t._type?this.createCubemap(e,t._shadowResolution,t._shadowType):this.create2dMap(e,t._shadowResolution,t._shadowType),s}static createAtlas(e,t,s){const i=this.create2dMap(e,t,s),n=i.renderTargets,r=n[0];for(let e=0;e<5;e++)n.push(r);return i}static create2dMap(e,t,s){const i=this.getShadowFormat(e,s),n=this.getShadowFiltering(e,s),r=new bm(e,{format:i,width:t,height:t,mipmaps:!1,minFilter:n,magFilter:n,addressU:1,addressV:1,name:"ShadowMap2D"});let a=null;return 4===s||(5===s||0===s)&&e.supportsDepthShadow?(r.compareOnRead=!0,r.compareFunc=1,a=new qp({depthBuffer:r})):a=new qp({colorBuffer:r,depth:!0}),e.isWebGPU&&(a.flipY=!0),new Nv(r,[a])}static createCubemap(e,t,s){const i=6!==s||e.isWebGL1?7:ku,n=new bm(e,{format:i,width:t,height:t,cubemap:!0,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1,name:"ShadowMapCube"}),r=[];for(let e=0;e<6;e++){const t=new qp({colorBuffer:n,face:e,depth:!0});r.push(t)}return new Nv(n,r)}}const Bv=[],Uv=[],Hv=new ou,Wv=new ou;class Gv{constructor(e){this.size=Math.floor(1024*e.w),this.used=!1,this.lightId=-1,this.rect=e}}class jv{constructor(e){this.device=e,this.version=1,this.shadowAtlasResolution=2048,this.shadowAtlas=null,this.shadowEdgePixels=3,this.cookieAtlasResolution=4,this.cookieAtlas=new bm(this.device,{name:"CookieAtlas",width:this.cookieAtlasResolution,height:this.cookieAtlasResolution,format:7,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1}),this.cookieRenderTarget=new qp({colorBuffer:this.cookieAtlas,depth:!1,flipY:!0}),this.slots=[],this.atlasSplit=[],this.cubeSlotsOffsets=[new au(0,0),new au(0,1),new au(1,0),new au(1,1),new au(2,0),new au(2,1)],this.scissorVec=new ou,this.allocateShadowAtlas(1),this.allocateCookieAtlas(1),this.allocateUniforms()}destroy(){this.destroyShadowAtlas(),this.destroyCookieAtlas()}destroyShadowAtlas(){var e;null==(e=this.shadowAtlas)||e.destroy(),this.shadowAtlas=null}destroyCookieAtlas(){var e,t;null==(e=this.cookieAtlas)||e.destroy(),this.cookieAtlas=null,null==(t=this.cookieRenderTarget)||t.destroy(),this.cookieRenderTarget=null}allocateShadowAtlas(e){if(!this.shadowAtlas||this.shadowAtlas.texture.width!==e){this.version++,this.destroyShadowAtlas(),this.shadowAtlas=Nv.createAtlas(this.device,e,0),this.shadowAtlas.cached=!0;const t=4/this.shadowAtlasResolution;this.scissorVec.set(t,t,-2*t,-2*t)}}allocateCookieAtlas(e){this.cookieAtlas.width!==e&&(this.cookieRenderTarget.resize(e,e),this.version++)}allocateUniforms(){this._shadowAtlasTextureId=this.device.scope.resolve("shadowAtlasTexture"),this._shadowAtlasParamsId=this.device.scope.resolve("shadowAtlasParams"),this._shadowAtlasParams=new Float32Array(2),this._cookieAtlasTextureId=this.device.scope.resolve("cookieAtlasTexture")}updateUniforms(){const e=this.shadowAtlas.renderTargets[0],t=!this.device.isWebGL1&&!0?e.depthBuffer:e.colorBuffer;this._shadowAtlasTextureId.setValue(t),this._shadowAtlasParams[0]=this.shadowAtlasResolution,this._shadowAtlasParams[1]=this.shadowEdgePixels,this._shadowAtlasParamsId.setValue(this._shadowAtlasParams),this._cookieAtlasTextureId.setValue(this.cookieAtlas)}subdivide(e,t){let s=t.atlasSplit;if(!s){const t=Math.ceil(Math.sqrt(e));s=Uv,s[0]=t,s.length=1}if(!((e,t)=>e.length===t.length&&e.every(((e,s)=>e===t[s])))(s,this.atlasSplit)){this.version++,this.slots.length=0,this.atlasSplit.length=0,this.atlasSplit.push(...s);const e=this.atlasSplit[0];if(e>1){const t=1/e;for(let s=0;s<e;s++)for(let i=0;i<e;i++){const n=new ou(s*t,i*t,t,t),r=this.atlasSplit[1+s*e+i];if(r>1)for(let e=0;e<r;e++)for(let s=0;s<r;s++){const i=t/r,a=new ou(n.x+e*i,n.y+s*i,i,i);this.slots.push(new Gv(a))}else this.slots.push(new Gv(n))}}else this.slots.push(new Gv(new ou(0,0,1,1)));this.slots.sort(((e,t)=>t.size-e.size))}}collectLights(e,t){const s=t.cookiesEnabled,i=t.shadowsEnabled;let n=!1,r=!1;const a=Bv;a.length=0;return(s||i)&&(e=>{for(let t=0;t<e.length;t++){const o=e[t];if(o.visibleThisFrame){const e=i&&o.castShadows,t=s&&!!o.cookie;n||(n=e),r||(r=t),(e||t)&&a.push(o)}}})(e),a.sort(((e,t)=>t.maxScreenSize-e.maxScreenSize)),n&&this.allocateShadowAtlas(this.shadowAtlasResolution),r&&this.allocateCookieAtlas(this.cookieAtlasResolution),(n||r)&&this.subdivide(a.length,t),a}setupSlot(e,t){e.atlasViewport.copy(t);const s=e.numShadowFaces;for(let i=0;i<s;i++)if(e.castShadows||e._cookie){if(Hv.copy(t),Wv.copy(t),2===e._type&&Hv.add(this.scissorVec),1===e._type){const e=Hv.z/3,t=this.cubeSlotsOffsets[i];Hv.x+=e*t.x,Hv.y+=e*t.y,Hv.z=e,Hv.w=e,Wv.copy(Hv)}if(e.castShadows){const t=e.getRenderData(null,i);t.shadowViewport.copy(Hv),t.shadowScissor.copy(Wv)}}}assignSlot(e,t,s){e.atlasViewportAllocated=!0;const i=this.slots[t];i.lightId=e.id,i.used=!0,s&&(e.atlasSlotUpdated=!0,e.atlasVersion=this.version,e.atlasSlotIndex=t)}update(e,t){this.shadowAtlasResolution=t.shadowAtlasResolution,this.cookieAtlasResolution=t.cookieAtlasResolution;const s=this.collectLights(e,t);if(s.length>0){const e=this.slots;for(let t=0;t<e.length;t++)e[t].used=!1;const t=Math.min(s.length,e.length);for(let i=0;i<t;i++){const t=s[i];t.castShadows&&(t._shadowMap=this.shadowAtlas);const n=e[t.atlasSlotIndex];if(t.atlasVersion===this.version&&t.id===(null==n?void 0:n.lightId)){const s=e[t.atlasSlotIndex];s.size!==e[i].size||s.used||this.assignSlot(t,t.atlasSlotIndex,!1)}}let i=0;for(let n=0;n<t;n++){for(;i<e.length&&e[i].used;)i++;const t=s[n];t.atlasViewportAllocated||this.assignSlot(t,i,!0);const r=e[t.atlasSlotIndex];this.setupSlot(t,r.rect)}}this.updateUniforms()}}const qv=[new nu(-1,0,0),new nu(1,0,0),new nu(0,-1,0),new nu(0,1,0),new nu(0,0,-1),new nu(0,0,1)];class Kv{constructor(){this.colors=new Float32Array(18)}update(e,t){const s=this.colors,{r:i,g:n,b:r}=e;for(let e=0;e<6;e++)s[3*e]=i,s[3*e+1]=n,s[3*e+2]=r;for(let e=0;e<t.length;e++){const i=t[e];if(0===i._type)for(let e=0;e<6;e++){const t=Math.max(qv[e].dot(i._direction),0)*i._intensity,n=i._color;s[3*e]+=n.r*t,s[3*e+1]+=n.g*t,s[3*e+2]+=n.b*t}}}}class Xv{constructor(){this.cache=new Map}destroy(){this.clear(),this.cache=null}clear(){this.cache.forEach((e=>{e.forEach((e=>{e.destroy()}))})),this.cache.clear()}getKey(e){return`${1===e._type}-${e._shadowType}-${e._shadowResolution}`}get(e,t){const s=this.getKey(t),i=this.cache.get(s);if(i&&i.length)return i.pop();const n=Nv.create(e,t);return n.cached=!0,n}add(e,t){const s=this.getKey(e),i=this.cache.get(s);i?i.push(t):this.cache.set(s,[t])}}class Yv extends Im{constructor(e,t,s,i,n){super(e),this.requiresCubemaps=!1,this.shadowRenderer=t,this.light=s,this.face=i,this.applyVsm=n,this.shadowCamera=t.prepareFace(s,null,i),t.setupRenderPass(this,this.shadowCamera,!0)}execute(){this.shadowRenderer.renderFace(this.light,null,this.face,!1)}after(){this.applyVsm&&this.shadowRenderer.renderVsm(this.light,this.shadowCamera)}}class Zv{constructor(e,t){this.shadowLights=[],this.renderer=void 0,this.shadowRenderer=void 0,this.device=void 0,this.renderer=e,this.shadowRenderer=t,this.device=e.device}cull(e,t,s=null){const i=this.renderer.scene.clusteredLightingEnabled;e.visibleThisFrame=!0,i||e._shadowMap||(e._shadowMap=Nv.create(this.device,e));const n=e._type,r=2===n?1:6;for(let a=0;a<r;a++){const r=e.getRenderData(null,a),o=r.shadowCamera;o.nearClip=e.attenuationEnd/1e3,o.farClip=e.attenuationEnd,r.depthRangeCompensation=o.farClip-o.nearClip;const l=o._node,h=e._node;if(l.setPosition(h.getPosition()),2===n)o.fov=2*e._outerConeAngle,l.setRotation(h.getRotation()),l.rotateLocal(-90,0,0);else if(1===n)if(i){const t=2/(this.shadowRenderer.lightTextureAtlas.shadowAtlasResolution*e.atlasViewport.z/3)*this.shadowRenderer.lightTextureAtlas.shadowEdgePixels;o.fov=Math.atan(1+t)*Wd.RAD_TO_DEG*2}else o.fov=90;this.renderer.updateCameraFrustum(o),this.shadowRenderer.cullShadowCasters(t,e,r.visibleCasters,o,s)}}prepareLights(e,t){let s;for(let i=0;i<t.length;i++){const n=t[i];if(this.shadowRenderer.needsShadowRendering(n)&&n.atlasViewportAllocated){e.push(n);for(let e=0;e<n.numShadowFaces;e++)s=this.shadowRenderer.prepareFace(n,null,e)}}return s}buildNonClusteredRenderPasses(e,t){for(let s=0;s<t.length;s++){const i=t[s];if(this.shadowRenderer.needsShadowRendering(i)){const t=2===i._type,s=i.numShadowFaces;for(let n=0;n<s;n++){const s=new Yv(this.device,this.shadowRenderer,i,n,t);e.addRenderPass(s)}}}}}class $v extends Im{constructor(e,t,s,i,n){super(e),this.shadowRenderer=t,this.light=s,this.camera=i,this.allCascadesRendering=n}execute(){const{light:e,camera:t,shadowRenderer:s,allCascadesRendering:i}=this,n=e.numShadowFaces,r=e.shadowUpdateOverrides;for(let a=0;a<n;a++)0!==(null==r?void 0:r[a])&&s.renderFace(e,t,a,!i),1===(null==r?void 0:r[a])&&(r[a]=0)}after(){this.shadowRenderer.renderVsm(this.light,this.camera)}}const Qv=new xu,Jv=new nu,ey=new pu,ty=[new nu,new nu,new nu,new nu,new nu,new nu,new nu,new nu],sy={min:0,max:0};function iy(e,t,s){ty[0].x=ty[1].x=ty[2].x=ty[3].x=t.x,ty[1].y=ty[3].y=ty[7].y=ty[5].y=t.y,ty[2].z=ty[3].z=ty[6].z=ty[7].z=t.z,ty[4].x=ty[5].x=ty[6].x=ty[7].x=s.x,ty[0].y=ty[2].y=ty[4].y=ty[6].y=s.y,ty[0].z=ty[1].z=ty[4].z=ty[5].z=s.z;let i=9999999999,n=-9999999999;for(let t=0;t<8;++t){e.transformPoint(ty[t],ty[t]);const s=ty[t].z;s<i&&(i=s),s>n&&(n=s)}return sy.min=i,sy.max=n,sy}class ny{constructor(e,t){this.renderer=void 0,this.shadowRenderer=void 0,this.device=void 0,this.renderer=e,this.shadowRenderer=t,this.device=e.device}cull(e,t,s,i=null){e.visibleThisFrame=!0,e._shadowMap||(e._shadowMap=Nv.create(this.device,e));const n=s._nearClip;this.generateSplitDistances(e,n,Math.min(s._farClip,e.shadowDistance));const r=e.shadowUpdateOverrides;for(let a=0;a<e.numCascades&&0!==(null==r?void 0:r[a]);a++){const r=e.getRenderData(s,a),o=r.shadowCamera;o.renderTarget=e._shadowMap.renderTargets[0],r.shadowViewport.copy(e.cascades[a]),r.shadowScissor.copy(e.cascades[a]);const l=o._node,h=e._node;l.setPosition(h.getPosition()),l.setRotation(h.getRotation()),l.rotateLocal(-90,0,0);const c=0===a?n:e._shadowCascadeDistances[a-1],d=e._shadowCascadeDistances[a],u=s.getFrustumCorners(c,d);Jv.set(0,0,0);const p=s.node.getWorldTransform();for(let e=0;e<8;e++)p.transformPoint(u[e],u[e]),Jv.add(u[e]);Jv.mulScalar(1/8);let m=0;for(let e=0;e<8;e++){const t=u[e].sub(Jv).length();t>m&&(m=t)}const _=l.right,f=l.up,g=l.forward,v=.25*e._shadowResolution/m,y=Math.ceil(Jv.dot(f)*v)/v,b=Math.ceil(Jv.dot(_)*v)/v,x=f.mulScalar(y),w=_.mulScalar(b),S=Jv.dot(g),C=g.mulScalar(S);Jv.add2(x,w).add(C),l.setPosition(Jv),l.translateLocal(0,0,1e6),o.nearClip=.01,o.farClip=2e6,o.orthoHeight=m,this.renderer.updateCameraFrustum(o),this.shadowRenderer.cullShadowCasters(t,e,r.visibleCasters,o,i);let T=!0;const A=r.visibleCasters;for(let e=0;e<A.length;e++){const t=A[e];T?(T=!1,Qv.copy(t.aabb)):Qv.add(t.aabb)}ey.copy(l.getWorldTransform()).invert();const E=iy(ey,Qv.getMin(),Qv.getMax());l.translateLocal(0,0,E.max+.1),o.farClip=E.max-E.min+.2,r.depthRangeCompensation=o.farClip,r.projectionCompensation=m}}generateSplitDistances(e,t,s){e._shadowCascadeDistances.fill(s);for(let i=1;i<e.numCascades;i++){const n=i/e.numCascades,r=t+(s-t)*n,a=t*(s/t)**n,o=Wd.lerp(r,a,e.cascadeDistribution);e._shadowCascadeDistances[i-1]=o}}getLightRenderPass(e,t){let s=null;if(this.shadowRenderer.needsShadowRendering(e)){const i=e.numShadowFaces,n=e.shadowUpdateOverrides;let r,a=!0;for(let s=0;s<i;s++)0===(null==n?void 0:n[s])&&(a=!1),r=this.shadowRenderer.prepareFace(e,t,s);s=new $v(this.device,this.shadowRenderer,e,t,a),this.shadowRenderer.setupRenderPass(s,r,a)}return s}}function ry(e,t){return Math.exp(-e*e/(2*t*t))}const ay=new Set,oy=new pu,ly=new pu,hy=new Float32Array(2),cy=new ou(1,1,0,0),dy=new pu;class uy{constructor(e,t){this.shadowPassCache=[],this.device=e.device,this.renderer=e,this.lightTextureAtlas=t;const s=this.device.scope;this.polygonOffsetId=s.resolve("polygonOffset"),this.polygonOffset=new Float32Array(2),this.sourceId=s.resolve("source"),this.pixelOffsetId=s.resolve("pixelOffset"),this.weightId=s.resolve("weight[0]"),this.blurVsmShaderCode=[tf.blurVSMPS,"#define GAUSS\n"+tf.blurVSMPS];const i="#define PACKED\n";this.blurPackedVsmShaderCode=[i+this.blurVsmShaderCode[0],i+this.blurVsmShaderCode[1]],this.blurVsmShader=[{},{}],this.blurPackedVsmShader=[{},{}],this.blurVsmWeights={},this.shadowMapLightRadiusId=s.resolve("light_radius"),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this.blendStateWrite=new Sp,this.blendStateNoWrite=new Sp,this.blendStateNoWrite.setColorWrite(!1,!1,!1,!1)}static createShadowCamera(e,t,s,i){const n=Pg.create("ShadowCamera",s,i);return n.clearColor=t>=1&&t<=3?new jd(0,0,0,0):new jd(1,1,1,1),n.clearDepthBuffer=!0,n.clearStencilBuffer=!1,n}static setShadowCameraSettings(e,t,s,i,n){let r=4===s||(5===s||0===s)&&t.supportsDepthShadow;1!==i||n||(r=!1),e.clearColorBuffer=!r}_cullShadowCastersInternal(e,t,s){const i=e.length;for(let n=0;n<i;n++){const i=e[n];i.castShadow&&(i.cull&&!i._isVisible(s)||(i.visibleThisFrame=!0,t.push(i)))}}cullShadowCasters(e,t,s,i,n){if(s.length=0,n)this._cullShadowCastersInternal(n,s,i);else{const n=e.layerList,r=n.length;for(let e=0;e<r;e++){const r=n[e];r._lightsSet.has(t)&&(ay.has(r)||(ay.add(r),this._cullShadowCastersInternal(r.shadowCasters,s,i)))}ay.clear()}s.sort(this.renderer.sortCompareDepth)}setupRenderState(e,t){e.isWebGL1&&e.extStandardDerivatives&&(1===t._type?(this.polygonOffset[0]=0,this.polygonOffset[1]=0,this.polygonOffsetId.setValue(this.polygonOffset)):(this.polygonOffset[0]=-1e3*t.shadowBias,this.polygonOffset[1]=-1e3*t.shadowBias,this.polygonOffsetId.setValue(this.polygonOffset)));const s=this.renderer.scene.clusteredLightingEnabled,i=e.isWebGL2||e.isWebGPU,n=s?t._isPcf&&i:t._isPcf&&i&&1!==t._type;e.setBlendState(n?this.blendStateNoWrite:this.blendStateWrite),e.setDepthState(t.shadowDepthState),e.setStencilState(null,null)}dispatchUniforms(e,t,s,i){const n=t._node;0!==e._type&&(this.renderer.dispatchViewPos(n.getPosition()),this.shadowMapLightRadiusId.setValue(e.attenuationEnd)),oy.setTRS(n.getPosition(),n.getRotation(),nu.ONE).invert(),ly.mul2(t.projectionMatrix,oy);const r=s.shadowViewport;t.rect=r,t.scissorRect=s.shadowScissor,dy.setViewport(r.x,r.y,r.z,r.w),s.shadowMatrix.mul2(dy,ly),0===e._type&&e._shadowMatrixPalette.set(s.shadowMatrix.data,16*i)}getShadowPass(e){var t;const s=e._type,i=e._shadowType;let n=null==(t=this.shadowPassCache[s])?void 0:t[i];if(!n){const e=`ShadowPass_${s}_${i}`;n=yf.get(this.device).allocate(e,{isShadow:!0,lightType:s,shadowType:i}),this.shadowPassCache[s]||(this.shadowPassCache[s]=[]),this.shadowPassCache[s][i]=n}return n.index}submitCasters(e,t){const s=this.device,i=this.renderer,n=i.scene,r=this.getShadowPass(t),a=e.length;for(let t=0;t<a;t++){const a=e[t],o=a.mesh;a.ensureMaterial(s);const l=a.material;i.setBaseConstants(s,l),i.setSkinning(s,a),l.dirty&&(l.updateUniforms(s,n),l.dirty=!1),l.chunks&&(i.setupCullMode(!0,1,a),l.setParameters(s),a.setParameters(s,16));const h=a.getShaderInstance(r,0,n,this.viewUniformFormat,this.viewBindGroupFormat),c=h.shader;a._key[1]=c.id,s.setShader(c),i.setVertexBuffers(s,o),i.setMorphing(s,a.morphInstance),this.renderer.setupMeshUniformBuffers(h,a);const d=a.renderStyle;s.setIndexBuffer(o.indexBuffer[d]),i.drawInstance(s,a,o,d),i._shadowDrawCalls++}}needsShadowRendering(e){const t=e.enabled&&e.castShadows&&0!==e.shadowUpdateMode&&e.visibleThisFrame;return 1===e.shadowUpdateMode&&(e.shadowUpdateMode=0),t&&(this.renderer._shadowMapUpdates+=e.numShadowFaces),t}getLightRenderData(e,t,s){return e.getRenderData(0===e._type?t:null,s)}setupRenderPass(e,t,s){const i=t.renderTarget;e.init(i),e.depthStencilOps.clearDepthValue=1,e.depthStencilOps.clearDepth=s,i.depthBuffer?e.depthStencilOps.storeDepth=!0:(e.colorOps.clearValue.copy(t.clearColor),e.colorOps.clear=s,e.depthStencilOps.storeDepth=!1),e.requiresCubemaps=!1}prepareFace(e,t,s){const i=e._type,n=e._shadowType,r=this.renderer.scene.clusteredLightingEnabled,a=this.getLightRenderData(e,t,s).shadowCamera;uy.setShadowCameraSettings(a,this.device,n,i,r);const o=0===i?0:s;return a.renderTarget=e._shadowMap.renderTargets[o],a}renderFace(e,t,s,i,n=!0){const r=this.device,a=this.getLightRenderData(e,t,s),o=a.shadowCamera;this.dispatchUniforms(e,o,a,s);const l=o.renderTarget,h=this.renderer;h.setCameraUniforms(o,l),r.supportsUniformBuffers&&h.setupViewUniformBuffers(a.viewBindGroups,this.viewUniformFormat,this.viewBindGroupFormat,1),n?(h.setupViewport(o,l),i&&h.clear(o)):h.clearView(o,l,!0,!1),this.setupRenderState(r,e),this.submitCasters(a.visibleCasters,e)}render(e,t,s=!0){if(this.needsShadowRendering(e)){const i=e.numShadowFaces;for(let n=0;n<i;n++)this.prepareFace(e,t,n),this.renderFace(e,t,n,!0,s);this.renderVsm(e,t)}}renderVsm(e,t){if(e._isVsm&&e._vsmBlurSize>1){this.renderer.scene.clusteredLightingEnabled&&0!==e._type||this.applyVsmBlur(e,t)}}getVsmBlurShader(e,t,s){let i=(e?this.blurPackedVsmShader:this.blurVsmShader)[t][s];if(!i){this.blurVsmWeights[s]=function(e){const t=(e-1)/6,s=.5*(e-1),i=new Array(e);let n=0;for(let r=0;r<e;++r)i[r]=ry(r-s,t),n+=i[r];for(let t=0;t<e;++t)i[t]/=n;return i}(s);const n=tf.fullscreenQuadVS;let r="#define SAMPLES "+s+"\n";r+=e?this.blurPackedVsmShaderCode[t]:this.blurVsmShaderCode[t];const a="blurVsm"+t+s+e;i=of(this.device,n,r,a),e?this.blurPackedVsmShader[t][s]=i:this.blurVsmShader[t][s]=i}return i}applyVsmBlur(e,t){const s=this.device;s.setBlendState(Sp.NOBLEND);const i=e.getRenderData(0===e._type?t:null,0).shadowCamera.renderTarget,n=this.renderer.shadowMapCache.get(s,e),r=n.renderTargets[0],a=1===e._shadowType,o=e.vsmBlurMode,l=e._vsmBlurSize,h=this.getVsmBlurShader(a,o,l);cy.z=e._shadowResolution-2,cy.w=cy.z,this.sourceId.setValue(i.colorBuffer),hy[0]=1/e._shadowResolution,hy[1]=0,this.pixelOffsetId.setValue(hy),1===o&&this.weightId.setValue(this.blurVsmWeights[l]),ff(s,r,h,null,cy),this.sourceId.setValue(r.colorBuffer),hy[1]=hy[0],hy[0]=0,this.pixelOffsetId.setValue(hy),ff(s,i,h,null,cy),this.renderer.shadowMapCache.add(e,n)}initViewBindGroupFormat(){this.device.supportsUniformBuffers&&!this.viewUniformFormat&&(this.viewUniformFormat=new Yp(this.device,[new Xp("matrix_viewProjection",14)]),this.viewBindGroupFormat=new em(this.device,[new Qp(mp,3)],[]))}frameUpdate(){this.initViewBindGroupFormat()}}const py=[];class my{constructor(e){this._empty=null,this._allocated=[],this._clusters=new Map,this.device=e}destroy(){this._empty&&(this._empty.destroy(),this._empty=null),this._allocated.forEach((e=>{e.destroy()})),this._allocated.length=0}get count(){return this._allocated.length}get empty(){if(!this._empty){const e=new Kg(this.device);e.name="ClusterEmpty",e.update([],!1,null),this._empty=e}return this._empty}assign(e){const t=this.empty;py.push(...this._allocated),this._allocated.length=0,this._clusters.clear();const s=e.length;for(let n=0;n<s;n++){const s=e[n].renderActions;if(s){const e=s.length;for(let n=0;n<e;n++){const e=s[n];e.lightClusters=null;const r=e.layer;if(r.hasClusteredLights&&r.meshInstances.length){const t=r.getLightIdHash(),s=this._clusters.get(t);let n=null==s?void 0:s.lightClusters;var i;if(!n)n=null!=(i=py.pop())?i:new Kg(this.device),this._allocated.push(n),this._clusters.set(t,e);e.lightClusters=n}e.lightClusters||(e.lightClusters=t)}}}py.forEach((e=>e.destroy())),py.length=0}update(e,t,s){this.assign(e),this._clusters.forEach((e=>{const i=e.layer;e.lightClusters.update(i.clusteredLightsSet,t,s)}))}}const _y="\n\tattribute vec2 vertex_position;\n\tvarying vec2 uv0;\n\tvoid main(void) {\n\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\tuv0 = vertex_position.xy * 0.5 + 0.5;\n\t\t#ifndef WEBGPU\n\t\t\tuv0.y = 1.0 - uv0.y;\n\t\t#endif\n\t}",fy=new ou,gy=[];class vy extends Im{constructor(e,t){super(e),this._quadRenderer2D=null,this._quadRendererCube=null,this._filteredLights=[],this._cubeSlotsOffsets=t,this.requiresCubemaps=!1,this.blitTextureId=e.scope.resolve("blitTexture"),this.invViewProjId=e.scope.resolve("invViewProj")}destroy(){var e,t;null==(e=this._quadRenderer2D)||e.destroy(),this._quadRenderer2D=null,null==(t=this._quadRendererCube)||t.destroy(),this._quadRendererCube=null}static create(e,t){const s=new vy(e.device,t);return s.init(e),s.colorOps.clear=!1,s.depthStencilOps.clearDepth=!1,s}update(e){const t=this._filteredLights;this.filter(e,t),this.executeEnabled=t.length>0}filter(e,t){for(let s=0;s<e.length;s++){const i=e[s];0!==i._type&&(i.atlasViewportAllocated&&i.atlasSlotUpdated&&i.enabled&&i.cookie&&i.visibleThisFrame&&t.push(i))}}initInvViewProjMatrices(){if(!gy.length)for(let e=0;e<6;e++){const t=Pg.create(null,1,e),s=t.projectionMatrix,i=t.node.getLocalTransform().clone().invert();gy[e]=(new pu).mul2(s,i).invert()}}get quadRenderer2D(){if(!this._quadRenderer2D){const e=of(this.device,_y,"\n\tvarying vec2 uv0;\n\tuniform sampler2D blitTexture;\n\tvoid main(void) {\n\t\tgl_FragColor = texture2D(blitTexture, uv0);\n\t}","cookieRenderer2d");this._quadRenderer2D=new pf(e)}return this._quadRenderer2D}get quadRendererCube(){if(!this._quadRendererCube){const e=of(this.device,_y,"\n\tvarying vec2 uv0;\n\tuniform samplerCube blitTexture;\n\tuniform mat4 invViewProj;\n\tvoid main(void) {\n\t\tvec4 projPos = vec4(uv0 * 2.0 - 1.0, 0.5, 1.0);\n\t\tvec4 worldPos = invViewProj * projPos;\n\t\tgl_FragColor = textureCube(blitTexture, worldPos.xyz);\n\t}","cookieRendererCube");this._quadRendererCube=new pf(e)}return this._quadRendererCube}execute(){const e=this.device;e.setBlendState(Sp.NOBLEND),e.setCullMode(0),e.setDepthState(Ep.NODEPTH),e.setStencilState();const t=this.renderTarget.colorBuffer.width,s=this._cubeSlotsOffsets,i=this._filteredLights;for(let e=0;e<i.length;e++){const n=i[e],r=n.numShadowFaces,a=r>1?this.quadRendererCube:this.quadRenderer2D;r>1&&this.initInvViewProjMatrices(),this.blitTextureId.setValue(n.cookie);for(let e=0;e<r;e++){if(fy.copy(n.atlasViewport),r>1){const t=fy.z/3,i=s[e];fy.x+=t*i.x,fy.y+=t*i.y,fy.z=t,fy.w=t,this.invViewProjId.setValue(gy[e].data)}fy.mulScalar(t),a.render(fy)}}i.length=0}}class yy extends Im{constructor(e,t,s){super(e),this.requiresCubemaps=!1,this.shadowRenderer=t,this.shadowRendererLocal=s}update(e){const t=this.shadowRendererLocal.shadowLights,s=this.shadowRendererLocal.prepareLights(t,e),i=t.length;this.enabled=i>0,i&&this.shadowRenderer.setupRenderPass(this,s,!1)}execute(){const e=this.shadowRendererLocal.shadowLights,t=e.length;for(let s=0;s<t;s++){const t=e[s];for(let e=0;e<t.numShadowFaces;e++)this.shadowRenderer.renderFace(t,null,e,!0)}e.length=0}}class by extends Im{constructor(e,t,s,i,n){super(e),this.renderer=t,this.frameGraph=null,this.cookiesRenderPass=vy.create(n.cookieRenderTarget,n.cubeSlotsOffsets),this.beforePasses.push(this.cookiesRenderPass),this.shadowRenderPass=new yy(e,s,i),this.beforePasses.push(this.shadowRenderPass)}update(e,t,s,i,n){this.frameGraph=e,this.cookiesRenderPass.enabled=s,s&&this.cookiesRenderPass.update(i),this.shadowRenderPass.enabled=t,t&&this.shadowRenderPass.update(n)}destroy(){this.cookiesRenderPass.destroy(),this.cookiesRenderPass=null}execute(){const{renderer:e}=this,{scene:t}=e;e.worldClustersAllocator.update(this.frameGraph.renderPasses,t.gammaCorrection,t.lighting)}}let xy=null;const wy=()=>{if(!xy){const e=atob("muPIHORMLNDCz4DxVR/ZvYfAUVEFR47KRIC4nwAAAAAP7WxlhD6Ci+2HCe7BF8jRAPZwdH2UPpI5PdLCJdkvG4UTaNDJ/0crAzne71GCrb4kbdMjjCEGzdX6fNxDMLJq5xkeoIVTdfiZkodEeArmZmp/FQzFjD4x8iOW7Dg64n+3mWqyEwLxXT8zoJXfbw8QJKDCaarUYyTlMzNFHbgUe9IQV7g4YOgtSKpIFZJ0qERm7u4PpmiF89ktHWCywaGmD6h+hfh2/Zd8KYlKqqo4Cem4T42bT/Z9FpCQF1hhSjfBzZ5XFn/y3jegWC6u86KuELRundQS/1Rp+XuKKGIgRv3CvP5y749yqLlFO495JOT3+f2CXgd71npU0/KjjpkZucbJ5m78IVyuSrSozc9jgBUhDrz0hFsyb7LFUH9//wJbBgLdNWJZObfKxrNt8TliLA9w9sXFv6g26iXpf6r/BqcAusj/QzGBZuoUGeEtw8BCXCZ3jUiw4hvM18ZVqlUD3C40LAFXW6FRjuAZGRNstb0/qVk4skwyT+MHrvRorI4rKHVMWZmKyAkzL/78u/9pMQuX14pZN50b2PHn6fRxeaCQLsfT4dpvIkWWFuFVENZIh+8xgR6lU+85W0PPdAu1j99kcCG40JBQa4JMyRzq6qriOBLtqF87vpCJan0WEduVr/mOYkS00urVA0mA6M3031+GmGmW48PaJDYOEIb3bIXWPaLoAOEinX1TN3+/vwhG6nqJu0TdHpedS7QsGZIoxH3nQYYjQP1jmbahlbNngw5ogsGk1y50XZyUmQBY+/JBJ3Unu4dApm+WmPwHPU9gLb+4mHh4BiY6M86pq+WeTyWdI3s0CXPEtHGXZ8zMZgUoyRomBi1VdazzuN+WOmQ9Pa0Z0tlNopUi8AJ4x2Xn4mmOKEbXLxlbVsWu8XhuDGYFOGCRVdSqDPXrHU5SDdUlti3k5///SBwzTMwK3L4a1H7w4lnpEas6////AfX8asyIBfeFXVJ3tgvxQ/blZuUKyIODIfr/UzdWNu7pciLBpdZRZ4pIfZ1R6szq+XNxkGG///8EZFpu7VHAhFWqHEOrB9unw+YQa5o8/9IR/V5/zq+986rJSyfgJKt2u9hxU1wzyQWPjJGvzG9+eWWxGFOHVKqI4jBQALwZZswesnvZ2UmmkEXdiRpz8B+oWE7PY70ZTMndisYSXg2TqoI+3y9BxbnY2Y4EfbdcRhAvG59NqDENNYbxKvK5HJfPG5M+Wi2AcpLVJrD6caiEOzgSoVNSgQK8fm2M3zGcF4xtClv/8Hs9oD7C3jitTATYNQxmKqKf1LhIxzf1bmfiNn7UKFmcJu4sLqVLwxGSue3taBEyknkw5hXTsUCvqmmL/f8n/w0giR7Hu/9EHvpkz3yuu64TioMkzdTJ30i0+hFnQqW1+v9mMwq+z9qGX0UFu9MomvVG2xod6vc12AAAAACq7sGa5qptFR0jF3nQt/D+7PibKYahaxP3hEixPbGi9nwNf2LAa7LkEZRKxzXeCD64Xpii5n+8Kpg8eHIv7AWXZltgMoGltmoJ0XGdOCL8WkzphvR9N2o3ARSZ42l5e5Pe4B58MCRlP3EKv+mcloknH+fto5BWsmEutW6KvjOVsznFCktkSczVk4aGvj9VXlRcLeDoKG8RkBgdcNG2bf8HUL4MT2DM+ar7NImJhKpxakX4Vk0CnP+/XNhl5UsP0lXgeZXPoDBMSW5An+DXlTCO5FQGwSPYwHLKYVIimEdAoVe49rQLaaNcye5LxU2/c5TijTgJtD5eQQIe1snxauj5jZsxJBUJdoP/zqpjqv8qBruoPsVsP8N44PCUW5Dd0DzqjSS/Dl5mI9cn1w2ndN/0KAEm1QAAAACwu6KM/083IBbH5bPa/9oHUwcU8I9v3j6/v18QYammrf+P6VL///8BrpuM3fOLCxaLNOFNF1zPbPYTP65ni6njft4eVcyrVXRQFrs52tr35StiSp55edVDCBC0H5rIfac6nzUwxQSt7y15QoKb+5zebEQUmVbrPjXuUa19Ey7sqXMiSUKHaw72PJKDdrutJoQr3u6lEYJ8K0MakWKj9zjTFi4X94TsKYco0GrLeB60M6D8M/80rhXUW8iMequg8y5F838WI0+gp3GBN5Kj/xIOxTWQuUaPV/LwvARr1VH93BFgGZR1MFW0Ua30GbYmdnAgo9VWy8SQtpDUgGE2r2zq2eTEMCL7sMKmE1hchVhuF/TCq9iXKEm86kzOf3Rp9ZnCxbpDUj+FKNxVyXe6pVZkRXv/m95SnB/EB8aME29N85MtAcDoXWlor8De2Q5Dg1tar+8wgiZufbMam81j//ASUohoR/zSh2KG4bvT6mkIPz6C5/98DC3LaWlaEZ1zA5JORZRu6J/a0GY285sEYzw71YqOT1ihAG0z5SDt1xNiDQWZdFpndArp6xWhqSDkRb4kSJEHb9liPvw7uLV/6i5MVf//A9Qjr8xkAEUh+KDI+zdtJ68d6MBOktg1iyp/SCq8O9f5pbamn1VVVQPRTWqNBvhQKa07s6P0lc9Luu/3gw4HeyOUfz8MxMwV4UQhua+t9cr4bz/nIB2wnDSK1K7I94M+s6C84htaX/CNlMQUSs2KJO+yaebfTbkNX5yWcqEJevo0vbKUiETuFXiL019A3E+lmsyZMwXrXLLiQAZ5t9+jI3JobhJTMiDH5ZOQ+8Jau5555NMjHSscP9qCVaa40doh+1a3Ukf6jqBmLddgh79/fwTfCyqiuldNkUoy+nUp+4nerwg0OjtGv2x485PJOJvUEokNhYIdWjpx7BWk0VZGWOp3jSFTJ2bnu6KCduZtG/UcBC9RZ3W/jMSfSMw4Etr/DoD/XYP2V5Ovw+YoM3F5g2dGLdvuG6ZkVGLE6Dk5Zr+sdSyGliJP1y2OFf/KFO0RWO+3gsGhesTnfZVpTd8/HwgO216gwaqo+vY3TljfJWowY+i0p0Os4SLn/1wLqDHMlszggmT/D8MRFzs+pLv6LNJSsNZ/r41mWi/rF6ZcKp/yzJdK0VU44hskq3RGpgO6mIpJDsf/mZkFrz0yYOMLbuaj/wp1v7JMFM5eqvBhmTd7U8frQAtHtys4zgpjZmzUhOVTfNNLifElGXADlqHGKrkBT/nYwX8ZRm3RjvyPvjKyEqEGKUpVnvOGx+NKPHiWM//ZDpDVGvvrjmk8RPF/wiYZD3+Us8YCXjrVOfjdd1UPAfjLp8jgSn4me7DPTpz1Ggy9XL80guFO7ECT10AvILKfD18Qx+KY/f8aRqu0oOO8hfKRFZa9PUJwCsp6VdZz6LFkm2b9Pl2LIifCwzRy7TpdG2uAtOxP2OemY26bJMa9ZGSLIRlMsgpDpnDJwd0oa5pQ13x1hrHf52HpulUWonGWsfXZbSQYKu9bnEN76ciQih0opN3deDVrbrxorfVlnCmL1R9zq3ePGWIv21c7pW8kEiFTM5JX8dAw867s/60cf79/BH+MDFCZBHlz1L+qGOJf/1txhhmrf3//As+RIJwevDb+fgNXVeHw67QptZegayhrEwr5Gy+EPo1RLaMtPbqOZYoVzXzwzjMFWZxyUG9YUIf6////AQWy84iAygLk9COtXt92+0mT/xg0zMzMBeLkb8y9SL2TDXgSX422hDgpGNLJyuPioA+YJ91G8znrpNqHkwYyscaJDEc9Vc+j4cXle3hvcd2JqDQH2lBZxDn6mUTs0b75raMvbs727codX01Anj8f3wir9P2xQaQ22v/TxCMglKDFoTjaP01XTLgxnTvPv02JgEUrW6UDgOnobFpLdvKdlypgIzPcq14fgXU5tvVW0FEs7VRlsG1IyA69fN4n+awHhT34cE+xUvdj86C8LgAsFheTjI9Ht9EyYAAAAAAVBVKRx2wLgUTI0/2QfyJo2riRw3JDqzEShmx/Lifo6mRkQVbS7X53t+EvKxcXogtdts31e9MRHdcHgsA8rt4/mt2unlzQ/wsU8Gu7+W6Oj7eD8EQdDp5XlCsVaS/AV/t5ZpPOHR3rGpyAJe9IPV+xMrBL1Oz/8MQhFs31h0N1cVnq371uqIJYHyafKH1jteAK3VpMXBcuC+yt0ZeKyRUY4QhdrJJ4tJ1wg3Hu6kDsbovxupTMkGdRrm8oZSoYPbJ+PwH/xotgTdkA1205vUEfnqkI04T/fnnd1fiZW5AwNcggd7fi4j5zasmcntZexIxqFZQMzMJpfndmI5jn17cgn5EV5t9XN0C///8Q9wlJpMGXdoiaMTG2sVyHQsn8mWRISCLNG777S0OuDRP2GlLcJ2UeOg7Fo8hTNPeJ//iTJhyqxhKRUntdXOihq2wfKfH///8B0GGrwT+fSOQRdctKxjjGCSS11d6BlQ9BDfE0J6Z25FaNTKGpFKNCMr2G/041KpWwBLVe1k08vncseQbKZdXi8x1t9XA45U/Wd43D9wAh3Tal0aiLVzGPusOZ1F+W3TWoqlX/A95+dNef11TsuGful+ctGssldk3fqpfqh+43XTxL42+leSHoF/dWHYGX6maqUEuLX7UB+r/6Llr4LKocbVIeu+hB9QTPfz9fCP8RyWmX4SmbhMFsNtCijV7lVcwejLKlvl0GfCndnWV7/39VBrtTRuUx92oke3GBgKkC5fdGK0YvNK+xenKaDmsHDjNFUM3NMz3ZiXXFuLgojosPVCDEl2W5BjX3Ms+j0GSqACHmh0+RPWyuNm/Qe8vFf9AW7N1uRaxWirrUytqEJnJ4/Flm8hSoiZ2NQBsS6w/yQlC4gCaFo8q4nyY6AFdo4hiwhBXzbNKKvZvktCjSCukRR/BbYVbNwZi2Yh3hGodEacLW8qijiWJODf0P2bhfaiPspPT4lYJBgi/KfcFwCfvyUIgkJOv///8CG/JEepRBLaMFE+2TgrqsJXOVOWHt6g/bFwVLLMVBsMR50dis/39/AlBX+/rMTJkUQrnlxpR2iu0Tp8tATkRYGmDIrcAiRP8PjoWIlb7/0ecTdSCE9Y58+a+n/FovJQTVF4F2jAxMZhTgrM/KVS5BQu6bVbkWY5HXnxRshks3urDdW4RkWp4M4TeLmFK5KF/uHkkiO5Kv96RioH984v/CSDBnG+BwlnU9B+o7Y+0X0Nob+0pLsStxjvPXMy2eCpzhOWV4XbObBHN4UE2sLQ/DIqXhOzxVf38GlTi6aG7EnePO7TRJm9yOfUUcqq1I2iQHrVDqn3TUNRi/lMw8KbMW/3/nqCz/Ef8PoW5Qxcz2yHR/f78EPB2Stbd+ZFmfNTUYILzsb9YNhpaHcaymYrBiNHmFE3Y4ccYJ25Prqm7zHobGHED8/93ZNlWro9vcKivGZs31UiK1k5zjUhexUgbqJb+fUTjxce/7Zly8a5KMC1fX5nfjPgibdvzbXV1jRT2asXvmSAusaLdq1TSIJ8fXINk5AtT34EWPAsfP9IFQqM5K11O6saoHJA==");xy=Uint8Array.from(e,(e=>e.charCodeAt(0)))}},Sy=()=>(wy(),xy);class Cy{constructor(e=0){this.seed=0,this.seed=4*e,wy()}_next(){this.seed=(this.seed+4)%xy.length}value(){return this._next(),xy[this.seed]/255}vec4(e=new ou){return this._next(),e.set(xy[this.seed],xy[this.seed+1],xy[this.seed+2],xy[this.seed+3]).mulScalar(1/255)}}const Ty=new zp;let Ay=0;const Ey=new pu,Py=new pu,My=new pu,Ly=new ru,Dy=new Cu,ky=(new pu).setScale(1,-1,1),Iy=new Set,Ry=new Set,Oy=new ou,zy=(new pu).set([1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1]),Fy=[new au(.5,.333333),new au(.25,.666667),new au(.75,.111111),new au(.125,.444444),new au(.625,.777778),new au(.375,.222222),new au(.875,.555556),new au(.0625,.888889),new au(.5625,.037037),new au(.3125,.37037),new au(.8125,.703704),new au(.1875,.148148),new au(.6875,.481481),new au(.4375,.814815),new au(.9375,.259259),new au(.03125,.592593)],Vy=new pu,Ny=new pu,By=new pu,Uy=new pu,Hy=new pu,Wy=new pu,Gy=new Set,jy=[],qy=[];class Ky{constructor(e){this.clustersDebugRendered=!1,this.processingMeshInstances=new Set,this.worldClustersAllocator=void 0,this.lights=[],this.localLights=[],this.cameraDirShadowLights=new Map,this.dirLightShadows=new Map,this.blueNoise=new Cy(123),this.device=e,this.scene=null,this.worldClustersAllocator=new my(e),this.lightTextureAtlas=new jv(e),this.shadowMapCache=new Xv,this.shadowRenderer=new uy(this,this.lightTextureAtlas),this._shadowRendererLocal=new Zv(this,this.shadowRenderer),this._shadowRendererDirectional=new ny(this,this.shadowRenderer),this._renderPassUpdateClustered=new by(this.device,this,this.shadowRenderer,this._shadowRendererLocal,this.lightTextureAtlas),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this._skinTime=0,this._morphTime=0,this._cullTime=0,this._shadowMapTime=0,this._lightClustersTime=0,this._layerCompositionUpdateTime=0,this._shadowDrawCalls=0,this._skinDrawCalls=0,this._instancedDrawCalls=0,this._shadowMapUpdates=0,this._numDrawCallsCulled=0,this._camerasRendered=0,this._lightClusters=0;const t=e.scope;this.boneTextureId=t.resolve("texture_poseMap"),this.boneTextureSizeId=t.resolve("texture_poseMapSize"),this.poseMatrixId=t.resolve("matrix_pose[0]"),this.modelMatrixId=t.resolve("matrix_model"),this.normalMatrixId=t.resolve("matrix_normal"),this.viewInvId=t.resolve("matrix_viewInverse"),this.viewPos=new Float32Array(3),this.viewPosId=t.resolve("view_position"),this.projId=t.resolve("matrix_projection"),this.projSkyboxId=t.resolve("matrix_projectionSkybox"),this.viewId=t.resolve("matrix_view"),this.viewId3=t.resolve("matrix_view3"),this.viewProjId=t.resolve("matrix_viewProjection"),this.flipYId=t.resolve("projectionFlipY"),this.tbnBasis=t.resolve("tbnBasis"),this.nearClipId=t.resolve("camera_near"),this.farClipId=t.resolve("camera_far"),this.cameraParams=new Float32Array(4),this.cameraParamsId=t.resolve("camera_params"),this.viewIndexId=t.resolve("view_index"),this.blueNoiseJitterId=t.resolve("blueNoiseJitter"),this.blueNoiseTextureId=t.resolve("blueNoiseTex32"),this.alphaTestId=t.resolve("alpha_ref"),this.opacityMapId=t.resolve("texture_opacityMap"),this.exposureId=t.resolve("exposure"),this.twoSidedLightingNegScaleFactorId=t.resolve("twoSidedLightingNegScaleFactor"),this.twoSidedLightingNegScaleFactorId.setValue(0),this.morphWeightsA=t.resolve("morph_weights_a"),this.morphWeightsB=t.resolve("morph_weights_b"),this.morphPositionTex=t.resolve("morphPositionTex"),this.morphNormalTex=t.resolve("morphNormalTex"),this.morphTexParams=t.resolve("morph_tex_params"),this.lightCube=new Kv,this.constantLightCube=t.resolve("lightCube[0]")}destroy(){this.shadowRenderer=null,this._shadowRendererLocal=null,this._shadowRendererDirectional=null,this.shadowMapCache.destroy(),this.shadowMapCache=null,this._renderPassUpdateClustered.destroy(),this._renderPassUpdateClustered=null,this.lightTextureAtlas.destroy(),this.lightTextureAtlas=null}sortCompare(e,t){if(e.layer===t.layer){if(e.drawOrder&&t.drawOrder)return e.drawOrder-t.drawOrder;if(e.zdist&&t.zdist)return t.zdist-e.zdist;if(e.zdist2&&t.zdist2)return e.zdist2-t.zdist2}return t._key[0]-e._key[0]}sortCompareMesh(e,t){if(e.layer===t.layer){if(e.drawOrder&&t.drawOrder)return e.drawOrder-t.drawOrder;if(e.zdist&&t.zdist)return t.zdist-e.zdist}const s=e._key[0],i=t._key[0];return s===i&&e.mesh&&t.mesh?t.mesh.id-e.mesh.id:i-s}sortCompareDepth(e,t){const s=e._key[1],i=t._key[1];return s===i&&e.mesh&&t.mesh?t.mesh.id-e.mesh.id:i-s}setupViewport(e,t){const s=this.device,i=t?t.width:s.width,n=t?t.height:s.height,r=e.rect;let a=Math.floor(r.x*i),o=Math.floor(r.y*n),l=Math.floor(r.z*i),h=Math.floor(r.w*n);if(s.setViewport(a,o,l,h),e._scissorRectClear){const t=e.scissorRect;a=Math.floor(t.x*i),o=Math.floor(t.y*n),l=Math.floor(t.z*i),h=Math.floor(t.w*n)}s.setScissor(a,o,l,h)}setCameraUniforms(e,t){const s=null==t?void 0:t.flipY;let i=1;if(e.xr&&e.xr.session){var n;const t=(null==(n=e._node)||null==(n=n.parent)?void 0:n.getWorldTransform())||null,s=e.xr.views;i=s.list.length;for(let n=0;n<i;n++){const i=s.list[n];i.updateTransforms(t),e.frustum.setFromMat4(i.projViewOffMat)}}else{let i=e.projectionMatrix;e.calculateProjection&&e.calculateProjection(i,0);let n=e.getProjectionMatrixSkybox();s&&(i=Vy.mul2(ky,i),n=Ny.mul2(ky,n)),this.device.isWebGPU&&(i=By.mul2(zy,i),n=Uy.mul2(zy,n));const{jitter:r}=e;let a=ou.ZERO,o=0,l=0;if(r>0){const e=t?t.width:this.device.width,s=t?t.height:this.device.height,h=Fy[this.device.renderVersion%Fy.length];o=r*(2*h.x-1)/e,l=r*(2*h.y-1)/s,i=Hy.copy(i),i.data[8]=o,i.data[9]=l,n=Wy.copy(n),n.data[8]=o,n.data[9]=l,a=this.blueNoise.vec4(Oy)}if(this.blueNoiseJitterId.setValue([a.x,a.y,a.z,a.w]),this.projId.setValue(i.data),this.projSkyboxId.setValue(n.data),e.calculateTransform)e.calculateTransform(Py,0);else{const t=e._node.getPosition(),s=e._node.getRotation();Py.setTRS(t,s,nu.ONE)}this.viewInvId.setValue(Py.data),My.copy(Py).invert(),this.viewId.setValue(My.data),Ly.setFromMat4(My),this.viewId3.setValue(Ly.data),Ey.mul2(i,My),this.viewProjId.setValue(Ey.data),e._storeShaderMatrices(Ey,o,l,this.device.renderVersion),this.flipYId.setValue(s?-1:1),this.dispatchViewPos(e._node.getPosition()),e.frustum.setFromMat4(Ey)}this.tbnBasis.setValue(s?-1:1);const r=e._nearClip,a=e._farClip;return this.nearClipId.setValue(r),this.farClipId.setValue(a),this.cameraParams[0]=1/a,this.cameraParams[1]=a,this.cameraParams[2]=r,this.cameraParams[3]=1===e.projection?1:0,this.cameraParamsId.setValue(this.cameraParams),this.exposureId.setValue(this.scene.physicalUnits?e.getExposure():this.scene.exposure),i}clear(e,t,s,i){const n=((null!=t?t:e._clearColorBuffer)?1:0)|((null!=s?s:e._clearDepthBuffer)?2:0)|((null!=i?i:e._clearStencilBuffer)?4:0);if(n){this.device.clear({color:[e._clearColor.r,e._clearColor.g,e._clearColor.b,e._clearColor.a],depth:e._clearDepth,stencil:e._clearStencil,flags:n})}}setCamera(e,t,s,i=null){this.setCameraUniforms(e,t),this.clearView(e,t,s,!1)}clearView(e,t,s,i){const n=this.device;if(n.setRenderTarget(t),n.updateBegin(),i&&(n.setColorWrite(!0,!0,!0,!0),n.setDepthWrite(!0)),this.setupViewport(e,t),s){const t=e._clearOptions;n.clear(t||{color:[e._clearColor.r,e._clearColor.g,e._clearColor.b,e._clearColor.a],depth:e._clearDepth,flags:(e._clearColorBuffer?1:0)|(e._clearDepthBuffer?2:0)|(e._clearStencilBuffer?4:0),stencil:e._clearStencil})}}setupCullMode(e,t,s){const i=s.material;let n=0;if(e){let e=1;2!==i.cull&&1!==i.cull||(e=t*s.flipFacesFactor*s.node.worldScaleSign),n=e<0?2===i.cull?1:2:i.cull}this.device.setCullMode(n),0===n&&0===i.cull&&this.twoSidedLightingNegScaleFactorId.setValue(s.node.worldScaleSign)}updateCameraFrustum(e){if(e.xr&&e.xr.views.list.length){const t=e.xr.views.list[0];return Ey.mul2(t.projMat,t.viewOffMat),void e.frustum.setFromMat4(Ey)}const t=e.projectionMatrix;if(e.calculateProjection&&e.calculateProjection(t,0),e.calculateTransform)e.calculateTransform(Py,0);else{const t=e._node.getPosition(),s=e._node.getRotation();Py.setTRS(t,s,nu.ONE),this.viewInvId.setValue(Py.data)}My.copy(Py).invert(),Ey.mul2(t,My),e.frustum.setFromMat4(Ey)}setBaseConstants(e,t){e.setCullMode(t.cull),t.opacityMap&&this.opacityMapId.setValue(t.opacityMap),(t.opacityMap||t.alphaTest>0)&&this.alphaTestId.setValue(t.alphaTest)}updateCpuSkinMatrices(e){Ay++;const t=e.length;if(0!==t)for(let s=0;s<t;s++){const t=e[s].skinInstance;t&&(t.updateMatrices(e[s].node,Ay),t._dirty=!0)}}updateGpuSkinMatrices(e){for(const t of e){const e=t.skinInstance;e&&e._dirty&&(e.updateMatrixPalette(t.node,Ay),e._dirty=!1)}}updateMorphing(e){for(const t of e){const e=t.morphInstance;e&&e._dirty&&e.update()}}updateGSplats(e){for(const s of e){var t;null==(t=s.gsplatInstance)||t.update()}}gpuUpdate(e){this.updateGpuSkinMatrices(e),this.updateMorphing(e),this.updateGSplats(e)}setVertexBuffers(e,t){e.setVertexBuffer(t.vertexBuffer)}setMorphing(e,t){if(t)if(t.morph.useTextureMorph)e.setVertexBuffer(t.morph.vertexBufferIds),this.morphPositionTex.setValue(t.texturePositions),this.morphNormalTex.setValue(t.textureNormals),this.morphTexParams.setValue(t._textureParams);else{for(let s=0;s<t._activeVertexBuffers.length;s++){const i=t._activeVertexBuffers[s];if(i){const t="ATTR"+(s+8);i.format.elements[0].name=t,i.format.elements[0].scopeId=e.scope.resolve(t),i.format.update(),e.setVertexBuffer(i)}}this.morphWeightsA.setValue(t._shaderMorphWeightsA),this.morphWeightsB.setValue(t._shaderMorphWeightsB)}}setSkinning(e,t){const s=t.skinInstance;if(s)if(this._skinDrawCalls++,e.supportsBoneTextures){const e=s.boneTexture;this.boneTextureId.setValue(e),this.boneTextureSizeId.setValue(s.boneTextureSize)}else this.poseMatrixId.setValue(s.matrixPalette)}dispatchViewPos(e){const t=this.viewPos;t[0]=e.x,t[1]=e.y,t[2]=e.z,this.viewPosId.setValue(t)}initViewBindGroupFormat(e){if(this.device.supportsUniformBuffers&&!this.viewUniformFormat){const t=[new Xp("matrix_viewProjection",14),new Xp("cubeMapRotationMatrix",13),new Xp("view_position",4),new Xp("skyboxIntensity",2),new Xp("exposure",2),new Xp("textureBias",2)];e&&t.push(new Xp("clusterCellsCountByBoundsSize",4),new Xp("clusterTextureSize",4),new Xp("clusterBoundsMin",4),new Xp("clusterBoundsDelta",4),new Xp("clusterCellsDot",4),new Xp("clusterCellsMax",4),new Xp("clusterCompressionLimit0",3),new Xp("shadowAtlasParams",3),new Xp("clusterMaxCells",1),new Xp("clusterSkip",2)),this.viewUniformFormat=new Yp(this.device,t);const s=[new Qp(mp,3)],i=[new Jp("lightsTextureFloat",2,np,1),new Jp("lightsTexture8",2,np,1),new Jp("shadowAtlasTexture",2,np,2),new Jp("cookieAtlasTexture",2,np,0),new Jp("areaLightsLutTex1",2,np,0),new Jp("areaLightsLutTex2",2,np,0)];e&&i.push(new Jp("clusterWorldTexture",2,np,1)),this.viewBindGroupFormat=new em(this.device,s,i)}}setupViewUniformBuffers(e,t,s,i){const n=this.device;for(;e.length<i;){const i=new vm(n,t,!1),r=new _m(n,s,i);e.push(r)}const r=e[0];r.defaultUniformBuffer.update(),r.update(),n.setBindGroup(1,r)}setupMeshUniformBuffers(e,t){const s=this.device;if(s.supportsUniformBuffers){this.modelMatrixId.setValue(t.node.worldTransform.data),this.normalMatrixId.setValue(t.node.normalMatrix.data);const i=e.getBindGroup(s);i.defaultUniformBuffer.update(),i.update(),s.setBindGroup(0,i)}}drawInstance(e,t,s,i,n){const r=t.node.worldTransform;this.modelMatrixId.setValue(r.data),n&&this.normalMatrixId.setValue(t.node.normalMatrix.data);const a=t.instancingData;a?a.count>0&&(this._instancedDrawCalls++,e.setVertexBuffer(a.vertexBuffer),e.draw(s.primitive[i],a.count)):e.draw(s.primitive[i])}drawInstance2(e,t,s,i){const n=t.instancingData;n?n.count>0&&(this._instancedDrawCalls++,e.draw(s.primitive[i],n.count,!0)):e.draw(s.primitive[i],void 0,!0)}cull(e,t,s){const i=s.opaque;i.length=0;const n=s.transparent;n.length=0;const r=e.frustumCulling,a=t.length;for(let s=0;s<a;s++){const a=t[s];if(a.visible){if(!r||!a.cull||a._isVisible(e)){a.visibleThisFrame=!0;(a.transparent?n:i).push(a),(a.skinInstance||a.morphInstance||a.gsplatInstance)&&(this.processingMeshInstances.add(a),a.gsplatInstance&&a.gsplatInstance.cameras.push(e))}}}}collectLights(e){this.lights.length=0,this.localLights.length=0;const t=this.scene._stats,s=e.layerList.length;for(let t=0;t<s;t++){const s=e.layerList[t];if(!Ry.has(s)){Ry.add(s);const e=s._lights;for(let t=0;t<e.length;t++){const s=e[t];Iy.has(s)||(Iy.add(s),this.lights.push(s),0!==s._type&&this.localLights.push(s))}}}t.lights=this.lights.length,Iy.clear(),Ry.clear()}cullLights(e,t){const s=this.scene.clusteredLightingEnabled,i=this.scene.physicalUnits;for(let n=0;n<t.length;n++){const r=t[n];if(r.enabled)if(0!==r._type)if(r.getBoundingSphere(Dy),e.frustum.containsSphere(Dy)){r.visibleThisFrame=!0,r.usePhysicalUnits=i;const t=e.getScreenSize(Dy);r.maxScreenSize=Math.max(r.maxScreenSize,t)}else s||r.castShadows&&!r.shadowMap&&(r.visibleThisFrame=!0);else r.usePhysicalUnits=this.scene.physicalUnits}}cullShadowmaps(e){const t=this.scene.clusteredLightingEnabled;for(let s=0;s<this.localLights.length;s++){const i=this.localLights[s];0!==i._type&&(t?i.atlasSlotUpdated&&0===i.shadowUpdateMode&&(i.shadowUpdateMode=1):0===i.shadowUpdateMode&&i.castShadows&&(i.getRenderData(null,0).shadowCamera.renderTarget||(i.shadowUpdateMode=1)),i.visibleThisFrame&&i.castShadows&&0!==i.shadowUpdateMode&&this._shadowRendererLocal.cull(i,e))}this.cameraDirShadowLights.clear();const s=e.cameras;for(let t=0;t<s.length;t++){const n=s[t];if(n.enabled){const t=n.camera;let s;const r=t.layers;for(let n=0;n<r.length;n++){const a=e.getLayerById(r[n]);if(a){const n=a.splitLights[0];for(let r=0;r<n.length;r++){const a=n[r];var i;if(a.castShadows&&!Gy.has(a))Gy.add(a),s=null!=(i=s)?i:[],s.push(a),this._shadowRendererDirectional.cull(a,e,t)}}}s&&this.cameraDirShadowLights.set(t,s),Gy.clear()}}}cullComposition(e){this.processingMeshInstances.clear();const t=e.cameras.length;for(let i=0;i<t;i++){const t=e.cameras[i];let n,r=!0;this._camerasRendered++;const a=t.layers;for(let i=0;i<a.length;i++){const o=e.getLayerById(a[i]);if(o&&o.enabled){var s;const i=null!=(s=t.renderTarget)?s:o.renderTarget;(r||i!==n)&&(r=!1,n=i,t.frameUpdate(i),this.updateCameraFrustum(t.camera)),this.cullLights(t.camera,o._lights),null==o.onPreCull||o.onPreCull(e.camerasMap.get(t));const a=o.getCulledInstances(t.camera);this.cull(t.camera,o.meshInstances,a),null==o.onPostCull||o.onPostCull(e.camerasMap.get(t))}}}this.scene.clusteredLightingEnabled&&this.updateLightTextureAtlas(),this.cullShadowmaps(e)}updateShaders(e,t){const s=e.length;for(let i=0;i<s;i++){const s=e[i].material;if(s&&!Gy.has(s)&&(Gy.add(s),s.getShaderVariant!==Tf.prototype.getShaderVariant)){if(t&&(!s.useLighting||s.emitter&&!s.emitter.lighting))continue;s.clearVariants()}}Gy.clear()}updateFrameUniforms(){var e;this.blueNoiseTextureId.setValue((e=this.device,Ty.get(e,(()=>{const t=Sy(),s=Math.sqrt(t.length/4),i=new bm(e,{name:`BlueNoise${s}`,width:s,height:s,format:7,addressU:0,addressV:0,type:ep,magFilter:0,minFilter:0,anisotropy:1,mipmaps:!1});return i.lock().set(t),i.unlock(),i}))))}beginFrame(e){const t=this.scene,s=t.updateShaders,i=e.layerList,n=i.length;for(let e=0;e<n;e++){const t=i[e].meshInstances,n=t.length;for(let e=0;e<n;e++){const i=t[e];i.visibleThisFrame=!1,s&&jy.push(i),i.skinInstance&&qy.push(i)}}if(s){const e=!t.updateShaders;this.updateShaders(jy,e),t.updateShaders=!1,t._shaderVersion++}this.updateFrameUniforms(),this.updateCpuSkinMatrices(qy),jy.length=0,qy.length=0;const r=this.lights,a=r.length;for(let e=0;e<a;e++)r[e].beginFrame()}updateLightTextureAtlas(){this.lightTextureAtlas.update(this.localLights,this.scene.lighting)}updateLayerComposition(e){const t=e.layerList.length;for(let s=0;s<t;s++)e.layerList[s]._postRenderCounter=0;const s=this.scene._shaderVersion;for(let i=0;i<t;i++){const t=e.layerList[i];t._shaderVersion=s,t._preRenderCalledForCameras=0,t._postRenderCalledForCameras=0;const n=e.subLayerList[i];t._postRenderCounter|=n?2:1,t._postRenderCounterMax=t._postRenderCounter}e._update()}frameUpdate(){this.clustersDebugRendered=!1,this.initViewBindGroupFormat(this.scene.clusteredLightingEnabled),this.dirLightShadows.clear()}}class Xy{constructor(){this.layer=null,this.transparent=!1,this.camera=null,this.renderTarget=null,this.lightClusters=null,this.clearColor=!1,this.clearDepth=!1,this.clearStencil=!1,this.triggerPostprocess=!1,this.firstCameraUse=!1,this.lastCameraUse=!1,this.viewBindGroups=[],this.useCameraPasses=!1}destroy(){this.viewBindGroups.forEach((e=>{e.defaultUniformBuffer.destroy(),e.destroy()})),this.viewBindGroups.length=0}setupClears(e,t){this.clearColor=(null==e?void 0:e.clearColorBuffer)||t.clearColorBuffer,this.clearDepth=(null==e?void 0:e.clearDepthBuffer)||t.clearDepthBuffer,this.clearStencil=(null==e?void 0:e.clearStencilBuffer)||t.clearStencilBuffer}}class Yy extends Im{constructor(e,t,s,i){super(e),this.layerComposition=void 0,this.scene=void 0,this.renderer=void 0,this.renderActions=[],this.noDepthClear=!1,this.layerComposition=t,this.scene=s,this.renderer=i}addRenderAction(e){this.renderActions.push(e)}addLayer(e,t,s,i=!0){const n=new Xy;if(n.renderTarget=this.renderTarget,n.camera=e,n.layer=t,n.transparent=s,i){const s=0===this.renderActions.length;n.setupClears(s?e:void 0,t)}this.addRenderAction(n)}addLayers(e,t,s,i,n,r=!0){const{layerList:a,subLayerEnabled:o,subLayerList:l}=e;let h=i,c=s;for(;c<a.length;){const e=a[c],s=l[c],i=e.enabled&&o[c],d=t.camera.layersSet.has(e.id);if(i&&d&&(this.addLayer(t,e,s,h),h=!1),c++,e.id===n&&s===r)break}return c}updateDirectionalShadows(){const{renderer:e,renderActions:t}=this;for(let s=0;s<t.length;s++){const i=t[s].camera.camera,n=this.renderer.cameraDirShadowLights.get(i);if(n)for(let t=0;t<n.length;t++){const s=n[t];if(e.dirLightShadows.get(s)!==i){e.dirLightShadows.set(s,i);const t=e._shadowRendererDirectional.getLightRenderPass(s,i);t&&this.beforePasses.push(t)}}}}updateClears(){const e=this.renderActions[0];if(e){const t=e.camera.camera,s=t.fullSizeClearRect;this.setClearColor(s&&e.clearColor?t.clearColor:void 0),this.setClearDepth(s&&e.clearDepth&&!this.noDepthClear?t.clearDepth:void 0),this.setClearStencil(s&&e.clearStencil?t.clearStencil:void 0)}}frameUpdate(){super.frameUpdate(),this.updateDirectionalShadows(),this.updateClears()}before(){const{renderActions:e}=this;if(e.length){const t=e[0];t.camera.onPreRender&&t.firstCameraUse&&t.camera.onPreRender()}}execute(){const{layerComposition:e,renderActions:t}=this;for(let s=0;s<t.length;s++){const i=t[s];e.isEnabled(i.layer,i.transparent)&&this.renderRenderAction(i,0===s)}}after(){const{renderActions:e}=this;if(e.length){const t=e[e.length-1];t.camera.onPostRender&&t.lastCameraUse&&t.camera.onPostRender()}this.beforePasses.length=0}renderRenderAction(e,t){const{renderer:s,layerComposition:i}=this,n=s.device,{layer:r,transparent:a,camera:o}=e,l=i.camerasMap.get(o);if(!a&&r.onPreRenderOpaque?r.onPreRenderOpaque(l):a&&r.onPreRenderTransparent&&r.onPreRenderTransparent(l),r._preRenderCalledForCameras&1<<l||(r.onPreRender&&r.onPreRender(l),r._preRenderCalledForCameras|=1<<l),o){var h,c;const i={lightClusters:e.lightClusters},l=null!=(h=null==(c=o.camera.shaderPassInfo)?void 0:c.index)?h:r.shaderPass;t&&o.camera.fullSizeClearRect||(i.clearColor=e.clearColor,i.clearDepth=e.clearDepth,i.clearStencil=e.clearStencil),s.renderForwardLayer(o.camera,e.renderTarget,r,a,l,e.viewBindGroups,i),n.setBlendState(Sp.NOBLEND),n.setStencilState(null,null),n.setAlphaToCoverage(!1)}!a&&r.onPostRenderOpaque?r.onPostRenderOpaque(l):a&&r.onPostRenderTransparent&&r.onPostRenderTransparent(l),!r.onPostRender||r._postRenderCalledForCameras&1<<l||(r._postRenderCounter&=~(a?2:1),0===r._postRenderCounter&&(r.onPostRender(l),r._postRenderCalledForCameras|=1<<l,r._postRenderCounter=r._postRenderCounterMax))}}class Zy extends Im{constructor(e,t,s){super(e),this.renderer=t,this.renderAction=s,this.requiresCubemaps=!1}execute(){this.renderAction.camera.onPostprocessing()}}const $y=[[],[],[]],Qy={drawCalls:[],shaderInstances:[],isNewMaterial:[],lightMaskChanged:[],clear:function(){this.drawCalls.length=0,this.shaderInstances.length=0,this.isNewMaterial.length=0,this.lightMaskChanged.length=0}};class Jy extends Ky{constructor(e){super(e);const t=this.device;this._forwardDrawCalls=0,this._materialSwitches=0,this._depthMapTime=0,this._forwardTime=0,this._sortTime=0;const s=t.scope;this.fogColorId=s.resolve("fog_color"),this.fogStartId=s.resolve("fog_start"),this.fogEndId=s.resolve("fog_end"),this.fogDensityId=s.resolve("fog_density"),this.ambientId=s.resolve("light_globalAmbient"),this.skyboxIntensityId=s.resolve("skyboxIntensity"),this.cubeMapRotationMatrixId=s.resolve("cubeMapRotationMatrix"),this.pcssDiskSamplesId=s.resolve("pcssDiskSamples[0]"),this.pcssSphereSamplesId=s.resolve("pcssSphereSamples[0]"),this.lightColorId=[],this.lightDir=[],this.lightDirId=[],this.lightShadowMapId=[],this.lightShadowMatrixId=[],this.lightShadowParamsId=[],this.lightShadowIntensity=[],this.lightRadiusId=[],this.lightPos=[],this.lightPosId=[],this.lightWidth=[],this.lightWidthId=[],this.lightHeight=[],this.lightHeightId=[],this.lightInAngleId=[],this.lightOutAngleId=[],this.lightCookieId=[],this.lightCookieIntId=[],this.lightCookieMatrixId=[],this.lightCookieOffsetId=[],this.lightShadowSearchAreaId=[],this.lightCameraParamsId=[],this.shadowMatrixPaletteId=[],this.shadowCascadeDistancesId=[],this.shadowCascadeCountId=[],this.screenSizeId=s.resolve("uScreenSize"),this._screenSize=new Float32Array(4),this.fogColor=new Float32Array(3),this.ambientColor=new Float32Array(3),this.pcssDiskSamples=function(e){const t=[];for(let s=0;s<e;++s){const i=Math.sqrt(s+.5)/Math.sqrt(e);t.push(i)}return t}(16),this.pcssSphereSamples=function(e){const t=[];for(let s=0;s<e;s++){const i=s/e,n=Math.sqrt(1-i*i);t.push(n)}return t}(16)}destroy(){super.destroy()}dispatchGlobalLights(e){if(this.ambientColor[0]=e.ambientLight.r,this.ambientColor[1]=e.ambientLight.g,this.ambientColor[2]=e.ambientLight.b,e.gammaCorrection)for(let e=0;e<3;e++)this.ambientColor[e]=Math.pow(this.ambientColor[e],2.2);if(e.physicalUnits)for(let t=0;t<3;t++)this.ambientColor[t]*=e.ambientLuminance;this.ambientId.setValue(this.ambientColor),this.skyboxIntensityId.setValue(e.physicalUnits?e.skyboxLuminance:e.skyboxIntensity),this.cubeMapRotationMatrixId.setValue(e._skyboxRotationMat3.data)}_resolveLight(e,t){const s="light"+t;this.lightColorId[t]=e.resolve(s+"_color"),this.lightDir[t]=new Float32Array(3),this.lightDirId[t]=e.resolve(s+"_direction"),this.lightShadowMapId[t]=e.resolve(s+"_shadowMap"),this.lightShadowMatrixId[t]=e.resolve(s+"_shadowMatrix"),this.lightShadowParamsId[t]=e.resolve(s+"_shadowParams"),this.lightShadowIntensity[t]=e.resolve(s+"_shadowIntensity"),this.lightShadowSearchAreaId[t]=e.resolve(s+"_shadowSearchArea"),this.lightRadiusId[t]=e.resolve(s+"_radius"),this.lightPos[t]=new Float32Array(3),this.lightPosId[t]=e.resolve(s+"_position"),this.lightWidth[t]=new Float32Array(3),this.lightWidthId[t]=e.resolve(s+"_halfWidth"),this.lightHeight[t]=new Float32Array(3),this.lightHeightId[t]=e.resolve(s+"_halfHeight"),this.lightInAngleId[t]=e.resolve(s+"_innerConeAngle"),this.lightOutAngleId[t]=e.resolve(s+"_outerConeAngle"),this.lightCookieId[t]=e.resolve(s+"_cookie"),this.lightCookieIntId[t]=e.resolve(s+"_cookieIntensity"),this.lightCookieMatrixId[t]=e.resolve(s+"_cookieMatrix"),this.lightCookieOffsetId[t]=e.resolve(s+"_cookieOffset"),this.lightCameraParamsId[t]=e.resolve(s+"_cameraParams"),this.shadowMatrixPaletteId[t]=e.resolve(s+"_shadowMatrixPalette[0]"),this.shadowCascadeDistancesId[t]=e.resolve(s+"_shadowCascadeDistances[0]"),this.shadowCascadeCountId[t]=e.resolve(s+"_shadowCascadeCount")}setLTCDirectionalLight(e,t,s,i,n){this.lightPos[t][0]=i.x-s.x*n,this.lightPos[t][1]=i.y-s.y*n,this.lightPos[t][2]=i.z-s.z*n,this.lightPosId[t].setValue(this.lightPos[t]);const r=e.transformVector(new nu(-.5,0,0));this.lightWidth[t][0]=r.x*n,this.lightWidth[t][1]=r.y*n,this.lightWidth[t][2]=r.z*n,this.lightWidthId[t].setValue(this.lightWidth[t]);const a=e.transformVector(new nu(0,0,.5));this.lightHeight[t][0]=a.x*n,this.lightHeight[t][1]=a.y*n,this.lightHeight[t][2]=a.z*n,this.lightHeightId[t].setValue(this.lightHeight[t])}dispatchDirectLights(e,t,s,i){let n=0;const r=this.device.scope;for(let a=0;a<e.length;a++){if(!(e[a].mask&s))continue;const o=e[a],l=o._node.getWorldTransform();if(this.lightColorId[n]||this._resolveLight(r,n),this.lightColorId[n].setValue(t.gammaCorrection?o._linearFinalColor:o._finalColor),l.getY(o._direction).mulScalar(-1),o._direction.normalize(),this.lightDir[n][0]=o._direction.x,this.lightDir[n][1]=o._direction.y,this.lightDir[n][2]=o._direction.z,this.lightDirId[n].setValue(this.lightDir[n]),0!==o.shape&&this.setLTCDirectionalLight(l,n,o._direction,i._node.getPosition(),i.farClip),o.castShadows){const e=o.getRenderData(i,0),t=o._getUniformBiasValues(e);this.lightShadowMapId[n].setValue(e.shadowBuffer),this.lightShadowMatrixId[n].setValue(e.shadowMatrix.data),this.shadowMatrixPaletteId[n].setValue(o._shadowMatrixPalette),this.shadowCascadeDistancesId[n].setValue(o._shadowCascadeDistances),this.shadowCascadeCountId[n].setValue(o.numCascades),this.lightShadowIntensity[n].setValue(o.shadowIntensity);const s=50/e.projectionCompensation,r=o.penumbraSize/e.shadowCamera.renderTarget.width;this.lightShadowSearchAreaId[n].setValue(r*s);const a=o._shadowCameraParams;a.length=4,a[0]=e.depthRangeCompensation,a[1]=e.shadowCamera._farClip,a[2]=e.shadowCamera._nearClip,a[3]=1,this.lightCameraParamsId[n].setValue(a);const l=o._shadowRenderParams;l.length=4,l[0]=o._shadowResolution,l[1]=t.normalBias,l[2]=t.bias,l[3]=0,this.lightShadowParamsId[n].setValue(l)}n++}return n}setLTCPositionalLight(e,t){const s=e.transformVector(new nu(-.5,0,0));this.lightWidth[t][0]=s.x,this.lightWidth[t][1]=s.y,this.lightWidth[t][2]=s.z,this.lightWidthId[t].setValue(this.lightWidth[t]);const i=e.transformVector(new nu(0,0,.5));this.lightHeight[t][0]=i.x,this.lightHeight[t][1]=i.y,this.lightHeight[t][2]=i.z,this.lightHeightId[t].setValue(this.lightHeight[t])}dispatchOmniLight(e,t,s,i){const n=s._node.getWorldTransform();if(this.lightColorId[i]||this._resolveLight(t,i),this.lightRadiusId[i].setValue(s.attenuationEnd),this.lightColorId[i].setValue(e.gammaCorrection?s._linearFinalColor:s._finalColor),n.getTranslation(s._position),this.lightPos[i][0]=s._position.x,this.lightPos[i][1]=s._position.y,this.lightPos[i][2]=s._position.z,this.lightPosId[i].setValue(this.lightPos[i]),0!==s.shape&&this.setLTCPositionalLight(n,i),s.castShadows){const e=s.getRenderData(null,0);this.lightShadowMapId[i].setValue(e.shadowBuffer);const t=s._getUniformBiasValues(e),n=s._shadowRenderParams;n.length=4,n[0]=s._shadowResolution,n[1]=t.normalBias,n[2]=t.bias,n[3]=1/s.attenuationEnd,this.lightShadowParamsId[i].setValue(n),this.lightShadowIntensity[i].setValue(s.shadowIntensity);const r=s.penumbraSize/e.shadowCamera.renderTarget.width;this.lightShadowSearchAreaId[i].setValue(r);const a=s._shadowCameraParams;a.length=4,a[0]=e.depthRangeCompensation,a[1]=e.shadowCamera._farClip,a[2]=e.shadowCamera._nearClip,a[3]=0,this.lightCameraParamsId[i].setValue(a)}s._cookie&&(this.lightCookieId[i].setValue(s._cookie),this.lightShadowMatrixId[i].setValue(n.data),this.lightCookieIntId[i].setValue(s.cookieIntensity))}dispatchSpotLight(e,t,s,i){const n=s._node.getWorldTransform();if(this.lightColorId[i]||this._resolveLight(t,i),this.lightInAngleId[i].setValue(s._innerConeAngleCos),this.lightOutAngleId[i].setValue(s._outerConeAngleCos),this.lightRadiusId[i].setValue(s.attenuationEnd),this.lightColorId[i].setValue(e.gammaCorrection?s._linearFinalColor:s._finalColor),n.getTranslation(s._position),this.lightPos[i][0]=s._position.x,this.lightPos[i][1]=s._position.y,this.lightPos[i][2]=s._position.z,this.lightPosId[i].setValue(this.lightPos[i]),0!==s.shape&&this.setLTCPositionalLight(n,i),n.getY(s._direction).mulScalar(-1),s._direction.normalize(),this.lightDir[i][0]=s._direction.x,this.lightDir[i][1]=s._direction.y,this.lightDir[i][2]=s._direction.z,this.lightDirId[i].setValue(this.lightDir[i]),s.castShadows){const e=s.getRenderData(null,0);this.lightShadowMapId[i].setValue(e.shadowBuffer),this.lightShadowMatrixId[i].setValue(e.shadowMatrix.data);const t=s._getUniformBiasValues(e),n=s._shadowRenderParams;n.length=4,n[0]=s._shadowResolution,n[1]=t.normalBias,n[2]=t.bias,n[3]=1/s.attenuationEnd,this.lightShadowParamsId[i].setValue(n),this.lightShadowIntensity[i].setValue(s.shadowIntensity);const r=s.penumbraSize/e.shadowCamera.renderTarget.width,a=e.shadowCamera._fov*Math.PI/180,o=1/Math.tan(a/2);this.lightShadowSearchAreaId[i].setValue(r*o);const l=s._shadowCameraParams;l.length=4,l[0]=e.depthRangeCompensation,l[1]=e.shadowCamera._farClip,l[2]=e.shadowCamera._nearClip,l[3]=0,this.lightCameraParamsId[i].setValue(l)}if(s._cookie){if(!s.castShadows){const e=Pg.evalSpotCookieMatrix(s);this.lightShadowMatrixId[i].setValue(e.data)}this.lightCookieId[i].setValue(s._cookie),this.lightCookieIntId[i].setValue(s.cookieIntensity),s._cookieTransform&&(s._cookieTransformUniform[0]=s._cookieTransform.x,s._cookieTransformUniform[1]=s._cookieTransform.y,s._cookieTransformUniform[2]=s._cookieTransform.z,s._cookieTransformUniform[3]=s._cookieTransform.w,this.lightCookieMatrixId[i].setValue(s._cookieTransformUniform),s._cookieOffsetUniform[0]=s._cookieOffset.x,s._cookieOffsetUniform[1]=s._cookieOffset.y,this.lightCookieOffsetId[i].setValue(s._cookieOffsetUniform))}}dispatchLocalLights(e,t,s,i){let n=i;const r=this.device.scope,a=e[1],o=a.length;for(let e=0;e<o;e++){const i=a[e];i.mask&s&&(this.dispatchOmniLight(t,r,i,n),n++)}const l=e[2],h=l.length;for(let e=0;e<h;e++){const i=l[e];i.mask&s&&(this.dispatchSpotLight(t,r,i,n),n++)}}renderForwardPrepareMaterials(e,t,s,i,n){var r;const a=(e,t,s,i)=>{Qy.drawCalls.push(e),Qy.shaderInstances.push(t),Qy.isNewMaterial.push(s),Qy.lightMaskChanged.push(i)};Qy.clear();const o=this.device,l=this.scene,h=l.clusteredLightingEnabled,c=null!=(r=null==i?void 0:i.getLightHash(h))?r:0;let d,u,p=null;const m=t.length;for(let e=0;e<m;e++){const i=t[e];i.ensureMaterial(o);const r=i.material,h=i._shaderDefs,m=i.mask;r&&r===p&&h!==d&&(p=null),r!==p&&(this._materialSwitches++,r._scene=l,r.dirty&&(r.updateUniforms(o,l),r.dirty=!1));const _=i.getShaderInstance(n,c,l,this.viewUniformFormat,this.viewBindGroupFormat,s);a(i,_,r!==p,!p||m!==u),p=r,d=h,u=m}return Qy}renderForwardInternal(e,t,s,i,n,r){const a=this.device,o=this.scene,l=1<<i,h=r?-1:1,c=this.scene.clusteredLightingEnabled,d=t.drawCalls.length;for(let i=0;i<d;i++){var u,p;const r=t.drawCalls[i],m=t.isNewMaterial[i],_=t.lightMaskChanged[i],f=t.shaderInstances[i],g=r.material,v=r.mask;if(m){const t=!1;if(a.setShader(f.shader,t),g.setParameters(a),_){const t=this.dispatchDirectLights(s[0],o,v,e);c||this.dispatchLocalLights(s,o,v,t)}this.alphaTestId.setValue(g.alphaTest),a.setBlendState(g.blendState),a.setDepthState(g.depthState),a.setAlphaToCoverage(g.alphaToCoverage)}this.setupCullMode(e._cullFaces,h,r);const y=null!=(u=r.stencilFront)?u:g.stencilFront,b=null!=(p=r.stencilBack)?p:g.stencilBack;a.setStencilState(y,b);const x=r.mesh;r.setParameters(a,l),this.setVertexBuffers(a,x),this.setMorphing(a,r.morphInstance),this.setSkinning(a,r),this.setupMeshUniformBuffers(f,r);const w=r.renderStyle;if(a.setIndexBuffer(x.indexBuffer[w]),null==n||n(r,i),e.xr&&e.xr.session&&e.xr.views.list.length){const t=e.xr.views;for(let e=0;e<t.list.length;e++){const s=t.list[e];a.setViewport(s.viewport.x,s.viewport.y,s.viewport.z,s.viewport.w),this.projId.setValue(s.projMat.data),this.projSkyboxId.setValue(s.projMat.data),this.viewId.setValue(s.viewOffMat.data),this.viewInvId.setValue(s.viewInvOffMat.data),this.viewId3.setValue(s.viewMat3.data),this.viewProjId.setValue(s.projViewOffMat.data),this.viewPosId.setValue(s.positionData),this.viewIndexId.setValue(e),0===e?this.drawInstance(a,r,x,w,!0):this.drawInstance2(a,r,x,w),this._forwardDrawCalls++}}else this.drawInstance(a,r,x,w,!0),this._forwardDrawCalls++;i<d-1&&!t.isNewMaterial[i+1]&&g.setParameters(a,r.parameters)}}renderForward(e,t,s,i,n,r,a){const o=this.renderForwardPrepareMaterials(e,t,s,r,i);this.renderForwardInternal(e,o,s,i,n,a),Qy.clear()}renderForwardLayer(e,t,s,i,n,r,a={}){var o,l,h;const{scene:c,device:d}=this,u=c.clusteredLightingEnabled;this.setupViewport(e,t);const p=null!=(o=a.clearColors)&&o,m=null!=(l=a.clearDepth)&&l,_=null!=(h=a.clearStencil)&&h;let f,g;if((p||m||_)&&this.clear(e,p,m,_),s){s.sortVisible(e,i);const t=s.getCulledInstances(e);f=i?t.transparent:t.opaque,c.immediate.onPreRenderLayer(s,f,i),s.requiresLightCube&&(this.lightCube.update(c.ambientLight,s._lights),this.constantLightCube.setValue(this.lightCube.colors)),g=s.splitLights}else{var v;f=a.meshInstances,g=null!=(v=a.splitLights)?v:$y}if(u){var y;(null!=(y=a.lightClusters)?y:this.worldClustersAllocator.empty).activate(),s&&(this.clustersDebugRendered||c.lighting.debugLayer!==s.id||(this.clustersDebugRendered=!0))}c._activeCamera=e;const b=this.setCameraUniforms(e,t);d.supportsUniformBuffers&&this.setupViewUniformBuffers(r,this.viewUniformFormat,this.viewBindGroupFormat,b);const x=!!(e._flipFaces^(null==t?void 0:t.flipY)),w=this._forwardDrawCalls;this.renderForward(e,f,g,n,null==s?void 0:s.onDrawCall,s,x),s&&(s._forwardDrawCalls+=this._forwardDrawCalls-w)}setSceneConstants(){const e=this.scene;if(this.dispatchGlobalLights(e),e.fog!==D_){if(this.fogColor[0]=e.fogColor.r,this.fogColor[1]=e.fogColor.g,this.fogColor[2]=e.fogColor.b,e.gammaCorrection)for(let e=0;e<3;e++)this.fogColor[e]=Math.pow(this.fogColor[e],2.2);this.fogColorId.setValue(this.fogColor),"linear"===e.fog?(this.fogStartId.setValue(e.fogStart),this.fogEndId.setValue(e.fogEnd)):this.fogDensityId.setValue(e.fogDensity)}const t=this.device;this._screenSize[0]=t.width,this._screenSize[1]=t.height,this._screenSize[2]=1/t.width,this._screenSize[3]=1/t.height,this.screenSizeId.setValue(this._screenSize),this.pcssDiskSamplesId.setValue(this.pcssDiskSamples),this.pcssSphereSamplesId.setValue(this.pcssSphereSamples)}buildFrameGraph(e,t){const s=this.scene,i=this.device.isWebGL1;if(e.reset(),this.update(t),s.clusteredLightingEnabled){const{shadowsEnabled:t,cookiesEnabled:i}=s.lighting;this._renderPassUpdateClustered.update(e,t,i,this.lights,this.localLights),e.addRenderPass(this._renderPassUpdateClustered)}else this._shadowRendererLocal.buildNonClusteredRenderPasses(e,this.localLights);let n=0,r=!0,a=null;const o=t._renderActions;for(let s=n;s<o.length;s++){const l=o[s],{layer:h,camera:c}=l;if(l.useCameraPasses)c.camera.renderPasses.forEach((t=>{e.addRenderPass(t)}));else{const d=c.camera.renderPassDepthGrab;d&&i&&l.firstCameraUse&&(d.options.resizeSource=c.camera.renderTarget,d.update(this.scene),e.addRenderPass(d));const u=1===h.id;if(i&&u&&!c.renderSceneColorMap)continue;const p=u&&(c.renderSceneColorMap||c.renderSceneDepthMap);r&&(r=!1,n=s,a=l.renderTarget);const m=o[s+1],_=!!m&&1===m.layer.id&&(c.renderSceneColorMap||c.renderSceneDepthMap)&&!i,f=!!m&&(m.firstCameraUse&&this.cameraDirShadowLights.has(m.camera.camera));if(!m||m.renderTarget!==a||f||_||p){if(u&&n===s||this.addMainRenderPass(e,t,a,n,s),u){if(c.renderSceneColorMap){const t=c.camera.renderPassColorGrab;t.source=c.renderTarget,e.addRenderPass(t)}c.renderSceneDepthMap&&!i&&e.addRenderPass(c.camera.renderPassDepthGrab)}if(l.triggerPostprocess&&null!=c&&c.onPostprocessing){const t=new Zy(this.device,this,l);e.addRenderPass(t)}r=!0}}}}addMainRenderPass(e,t,s,i,n){const r=new Yy(this.device,t,this.scene,this);r.init(s);const a=t._renderActions;for(let e=i;e<=n;e++)r.addRenderAction(a[e]);e.addRenderPass(r)}update(e){this.frameUpdate(),this.shadowRenderer.frameUpdate(),this.scene._updateSkyMesh(),this.updateLayerComposition(e),this.collectLights(e),this.beginFrame(e),this.setSceneConstants(),this.cullComposition(e),this.gpuUpdate(this.processingMeshInstances)}}const eb=[null,function(e,t){return e.drawOrder-t.drawOrder},function(e,t){const s=e._key[0],i=t._key[0];return s===i&&e.mesh&&t.mesh?t.mesh.id-e.mesh.id:i-s},function(e,t){return t.zdist-e.zdist},function(e,t){return e.zdist-t.zdist}];let tb=0;const sb=[],ib=new Set;class nb{constructor(){this.opaque=[],this.transparent=[]}}class rb{constructor(e={}){var t,s,i,n;this.meshInstances=[],this.meshInstancesSet=new Set,this.shadowCasters=[],this.shadowCastersSet=new Set,this._visibleInstances=new WeakMap,this._lights=[],this._lightsSet=new Set,this._clusteredLightsSet=new Set,this._splitLights=[[],[],[]],this._splitLightsDirty=!0,this.requiresLightCube=!1,this.cameras=[],this.camerasSet=new Set,this._dirtyComposition=!1,void 0!==e.id?(this.id=e.id,tb=Math.max(this.id+1,tb)):this.id=tb++,this.name=e.name,this._enabled=null==(t=e.enabled)||t,this._refCounter=this._enabled?1:0,this.opaqueSortMode=null!=(s=e.opaqueSortMode)?s:2,this.transparentSortMode=null!=(i=e.transparentSortMode)?i:3,e.renderTarget&&(this.renderTarget=e.renderTarget),this.shaderPass=null!=(n=e.shaderPass)?n:0,this._clearColorBuffer=!!e.clearColorBuffer,this._clearDepthBuffer=!!e.clearDepthBuffer,this._clearStencilBuffer=!!e.clearStencilBuffer,this.onPreCull=e.onPreCull,this.onPreRender=e.onPreRender,this.onPreRenderOpaque=e.onPreRenderOpaque,this.onPreRenderTransparent=e.onPreRenderTransparent,this.onPostCull=e.onPostCull,this.onPostRender=e.onPostRender,this.onPostRenderOpaque=e.onPostRenderOpaque,this.onPostRenderTransparent=e.onPostRenderTransparent,this.onDrawCall=e.onDrawCall,this.onEnable=e.onEnable,this.onDisable=e.onDisable,this._enabled&&this.onEnable&&this.onEnable(),this.layerReference=e.layerReference,this.customSortCallback=null,this.customCalculateSortValues=null,this._lightHash=0,this._lightHashDirty=!1,this._lightIdHash=0,this._lightIdHashDirty=!1,this._shaderVersion=-1}set enabled(e){e!==this._enabled&&(this._dirtyComposition=!0,this._enabled=e,e?(this.incrementCounter(),this.onEnable&&this.onEnable()):(this.decrementCounter(),this.onDisable&&this.onDisable()))}get enabled(){return this._enabled}set clearColorBuffer(e){this._clearColorBuffer=e,this._dirtyComposition=!0}get clearColorBuffer(){return this._clearColorBuffer}set clearDepthBuffer(e){this._clearDepthBuffer=e,this._dirtyComposition=!0}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencilBuffer(e){this._clearStencilBuffer=e,this._dirtyComposition=!0}get clearStencilBuffer(){return this._clearStencilBuffer}get hasClusteredLights(){return this._clusteredLightsSet.size>0}get clusteredLightsSet(){return this._clusteredLightsSet}incrementCounter(){0===this._refCounter&&(this._enabled=!0,this.onEnable&&this.onEnable()),this._refCounter++}decrementCounter(){if(1===this._refCounter)this._enabled=!1,this.onDisable&&this.onDisable();else if(0===this._refCounter)return;this._refCounter--}addMeshInstances(e,t){const s=this.meshInstances,i=this.meshInstancesSet;for(let t=0;t<e.length;t++){const n=e[t];i.has(n)||(s.push(n),i.add(n),ib.add(n.material))}if(t||this.addShadowCasters(e),ib.size>0){const e=this._shaderVersion;ib.forEach((t=>{e>=0&&t._shaderVersion!==e&&(t.getShaderVariant!==Tf.prototype.getShaderVariant&&t.clearVariants(),t._shaderVersion=e)})),ib.clear()}}removeMeshInstances(e,t){const s=this.meshInstances,i=this.meshInstancesSet;for(let t=0;t<e.length;t++){const n=e[t];if(i.has(n)){i.delete(n);const e=s.indexOf(n);e>=0&&s.splice(e,1)}}t||this.removeShadowCasters(e)}addShadowCasters(e){const t=this.shadowCasters,s=this.shadowCastersSet;for(let i=0;i<e.length;i++){const n=e[i];n.castShadow&&!s.has(n)&&(s.add(n),t.push(n))}}removeShadowCasters(e){const t=this.shadowCasters,s=this.shadowCastersSet;for(let i=0;i<e.length;i++){const n=e[i];if(s.has(n)){s.delete(n);const e=t.indexOf(n);e>=0&&t.splice(e,1)}}}clearMeshInstances(e=!1){this.meshInstances.length=0,this.meshInstancesSet.clear(),e||(this.shadowCasters.length=0,this.shadowCastersSet.clear())}markLightsDirty(){this._lightHashDirty=!0,this._lightIdHashDirty=!0,this._splitLightsDirty=!0}addLight(e){const t=e.light;this._lightsSet.has(t)||(this._lightsSet.add(t),this._lights.push(t),this.markLightsDirty()),0!==t.type&&this._clusteredLightsSet.add(t)}removeLight(e){const t=e.light;this._lightsSet.has(t)&&(this._lightsSet.delete(t),this._lights.splice(this._lights.indexOf(t),1),this.markLightsDirty()),0!==t.type&&this._clusteredLightsSet.delete(t)}clearLights(){this._lightsSet.forEach((e=>e.removeLayer(this))),this._lightsSet.clear(),this._clusteredLightsSet.clear(),this._lights.length=0,this.markLightsDirty()}get splitLights(){if(this._splitLightsDirty){this._splitLightsDirty=!1;const e=this._splitLights;for(let t=0;t<e.length;t++)e[t].length=0;const t=this._lights;for(let s=0;s<t.length;s++){const i=t[s];i.enabled&&e[i._type].push(i)}for(let t=0;t<e.length;t++)e[t].sort(((e,t)=>e.key-t.key))}return this._splitLights}evaluateLightHash(e,t,s){let i=0;const n=this._lights;for(let i=0;i<n.length;i++){const r=0!==n[i].type;(e&&r||t&&!r)&&sb.push(s?n[i].id:n[i].key)}return sb.length>0&&(sb.sort(),i=function(e){let t=2166136261;for(let s=0;s<e.length;s++)t^=e[s],t*=16777619;return t>>>0}(sb),sb.length=0),i}getLightHash(e){return this._lightHashDirty&&(this._lightHashDirty=!1,this._lightHash=this.evaluateLightHash(!e,!0,!1)),this._lightHash}getLightIdHash(){return this._lightIdHashDirty&&(this._lightIdHashDirty=!1,this._lightIdHash=this.evaluateLightHash(!0,!1,!0)),this._lightIdHash}addCamera(e){this.camerasSet.has(e.camera)||(this.camerasSet.add(e.camera),this.cameras.push(e),this._dirtyComposition=!0)}removeCamera(e){if(this.camerasSet.has(e.camera)){this.camerasSet.delete(e.camera);const t=this.cameras.indexOf(e);this.cameras.splice(t,1),this._dirtyComposition=!0}}clearCameras(){this.cameras.length=0,this.camerasSet.clear(),this._dirtyComposition=!0}_calculateSortDistances(e,t,s,i){for(let n=0;n<t;n++){const t=e[n];if(t.layer<=2)continue;if(t.calculateSortDistance){t.zdist=t.calculateSortDistance(t,s,i);continue}const r=t.aabb.center,a=r.x-s.x,o=r.y-s.y,l=r.z-s.z;t.zdist=a*i.x+o*i.y+l*i.z}}getCulledInstances(e){let t=this._visibleInstances.get(e);return t||(t=new nb,this._visibleInstances.set(e,t)),t}sortVisible(e,t){const s=t?this.transparentSortMode:this.opaqueSortMode;if(0===s)return;const i=this.getCulledInstances(e),n=t?i.transparent:i.opaque,r=e.node;if(5===s){const e=r.getPosition(),t=r.forward;this.customCalculateSortValues&&this.customCalculateSortValues(n,n.length,e,t),this.customSortCallback&&n.sort(this.customSortCallback)}else{if(3===s||4===s){const e=r.getPosition(),t=r.forward;this._calculateSortDistances(n,n.length,e,t)}n.sort(eb[s])}}}const ab=(e,t)=>e.priority-t.priority,ob=e=>e.sort(ab);class lb extends od{constructor(e="Untitled"){super(),this.layerList=[],this.layerIdMap=new Map,this.layerNameMap=new Map,this.layerOpaqueIndexMap=new Map,this.layerTransparentIndexMap=new Map,this.subLayerList=[],this.subLayerEnabled=[],this.cameras=[],this.camerasMap=new Map,this._renderActions=[],this._dirty=!1,this.name=e,this._opaqueOrder={},this._transparentOrder={}}destroy(){this.destroyRenderActions()}destroyRenderActions(){this._renderActions.forEach((e=>e.destroy())),this._renderActions.length=0}_update(){const e=this.layerList.length;if(!this._dirty)for(let t=0;t<e;t++)if(this.layerList[t]._dirtyComposition){this._dirty=!0;break}if(this._dirty){this._dirty=!1,this.cameras.length=0;for(let t=0;t<e;t++){const e=this.layerList[t];e._dirtyComposition=!1;for(let t=0;t<e.cameras.length;t++){const s=e.cameras[t];this.cameras.indexOf(s)<0&&this.cameras.push(s)}}this.cameras.length>1&&ob(this.cameras),this.camerasMap.clear();for(let e=0;e<this.cameras.length;e++)this.camerasMap.set(this.cameras[e],e);let t=0;this.destroyRenderActions();for(let s=0;s<this.cameras.length;s++){const i=this.cameras[s];if(i.camera.renderPasses.length>0){this.addDummyRenderAction(t,i),t++;continue}let n=!0;const r=t;let a=null,o=!1;for(let s=0;s<e;s++){const e=this.layerList[s];if(e.enabled&&this.subLayerEnabled[s]&&e.cameras.length>0&&i.layers.indexOf(e.id)>=0){o||e.id!==i.disablePostEffectsLayer||(o=!0,a&&(a.triggerPostprocess=!0));const r=this.subLayerList[s];a=this.addRenderAction(t,e,r,i,n,o),t++,n=!1}}r<t&&(a.lastCameraUse=!0),!o&&a&&(a.triggerPostprocess=!0),i.renderTarget&&i.postEffectsEnabled&&this.propagateRenderTarget(r-1,i)}this._logRenderActions()}}getNextRenderAction(e){const t=new Xy;return this._renderActions.push(t),t}addDummyRenderAction(e,t){const s=this.getNextRenderAction(e);s.camera=t,s.useCameraPasses=!0}addRenderAction(e,t,s,i,n,r){let a=t.renderTarget;i&&i.renderTarget&&1!==t.id&&(a=i.renderTarget);let o=!1;const l=this._renderActions;for(let t=e-1;t>=0;t--)if(l[t].camera===i&&l[t].renderTarget===a){o=!0;break}r&&i.postEffectsEnabled&&(a=null);const h=this.getNextRenderAction(e);h.triggerPostprocess=!1,h.layer=t,h.transparent=s,h.camera=i,h.renderTarget=a,h.firstCameraUse=n,h.lastCameraUse=!1;const c=n||!o,d=t.clearColorBuffer||t.clearDepthBuffer||t.clearStencilBuffer;return(c||d)&&h.setupClears(c?i:void 0,t),h}propagateRenderTarget(e,t){for(let s=e;s>=0;s--){const e=this._renderActions[s],i=e.layer;if(e.renderTarget&&1!==i.id)break;if(1===i.id)continue;if(e.useCameraPasses)break;const n=null==e?void 0:e.camera.camera;if(n&&(!t.camera.rect.equals(n.rect)||!t.camera.scissorRect.equals(n.scissorRect)))break;e.renderTarget=t.renderTarget}}_logRenderActions(){}_isLayerAdded(e){return this.layerIdMap.get(e.id)===e}_isSublayerAdded(e,t){return void 0!==(t?this.layerTransparentIndexMap:this.layerOpaqueIndexMap).get(e)}push(e){this._isLayerAdded(e)||(this.layerList.push(e),this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(!1)-1,this._transparentOrder[e.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e))}insert(e,t){if(this._isLayerAdded(e))return;this.layerList.splice(t,0,e,e),this.subLayerList.splice(t,0,!1,!0);const s=this.layerList.length;this._updateOpaqueOrder(t,s-1),this._updateTransparentOrder(t,s-1),this.subLayerEnabled.splice(t,0,!0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e)}remove(e){let t=this.layerList.indexOf(e);for(delete this._opaqueOrder[t],delete this._transparentOrder[t];t>=0;)this.layerList.splice(t,1),this.subLayerList.splice(t,1),this.subLayerEnabled.splice(t,1),t=this.layerList.indexOf(e),this._dirty=!0,this.fire("remove",e);const s=this.layerList.length;this._updateOpaqueOrder(0,s-1),this._updateTransparentOrder(0,s-1),this._updateLayerMaps()}pushOpaque(e){this._isSublayerAdded(e,!1)||(this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(!1)-1,this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e))}insertOpaque(e,t){if(this._isSublayerAdded(e,!1))return;this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,!1);const s=this.subLayerList.length;this._updateOpaqueOrder(t,s-1),this.subLayerEnabled.splice(t,0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e)}removeOpaque(e){for(let t=0,s=this.layerList.length;t<s;t++)if(this.layerList[t]===e&&!this.subLayerList[t]){this.layerList.splice(t,1),this.subLayerList.splice(t,1),s--,this._updateOpaqueOrder(t,s-1),this.subLayerEnabled.splice(t,1),this._dirty=!0,this.layerList.indexOf(e)<0&&this.fire("remove",e);break}this._updateLayerMaps()}pushTransparent(e){this._isSublayerAdded(e,!0)||(this.layerList.push(e),this._transparentOrder[e.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e))}insertTransparent(e,t){if(this._isSublayerAdded(e,!0))return;this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,!0);const s=this.subLayerList.length;this._updateTransparentOrder(t,s-1),this.subLayerEnabled.splice(t,0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e)}removeTransparent(e){for(let t=0,s=this.layerList.length;t<s;t++)if(this.layerList[t]===e&&this.subLayerList[t]){this.layerList.splice(t,1),this.subLayerList.splice(t,1),s--,this._updateTransparentOrder(t,s-1),this.subLayerEnabled.splice(t,1),this._dirty=!0,this.layerList.indexOf(e)<0&&this.fire("remove",e);break}this._updateLayerMaps()}getOpaqueIndex(e){var t;return null!=(t=this.layerOpaqueIndexMap.get(e))?t:-1}getTransparentIndex(e){var t;return null!=(t=this.layerTransparentIndexMap.get(e))?t:-1}isEnabled(e,t){const s=t?this.getTransparentIndex(e):this.getOpaqueIndex(e);return this.subLayerEnabled[s]}_updateLayerMaps(){this.layerIdMap.clear(),this.layerNameMap.clear(),this.layerOpaqueIndexMap.clear(),this.layerTransparentIndexMap.clear();for(let e=0;e<this.layerList.length;e++){const t=this.layerList[e];this.layerIdMap.set(t.id,t),this.layerNameMap.set(t.name,t);(this.subLayerList[e]?this.layerTransparentIndexMap:this.layerOpaqueIndexMap).set(t,e)}}getLayerById(e){var t;return null!=(t=this.layerIdMap.get(e))?t:null}getLayerByName(e){var t;return null!=(t=this.layerNameMap.get(e))?t:null}_updateOpaqueOrder(e,t){for(let s=e;s<=t;s++)!1===this.subLayerList[s]&&(this._opaqueOrder[this.layerList[s].id]=s)}_updateTransparentOrder(e,t){for(let s=e;s<=t;s++)!0===this.subLayerList[s]&&(this._transparentOrder[this.layerList[s].id]=s)}_sortLayersDescending(e,t,s){let i=-1,n=-1;for(let t=0,n=e.length;t<n;t++){const n=e[t];s.hasOwnProperty(n)&&(i=Math.max(i,s[n]))}for(let e=0,i=t.length;e<i;e++){const i=t[e];s.hasOwnProperty(i)&&(n=Math.max(n,s[i]))}return-1===i&&-1!==n?1:-1===n&&-1!==i?-1:n-i}sortTransparentLayers(e,t){return this._sortLayersDescending(e,t,this._transparentOrder)}sortOpaqueLayers(e,t){return this._sortLayersDescending(e,t,this._opaqueOrder)}}new nu,new ou(0,0,1,1),new ou(0,0,.5,.5),new ou(0,.5,.5,.5),new ou(0,0,.5,.5),new ou(0,.5,.5,.5),new ou(.5,0,.5,.5),new ou(0,0,.5,.5),new ou(0,.5,.5,.5),new ou(.5,0,.5,.5),new ou(.5,.5,.5,.5);class hb{constructor(e,t,s){this._areaLightsEnabled=!1,this._cells=new nu(10,3,10),this._maxLightsPerCell=255,this._shadowsEnabled=!0,this._shadowType=0,this._shadowAtlasResolution=2048,this._cookiesEnabled=!1,this._cookieAtlasResolution=2048,this.debugLayer=void 0,this.atlasSplit=null,this._supportsAreaLights=e,this._maxTextureSize=t,this._dirtyLightsFnc=s}applySettings(e){var t,s,i,n,r,a,o;this.shadowsEnabled=null!=(t=e.lightingShadowsEnabled)?t:this.shadowsEnabled,this.cookiesEnabled=null!=(s=e.lightingCookiesEnabled)?s:this.cookiesEnabled,this.areaLightsEnabled=null!=(i=e.lightingAreaLightsEnabled)?i:this.areaLightsEnabled,this.shadowAtlasResolution=null!=(n=e.lightingShadowAtlasResolution)?n:this.shadowAtlasResolution,this.cookieAtlasResolution=null!=(r=e.lightingCookieAtlasResolution)?r:this.cookieAtlasResolution,this.maxLightsPerCell=null!=(a=e.lightingMaxLightsPerCell)?a:this.maxLightsPerCell,this.shadowType=null!=(o=e.lightingShadowType)?o:this.shadowType,e.lightingCells&&(this.cell=new nu(e.lightingCells))}set cells(e){this._cells.copy(e)}get cells(){return this._cells}set maxLightsPerCell(e){this._maxLightsPerCell=Wd.clamp(e,1,255)}get maxLightsPerCell(){return this._maxLightsPerCell}set cookieAtlasResolution(e){this._cookieAtlasResolution=Wd.clamp(e,32,this._maxTextureSize)}get cookieAtlasResolution(){return this._cookieAtlasResolution}set shadowAtlasResolution(e){this._shadowAtlasResolution=Wd.clamp(e,32,this._maxTextureSize)}get shadowAtlasResolution(){return this._shadowAtlasResolution}set shadowType(e){this._shadowType!==e&&(this._shadowType=e,this._dirtyLightsFnc())}get shadowType(){return this._shadowType}set cookiesEnabled(e){this._cookiesEnabled!==e&&(this._cookiesEnabled=e,this._dirtyLightsFnc())}get cookiesEnabled(){return this._cookiesEnabled}set areaLightsEnabled(e){this._supportsAreaLights&&this._areaLightsEnabled!==e&&(this._areaLightsEnabled=e,this._dirtyLightsFnc())}get areaLightsEnabled(){return this._areaLightsEnabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this._dirtyLightsFnc())}get shadowsEnabled(){return this._shadowsEnabled}}const cb=new Sp(!0,0,1,1);class db{constructor(e){this.morph=e,e.incRefCount(),this.device=e.device,this._weights=[],this._weightMap=new Map;for(let t=0;t<e._targets.length;t++){const s=e._targets[t];s.name&&this._weightMap.set(s.name,t),this.setWeight(t,s.defaultWeight)}if(this._activeTargets=[],e.useTextureMorph){this.shaderCache={},this.maxSubmitCount=this.device.maxTextures,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount);const t=(t,s)=>(this[s]=e._createTexture(t,e._renderTextureFormat),new qp({colorBuffer:this[s],depth:!1}));e.morphPositions&&(this.rtPositions=t("MorphRTPos","texturePositions")),e.morphNormals&&(this.rtNormals=t("MorphRTNrm","textureNormals")),this._textureParams=new Float32Array([e.morphTextureWidth,e.morphTextureHeight,1/e.morphTextureWidth,1/e.morphTextureHeight]);for(let e=0;e<this.maxSubmitCount;e++)this["morphBlendTex"+e]=this.device.scope.resolve("morphBlendTex"+e);this.morphFactor=this.device.scope.resolve("morphFactor[0]"),this.zeroTextures=!1}else this.maxSubmitCount=8,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount),this._shaderMorphWeightsA=new Float32Array(this._shaderMorphWeights.buffer,0,4),this._shaderMorphWeightsB=new Float32Array(this._shaderMorphWeights.buffer,16,4),this._activeVertexBuffers=new Array(this.maxSubmitCount)}destroy(){this.shader=null;const e=this.morph;e&&(this.morph=null,e.decRefCount(),e.refCount<1&&e.destroy()),this.rtPositions&&(this.rtPositions.destroy(),this.rtPositions=null),this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null),this.rtNormals&&(this.rtNormals.destroy(),this.rtNormals=null),this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)}clone(){return new db(this.morph)}_getWeightIndex(e){if("string"==typeof e){return this._weightMap.get(e)}return e}getWeight(e){const t=this._getWeightIndex(e);return this._weights[t]}setWeight(e,t){const s=this._getWeightIndex(e);this._weights[s]=t,this._dirty=!0}_getFragmentShader(e){let t="";e>0&&(t+="varying vec2 uv0;\nuniform highp float morphFactor["+e+"];\n");for(let s=0;s<e;s++)t+="uniform highp sampler2D morphBlendTex"+s+";\n";t+="void main (void) {\n    highp vec4 color = vec4(0, 0, 0, 1);\n";for(let s=0;s<e;s++)t+="    color.xyz += morphFactor["+s+"] * texture2D(morphBlendTex"+s+", uv0).xyz;\n";return t+="    gl_FragColor = color;\n}\n",t}_getShader(e){let t=this.shaderCache[e];if(!t){const s=this._getFragmentShader(e);t=of(this.device,"\n\tattribute vec2 vertex_position;\n\tvarying vec2 uv0;\n\tvoid main(void) {\n\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\tuv0 = vertex_position.xy * 0.5 + 0.5;\n\t}\n\t",s,"textureMorph"+e),this.shaderCache[e]=t}return t}_updateTextureRenderTarget(e,t){const s=this.device,i=(t,i)=>{this.morphFactor.setValue(this._shaderMorphWeights),s.setBlendState(i?cb:Sp.NOBLEND);const n=this._getShader(t);ff(s,e,n)};let n=0,r=!1;const a=this._activeTargets.length;for(let e=0;e<a;e++){const s=this._activeTargets[e],a=s.target[t];a&&(this["morphBlendTex"+n].setValue(a),this._shaderMorphWeights[n]=s.weight,n++,n>=this.maxSubmitCount&&(i(n,r),n=0,r=!0))}(n>0||0===a&&!this.zeroTextures)&&i(n,r)}_updateTextureMorph(){this.device,(this._activeTargets.length>0||!this.zeroTextures)&&(this.rtPositions&&this._updateTextureRenderTarget(this.rtPositions,"texturePositions"),this.rtNormals&&this._updateTextureRenderTarget(this.rtNormals,"textureNormals"),this.zeroTextures=0===this._activeTargets.length)}_updateVertexMorph(){const e=this.maxSubmitCount;for(let t=0;t<e;t++)this._shaderMorphWeights[t]=0,this._activeVertexBuffers[t]=null;let t=0,s=this.morph.morphPositions?4:0;for(let e=0;e<this._activeTargets.length;e++){const i=this._activeTargets[e].target;i._vertexBufferPositions&&(this._activeVertexBuffers[t]=i._vertexBufferPositions,this._shaderMorphWeights[t]=this._activeTargets[e].weight,t++),i._vertexBufferNormals&&(this._activeVertexBuffers[s]=i._vertexBufferNormals,this._shaderMorphWeights[s]=this._activeTargets[e].weight,s++)}}update(){this._dirty=!1;const e=this.morph._targets;let t=0;for(let s=0;s<e.length;s++){const i=Math.abs(this.getWeight(s));if(i>1e-5){this._activeTargets.length<=t&&(this._activeTargets[t]={});const n=this._activeTargets[t++];n.absWeight=i,n.weight=this.getWeight(s),n.target=e[s]}}this._activeTargets.length=t;const s=this.morph.maxActiveTargets;this._activeTargets.length>s&&(this._activeTargets.sort((function(e,t){return e.absWeight<t.absWeight?1:t.absWeight<e.absWeight?-1:0})),this._activeTargets.length=s),this.morph.useTextureMorph?this._updateTextureMorph():this._updateVertexMorph()}}class ub{constructor(){this.graph=null,this.meshInstances=[],this.skinInstances=[],this.morphInstances=[],this.cameras=[],this.lights=[],this._shadersVersion=0,this._immutable=!1}getGraph(){return this.graph}setGraph(e){this.graph=e}getCameras(){return this.cameras}setCameras(e){this.cameras=e}getLights(){return this.lights}setLights(e){this.lights=e}getMaterials(){const e=[];for(let t=0;t<this.meshInstances.length;t++){const s=this.meshInstances[t];-1===e.indexOf(s.material)&&e.push(s.material)}return e}clone(){const e=[],t=[],s=function s(i){const n=i.clone();e.push(i),t.push(n);for(let e=0;e<i._children.length;e++)n.addChild(s(i._children[e]));return n}(this.graph),i=[],n=[],r=[];for(let e=0;e<this.skinInstances.length;e++){const t=this.skinInstances[e].skin,i=new Mf(t),r=[];for(let e=0;e<t.boneNames.length;e++){const i=t.boneNames[e],n=s.findByName(i);r.push(n)}i.bones=r,n.push(i)}for(let e=0;e<this.morphInstances.length;e++){const t=this.morphInstances[e].morph,s=new db(t);r.push(s)}for(let s=0;s<this.meshInstances.length;s++){const a=this.meshInstances[s],o=e.indexOf(a.node),l=new ig(a.mesh,a.material,t[o]);if(a.skinInstance){const e=this.skinInstances.indexOf(a.skinInstance);l.skinInstance=n[e]}if(a.morphInstance){const e=this.morphInstances.indexOf(a.morphInstance);l.morphInstance=r[e]}i.push(l)}const a=new ub;return a.graph=s,a.meshInstances=i,a.skinInstances=n,a.morphInstances=r,a.getGraph().syncHierarchy(),a}destroy(){const e=this.meshInstances;for(let t=0;t<e.length;t++)e[t].destroy();this.meshInstances.length=0}generateWireframe(){ig._prepareRenderStyleForArray(this.meshInstances,1)}}const pb=new class extends af{generateKey(e){let t="particle";for(const s in e)e.hasOwnProperty(s)&&(t+=e[s]);return t}_animTex(e){let t="";return t+=e.animTexLoop?tf.particleAnimFrameLoopVS:tf.particleAnimFrameClampVS,t+=tf.particleAnimTexVS,t}createShaderDefinition(e,t){const s=`#define PARTICLE_${t.useCpu?"CPU":"GPU"}\n`;let i="#define PARTICLE\n"+s,n="#define VERTEXSHADER\n"+s;t.mesh&&(n+="#define USE_MESH\n"),t.localSpace&&(n+="#define LOCAL_SPACE\n"),t.screenSpace&&(n+="#define SCREEN_SPACE\n"),t.animTex&&(n+="\nuniform vec2 animTexTilesParams;\n"),t.animTex&&(n+="\nuniform vec4 animTexParams;\n"),t.animTex&&(n+="\nuniform vec2 animTexIndexParams;\n"),2===t.normal&&(n+="\nvarying mat3 ParticleMat;\n"),1===t.normal&&(n+="\nvarying vec3 Normal;\n"),t.soft&&(n+="\nvarying float vDepth;\n");const r=t.customFace?tf.particle_customFaceVS:tf.particle_billboardVS;return t.useCpu?(t.soft>0&&(n+=tf.screenDepthPS),n+=tf.particle_cpuVS,t.localSpace&&(n+=tf.particle_localShiftVS),t.animTex&&(n+=this._animTex(t)),t.alignToMotion&&(n+=tf.particle_pointAlongVS),n+=t.mesh?tf.particle_meshVS:r,1===t.normal&&(n+=tf.particle_normalVS),2===t.normal&&(n+=tf.particle_TBNVS),t.stretch>0&&(n+=tf.particle_stretchVS),n+=tf.particle_cpu_endVS,t.soft>0&&(n+=tf.particle_softVS)):(n+=tf.particle_initVS,n+=t.pack8?tf.particleInputRgba8PS:tf.particleInputFloatPS,t.soft>0&&(n+=tf.screenDepthPS),n+=tf.particleVS,t.localSpace&&(n+=tf.particle_localShiftVS),t.animTex&&(n+=this._animTex(t)),t.wrap&&(n+=tf.particle_wrapVS),t.alignToMotion&&(n+=tf.particle_pointAlongVS),n+=t.mesh?tf.particle_meshVS:r,1===t.normal&&(n+=tf.particle_normalVS),2===t.normal&&(n+=tf.particle_TBNVS),t.stretch>0&&(n+=tf.particle_stretchVS),n+=tf.particle_endVS,t.soft>0&&(n+=tf.particle_softVS)),n+="}\n",t.normal>0&&(1===t.normal?i+="\nvarying vec3 Normal;\n":2===t.normal&&(i+="\nvarying mat3 ParticleMat;\n"),i+="\nuniform vec3 lightCube[6];\n"),t.soft&&(i+="\nvarying float vDepth;\n"),0===t.normal&&"none"===t.fog&&(t.srgb=!1),i+=tf.decodePS,i+=af.gammaCode(t.gamma),i+=af.tonemapCode(t.toneMap),"linear"===t.fog?i+=tf.fogLinearPS:"exp"===t.fog?i+=tf.fogExpPS:"exp2"===t.fog?i+=tf.fogExp2PS:i+=tf.fogNonePS,2===t.normal&&(i+="\nuniform sampler2D normalMap;\n"),t.soft>0&&(i+=tf.screenDepthPS),i+=tf.particlePS,t.soft>0&&(i+=tf.particle_softPS),1===t.normal&&(i+="\nvec3 normal = Normal;\n"),2===t.normal&&(i+=tf.particle_normalMapPS),t.normal>0&&(i+=t.halflambert?tf.particle_halflambertPS:tf.particle_lambertPS),t.normal>0&&(i+=tf.particle_lightingPS),2===t.blend?i+=tf.particle_blendNormalPS:1===t.blend?i+=tf.particle_blendAddPS:5===t.blend&&(i+=tf.particle_blendMultiplyPS),i+=tf.particle_endPS,Pm.createDefinition(e,{name:"ParticleShader",vertexCode:n,fragmentCode:i})}};let mb,_b=1;const fb=new pu,gb=new pu,vb=new nu,yb=new nu,bb=new nu,xb=new nu,wb=new nu,Sb=new nu,Cb=new nu,Tb=new nu,Ab=new nu,Eb=new nu,Pb=new nu,Mb=new nu,Lb=new nu;function Db(e){return e-Math.floor(e)}function kb(e){return Math.max(Math.min(e,1),0)}function Ib(e,t){return e-t*Math.floor(e/t)}function Rb(e){let t=Db(e),s=Db(255*e);return t-=s/255,s-=s/255,[t,s]}class Ob{constructor(e){this._emitter=e}calcSpawnPosition(e,t,s,i,n){const r=this._emitter,a=Math.random(),o=Math.random(),l=Math.random(),h=Math.random();if(r.useCpu&&(e[4*n+0+2*r.numParticlesPot*4]=a,e[4*n+1+2*r.numParticlesPot*4]=o,e[4*n+2+2*r.numParticlesPot*4]=l),yb.x=a-.5,yb.y=o-.5,yb.z=l-.5,0===r.emitterShape){const e=Math.max(Math.abs(yb.x),Math.max(Math.abs(yb.y),Math.abs(yb.z))),n=e+(.5-e)*s[0],a=e+(.5-e)*s[1],o=e+(.5-e)*s[2];yb.x=n*(e===Math.abs(yb.x)?Math.sign(yb.x):2*yb.x),yb.y=a*(e===Math.abs(yb.y)?Math.sign(yb.y):2*yb.y),yb.z=o*(e===Math.abs(yb.z)?Math.sign(yb.z):2*yb.z),r.localSpace?vb.copy(t.transformPoint(yb)):vb.copy(i).add(t.transformPoint(yb))}else{yb.normalize();const e=0===r.emitterRadius?0:r.emitterRadiusInner/r.emitterRadius,t=h*(1-e)+e;r.localSpace?vb.copy(yb.mulScalar(t*r.emitterRadius)):vb.copy(i).add(yb.mulScalar(t*r.emitterRadius))}let c=-Wd.lerp(r.rate,r.rate2,a)*n;if(r.pack8){const t=(vb.x-r.worldBounds.center.x)/r.worldBoundsSize.x+.5,s=(vb.y-r.worldBounds.center.y)/r.worldBoundsSize.y+.5,i=(vb.z-r.worldBounds.center.z)/r.worldBoundsSize.z+.5;let o=Wd.lerp(r.startAngle*Wd.DEG_TO_RAD,r.startAngle2*Wd.DEG_TO_RAD,a);o=o%(2*Math.PI)/(2*Math.PI);const l=Rb(t);e[4*n]=l[0],e[4*n+1]=l[1];const h=Rb(s);e[4*n+2]=h[0],e[4*n+3]=h[1];const d=Rb(i);e[4*n+0+4*r.numParticlesPot]=d[0],e[4*n+1+4*r.numParticlesPot]=d[1];const u=Rb(o);e[4*n+2+4*r.numParticlesPot]=u[0],e[4*n+3+4*r.numParticlesPot]=u[1];const p=1;e[4*n+3+4*r.numParticlesPot*2]=p;const m=Math.max(r.lifetime,(r.numParticles-1)*Math.max(r.rate,r.rate2));c=(c+m)/(m+(r.lifetime+1));const _=function(e){let t=Db(e),s=Db(255*e),i=Db(65025*e),n=Db(160581375*e);return t-=s/255,s-=i/255,i-=n/255,n-=n/255,[t,s,i,n]}(c);e[4*n+0+4*r.numParticlesPot*3]=_[0],e[4*n+1+4*r.numParticlesPot*3]=_[1],e[4*n+2+4*r.numParticlesPot*3]=_[2],e[4*n+3+4*r.numParticlesPot*3]=_[3]}else e[4*n]=vb.x,e[4*n+1]=vb.y,e[4*n+2]=vb.z,e[4*n+3]=Wd.lerp(r.startAngle*Wd.DEG_TO_RAD,r.startAngle2*Wd.DEG_TO_RAD,a),e[4*n+3+4*r.numParticlesPot]=c}update(e,t,s,i,n,r,a,o){let l,h,c;const d=this._emitter;if(d.meshInstance.node){const e=d.meshInstance.node.worldTransform;for(let t=0;t<12;t++)fb.data[t]=e.data[t];gb.copy(fb),gb.invert(),mb=d.meshInstance.node.localScale,_b=Math.max(Math.max(mb.x,mb.y),mb.z)}r=null===d.meshInstance.node||d.localSpace?nu.ZERO:d.meshInstance.node.getPosition();const u=d.camera?d.camera._node.getPosition():nu.ZERO,p=d.useMesh?17:15;let m,_,f,g,v,y,b,x,w;const S=d.precision-1;for(let t=0;t<d.numParticles;t++){const C=Math.floor(d.vbCPU[t*d.numParticleVerts*(d.useMesh?6:4)+3]),T=s[4*C+0+2*d.numParticlesPot*4];bb.x=T,bb.y=s[4*C+1+2*d.numParticlesPot*4],bb.z=s[4*C+2+2*d.numParticlesPot*4];const A=d.rate+(d.rate2-d.rate)*T,E=d.lifetime;let P=s[4*C+3+4*d.numParticlesPot]+a;const M=kb(P/E);let L=0,D=0;const k=0;(P-a<=0||P>=E)&&this.calcSpawnPosition(s,i,n,r,C);let I=P>0&&P<E;I&&(c=M*S,m=Math.floor(c),_=Math.ceil(c),c%=1,l=d.qRotSpeed[m],h=d.qRotSpeed[_],f=l+(h-l)*c,l=d.qRotSpeed2[m],h=d.qRotSpeed2[_],g=l+(h-l)*c,l=d.qScale[m],h=d.qScale[_],L=l+(h-l)*c,l=d.qScale2[m],h=d.qScale2[_],v=l+(h-l)*c,l=d.qAlpha[m],h=d.qAlpha[_],y=l+(h-l)*c,l=d.qAlpha2[m],h=d.qAlpha2[_],b=l+(h-l)*c,l=d.qRadialSpeed[m],h=d.qRadialSpeed[_],x=l+(h-l)*c,l=d.qRadialSpeed2[m],h=d.qRadialSpeed2[_],w=l+(h-l)*c,x+=100*T%1*(w-x),xb.x=s[4*C],xb.y=s[4*C+1],xb.z=s[4*C+2],d.localSpace?Ab.copy(xb):Ab.copy(xb).sub(r),Ab.normalize().mulScalar(x),m*=3,_*=3,l=d.qLocalVelocity[m],h=d.qLocalVelocity[_],Sb.x=l+(h-l)*c,l=d.qLocalVelocity[m+1],h=d.qLocalVelocity[_+1],Sb.y=l+(h-l)*c,l=d.qLocalVelocity[m+2],h=d.qLocalVelocity[_+2],Sb.z=l+(h-l)*c,l=d.qLocalVelocity2[m],h=d.qLocalVelocity2[_],Tb.x=l+(h-l)*c,l=d.qLocalVelocity2[m+1],h=d.qLocalVelocity2[_+1],Tb.y=l+(h-l)*c,l=d.qLocalVelocity2[m+2],h=d.qLocalVelocity2[_+2],Tb.z=l+(h-l)*c,l=d.qVelocity[m],h=d.qVelocity[_],wb.x=l+(h-l)*c,l=d.qVelocity[m+1],h=d.qVelocity[_+1],wb.y=l+(h-l)*c,l=d.qVelocity[m+2],h=d.qVelocity[_+2],wb.z=l+(h-l)*c,l=d.qVelocity2[m],h=d.qVelocity2[_],Cb.x=l+(h-l)*c,l=d.qVelocity2[m+1],h=d.qVelocity2[_+1],Cb.y=l+(h-l)*c,l=d.qVelocity2[m+2],h=d.qVelocity2[_+2],Cb.z=l+(h-l)*c,Sb.x+=(Tb.x-Sb.x)*bb.x,Sb.y+=(Tb.y-Sb.y)*bb.y,Sb.z+=(Tb.z-Sb.z)*bb.z,d.initialVelocity>0&&(1===d.emitterShape?(yb.copy(bb).mulScalar(2).sub(nu.ONE).normalize(),Sb.add(yb.mulScalar(d.initialVelocity))):Sb.add(nu.FORWARD.mulScalar(d.initialVelocity))),wb.x+=(Cb.x-wb.x)*bb.x,wb.y+=(Cb.y-wb.y)*bb.y,wb.z+=(Cb.z-wb.z)*bb.z,f+=(g-f)*bb.y,L=(L+1e4*T%1*(v-L))*_b,D=1e3*T%1*(b-y),d.meshInstance.node&&(d.localSpace?(Sb.x/=mb.x,Sb.y/=mb.y,Sb.z/=mb.z):fb.transformPoint(Sb,Sb)),d.localSpace?(gb.transformPoint(wb,wb),Sb.add(wb).add(Ab)):(Sb.add(wb.mul(mb)),Sb.add(Ab.mul(mb))),Mb.copy(Sb),Eb.copy(xb).add(Sb.mulScalar(a)),Pb.copy(Eb),s[4*C]=Pb.x,s[4*C+1]=Pb.y,s[4*C+2]=Pb.z,s[4*C+3]+=f*a,d.wrap&&d.wrapBounds&&(d.localSpace||Pb.sub(r),Pb.x=Ib(Pb.x,d.wrapBounds.x)-.5*d.wrapBounds.x,Pb.y=Ib(Pb.y,d.wrapBounds.y)-.5*d.wrapBounds.y,Pb.z=Ib(Pb.z,d.wrapBounds.z)-.5*d.wrapBounds.z,d.localSpace||Pb.add(r)),d.sort>0&&(1===d.sort?(Lb.copy(Pb).sub(u),d.particleDistance[C]=-(Lb.x*Lb.x+Lb.y*Lb.y+Lb.z*Lb.z)):2===d.sort?d.particleDistance[C]=P:3===d.sort&&(d.particleDistance[C]=-P))),o?P<0&&(s[4*C+3+2*d.numParticlesPot*4]=-1):(P>=E&&(P-=Math.max(E,(d.numParticles-1)*A),s[4*C+3+2*d.numParticlesPot*4]=d.loop?1:-1),P<0&&d.loop&&(s[4*C+3+2*d.numParticlesPot*4]=1)),s[4*C+3+2*d.numParticlesPot*4]<0&&(I=!1),s[4*C+3+4*d.numParticlesPot]=P;for(let i=0;i<d.numParticleVerts;i++){const n=(t*d.numParticleVerts+i)*(d.useMesh?6:4);let r=d.vbCPU[n],a=d.vbCPU[n+1],o=d.vbCPU[n+2];I||(r=a=o=0);const l=t*d.numParticleVerts*p+i*p;e[l]=Pb.x,e[l+1]=Pb.y,e[l+2]=Pb.z,e[l+3]=M,e[l+4]=d.alignToMotion?k:s[4*C+3],e[l+5]=L,e[l+6]=D,e[l+7]=Mb.x,e[l+8]=r,e[l+9]=a,e[l+10]=o,e[l+11]=Mb.y,e[l+12]=C,e[l+13]=Mb.z,e[l+14]=d.vbCPU[n+3],d.useMesh&&(e[l+15]=d.vbCPU[n+4],e[l+16]=d.vbCPU[n+5])}}if(d.sort>0&&d.camera){const e=d.useMesh?6:4,s=d.particleDistance;for(let i=0;i<d.numParticles;i++)t[i][0]=i,t[i][1]=s[Math.floor(d.vbCPU[i*d.numParticleVerts*e+3])];d.vbOld.set(d.vbCPU),t.sort((function(e,t){return e[1]-t[1]}));for(let s=0;s<d.numParticles;s++){const i=t[s][0]*d.numParticleVerts*e,n=s*d.numParticleVerts*e;for(let t=0;t<d.numParticleVerts*e;t++)d.vbCPU[n+t]=d.vbOld[i+t]}}}}const zb=new ru,Fb=new ru,Vb=new ru;class Nb{constructor(e,t){this._emitter=e,this.frameRandomUniform=new Float32Array(3),this.emitterPosUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),this.worldBoundsMulUniform=new Float32Array(3),this.worldBoundsAddUniform=new Float32Array(3),this.inBoundsSizeUniform=new Float32Array(3),this.inBoundsCenterUniform=new Float32Array(3),this.constantParticleTexIN=t.scope.resolve("particleTexIN"),this.constantParticleTexOUT=t.scope.resolve("particleTexOUT"),this.constantEmitterPos=t.scope.resolve("emitterPos"),this.constantEmitterScale=t.scope.resolve("emitterScale"),this.constantSpawnBounds=t.scope.resolve("spawnBounds"),this.constantSpawnPosInnerRatio=t.scope.resolve("spawnPosInnerRatio"),this.constantSpawnBoundsSphere=t.scope.resolve("spawnBoundsSphere"),this.constantSpawnBoundsSphereInnerRatio=t.scope.resolve("spawnBoundsSphereInnerRatio"),this.constantInitialVelocity=t.scope.resolve("initialVelocity"),this.constantFrameRandom=t.scope.resolve("frameRandom"),this.constantDelta=t.scope.resolve("delta"),this.constantRate=t.scope.resolve("rate"),this.constantRateDiv=t.scope.resolve("rateDiv"),this.constantLifetime=t.scope.resolve("lifetime"),this.constantGraphSampleSize=t.scope.resolve("graphSampleSize"),this.constantGraphNumSamples=t.scope.resolve("graphNumSamples"),this.constantInternalTex0=t.scope.resolve("internalTex0"),this.constantInternalTex1=t.scope.resolve("internalTex1"),this.constantInternalTex2=t.scope.resolve("internalTex2"),this.constantInternalTex3=t.scope.resolve("internalTex3"),this.constantEmitterMatrix=t.scope.resolve("emitterMatrix"),this.constantEmitterMatrixInv=t.scope.resolve("emitterMatrixInv"),this.constantNumParticles=t.scope.resolve("numParticles"),this.constantNumParticlesPot=t.scope.resolve("numParticlesPot"),this.constantLocalVelocityDivMult=t.scope.resolve("localVelocityDivMult"),this.constantVelocityDivMult=t.scope.resolve("velocityDivMult"),this.constantRotSpeedDivMult=t.scope.resolve("rotSpeedDivMult"),this.constantSeed=t.scope.resolve("seed"),this.constantStartAngle=t.scope.resolve("startAngle"),this.constantStartAngle2=t.scope.resolve("startAngle2"),this.constantOutBoundsMul=t.scope.resolve("outBoundsMul"),this.constantOutBoundsAdd=t.scope.resolve("outBoundsAdd"),this.constantInBoundsSize=t.scope.resolve("inBoundsSize"),this.constantInBoundsCenter=t.scope.resolve("inBoundsCenter"),this.constantMaxVel=t.scope.resolve("maxVel"),this.constantFaceTangent=t.scope.resolve("faceTangent"),this.constantFaceBinorm=t.scope.resolve("faceBinorm")}_setInputBounds(){this.inBoundsSizeUniform[0]=this._emitter.prevWorldBoundsSize.x,this.inBoundsSizeUniform[1]=this._emitter.prevWorldBoundsSize.y,this.inBoundsSizeUniform[2]=this._emitter.prevWorldBoundsSize.z,this.constantInBoundsSize.setValue(this.inBoundsSizeUniform),this.inBoundsCenterUniform[0]=this._emitter.prevWorldBoundsCenter.x,this.inBoundsCenterUniform[1]=this._emitter.prevWorldBoundsCenter.y,this.inBoundsCenterUniform[2]=this._emitter.prevWorldBoundsCenter.z,this.constantInBoundsCenter.setValue(this.inBoundsCenterUniform)}randomize(){this.frameRandomUniform[0]=Math.random(),this.frameRandomUniform[1]=Math.random(),this.frameRandomUniform[2]=Math.random()}update(e,t,s,i,n){const r=this._emitter;e.setBlendState(Sp.NOBLEND),e.setDepthState(Ep.NODEPTH),e.setCullMode(0),this.randomize(),this.constantGraphSampleSize.setValue(1/r.precision),this.constantGraphNumSamples.setValue(r.precision),this.constantNumParticles.setValue(r.numParticles),this.constantNumParticlesPot.setValue(r.numParticlesPot),this.constantInternalTex0.setValue(r.internalTex0),this.constantInternalTex1.setValue(r.internalTex1),this.constantInternalTex2.setValue(r.internalTex2),this.constantInternalTex3.setValue(r.internalTex3);const a=r.meshInstance.node,o=null===a?nu.ONE:a.localScale;if(r.pack8){this.worldBoundsMulUniform[0]=r.worldBoundsMul.x,this.worldBoundsMulUniform[1]=r.worldBoundsMul.y,this.worldBoundsMulUniform[2]=r.worldBoundsMul.z,this.constantOutBoundsMul.setValue(this.worldBoundsMulUniform),this.worldBoundsAddUniform[0]=r.worldBoundsAdd.x,this.worldBoundsAddUniform[1]=r.worldBoundsAdd.y,this.worldBoundsAddUniform[2]=r.worldBoundsAdd.z,this.constantOutBoundsAdd.setValue(this.worldBoundsAddUniform),this._setInputBounds();let e=r.maxVel*Math.max(Math.max(o.x,o.y),o.z);e=Math.max(e,1),this.constantMaxVel.setValue(e)}const l=null===a||r.localSpace?nu.ZERO:a.getPosition(),h=null===a?pu.IDENTITY:a.getWorldTransform();0===r.emitterShape?(zb.setFromMat4(t),this.constantSpawnBounds.setValue(zb.data),this.constantSpawnPosInnerRatio.setValue(s)):(this.constantSpawnBoundsSphere.setValue(r.emitterRadius),this.constantSpawnBoundsSphereInnerRatio.setValue(0===r.emitterRadius?0:r.emitterRadiusInner/r.emitterRadius)),this.constantInitialVelocity.setValue(r.initialVelocity),Fb.setFromMat4(h),Vb.invertMat4(h),this.emitterPosUniform[0]=l.x,this.emitterPosUniform[1]=l.y,this.emitterPosUniform[2]=l.z,this.constantEmitterPos.setValue(this.emitterPosUniform),this.constantFrameRandom.setValue(this.frameRandomUniform),this.constantDelta.setValue(i),this.constantRate.setValue(r.rate),this.constantRateDiv.setValue(r.rate2-r.rate),this.constantStartAngle.setValue(r.startAngle*Wd.DEG_TO_RAD),this.constantStartAngle2.setValue(r.startAngle2*Wd.DEG_TO_RAD),this.constantSeed.setValue(r.seed),this.constantLifetime.setValue(r.lifetime),this.emitterScaleUniform[0]=o.x,this.emitterScaleUniform[1]=o.y,this.emitterScaleUniform[2]=o.z,this.constantEmitterScale.setValue(this.emitterScaleUniform),this.constantEmitterMatrix.setValue(Fb.data),this.constantEmitterMatrixInv.setValue(Vb.data),this.constantLocalVelocityDivMult.setValue(r.localVelocityUMax),this.constantVelocityDivMult.setValue(r.velocityUMax),this.constantRotSpeedDivMult.setValue(r.rotSpeedUMax[0]);let c=r.swapTex?r.particleTexOUT:r.particleTexIN;c=r.beenReset?r.particleTexStart:c;const d=r.swapTex?r.particleTexIN:r.particleTexOUT;this.constantParticleTexIN.setValue(c),ff(e,r.swapTex?r.rtParticleTexIN:r.rtParticleTexOUT,n?r.shaderParticleUpdateOnStop:r.loop?r.shaderParticleUpdateRespawn:r.shaderParticleUpdateNoRespawn),r.material.setParameter("particleTexOUT",c),r.material.setParameter("particleTexIN",d),r.beenReset=!1,r.swapTex=!r.swapTex,r.prevWorldBoundsSize.copy(r.worldBoundsSize),r.prevWorldBoundsCenter.copy(r.worldBounds.center),r.pack8&&this._setInputBounds()}}const Bb=[[-1,-1],[1,-1],[1,1],[-1,1]];function Ub(e,t,s,i,n=14,r,a){let o=0;a&&7===n&&(o=1);const l=new bm(e,{width:t,height:s,format:n,cubemap:!1,mipmaps:!1,minFilter:o,magFilter:o,addressU:1,addressV:1,name:"ParticleSystemTexture"}),h=l.lock();if(7===n){const e=new Uint8Array(i.length);for(let t=0;t<i.length;t++)e[t]=i[t]*r*255;i=e}return h.set(i),l.unlock(),l}function Hb(e){return Math.max(Math.min(e,1),0)}const Wb=new Kd([0,0,1,0]),Gb=new Kd([0,1,1,1]),jb=new Xd([0,0,1,0],[0,0,1,0],[0,0,1,0]),qb=new Xd([0,1,1,1],[0,1,1,1],[0,1,1,1]);let Kb=2;const Xb=new Float32Array(3),Yb=new pu,Zb=new nu,$b=new nu,Qb=new nu;let Jb,ex;function tx(e,t){void 0!==ex[e]&&null!==ex[e]?Jb[e]=ex[e]:Jb[e]=t}function sx(e,t,s){return(255*e<<16|255*t<<8|255*s)/(1<<24)}function ix(e,t){const s=e.length/3,i=new Array(4*s);for(let n=0;n<s;n++)i[4*n]=e[3*n],i[4*n+1]=e[3*n+1],i[4*n+2]=e[3*n+2],i[4*n+3]=sx(t[3*n],t[3*n+1],t[3*n+2]);return i}function nx(e,t){const s=t.length,i=e.length/s;for(let n=0;n<i;n++)for(let i=0;i<s;i++){const r=Math.abs(e[n*s+i]);t[i]=Math.max(t[i],r)}}function rx(e,t,s){const i=function(e,t){const s=new Float32Array(e.length);for(let i=0;i<e.length;i++)s[i]=e[i]-t[i];return s}(t,e);return nx(i,s),function(e,t){const s=t.length,i=e.length/s;for(let n=0;n<i;n++)for(let i=0;i<s;i++)e[n*s+i]/=0===t[i]?1:t[i],e[n*s+i]*=.5,e[n*s+i]+=.5}(i,s),i}const ax=new zp;class ox{constructor(e,t){this.graphicsDevice=e;const s=e;this.precision=32,this._addTimeTime=0,Jb=this,ex=t,tx("numParticles",1),this.numParticles>e.maxTextureSize&&(this.numParticles=e.maxTextureSize),tx("rate",1),tx("rate2",this.rate),tx("lifetime",50),tx("emitterExtents",new nu(0,0,0)),tx("emitterExtentsInner",new nu(0,0,0)),tx("emitterRadius",0),tx("emitterRadiusInner",0),tx("emitterShape",0),tx("initialVelocity",1),tx("wrap",!1),tx("localSpace",!1),tx("screenSpace",!1),tx("wrapBounds",null),tx("colorMap",this.defaultParamTexture),tx("normalMap",null),tx("loop",!0),tx("preWarm",!1),tx("sort",0),tx("mode",0),tx("scene",null),tx("lighting",!1),tx("halfLambert",!1),tx("intensity",1),tx("stretch",0),tx("alignToMotion",!1),tx("depthSoftening",0),tx("mesh",null),tx("particleNormal",new nu(0,1,0)),tx("orientation",0),tx("depthWrite",!1),tx("noFog",!1),tx("blendType",2),tx("node",null),tx("startAngle",0),tx("startAngle2",this.startAngle),tx("animTilesX",1),tx("animTilesY",1),tx("animStartFrame",0),tx("animNumFrames",1),tx("animNumAnimations",1),tx("animIndex",0),tx("randomizeAnimIndex",!1),tx("animSpeed",1),tx("animLoop",!0),this._gpuUpdater=new Nb(this,s),this._cpuUpdater=new Ob(this),this.emitterPosUniform=new Float32Array(3),this.wrapBoundsUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),tx("colorGraph",qb),tx("colorGraph2",this.colorGraph),tx("scaleGraph",Gb),tx("scaleGraph2",this.scaleGraph),tx("alphaGraph",Gb),tx("alphaGraph2",this.alphaGraph),tx("localVelocityGraph",jb),tx("localVelocityGraph2",this.localVelocityGraph),tx("velocityGraph",jb),tx("velocityGraph2",this.velocityGraph),tx("rotationSpeedGraph",Wb),tx("rotationSpeedGraph2",this.rotationSpeedGraph),tx("radialSpeedGraph",Wb),tx("radialSpeedGraph2",this.radialSpeedGraph),this.animTilesParams=new Float32Array(2),this.animParams=new Float32Array(4),this.animIndexParams=new Float32Array(2),this.internalTex0=null,this.internalTex1=null,this.internalTex2=null,this.colorParam=null,this.vbToSort=null,this.vbOld=null,this.particleDistance=null,this.camera=null,this.swapTex=!1,this.useMesh=!0,this.useCpu=!e.supportsGpuParticles,this.pack8=!0,this.localBounds=new xu,this.worldBoundsNoTrail=new xu,this.worldBoundsTrail=[new xu,new xu],this.worldBounds=new xu,this.worldBoundsSize=new nu,this.prevWorldBoundsSize=new nu,this.prevWorldBoundsCenter=new nu,this.prevEmitterExtents=this.emitterExtents,this.prevEmitterRadius=this.emitterRadius,this.worldBoundsMul=new nu,this.worldBoundsAdd=new nu,this.timeToSwitchBounds=0,this.shaderParticleUpdateRespawn=null,this.shaderParticleUpdateNoRespawn=null,this.shaderParticleUpdateOnStop=null,this.numParticleVerts=0,this.numParticleIndices=0,this.material=null,this.meshInstance=null,this.drawOrder=0,this.seed=Math.random(),this.fixedTimeStep=1/60,this.maxSubSteps=10,this.simTime=0,this.simTimeTotal=0,this.beenReset=!1,this._layer=null,this.rebuild()}get defaultParamTexture(){return ax.get(this.graphicsDevice,(()=>{const e=16,t=new Float32Array(1024);for(let s=0;s<e;s++)for(let i=0;i<e;i++){const n=i+1-8.5,r=s+1-8.5,a=Hb(1-Hb(Math.sqrt(n*n+r*r)/e)-.5),o=s*e+i;t[4*o]=1,t[4*o+1]=1,t[4*o+2]=1,t[4*o+3]=a}const s=Ub(this.graphicsDevice,e,e,t,7,1,!0);return s.minFilter=1,s.magFilter=1,s}))}onChangeCamera(){this.regenShader(),this.resetMaterial()}calculateBoundsMad(){this.worldBoundsMul.x=1/this.worldBoundsSize.x,this.worldBoundsMul.y=1/this.worldBoundsSize.y,this.worldBoundsMul.z=1/this.worldBoundsSize.z,this.worldBoundsAdd.copy(this.worldBounds.center).mul(this.worldBoundsMul).mulScalar(-1),this.worldBoundsAdd.x+=.5,this.worldBoundsAdd.y+=.5,this.worldBoundsAdd.z+=.5}calculateWorldBounds(){if(!this.node)return;if(this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),!this.useCpu){let e=!1;e=0===this.emitterShape?!this.emitterExtents.equals(this.prevEmitterExtents):!(this.emitterRadius===this.prevEmitterRadius),e&&this.calculateLocalBounds()}const e=this.node.getWorldTransform();this.localSpace?this.worldBoundsNoTrail.copy(this.localBounds):this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,e),this.worldBoundsTrail[0].add(this.worldBoundsNoTrail),this.worldBoundsTrail[1].add(this.worldBoundsNoTrail);const t=this.simTimeTotal;t>=this.timeToSwitchBounds&&(this.worldBoundsTrail[0].copy(this.worldBoundsTrail[1]),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.timeToSwitchBounds=t+this.lifetime),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.localSpace?(this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,e),this.meshInstance.mesh.aabb.setFromTransformedAabb(this.worldBounds,e)):(this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance.mesh.aabb.copy(this.worldBounds)),this.meshInstance._aabbVer=1-this.meshInstance._aabbVer,this.pack8&&this.calculateBoundsMad()}resetWorldBounds(){this.node&&(this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,this.localSpace?pu.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBoundsNoTrail),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.simTimeTotal=0,this.timeToSwitchBounds=0)}calculateLocalBounds(){let e=Number.MAX_VALUE,t=Number.MAX_VALUE,s=Number.MAX_VALUE,i=-Number.MAX_VALUE,n=-Number.MAX_VALUE,r=-Number.MAX_VALUE,a=0,o=0;const l=this.lifetime/this.precision,h=[this.qVelocity,this.qVelocity2],c=[this.qLocalVelocity,this.qLocalVelocity2],d=[0,0],u=[0,0],p=[0,0],m=[0,0],_=[0,0];let f,g,v;for(let y=0;y<this.precision+1;y++){const b=Math.min(y,this.precision-1);for(let a=0;a<2;a++)f=c[a][3*b+0]*l+d[a],g=c[a][3*b+1]*l+u[a],v=c[a][3*b+2]*l+p[a],e=Math.min(f,e),t=Math.min(g,t),s=Math.min(v,s),i=Math.max(f,i),n=Math.max(g,n),r=Math.max(v,r),d[a]=f,u[a]=g,p[a]=v;for(let e=0;e<2;e++)_[e]+=l*Math.sqrt(h[e][3*b+0]*h[e][3*b+0]+h[e][3*b+1]*h[e][3*b+1]+h[e][3*b+2]*h[e][3*b+2]);m[0]+=this.qRadialSpeed[b]*l,m[1]+=this.qRadialSpeed2[b]*l,a=Math.max(a,Math.max(Math.abs(m[0]),Math.abs(m[1]))),o=Math.max(o,this.qScale[b])}0===this.emitterShape?(f=.5*this.emitterExtents.x,g=.5*this.emitterExtents.y,v=.5*this.emitterExtents.z):(f=this.emitterRadius,g=this.emitterRadius,v=this.emitterRadius);const y=Math.max(_[0],_[1]);$b.x=e-o-f-a-y,$b.y=t-o-g-a-y,$b.z=s-o-v-a-y,Qb.x=i+o+f+a+y,Qb.y=n+o+g+a+y,Qb.z=r+o+v+a+y,this.localBounds.setMinMax($b,Qb)}rebuild(){const e=this.graphicsDevice;if(null===this.colorMap&&(this.colorMap=this.defaultParamTexture),this.spawnBounds=0===this.emitterShape?this.emitterExtents:this.emitterRadius,this.useCpu=this.useCpu||this.sort>0||e.maxVertexTextures<=1||e.fragmentUniformsCount<64||e.forceCpuParticles||!e.extTextureFloat,this._destroyResources(),this.pack8=(this.pack8||!e.textureFloatRenderable)&&!this.useCpu,Kb=this.useCpu||this.pack8?4:2,this.useMesh=!1,this.mesh){this.numParticles*this.mesh.vertexBuffer.numVertices>65535||(this.useMesh=!0)}this.numParticlesPot=Wd.nextPowerOfTwo(this.numParticles),this.rebuildGraphs(),this.calculateLocalBounds(),this.resetWorldBounds(),this.node&&(this.worldBounds.setFromTransformedAabb(this.localBounds,this.localSpace?pu.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBounds),this.worldBoundsTrail[1].copy(this.worldBounds),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.pack8&&this.calculateBoundsMad()),this.vbToSort=new Array(this.numParticles);for(let e=0;e<this.numParticles;e++)this.vbToSort[e]=[0,0];this.particleDistance=new Float32Array(this.numParticles),this._gpuUpdater.randomize(),this.particleTex=new Float32Array(this.numParticlesPot*Kb*4);const t=null===this.node||this.localSpace?nu.ZERO:this.node.getPosition();0===this.emitterShape&&(null===this.node||this.localSpace?Yb.setTRS(nu.ZERO,_u.IDENTITY,this.spawnBounds):Yb.setTRS(nu.ZERO,this.node.getRotation(),Zb.copy(this.spawnBounds).mul(this.node.localScale)),Xb[0]=0!==this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,Xb[1]=0!==this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,Xb[2]=0!==this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0);for(let e=0;e<this.numParticles;e++)this._cpuUpdater.calcSpawnPosition(this.particleTex,Yb,Xb,t,e),this.useCpu&&(this.particleTex[4*e+3+2*this.numParticlesPot*4]=1);this.particleTexStart=new Float32Array(this.numParticlesPot*Kb*4);for(let e=0;e<this.particleTexStart.length;e++)this.particleTexStart[e]=this.particleTex[e];this.useCpu||(this.pack8?(this.particleTexIN=Ub(e,this.numParticlesPot,Kb,this.particleTex,7,1,!1),this.particleTexOUT=Ub(e,this.numParticlesPot,Kb,this.particleTex,7,1,!1),this.particleTexStart=Ub(e,this.numParticlesPot,Kb,this.particleTexStart,7,1,!1)):(this.particleTexIN=Ub(e,this.numParticlesPot,Kb,this.particleTex),this.particleTexOUT=Ub(e,this.numParticlesPot,Kb,this.particleTex),this.particleTexStart=Ub(e,this.numParticlesPot,Kb,this.particleTexStart)),this.rtParticleTexIN=new qp({colorBuffer:this.particleTexIN,depth:!1}),this.rtParticleTexOUT=new qp({colorBuffer:this.particleTexOUT,depth:!1}),this.swapTex=!1);const s=(this.localSpace?"#define LOCAL_SPACE\n":"")+tf.particleUpdaterInitPS+(this.pack8?tf.particleInputRgba8PS+tf.particleOutputRgba8PS:tf.particleInputFloatPS+tf.particleOutputFloatPS)+(0===this.emitterShape?tf.particleUpdaterAABBPS:tf.particleUpdaterSpherePS)+tf.particleUpdaterStartPS,i=s+tf.particleUpdaterRespawnPS+tf.particleUpdaterEndPS,n=s+tf.particleUpdaterNoRespawnPS+tf.particleUpdaterEndPS,r=s+tf.particleUpdaterOnStopPS+tf.particleUpdaterEndPS,a=this.emitterShape+""+this.pack8+this.localSpace;this.shaderParticleUpdateRespawn=of(e,tf.fullscreenQuadVS,i,"fsQuad0"+a),this.shaderParticleUpdateNoRespawn=of(e,tf.fullscreenQuadVS,n,"fsQuad1"+a),this.shaderParticleUpdateOnStop=of(e,tf.fullscreenQuadVS,r,"fsQuad2"+a),this.numParticleVerts=this.useMesh?this.mesh.vertexBuffer.numVertices:4,this.numParticleIndices=this.useMesh?this.mesh.indexBuffer[0].numIndices:6,this._allocate(this.numParticles);const o=new G_(e);o.vertexBuffer=this.vertexBuffer,o.indexBuffer[0]=this.indexBuffer,o.primitive[0].type=4,o.primitive[0].base=0,o.primitive[0].count=this.numParticles*this.numParticleIndices,o.primitive[0].indexed=!0,this.material=new Tf,this.material.name=this.node.name,this.material.cull=0,this.material.alphaWrite=!1,this.material.blendType=this.blendType,this.material.depthWrite=this.depthWrite,this.material.emitter=this,this.regenShader(),this.resetMaterial();const l=!this.meshInstance||this.meshInstance.visible;this.meshInstance=new ig(o,this.material,this.node),this.meshInstance.pick=!1,this.meshInstance.updateKey(),this.meshInstance.cull=!0,this.localSpace?this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,this.node.getWorldTransform()):this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance._updateAabb=!1,this.meshInstance.visible=l,this._initializeTextures(),this.resetTime(),this.addTime(0,!1),this.preWarm&&this.prewarm(this.lifetime)}_isAnimated(){return this.animNumFrames>=1&&(this.animTilesX>1||this.animTilesY>1)&&(this.colorMap&&this.colorMap!==this.defaultParamTexture||this.normalMap)}rebuildGraphs(){const e=this.precision,t=this.graphicsDevice;this.qLocalVelocity=this.localVelocityGraph.quantize(e),this.qVelocity=this.velocityGraph.quantize(e),this.qColor=this.colorGraph.quantizeClamped(e,0,1),this.qRotSpeed=this.rotationSpeedGraph.quantize(e),this.qScale=this.scaleGraph.quantize(e),this.qAlpha=this.alphaGraph.quantize(e),this.qRadialSpeed=this.radialSpeedGraph.quantize(e),this.qLocalVelocity2=this.localVelocityGraph2.quantize(e),this.qVelocity2=this.velocityGraph2.quantize(e),this.qColor2=this.colorGraph2.quantizeClamped(e,0,1),this.qRotSpeed2=this.rotationSpeedGraph2.quantize(e),this.qScale2=this.scaleGraph2.quantize(e),this.qAlpha2=this.alphaGraph2.quantize(e),this.qRadialSpeed2=this.radialSpeedGraph2.quantize(e);for(let t=0;t<e;t++)this.qRotSpeed[t]*=Wd.DEG_TO_RAD,this.qRotSpeed2[t]*=Wd.DEG_TO_RAD;if(this.localVelocityUMax=new Float32Array(3),this.velocityUMax=new Float32Array(3),this.colorUMax=new Float32Array(3),this.rotSpeedUMax=[0],this.scaleUMax=[0],this.alphaUMax=[0],this.radialSpeedUMax=[0],this.qLocalVelocityDiv=rx(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax),this.qVelocityDiv=rx(this.qVelocity,this.qVelocity2,this.velocityUMax),this.qColorDiv=rx(this.qColor,this.qColor2,this.colorUMax),this.qRotSpeedDiv=rx(this.qRotSpeed,this.qRotSpeed2,this.rotSpeedUMax),this.qScaleDiv=rx(this.qScale,this.qScale2,this.scaleUMax),this.qAlphaDiv=rx(this.qAlpha,this.qAlpha2,this.alphaUMax),this.qRadialSpeedDiv=rx(this.qRadialSpeed,this.qRadialSpeed2,this.radialSpeedUMax),this.pack8){const e=[0,0,0];nx(this.qVelocity,e);const t=[0,0,0];nx(this.qVelocity2,t);const s=[0,0,0];nx(this.qLocalVelocity,s);const i=[0,0,0];nx(this.qLocalVelocity2,i);const n=[0];nx(this.qRadialSpeed,n);const r=[0];nx(this.qRadialSpeed2,r);let a=Math.max(e[0],t[0]);a=Math.max(a,e[1]),a=Math.max(a,t[1]),a=Math.max(a,e[2]),a=Math.max(a,t[2]);let o=Math.max(s[0],i[0]);o=Math.max(o,s[1]),o=Math.max(o,i[1]),o=Math.max(o,s[2]),o=Math.max(o,i[2]);const l=Math.max(n[0],r[0]);this.maxVel=a+o+l}this.useCpu||(this.internalTex0=Ub(t,e,1,ix(this.qLocalVelocity,this.qLocalVelocityDiv)),this.internalTex1=Ub(t,e,1,ix(this.qVelocity,this.qVelocityDiv)),this.internalTex2=Ub(t,e,1,function(e,t,s,i,n){const r=new Array(4*e.length);for(let a=0;a<e.length;a++)r[4*a]=e[a],r[4*a+1]=t[a],r[4*a+2]=0,r[4*a+3]=sx(s[a],i[a],n[a]);return r}(this.qRotSpeed,this.qScale,this.qScaleDiv,this.qRotSpeedDiv,this.qAlphaDiv)),this.internalTex3=Ub(t,e,1,function(e,t){const s=new Array(4*e.length);for(let i=0;i<e.length;i++)s[4*i]=e[i],s[4*i+1]=t[i],s[4*i+2]=0,s[4*i+3]=0;return s}(this.qRadialSpeed,this.qRadialSpeedDiv))),this.colorParam=Ub(t,e,1,function(e,t){const s=new Array(4*t.length);for(let i=0;i<t.length;i++)s[4*i]=e[3*i],s[4*i+1]=e[3*i+1],s[4*i+2]=e[3*i+2],s[4*i+3]=t[i];return s}(this.qColor,this.qAlpha),7,1,!0)}_initializeTextures(){this.colorMap&&(this.material.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&this.material.setParameter("normalMap",this.normalMap))}regenShader(){const e=nf(this.graphicsDevice);e.register("particle",pb);const t=null!==this.normalMap;this.normalOption=0,this.lighting&&(this.normalOption=t?2:1),this.material.getShaderVariant=function(t,s,i,n,r,a,o,l){this.emitter.scene&&this.emitter.camera!==this.emitter.scene._activeCamera&&(this.emitter.camera=this.emitter.scene._activeCamera,this.emitter.onChangeCamera());const h=this.emitter.inTools,c=new Rm(o,l);return e.getProgram("particle",{pass:0,useCpu:this.emitter.useCpu,normal:this.emitter.normalOption,halflambert:this.emitter.halfLambert,stretch:this.emitter.stretch,alignToMotion:this.emitter.alignToMotion,soft:this.emitter.depthSoftening,mesh:this.emitter.useMesh,gamma:this.emitter.scene?this.emitter.scene.gammaCorrection:0,toneMap:this.emitter.scene?this.emitter.scene.toneMapping:0,fog:this.emitter.scene&&!this.emitter.noFog?this.emitter.scene.fog:"none",wrap:this.emitter.wrap&&this.emitter.wrapBounds,localSpace:this.emitter.localSpace,screenSpace:!h&&this.emitter.screenSpace,blend:this.blendType,animTex:this.emitter._isAnimated(),animTexLoop:this.emitter.animLoop,pack8:this.emitter.pack8,customFace:0!==this.emitter.orientation},c)},this.material.shader=this.material.getShaderVariant()}resetMaterial(){const e=this.material;e.setParameter("stretch",this.stretch),this._isAnimated()&&(e.setParameter("animTexTilesParams",this.animTilesParams),e.setParameter("animTexParams",this.animParams),e.setParameter("animTexIndexParams",this.animIndexParams)),e.setParameter("colorMult",this.intensity),this.useCpu||(e.setParameter("internalTex0",this.internalTex0),e.setParameter("internalTex1",this.internalTex1),e.setParameter("internalTex2",this.internalTex2),e.setParameter("internalTex3",this.internalTex3)),e.setParameter("colorParam",this.colorParam),e.setParameter("numParticles",this.numParticles),e.setParameter("numParticlesPot",this.numParticlesPot),e.setParameter("lifetime",this.lifetime),e.setParameter("rate",this.rate),e.setParameter("rateDiv",this.rate2-this.rate),e.setParameter("seed",this.seed),e.setParameter("scaleDivMult",this.scaleUMax[0]),e.setParameter("alphaDivMult",this.alphaUMax[0]),e.setParameter("radialSpeedDivMult",this.radialSpeedUMax[0]),e.setParameter("graphNumSamples",this.precision),e.setParameter("graphSampleSize",1/this.precision),e.setParameter("emitterScale",new Float32Array([1,1,1])),this.pack8&&(this._gpuUpdater._setInputBounds(),e.setParameter("inBoundsSize",this._gpuUpdater.inBoundsSizeUniform),e.setParameter("inBoundsCenter",this._gpuUpdater.inBoundsCenterUniform),e.setParameter("maxVel",this.maxVel)),this.wrap&&this.wrapBounds&&(this.wrapBoundsUniform[0]=this.wrapBounds.x,this.wrapBoundsUniform[1]=this.wrapBounds.y,this.wrapBoundsUniform[2]=this.wrapBounds.z,e.setParameter("wrapBounds",this.wrapBoundsUniform)),this.colorMap&&e.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&e.setParameter("normalMap",this.normalMap),this.depthSoftening>0&&e.setParameter("softening",1/(this.depthSoftening*this.depthSoftening*100)),this.stretch>0&&(e.cull=0),this._compParticleFaceParams()}_compParticleFaceParams(){let e,t;if(0===this.orientation)e=new Float32Array([1,0,0]),t=new Float32Array([0,0,1]);else{let s;if(1===this.orientation)s=this.particleNormal.normalize();else{s=(null===this.node?pu.IDENTITY:this.node.getWorldTransform()).transformVector(this.particleNormal).normalize()}const i=new nu(1,0,0);1===Math.abs(i.dot(s))&&i.set(0,0,1);const n=(new nu).cross(s,i).normalize();i.cross(n,s).normalize(),e=new Float32Array([i.x,i.y,i.z]),t=new Float32Array([n.x,n.y,n.z])}this.material.setParameter("faceTangent",e),this.material.setParameter("faceBinorm",t)}_allocate(e){const t=e*this.numParticleVerts,s=e*this.numParticleIndices;if(void 0===this.vertexBuffer||this.vertexBuffer.getNumVertices()!==t){if(this.useCpu){const e=[{semantic:Gu,components:4,type:6},{semantic:ju,components:4,type:6},{semantic:"ATTR2",components:4,type:6},{semantic:"ATTR3",components:1,type:6},{semantic:"ATTR4",components:this.useMesh?4:2,type:6}],i=new Bp(this.graphicsDevice,e);this.vertexBuffer=new Rp(this.graphicsDevice,i,t,1),this.indexBuffer=new Lm(this.graphicsDevice,1,s)}else{const e=[{semantic:Gu,components:4,type:6}];this.useMesh&&e.push({semantic:ju,components:2,type:6});const i=new Bp(this.graphicsDevice,e);this.vertexBuffer=new Rp(this.graphicsDevice,i,t,1),this.indexBuffer=new Lm(this.graphicsDevice,1,s)}const i=new Float32Array(this.vertexBuffer.lock());let n,r,a;if(this.useMesh){n=new Float32Array(this.mesh.vertexBuffer.lock()),r=n.length/this.mesh.vertexBuffer.numVertices;for(let e=0;e<this.mesh.vertexBuffer.format.elements.length;e++)if(this.mesh.vertexBuffer.format.elements[e].name===Hu){a=this.mesh.vertexBuffer.format.elements[e].offset/4;break}}for(let e=0;e<t;e++){const t=Math.floor(e/this.numParticleVerts);if(this.useMesh){const s=e%this.numParticleVerts;i[6*e]=n[s*r],i[6*e+1]=n[s*r+1],i[6*e+2]=n[s*r+2],i[6*e+3]=t,i[6*e+4]=n[s*r+a+0],i[6*e+5]=1-n[s*r+a+1]}else{const s=e%4;i[4*e]=Bb[s][0],i[4*e+1]=Bb[s][1],i[4*e+2]=0,i[4*e+3]=t}}this.useCpu&&(this.vbCPU=new Float32Array(i),this.vbOld=new Float32Array(this.vbCPU.length)),this.vertexBuffer.unlock(),this.useMesh&&this.mesh.vertexBuffer.unlock();let o=0;const l=new Uint16Array(this.indexBuffer.lock());this.useMesh&&(n=new Uint16Array(this.mesh.indexBuffer[0].lock()));for(let t=0;t<e;t++)if(this.useMesh)for(let e=0;e<this.numParticleIndices;e++)l[t*this.numParticleIndices+e]=n[e]+t*this.numParticleVerts;else{const e=4*t;l[o++]=e,l[o++]=e+1,l[o++]=e+2,l[o++]=e,l[o++]=e+2,l[o++]=e+3}this.indexBuffer.unlock(),this.useMesh&&this.mesh.indexBuffer[0].unlock()}}reset(){if(this.beenReset=!0,this.seed=Math.random(),this.material.setParameter("seed",this.seed),this.useCpu)for(let e=0;e<this.particleTexStart.length;e++)this.particleTex[e]=this.particleTexStart[e];else this._initializeTextures();this.resetWorldBounds(),this.resetTime();const e=this.loop;this.loop=!0,this.addTime(0,!1),this.loop=e,this.preWarm&&this.prewarm(this.lifetime)}prewarm(e){const t=e/this.lifetime,s=Math.min(Math.floor(t*this.precision),this.precision),i=e/s;for(let e=0;e<s;e++)this.addTime(i,!1)}resetTime(){this.endTime=function(e){const t=Math.max(e.rate,e.rate2)*e.numParticles+e.lifetime;return Date.now()+1e3*t}(this)}finishFrame(){this.useCpu&&this.vertexBuffer.unlock()}addTime(e,t){const s=this.graphicsDevice;if(this.simTimeTotal+=e,this.calculateWorldBounds(),this._isAnimated()){const e=this.animTilesParams;e[0]=1/this.animTilesX,e[1]=1/this.animTilesY;const t=this.animParams;t[0]=this.animStartFrame,t[1]=this.animNumFrames*this.animSpeed,t[2]=this.animNumFrames-1,t[3]=this.animNumAnimations-1;const s=this.animIndexParams;s[0]=this.animIndex,s[1]=this.randomizeAnimIndex}let i;this.scene&&this.camera!==this.scene._activeCamera&&(this.camera=this.scene._activeCamera,this.onChangeCamera()),0===this.emitterShape&&(Xb[0]=0!==this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,Xb[1]=0!==this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,Xb[2]=0!==this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0,null===this.meshInstance.node?Yb.setTRS(nu.ZERO,_u.IDENTITY,this.emitterExtents):Yb.setTRS(nu.ZERO,this.meshInstance.node.getRotation(),Zb.copy(this.emitterExtents).mul(this.meshInstance.node.localScale)));const n=null===this.meshInstance.node?nu.ONE:this.meshInstance.node.localScale;if(this.emitterScaleUniform[0]=n.x,this.emitterScaleUniform[1]=n.y,this.emitterScaleUniform[2]=n.z,this.material.setParameter("emitterScale",this.emitterScaleUniform),this.localSpace&&this.meshInstance.node&&(i=this.meshInstance.node.getPosition(),this.emitterPosUniform[0]=i.x,this.emitterPosUniform[1]=i.y,this.emitterPosUniform[2]=i.z,this.material.setParameter("emitterPos",this.emitterPosUniform)),this._compParticleFaceParams(),this.useCpu){const s=new Float32Array(this.vertexBuffer.lock());this._cpuUpdater.update(s,this.vbToSort,this.particleTex,Yb,Xb,i,e,t)}else this._gpuUpdater.update(s,Yb,Xb,e,t);this.loop||Date.now()>this.endTime&&(this.onFinished&&this.onFinished(),this.meshInstance.visible=!1),this.meshInstance&&(this.meshInstance.drawOrder=this.drawOrder)}_destroyResources(){this.particleTexIN&&(this.particleTexIN.destroy(),this.particleTexIN=null),this.particleTexOUT&&(this.particleTexOUT.destroy(),this.particleTexOUT=null),this.particleTexStart&&this.particleTexStart.destroy&&(this.particleTexStart.destroy(),this.particleTexStart=null),this.rtParticleTexIN&&(this.rtParticleTexIN.destroy(),this.rtParticleTexIN=null),this.rtParticleTexOUT&&(this.rtParticleTexOUT.destroy(),this.rtParticleTexOUT=null),this.internalTex0&&(this.internalTex0.destroy(),this.internalTex0=null),this.internalTex1&&(this.internalTex1.destroy(),this.internalTex1=null),this.internalTex2&&(this.internalTex2.destroy(),this.internalTex2=null),this.internalTex3&&(this.internalTex3.destroy(),this.internalTex3=null),this.colorParam&&(this.colorParam.destroy(),this.colorParam=null),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=void 0),this.indexBuffer&&(this.indexBuffer.destroy(),this.indexBuffer=void 0),this.material&&(this.material.destroy(),this.material=null)}destroy(){this.camera=null,this._destroyResources()}}const lx=new class extends af{generateKey(e){return`skybox-${e.type}-${e.encoding}-${e.useIntensity}-${e.gamma}-${e.toneMapping}-${e.skymesh}`+("cubemap"===e.type?`-${e.fixSeams}-${e.mip}`:"")}createShaderDefinition(e,t){const s=t.skymesh===F_?"":"#define SKYMESH\n",i=s+tf.skyboxVS;let n=s;if("cubemap"===t.type){const e=[128,64,16,8,4,2];n+=t.mip?tf.fixCubemapSeamsStretchPS:tf.fixCubemapSeamsNonePS,n+=t.useIntensity?tf.envMultiplyPS:tf.envConstPS,n+=tf.decodePS,n+=af.gammaCode(t.gamma),n+=af.tonemapCode(t.toneMapping),n+=tf.skyboxHDRPS.replace(/\$DECODE/g,Cg.decodeFunc(t.encoding)).replace(/\$FIXCONST/g,1-1/e[t.mip]+"")}else n+=t.useIntensity?tf.envMultiplyPS:tf.envConstPS,n+=tf.decodePS,n+=af.gammaCode(t.gamma),n+=af.tonemapCode(t.toneMapping),n+=tf.sphericalPS,n+=tf.envAtlasPS,n+=tf.skyboxEnvPS.replace(/\$DECODE/g,Cg.decodeFunc(t.encoding));return Pm.createDefinition(e,{name:"SkyboxShader",attributes:{aPosition:Ou},vertexCode:i,fragmentCode:n})}};class hx{static create(e,t){switch(t){case"box":return hx.box(e);case"dome":return hx.dome(e)}return hx.infinite(e)}static infinite(e){return $_(e)}static box(e){return $_(e,{yOffset:.5})}static dome(e){const t=[],s=[];for(let e=0;e<=50;e++){const s=e*Math.PI/50,i=Math.sin(s),n=Math.cos(s);for(let e=0;e<=50;e++){const s=2*e*Math.PI/50-Math.PI/2,r=Math.sin(s),a=Math.cos(s)*i;let o=n;const l=r*i;o<0&&(o*=.3,a*a+l*l<.9025&&(o=-.1)),o+=.1,t.push(.5*a,.5*o,.5*l)}}for(let e=0;e<50;++e)for(let t=0;t<50;++t){const i=51*e+t,n=i+50+1;s.push(i+1,n,i),s.push(i+1,n+1,n)}return Y_(e,t,{indices:s})}}class cx{constructor(e,t,s,i,n){this.meshInstance=null;const r=new Tf;r.getShaderVariant=function(s,r,a,o,l,h,c,d){const u={pass:l,encoding:i.encoding,useIntensity:1!==t.skyboxIntensity||t.physicalUnits,gamma:1===l?t.gammaCorrection?3:0:t.gammaCorrection,toneMapping:1===l?0:t.toneMapping,skymesh:n};i.cubemap?(u.type="cubemap",u.mip=i.fixCubemapSeams?t.skyboxMip:0,u.fixSeams=i.fixCubemapSeams):u.type="envAtlas";const p=new Rm(c,d),m=nf(e);return m.register("skybox",lx),m.getProgram("skybox",u,p)},i.cubemap?r.setParameter("texture_cubeMap",i):(r.setParameter("texture_envAtlas",i),r.setParameter("mipLevel",t._skyboxMip)),r.cull=2,r.depthWrite=!1;const a=t.layers.getLayerById(2);if(a){const t=hx.create(e,n),i=new ig(t,r,s);this.meshInstance=i,i.cull=!1,i.pick=!1,a.addMeshInstances([i]),this.skyLayer=a}}destroy(){this.meshInstance&&(this.skyLayer&&this.skyLayer.removeMeshInstances([this.meshInstance]),this.meshInstance.destroy(),this.meshInstance=null)}}class dx{constructor(e){this._type=F_,this._center=new nu(0,1,0),this.skyMesh=null,this.node=new Kf("SkyMeshNode"),this.device=e.device,this.scene=e,this.center=new nu(0,1,0),this.centerArray=new Float32Array(3),this.projectedSkydomeCenterId=this.device.scope.resolve("projectedSkydomeCenter")}applySettings(e){var t,s,i,n;this.type=null!=(t=e.skyType)?t:F_,this.node.setLocalPosition(new nu(null!=(s=e.skyMeshPosition)?s:[0,0,0])),this.node.setLocalEulerAngles(new nu(null!=(i=e.skyMeshRotation)?i:[0,0,0])),this.node.setLocalScale(new nu(null!=(n=e.skyMeshScale)?n:[1,1,1])),e.skyCenter&&(this._center=new nu(e.skyCenter))}set type(e){this._type!==e&&(this._type=e,this.scene.updateShaders=!0,this.updateSkyMesh())}get type(){return this._type}set center(e){this._center.copy(e)}get center(){return this._center}updateSkyMesh(){const e=this.scene._getSkyboxTex();e&&(this.resetSkyMesh(),this.skyMesh=new cx(this.device,this.scene,this.node,e,this.type),this.scene.fire("set:skybox",e))}resetSkyMesh(){var e;null==(e=this.skyMesh)||e.destroy(),this.skyMesh=null}update(){if(this.type!==F_){const{center:e,centerArray:t}=this,s=new nu;this.node.getWorldTransform().transformPoint(e,s),t[0]=s.x,t[1]=s.y,t[2]=s.z,this.projectedSkydomeCenterId.setValue(t)}}}const ux=new Kf;ux.worldTransform=pu.IDENTITY,ux._dirtyWorld=ux._dirtyNormal=!1;class px{constructor(e,t,s){this.material=t,this.layer=s,this.positions=[],this.colors=[],this.mesh=new G_(e),this.meshInstance=null}addLines(e,t){const s=this.positions,i=e.length;for(let t=0;t<i;t++){const i=e[t];s.push(i.x,i.y,i.z)}const n=this.colors;if(t.length)for(let e=0;e<i;e++){const s=t[e];n.push(s.r,s.g,s.b,s.a)}else for(let e=0;e<i;e++)n.push(t.r,t.g,t.b,t.a)}addLinesArrays(e,t){const s=this.positions;for(let t=0;t<e.length;t+=3)s.push(e[t],e[t+1],e[t+2]);const i=this.colors;if(t.length)for(let e=0;e<t.length;e+=4)i.push(t[e],t[e+1],t[e+2],t[e+3]);else{const s=e.length/3;for(let e=0;e<s;e++)i.push(t.r,t.g,t.b,t.a)}}onPreRender(e,t){this.positions.length>0&&this.material.transparent===t&&(this.mesh.setPositions(this.positions),this.mesh.setColors(this.colors),this.mesh.update(1,!1),this.meshInstance||(this.meshInstance=new ig(this.mesh,this.material,ux)),this.positions.length=0,this.colors.length=0,e.push(this.meshInstance))}}class mx{constructor(e){this.device=e,this.map=new Map}getBatch(e,t){let s=this.map.get(e);return s||(s=new px(this.device,e,t),this.map.set(e,s)),s}onPreRender(e,t){this.map.forEach((s=>{s.onPreRender(e,t)}))}}const _x=[],fx=new nu;class gx{constructor(e){this.device=e,this.quadMesh=null,this.textureShader=null,this.depthTextureShader=null,this.cubeLocalPos=null,this.cubeWorldPos=null,this.batchesMap=new Map,this.allBatches=new Set,this.updatedLayers=new Set,this._materialDepth=null,this._materialNoDepth=null,this.layerMeshInstances=new Map}createMaterial(e){const t=new Af;return t.vertexColors=!0,t.blendType=2,t.depthTest=e,t.update(),t}get materialDepth(){return this._materialDepth||(this._materialDepth=this.createMaterial(!0)),this._materialDepth}get materialNoDepth(){return this._materialNoDepth||(this._materialNoDepth=this.createMaterial(!1)),this._materialNoDepth}getBatch(e,t){let s=this.batchesMap.get(e);s||(s=new mx(this.device),this.batchesMap.set(e,s)),this.allBatches.add(s);const i=t?this.materialDepth:this.materialNoDepth;return s.getBatch(i,e)}getShader(e,t){if(!this[e]){const s="\n\t\t\t\tattribute vec2 vertex_position;\n\t\t\t\tuniform mat4 matrix_model;\n\t\t\t\tvarying vec2 uv0;\n\t\t\t\tvoid main(void) {\n\t\t\t\t\tgl_Position = matrix_model * vec4(vertex_position, 0, 1);\n\t\t\t\t\tuv0 = vertex_position.xy + 0.5;\n\t\t\t\t}\n\t\t\t";this[e]=of(this.device,s,t,`DebugShader:${e}`)}return this[e]}getTextureShader(){return this.getShader("textureShader","\n\t\t\tvarying vec2 uv0;\n\t\t\tuniform sampler2D colorMap;\n\t\t\tvoid main (void) {\n\t\t\t\tgl_FragColor = vec4(texture2D(colorMap, uv0).xyz, 1);\n\t\t\t}\n\t\t")}getUnfilterableTextureShader(){return this.getShader("textureShaderUnfilterable","\n\t\t\tvarying vec2 uv0;\n\t\t\tuniform highp sampler2D colorMap;\n\t\t\tvoid main (void) {\n\t\t\t\tivec2 uv = ivec2(uv0 * textureSize(colorMap, 0));\n\t\t\t\tgl_FragColor = vec4(texelFetch(colorMap, uv, 0).xyz, 1);\n\t\t\t}\n\t\t")}getDepthTextureShader(){return this.getShader("depthTextureShader",`\n\t\t\t${tf.screenDepthPS}\n\t\t\tvarying vec2 uv0;\n\t\t\tvoid main() {\n\t\t\t\tfloat depth = getLinearScreenDepth(getImageEffectUV(uv0)) * camera_params.x;\n\t\t\t\tgl_FragColor = vec4(vec3(depth), 1.0);\n\t\t\t}\n\t\t`)}getQuadMesh(){return this.quadMesh||(this.quadMesh=new G_(this.device),this.quadMesh.setPositions([-.5,-.5,0,.5,-.5,0,-.5,.5,0,.5,.5,0]),this.quadMesh.update(5)),this.quadMesh}drawMesh(e,t,s,i,n){if(!i){const n=this.getGraphNode(t);i=new ig(s,e,n)}let r=this.layerMeshInstances.get(n);r||(r=[],this.layerMeshInstances.set(n,r)),r.push(i)}drawWireAlignedBox(e,t,s,i,n,r){if(r){const s=(e,t,s)=>{fx.set(e,t,s),r.transformPoint(fx,fx),_x.push(fx.x,fx.y,fx.z)};s(e.x,e.y,e.z),s(e.x,t.y,e.z),s(e.x,t.y,e.z),s(t.x,t.y,e.z),s(t.x,t.y,e.z),s(t.x,e.y,e.z),s(t.x,e.y,e.z),s(e.x,e.y,e.z),s(e.x,e.y,t.z),s(e.x,t.y,t.z),s(e.x,t.y,t.z),s(t.x,t.y,t.z),s(t.x,t.y,t.z),s(t.x,e.y,t.z),s(t.x,e.y,t.z),s(e.x,e.y,t.z),s(e.x,e.y,e.z),s(e.x,e.y,t.z),s(e.x,t.y,e.z),s(e.x,t.y,t.z),s(t.x,t.y,e.z),s(t.x,t.y,t.z),s(t.x,e.y,e.z),s(t.x,e.y,t.z)}else _x.push(e.x,e.y,e.z,e.x,t.y,e.z,e.x,t.y,e.z,t.x,t.y,e.z,t.x,t.y,e.z,t.x,e.y,e.z,t.x,e.y,e.z,e.x,e.y,e.z,e.x,e.y,t.z,e.x,t.y,t.z,e.x,t.y,t.z,t.x,t.y,t.z,t.x,t.y,t.z,t.x,e.y,t.z,t.x,e.y,t.z,e.x,e.y,t.z,e.x,e.y,e.z,e.x,e.y,t.z,e.x,t.y,e.z,e.x,t.y,t.z,t.x,t.y,e.z,t.x,t.y,t.z,t.x,e.y,e.z,t.x,e.y,t.z);this.getBatch(n,i).addLinesArrays(_x,s),_x.length=0}drawWireSphere(e,t,s,i,n,r){const a=2*Math.PI/i;let o=0;for(let s=0;s<i;s++){const s=Math.sin(o),i=Math.cos(o);o+=a;const n=Math.sin(o),r=Math.cos(o);_x.push(e.x+t*s,e.y,e.z+t*i),_x.push(e.x+t*n,e.y,e.z+t*r),_x.push(e.x+t*s,e.y+t*i,e.z),_x.push(e.x+t*n,e.y+t*r,e.z),_x.push(e.x,e.y+t*s,e.z+t*i),_x.push(e.x,e.y+t*n,e.z+t*r)}this.getBatch(r,n).addLinesArrays(_x,s),_x.length=0}getGraphNode(e){const t=new Kf("ImmediateDebug");return t.worldTransform=e,t._dirtyWorld=t._dirtyNormal=!1,t}onPreRenderLayer(e,t,s){if(this.batchesMap.forEach(((i,n)=>{n===e&&i.onPreRender(t,s)})),!this.updatedLayers.has(e)){this.updatedLayers.add(e);const s=this.layerMeshInstances.get(e);if(s){for(let e=0;e<s.length;e++)t.push(s[e]);s.length=0}}}onPostRender(){this.allBatches.clear(),this.updatedLayers.clear()}}class vx extends od{constructor(e){super(),this.ambientBake=!1,this.ambientBakeOcclusionBrightness=0,this.ambientBakeOcclusionContrast=0,this.ambientLight=new jd(0,0,0),this.ambientLuminance=0,this.exposure=1,this.fogColor=new jd(0,0,0),this.fogDensity=0,this.fogEnd=1e3,this.fogStart=1,this.lightmapSizeMultiplier=1,this.lightmapMaxResolution=2048,this.lightmapMode=1,this.lightmapFilterEnabled=!1,this.lightmapHDR=!1,this.root=null,this.physicalUnits=!1,this._envAtlas=null,this._skyboxCubeMap=null,this.device=e,this._gravity=new nu(0,-9.8,0),this._layers=null,this._fog=D_,this._gammaCorrection=1,this._toneMapping=0,this._prefilteredCubemaps=[],this._internalEnvAtlas=null,this._skyboxIntensity=1,this._skyboxLuminance=0,this._skyboxMip=0,this._skyboxRotationShaderInclude=!1,this._skyboxRotation=new _u,this._skyboxRotationMat3=new ru,this._skyboxRotationMat4=new pu,this._ambientBakeNumSamples=1,this._ambientBakeSpherePart=.4,this._lightmapFilterRange=10,this._lightmapFilterSmoothness=.2,this._clusteredLightingEnabled=!0,this._lightingParams=new hb(this.device.supportsAreaLights,this.device.maxTextureSize,(()=>{this.updateShaders=!0})),this._sky=new dx(this),this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,updateShadersTime:0},this.updateShaders=!0,this._shaderVersion=0,this.immediate=new gx(this.device)}get defaultDrawLayer(){return this.layers.getLayerById(3)}set ambientBakeNumSamples(e){this._ambientBakeNumSamples=Wd.clamp(Math.floor(e),1,255)}get ambientBakeNumSamples(){return this._ambientBakeNumSamples}set ambientBakeSpherePart(e){this._ambientBakeSpherePart=Wd.clamp(e,.001,1)}get ambientBakeSpherePart(){return this._ambientBakeSpherePart}set clusteredLightingEnabled(e){this.device.isWebGPU&&!e||(this._clusteredLightingEnabled||!e?this._clusteredLightingEnabled=e:console.error("Turning on disabled clustered lighting is not currently supported"))}get clusteredLightingEnabled(){return this._clusteredLightingEnabled}set envAtlas(e){e!==this._envAtlas&&(this._envAtlas=e,e&&(e.addressU=1,e.addressV=1,e.minFilter=1,e.magFilter=1,e.mipmaps=!1),this._prefilteredCubemaps=[],this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._resetSkyMesh())}get envAtlas(){return this._envAtlas}set fog(e){e!==this._fog&&(this._fog=e,this.updateShaders=!0)}get fog(){return this._fog}set gammaCorrection(e){e!==this._gammaCorrection&&(this._gammaCorrection=e,this.updateShaders=!0)}get gammaCorrection(){return this._gammaCorrection}set layers(e){const t=this._layers;this._layers=e,this.fire("set:layers",t,e)}get layers(){return this._layers}get sky(){return this._sky}get lighting(){return this._lightingParams}set lightmapFilterRange(e){this._lightmapFilterRange=Math.max(e,.001)}get lightmapFilterRange(){return this._lightmapFilterRange}set lightmapFilterSmoothness(e){this._lightmapFilterSmoothness=Math.max(e,.001)}get lightmapFilterSmoothness(){return this._lightmapFilterSmoothness}set prefilteredCubemaps(e){e=e||[];const t=this._prefilteredCubemaps,s=t.length!==e.length||t.some(((t,s)=>t!==e[s]));if(s){const t=6===e.length&&e.every((e=>!!e));t?(this._internalEnvAtlas=pv.generatePrefilteredAtlas(e,{target:this._internalEnvAtlas}),this._envAtlas=this._internalEnvAtlas):(this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._envAtlas=null),this._prefilteredCubemaps=e.slice(),this._resetSkyMesh()}}get prefilteredCubemaps(){return this._prefilteredCubemaps}set skybox(e){e!==this._skyboxCubeMap&&(this._skyboxCubeMap=e,this._resetSkyMesh())}get skybox(){return this._skyboxCubeMap}set skyboxIntensity(e){e!==this._skyboxIntensity&&(this._skyboxIntensity=e,this._resetSkyMesh())}get skyboxIntensity(){return this._skyboxIntensity}set skyboxLuminance(e){e!==this._skyboxLuminance&&(this._skyboxLuminance=e,this._resetSkyMesh())}get skyboxLuminance(){return this._skyboxLuminance}set skyboxMip(e){e!==this._skyboxMip&&(this._skyboxMip=e,this._resetSkyMesh())}get skyboxMip(){return this._skyboxMip}set skyboxRotation(e){if(!this._skyboxRotation.equals(e)){const t=e.equals(_u.IDENTITY);this._skyboxRotation.copy(e),t?this._skyboxRotationMat3.setIdentity():(this._skyboxRotationMat4.setTRS(nu.ZERO,e,nu.ONE),this._skyboxRotationMat3.invertMat4(this._skyboxRotationMat4)),this._skyboxRotationShaderInclude||t||(this._skyboxRotationShaderInclude=!0,this._resetSkyMesh())}}get skyboxRotation(){return this._skyboxRotation}set toneMapping(e){e!==this._toneMapping&&(this._toneMapping=e,this.updateShaders=!0)}get toneMapping(){return this._toneMapping}destroy(){this._resetSkyMesh(),this.root=null,this.off()}drawLine(e,t,s=jd.WHITE,i=!0,n=this.defaultDrawLayer){this.immediate.getBatch(n,i).addLines([e,t],[s,s])}drawLines(e,t,s=!0,i=this.defaultDrawLayer){this.immediate.getBatch(i,s).addLines(e,t)}drawLineArrays(e,t,s=!0,i=this.defaultDrawLayer){this.immediate.getBatch(i,s).addLinesArrays(e,t)}applySettings(e){var t,s,i,n;const r=e.physics,a=e.render;this._gravity.set(r.gravity[0],r.gravity[1],r.gravity[2]),this.ambientLight.set(a.global_ambient[0],a.global_ambient[1],a.global_ambient[2]),this.ambientLuminance=a.ambientLuminance,this._fog=a.fog,this.fogColor.set(a.fog_color[0],a.fog_color[1],a.fog_color[2]),this.fogStart=a.fog_start,this.fogEnd=a.fog_end,this.fogDensity=a.fog_density,this._gammaCorrection=a.gamma_correction,this._toneMapping=a.tonemapping,this.lightmapSizeMultiplier=a.lightmapSizeMultiplier,this.lightmapMaxResolution=a.lightmapMaxResolution,this.lightmapMode=a.lightmapMode,this.exposure=a.exposure,this._skyboxIntensity=null!=(t=a.skyboxIntensity)?t:1,this._skyboxLuminance=null!=(s=a.skyboxLuminance)?s:2e4,this._skyboxMip=null!=(i=a.skyboxMip)?i:0,a.skyboxRotation&&(this.skyboxRotation=(new _u).setFromEulerAngles(a.skyboxRotation[0],a.skyboxRotation[1],a.skyboxRotation[2])),this.sky.applySettings(a),this.clusteredLightingEnabled=null!=(n=a.clusteredLightingEnabled)&&n,this.lighting.applySettings(a),["lightmapFilterEnabled","lightmapFilterRange","lightmapFilterSmoothness","ambientBake","ambientBakeNumSamples","ambientBakeSpherePart","ambientBakeOcclusionBrightness","ambientBakeOcclusionContrast"].forEach((e=>{a.hasOwnProperty(e)&&(this[e]=a[e])})),this._resetSkyMesh()}_getSkyboxTex(){const e=this._prefilteredCubemaps;if(this._skyboxMip){return e[[0,1,3,4,5,6][this._skyboxMip]]||this._envAtlas||e[0]||this._skyboxCubeMap}return this._skyboxCubeMap||e[0]||this._envAtlas}_updateSkyMesh(){this.sky.skyMesh||this.sky.updateSkyMesh(),this.sky.update()}_resetSkyMesh(){this.sky.resetSkyMesh(),this.updateShaders=!0}setSkybox(e){e?(this.skybox=e[0]||null,e[1]&&!e[1].cubemap?this.envAtlas=e[1]:this.prefilteredCubemaps=e.slice(1)):(this.skybox=null,this.envAtlas=null)}get lightmapPixelFormat(){return this.lightmapHDR&&this.device.getRenderableHdrFormat()||7}}vx.EVENT_SETLAYERS="set:layers",vx.EVENT_SETSKYBOX="set:skybox";class yx{constructor(){this._written=!1,this._name="",this._keyFrames=[],this._quat=new _u,this._pos=new nu,this._scale=new nu,this._targetNode=null}getTarget(){return this._targetNode}setTarget(e){this._targetNode=e}}class bx{constructor(e){this.looping=!0,this._animation=null,this._time=0,this._interpolatedKeys=[],this._interpolatedKeyDict={},this._currKeyIndices={},this.graph=null;const t=e=>{const s=new yx;s._name=e.name,this._interpolatedKeys.push(s),this._interpolatedKeyDict[e.name]=s,this._currKeyIndices[e.name]=0;for(let s=0;s<e._children.length;s++)t(e._children[s])};t(e)}set animation(e){this._animation=e,this.currentTime=0}get animation(){return this._animation}set currentTime(e){this._time=e;const t=this._interpolatedKeys.length;for(let e=0;e<t;e++){const t=this._interpolatedKeys[e]._name;this._currKeyIndices[t]=0}this.addTime(0),this.updateGraph()}get currentTime(){return this._time}get numNodes(){return this._interpolatedKeys.length}addTime(e){if(null!==this._animation){const t=this._animation._nodes,s=this._animation.duration;if(this._time===s&&!this.looping)return;if(this._time+=e,this._time>s){this._time=this.looping?0:s;for(let e=0;e<t.length;e++){const s=t[e]._name;this._currKeyIndices[s]=0}}else if(this._time<0){this._time=this.looping?s:0;for(let e=0;e<t.length;e++){const s=t[e],i=s._name;this._currKeyIndices[i]=s._keys.length-2}}const i=e>=0?1:-1;for(let e=0;e<t.length;e++){const s=t[e],n=s._name,r=s._keys,a=this._interpolatedKeyDict[n];if(void 0===a)continue;let o=!1;if(1!==r.length)for(let e=this._currKeyIndices[n];e<r.length-1&&e>=0;e+=i){const t=r[e],s=r[e+1];if(t.time<=this._time&&s.time>=this._time){const i=(this._time-t.time)/(s.time-t.time);a._pos.lerp(t.position,s.position,i),a._quat.slerp(t.rotation,s.rotation,i),a._scale.lerp(t.scale,s.scale,i),a._written=!0,this._currKeyIndices[n]=e,o=!0;break}}(1===r.length||!o&&0===this._time&&this.looping)&&(a._pos.copy(r[0].position),a._quat.copy(r[0].rotation),a._scale.copy(r[0].scale),a._written=!0)}}}blend(e,t,s){const i=this._interpolatedKeys.length;for(let n=0;n<i;n++){const i=e._interpolatedKeys[n],r=t._interpolatedKeys[n],a=this._interpolatedKeys[n];i._written&&r._written?(a._quat.slerp(i._quat,t._interpolatedKeys[n]._quat,s),a._pos.lerp(i._pos,t._interpolatedKeys[n]._pos,s),a._scale.lerp(i._scale,r._scale,s),a._written=!0):i._written?(a._quat.copy(i._quat),a._pos.copy(i._pos),a._scale.copy(i._scale),a._written=!0):r._written&&(a._quat.copy(r._quat),a._pos.copy(r._pos),a._scale.copy(r._scale),a._written=!0)}}setGraph(e){if(this.graph=e,e)for(let t=0;t<this._interpolatedKeys.length;t++){const s=this._interpolatedKeys[t],i=e.findByName(s._name);this._interpolatedKeys[t].setTarget(i)}else for(let e=0;e<this._interpolatedKeys.length;e++)this._interpolatedKeys[e].setTarget(null)}updateGraph(){if(this.graph)for(let e=0;e<this._interpolatedKeys.length;e++){const t=this._interpolatedKeys[e];if(t._written){const e=t.getTarget();e.localPosition.copy(t._pos),e.localRotation.copy(t._quat),e.localScale.copy(t._scale),e._dirtyLocal||e._dirtifyLocal(),t._written=!1}}}}new ou;class xx extends Im{constructor(...e){super(...e),this._shader=null,this.quadRender=null,this.cullMode=0,this.blendState=Sp.NOBLEND,this.depthState=Ep.NODEPTH,this.stencilFront=null,this.stencilBack=null}set shader(e){var t,s;null==(t=this.quadRender)||t.destroy(),this.quadRender=null,null==(s=this._shader)||s.destroy(),this._shader=e,e&&(this.quadRender=new pf(e))}get shader(){return this._shader}createQuadShader(e,t,s={}){return of(this.device,xx.quadVertexShader,t,e,{aPosition:Ou},s)}destroy(){var e;null==(e=this.shader)||e.destroy(),this.shader=null}execute(){const e=this.device;e.setBlendState(this.blendState),e.setCullMode(this.cullMode),e.setDepthState(this.depthState),e.setStencilState(this.stencilFront,this.stencilBack),this.quadRender.render()}}xx.quadVertexShader="\n\t\t\t\tattribute vec2 aPosition;\n\t\t\t\tvarying vec2 uv0;\n\t\t\t\tvoid main(void)\n\t\t\t\t{\n\t\t\t\t\t\tgl_Position = vec4(aPosition, 0.0, 1.0);\n\t\t\t\t\t\tuv0 = getImageEffectUV((aPosition.xy + 1.0) * 0.5);\n\t\t\t\t}\n\t\t";class wx{constructor(e,t){this.processedCache=new Map,this.definitionsCache=new Map,this._generators=new Map,this._device=e,this._isClearingCache=!1,this._precached=!1,this._programsCollection=[],this._defaultStdMatOption=new mv,this._defaultStdMatOptionMin=new mv,t.shaderOptBuilder.updateRef(this._defaultStdMatOption,{},t,null,[],0,null),t.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,{},t,null,4,null),e.on("destroy:shader",(e=>{this.removeFromCache(e)}))}destroy(){this.clearCache()}register(e,t){this._generators.has(e)||this._generators.set(e,t)}unregister(e){this._generators.has(e)&&this._generators.delete(e)}isRegistered(e){return this._generators.has(e)}generateShaderDefinition(e,t,s,i){let n=this.definitionsCache.get(s);if(!n){var r,a,o;let l;null!=(r=i.litOptions)&&r.lights&&(l=i.litOptions.lights,i.litOptions.lights=l.map((function(e){const t=e.clone?e.clone():e;return t.key=e.key,t}))),this.storeNewProgram(t,i),null!=(a=i.litOptions)&&a.lights&&(i.litOptions.lights=l),this._precached;const h=this._device;n=e.createShaderDefinition(h,i),n.name=null!=(o=n.name)?o:i.pass?`${t}-pass:${i.pass}`:t,this.definitionsCache.set(s,n)}return n}getCachedShader(e){return this.processedCache.get(e)}setCachedShader(e,t){this.processedCache.set(e,t)}getProgram(e,t,s,i){const n=this._generators.get(e);if(!n)return null;const r=Op(n.generateKey(t)),a=`${r}#${Op(s.generateKey(this._device))}`;let o=this.getCachedShader(a);if(!o){const l=this.generateShaderDefinition(n,e,r,t);let h,c="";void 0!==t.pass&&(h=yf.get(this._device).getByIndex(t.pass),c=`-${h.name}`),this._device.fire("shader:generate",{userMaterialId:i,shaderPassInfo:h,definition:l});const d={name:`${l.name}${c}-proc`,attributes:l.attributes,vshader:l.vshader,fshader:l.fshader,processingOptions:s,shaderLanguage:l.shaderLanguage};o=new pm(this._device,d),this.setCachedShader(a,o)}return o}storeNewProgram(e,t){let s={};if("standard"===e){const e=this._getDefaultStdMatOptions(t.pass);for(const i in t)(t.hasOwnProperty(i)&&e[i]!==t[i]||"pass"===i)&&(s[i]=t[i]);for(const e in t.litOptions)s[e]=t.litOptions[e]}else s=t;this._programsCollection.push(JSON.stringify({name:e,options:s}))}dumpPrograms(){let e="let device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;\n";e+="let shaders = [",this._programsCollection[0]&&(e+="\n\t"+this._programsCollection[0]);for(let t=1;t<this._programsCollection.length;++t)e+=",\n\t"+this._programsCollection[t];e+="\n];\n",e+="device.getProgramLibrary().precompile(shaders);\n",e+='if (pc.version != "1.69.0" || pc.revision != "29eb79929")\n',e+='\tconsole.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");';const t=document.createElement("a");t.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(e)),t.setAttribute("download","precompile-shaders.js"),t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)}clearCache(){this._isClearingCache=!0,this.processedCache.forEach((e=>{e.destroy()})),this.processedCache.clear(),this._isClearingCache=!1}removeFromCache(e){this._isClearingCache||this.processedCache.forEach(((t,s)=>{e===t&&this.processedCache.delete(s)}))}_getDefaultStdMatOptions(e){const t=yf.get(this._device).getByIndex(e);return 2===e||3===e||5===e||t.isShadow?this._defaultStdMatOptionMin:this._defaultStdMatOption}precompile(e){if(e){const t=new Array(e.length);for(let s=0;s<e.length;s++){if("standard"===e[s].name){const t=e[s].options,i=this._getDefaultStdMatOptions(t.pass);for(const e in i)i.hasOwnProperty(e)&&void 0===t[e]&&(t[e]=i[e])}t[s]=this.getProgram(e[s].name,e[s].options)}}this._precached=!0}}new nu,new pu,new _u,new _u,new xu,new xu,new nu,new nu,new nu,new nu,new nu,new nu,new nu,new nu,new jd(1,1,0,.4),new nu,new nu,new nu,new nu,new nu,new nu,new nu,new nu,new pu,new nu,new nu;const Sx="KEEP_ASPECT",Cx="AUTO";let Tx;function Ax(){return Tx}function Ex(e){Tx=e}class Px{static push(e,t){t&&Px._types.length>0?console.assert("Script Ordering Error. Contact support@playcanvas.com"):Px._types.push(e)}}Px._types=[];let Mx=!1,Lx=!1;const Dx={app:null,create(e,t){if(!Mx)return;const s=t(Dx.app);s._pcScriptName=e,Px.push(s,Mx),this.fire("created",e,t)},attribute(e,t,s,i){},createLoadingScreen(e){if(Lx)return;Lx=!0;e(Ax())}};Object.defineProperty(Dx,"legacy",{get:function(){return Mx},set:function(e){Mx=e}}),ld.attach(Dx);class kx{constructor(){this.renderPasses=[],this.renderTargetMap=new Map}addRenderPass(e){e.frameUpdate();const t=e.beforePasses;for(let e=0;e<t.length;e++){const s=t[e];s.enabled&&this.addRenderPass(s)}e.enabled&&this.renderPasses.push(e);const s=e.afterPasses;for(let e=0;e<s.length;e++){const t=s[e];t.enabled&&this.addRenderPass(t)}}reset(){this.renderPasses.length=0}compile(){const e=this.renderTargetMap,t=this.renderPasses;for(let s=0;s<t.length;s++){const i=t[s],n=i.renderTarget;if(void 0!==n){const t=e.get(n);if(t){const e=i.colorArrayOps.length;for(let s=0;s<e;s++){i.colorArrayOps[s].clear||(t.colorArrayOps[s].store=!0)}i.depthStencilOps.clearDepth||(t.depthStencilOps.storeDepth=!0),i.depthStencilOps.clearStencil||(t.depthStencilOps.storeStencil=!0)}e.set(n,i)}}let s=null,i=null;for(let e=0;e<t.length;e++){const n=t[e],r=n.renderTarget,a=null==r?void 0:r.colorBuffer;if(null!=a&&a.cubemap){if(s===a){const e=i.colorArrayOps.length;for(let t=0;t<e;t++)i.colorArrayOps[t].mipmaps=!1}s=r.colorBuffer,i=n}else n.requiresCubemaps&&(s=null,i=null)}e.clear()}render(e){this.compile();const t=this.renderPasses;for(let e=0;e<t.length;e++)t[e].render()}}class Ix{constructor(e,t){this.texture0=e,this.texture1=t}destroy(){var e,t;null==(e=this.texture0)||e.destroy(),null==(t=this.texture1)||t.destroy()}}const Rx=new zp;class Ox{static createTexture(e,t,s,i=""){return new bm(e,{name:`AreaLightLUT${i}`,width:s,height:s,format:t,addressU:1,addressV:1,type:ep,magFilter:1,minFilter:0,anisotropy:1,mipmaps:!1})}static applyTextures(e,t,s){Rx.remove(e),Rx.get(e,(()=>new Ix(t,t===s?null:s))),e.scope.resolve("areaLightsLutTex1").setValue(t),e.scope.resolve("areaLightsLutTex2").setValue(s)}static createPlaceholder(e){const t=Ox.createTexture(e,e.areaLightLutFormat,2,"placeholder");t.lock().fill(0),t.unlock(),Ox.applyTextures(e,t,t)}static set(e,t,s){function i(e,t,s){const i=Ox.createTexture(e,s,64);return i.lock().set(t),i.unlock(),i}function n(e,t,s){const i=e.length,n=new Float32Array(i);for(let r=0;r<i;r++){const i=r%4;n[r]=(e[r]+t[i])*s[i]}return n}function r(e){const t=e.length,s=new Uint16Array(t),i=Qd.float2Half;for(let n=0;n<t;n++)s[n]=i(e[n]);return s}function a(e){const t=e.length,s=new Uint8ClampedArray(t);for(let i=0;i<t;i++)s[i]=255*e[i];return s}const o=t,l=s;let h,c;const d=e.areaLightLutFormat;if(d===Du)h=o,c=l;else if(d===Lu)h=r(o),c=r(l);else{const e=[-.306897,0,0,0],t=[1.442787,1,1,1];h=a(n(o,[0,.2976,.01381,0],[.999,3.08737,1.6546,.603249])),c=a(n(l,e,t))}const u=i(e,h,d),p=i(e,c,d);Ox.applyTextures(e,u,p)}}const zx="en-US",Fx={en:"en-US",es:"en-ES",zh:"zh-CN","zh-HK":"zh-TW","zh-TW":"zh-HK","zh-MO":"zh-HK",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"},Vx={};function Nx(e,t){for(let s=0,i=e.length;s<i;s++)Vx[e[s]]=t}function Bx(e){const t=e.indexOf("-");return-1!==t?e.substring(0,t):e}function Ux(e,t){if(t[e])return e;let s=Fx[e];if(s&&t[s])return s;const i=Bx(e);return s=Fx[i],t[s]?s:t[i]?i:zx}Nx(["ja","ko","th","vi","zh","id"],(function(e){return 0})),Nx(["fa","hi"],(function(e){return e>=0&&e<=1?0:1})),Nx(["fr","pt"],(function(e){return e>=0&&e<2?0:1})),Nx(["da"],(function(e){return 1===e||!Number.isInteger(e)&&e>=0&&e<=1?0:1})),Nx(["de","en","it","el","es","tr","fi","sv","nb","no","ur"],(function(e){return 1===e?0:1})),Nx(["ru","uk"],(function(e){if(Number.isInteger(e)){const t=e%10,s=e%100;if(1===t&&11!==s)return 0;if(t>=2&&t<=4&&(s<12||s>14))return 1;if(0===t||t>=5&&t<=9||s>=11&&s<=14)return 2}return 3})),Nx(["pl"],(function(e){if(Number.isInteger(e)){if(1===e)return 0;const t=e%10,s=e%100;if(t>=2&&t<=4&&(s<12||s>14))return 1;if(t>=0&&t<=1||t>=5&&t<=9||s>=12&&s<=14)return 2}return 3})),Nx(["ar"],(function(e){if(0===e)return 0;if(1===e)return 1;if(2===e)return 2;if(Number.isInteger(e)){const t=e%100;if(t>=3&&t<=10)return 3;if(t>=11&&t<=99)return 4}return 5}));const Hx=Vx[Bx(zx)];function Wx(e){return Vx[e]||Hx}const Gx=new RegExp("^\\s*(?:(?:[a-z]+[a-z0-9\\-\\+\\.]*:)?//|data:|blob:)","i");class jx{constructor(e="",t="",s=null,i=null,n=null,r=null){this.url=e,this.filename=t,this.hash=s,this.size=i,this.opt=n,this.contents=r}equals(e){return this.url===e.url&&this.filename===e.filename&&this.hash===e.hash&&this.size===e.size&&this.opt===e.opt&&this.contents===e.contents}}let qx=-1;const Kx={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",basis:"canvas"},Xx=["pvr","dxt","etc2","etc1","basis"];class Yx extends od{constructor(e,t,s,i,n){super(),this._id=qx--,this._name=e||"",this.type=t,this.tags=new Nd(this),this._preload=!1,this._file=null,this._data=i||{},this.options=n||{},this._resources=[],this.urlObject=null,this._i18n={},this.loaded=!1,this.loading=!1,this.registry=null,s&&(this.file=s)}set id(e){this._id=e}get id(){return this._id}set name(e){if(this._name===e)return;const t=this._name;this._name=e,this.fire("name",this,this._name,t)}get name(){return this._name}set file(e){if(e&&e.variants&&-1!==["texture","textureatlas","bundle"].indexOf(this.type)){var t;const s=(null==(t=this.registry)||null==(t=t._loader)?void 0:t._app)||Ax(),i=null==s?void 0:s.graphicsDevice;if(i)for(let t=0,n=Xx.length;t<n;t++){const n=Xx[t];if(e.variants[n]&&i[Kx[n]]){e=e.variants[n];break}if(s.enableBundles){const e=s.bundles.listBundlesForAsset(this);if(e&&e.find((e=>{var t;return null==e||null==(t=e.file)?void 0:t.variants[n]})))break}}}const s=this._file,i=e?new jx(e.url,e.filename,e.hash,e.size,e.opt,e.contents):null;(!!i!=!!s||i&&!i.equals(s))&&(this._file=i,this.fire("change",this,"file",i,s),this.reload())}get file(){return this._file}set data(e){const t=this._data;this._data=e,e!==t&&(this.fire("change",this,"data",e,t),this.loaded&&this.registry._loader.patch(this,this.registry))}get data(){return this._data}set resource(e){const t=this._resources[0];this._resources[0]=e,this.fire("change",this,"resource",e,t)}get resource(){return this._resources[0]}set resources(e){const t=this._resources;this._resources=e,this.fire("change",this,"resources",e,t)}get resources(){return this._resources}set preload(e){e=!!e,this._preload!==e&&(this._preload=e,this._preload&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this))}get preload(){return this._preload}set loadFaces(e){e=!!e,this.hasOwnProperty("_loadFaces")&&e===this._loadFaces||(this._loadFaces=e,this.loaded&&this.registry._loader.patch(this,this.registry))}get loadFaces(){return this._loadFaces}getFileUrl(){const e=this.file;if(!e||!e.url)return null;let t=e.url;if(this.registry&&this.registry.prefix&&!Gx.test(t)&&(t=this.registry.prefix+t),"script"!==this.type&&e.hash){const s=-1!==t.indexOf("?")?"&":"?";t+=s+"t="+e.hash}return t}getAbsoluteUrl(e){if(e.startsWith("blob:")||e.startsWith("data:"))return e;const t=cd.getDirectory(this.file.url);return cd.join(t,e)}getLocalizedAssetId(e){return e=Ux(e,this._i18n),this._i18n[e]||null}addLocalizedAssetId(e,t){this._i18n[e]=t,this.fire("add:localized",e,t)}removeLocalizedAssetId(e){const t=this._i18n[e];t&&(delete this._i18n[e],this.fire("remove:localized",e,t))}ready(e,t){t=t||this,this.loaded?e.call(t,this):this.once("load",(function(s){e.call(t,s)}))}reload(){this.loaded&&(this.loaded=!1,this.registry.load(this))}unload(){if(!this.loaded&&0===this._resources.length)return;this.fire("unload",this),this.registry.fire("unload:"+this.id,this);const e=this._resources;this.urlObject&&(URL.revokeObjectURL(this.urlObject),this.urlObject=null),this.resources=[],this.loaded=!1,this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type);for(let t=0;t<e.length;++t){const s=e[t];s&&s.destroy&&s.destroy()}}static fetchArrayBuffer(e,t,s,i=0){var n;null!=s&&null!=(n=s.file)&&n.contents?setTimeout((()=>{t(null,s.file.contents)})):b_.get(e,{cache:!0,responseType:"arraybuffer",retry:i>0,maxRetries:i},t)}}Yx.EVENT_LOAD="load",Yx.EVENT_UNLOAD="unload",Yx.EVENT_REMOVE="remove",Yx.EVENT_ERROR="error",Yx.EVENT_CHANGE="change",Yx.EVENT_ADDLOCALIZED="add:localized",Yx.EVENT_REMOVELOCALIZED="remove:localized";class Zx{constructor(e=null){this._index={},this._key=void 0,this._key=e}addItem(e){const t=e.tags._list;for(const s of t)this.add(s,e)}removeItem(e){const t=e.tags._list;for(const s of t)this.remove(s,e)}add(e,t){this._index[e]&&-1!==this._index[e].list.indexOf(t)||(this._index[e]||(this._index[e]={list:[]},this._key&&(this._index[e].keys={})),this._index[e].list.push(t),this._key&&(this._index[e].keys[t[this._key]]=t))}remove(e,t){if(!this._index[e])return;if(this._key&&!this._index[e].keys[t[this._key]])return;const s=this._index[e].list.indexOf(t);-1!==s&&(this._index[e].list.splice(s,1),this._key&&delete this._index[e].keys[t[this._key]],0===this._index[e].list.length&&delete this._index[e])}find(e){const t={},s=[];let i,n,r,a,o;const l=(e,t)=>this._index[e].list.length-this._index[t].list.length;for(let h=0;h<e.length;h++){if(n=e[h],n instanceof Array){if(0===n.length)continue;if(1!==n.length){o=!1;for(let e=0;e<n.length;e++)if(!this._index[n[e]]){o=!0;break}if(o)continue;r=n.slice(0).sort(l),a=r.slice(1),1===a.length&&(a=a[0]);for(let e=0;e<this._index[r[0]].list.length;e++)i=this._index[r[0]].list[e],(this._key?!t[i[this._key]]:-1===s.indexOf(i))&&i.tags.has(a)&&(this._key&&(t[i[this._key]]=!0),s.push(i));continue}n=n[0]}if(n&&"string"==typeof n&&this._index[n])for(let e=0;e<this._index[n].list.length;e++)i=this._index[n].list[e],this._key?t[i[this._key]]||(t[i[this._key]]=!0,s.push(i)):-1===s.indexOf(i)&&s.push(i)}return s}}class $x extends od{constructor(e){super(),this._assets=new Set,this._idToAsset=new Map,this._urlToAsset=new Map,this._nameToAsset=new Map,this._tags=new Zx("_id"),this.prefix=null,this.bundles=null,this._loader=e}list(e={}){const t=Array.from(this._assets);return void 0!==e.preload?t.filter((t=>t.preload===e.preload)):t}add(e){var t,s;this._assets.has(e)||(this._assets.add(e),this._idToAsset.set(e.id,e),null!=(t=e.file)&&t.url&&this._urlToAsset.set(e.file.url,e),this._nameToAsset.has(e.name)||this._nameToAsset.set(e.name,new Set),this._nameToAsset.get(e.name).add(e),e.on("name",this._onNameChange,this),e.registry=this,this._tags.addItem(e),e.tags.on("add",this._onTagAdd,this),e.tags.on("remove",this._onTagRemove,this),this.fire("add",e),this.fire("add:"+e.id,e),null!=(s=e.file)&&s.url&&this.fire("add:url:"+e.file.url,e),e.preload&&this.load(e))}remove(e){var t,s;if(!this._assets.has(e))return!1;if(this._assets.delete(e),this._idToAsset.delete(e.id),null!=(t=e.file)&&t.url&&this._urlToAsset.delete(e.file.url),e.off("name",this._onNameChange,this),this._nameToAsset.has(e.name)){const t=this._nameToAsset.get(e.name);t.delete(e),0===t.size&&this._nameToAsset.delete(e.name)}return this._tags.removeItem(e),e.tags.off("add",this._onTagAdd,this),e.tags.off("remove",this._onTagRemove,this),e.fire("remove",e),this.fire("remove",e),this.fire("remove:"+e.id,e),null!=(s=e.file)&&s.url&&this.fire("remove:url:"+e.file.url,e),!0}get(e){return this._idToAsset.get(Number(e))}getByUrl(e){return this._urlToAsset.get(e)}load(e,t){if((e.loading||e.loaded)&&(null==t||!t.force))return;const s=e.file,i=()=>{this.fire("load",e),this.fire("load:"+e.id,e),s&&s.url&&this.fire("load:url:"+s.url,e),e.fire("load",e)},n=t=>{if(t instanceof Array?e.resources=t:e.resource=t,this._loader.patch(e,this),"bundle"===e.type){const t=e.data.assets;for(let e=0;e<t.length;e++){const s=this._idToAsset.get(t[e]);s&&!s.loaded&&this.load(s,{force:!0})}e.resource.loaded?i():(this.fire("load:start",e),this.fire("load:start:"+e.id,e),s&&s.url&&this.fire("load:start:url:"+s.url,e),e.fire("load:start",e),e.resource.on("load",i))}else i()},r=(t,s,i)=>{if(e.loaded=!0,e.loading=!1,t)this.fire("error",t,e),this.fire("error:"+e.id,t,e),e.fire("error",t,e);else{if(!Dx.legacy&&"script"===e.type){const t=this._loader.getHandler("script");t._cache[e.id]&&t._cache[e.id].parentNode===document.head&&document.head.removeChild(t._cache[e.id]),t._cache[e.id]=i}n(s)}};if(s||"cubemap"===e.type){this.fire("load:start",e),this.fire("load:"+e.id+":start",e),e.loading=!0;const s=e.getFileUrl();if("bundle"===e.type){const t=e.data.assets;for(let e=0;e<t.length;e++){const s=this._idToAsset.get(t[e]);s&&(s.loaded||s.resource||s.loading||(s.loading=!0))}}this._loader.load(s,e.type,r,e,t)}else{const t=this._loader.open(e.type,e.data);e.loaded=!0,n(t)}}loadFromUrl(e,t,s){this.loadFromUrlAndFilename(e,null,t,s)}loadFromUrlAndFilename(e,t,s,i){const n=cd.getBasename(t||e),r={filename:t||n,url:e};let a=this.getByUrl(e);if(a){if(a.loaded)return void i(a.loadFromUrlError||null,a)}else a=new Yx(n,s,r),this.add(a);const o=e=>{e.once("load",(e=>{"material"===s?this._loadTextures(e,((t,s)=>{i(t,e)})):i(null,e)})),e.once("error",(t=>{t&&(this.loadFromUrlError=t),i(t,e)})),this.load(e)};a.resource?i(null,a):"model"===s?this._loadModel(a,o):o(a)}_loadModel(e,t){const s=e.getFileUrl(),i=cd.getExtension(s);if(".json"===i||".glb"===i){const n=cd.getDirectory(s),r=cd.getBasename(s),a=cd.join(n,r.replace(i,".mapping.json"));this._loader.load(a,"json",((s,i)=>{s?(e.data={mapping:[]},t(e)):this._loadMaterials(e,i,((s,n)=>{e.data=i,t(e)}))}))}else t(e)}_loadMaterials(e,t,s){const i=[];let n=0;const r=(e,t)=>{this._loadTextures(t,((e,r)=>{i.push(t),i.length===n&&s(null,i)}))};for(let s=0;s<t.mapping.length;s++){const i=t.mapping[s].path;if(i){n++;const t=e.getAbsoluteUrl(i);this.loadFromUrl(t,"material",r)}}0===n&&s(null,i)}_loadTextures(e,t){const s=[];let i=0;const n=e.data;if("path"!==n.mappingFormat)return void t(null,s);const r=(e,n)=>{e&&console.error(e),s.push(n),s.length===i&&t(null,s)},a=Sv;for(let t=0;t<a.length;t++){const s=n[a[t]];if(s&&"string"==typeof s){i++;const t=e.getAbsoluteUrl(s);this.loadFromUrl(t,"texture",r)}}0===i&&t(null,s)}_onTagAdd(e,t){this._tags.add(e,t)}_onTagRemove(e,t){this._tags.remove(e,t)}_onNameChange(e,t,s){if(this._nameToAsset.has(s)){const t=this._nameToAsset.get(s);t.delete(e),0===t.size&&this._nameToAsset.delete(s)}this._nameToAsset.has(e.name)||this._nameToAsset.set(e.name,new Set),this._nameToAsset.get(e.name).add(e)}findByTag(){return this._tags.find(arguments)}filter(e){return Array.from(this._assets).filter((t=>e(t)))}find(e,t){const s=this._nameToAsset.get(e);if(!s)return null;for(const e of s)if(!t||e.type===t)return e;return null}findAll(e,t){const s=this._nameToAsset.get(e);if(!s)return[];const i=Array.from(s);return t?i.filter((e=>e.type===t)):i}}$x.EVENT_LOAD="load",$x.EVENT_ADD="add",$x.EVENT_REMOVE="remove",$x.EVENT_ERROR="error";class Qx{constructor(e){this._idToBundle=new Map,this._assetToBundles=new Map,this._urlsToBundles=new Map,this._fileRequests=new Map,this._assets=e,this._assets.bundles=this,this._assets.on("add",this._onAssetAdd,this),this._assets.on("remove",this._onAssetRemove,this)}_onAssetAdd(e){if("bundle"===e.type){this._idToBundle.set(e.id,e),this._assets.on(`load:start:${e.id}`,this._onBundleLoadStart,this),this._assets.on(`load:${e.id}`,this._onBundleLoad,this),this._assets.on(`error:${e.id}`,this._onBundleError,this);const t=e.data.assets;for(let s=0;s<t.length;s++)this._indexAssetInBundle(t[s],e)}else this._assetToBundles.has(e.id)&&this._indexAssetFileUrls(e)}_unbindAssetEvents(e){this._assets.off("load:start:"+e,this._onBundleLoadStart,this),this._assets.off("load:"+e,this._onBundleLoad,this),this._assets.off("error:"+e,this._onBundleError,this)}_indexAssetInBundle(e,t){let s=this._assetToBundles.get(e);s||(s=new Set,this._assetToBundles.set(e,s)),s.add(t);const i=this._assets.get(e);i&&this._indexAssetFileUrls(i)}_indexAssetFileUrls(e){const t=this._getAssetFileUrls(e);if(t)for(let s=0;s<t.length;s++){const i=this._assetToBundles.get(e.id);i&&this._urlsToBundles.set(t[s],i)}}_getAssetFileUrls(e){let t=e.getFileUrl();if(!t)return null;t=t.split("?")[0];const s=[t];if("font"===e.type){const i=e.data.info.maps.length;for(let e=1;e<i;e++)s.push(t.replace(".png",e+".png"))}return s}_onAssetRemove(e){if("bundle"===e.type){this._idToBundle.delete(e.id),this._unbindAssetEvents(e.id);const t=e.data.assets;for(let s=0;s<t.length;s++){const i=this._assetToBundles.get(t[s]);if(i&&(i.delete(e),0===i.size)){this._assetToBundles.delete(t[s]);for(const[e,t]of this._urlsToBundles)t===i&&this._urlsToBundles.delete(e)}}this._onBundleError(`Bundle ${e.id} was removed`)}else{if(!this._assetToBundles.get(e.id))return;this._assetToBundles.delete(e.id);const t=this._getAssetFileUrls(e);if(!t)return;for(let e=0;e<t.length;e++)this._urlsToBundles.delete(t[e])}}_onBundleLoadStart(e){e.resource.on("add",((e,t)=>{const s=this._fileRequests.get(e);if(s){for(let e=0;e<s.length;e++)s[e](null,t);this._fileRequests.delete(e)}}))}_onBundleLoad(e){if(e.resource){if(this._fileRequests)for(const[t,s]of this._fileRequests){const i=this._urlsToBundles.get(t);if(!i||!i.has(e))continue;const n=decodeURIComponent(t);let r,a;if(e.resource.has(n))a=e.resource.get(n);else{if(!e.resource.loaded)continue;r=`Bundle ${e.id} does not contain URL ${t}`}for(let e=0;e<s.length;e++)s[e](r,r||a);this._fileRequests.delete(t)}}else this._onBundleError(`Bundle ${e.id} failed to load`)}_onBundleError(e){for(const[t,s]of this._fileRequests){if(!this._findLoadedOrLoadingBundleForUrl(t)){for(let t=0;t<s.length;t++)s[t](e);this._fileRequests.delete(t)}}}_findLoadedOrLoadingBundleForUrl(e){const t=this._urlsToBundles.get(e);if(!t)return null;let s=null;for(const e of t){if(e.loaded&&e.resource)return e;e.loading&&(s=e)}return s}listBundlesForAsset(e){const t=this._assetToBundles.get(e.id);return t?Array.from(t):null}list(){return Array.from(this._idToBundle.values())}hasUrl(e){return this._urlsToBundles.has(e)}urlIsLoadedOrLoading(e){return!!this._findLoadedOrLoadingBundleForUrl(e)}loadUrl(e,t){const s=this._findLoadedOrLoadingBundleForUrl(e);if(!s)return void t(`URL ${e} not found in any bundles`);if(s.loaded){const i=decodeURIComponent(e);if(s.resource.has(i))return void t(null,s.resource.get(i));if(s.resource.loaded)return void t(`Bundle ${s.id} does not contain URL ${e}`)}let i=this._fileRequests.get(e);i||(i=[],this._fileRequests.set(e,i)),i.push(t)}destroy(){this._assets.off("add",this._onAssetAdd,this),this._assets.off("remove",this._onAssetRemove,this);for(const e of this._idToBundle.keys())this._unbindAssetEvents(e);this._assets=null,this._idToBundle.clear(),this._idToBundle=null,this._assetToBundles.clear(),this._assetToBundles=null,this._urlsToBundles.clear(),this._urlsToBundles=null,this._fileRequests.clear(),this._fileRequests=null}}class Jx extends od{constructor(){super(),this.anim=void 0,this.animation=void 0,this.audiolistener=void 0,this.audiosource=void 0,this.button=void 0,this.camera=void 0,this.collision=void 0,this.element=void 0,this.joint=void 0,this.layoutchild=void 0,this.layoutgroup=void 0,this.light=void 0,this.model=void 0,this.particlesystem=void 0,this.render=void 0,this.rigidbody=void 0,this.screen=void 0,this.script=void 0,this.scrollbar=void 0,this.scrollview=void 0,this.sound=void 0,this.sprite=void 0,this.zone=void 0,this.list=[]}add(e){const t=e.id;if(this[t])throw new Error(`ComponentSystem name '${t}' already registered or not allowed`);this[t]=e,this.list.push(e)}remove(e){const t=e.id;if(!this[t])throw new Error(`No ComponentSystem named '${t}' registered`);delete this[t];const s=this.list.indexOf(this[t]);-1!==s&&this.list.splice(s,1)}destroy(){this.off();for(let e=0;e<this.list.length;e++)this.list[e].destroy()}}class ew extends od{constructor(...e){super(...e),this._index=new Map,this._loaded=!1}addFile(e,t){this._index.has(e)||(this._index.set(e,t),this.fire("add",e,t))}has(e){return this._index.has(e)}get(e){return this._index.get(e)||null}destroy(){this._index.clear()}set loaded(e){e&&!this._loaded&&(this._loaded=!0,this.fire("load"))}get loaded(){return this._loaded}}ew.EVENT_ADD="add",ew.EVENT_LOAD="load";class tw extends od{constructor(e,t=""){super(),this.headerSize=512,this.paddingSize=512,this.bytesRead=0,this.bytesReceived=0,this.headerRead=!1,this.reader=null,this.data=new Uint8Array(0),this.decoder=null,this.prefix="",this.fileName="",this.fileSize=0,this.fileType="",this.ustarFormat="",this.prefix=t||"",this.reader=e.body.getReader(),this.reader.read().then((e=>{this.pump(e.done,e.value)})).catch((e=>{this.fire("error",e)}))}pump(e,t){if(e)return this.fire("done"),null;this.bytesReceived+=t.byteLength;const s=new Uint8Array(this.data.length+t.length);for(s.set(this.data),s.set(t,this.data.length),this.data=s;this.readFile(););return this.reader.read().then((e=>{this.pump(e.done,e.value)})).catch((e=>{this.fire("error",e)}))}readFile(){if(!this.headerRead&&this.bytesReceived>this.bytesRead+this.headerSize){this.headerRead=!0;const e=new DataView(this.data.buffer,this.bytesRead,this.headerSize);null!=this.decoder||(this.decoder=new TextDecoder("windows-1252"));const t=this.decoder.decode(e);if(this.fileName=t.substring(0,100).replace(/\0/g,""),this.fileSize=parseInt(t.substring(124,136),8),this.fileType=t.substring(156,157),this.ustarFormat=t.substring(257,263),-1!==this.ustarFormat.indexOf("ustar")){const e=t.substring(345,500).replace(/\0/g,"");e.length>0&&(this.fileName=e.trim()+this.fileName.trim())}this.bytesRead+=512}if(this.headerRead){if(this.bytesReceived<this.bytesRead+this.fileSize)return!1;if(""===this.fileType||"0"===this.fileType){const e=new DataView(this.data.buffer,this.bytesRead,this.fileSize),t={name:this.prefix+this.fileName,size:this.fileSize,data:e};this.fire("file",t)}this.bytesRead+=this.fileSize,this.headerRead=!1;const e=this.bytesRead%this.paddingSize;return 0!==e&&(this.bytesRead+=this.paddingSize-e),!0}return!1}}class sw{constructor(e,t){this.handlerType="",this._app=void 0,this._maxRetries=0,this._app=e,this.handlerType=t}set maxRetries(e){this._maxRetries=e}get maxRetries(){return this._maxRetries}load(e,t,s){}open(e,t,s){return t}patch(e,t){}}class iw extends sw{constructor(e){super(e,"bundle"),this._assets=e.assets}_fetchRetries(e,t,s=0){return new Promise(((i,n)=>{const r=()=>{fetch(e,t).then(i).catch((e=>{++s<this.maxRetries?r():n(e)}))};r()}))}load(e,t){"string"==typeof e&&(e={load:e,original:e}),this._fetchRetries(e.load,{mode:"cors",credentials:"include"},this.maxRetries).then((e=>{const s=new ew;t(null,s);const i=new tw(e,this._assets.prefix);i.on("file",(e=>{s.addFile(e.name,e.data)})),i.on("done",(()=>{s.loaded=!0})),i.on("error",(e=>{t(e)}))})).catch((e=>{t(e)}))}open(e,t){return t}}class nw{constructor(e){this._handlers={},this._requests={},this._cache={},this._app=e}addHandler(e,t){this._handlers[e]=t,t._loader=this}removeHandler(e){delete this._handlers[e]}getHandler(e){return this._handlers[e]}static makeKey(e,t){return`${e}-${t}`}load(e,t,s,i,n){const r=this._handlers[t];if(!r){return void s(`No resource handler for asset type: '${t}' when loading [${e}]`)}if(!e)return void this._loadNull(r,s,i);const a=nw.makeKey(e,t);if(void 0!==this._cache[a])s(null,this._cache[a]);else if(this._requests[a])this._requests[a].push(s);else{this._requests[a]=[s];const t=this,l=function(e,s){if(e)t._onFailure(a,e);else{if(s.load instanceof DataView){if(r.openBinary){if(!t._requests[a])return;try{const e=r.openBinary(s.load);t._onSuccess(a,e)}catch(e){t._onFailure(a,e)}return}s.load=URL.createObjectURL(new Blob([s.load])),i&&(i.urlObject&&URL.revokeObjectURL(i.urlObject),i.urlObject=s.load)}r.load(s,(function(e,n,o){if(t._requests[a])if(e)t._onFailure(a,e);else try{t._onSuccess(a,r.open(s.original,n,i),o)}catch(e){t._onFailure(a,e)}}),i)}},h=e.split("?")[0];if(!this._app.enableBundles||!this._app.bundles.hasUrl(h)||n&&n.bundlesIgnore)l(null,{load:e,original:i&&i.file.filename||e});else{if(!this._app.bundles.urlIsLoadedOrLoading(h)){var o;const e=this._app.bundles.listBundlesForAsset(i);let t;n&&n.bundlesFilter&&(t=n.bundlesFilter(e)),t||(null==e||e.sort(((e,t)=>e.file.size-t.file.size)),t=null==e?void 0:e[0]),t&&(null==(o=this._app.assets)||o.load(t))}this._app.bundles.loadUrl(h,(function(e,t){l(e,{load:t,original:h})}))}}}_loadNull(e,t,s){e.load(null,(function(i,n,r){if(i)t(i);else try{t(null,e.open(null,n,s),r)}catch(e){t(e)}}),s)}_onSuccess(e,t,s){null!==t?this._cache[e]=t:delete this._cache[e];for(let i=0;i<this._requests[e].length;i++)this._requests[e][i](null,t,s);delete this._requests[e]}_onFailure(e,t){if(console.error(t),this._requests[e]){for(let s=0;s<this._requests[e].length;s++)this._requests[e][s](t);delete this._requests[e]}}open(e,t){const s=this._handlers[e];return s?s.open(null,t):(console.warn("No resource handler found for: "+e),t)}patch(e,t){const s=this._handlers[e.type];s?s.patch&&s.patch(e,t):console.warn("No resource handler found for: "+e.type)}clearCache(e,t){const s=nw.makeKey(e,t);delete this._cache[s]}getFromCache(e,t){const s=nw.makeKey(e,t);if(this._cache[s])return this._cache[s]}enableRetry(e=5){e=Math.max(0,e)||0;for(const t in this._handlers)this._handlers[t].maxRetries=e}disableRetry(){for(const e in this._handlers)this._handlers[e].maxRetries=0}destroy(){this._handlers={},this._requests={},this._cache={}}}class rw{_validate(e){if(!e.header)throw new Error('pc.I18n#addData: Missing "header" field');if(!e.header.version)throw new Error('pc.I18n#addData: Missing "header.version" field');if(1!==e.header.version)throw new Error('pc.I18n#addData: Invalid "header.version" field');if(!e.data)throw new Error('pc.I18n#addData: Missing "data" field');if(!Array.isArray(e.data))throw new Error('pc.I18n#addData: "data" field must be an array');for(let t=0,s=e.data.length;t<s;t++){const s=e.data[t];if(!s.info)throw new Error(`pc.I18n#addData: missing "data[${t}].info" field`);if(!s.info.locale)throw new Error(`pc.I18n#addData: missing "data[${t}].info.locale" field`);if("string"!=typeof s.info.locale)throw new Error(`pc.I18n#addData: "data[${t}].info.locale" must be a string`);if(!s.messages)throw new Error(`pc.I18n#addData: missing "data[${t}].messages" field`)}}parse(e){return e.data}}class aw extends od{constructor(e){super(),this.locale=zx,this._translations={},this._availableLangs={},this._app=e,this._assets=[],this._parser=new rw}set assets(e){const t={};for(let s=0,i=e.length;s<i;s++){t[e[s]instanceof Yx?e[s].id:e[s]]=!0}let s=this._assets.length;for(;s--;){const e=this._assets[s];if(!t[e]){this._app.assets.off("add:"+e,this._onAssetAdd,this);const t=this._app.assets.get(e);t&&this._onAssetRemove(t),this._assets.splice(s,1)}}for(const e in t){const t=parseInt(e,10);if(-1!==this._assets.indexOf(t))continue;this._assets.push(t);const s=this._app.assets.get(t);s?this._onAssetAdd(s):this._app.assets.once("add:"+t,this._onAssetAdd,this)}}get assets(){return this._assets}set locale(e){if(this._locale===e)return;let t=Bx(e);if("in"===t&&(t="id",e=function(e,t){const s=e.indexOf("-");return-1!==s?t+e.substring(s):t}(e,t),this._locale===e))return;const s=this._locale;this._locale=e,this._lang=t,this._pluralFn=Wx(this._lang),this.fire("set:locale",e,s)}get locale(){return this._locale}static findAvailableLocale(e,t){return Ux(e,t)}findAvailableLocale(e){if(this._translations[e])return e;const t=Bx(e);return this._findFallbackLocale(e,t)}getText(e,t){let s,i=e;t||(t=this._locale,s=this._lang);let n=this._translations[t];return n||(s||(s=Bx(t)),t=this._findFallbackLocale(t,s),n=this._translations[t]),n&&n.hasOwnProperty(e)&&(i=n[e],Array.isArray(i)&&(i=i[0]),null==i&&(i=e)),i}getPluralText(e,t,s){let i,n,r=e;s?(i=Bx(s),n=Wx(i)):(s=this._locale,i=this._lang,n=this._pluralFn);let a=this._translations[s];if(a||(i=Bx(s=this._findFallbackLocale(s,i)),n=Wx(i),a=this._translations[s]),a&&a[e]&&n){const s=n(t);r=a[e][s],null==r&&(r=e)}return r}addData(e){let t;try{t=this._parser.parse(e)}catch(e){return void console.error(e)}for(let e=0,s=t.length;e<s;e++){const s=t[e],i=s.info.locale,n=s.messages;if(!this._translations[i]){this._translations[i]={};const e=Bx(i);this._availableLangs[e]||(this._availableLangs[e]=i)}Object.assign(this._translations[i],n),this.fire("data:add",i,n)}}removeData(e){let t;try{t=this._parser.parse(e)}catch(e){return void console.error(e)}for(let e=0,s=t.length;e<s;e++){const s=t[e],i=s.info.locale,n=this._translations[i];if(!n)continue;const r=s.messages;for(const e in r)delete n[e];0===Object.keys(n).length&&(delete this._translations[i],delete this._availableLangs[Bx(i)]),this.fire("data:remove",i,r)}}destroy(){this._translations=null,this._availableLangs=null,this._assets=null,this._parser=null,this.off()}_findFallbackLocale(e,t){let s=Fx[e];return s&&this._translations[s]?s:(s=Fx[t],s&&this._translations[s]?s:(s=this._availableLangs[t],s&&this._translations[s]?s:zx))}_onAssetAdd(e){e.on("load",this._onAssetLoad,this),e.on("change",this._onAssetChange,this),e.on("remove",this._onAssetRemove,this),e.on("unload",this._onAssetUnload,this),e.resource&&this._onAssetLoad(e)}_onAssetLoad(e){this.addData(e.resource)}_onAssetChange(e){e.resource&&this.addData(e.resource)}_onAssetRemove(e){e.off("load",this._onAssetLoad,this),e.off("change",this._onAssetChange,this),e.off("remove",this._onAssetRemove,this),e.off("unload",this._onAssetUnload,this),e.resource&&this.removeData(e.resource),this._app.assets.once("add:"+e.id,this._onAssetAdd,this)}_onAssetUnload(e){e.resource&&this.removeData(e.resource)}}class ow extends od{constructor(e){super(),this.app=e,this._scripts={},this._list=[]}destroy(){this.app=null,this.off()}add(e){const t=e.__name;return this._scripts.hasOwnProperty(t)?(setTimeout((()=>{if(e.prototype.swap){const s=this._scripts[t],i=this._list.indexOf(s);this._list[i]=e,this._scripts[t]=e,this.fire("swap",t,e),this.fire("swap:"+t,e)}else console.warn(`script registry already has '${t}' script, define 'swap' method for new script type to enable code hot swapping`)})),!1):(this._scripts[t]=e,this._list.push(e),this.fire("add",t,e),this.fire("add:"+t,e),setTimeout((()=>{if(!this._scripts.hasOwnProperty(t))return;if(!this.app||!this.app.systems||!this.app.systems.script)return;const e=this.app.systems.script._components;let s;const i=[],n=[];for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++){const n=e.items[e.loopIndex];if(n._scriptsIndex[t]&&n._scriptsIndex[t].awaiting){n._scriptsData&&n._scriptsData[t]&&(s=n._scriptsData[t].attributes);const e=n.create(t,{preloading:!0,ind:n._scriptsIndex[t].ind,attributes:s});e&&i.push(e)}}for(let e=0;e<i.length;e++)i[e].__initializeAttributes();for(let e=0;e<i.length;e++)i[e].enabled&&(i[e]._initialized=!0,n.push(i[e]),i[e].initialize&&i[e].initialize());for(let e=0;e<n.length;e++)n[e].enabled&&!n[e]._postInitialized&&(n[e]._postInitialized=!0,n[e].postInitialize&&n[e].postInitialize())})),!0)}remove(e){let t=e,s=e;if("string"!=typeof s?s=t.__name:t=this.get(s),this.get(s)!==t)return!1;delete this._scripts[s];const i=this._list.indexOf(t);return this._list.splice(i,1),this.fire("remove",s,t),this.fire("remove:"+s,t),!0}get(e){return this._scripts[e]||null}has(e){if("string"==typeof e)return this._scripts.hasOwnProperty(e);if(!e)return!1;const t=e.__name;return this._scripts[t]===e}list(){return this._list}}const lw=[];class hw extends Kf{constructor(e,t=Ax()){super(e),this.anim=void 0,this.animation=void 0,this.audiolistener=void 0,this.button=void 0,this.camera=void 0,this.collision=void 0,this.element=void 0,this.gsplat=void 0,this.layoutchild=void 0,this.layoutgroup=void 0,this.light=void 0,this.model=void 0,this.particlesystem=void 0,this.render=void 0,this.rigidbody=void 0,this.screen=void 0,this.script=void 0,this.scrollbar=void 0,this.scrollview=void 0,this.sound=void 0,this.sprite=void 0,this.c={},this._app=void 0,this._destroying=!1,this._guid=null,this._template=!1,this._app=t}addComponent(e,t){const s=this._app.systems[e];return s?this.c[e]?null:s.addComponent(this,t):null}removeComponent(e){const t=this._app.systems[e];t&&this.c[e]&&t.removeComponent(this)}findComponent(e){const t=this.findOne((function(t){return t.c&&t.c[e]}));return t&&t.c[e]}findComponents(e){return this.find((function(t){return t.c&&t.c[e]})).map((function(t){return t.c[e]}))}findScript(e){const t=this.findOne((t=>{var s;return null==(s=t.c)||null==(s=s.script)?void 0:s.has(e)}));return null==t?void 0:t.c.script.get(e)}findScripts(e){return this.find((t=>{var s;return null==(s=t.c)||null==(s=s.script)?void 0:s.has(e)})).map((t=>t.c.script.get(e)))}getGuid(){return this._guid||this.setGuid(hd.create()),this._guid}setGuid(e){const t=this._app._entityIndex;this._guid&&delete t[this._guid],this._guid=e,t[this._guid]=this}_notifyHierarchyStateChanged(e,t){let s=!1;e===this&&0===lw.length&&(s=!0),e._beingEnabled=!0,e._onHierarchyStateChanged(t),e._onHierarchyStatePostChanged&&lw.push(e);const i=e._children;for(let e=0,s=i.length;e<s;e++)i[e]._enabled&&this._notifyHierarchyStateChanged(i[e],t);if(e._beingEnabled=!1,s){for(let e=0;e<lw.length;e++)lw[e]._onHierarchyStatePostChanged();lw.length=0}}_onHierarchyStateChanged(e){super._onHierarchyStateChanged(e);const t=this.c;for(const s in t)if(t.hasOwnProperty(s)){const i=t[s];i.enabled&&(e?i.onEnable():i.onDisable())}}_onHierarchyStatePostChanged(){const e=this.c;for(const t in e)e.hasOwnProperty(t)&&e[t].onPostStateChange()}findByGuid(e){if(this._guid===e)return this;const t=this._app._entityIndex[e];return t&&(t===this||t.isDescendantOf(this))?t:null}destroy(){this._destroying=!0;for(const e in this.c)this.c[e].enabled=!1;for(const e in this.c)this.c[e].system.removeComponent(this);super.destroy(),this._guid&&delete this._app._entityIndex[this._guid],this._destroying=!1}clone(){const e={},t=this._cloneRecursively(e);return e[this.getGuid()]=t,cw(this,this,t,e),t}_cloneRecursively(e){const t=new this.constructor(void 0,this._app);super._cloneInternal(t);for(const e in this.c){this.c[e].system.cloneComponent(this,t)}for(let s=0;s<this._children.length;s++){const i=this._children[s];if(i instanceof hw){const s=i._cloneRecursively(e);t.addChild(s),e[i.getGuid()]=s}}return t}}function cw(e,t,s,i){if(t instanceof hw){const n=t.c;for(const t in n){const r=n[t],a=r.system.getPropertiesOfType("entity");for(let n=0,o=a.length;n<o;n++){const o=a[n].name,l=r[o];if(!!e.findByGuid(l)){const e=i[l].getGuid();e&&(s.c[t][o]=e)}}}n.script&&!s._app.useLegacyScriptAttributeCloning&&s.script.resolveDuplicatedEntityReferenceProperties(n.script,i),n.render&&s.render.resolveDuplicatedEntityReferenceProperties(n.render,i),n.anim&&s.anim.resolveDuplicatedEntityReferenceProperties(n.anim,i);const r=t.children.filter((function(e){return e instanceof hw})),a=s.children.filter((function(e){return e instanceof hw}));for(let t=0,s=r.length;t<s;t++)cw(e,r[t],a[t],i)}}hw.EVENT_DESTROY="destroy";class dw{constructor(e,t){this.name=void 0,this.url=void 0,this.data=null,this._loading=!1,this._onLoadedCallbacks=[],this.name=e,this.url=t}get loaded(){return!!this.data}get loading(){return this._loading}}class uw{constructor(e){this._app=void 0,this._list=[],this._index={},this._urlIndex={},this._app=e}destroy(){this._app=null}list(){return this._list}add(e,t){if(this._index.hasOwnProperty(e))return!1;const s=new dw(e,t),i=this._list.push(s);return this._index[s.name]=i-1,this._urlIndex[s.url]=i-1,!0}find(e){return this._index.hasOwnProperty(e)?this._list[this._index[e]]:null}findByUrl(e){return this._urlIndex.hasOwnProperty(e)?this._list[this._urlIndex[e]]:null}remove(e){if(this._index.hasOwnProperty(e)){const t=this._index[e];let s=this._list[t];delete this._urlIndex[s.url],delete this._index[e],this._list.splice(t,1);for(let e=0;e<this._list.length;e++)s=this._list[e],this._index[s.name]=e,this._urlIndex[s.url]=e}}_loadSceneData(e,t,s){const i=this._app;let n=e;if("string"==typeof e&&(e=this.findByUrl(n)||this.find(n)||new dw("Untitled",n)),n=e.url,n)if(e.loaded)s(null,e);else{if(i.assets&&i.assets.prefix&&!Gx.test(n)&&(n=cd.join(i.assets.prefix,n)),e._onLoadedCallbacks.push(s),!e._loading){i.loader.getHandler("hierarchy").load(n,((s,i)=>{e.data=i,e._loading=!1;for(let t=0;t<e._onLoadedCallbacks.length;t++)e._onLoadedCallbacks[t](s,e);t||(e.data=null),e._onLoadedCallbacks.length=0}))}e._loading=!0}else s("Cannot find scene to load")}loadSceneData(e,t){this._loadSceneData(e,!0,t)}unloadSceneData(e){"string"==typeof e&&(e=this.findByUrl(e)),e&&(e.data=null)}_loadSceneHierarchy(e,t,s){this._loadSceneData(e,!1,((e,i)=>{if(e)return void(s&&s(e));t&&t(i);const n=this._app;n._preloadScripts(i.data,(()=>{const e=n.loader.getHandler("hierarchy");n.systems.script.preloading=!0;const t=e.open(i.url,i.data);n.systems.script.preloading=!1,n.loader.clearCache(i.url,"hierarchy"),n.root.addChild(t),n.systems.fire("initialize",t),n.systems.fire("postInitialize",t),n.systems.fire("postPostInitialize",t),s&&s(null,t)}))}))}loadSceneHierarchy(e,t){this._loadSceneHierarchy(e,null,t)}loadSceneSettings(e,t){this._loadSceneData(e,!1,((e,s)=>{e?t&&t(e):(this._app.applySceneSettings(s.data.settings),t&&t(null))}))}changeScene(e,t){const s=this._app;this._loadSceneHierarchy(e,(e=>{const{children:t}=s.root;for(;t.length;)t[0].destroy();s.applySceneSettings(e.data.settings)}),t)}loadScene(e,t){const s=this._app,i=s.loader.getHandler("scene");s.assets&&s.assets.prefix&&!Gx.test(e)&&(e=cd.join(s.assets.prefix,e)),i.load(e,((n,r)=>{if(n)t&&t(n);else{const n=()=>{s.systems.script.preloading=!0;const n=i.open(e,r),a=this.findByUrl(e);a&&!a.loaded&&(a.data=r),s.systems.script.preloading=!1,s.loader.clearCache(e,"scene"),s.loader.patch({resource:n,type:"scene"},s.assets),s.root.addChild(n.root),s.systems.rigidbody&&"undefined"!=typeof Ammo&&s.systems.rigidbody.gravity.set(n._gravity.x,n._gravity.y,n._gravity.z),t&&t(null,n)};s._preloadScripts(r,n)}}))}}class pw{constructor(e){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,lightClustersTime:0,lightClusters:0,_timeToCountFrames:0,_fpsAccum:0},this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0},this.misc={renderTargetCreationTime:0},this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0},this.shaders=e._shaderStats,this.vram=e._vram,Object.defineProperty(this.vram,"totalUsed",{get:function(){return this.tex+this.vb+this.ib}}),Object.defineProperty(this.vram,"geom",{get:function(){return this.vb+this.ib}})}get scene(){return Ax().scene._stats}get lightmapper(){var e;return null==(e=Ax().lightmapper)?void 0:e.stats}get batcher(){const e=Ax()._batcher;return e?e._stats:null}}class mw{constructor(e){this.length=e,this.count=0}inc(){this.count++}done(){return this.count===this.length}}class _w extends od{constructor(e){super(),this.frameRequestId=void 0,_w._applications[e.id]=this,Ex(this),this._destroyRequested=!1,this._inFrameUpdate=!1,this._time=0,this.timeScale=1,this.maxDeltaTime=.1,this.frame=0,this.autoRender=!0,this.renderNextFrame=!1,this.useLegacyScriptAttributeCloning=Dx.legacy,this._librariesLoaded=!1,this._fillMode=Sx,this._resolutionMode="FIXED",this._allowResize=!0,this.context=this}init(e){const t=e.graphicsDevice;this.graphicsDevice=t,this._initDefaultMaterial(),this._initProgramLibrary(),this.stats=new pw(t),this._soundManager=e.soundManager,this.loader=new nw(this),this._entityIndex={},this.scene=new vx(t),this._registerSceneImmediate(this.scene),this.root=new hw,this.root._enabledInHierarchy=!0,this.assets=new $x(this.loader),e.assetPrefix&&(this.assets.prefix=e.assetPrefix),this.bundles=new Qx(this.assets),this.enableBundles="undefined"!=typeof TextDecoder,this.scriptsOrder=e.scriptsOrder||[],this.scripts=new ow(this),this.i18n=new aw(this),this.scenes=new uw(this),this.defaultLayerWorld=new rb({name:"World",id:0}),this.defaultLayerDepth=new rb({name:"Depth",id:1,enabled:!1,opaqueSortMode:0}),this.defaultLayerSkybox=new rb({name:"Skybox",id:2,opaqueSortMode:0}),this.defaultLayerUi=new rb({name:"UI",id:4,transparentSortMode:1}),this.defaultLayerImmediate=new rb({name:"Immediate",id:3,opaqueSortMode:0});const s=new lb("default");s.pushOpaque(this.defaultLayerWorld),s.pushOpaque(this.defaultLayerDepth),s.pushOpaque(this.defaultLayerSkybox),s.pushTransparent(this.defaultLayerWorld),s.pushOpaque(this.defaultLayerImmediate),s.pushTransparent(this.defaultLayerImmediate),s.pushTransparent(this.defaultLayerUi),this.scene.layers=s,Ox.createPlaceholder(t),this.renderer=new Jy(t),this.renderer.scene=this.scene,this.frameGraph=new kx,this.lightmapper=null,e.lightmapper&&(this.lightmapper=new e.lightmapper(t,this.root,this.scene,this.renderer,this.assets),this.once("prerender",this._firstBake,this)),this._batcher=null,e.batchManager&&(this._batcher=new e.batchManager(t,this.root,this.scene),this.once("prerender",this._firstBatch,this)),this.keyboard=e.keyboard||null,this.mouse=e.mouse||null,this.touch=e.touch||null,this.gamepads=e.gamepads||null,this.elementInput=e.elementInput||null,this.elementInput&&(this.elementInput.app=this),this.xr=e.xr?new e.xr(this):null,this.elementInput&&this.elementInput.attachSelectEvents(),this._inTools=!1,this._skyboxAsset=null,this._scriptPrefix=e.scriptPrefix||"",this.enableBundles&&this.loader.addHandler("bundle",new iw(this)),e.resourceHandlers.forEach((e=>{const t=new e(this);this.loader.addHandler(t.handlerType,t)})),this.systems=new Jx,e.componentSystems.forEach((e=>{this.systems.add(new e(this))})),this._visibilityChangeHandler=this.onVisibilityChange.bind(this),"undefined"!=typeof document&&(void 0!==document.hidden?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.mozHidden?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.msHidden?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.webkitHidden&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1))),this.tick=gw(this)}static getApplication(e){return e?_w._applications[e]:Ax()}_initDefaultMaterial(){const e=new Pv;e.name="Default Material",e.shadingModel=1,function(e,t){xf.get(e,(()=>t))}(this.graphicsDevice,e)}_initProgramLibrary(){const e=new wx(this.graphicsDevice,new Pv);rf(this.graphicsDevice,e)}get soundManager(){return this._soundManager}get batcher(){return this._batcher}get fillMode(){return this._fillMode}get resolutionMode(){return this._resolutionMode}configure(e,t){b_.get(e,((e,s)=>{if(e)return void t(e);const i=s.application_properties,n=s.scenes,r=s.assets;this._parseApplicationProperties(i,(e=>{this._parseScenes(n),this._parseAssets(r),t(e||null)}))}))}preload(e){this.fire("preload:start");const t=this.assets.list({preload:!0}),s=new mw(t.length);let i=!1;const n=()=>{this.graphicsDevice&&!i&&s.done()&&(i=!0,this.fire("preload:end"),e())},r=t.length;if(s.length){const e=e=>{s.inc(),this.fire("preload:progress",s.count/r),s.done()&&n()},i=(e,t)=>{s.inc(),this.fire("preload:progress",s.count/r),s.done()&&n()};for(let a=0;a<t.length;a++)t[a].loaded?(s.inc(),this.fire("preload:progress",s.count/r),s.done()&&n()):(t[a].once("load",e),t[a].once("error",i),this.assets.load(t[a]))}else n()}_preloadScripts(e,t){if(!Dx.legacy)return void t();this.systems.script.preloading=!0;const s=this._getScriptReferences(e),i=s.length,n=new mw(i),r=/^http(s)?:\/\//;if(i){const e=(e,s)=>{e&&console.error(e),n.inc(),n.done()&&(this.systems.script.preloading=!1,t())};for(let t=0;t<i;t++){let i=s[t];!r.test(i.toLowerCase())&&this._scriptPrefix&&(i=cd.join(this._scriptPrefix,s[t])),this.loader.load(i,"script",e)}}else this.systems.script.preloading=!1,t()}_parseApplicationProperties(e,t){if("number"==typeof e.maxAssetRetries&&e.maxAssetRetries>0&&this.loader.enableRetry(e.maxAssetRetries),e.useDevicePixelRatio||(e.useDevicePixelRatio=e.use_device_pixel_ratio),e.resolutionMode||(e.resolutionMode=e.resolution_mode),e.fillMode||(e.fillMode=e.fill_mode),this._width=e.width,this._height=e.height,e.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio),this.setCanvasResolution(e.resolutionMode,this._width,this._height),this.setCanvasFillMode(e.fillMode,this._width,this._height),e.layers&&e.layerOrder){const t=new lb("application"),s={};for(const t in e.layers){const i=e.layers[t];i.id=parseInt(t,10),i.enabled=1!==i.id,s[t]=new rb(i)}for(let i=0,n=e.layerOrder.length;i<n;i++){const n=e.layerOrder[i],r=s[n.layer];r&&(n.transparent?t.pushTransparent(r):t.pushOpaque(r),t.subLayerEnabled[i]=n.enabled)}this.scene.layers=t}if(e.batchGroups){const t=this.batcher;if(t)for(let s=0,i=e.batchGroups.length;s<i;s++){const i=e.batchGroups[s];t.addGroup(i.name,i.dynamic,i.maxAabbSize,i.id,i.layers)}}e.i18nAssets&&(this.i18n.assets=e.i18nAssets),this._loadLibraries(e.libraries,t)}_loadLibraries(e,t){const s=e.length;let i=s;const n=/^http(s)?:\/\//;if(s){const r=(e,s)=>{i--,e?t(e):0===i&&(this.onLibrariesLoaded(),t(null))};for(let t=0;t<s;++t){let s=e[t];!n.test(s.toLowerCase())&&this._scriptPrefix&&(s=cd.join(this._scriptPrefix,s)),this.loader.load(s,"script",r)}}else this.onLibrariesLoaded(),t(null)}_parseScenes(e){if(e)for(let t=0;t<e.length;t++)this.scenes.add(e[t].name,e[t].url)}_parseAssets(e){const t=[],s={},i={};if(Dx.legacy){if(this.enableBundles)for(const s in e)"bundle"===e[s].type&&(i[s]=!0,t.push(e[s]));for(const s in e)i[s]||t.push(e[s])}else{for(let i=0;i<this.scriptsOrder.length;i++){const n=this.scriptsOrder[i];e[n]&&(s[n]=!0,t.push(e[n]))}if(this.enableBundles)for(const s in e)"bundle"===e[s].type&&(i[s]=!0,t.push(e[s]));for(const n in e)s[n]||i[n]||t.push(e[n])}for(let e=0;e<t.length;e++){const s=t[e],i=new Yx(s.name,s.type,s.file,s.data);if(i.id=parseInt(s.id,10),i.preload=!!s.preload&&s.preload,i.loaded="script"===s.type&&s.data&&s.data.loadingType>0,i.tags.add(s.tags),s.i18n)for(const e in s.i18n)i.addLocalizedAssetId(e,s.i18n[e]);this.assets.add(i)}}_getScriptReferences(e){let t=[];e.settings.priority_scripts&&(t=e.settings.priority_scripts);const s=[],i={};for(let e=0;e<t.length;e++)s.push(t[e]),i[t[e]]=!0;const n=e.entities;for(const e in n){if(!n[e].components.script)continue;const t=n[e].components.script.scripts;for(let e=0;e<t.length;e++)i[t[e].url]||(s.push(t[e].url),i[t[e].url]=!0)}return s}start(){this.frame=0,this.fire("start",{timestamp:Bd(),target:this}),this._librariesLoaded||this.onLibrariesLoaded(),this.systems.fire("initialize",this.root),this.fire("initialize"),this.systems.fire("postInitialize",this.root),this.systems.fire("postPostInitialize",this.root),this.fire("postinitialize"),this.tick()}inputUpdate(e){this.controller&&this.controller.update(e),this.mouse&&this.mouse.update(),this.keyboard&&this.keyboard.update(),this.gamepads&&this.gamepads.update()}update(e){this.frame++,this.graphicsDevice.updateClientRect(),Dx.legacy&&this.systems.fire("fixedUpdate",1/60),this.systems.fire(this._inTools?"toolsUpdate":"update",e),this.systems.fire("animationUpdate",e),this.systems.fire("postUpdate",e),this.fire("update",e),this.inputUpdate(e)}frameStart(){this.graphicsDevice.frameStart()}frameEnd(){this.graphicsDevice.frameEnd()}render(){this.fire("prerender"),this.root.syncHierarchy(),this._batcher&&this._batcher.updateAll(),this.renderComposition(this.scene.layers),this.fire("postrender")}renderComposition(e){this.renderer.buildFrameGraph(this.frameGraph,e),this.frameGraph.render(this.graphicsDevice)}_fillFrameStatsBasic(e,t,s){const i=this.stats.frame;i.dt=t,i.ms=s,e>i._timeToCountFrames?(i.fps=i._fpsAccum,i._fpsAccum=0,i._timeToCountFrames=e+1e3):i._fpsAccum++,this.stats.drawCalls.total=this.graphicsDevice._drawCallsPerFrame,this.graphicsDevice._drawCallsPerFrame=0}_fillFrameStats(){let e=this.stats.frame;e.cameras=this.renderer._camerasRendered,e.materials=this.renderer._materialSwitches,e.shaders=this.graphicsDevice._shaderSwitchesPerFrame,e.shadowMapUpdates=this.renderer._shadowMapUpdates,e.shadowMapTime=this.renderer._shadowMapTime,e.depthMapTime=this.renderer._depthMapTime,e.forwardTime=this.renderer._forwardTime;const t=this.graphicsDevice._primsPerFrame;e.triangles=t[4]/3+Math.max(t[5]-2,0)+Math.max(t[6]-2,0),e.cullTime=this.renderer._cullTime,e.sortTime=this.renderer._sortTime,e.skinTime=this.renderer._skinTime,e.morphTime=this.renderer._morphTime,e.lightClusters=this.renderer._lightClusters,e.lightClustersTime=this.renderer._lightClustersTime,e.otherPrimitives=0;for(let s=0;s<t.length;s++)s<4&&(e.otherPrimitives+=t[s]),t[s]=0;this.renderer._camerasRendered=0,this.renderer._materialSwitches=0,this.renderer._shadowMapUpdates=0,this.graphicsDevice._shaderSwitchesPerFrame=0,this.renderer._cullTime=0,this.renderer._layerCompositionUpdateTime=0,this.renderer._lightClustersTime=0,this.renderer._sortTime=0,this.renderer._skinTime=0,this.renderer._morphTime=0,this.renderer._shadowMapTime=0,this.renderer._depthMapTime=0,this.renderer._forwardTime=0,e=this.stats.drawCalls,e.forward=this.renderer._forwardDrawCalls,e.culled=this.renderer._numDrawCallsCulled,e.depth=0,e.shadow=this.renderer._shadowDrawCalls,e.skinned=this.renderer._skinDrawCalls,e.immediate=0,e.instanced=0,e.removedByInstancing=0,e.misc=e.total-(e.forward+e.shadow),this.renderer._depthDrawCalls=0,this.renderer._shadowDrawCalls=0,this.renderer._forwardDrawCalls=0,this.renderer._numDrawCallsCulled=0,this.renderer._skinDrawCalls=0,this.renderer._immediateRendered=0,this.renderer._instancedDrawCalls=0,this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime,e=this.stats.particles,e.updatesPerFrame=e._updatesPerFrame,e.frameTime=e._frameTime,e._updatesPerFrame=0,e._frameTime=0}setCanvasFillMode(e,t,s){this._fillMode=e,this.resizeCanvas(t,s)}setCanvasResolution(e,t,s){this._resolutionMode=e,e===Cx&&void 0===t&&(t=this.graphicsDevice.canvas.clientWidth,s=this.graphicsDevice.canvas.clientHeight),this.graphicsDevice.resizeCanvas(t,s)}isHidden(){return document[this._hiddenAttr]}onVisibilityChange(){this.isHidden()?this._soundManager&&this._soundManager.suspend():this._soundManager&&this._soundManager.resume()}resizeCanvas(e,t){if(!this._allowResize)return;if(this.xr&&this.xr.session)return;const s=window.innerWidth,i=window.innerHeight;if(this._fillMode===Sx){const n=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;n>s/i?t=(e=s)/n:e=(t=i)*n}else"FILL_WINDOW"===this._fillMode&&(e=s,t=i);return this.graphicsDevice.canvas.style.width=e+"px",this.graphicsDevice.canvas.style.height=t+"px",this.updateCanvasSize(),{width:e,height:t}}updateCanvasSize(){var e;if(this._allowResize&&(null==(e=this.xr)||!e.active)&&this._resolutionMode===Cx){const e=this.graphicsDevice.canvas;this.graphicsDevice.resizeCanvas(e.clientWidth,e.clientHeight)}}onLibrariesLoaded(){this._librariesLoaded=!0,this.systems.rigidbody&&this.systems.rigidbody.onLibraryLoaded()}applySceneSettings(e){let t;if(this.systems.rigidbody&&"undefined"!=typeof Ammo){const t=e.physics.gravity;this.systems.rigidbody.gravity.set(t[0],t[1],t[2])}this.scene.applySettings(e),e.render.hasOwnProperty("skybox")&&(e.render.skybox?(t=this.assets.get(e.render.skybox),t?this.setSkybox(t):this.assets.once("add:"+e.render.skybox,this.setSkybox,this)):this.setSkybox(null))}setAreaLightLuts(e,t){e&&t&&Ox.set(this.graphicsDevice,e,t)}setSkybox(e){if(e!==this._skyboxAsset){const t=()=>{this.setSkybox(null)},s=()=>{this.scene.setSkybox(this._skyboxAsset?this._skyboxAsset.resources:null)};this._skyboxAsset&&(this.assets.off("load:"+this._skyboxAsset.id,s,this),this.assets.off("remove:"+this._skyboxAsset.id,t,this),this._skyboxAsset.off("change",s,this)),this._skyboxAsset=e,this._skyboxAsset&&(this.assets.on("load:"+this._skyboxAsset.id,s,this),this.assets.once("remove:"+this._skyboxAsset.id,t,this),this._skyboxAsset.on("change",s,this),0!==this.scene.skyboxMip||this._skyboxAsset.loadFaces||(this._skyboxAsset.loadFaces=!0),this.assets.load(this._skyboxAsset)),s()}}_firstBake(){var e;null==(e=this.lightmapper)||e.bake(null,this.scene.lightmapMode)}_firstBatch(){var e;null==(e=this.batcher)||e.generate()}_processTimestamp(e){return e}drawLine(e,t,s,i,n){this.scene.drawLine(e,t,s,i,n)}drawLines(e,t,s=!0,i=this.scene.defaultDrawLayer){this.scene.drawLines(e,t,s,i)}drawLineArrays(e,t,s=!0,i=this.scene.defaultDrawLayer){this.scene.drawLineArrays(e,t,s,i)}drawWireSphere(e,t,s=jd.WHITE,i=20,n=!0,r=this.scene.defaultDrawLayer){this.scene.immediate.drawWireSphere(e,t,s,i,n,r)}drawWireAlignedBox(e,t,s=jd.WHITE,i=!0,n=this.scene.defaultDrawLayer,r){this.scene.immediate.drawWireAlignedBox(e,t,s,i,n,r)}drawMeshInstance(e,t=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(null,null,null,e,t)}drawMesh(e,t,s,i=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(t,s,e,null,i)}drawQuad(e,t,s=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(t,e,this.scene.immediate.getQuadMesh(),null,s)}drawTexture(e,t,s,i,n,r,a=this.scene.defaultDrawLayer,o=!0){if(!1===o&&!this.graphicsDevice.isWebGPU)return;const l=new pu;l.setTRS(new nu(e,t,0),_u.IDENTITY,new nu(s,-i,0)),r||((r=new Tf).cull=0,r.setParameter("colorMap",n),r.shader=o?this.scene.immediate.getTextureShader():this.scene.immediate.getUnfilterableTextureShader(),r.update()),this.drawQuad(l,r,a)}drawDepthTexture(e,t,s,i,n=this.scene.defaultDrawLayer){const r=new Tf;r.cull=0,r.shader=this.scene.immediate.getDepthTextureShader(),r.update(),this.drawTexture(e,t,s,i,null,r,n)}destroy(){var e,t,s,i;if(this._inFrameUpdate)return void(this._destroyRequested=!0);const n=this.graphicsDevice.canvas.id;this.fire("destroy",this),this.off("librariesloaded"),"undefined"!=typeof document&&(document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1)),this._visibilityChangeHandler=null,this.root.destroy(),this.root=null,this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null),this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null),this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null),this.elementInput&&(this.elementInput.detach(),this.elementInput=null),this.gamepads&&(this.gamepads.destroy(),this.gamepads=null),this.controller&&(this.controller=null),this.systems.destroy(),this.scene.layers&&this.scene.layers.destroy();const r=this.assets.list();for(let e=0;e<r.length;e++)r[e].unload(),r[e].off();this.assets.off(),this.bundles.destroy(),this.bundles=null,this.i18n.destroy(),this.i18n=null;const a=this.loader.getHandler("script");null==a||a.clearCache(),this.loader.destroy(),this.loader=null,this.scene.destroy(),this.scene=null,this.systems=null,this.context=null,this.scripts.destroy(),this.scripts=null,this.scenes.destroy(),this.scenes=null,null==(e=this.lightmapper)||e.destroy(),this.lightmapper=null,this._batcher&&(this._batcher.destroy(),this._batcher=null),this._entityIndex={},this.defaultLayerDepth.onPreRenderOpaque=null,this.defaultLayerDepth.onPostRenderOpaque=null,this.defaultLayerDepth.onDisable=null,this.defaultLayerDepth.onEnable=null,this.defaultLayerDepth=null,this.defaultLayerWorld=null,null==(t=this.xr)||t.end(),null==(s=this.xr)||s.destroy(),this.renderer.destroy(),this.renderer=null,this.graphicsDevice.destroy(),this.graphicsDevice=null,this.tick=null,this.off(),null==(i=this._soundManager)||i.destroy(),this._soundManager=null,Dx.app=null,_w._applications[n]=null,Ax()===this&&Ex(null),_w.cancelTick(this)}static cancelTick(e){e.frameRequestId&&(window.cancelAnimationFrame(e.frameRequestId),e.frameRequestId=void 0)}getEntityFromIndex(e){return this._entityIndex[e]}_registerSceneImmediate(e){this.on("postrender",e.immediate.onPostRender,e.immediate)}}_w._applications={};const fw={},gw=function(e){const t=e;return function(e,s){var i;if(!t.graphicsDevice)return;t.frameRequestId=null,t._inFrameUpdate=!0,Ex(t);const n=t._processTimestamp(e)||Bd(),r=n-(t._time||n);let a=r/1e3;if(a=Wd.clamp(a,0,t.maxDeltaTime),a*=t.timeScale,t._time=n,null!=(i=t.xr)&&i.session?t.frameRequestId=t.xr.session.requestAnimationFrame(t.tick):t.frameRequestId=Sd.browser?window.requestAnimationFrame(t.tick):null,t.graphicsDevice.contextLost)return;t._fillFrameStatsBasic(n,a,r),t.fire("frameupdate",r);let o=!0;var l;s?(o=null==(l=t.xr)?void 0:l.update(s),t.graphicsDevice.defaultFramebuffer=s.session.renderState.baseLayer.framebuffer):t.graphicsDevice.defaultFramebuffer=null;o&&(t.update(a),t.fire("framerender"),(t.autoRender||t.renderNextFrame)&&(t.updateCanvasSize(),t.frameStart(),t.render(),t.frameEnd(),t.renderNextFrame=!1),fw.timestamp=Bd(),fw.target=t,t.fire("frameend",fw)),t._inFrameUpdate=!1,t._destroyRequested&&t.destroy()}};new Cu,new au,new nu,new nu;class vw extends od{constructor(e,t){super(),this.system=void 0,this.entity=void 0,this.system=e,this.entity=t,this.system.schema&&!this._accessorsBuilt&&this.buildAccessors(this.system.schema),this.on("set",(function(e,t,s){this.fire("set_"+e,e,t,s)})),this.on("set_enabled",this.onSetEnabled,this)}static _buildAccessors(e,t){t.forEach((function(t){const s="object"==typeof t?t.name:t;Object.defineProperty(e,s,{get:function(){return this.data[s]},set:function(e){const t=this.data,i=t[s];t[s]=e,this.fire("set",s,i,e)},configurable:!0})})),e._accessorsBuilt=!0}buildAccessors(e){vw._buildAccessors(this,e)}onSetEnabled(e,t,s){t!==s&&this.entity.enabled&&(s?this.onEnable():this.onDisable())}onEnable(){}onDisable(){}onPostStateChange(){}get data(){const e=this.system.store[this.entity.getGuid()];return e?e.data:null}}class yw extends od{constructor(e){super(),this.app=e,this.store={},this.schema=[]}addComponent(e,t={}){const s=new this.ComponentType(this,e),i=new this.DataType;return this.store[e.getGuid()]={entity:e,data:i},e[this.id]=s,e.c[this.id]=s,this.initializeComponentData(s,t,[]),this.fire("add",e,s),s}removeComponent(e){const t=this.store[e.getGuid()],s=e.c[this.id];this.fire("beforeremove",e,s),delete this.store[e.getGuid()],e[this.id]=void 0,delete e.c[this.id],this.fire("remove",e,t.data)}cloneComponent(e,t){const s=this.store[e.getGuid()];return this.addComponent(t,s.data)}initializeComponentData(e,t={},s){for(let i=0,n=s.length;i<n;i++){const n=s[i];let r,a;"object"==typeof n?(r=n.name,a=n.type):(r=n,a=void 0);let o=t[r];void 0!==o?(void 0!==a&&(o=bw(o,a)),e[r]=o):e[r]=e.data[r]}e.enabled&&e.entity.enabled&&e.onEnable()}getPropertiesOfType(e){const t=[];return(this.schema||[]).forEach((function(s){s&&"object"==typeof s&&s.type===e&&t.push(s)})),t}destroy(){this.off()}}function bw(e,t){if(!e)return e;switch(t){case"rgb":return e instanceof jd?e.clone():new jd(e[0],e[1],e[2]);case"rgba":return e instanceof jd?e.clone():new jd(e[0],e[1],e[2],e[3]);case"vec2":return e instanceof au?e.clone():new au(e[0],e[1]);case"vec3":return e instanceof nu?e.clone():new nu(e[0],e[1],e[2]);case"vec4":return e instanceof ou?e.clone():new ou(e[0],e[1],e[2],e[3]);case"boolean":case"number":case"string":case"entity":return e;default:throw new Error("Could not convert unhandled type: "+t)}}class xw{constructor(){this._left=1/0,this._right=-1/0,this._len=0,this._recip=0,this._p0=0,this._p1=0,this._t=0,this._hermite={valid:!1,p0:0,m0:0,p1:0,m1:0}}update(e,t){if(e<this._left||e>=this._right){const s=t.length;if(s)if(e<t[0])this._left=-1/0,this._right=t[0],this._len=0,this._recip=0,this._p0=this._p1=0;else if(e>=t[s-1])this._left=t[s-1],this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=s-1;else{const s=this._findKey(e,t);this._left=t[s],this._right=t[s+1],this._len=this._right-this._left;const i=1/this._len;this._recip=isFinite(i)?i:0,this._p0=s,this._p1=s+1}else this._left=-1/0,this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=0}this._t=0===this._recip?0:(e-this._left)*this._recip,this._hermite.valid=!1}_findKey(e,t){let s=0;for(;e>=t[s+1];)s++;return s}eval(e,t,s){const i=s._data,n=s._components,r=this._p0*n;if(0===t)for(let t=0;t<n;++t)e[t]=i[r+t];else{const s=this._t,a=this._p1*n;switch(t){case 1:for(let t=0;t<n;++t)e[t]=Wd.lerp(i[r+t],i[a+t],s);break;case 2:{const t=this._hermite;if(!t.valid){const e=s*s,i=s+s,n=1-s,r=n*n;t.valid=!0,t.p0=(1+i)*r,t.m0=s*r,t.p1=e*(3-i),t.m1=e*(s-1)}const r=(3*this._p0+1)*n,a=(3*this._p0+2)*n,o=(3*this._p1+1)*n,l=(3*this._p1+0)*n;for(let s=0;s<n;++s)e[s]=t.p0*i[r+s]+t.m0*i[a+s]*this._len+t.p1*i[o+s]+t.m1*i[l+s]*this._len;break}}}}}class ww{constructor(e){this._name=e.name+"Snapshot",this._time=-1,this._cache=[],this._results=[];for(let t=0;t<e._inputs.length;++t)this._cache[t]=new xw;const t=e._curves,s=e._outputs;for(let e=0;e<t.length;++e){const i=s[t[e]._output],n=[];for(let e=0;e<i._components;++e)n[e]=0;this._results[e]=n}}}class Sw{constructor(e,t,s,i,n,r){this._name=e.name,this._track=e,this._snapshot=new ww(e),this._playing=i,this._time=t,this._speed=s,this._loop=n,this._blendWeight=1,this._blendOrder=0,this._eventHandler=r,this.alignCursorToCurrentTime()}set name(e){this._name=e}get name(){return this._name}set track(e){this._track=e,this._snapshot=new ww(e)}get track(){return this._track}get snapshot(){return this._snapshot}set time(e){this._time=e,this.alignCursorToCurrentTime()}get time(){return this._time}set speed(e){const t=Math.sign(e)!==Math.sign(this._speed);this._speed=e,t&&this.alignCursorToCurrentTime()}get speed(){return this._speed}set loop(e){this._loop=e}get loop(){return this._loop}set blendWeight(e){this._blendWeight=e}get blendWeight(){return this._blendWeight}set blendOrder(e){this._blendOrder=e}get blendOrder(){return this._blendOrder}set eventCursor(e){this._eventCursor=e}get eventCursor(){return this._eventCursor}get eventCursorEnd(){return this.isReverse?0:this._track.events.length-1}get nextEvent(){return this._track.events[this._eventCursor]}get isReverse(){return this._speed<0}nextEventAheadOfTime(e){return!!this.nextEvent&&(this.isReverse?this.nextEvent.time<=e:this.nextEvent.time>=e)}nextEventBehindTime(e){return!!this.nextEvent&&(e===this.track.duration?this.isReverse?this.nextEvent.time>=e:this.nextEvent.time<=e:this.isReverse?this.nextEvent.time>e:this.nextEvent.time<e)}resetEventCursor(){this._eventCursor=this.isReverse?this._track.events.length-1:0}moveEventCursor(){this._eventCursor+=this.isReverse?-1:1,this._eventCursor>=this.track.events.length?this._eventCursor=0:this._eventCursor<0&&(this._eventCursor=this.track.events.length-1)}clipFrameTime(e){const t=Sw.eventFrame;t.start=0,t.end=e,t.residual=0,this.isReverse?e<0&&(t.start=this.track.duration,t.end=0,t.residual=e+this.track.duration):e>this.track.duration&&(t.start=0,t.end=this.track.duration,t.residual=e-this.track.duration)}alignCursorToCurrentTime(){for(this.resetEventCursor();this.nextEventBehindTime(this._time)&&this._eventCursor!==this.eventCursorEnd;)this.moveEventCursor()}fireNextEvent(){this._eventHandler.fire(this.nextEvent.name,yp({track:this.track},this.nextEvent)),this.moveEventCursor()}fireNextEventInFrame(e,t){return!(!this.nextEventAheadOfTime(e)||!this.nextEventBehindTime(t))&&(this.fireNextEvent(),!0)}activeEventsForFrame(e,t){const s=Sw.eventFrame;this.clipFrameTime(t);const i=this.eventCursor;for(;this.fireNextEventInFrame(e,s.end)&&i!==this.eventCursor;);this.loop&&Math.abs(s.residual)>0&&this.activeEventsForFrame(s.start,s.residual)}progressForTime(e){return e*this._speed/this._track.duration}_update(e){if(this._playing){let t=this._time;const s=this._track.duration,i=this._speed,n=this._loop;this._track.events.length>0&&s>0&&this.activeEventsForFrame(t,t+i*e),t+=i*e,i>=0?t>s&&(n?t=t%s||0:(t=this._track.duration,this.pause())):t<0&&(n?t=s+(t%s||0):(t=0,this.pause())),this._time=t}this._time!==this._snapshot._time&&this._track.eval(this._time,this._snapshot)}play(){this._playing=!0,this._time=0}stop(){this._playing=!1,this._time=0}pause(){this._playing=!1}resume(){this._playing=!0}reset(){this._time=0}}Sw.eventFrame={start:0,end:0,residual:0};const Cw="NONE",Tw="INTEGER",Aw="FLOAT",Ew="BOOLEAN",Pw="TRIGGER",Mw="START",Lw="END",Dw="ANY",kw=[Mw,Lw,Dw],Iw="OVERWRITE";class Rw{static dot(e,t){const s=e.length;let i=0;for(let n=0;n<s;++n)i+=e[n]*t[n];return i}static normalize(e){let t=Rw.dot(e,e);if(t>0){t=1/Math.sqrt(t);const s=e.length;for(let i=0;i<s;++i)e[i]*=t}}static set(e,t,s){const i=e.length;if("quaternion"===s){let s=Rw.dot(t,t);s>0&&(s=1/Math.sqrt(s));for(let n=0;n<i;++n)e[n]=t[n]*s}else for(let s=0;s<i;++s)e[s]=t[s]}static blendVec(e,t,s,i){const n=i?1:1-s,r=e.length;for(let i=0;i<r;++i)e[i]=e[i]*n+t[i]*s}static blendQuat(e,t,s,i){const n=e.length,r=i?1:1-s;Rw.dot(e,t)<0&&(s=-s);for(let i=0;i<n;++i)e[i]=e[i]*r+t[i]*s;i||Rw.normalize(e)}static blend(e,t,s,i,n){"quaternion"===i?Rw.blendQuat(e,t,s,n):Rw.blendVec(e,t,s,n)}static stableSort(e,t){const s=e.length;for(let i=0;i<s-1;++i)for(let n=i+1;n<s;++n)if(t(e[n],e[i])){const t=e[i];e[i]=e[n],e[n]=t}}}class Ow{constructor(e,t){this._component=e,this.mask=new Int8Array(e.layers.length),this.weights=new Float32Array(e.layers.length),this.totalWeight=0,this.counter=0,this.layerCounter=0,this.valueType=t,this.dirty=!0,this.value=t===Ow.TYPE_QUAT?[0,0,0,1]:[0,0,0],this.baseValue=null,this.setter=null}get _normalizeWeights(){return this._component.normalizeWeights}getWeight(e){return this.dirty&&this.updateWeights(),this._normalizeWeights&&0===this.totalWeight||!this.mask[e]?0:this._normalizeWeights?this.weights[e]/this.totalWeight:Wd.clamp(this.weights[e],0,1)}_layerBlendType(e){return this._component.layers[e].blendType}setMask(e,t){this.mask[e]=t,this._normalizeWeights&&(this._component.layers[e].blendType===Iw&&(this.mask=this.mask.fill(0,0,e)),this.dirty=!0)}updateWeights(){this.totalWeight=0;for(let e=0;e<this.weights.length;e++)this.weights[e]=this._component.layers[e].weight,this.totalWeight+=this.mask[e]*this.weights[e];this.dirty=!1}updateValue(e,t){if(0===this.counter&&(Rw.set(this.value,Ow.IDENTITY_QUAT_ARR,this.valueType),this._normalizeWeights||Rw.blend(this.value,this.baseValue,1,this.valueType)),this.mask[e]&&0!==this.getWeight(e)){if("ADDITIVE"!==this._layerBlendType(e)||this._normalizeWeights)Rw.blend(this.value,t,this.getWeight(e),this.valueType);else if(this.valueType===Ow.TYPE_QUAT){const s=Ow.q1.set(this.value[0],this.value[1],this.value[2],this.value[3]),i=Ow.q2.set(this.baseValue[0],this.baseValue[1],this.baseValue[2],this.baseValue[3]),n=Ow.q3.set(t[0],t[1],t[2],t[3]),r=i.invert().mul(n);r.slerp(_u.IDENTITY,r,this.getWeight(e)),s.mul(r),Ow.quatArr[0]=s.x,Ow.quatArr[1]=s.y,Ow.quatArr[2]=s.z,Ow.quatArr[3]=s.w,Rw.set(this.value,Ow.quatArr,this.valueType)}else Ow.vecArr[0]=t[0]-this.baseValue[0],Ow.vecArr[1]=t[1]-this.baseValue[1],Ow.vecArr[2]=t[2]-this.baseValue[2],Rw.blend(this.value,Ow.vecArr,this.getWeight(e),this.valueType,!0);this.setter&&this.setter(this.value)}}unbind(){this.setter&&this.setter(this.baseValue)}}Ow.TYPE_QUAT="quaternion",Ow.TYPE_VEC3="vector3",Ow.q1=new _u,Ow.q2=new _u,Ow.q3=new _u,Ow.quatArr=[0,0,0,1],Ow.vecArr=[0,0,0],Ow.IDENTITY_QUAT_ARR=[0,0,0,1];class zw{constructor(e){this._binder=e,this._clips=[],this._inputs=[],this._outputs=[],this._targets={}}get clips(){return this._clips}addClip(e){const t=this._targets,s=this._binder,i=e.track.curves,n=e.snapshot,r=[],a=[];for(let e=0;e<i.length;++e){const o=i[e].paths;for(let i=0;i<o.length;++i){const l=o[i],h=s.resolve(l);let c=t[h&&h.targetPath||null];if(!c&&h){c={target:h,value:[],curves:0,blendCounter:0};for(let e=0;e<c.target.components;++e)c.value.push(0);if(t[h.targetPath]=c,s.animComponent){if(!s.animComponent.targets[h.targetPath]){let e;e="localRotation"===h.targetPath.substring(h.targetPath.length-13)?Ow.TYPE_QUAT:Ow.TYPE_VEC3,s.animComponent.targets[h.targetPath]=new Ow(s.animComponent,e)}s.animComponent.targets[h.targetPath].layerCounter++,s.animComponent.targets[h.targetPath].setMask(s.layerIndex,1)}}c&&(c.curves++,r.push(n._results[e]),a.push(c))}}this._clips.push(e),this._inputs.push(r),this._outputs.push(a)}removeClip(e){const t=this._targets,s=this._binder,i=this._clips,n=i[e].track.curves;for(let e=0;e<n.length;++e){const i=n[e].paths;for(let e=0;e<i.length;++e){const n=i[e],r=this._binder.resolve(n);r&&(r.curves--,0===r.curves&&(s.unresolve(n),delete t[r.targetPath],s.animComponent&&s.animComponent.targets[r.targetPath].layerCounter--))}}i.splice(e,1),this._inputs.splice(e,1),this._outputs.splice(e,1)}removeClips(){for(;this._clips.length>0;)this.removeClip(0)}updateClipTrack(e,t){this._clips.forEach((s=>{s.name.includes(e)&&(s.track=t)})),this.rebind()}findClip(e){const t=this._clips;for(let s=0;s<t.length;++s){const i=t[s];if(i.name===e)return i}return null}rebind(){this._binder.rebind(),this._targets={};const e=[...this.clips];this.removeClips(),e.forEach((e=>{this.addClip(e)}))}assignMask(e){return this._binder.assignMask(e)}update(e,t=!0){const s=this._clips,i=s.map((function(e,t){return t}));Rw.stableSort(i,(function(e,t){return s[e].blendOrder<s[t].blendOrder}));for(let n=0;n<i.length;++n){const r=i[n],a=s[r],o=this._inputs[r],l=this._outputs[r],h=a.blendWeight;if(h>0&&a._update(e),!t)break;let c,d,u;if(h>=1)for(let e=0;e<o.length;++e)c=o[e],d=l[e],u=d.value,Rw.set(u,c,d.target.type),d.blendCounter++;else if(h>0)for(let e=0;e<o.length;++e)c=o[e],d=l[e],u=d.value,0===d.blendCounter?Rw.set(u,c,d.target.type):Rw.blend(u,c,h,d.target.type),d.blendCounter++}const n=this._targets,r=this._binder;for(const e in n)if(n.hasOwnProperty(e)){const t=n[e];if(r.animComponent&&t.target.isTransform){const s=r.animComponent.targets[e];s.counter===s.layerCounter&&(s.counter=0),s.path||(s.path=e,s.baseValue=t.target.get(),s.setter=t.target.set),s.updateValue(r.layerIndex,t.value),s.counter++}else t.target.set(t.value);t.blendCounter=0}this._binder.update(e)}}class Fw{constructor(e){this._events=[...e],this._events.sort(((e,t)=>e.time-t.time))}get events(){return this._events}}var Vw;class Nw{constructor(e,t,s,i,n,r=new Fw([])){this._name=e,this._duration=t,this._inputs=s,this._outputs=i,this._curves=n,this._animEvents=r}get name(){return this._name}get duration(){return this._duration}get inputs(){return this._inputs}get outputs(){return this._outputs}get curves(){return this._curves}set events(e){this._animEvents=e}get events(){return this._animEvents.events}eval(e,t){t._time=e;const s=this._inputs,i=this._outputs,n=this._curves,r=t._cache,a=t._results;for(let t=0;t<s.length;++t)r[t].update(e,s[t]._data);for(let e=0;e<n.length;++e){const t=n[e],s=i[t._output],o=a[e];r[t._input].eval(o,t._interpolation,s)}}}Vw=Nw,Nw.EMPTY=Object.freeze(new Vw("empty",Number.MAX_VALUE,[],[],[]));class Bw{static joinPath(e,t){t=t||".";return e.map((function(e){return e.replace(/\\/g,"\\\\").replace(new RegExp("\\"+t,"g"),"\\"+t)})).join(t)}static splitPath(e,t){t=t||".";const s=[];let i="",n=0;for(;n<e.length;){let r=e[n++];"\\"===r&&n<e.length?(r=e[n++],i+="\\"===r||r===t?r:"\\"+r):r===t?(s.push(i),i=""):i+=r}return i.length>0&&s.push(i),s}static encode(e,t,s){return`${Array.isArray(e)?e.join("/"):e}/${t}/${Array.isArray(s)?s.join("/"):s}`}resolve(e){return null}unresolve(e){}update(e){}}class Uw{constructor(e,t,s,i){e.set?(this._set=e.set,this._get=e.get):this._set=e,this._type=t,this._components=s,this._targetPath=i,this._isTransform="localRotation"===this._targetPath.substring(this._targetPath.length-13)||"localPosition"===this._targetPath.substring(this._targetPath.length-13)||"localScale"===this._targetPath.substring(this._targetPath.length-10)}get set(){return this._set}get get(){return this._get}get type(){return this._type}get components(){return this._components}get targetPath(){return this._targetPath}get isTransform(){return this._isTransform}}class Hw{constructor(e){if(this._isPathInMask=(e,t)=>{const s=this._mask[e];return!!s&&!!(s.children||t&&!1!==s.value)},this.graph=e,!e)return;this._mask=null;const t={};!function e(s){t[s.name]=s;for(let t=0;t<s.children.length;++t)e(s.children[t])}(e),this.nodes=t,this.targetCache={};const s=function(e){let t,s=e;for(;s&&!(s instanceof hw);)s=s.parent;return s&&(s.render?t=s.render.meshInstances:s.model&&(t=s.model.meshInstances)),t};this.nodeCounts={},this.activeNodes=[],this.handlers={localPosition:function(e){const t=e.localPosition;return Hw.createAnimTarget((function(e){t.set(...e)}),"vector",3,e,"localPosition")},localRotation:function(e){const t=e.localRotation;return Hw.createAnimTarget((function(e){t.set(...e)}),"quaternion",4,e,"localRotation")},localScale:function(e){const t=e.localScale;return Hw.createAnimTarget((function(e){t.set(...e)}),"vector",3,e,"localScale")},weight:function(e,t){t=0===t.indexOf("name.")?t.replace("name.",""):Number(t);const i=s(e);let n;if(i)for(let s=0;s<i.length;++s)if(i[s].node.name===e.name&&i[s].morphInstance){const e=i[s].morphInstance,r=s=>{e.setWeight(t,s[0])};n||(n=[]),n.push(r)}if(n){const s=e=>{for(let t=0;t<n.length;++t)n[t](e)};return Hw.createAnimTarget(s,"number",1,e,`weight.${t}`)}return null},materialTexture:(e,t)=>{const i=s(e);if(i){let s;for(let t=0;t<i.length;++t)if(i[t].node.name===e.name){s=i[t];break}if(s){const i=e=>{const i=this.animComponent.system.app.assets.get(e[0]);i&&i.resource&&"texture"===i.type&&(s.material[t]=i.resource,s.material.update())};return Hw.createAnimTarget(i,"vector",1,e,"materialTexture","material")}}return null}}}_isPathActive(e){if(!this._mask)return!0;const t=[e.entityPath[0],this.graph.name];for(let s=0;s<t.length;++s){let i=t[s];if(this._isPathInMask(i,1===e.entityPath.length))return!0;for(let t=1;t<e.entityPath.length;t++)if(i+="/"+e.entityPath[t],this._isPathInMask(i,t===e.entityPath.length-1))return!0}return!1}findNode(e){if(!this._isPathActive(e))return null;let t;return this.graph&&(t=this.graph.findByPath(e.entityPath),t||(t=this.graph.findByPath(e.entityPath.slice(1)))),t||(t=this.nodes[e.entityPath[e.entityPath.length-1]||""]),t}static createAnimTarget(e,t,s,i,n,r){const a=Bw.encode(i.path,r||"entity",n);return new Uw(e,t,s,a)}resolve(e){const t=Bw.encode(e.entityPath,e.component,e.propertyPath);let s=this.targetCache[t];if(s)return s;const i=this.findNode(e);if(!i)return null;const n=this.handlers[e.propertyPath];return n?(s=n(i),s?(this.targetCache[t]=s,this.nodeCounts[i.path]?this.nodeCounts[i.path]++:(this.activeNodes.push(i),this.nodeCounts[i.path]=1),s):null):null}unresolve(e){if("graph"!==e.component)return;const t=this.nodes[e.entityPath[e.entityPath.length-1]||""];if(this.nodeCounts[t.path]--,0===this.nodeCounts[t.path]){const e=this.activeNodes,s=e.indexOf(t.node),i=e.length;s<i-1&&(e[s]=e[i-1]),e.pop()}}update(e){const t=this.activeNodes;for(let e=0;e<t.length;++e)t[e]._dirtifyLocal()}assignMask(e){return e!==this._mask&&(this._mask=e,!0)}}vw._buildAccessors(class extends vw{constructor(e,t){super(e,t),this._animations={},this._assets=[],this._loop=!0,this.animEvaluator=null,this.model=null,this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animationsIndex={},this.prevAnim=null,this.currAnim=null,this.blend=0,this.blending=!1,this.blendSpeed=0,this.activate=!0,this.speed=1}set animations(e){this._animations=e,this.onSetAnimations()}get animations(){return this._animations}set assets(e){const t=this._assets;if(t&&t.length)for(let e=0;e<t.length;e++)if(t[e]){const s=this.system.app.assets.get(t[e]);if(s){s.off("change",this.onAssetChanged,this),s.off("remove",this.onAssetRemoved,this);const e=this.animationsIndex[s.id];this.currAnim===e&&this._stopCurrentAnimation(),delete this.animations[e],delete this.animationsIndex[s.id]}}this._assets=e;const s=e.map((e=>e instanceof Yx?e.id:e));this.loadAnimationAssets(s)}get assets(){return this._assets}set currentTime(e){if(this.skeleton&&(this.skeleton.currentTime=e,this.skeleton.addTime(0),this.skeleton.updateGraph()),this.animEvaluator){const t=this.animEvaluator.clips;for(let s=0;s<t.length;++s)t[s].time=e}}get currentTime(){if(this.skeleton)return this.skeleton._time;if(this.animEvaluator){const e=this.animEvaluator.clips;if(e.length>0)return e[e.length-1].time}return 0}get duration(){return this.currAnim?this.animations[this.currAnim].duration:0}set loop(e){if(this._loop=e,this.skeleton&&(this.skeleton.looping=e),this.animEvaluator)for(let t=0;t<this.animEvaluator.clips.length;++t)this.animEvaluator.clips[t].loop=e}get loop(){return this._loop}play(e,t=0){if(this.enabled&&this.entity.enabled&&this.animations[e]){if(this.prevAnim=this.currAnim,this.currAnim=e,this.model){this.skeleton||this.animEvaluator||this._createAnimationController();const e=this.animations[this.prevAnim],s=this.animations[this.currAnim];if(this.blending=t>0&&!!this.prevAnim,this.blending&&(this.blend=0,this.blendSpeed=1/t),this.skeleton&&(this.blending?(this.fromSkel.animation=e,this.fromSkel.addTime(this.skeleton._time),this.toSkel.animation=s):this.skeleton.animation=s),this.animEvaluator){const e=this.animEvaluator;if(this.blending)for(;e.clips.length>1;)e.removeClip(0);else this.animEvaluator.removeClips();const t=new Sw(this.animations[this.currAnim],0,1,!0,this.loop);t.name=this.currAnim,t.blendWeight=this.blending?0:1,t.reset(),this.animEvaluator.addClip(t)}}this.playing=!0}}getAnimation(e){return this.animations[e]}setModel(e){e!==this.model&&(this._resetAnimationController(),this.model=e,this.animations&&this.currAnim&&this.animations[this.currAnim]&&this.play(this.currAnim))}onSetAnimations(){const e=this.entity.model;if(e){const t=e.model;t&&t!==this.model&&this.setModel(t)}if(!this.currAnim&&this.activate&&this.enabled&&this.entity.enabled){const e=Object.keys(this._animations);e.length>0&&this.play(e[0])}}_resetAnimationController(){this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animEvaluator=null}_createAnimationController(){const e=this.model,t=this.animations;let s=!1,i=!1;for(const e in t)if(t.hasOwnProperty(e)){t[e].constructor===Nw?i=!0:s=!0}const n=e.getGraph();s?(this.fromSkel=new bx(n),this.toSkel=new bx(n),this.skeleton=new bx(n),this.skeleton.looping=this.loop,this.skeleton.setGraph(n)):i&&(this.animEvaluator=new zw(new Hw(this.entity)))}loadAnimationAssets(e){if(!e||!e.length)return;const t=this.system.app.assets,s=e=>{if(e.resources.length>1)for(let t=0;t<e.resources.length;t++)this.animations[e.resources[t].name]=e.resources[t],this.animationsIndex[e.id]=e.resources[t].name;else this.animations[e.name]=e.resource,this.animationsIndex[e.id]=e.name;this.animations=this.animations},i=e=>{e.off("change",this.onAssetChanged,this),e.on("change",this.onAssetChanged,this),e.off("remove",this.onAssetRemoved,this),e.on("remove",this.onAssetRemoved,this),e.resource?s(e):(e.once("load",s,this),this.enabled&&this.entity.enabled&&t.load(e))};for(let s=0,n=e.length;s<n;s++){const n=t.get(e[s]);n?i(n):t.on("add:"+e[s],i)}}onAssetChanged(e,t,s,i){if("resource"===t||"resources"===t)if("resources"===t&&s&&0===s.length&&(s=null),s){let t=!1;if(s.length>1){if(i&&i.length>1)for(let e=0;e<i.length;e++)delete this.animations[i[e].name];else delete this.animations[e.name];t=!1;for(let e=0;e<s.length;e++)this.animations[s[e].name]=s[e],t||this.currAnim!==s[e].name||this.playing&&this.enabled&&this.entity.enabled&&(t=!0,this.play(s[e].name));t||(this._stopCurrentAnimation(),this.onSetAnimations())}else{if(i&&i.length>1)for(let e=0;e<i.length;e++)delete this.animations[i[e].name];this.animations[e.name]=s[0]||s,t=!1,this.currAnim===e.name&&this.playing&&this.enabled&&this.entity.enabled&&(t=!0,this.play(e.name)),t||(this._stopCurrentAnimation(),this.onSetAnimations())}this.animationsIndex[e.id]=e.name}else{if(i.length>1)for(let e=0;e<i.length;e++)delete this.animations[i[e].name],this.currAnim===i[e].name&&this._stopCurrentAnimation();else delete this.animations[e.name],this.currAnim===e.name&&this._stopCurrentAnimation();delete this.animationsIndex[e.id]}}onAssetRemoved(e){if(e.off("remove",this.onAssetRemoved,this),this.animations){if(e.resources.length>1)for(let t=0;t<e.resources.length;t++)delete this.animations[e.resources[t].name],this.currAnim===e.resources[t].name&&this._stopCurrentAnimation();else delete this.animations[e.name],this.currAnim===e.name&&this._stopCurrentAnimation();delete this.animationsIndex[e.id]}}_stopCurrentAnimation(){if(this.currAnim=null,this.playing=!1,this.skeleton&&(this.skeleton.currentTime=0,this.skeleton.animation=null),this.animEvaluator){for(let e=0;e<this.animEvaluator.clips.length;++e)this.animEvaluator.clips[e].stop();this.animEvaluator.update(0),this.animEvaluator.removeClips()}}onEnable(){super.onEnable();const e=this.assets,t=this.system.app.assets;if(e)for(let s=0,i=e.length;s<i;s++){let i=e[s];i instanceof Yx||(i=t.get(i)),i&&!i.resource&&t.load(i)}if(this.activate&&!this.currAnim){const e=Object.keys(this.animations);e.length>0&&this.play(e[0])}}onBeforeRemove(){for(let e=0;e<this.assets.length;e++){let t=this.assets[e];"number"==typeof t&&(t=this.system.app.assets.get(t)),t&&(t.off("change",this.onAssetChanged,this),t.off("remove",this.onAssetRemoved,this))}this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animEvaluator=null}update(e){if(this.blending&&(this.blend+=e*this.blendSpeed,this.blend>=1&&(this.blend=1)),this.playing){const t=this.skeleton;if(null!==t&&null!==this.model){if(this.blending)t.blend(this.fromSkel,this.toSkel,this.blend);else{const s=e*this.speed;t.addTime(s),(this.speed>0&&t._time===t.animation.duration&&!this.loop||this.speed<0&&0===t._time&&!this.loop)&&(this.playing=!1)}this.blending&&1===this.blend&&(t.animation=this.toSkel.animation),t.updateGraph()}}const t=this.animEvaluator;if(t){for(let e=0;e<t.clips.length;++e){const s=t.clips[e];s.speed=this.speed,this.playing?s.resume():s.pause()}this.blending&&t.clips.length>1&&(t.clips[1].blendWeight=this.blend),t.update(e)}this.blending&&1===this.blend&&(this.blending=!1)}}.prototype,["enabled"]);class Ww{constructor(e,t,s,i,n=1){this._state=e,this._parent=t,this._name=s,Array.isArray(i)?(this._point=new au(i[0],i[1]),this._pointLength=this._point.length()):(this._point=i,this._pointLength=i),this._speed=n,this._weightedSpeed=1,this._weight=1,this._animTrack=null}get parent(){return this._parent}get name(){return this._name}get path(){return this._parent?this._parent.path+"."+this._name:this._name}get point(){return this._point}get pointLength(){return this._pointLength}set weight(e){this._weight=e}get weight(){return this._parent?this._parent.weight*this._weight:this._weight}get normalizedWeight(){const e=this._state.totalWeight;return 0===e?0:this.weight/e}get speed(){return this._weightedSpeed*this._speed}get absoluteSpeed(){return Math.abs(this._speed)}set weightedSpeed(e){this._weightedSpeed=e}get weightedSpeed(){return this._weightedSpeed}set animTrack(e){this._animTrack=e}get animTrack(){return this._animTrack}}class Gw extends Ww{constructor(e,t,s,i,n,r,a,o,l){super(e,t,s,i),this._parameters=n,this._parameterValues=new Array(n.length),this._children=[],this._findParameter=l,this._syncAnimations=!1!==a,this._pointCache={};for(let t=0;t<r.length;t++){const i=r[t];i.children?this._children.push(o(i.type,this,null,s,1,i.parameter?[i.parameter]:i.parameters,i.children,o,l)):this._children.push(new Ww(e,this,i.name,i.point,i.speed))}}get weight(){return this.calculateWeights(),this._parent?this._parent.weight*this._weight:this._weight}get syncAnimations(){return this._syncAnimations}getChild(e){for(let t=0;t<this._children.length;t++)if(this._children[t].name===e)return this._children[t];return null}updateParameterValues(){let e=!0;for(let t=0;t<this._parameterValues.length;t++){const s=this._findParameter(this._parameters[t]).value;this._parameterValues[t]!==s&&(this._parameterValues[t]=s,e=!1)}return e}getNodeWeightedDuration(e){return this._children[e].animTrack.duration/this._children[e].speedMultiplier*this._children[e].weight}getNodeCount(){let e=0;for(let t=0;t<this._children.length;t++){this._children[t].constructor===Gw?e+=this._children[t].getNodeCount():e++}return e}}class jw extends Gw{constructor(e,t,s,i,n,r,a,o,l){r.sort(((e,t)=>e.point-t.point)),super(e,t,s,i,n,r,a,o,l)}calculateWeights(){if(this.updateParameterValues())return;let e=0;this._children[0].weight=0;for(let t=0;t<this._children.length;t++){const s=this._children[t];if(t!==this._children.length-1){const e=this._children[t+1];if(s.point===e.point)s.weight=.5,e.weight=.5;else if(Wd.between(this._parameterValues[0],s.point,e.point,!0)){const t=Math.abs(s.point-e.point),i=(t-Math.abs(s.point-this._parameterValues[0]))/t;s.weight=i,e.weight=1-i}else e.weight=0}this._syncAnimations&&(e+=s.animTrack.duration/s.absoluteSpeed*s.weight)}if(this._syncAnimations)for(let t=0;t<this._children.length;t++){const s=this._children[t];s.weightedSpeed=s.animTrack.duration/s.absoluteSpeed/e}}}class qw extends Gw{pointDistanceCache(e,t){const s=`${e}${t}`;return this._pointCache[s]||(this._pointCache[s]=this._children[t].point.clone().sub(this._children[e].point)),this._pointCache[s]}calculateWeights(){if(this.updateParameterValues())return;let e,t;qw._p.set(...this._parameterValues),e=0,t=0;for(let s=0;s<this._children.length;s++){const i=this._children[s],n=i.point;qw._pip.set(qw._p.x,qw._p.y).sub(n);let r=Number.MAX_VALUE;for(let e=0;e<this._children.length;e++){if(s===e)continue;const t=this.pointDistanceCache(s,e),i=Wd.clamp(1-qw._pip.dot(t)/t.lengthSq(),0,1);i<r&&(r=i)}i.weight=r,e+=r,this._syncAnimations&&(t+=i.animTrack.duration/i.absoluteSpeed*i.weight)}for(let s=0;s<this._children.length;s++){const i=this._children[s];i.weight=i._weight/e,this._syncAnimations&&(i.weightedSpeed=i.animTrack.duration/i.absoluteSpeed/t)}}}qw._p=new au,qw._pip=new au;class Kw extends Gw{pointCache(e,t){const s=`${e}${t}`;return this._pointCache[s]||(this._pointCache[s]=new au((this._children[t].pointLength-this._children[e].pointLength)/((this._children[t].pointLength+this._children[e].pointLength)/2),2*au.angleRad(this._children[e].point,this._children[t].point))),this._pointCache[s]}calculateWeights(){if(this.updateParameterValues())return;let e,t;Kw._p.set(...this._parameterValues);const s=Kw._p.length();e=0,t=0;for(let i=0;i<this._children.length;i++){const n=this._children[i],r=n.point,a=n.pointLength;let o=Number.MAX_VALUE;for(let e=0;e<this._children.length;e++){if(i===e)continue;const t=this.pointCache(i,e),n=this._children[e].pointLength;Kw._pip.set((s-a)/((n+a)/2),2*au.angleRad(r,Kw._p));const l=Wd.clamp(1-Math.abs(Kw._pip.dot(t)/t.lengthSq()),0,1);l<o&&(o=l)}n.weight=o,e+=o,this._syncAnimations&&(t+=n.animTrack.duration/n.absoluteSpeed*n.weight)}for(let s=0;s<this._children.length;s++){const i=this._children[s];if(i.weight=i._weight/e,this._syncAnimations){const s=i.animTrack.duration/t*e;i.weightedSpeed=i.absoluteSpeed*s}}}}Kw._p=new au,Kw._pip=new au;class Xw extends Gw{calculateWeights(){if(this.updateParameterValues())return;let e=0,t=0;for(let s=0;s<this._children.length;s++)if(e+=Math.max(this._parameterValues[s],0),this._syncAnimations){const e=this._children[s];t+=e.animTrack.duration/e.absoluteSpeed*e.weight}for(let s=0;s<this._children.length;s++){const i=this._children[s],n=Math.max(this._parameterValues[s],0);e?(i.weight=n/e,this._syncAnimations&&(i.weightedSpeed=i.animTrack.duration/i.absoluteSpeed/t)):(i.weight=0,this._syncAnimations&&(i.weightedSpeed=0))}}}class Yw{constructor(e,t,s=1,i=!0,n){this._animations={},this._animationList=[],this._controller=e,this._name=t,this._speed=s,this._loop=i,this._hasAnimations=!1,this._blendTree=n?this._createTree(n.type,this,null,t,1,n.parameter?[n.parameter]:n.parameters,n.children,n.syncAnimations,this._createTree,this._controller.findParameter):new Ww(this,null,t,1,s)}_createTree(e,t,s,i,n,r,a,o,l,h){switch(e){case"1D":return new jw(t,s,i,n,r,a,o,l,h);case"2D_CARTESIAN":return new qw(t,s,i,n,r,a,o,l,h);case"2D_DIRECTIONAL":return new Kw(t,s,i,n,r,a,o,l,h);case"DIRECT":return new Xw(t,s,i,n,r,a,o,l,h)}}_getNodeFromPath(e){let t=this._blendTree;for(let s=1;s<e.length;s++)t=t.getChild(e[s]);return t}addAnimation(e,t){const s=e.join("."),i=this._animationList.findIndex((function(e){return e.path===s}));if(i>=0)this._animationList[i].animTrack=t;else{const s=this._getNodeFromPath(e);s.animTrack=t,this._animationList.push(s)}this._updateHasAnimations()}_updateHasAnimations(){this._hasAnimations=this._animationList.length>0&&this._animationList.every((e=>e.animTrack&&e.animTrack!==Nw.EMPTY))}get name(){return this._name}set animations(e){this._animationList=e,this._updateHasAnimations()}get animations(){return this._animationList}get hasAnimations(){return this._hasAnimations}set speed(e){this._speed=e}get speed(){return this._speed}set loop(e){this._loop=e}get loop(){return this._loop}get nodeCount(){return this._blendTree&&this._blendTree.constructor!==Ww?this._blendTree.getNodeCount():1}get playable(){return-1!==kw.indexOf(this.name)||this.animations.length===this.nodeCount}get looping(){if(this.animations.length>0){const e=this.name+"."+this.animations[0].animTrack.name,t=this._controller.animEvaluator.findClip(e);if(t)return t.loop}return!1}get totalWeight(){let e=0;for(let t=0;t<this.animations.length;t++)e+=this.animations[t].weight;return e}get timelineDuration(){let e=0;for(let t=0;t<this.animations.length;t++){const s=this.animations[t];s.animTrack.duration>e&&(e=s.animTrack.duration)}return e}}class Zw{constructor({from:e,to:t,time:s=0,priority:i=0,conditions:n=[],exitTime:r=null,transitionOffset:a=null,interruptionSource:o=Cw}){this._from=e,this._to=t,this._time=s,this._priority=i,this._conditions=n,this._exitTime=r,this._transitionOffset=a,this._interruptionSource=o}get from(){return this._from}set to(e){this._to=e}get to(){return this._to}get time(){return this._time}get priority(){return this._priority}get conditions(){return this._conditions}get exitTime(){return this._exitTime}get transitionOffset(){return this._transitionOffset}get interruptionSource(){return this._interruptionSource}get hasExitTime(){return!!this.exitTime}}class $w{constructor(e,t,s,i,n,r,a){this.findParameter=e=>this._findParameter(e),this._animEvaluator=e,this._states={},this._stateNames=[],this._eventHandler=n,this._findParameter=r,this._consumeTrigger=a;for(let e=0;e<t.length;e++)this._states[t[e].name]=new Yw(this,t[e].name,t[e].speed,t[e].loop,t[e].blendTree),this._stateNames.push(t[e].name);this._transitions=s.map((e=>new Zw(yp({},e)))),this._findTransitionsFromStateCache={},this._findTransitionsBetweenStatesCache={},this._previousStateName=null,this._activeStateName=Mw,this._activeStateDuration=0,this._activeStateDurationDirty=!0,this._playing=!1,this._activate=i,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._transitionInterruptionSource=Cw,this._transitionPreviousStates=[],this._timeInState=0,this._timeInStateBefore=0}get animEvaluator(){return this._animEvaluator}set activeState(e){this._activeStateName=e}get activeState(){return this._findState(this._activeStateName)}get activeStateName(){return this._activeStateName}get activeStateAnimations(){return this.activeState.animations}set previousState(e){this._previousStateName=e}get previousState(){return this._findState(this._previousStateName)}get previousStateName(){return this._previousStateName}get playable(){let e=!0;for(let t=0;t<this._stateNames.length;t++)this._states[this._stateNames[t]].playable||(e=!1);return e}set playing(e){this._playing=e}get playing(){return this._playing}get activeStateProgress(){return this._getActiveStateProgressForTime(this._timeInState)}get activeStateDuration(){if(this._activeStateDurationDirty){let e=0;for(let t=0;t<this.activeStateAnimations.length;t++){const s=this._animEvaluator.findClip(this.activeStateAnimations[t].name);s&&(e=Math.max(e,s.track.duration))}this._activeStateDuration=e,this._activeStateDurationDirty=!1}return this._activeStateDuration}set activeStateCurrentTime(e){this._timeInStateBefore=e,this._timeInState=e;for(let t=0;t<this.activeStateAnimations.length;t++){const s=this.animEvaluator.findClip(this.activeStateAnimations[t].name);s&&(s.time=e)}}get activeStateCurrentTime(){return this._timeInState}get transitioning(){return this._isTransitioning}get transitionProgress(){return this._currTransitionTime/this._totalTransitionTime}get states(){return this._stateNames}assignMask(e){return this._animEvaluator.assignMask(e)}_findState(e){return this._states[e]}_getActiveStateProgressForTime(e){if(this.activeStateName===Mw||this.activeStateName===Lw||this.activeStateName===Dw)return 1;const t=this._animEvaluator.findClip(this.activeStateAnimations[0].name);return t?t.progressForTime(e):null}_findTransitionsFromState(e){let t=this._findTransitionsFromStateCache[e];return t||(t=this._transitions.filter((function(t){return t.from===e})),ob(t),this._findTransitionsFromStateCache[e]=t),t}_findTransitionsBetweenStates(e,t){let s=this._findTransitionsBetweenStatesCache[e+"->"+t];return s||(s=this._transitions.filter((function(s){return s.from===e&&s.to===t})),ob(s),this._findTransitionsBetweenStatesCache[e+"->"+t]=s),s}_transitionHasConditionsMet(e){const t=e.conditions;for(let e=0;e<t.length;e++){const s=t[e],i=this._findParameter(s.parameterName);switch(s.predicate){case"GREATER_THAN":if(!(i.value>s.value))return!1;break;case"LESS_THAN":if(!(i.value<s.value))return!1;break;case"GREATER_THAN_EQUAL_TO":if(!(i.value>=s.value))return!1;break;case"LESS_THAN_EQUAL_TO":if(!(i.value<=s.value))return!1;break;case"EQUAL_TO":if(i.value!==s.value)return!1;break;case"NOT_EQUAL_TO":if(i.value===s.value)return!1}}return!0}_findTransition(e,t){let s=[];if(e&&t)s=s.concat(this._findTransitionsBetweenStates(e,t));else if(this._isTransitioning)switch(this._transitionInterruptionSource){case"PREV_STATE":s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(Dw));break;case"NEXT_STATE":s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(Dw));break;case"PREV_STATE_NEXT_STATE":s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(Dw));break;case"NEXT_STATE_PREV_STATE":s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(Dw))}else s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(Dw));if(s=s.filter((e=>{if(e.to===this.activeStateName)return!1;if(e.hasExitTime){let t=this._getActiveStateProgressForTime(this._timeInStateBefore),s=this._getActiveStateProgressForTime(this._timeInState);if(e.exitTime<1&&this.activeState.loop&&(t-=Math.floor(t),s-=Math.floor(s)),s===t){if(s!==e.exitTime)return null}else if(!(e.exitTime>t&&e.exitTime<=s))return null}return this._transitionHasConditionsMet(e)})),s.length>0){const e=s[0];if(e.to===Lw){const t=this._findTransitionsFromState(Mw)[0];e.to=t.to}return e}return null}updateStateFromTransition(e){let t,s,i;this.previousState=e.from?this.activeStateName:null,this.activeState=e.to,this._activeStateDurationDirty=!0;for(let t=0;t<e.conditions.length;t++){const s=e.conditions[t];this._findParameter(s.parameterName).type===Pw&&this._consumeTrigger(s.parameterName)}if(this.previousState){this._isTransitioning||(this._transitionPreviousStates=[]),this._transitionPreviousStates.push({name:this._previousStateName,weight:1});const e=Math.min(0!==this._totalTransitionTime?this._currTransitionTime/this._totalTransitionTime:1,1);for(let n=0;n<this._transitionPreviousStates.length;n++){this._isTransitioning?n!==this._transitionPreviousStates.length-1?this._transitionPreviousStates[n].weight*=1-e:this._transitionPreviousStates[n].weight=e:this._transitionPreviousStates[n].weight=1,t=this._findState(this._transitionPreviousStates[n].name);for(let e=0;e<t.animations.length;e++)s=t.animations[e],i=this._animEvaluator.findClip(s.name+".previous."+n),i||(i=this._animEvaluator.findClip(s.name),i.name=s.name+".previous."+n),n!==this._transitionPreviousStates.length-1&&i.pause()}}this._isTransitioning=!0,this._totalTransitionTime=e.time,this._currTransitionTime=0,this._transitionInterruptionSource=e.interruptionSource;const n=this.activeState,r=e.transitionOffset&&e.transitionOffset>0&&e.transitionOffset<1;let a=0,o=0;if(r){const t=n.timelineDuration*e.transitionOffset;a=t,o=t}this._timeInState=a,this._timeInStateBefore=o;for(let t=0;t<n.animations.length;t++){if(i=this._animEvaluator.findClip(n.animations[t].name),i)i.reset();else{const e=Number.isFinite(n.animations[t].speed)?n.animations[t].speed:n.speed;i=new Sw(n.animations[t].animTrack,this._timeInState,e,!0,n.loop,this._eventHandler),i.name=n.animations[t].name,this._animEvaluator.addClip(i)}if(e.time>0?i.blendWeight=0:i.blendWeight=n.animations[t].normalizedWeight,i.play(),r)i.time=n.timelineDuration*e.transitionOffset;else{const e=n.speed>=0?0:this.activeStateDuration;i.time=e}}}_transitionToState(e){if(!this._findState(e))return;let t=this._findTransition(this._activeStateName,e);t||(this._animEvaluator.removeClips(),t=new Zw({from:null,to:e})),this.updateStateFromTransition(t)}assignAnimation(e,t,s,i){const n=e.split(".");let r=this._findState(n[0]);r||(r=new Yw(this,n[0],s),this._states[n[0]]=r,this._stateNames.push(n[0])),r.addAnimation(n,t),this._animEvaluator.updateClipTrack(r.name,t),void 0!==s&&(r.speed=s),void 0!==i&&(r.loop=i),!this._playing&&this._activate&&this.playable&&this.play(),this._activeStateDurationDirty=!0}removeNodeAnimations(e){if(-1!==kw.indexOf(e))return!1;const t=this._findState(e);return!!t&&(t.animations=[],!0)}play(e){e&&this._transitionToState(e),this._playing=!0}pause(){this._playing=!1}reset(){this._previousStateName=null,this._activeStateName=Mw,this._playing=!1,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._timeInState=0,this._timeInStateBefore=0,this._animEvaluator.removeClips()}rebind(){this._animEvaluator.rebind()}update(e){if(!this._playing)return;let t,s,i;(this.activeState.loop||this._timeInState<this.activeStateDuration)&&(this._timeInStateBefore=this._timeInState,this._timeInState+=e*this.activeState.speed,!this.activeState.loop&&this._timeInState>this.activeStateDuration&&(this._timeInState=this.activeStateDuration,e=this.activeStateDuration-this._timeInStateBefore));const n=this._findTransition(this._activeStateName);if(n&&this.updateStateFromTransition(n),this._isTransitioning)if(this._currTransitionTime+=e,this._currTransitionTime<=this._totalTransitionTime){const e=0!==this._totalTransitionTime?this._currTransitionTime/this._totalTransitionTime:1;for(let n=0;n<this._transitionPreviousStates.length;n++){t=this._findState(this._transitionPreviousStates[n].name);const r=this._transitionPreviousStates[n].weight;for(let a=0;a<t.animations.length;a++)s=t.animations[a],i=this._animEvaluator.findClip(s.name+".previous."+n),i&&(i.blendWeight=(1-e)*s.normalizedWeight*r)}t=this.activeState;for(let i=0;i<t.animations.length;i++)s=t.animations[i],this._animEvaluator.findClip(s.name).blendWeight=e*s.normalizedWeight}else{this._isTransitioning=!1;const e=this.activeStateAnimations.length,n=this._animEvaluator.clips.length;for(let t=0;t<n-e;t++)this._animEvaluator.removeClip(0);this._transitionPreviousStates=[],t=this.activeState;for(let e=0;e<t.animations.length;e++)s=t.animations[e],i=this._animEvaluator.findClip(s.name),i&&(i.blendWeight=s.normalizedWeight)}else if(this.activeState._blendTree.constructor!==Ww){t=this.activeState;for(let e=0;e<t.animations.length;e++)s=t.animations[e],i=this._animEvaluator.findClip(s.name),i&&(i.blendWeight=s.normalizedWeight,s.parent.syncAnimations&&(i.speed=s.speed))}this._animEvaluator.update(e,this.activeState.hasAnimations)}}const Qw=new au,Jw=new nu,eS=new ou,tS=new jd,sS=new _u;class iS extends Hw{constructor(e,t,s,i,n){super(t),this.animComponent=e,this._mask=i,this.layerName=s,this.layerIndex=n}static _packFloat(e){return e[0]}static _packBoolean(e){return!!e[0]}static _packVec2(e){return Qw.x=e[0],Qw.y=e[1],Qw}static _packVec3(e){return Jw.x=e[0],Jw.y=e[1],Jw.z=e[2],Jw}static _packVec4(e){return eS.x=e[0],eS.y=e[1],eS.z=e[2],eS.w=e[3],eS}static _packColor(e){return tS.r=e[0],tS.g=e[1],tS.b=e[2],tS.a=e[3],tS}static _packQuat(e){return sS.x=e[0],sS.y=e[1],sS.z=e[2],sS.w=e[3],sS}resolve(e){const t=Bw.encode(e.entityPath,e.component,e.propertyPath);let s,i,n,r=this.targetCache[t];if(r)return r;switch(e.component){case"entity":s=this._getEntityFromHierarchy(e.entityPath),n=Bw.encode(s.path,"entity",e.propertyPath),i=s;break;case"graph":if(i=this.findNode(e),!i)return null;n=Bw.encode(i.path,"graph",e.propertyPath);break;default:if(s=this._getEntityFromHierarchy(e.entityPath),i=s.findComponent(e.component),!i)return null;n=Bw.encode(s.path,e.component,e.propertyPath)}return r=this._createAnimTargetForProperty(i,e.propertyPath,n),this.targetCache[t]=r,r}update(e){const t=this.activeNodes;if(t)for(let e=0;e<t.length;e++)t[e]._dirtifyLocal()}_getEntityFromHierarchy(e){if(!this.animComponent.entity.name===e[0])return null;const t=this.animComponent.entity;return 1===e.length?t:t._parent.findByPath(e)}_resolvePath(e,t,s){const i=t.length-(s?0:1);for(let s=0;s<i;s++)e=e[t[s]];return e}_setter(e,t,s){const i=this._resolvePath(e,t),n=t[t.length-1],r="set"+n.substring(0,1).toUpperCase()+n.substring(1);if(i[r]){let e=i["get"+n.substring(0,1).toUpperCase()+n.substring(1)].bind(i)();e=[e.x,e.y,e.z,e.w];const t=i[r].bind(i);return{set:e=>{t(s(e))},get:()=>e}}const a=i[n];if("object"==typeof a&&a.hasOwnProperty("copy"))return function(e){a.copy(s(e))};if(-1!==[au,nu,ou,jd,_u].indexOf(i.constructor)&&t.length>1){const r=t.length>2?this._resolvePath(e,t.slice(0,-1)):e,a=t[t.length-2];return function(e){i[n]=s(e),r[a]=i}}return function(e){i[n]=s(e)}}_createAnimTargetForProperty(e,t,s){if(this.handlers&&t[0].startsWith("weight."))return this.handlers.weight(e,t[0].replace("weight.",""));if(this.handlers&&"material"===t[0]&&2===t.length){const s=t[1];if(s.endsWith("Map"))return this.handlers.materialTexture(e,s)}const i=this._resolvePath(e,t,!0);if(void 0===i)return null;let n,r,a;if("number"==typeof i)n=this._setter(e,t,iS._packFloat),r="vector",a=1;else if("boolean"==typeof i)n=this._setter(e,t,iS._packBoolean),r="vector",a=1;else if("object"==typeof i)switch(i.constructor){case au:n=this._setter(e,t,iS._packVec2),r="vector",a=2;break;case nu:n=this._setter(e,t,iS._packVec3),r="vector",a=3;break;case ou:n=this._setter(e,t,iS._packVec4),r="vector",a=4;break;case jd:n=this._setter(e,t,iS._packColor),r="vector",a=4;break;case _u:n=this._setter(e,t,iS._packQuat),r="quaternion",a=4;break;default:return null}return-1!==t.indexOf("material")?new Uw((function(t){n(t),e.material.update()}),r,a,s):new Uw(n,r,a,s)}rebind(){this.targetCache={},this.animComponent.rootBone?this.graph=this.animComponent.rootBone:this.graph=this.animComponent.entity;const e={};!function t(s){e[s.name]=s;for(let e=0;e<s.children.length;++e)t(s.children[e])}(this.graph),this.nodes=e}}class nS{constructor(e,t,s,i=1,n=Iw,r=!0){this._name=e,this._controller=t,this._component=s,this._weight=i,this._blendType=n,this._normalizedWeight=r,this._mask=null,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0}get name(){return this._name}set playing(e){this._controller.playing=e}get playing(){return this._controller.playing}get playable(){return this._controller.playable}get activeState(){return this._controller.activeStateName}get previousState(){return this._controller.previousStateName}get activeStateProgress(){return this._controller.activeStateProgress}get activeStateDuration(){return this._controller.activeStateDuration}set activeStateCurrentTime(e){const t=this._controller,s=t.playing;t.playing=!0,t.activeStateCurrentTime=e,s||t.update(0),t.playing=s}get activeStateCurrentTime(){return this._controller.activeStateCurrentTime}get transitioning(){return this._controller.transitioning}get transitionProgress(){return this.transitioning?this._controller.transitionProgress:null}get states(){return this._controller.states}set weight(e){this._weight=e,this._component.dirtifyTargets()}get weight(){return this._weight}set blendType(e){e!==this._blendType&&(this._blendType=e,this._controller.normalizeWeights&&this._component.rebind())}get blendType(){return this._blendType}set mask(e){this._controller.assignMask(e)&&this._component.rebind(),this._mask=e}get mask(){return this._mask}play(e){this._controller.play(e)}pause(){this._controller.pause()}reset(){this._controller.reset()}rebind(){this._controller.rebind()}update(e){this._blendTime&&(this._blendTimeElapsed<this._blendTime?(this.weight=Wd.lerp(this._startingWeight,this._targetWeight,this._blendTimeElapsed/this._blendTime),this._blendTimeElapsed+=e):(this.weight=this._targetWeight,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0)),this._controller.update(e)}blendToWeight(e,t){this._startingWeight=this.weight,this._targetWeight=e,this._blendTime=Math.max(0,t),this._blendTimeElapsed=0}assignMask(e){this._controller.assignMask(e)&&this._component.rebind(),this._mask=e}assignAnimation(e,t,s,i){t instanceof Nw&&(this._controller.assignAnimation(e,t,s,i),0===this._controller._transitions.length&&this._controller._transitions.push(new Zw({from:"START",to:e})),this._component.activate&&this._component.playable&&(this._component.playing=!0))}removeNodeAnimations(e){this._controller.removeNodeAnimations(e)&&(this._component.playing=!1)}getAnimationAsset(e){return this._component.animationAssets[`${this.name}:${e}`]}transition(e,t=0,s=null){this._controller.updateStateFromTransition(new Zw({from:this._controller.activeStateName,to:e,time:t,transitionOffset:s}))}}class rS{constructor(e){if(this._layers=[],this._parameters={},Array.isArray(e.layers))this._layers=e.layers;else for(const t in e.layers){const s=e.layers[t],i={name:s.name,blendType:s.blendType,weight:s.weight,states:[],transitions:[]};for(let t=0;t<s.states.length;t++)i.states.push(e.states[s.states[t]]);for(let t=0;t<s.transitions.length;t++){const n=e.transitions[s.transitions[t]];if(n.conditions&&!Array.isArray(n.conditions)){const e=Object.keys(n.conditions),t=[];for(let s=0;s<e.length;s++){const i=n.conditions[e[s]];i.parameterName&&t.push(i)}n.conditions=t}Number.isInteger(n.from)&&(n.from=e.states[n.from].name),Number.isInteger(n.to)&&(n.to=e.states[n.to].name),i.transitions.push(n)}this._layers.push(i)}for(const t in e.parameters){const s=e.parameters[t];this._parameters[s.name]={type:s.type,value:s.value}}}get parameters(){return Object.assign({},this._parameters)}get layers(){return this._layers}}vw._buildAccessors(class extends vw{constructor(e,t){super(e,t),this.findParameter=e=>this._parameters[e],this.consumeTrigger=e=>{this._consumedTriggers.add(e)},this._stateGraphAsset=null,this._animationAssets={},this._speed=1,this._activate=!0,this._playing=!1,this._rootBone=null,this._stateGraph=null,this._layers=[],this._layerIndices={},this._parameters={},this._targets={},this._consumedTriggers=new Set,this._normalizeWeights=!1}set stateGraphAsset(e){if(null===e)return void this.removeStateGraph();if(this._stateGraphAsset){this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this)}let t,s;e instanceof Yx?(t=e.id,s=this.system.app.assets.get(t),s||(this.system.app.assets.add(e),s=this.system.app.assets.get(t))):(t=e,s=this.system.app.assets.get(t)),s&&this._stateGraphAsset!==t&&(s.resource?(this._stateGraph=s.resource,this.loadStateGraph(this._stateGraph),s.on("change",this._onStateGraphAssetChangeEvent,this)):(s.once("load",(e=>{this._stateGraph=e.resource,this.loadStateGraph(this._stateGraph)})),s.on("change",this._onStateGraphAssetChangeEvent,this),this.system.app.assets.load(s)),this._stateGraphAsset=t)}get stateGraphAsset(){return this._stateGraphAsset}set normalizeWeights(e){this._normalizeWeights=e,this.unbind()}get normalizeWeights(){return this._normalizeWeights}set animationAssets(e){this._animationAssets=e,this.loadAnimationAssets()}get animationAssets(){return this._animationAssets}set speed(e){this._speed=e}get speed(){return this._speed}set activate(e){this._activate=e}get activate(){return this._activate}set playing(e){this._playing=e}get playing(){return this._playing}set rootBone(e){if("string"==typeof e){const t=this.entity.root.findByGuid(e);this._rootBone=t}else this._rootBone=e instanceof hw?e:null;this.rebind()}get rootBone(){return this._rootBone}set stateGraph(e){this._stateGraph=e}get stateGraph(){return this._stateGraph}get layers(){return this._layers}set layerIndices(e){this._layerIndices=e}get layerIndices(){return this._layerIndices}set parameters(e){this._parameters=e}get parameters(){return this._parameters}set targets(e){this._targets=e}get targets(){return this._targets}get playable(){for(let e=0;e<this._layers.length;e++)if(!this._layers[e].playable)return!1;return!0}get baseLayer(){return this._layers.length>0?this._layers[0]:null}_onStateGraphAssetChangeEvent(e){const t=this.animationAssets,s=this.layers.map((e=>e.mask));this.removeStateGraph(),this._stateGraph=new rS(e._data),this.loadStateGraph(this._stateGraph),this.animationAssets=t,this.loadAnimationAssets(),this.layers.forEach(((e,t)=>{e.mask=s[t]})),this.rebind()}dirtifyTargets(){const e=Object.values(this._targets);for(let t=0;t<e.length;t++)e[t].dirty=!0}_addLayer({name:e,states:t,transitions:s,weight:i,mask:n,blendType:r}){let a;a=this.rootBone?this.rootBone:this.entity;const o=this._layers.length,l=new iS(this,a,e,n,o),h=new zw(l),c=new $w(h,t,s,this._activate,this,this.findParameter,this.consumeTrigger);return this._layers.push(new nS(e,c,this,i,r)),this._layerIndices[e]=o,this._layers[o]}addLayer(e,t,s,i){const n=this.findAnimationLayer(e);if(n)return n;return this._addLayer({name:e,states:[{name:"START",speed:1}],transitions:[],weight:t,mask:s,blendType:i})}_assignParameters(e){this._parameters={};const t=Object.keys(e.parameters);for(let s=0;s<t.length;s++){const i=t[s];this._parameters[i]={type:e.parameters[i].type,value:e.parameters[i].value}}}loadStateGraph(e){this._stateGraph=e,this._assignParameters(e),this._layers=[];let t=!1;for(let s=0;s<e.layers.length;s++){const i=e.layers[s];this._addLayer(yp({},i)),i.states.some((e=>e.blendTree))&&(t=!0)}t||this.setupAnimationAssets()}setupAnimationAssets(){for(let e=0;e<this._layers.length;e++){const t=this._layers[e],s=t.name;for(let e=0;e<t.states.length;e++){const i=t.states[e];if(-1===kw.indexOf(i)){const e=s+":"+i;this._animationAssets[e]||(this._animationAssets[e]={asset:null})}}}this.loadAnimationAssets()}loadAnimationAssets(){for(let e=0;e<this._layers.length;e++){const t=this._layers[e];for(let e=0;e<t.states.length;e++){const s=t.states[e];if(-1!==kw.indexOf(s))continue;const i=this._animationAssets[t.name+":"+s];if(!i||!i.asset){this.findAnimationLayer(t.name).assignAnimation(s,Nw.EMPTY);continue}const n=i.asset,r=this.system.app.assets.get(n);r&&(r.resource?this.onAnimationAssetLoaded(t.name,s,r):(r.once("load",function(e,t){return function(s){this.onAnimationAssetLoaded(e,t,s)}.bind(this)}.bind(this)(t.name,s)),this.system.app.assets.load(r)))}}}onAnimationAssetLoaded(e,t,s){this.findAnimationLayer(e).assignAnimation(t,s.resource)}removeStateGraph(){this._stateGraph=null,this._stateGraphAsset=null,this._animationAssets={},this._layers=[],this._layerIndices={},this._parameters={},this._playing=!1,this.unbind(),this._targets={}}reset(){this._assignParameters(this._stateGraph);for(let e=0;e<this._layers.length;e++){const t=this._layers[e].playing;this._layers[e].reset(),this._layers[e].playing=t}}unbind(){this._normalizeWeights||Object.keys(this._targets).forEach((e=>{this._targets[e].unbind()}))}rebind(){this._targets={};for(let e=0;e<this._layers.length;e++)this._layers[e].rebind()}findAnimationLayer(e){const t=this._layerIndices[e];return this._layers[t]||null}addAnimationState(e,t,s=1,i=!0,n="Base"){this._stateGraph||this.loadStateGraph(new rS({layers:[{name:n,states:[{name:"START",speed:1},{name:e,speed:s,loop:i,defaultState:!0}],transitions:[{from:"START",to:e}]}],parameters:{}}));const r=this.findAnimationLayer(n);var a;r?r.assignAnimation(e,t,s,i):null==(a=this.addLayer(n))||a.assignAnimation(e,t,s,i)}assignAnimation(e,t,s,i=1,n=!0){if(!this._stateGraph&&-1===e.indexOf("."))return this.loadStateGraph(new rS({layers:[{name:"Base",states:[{name:"START",speed:1},{name:e,speed:i,loop:n,defaultState:!0}],transitions:[{from:"START",to:e}]}],parameters:{}})),void this.baseLayer.assignAnimation(e,t);const r=s?this.findAnimationLayer(s):this.baseLayer;r&&r.assignAnimation(e,t,i,n)}removeNodeAnimations(e,t){const s=t?this.findAnimationLayer(t):this.baseLayer;s&&s.removeNodeAnimations(e)}getParameterValue(e,t){const s=this._parameters[e];if(s&&s.type===t)return s.value}setParameterValue(e,t,s){const i=this._parameters[e];i&&i.type===t&&(i.value=s)}getFloat(e){return this.getParameterValue(e,Aw)}setFloat(e,t){this.setParameterValue(e,Aw,t)}getInteger(e){return this.getParameterValue(e,Tw)}setInteger(e,t){"number"==typeof t&&t%1==0&&this.setParameterValue(e,Tw,t)}getBoolean(e){return this.getParameterValue(e,Ew)}setBoolean(e,t){this.setParameterValue(e,Ew,!!t)}getTrigger(e){return this.getParameterValue(e,Pw)}setTrigger(e,t=!1){this.setParameterValue(e,Pw,!0),t&&this._consumedTriggers.add(e)}resetTrigger(e){this.setParameterValue(e,Pw,!1)}onBeforeRemove(){if(Number.isFinite(this._stateGraphAsset)){this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this)}}update(e){for(let t=0;t<this.layers.length;t++)this.layers[t].update(e*this.speed);this._consumedTriggers.forEach((e=>{this.parameters[e].value=!1})),this._consumedTriggers.clear()}resolveDuplicatedEntityReferenceProperties(e,t){e.rootBone&&t[e.rootBone.getGuid()]?this.rootBone=t[e.rootBone.getGuid()]:this.rebind()}}.prototype,["enabled"]);vw._buildAccessors(class extends vw{constructor(e,t){super(e,t)}setCurrentListener(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;const e=this.system.current.getPosition();this.system.manager.listener.setPosition(e)}}onEnable(){this.setCurrentListener()}onDisable(){this.system.current===this.entity&&(this.system.current=null)}}.prototype,["enabled"]);vw._buildAccessors(class extends vw{constructor(e,t){super(e,t),this.on("set_assets",this.onSetAssets,this),this.on("set_loop",this.onSetLoop,this),this.on("set_volume",this.onSetVolume,this),this.on("set_pitch",this.onSetPitch,this),this.on("set_minDistance",this.onSetMinDistance,this),this.on("set_maxDistance",this.onSetMaxDistance,this),this.on("set_rollOffFactor",this.onSetRollOffFactor,this),this.on("set_distanceModel",this.onSetDistanceModel,this),this.on("set_3d",this.onSet3d,this)}play(e){if(!this.enabled||!this.entity.enabled)return;let t;this.channel&&this.stop();const s=this.data;if(s.sources[e])if(s["3d"]){const i=this.entity.getPosition();t=this.system.manager.playSound3d(s.sources[e],i,s),s.currentSource=e,s.channel=t}else t=this.system.manager.playSound(s.sources[e],s),s.currentSource=e,s.channel=t}pause(){this.channel&&this.channel.pause()}unpause(){this.channel&&this.channel.paused&&this.channel.unpause()}stop(){this.channel&&(this.channel.stop(),this.channel=null)}onSetAssets(e,t,s){const i=[],n=s.length;if(t&&t.length)for(let e=0;e<t.length;e++)if(t[e]){const s=this.system.app.assets.get(t[e]);s&&(s.off("change",this.onAssetChanged,this),s.off("remove",this.onAssetRemoved,this),this.currentSource===s.name&&this.stop())}if(n)for(let e=0;e<n;e++)t.indexOf(s[e])<0&&(s[e]instanceof Yx?i.push(s[e].id):i.push(s[e]));!this.system._inTools&&i.length&&this.loadAudioSourceAssets(i)}onAssetChanged(e,t,s,i){if("resource"===t){this.data.sources&&(this.data.sources[e.name]=s,this.data.currentSource===e.name&&this.channel&&(this.channel.paused?(this.play(e.name),this.pause()):this.play(e.name)))}}onAssetRemoved(e){e.off("remove",this.onAssetRemoved,this),this.data.sources[e.name]&&(delete this.data.sources[e.name],this.data.currentSource===e.name&&(this.stop(),this.data.currentSource=null))}onSetLoop(e,t,s){t!==s&&this.channel&&this.channel.setLoop(s)}onSetVolume(e,t,s){t!==s&&this.channel&&this.channel.setVolume(s)}onSetPitch(e,t,s){t!==s&&this.channel&&this.channel.setPitch(s)}onSetMaxDistance(e,t,s){t!==s&&this.channel instanceof S_&&this.channel.setMaxDistance(s)}onSetMinDistance(e,t,s){t!==s&&this.channel instanceof S_&&this.channel.setMinDistance(s)}onSetRollOffFactor(e,t,s){t!==s&&this.channel instanceof S_&&this.channel.setRollOffFactor(s)}onSetDistanceModel(e,t,s){t!==s&&this.channel instanceof S_&&this.channel.setDistanceModel(s)}onSet3d(e,t,s){if(t!==s&&this.system.initialized&&this.currentSource){let e=!1,t=!1;this.channel&&(e=this.channel.paused,t=this.channel.suspended),this.play(this.currentSource),this.channel&&(this.channel.paused=e,this.channel.suspended=t)}}onEnable(){const e=this.data.assets;if(e){const t=this.system.app.assets;for(let s=0,i=e.length;s<i;s++){let i=e[s];i instanceof Yx||(i=t.get(i)),i&&!i.resource&&t.load(i)}}this.system.initialized&&(this.data.activate&&!this.channel?this.play(this.currentSource):this.unpause())}onDisable(){this.pause()}loadAudioSourceAssets(e){const t=e.map((e=>this.system.app.assets.get(e))),s={};let i=null,n=t.length;const r=e=>{n--},a=()=>{this.data.sources=s,this.data.currentSource=i,this.enabled&&this.activate&&i&&this.onEnable()};t.forEach(((t,o)=>{t?(i=i||t.name,t.off("change",this.onAssetChanged,this),t.on("change",this.onAssetChanged,this),t.off("remove",this.onAssetRemoved,this),t.on("remove",this.onAssetRemoved,this),t.off("error",r,this),t.on("error",r,this),t.ready((e=>{s[e.name]=e.resource,n--,0===n&&a()})),!t.resource&&this.enabled&&this.entity.enabled&&this.system.app.assets.load(t)):(n--,0===n&&a(),this.system.app.assets.on("add:"+e[o],(e=>{e.ready((e=>{this.data.sources[e.name]=e.resource})),e.resource||this.system.app.assets.load(e)})))}))}}.prototype,["enabled","assets","volume","pitch","loop","activate","3d","minDistance","maxDistance","rollOffFactor","distanceModel","sources","currentSource","channel"]);class aS extends od{constructor(e,t,s){if(super(),!(e&&e instanceof vw))throw new Error("The parentComponent argument is required and must be a Component");if(!t||"string"!=typeof t)throw new Error("The propertyName argument is required and must be a string");if(s&&"object"!=typeof s)throw new Error("If provided, the eventConfig argument must be an object");this._parentComponent=e,this._entityPropertyName=t,this._entity=null,this._app=e.system.app,this._configureEventListeners(s||{},{"entity#destroy":this._onEntityDestroy}),this._toggleLifecycleListeners("on")}_configureEventListeners(e,t){const s=this._parseEventListenerConfig(e,"external",this._parentComponent),i=this._parseEventListenerConfig(t,"internal",this);this._eventListenerConfigs=s.concat(i),this._listenerStatusFlags={},this._gainListeners={},this._loseListeners={}}_parseEventListenerConfig(e,t,s){return Object.keys(e).map((function(i,n){const r=i.split("#"),a=r[0],o=r[1],l=e[i];if(2!==r.length||"string"!=typeof a||0===a.length||"string"!=typeof o||0===o.length)throw new Error("Invalid event listener description: `"+i+"`");if("function"!=typeof l)throw new Error("Invalid or missing callback for event listener `"+i+"`");return{id:t+"_"+n+"_"+i,sourceName:a,eventName:o,callback:l,scope:s}}),this)}_toggleLifecycleListeners(e){this._parentComponent[e]("set_"+this._entityPropertyName,this._onSetEntity,this),this._parentComponent.system[e]("beforeremove",this._onParentComponentRemove,this),this._app.systems[e]("postPostInitialize",this._updateEntityReference,this),this._app[e]("tools:sceneloaded",this._onSceneLoaded,this);const t=[];for(let e=0;e<this._eventListenerConfigs.length;++e){const s=this._eventListenerConfigs[e],i=this._app.systems[s.sourceName];i&&(-1===t.indexOf(i)&&t.push(i),i&&"gain"===s.eventName&&(this._gainListeners[s.sourceName]=s),i&&"lose"===s.eventName&&(this._loseListeners[s.sourceName]=s))}for(let s=0;s<t.length;++s)t[s][e]("add",this._onComponentAdd,this),t[s][e]("beforeremove",this._onComponentRemove,this)}_onSetEntity(e,t,s){if(s instanceof hw)this._updateEntityReference();else{if(null!=s&&"string"!=typeof s)return void console.warn("Entity field `"+this._entityPropertyName+"` was set to unexpected type '"+typeof s+"'");t!==s&&this._updateEntityReference()}}onParentComponentEnable(){this._entity||this._updateEntityReference()}_onSceneLoaded(){this._updateEntityReference()}_updateEntityReference(){let e,t=this._parentComponent.data[this._entityPropertyName];if(t instanceof hw)e=t,t=e.getGuid(),this._parentComponent.data[this._entityPropertyName]=t;else{const s=this._parentComponent.system.app.root;e=this._parentComponent.entity.isDescendantOf(s)&&t?s.findByGuid(t):null}this._entity!==e&&(this._entity&&this._onBeforeEntityChange(),this._entity=e,this._entity&&this._onAfterEntityChange(),this.fire("set:entity",this._entity))}_onBeforeEntityChange(){this._toggleEntityListeners("off"),this._callAllGainOrLoseListeners(this._loseListeners)}_onAfterEntityChange(){this._toggleEntityListeners("on"),this._callAllGainOrLoseListeners(this._gainListeners)}_onComponentAdd(e,t){const s=t.system.id;e===this._entity&&(this._callGainOrLoseListener(s,this._gainListeners),this._toggleComponentListeners("on",s))}_onComponentRemove(e,t){const s=t.system.id;e===this._entity&&(this._callGainOrLoseListener(s,this._loseListeners),this._toggleComponentListeners("off",s,!0))}_callAllGainOrLoseListeners(e){for(const t in this._entity.c)this._callGainOrLoseListener(t,e)}_callGainOrLoseListener(e,t){if(this._entity.c.hasOwnProperty(e)&&t[e]){const s=t[e];s.callback.call(s.scope)}}_toggleEntityListeners(e,t){if(this._entity)for(let s=0;s<this._eventListenerConfigs.length;++s)this._safeToggleListener(e,this._eventListenerConfigs[s],t)}_toggleComponentListeners(e,t,s){for(let i=0;i<this._eventListenerConfigs.length;++i){const n=this._eventListenerConfigs[i];n.sourceName===t&&this._safeToggleListener(e,n,s)}}_safeToggleListener(e,t,s){const i="on"===e;if(i&&this._listenerStatusFlags[t.id])return;const n=this._getEventSource(t.sourceName,s);n&&(n[e](t.eventName,t.callback,t.scope),this._listenerStatusFlags[t.id]=i)}_getEventSource(e,t){if("entity"===e)return this._entity;const s=this._entity[e];return s||(t||console.warn("Entity has no component with name "+e),null)}_onEntityDestroy(e){this._entity===e&&(this._toggleEntityListeners("off",!0),this._entity=null)}_onParentComponentRemove(e,t){t===this._parentComponent&&(this._toggleLifecycleListeners("off"),this._toggleEntityListeners("off",!0))}hasComponent(e){return!(!this._entity||!this._entity.c)&&!!this._entity.c[e]}get entity(){return this._entity}}const oS="group",lS="stretch",hS="DEFAULT",cS="HOVER",dS="PRESSED",uS="INACTIVE",pS={};pS[hS]="_defaultTint",pS[cS]="hoverTint",pS[dS]="pressedTint",pS[uS]="inactiveTint";const mS={};mS[hS]="_defaultSpriteAsset",mS[cS]="hoverSpriteAsset",mS[dS]="pressedSpriteAsset",mS[uS]="inactiveSpriteAsset";const _S={};_S[hS]="_defaultSpriteFrame",_S[cS]="hoverSpriteFrame",_S[dS]="pressedSpriteFrame",_S[uS]="inactiveSpriteFrame";class fS extends vw{constructor(e,t){super(e,t),this._visualState=hS,this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._defaultTint=new jd(1,1,1,1),this._defaultSpriteAsset=null,this._defaultSpriteFrame=0,this._imageReference=new aS(this,"imageEntity",{"element#gain":this._onImageElementGain,"element#lose":this._onImageElementLose,"element#set:color":this._onSetColor,"element#set:opacity":this._onSetOpacity,"element#set:spriteAsset":this._onSetSpriteAsset,"element#set:spriteFrame":this._onSetSpriteFrame}),this._toggleLifecycleListeners("on",e)}_toggleLifecycleListeners(e,t){this[e]("set_active",this._onSetActive,this),this[e]("set_transitionMode",this._onSetTransitionMode,this),this[e]("set_hoverTint",this._onSetTransitionValue,this),this[e]("set_pressedTint",this._onSetTransitionValue,this),this[e]("set_inactiveTint",this._onSetTransitionValue,this),this[e]("set_hoverSpriteAsset",this._onSetTransitionValue,this),this[e]("set_hoverSpriteFrame",this._onSetTransitionValue,this),this[e]("set_pressedSpriteAsset",this._onSetTransitionValue,this),this[e]("set_pressedSpriteFrame",this._onSetTransitionValue,this),this[e]("set_inactiveSpriteAsset",this._onSetTransitionValue,this),this[e]("set_inactiveSpriteFrame",this._onSetTransitionValue,this),t.app.systems.element[e]("add",this._onElementComponentAdd,this),t.app.systems.element[e]("beforeremove",this._onElementComponentRemove,this)}_onSetActive(e,t,s){t!==s&&this._updateVisualState()}_onSetTransitionMode(e,t,s){t!==s&&(this._cancelTween(),this._resetToDefaultVisualState(t),this._forceReapplyVisualState())}_onSetTransitionValue(e,t,s){t!==s&&this._forceReapplyVisualState()}_onElementComponentRemove(e){this.entity===e&&this._toggleHitElementListeners("off")}_onElementComponentAdd(e){this.entity===e&&this._toggleHitElementListeners("on")}_onImageElementLose(){this._cancelTween(),this._resetToDefaultVisualState(this.transitionMode)}_onImageElementGain(){this._storeDefaultVisualState(),this._forceReapplyVisualState()}_toggleHitElementListeners(e){if(this.entity.element){const t="on"===e;if(t&&this._hasHitElementListeners)return;this.entity.element[e]("mouseenter",this._onMouseEnter,this),this.entity.element[e]("mouseleave",this._onMouseLeave,this),this.entity.element[e]("mousedown",this._onMouseDown,this),this.entity.element[e]("mouseup",this._onMouseUp,this),this.entity.element[e]("touchstart",this._onTouchStart,this),this.entity.element[e]("touchend",this._onTouchEnd,this),this.entity.element[e]("touchleave",this._onTouchLeave,this),this.entity.element[e]("touchcancel",this._onTouchCancel,this),this.entity.element[e]("selectstart",this._onSelectStart,this),this.entity.element[e]("selectend",this._onSelectEnd,this),this.entity.element[e]("selectenter",this._onSelectEnter,this),this.entity.element[e]("selectleave",this._onSelectLeave,this),this.entity.element[e]("click",this._onClick,this),this._hasHitElementListeners=t}}_storeDefaultVisualState(){if(this._imageReference.hasComponent("element")){const e=this._imageReference.entity.element;e.type!==oS&&(this._storeDefaultColor(e.color),this._storeDefaultOpacity(e.opacity),this._storeDefaultSpriteAsset(e.spriteAsset),this._storeDefaultSpriteFrame(e.spriteFrame))}}_storeDefaultColor(e){this._defaultTint.r=e.r,this._defaultTint.g=e.g,this._defaultTint.b=e.b}_storeDefaultOpacity(e){this._defaultTint.a=e}_storeDefaultSpriteAsset(e){this._defaultSpriteAsset=e}_storeDefaultSpriteFrame(e){this._defaultSpriteFrame=e}_onSetColor(e){this._isApplyingTint||(this._storeDefaultColor(e),this._forceReapplyVisualState())}_onSetOpacity(e){this._isApplyingTint||(this._storeDefaultOpacity(e),this._forceReapplyVisualState())}_onSetSpriteAsset(e){this._isApplyingSprite||(this._storeDefaultSpriteAsset(e),this._forceReapplyVisualState())}_onSetSpriteFrame(e){this._isApplyingSprite||(this._storeDefaultSpriteFrame(e),this._forceReapplyVisualState())}_onMouseEnter(e){this._isHovering=!0,this._updateVisualState(),this._fireIfActive("mouseenter",e)}_onMouseLeave(e){this._isHovering=!1,this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseleave",e)}_onMouseDown(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("mousedown",e)}_onMouseUp(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseup",e)}_onTouchStart(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("touchstart",e)}_onTouchEnd(e){e.event.preventDefault(),this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchend",e)}_onTouchLeave(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchleave",e)}_onTouchCancel(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchcancel",e)}_onSelectStart(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("selectstart",e)}_onSelectEnd(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("selectend",e)}_onSelectEnter(e){this._hoveringCounter++,1===this._hoveringCounter&&(this._isHovering=!0,this._updateVisualState()),this._fireIfActive("selectenter",e)}_onSelectLeave(e){this._hoveringCounter--,0===this._hoveringCounter&&(this._isHovering=!1,this._isPressed=!1,this._updateVisualState()),this._fireIfActive("selectleave",e)}_onClick(e){this._fireIfActive("click",e)}_fireIfActive(e,t){this.data.active&&this.fire(e,t)}_updateVisualState(e){const t=this._visualState,s=this._determineVisualState();if((t!==s||e)&&this.enabled)switch(this._visualState=s,t===cS&&this._fireIfActive("hoverend"),t===dS&&this._fireIfActive("pressedend"),s===cS&&this._fireIfActive("hoverstart"),s===dS&&this._fireIfActive("pressedstart"),this.transitionMode){case 0:{const e=this[pS[this._visualState]];this._applyTint(e);break}case 1:{const e=mS[this._visualState],t=_S[this._visualState],s=this[e],i=this[t];this._applySprite(s,i);break}}}_forceReapplyVisualState(){this._updateVisualState(!0)}_resetToDefaultVisualState(e){if(this._imageReference.hasComponent("element"))switch(e){case 0:this._cancelTween(),this._applyTintImmediately(this._defaultTint);break;case 1:this._applySprite(this._defaultSpriteAsset,this._defaultSpriteFrame)}}_determineVisualState(){return this.active?this._isPressed?dS:this._isHovering?cS:hS:uS}_applySprite(e,t){t=t||0,this._imageReference.hasComponent("element")&&(this._isApplyingSprite=!0,this._imageReference.entity.element.spriteAsset!==e&&(this._imageReference.entity.element.spriteAsset=e),this._imageReference.entity.element.spriteFrame!==t&&(this._imageReference.entity.element.spriteFrame=t),this._isApplyingSprite=!1)}_applyTint(e){this._cancelTween(),0===this.fadeDuration?this._applyTintImmediately(e):this._applyTintWithTween(e)}_applyTintImmediately(e){if(!e||!this._imageReference.hasComponent("element")||this._imageReference.entity.element.type===oS)return;const t=gS(e);this._isApplyingTint=!0,t.equals(this._imageReference.entity.element.color)||(this._imageReference.entity.element.color=t),this._imageReference.entity.element.opacity!==e.a&&(this._imageReference.entity.element.opacity=e.a),this._isApplyingTint=!1}_applyTintWithTween(e){if(!e||!this._imageReference.hasComponent("element")||this._imageReference.entity.element.type===oS)return;const t=gS(e),s=this._imageReference.entity.element.color,i=this._imageReference.entity.element.opacity;t.equals(s)&&e.a===i||(this._tweenInfo={startTime:Bd(),from:new jd(s.r,s.g,s.b,i),to:e.clone(),lerpColor:new jd})}_updateTintTween(){const e=Bd()-this._tweenInfo.startTime;let t=0===this.fadeDuration?1:e/this.fadeDuration;if(t=Wd.clamp(t,0,1),Math.abs(t-1)>1e-5){const e=this._tweenInfo.lerpColor;e.lerp(this._tweenInfo.from,this._tweenInfo.to,t),this._applyTintImmediately(new jd(e.r,e.g,e.b,e.a))}else this._applyTintImmediately(this._tweenInfo.to),this._cancelTween()}_cancelTween(){delete this._tweenInfo}onUpdate(){this._tweenInfo&&this._updateTintTween()}onEnable(){this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._imageReference.onParentComponentEnable(),this._toggleHitElementListeners("on"),this._forceReapplyVisualState()}onDisable(){this._toggleHitElementListeners("off"),this._resetToDefaultVisualState(this.transitionMode)}onRemove(){this._toggleLifecycleListeners("off",this.system),this.onDisable()}}function gS(e){return new jd(e.r,e.g,e.b)}fS.EVENT_MOUSEDOWN="mousedown",fS.EVENT_MOUSEUP="mouseup",fS.EVENT_MOUSEENTER="mouseenter",fS.EVENT_MOUSELEAVE="mouseleave",fS.EVENT_CLICK="click",fS.EVENT_TOUCHSTART="touchstart",fS.EVENT_TOUCHEND="touchend",fS.EVENT_TOUCHCANCEL="touchcancel",fS.EVENT_TOUCHLEAVE="touchleave",fS.EVENT_SELECTSTART="selectstart",fS.EVENT_SELECTEND="selectend",fS.EVENT_SELECTENTER="selectenter",fS.EVENT_SELECTLEAVE="selectleave",fS.EVENT_HOVERSTART="hoverstart",fS.EVENT_HOVEREND="hoverend",fS.EVENT_PRESSEDSTART="pressedstart",fS.EVENT_PRESSEDEND="pressedend";vw._buildAccessors(fS.prototype,["enabled","active",{name:"imageEntity",type:"entity"},{name:"hitPadding",type:"vec4"},"transitionMode",{name:"hoverTint",type:"rgba"},{name:"pressedTint",type:"rgba"},{name:"inactiveTint",type:"rgba"},"fadeDuration","hoverSpriteAsset","hoverSpriteFrame","pressedSpriteAsset","pressedSpriteFrame","inactiveSpriteAsset","inactiveSpriteFrame"]);const vS=new nu,yS=new _u;class bS extends vw{constructor(e,t){super(e,t),this._compoundParent=null,this._hasOffset=!1,this.entity.on("insert",this._onInsert,this),this.on("set_type",this.onSetType,this),this.on("set_halfExtents",this.onSetHalfExtents,this),this.on("set_linearOffset",this.onSetOffset,this),this.on("set_angularOffset",this.onSetOffset,this),this.on("set_radius",this.onSetRadius,this),this.on("set_height",this.onSetHeight,this),this.on("set_axis",this.onSetAxis,this),this.on("set_asset",this.onSetAsset,this),this.on("set_renderAsset",this.onSetRenderAsset,this),this.on("set_model",this.onSetModel,this),this.on("set_render",this.onSetRender,this)}onSetType(e,t,s){t!==s&&this.system.changeType(this,t,s)}onSetHalfExtents(e,t,s){const i=this.data.type;this.data.initialized&&"box"===i&&this.system.recreatePhysicalShapes(this)}onSetOffset(e,t,s){this._hasOffset=!this.data.linearOffset.equals(nu.ZERO)||!this.data.angularOffset.equals(_u.IDENTITY),this.data.initialized&&this.system.recreatePhysicalShapes(this)}onSetRadius(e,t,s){const i=this.data.type;!this.data.initialized||"sphere"!==i&&"capsule"!==i&&"cylinder"!==i&&"cone"!==i||this.system.recreatePhysicalShapes(this)}onSetHeight(e,t,s){const i=this.data.type;!this.data.initialized||"capsule"!==i&&"cylinder"!==i&&"cone"!==i||this.system.recreatePhysicalShapes(this)}onSetAxis(e,t,s){const i=this.data.type;!this.data.initialized||"capsule"!==i&&"cylinder"!==i&&"cone"!==i||this.system.recreatePhysicalShapes(this)}onSetAsset(e,t,s){const i=this.system.app.assets;if(t){const e=i.get(t);e&&e.off("remove",this.onAssetRemoved,this)}if(s){s instanceof Yx&&(this.data.asset=s.id);const e=i.get(this.data.asset);e&&(e.off("remove",this.onAssetRemoved,this),e.on("remove",this.onAssetRemoved,this))}this.data.initialized&&"mesh"===this.data.type&&(s||(this.data.model=null),this.system.recreatePhysicalShapes(this))}onSetRenderAsset(e,t,s){const i=this.system.app.assets;if(t){const e=i.get(t);e&&e.off("remove",this.onRenderAssetRemoved,this)}if(s){s instanceof Yx&&(this.data.renderAsset=s.id);const e=i.get(this.data.renderAsset);e&&(e.off("remove",this.onRenderAssetRemoved,this),e.on("remove",this.onRenderAssetRemoved,this))}this.data.initialized&&"mesh"===this.data.type&&(s||(this.data.render=null),this.system.recreatePhysicalShapes(this))}onSetModel(e,t,s){this.data.initialized&&"mesh"===this.data.type&&this.system.implementations.mesh.doRecreatePhysicalShape(this)}onSetRender(e,t,s){this.onSetModel(e,t,s)}onAssetRemoved(e){e.off("remove",this.onAssetRemoved,this),this.data.asset===e.id&&(this.asset=null)}onRenderAssetRemoved(e){e.off("remove",this.onRenderAssetRemoved,this),this.data.renderAsset===e.id&&(this.renderAsset=null)}_getCompoundChildShapeIndex(e){const t=this.data.shape,s=t.getNumChildShapes();for(let i=0;i<s;i++){if(t.getChildShape(i).ptr===e.ptr)return i}return null}_onInsert(e){if("undefined"!=typeof Ammo)if(this._compoundParent)this.system.recreatePhysicalShapes(this);else if(!this.entity.rigidbody){let e=this.entity.parent;for(;e;){if(e.collision&&"compound"===e.collision.type){0===e.collision.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(e.collision):this.system.recreatePhysicalShapes(this);break}e=e.parent}}}_updateCompound(){const e=this.entity;if(e._dirtyWorld){let t=e._dirtyLocal,s=e;for(;s&&!t&&(!s.collision||s.collision!==this._compoundParent);)s._dirtyLocal&&(t=!0),s=s.parent;if(t){e.forEach(this.system.implementations.compound._updateEachDescendantTransform,e);const t=this._compoundParent.entity.rigidbody;t&&t.activate()}}}getShapePosition(){const e=this.entity.getPosition();if(this._hasOffset){const t=this.entity.getRotation(),s=this.data.linearOffset;return yS.copy(t).transformVector(s,vS),vS.add(e)}return e}getShapeRotation(){const e=this.entity.getRotation();return this._hasOffset?yS.copy(e).mul(this.data.angularOffset):e}onEnable(){if("mesh"===this.data.type&&(this.data.asset||this.data.renderAsset)&&this.data.initialized){const e=this.system.app.assets.get(this.data.asset||this.data.renderAsset);if(e&&(!e.resource||!this.data.shape))return void this.system.recreatePhysicalShapes(this)}if(this.entity.rigidbody)this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation();else if(this._compoundParent&&this!==this._compoundParent)if(0===this._compoundParent.shape.getNumChildShapes())this.system.recreatePhysicalShapes(this._compoundParent);else{const e=this.system._getNodeTransform(this.entity,this._compoundParent.entity);this._compoundParent.shape.addChildShape(e,this.data.shape),Ammo.destroy(e),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()}else this.entity.trigger&&this.entity.trigger.enable()}onDisable(){this.entity.rigidbody?this.entity.rigidbody.disableSimulation():this._compoundParent&&this!==this._compoundParent?this._compoundParent.entity._destroying||(this.system._removeCompoundChild(this._compoundParent,this.data.shape),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()):this.entity.trigger&&this.entity.trigger.disable()}onBeforeRemove(){this.asset&&(this.asset=null),this.renderAsset&&(this.renderAsset=null),this.entity.off("insert",this._onInsert,this),this.off()}}bS.EVENT_CONTACT="contact",bS.EVENT_COLLISIONSTART="collisionstart",bS.EVENT_COLLISIONEND="collisionend",bS.EVENT_TRIGGERENTER="triggerenter",bS.EVENT_TRIGGERLEAVE="triggerleave";const xS="static",wS="dynamic",SS="kinematic";new pu,new nu,new nu,new _u,new Kf;vw._buildAccessors(bS.prototype,["enabled","type","halfExtents","linearOffset","angularOffset","radius","axis","height","asset","renderAsset","shape","model","render","checkVertexDuplicates"]);const CS=new zp;class TS{constructor(e,t,s){this._entity=e,this._element=e.element,this.model=new ub,this.node=new Kf,this.model.graph=this.node,this.mesh=t,this.meshInstance=new ig(this.mesh,s,this.node),this.meshInstance.name="ImageElement: "+e.name,this.meshInstance.castShadow=!1,this.meshInstance.receiveShadow=!1,this._meshDirty=!1,this.model.meshInstances.push(this.meshInstance),this._entity.addChild(this.model.graph),this.model._entity=this._entity,this.unmaskMeshInstance=null}destroy(){this.setMaterial(null),this._element.removeModelFromLayers(this.model),this.model.destroy(),this.model=null,this.node=null,this.mesh=null,this.meshInstance=null,this._entity=null,this._element=null}setMesh(e){this.meshInstance&&(this.mesh=e,this.meshInstance.mesh=e,this.meshInstance.visible=!!e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.mesh=e),this.forceUpdateAabb())}setMask(e){if(this.meshInstance){if(e){this.unmaskMeshInstance=new ig(this.mesh,this.meshInstance.material,this.node),this.unmaskMeshInstance.name="Unmask: "+this._entity.name,this.unmaskMeshInstance.castShadow=!1,this.unmaskMeshInstance.receiveShadow=!1,this.unmaskMeshInstance.pick=!1,this.model.meshInstances.push(this.unmaskMeshInstance);for(const e in this.meshInstance.parameters)this.unmaskMeshInstance.setParameter(e,this.meshInstance.parameters[e].data)}else{const e=this.model.meshInstances.indexOf(this.unmaskMeshInstance);e>=0&&this.model.meshInstances.splice(e,1),this.unmaskMeshInstance=null}this._entity.enabled&&this._element.enabled&&(this._element.removeModelFromLayers(this.model),this._element.addModelToLayers(this.model))}}setMaterial(e){this.meshInstance&&(this.meshInstance.material=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.material=e))}setParameter(e,t){this.meshInstance&&(this.meshInstance.setParameter(e,t),this.unmaskMeshInstance&&this.unmaskMeshInstance.setParameter(e,t))}deleteParameter(e){this.meshInstance&&(this.meshInstance.deleteParameter(e),this.unmaskMeshInstance&&this.unmaskMeshInstance.deleteParameter(e))}setUnmaskDrawOrder(){if(!this.meshInstance)return;const e=function e(t){let s;const i=t.children,n=i.length;if(n){for(let e=0;e<n;e++)i[e].element&&(s=i[e]);if(!s)return null;const t=e(s);return t||s}return null};if(this.unmaskMeshInstance){const t=e(this._entity);t&&t.element?this.unmaskMeshInstance.drawOrder=t.element.drawOrder+t.element.getMaskOffset():this.unmaskMeshInstance.drawOrder=this.meshInstance.drawOrder+this._element.getMaskOffset()}}setDrawOrder(e){this.meshInstance&&(this.meshInstance.drawOrder=e)}setCull(e){if(!this.meshInstance)return;const t=this._element;let s=null;e&&t._isScreenSpace()&&(s=function(e){return t.isVisibleForCamera(e)}),this.meshInstance.cull=e,this.meshInstance.isVisibleFunc=s,this.unmaskMeshInstance&&(this.unmaskMeshInstance.cull=e,this.unmaskMeshInstance.isVisibleFunc=s)}setScreenSpace(e){this.meshInstance&&(this.meshInstance.screenSpace=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.screenSpace=e))}setLayer(e){this.meshInstance&&(this.meshInstance.layer=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.layer=e))}forceUpdateAabb(e){this.meshInstance&&(this.meshInstance._aabbVer=-1,this.unmaskMeshInstance&&(this.unmaskMeshInstance._aabbVer=-1))}setAabbFunc(e){this.meshInstance&&(this.meshInstance._updateAabbFunc=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance._updateAabbFunc=e))}}class AS{constructor(e){this._element=e,this._entity=e.entity,this._system=e.system,this._textureAsset=null,this._texture=null,this._materialAsset=null,this._material=null,this._spriteAsset=null,this._sprite=null,this._spriteFrame=0,this._pixelsPerUnit=null,this._targetAspectRatio=-1,this._rect=new ou(0,0,1,1),this._mask=!1,this._maskRef=0,this._outerScale=new au,this._outerScaleUniform=new Float32Array(2),this._innerOffset=new ou,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new ou,this._atlasRectUniform=new Float32Array(4),this._defaultMesh=this._createMesh(),this._renderable=new TS(this._entity,this._defaultMesh,this._material),this._color=new jd(1,1,1,1),this._colorUniform=new Float32Array([1,1,1]),this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",1),this._updateAabbFunc=this._updateAabb.bind(this),this._onScreenChange(this._element.screen),this._element.on("resize",this._onParentResizeOrPivotChange,this),this._element.on("set:pivot",this._onParentResizeOrPivotChange,this),this._element.on("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.on("set:screen",this._onScreenChange,this),this._element.on("set:draworder",this._onDrawOrderChange,this),this._element.on("screen:set:resolution",this._onResolutionChange,this)}destroy(){this.textureAsset=null,this.spriteAsset=null,this.materialAsset=null,this._renderable.setMesh(this._defaultMesh),this._renderable.destroy(),this._defaultMesh=null,this._element.off("resize",this._onParentResizeOrPivotChange,this),this._element.off("set:pivot",this._onParentResizeOrPivotChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("screen:set:resolution",this._onResolutionChange,this)}_onResolutionChange(e){}_onParentResizeOrPivotChange(){this._renderable.mesh&&this._updateMesh(this._renderable.mesh)}_onScreenSpaceChange(e){this._updateMaterial(e)}_onScreenChange(e,t){e?this._updateMaterial(e.screen.screenSpace):this._updateMaterial(!1)}_onDrawOrderChange(e){this._renderable.setDrawOrder(e),this.mask&&this._element.screen&&this._element.screen.screen.once("syncdraworder",(function(){this._renderable.setUnmaskDrawOrder()}),this)}_hasUserMaterial(){return!!this._materialAsset||!!this._material&&-1===this._system.defaultImageMaterials.indexOf(this._material)}_use9Slicing(){return this.sprite&&(1===this.sprite.renderMode||2===this.sprite.renderMode)}_updateMaterial(e){const t=!!this._mask,s=!(!this.sprite||1!==this.sprite.renderMode),i=!(!this.sprite||2!==this.sprite.renderMode);this._hasUserMaterial()||(this._material=this._system.getImageElementMaterial(e,t,s,i)),this._renderable&&(this._renderable.setCull(!this._element._isScreenSpace()||this._element._isScreenCulled()),this._renderable.setMaterial(this._material),this._renderable.setScreenSpace(e),this._renderable.setLayer(e?0:15))}_createMesh(){const e=this._element,t=e.calculatedWidth,s=e.calculatedHeight,i=this._rect,n=this._system.app.graphicsDevice,r=new Float32Array([t,0,0,0,0,1,i.x+i.z,1-i.y,t,s,0,0,0,1,i.x+i.z,1-(i.y+i.w),0,0,0,0,0,1,i.x,1-i.y,0,s,0,0,0,1,i.x,1-(i.y+i.w)]),a=CS.get(n,(()=>new Bp(n,[{semantic:Ou,components:3,type:6},{semantic:zu,components:3,type:6},{semantic:Hu,components:2,type:6}]))),o=new Rp(n,a,4,0,r.buffer),l=new G_(n);return l.vertexBuffer=o,l.primitive[0].type=5,l.primitive[0].base=0,l.primitive[0].count=4,l.primitive[0].indexed=!1,l.aabb.setMinMax(nu.ZERO,new nu(t,s,0)),this._updateMesh(l),l}_updateMesh(e){const t=this._element;let s=t.calculatedWidth,i=t.calculatedHeight;if(t.fitMode!==lS&&this._targetAspectRatio>0){const e=t.calculatedWidth/t.calculatedHeight;"contain"===t.fitMode&&e>this._targetAspectRatio||"cover"===t.fitMode&&e<this._targetAspectRatio?s=t.calculatedHeight*this._targetAspectRatio:i=t.calculatedWidth/this._targetAspectRatio}const n=t._isScreenSpace();if(this._updateMaterial(n),this._renderable&&this._renderable.forceUpdateAabb(),!this.sprite||1!==this.sprite.renderMode&&2!==this.sprite.renderMode){const n=e.vertexBuffer,r=new Float32Array(n.lock()),a=t.pivot.x,o=t.pivot.y;r[0]=s-a*s,r[1]=0-o*i,r[8]=s-a*s,r[9]=i-o*i,r[16]=0-a*s,r[17]=0-o*i,r[24]=0-a*s,r[25]=i-o*i;let l=1,h=1,c=this._rect;if(this._sprite&&this._sprite.frameKeys[this._spriteFrame]&&this._sprite.atlas){const e=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];e&&(c=e.rect,l=this._sprite.atlas.texture.width,h=this._sprite.atlas.texture.height)}r[6]=(c.x+c.z)/l,r[7]=1-c.y/h,r[14]=(c.x+c.z)/l,r[15]=1-(c.y+c.w)/h,r[22]=c.x/l,r[23]=1-c.y/h,r[30]=c.x/l,r[31]=1-(c.y+c.w)/h,n.unlock();const d=new nu(0-a*s,0-o*i,0),u=new nu(s-a*s,i-o*i,0);e.aabb.setMinMax(d,u),this._renderable&&(this._renderable.node.setLocalScale(1,1,1),this._renderable.node.setLocalPosition(0,0,0),this._renderable.setAabbFunc(null))}else{const e=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]],n=2/e.rect.z,r=2/e.rect.w;this._innerOffset.set(e.border.x*n,e.border.y*r,e.border.z*n,e.border.w*r);const a=this.sprite.atlas.texture;this._atlasRect.set(e.rect.x/a.width,e.rect.y/a.height,e.rect.z/a.width,e.rect.w/a.height);const o=null!==this._pixelsPerUnit?this._pixelsPerUnit:this.sprite.pixelsPerUnit,l=e.rect.z/o,h=e.rect.w/o;this._outerScale.set(Math.max(s,this._innerOffset.x*l),Math.max(i,this._innerOffset.y*h));let c=l,d=h;this._outerScale.x/=l,this._outerScale.y/=h,c*=Wd.clamp(s/(this._innerOffset.x*l),1e-4,1),d*=Wd.clamp(i/(this._innerOffset.y*h),1e-4,1),this._renderable&&(this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._renderable.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._renderable.setParameter("atlasRect",this._atlasRectUniform),this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._renderable.setParameter("outerScale",this._outerScaleUniform),this._renderable.setAabbFunc(this._updateAabbFunc),this._renderable.node.setLocalScale(c,d,1),this._renderable.node.setLocalPosition((.5-t.pivot.x)*s,(.5-t.pivot.y)*i,0))}this._meshDirty=!1}_updateSprite(){let e=!1,t=null;if(this._targetAspectRatio=-1,this._sprite&&this._sprite.atlas){t=this._sprite.meshes[this.spriteFrame],e=1===this._sprite.renderMode||2===this._sprite.renderMode;const s=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];(null==s?void 0:s.rect.w)>0&&(this._targetAspectRatio=s.rect.z/s.rect.w)}this.mesh=e?t:this._defaultMesh,this.refreshMesh()}refreshMesh(){this.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this.mesh))}_updateAabb(e){return e.center.set(0,0,0),e.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001),e.setFromTransformedAabb(e,this._renderable.node.getWorldTransform()),e}_toggleMask(){this._element._dirtifyMask();const e=this._element._isScreenSpace();this._updateMaterial(e),this._renderable.setMask(!!this._mask)}_onMaterialLoad(e){this.material=e.resource}_onMaterialAdded(e){this._system.app.assets.off("add:"+e.id,this._onMaterialAdded,this),this._materialAsset===e.id&&this._bindMaterialAsset(e)}_bindMaterialAsset(e){this._entity.enabled&&(e.on("load",this._onMaterialLoad,this),e.on("change",this._onMaterialChange,this),e.on("remove",this._onMaterialRemove,this),e.resource?this._onMaterialLoad(e):this._system.app.assets.load(e))}_unbindMaterialAsset(e){e.off("load",this._onMaterialLoad,this),e.off("change",this._onMaterialChange,this),e.off("remove",this._onMaterialRemove,this)}_onMaterialChange(){}_onMaterialRemove(){}_onTextureAdded(e){this._system.app.assets.off("add:"+e.id,this._onTextureAdded,this),this._textureAsset===e.id&&this._bindTextureAsset(e)}_bindTextureAsset(e){this._entity.enabled&&(e.on("load",this._onTextureLoad,this),e.on("change",this._onTextureChange,this),e.on("remove",this._onTextureRemove,this),e.resource?this._onTextureLoad(e):this._system.app.assets.load(e))}_unbindTextureAsset(e){e.off("load",this._onTextureLoad,this),e.off("change",this._onTextureChange,this),e.off("remove",this._onTextureRemove,this)}_onTextureLoad(e){this.texture=e.resource}_onTextureChange(e){}_onTextureRemove(e){}_onSpriteAssetAdded(e){this._system.app.assets.off("add:"+e.id,this._onSpriteAssetAdded,this),this._spriteAsset===e.id&&this._bindSpriteAsset(e)}_bindSpriteAsset(e){this._entity.enabled&&(e.on("load",this._onSpriteAssetLoad,this),e.on("change",this._onSpriteAssetChange,this),e.on("remove",this._onSpriteAssetRemove,this),e.resource?this._onSpriteAssetLoad(e):this._system.app.assets.load(e))}_unbindSpriteAsset(e){e.off("load",this._onSpriteAssetLoad,this),e.off("change",this._onSpriteAssetChange,this),e.off("remove",this._onSpriteAssetRemove,this),e.data.textureAtlasAsset&&this._system.app.assets.off("load:"+e.data.textureAtlasAsset,this._onTextureAtlasLoad,this)}_onSpriteAssetLoad(e){if(e&&e.resource)if(e.resource.atlas)this.sprite=e.resource;else{const t=e.data.textureAtlasAsset;if(t){const e=this._system.app.assets;e.off("load:"+t,this._onTextureAtlasLoad,this),e.once("load:"+t,this._onTextureAtlasLoad,this)}}else this.sprite=null}_onSpriteAssetChange(e){this._onSpriteAssetLoad(e)}_onSpriteAssetRemove(e){}_bindSprite(e){e.on("set:meshes",this._onSpriteMeshesChange,this),e.on("set:pixelsPerUnit",this._onSpritePpuChange,this),e.on("set:atlas",this._onAtlasTextureChange,this),e.atlas&&e.atlas.on("set:texture",this._onAtlasTextureChange,this)}_unbindSprite(e){e.off("set:meshes",this._onSpriteMeshesChange,this),e.off("set:pixelsPerUnit",this._onSpritePpuChange,this),e.off("set:atlas",this._onAtlasTextureChange,this),e.atlas&&e.atlas.off("set:texture",this._onAtlasTextureChange,this)}_onSpriteMeshesChange(){this._sprite&&(this._spriteFrame=Wd.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()}_onSpritePpuChange(){0!==this.sprite.renderMode&&null===this._pixelsPerUnit&&this._updateSprite()}_onAtlasTextureChange(){this.sprite&&this.sprite.atlas&&this.sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))}_onTextureAtlasLoad(e){const t=this._spriteAsset;t instanceof Yx?this._onSpriteAssetLoad(t):this._onSpriteAssetLoad(this._system.app.assets.get(t))}onEnable(){if(this._materialAsset){const e=this._system.app.assets.get(this._materialAsset);e&&e.resource!==this._material&&this._bindMaterialAsset(e)}if(this._textureAsset){const e=this._system.app.assets.get(this._textureAsset);e&&e.resource!==this._texture&&this._bindTextureAsset(e)}if(this._spriteAsset){const e=this._system.app.assets.get(this._spriteAsset);e&&e.resource!==this._sprite&&this._bindSpriteAsset(e)}this._element.addModelToLayers(this._renderable.model)}onDisable(){this._element.removeModelFromLayers(this._renderable.model)}_setStencil(e){this._renderable.meshInstance.stencilFront=e,this._renderable.meshInstance.stencilBack=e;let t=0;if(this._element.maskedBy&&(t=this._element.maskedBy.element._image._maskRef),this._renderable.unmaskMeshInstance){const e=new Wp({ref:t+1,func:2,zpass:5});this._renderable.unmaskMeshInstance.stencilFront=e,this._renderable.unmaskMeshInstance.stencilBack=e}}set color(e){const t=e.r,s=e.g,i=e.b;this._color.r===t&&this._color.g===s&&this._color.b===i||(this._color.r=t,this._color.g=s,this._color.b=i,this._colorUniform[0]=t,this._colorUniform[1]=s,this._colorUniform[2]=i,this._renderable.setParameter("material_emissive",this._colorUniform)),this._element&&this._element.fire("set:color",this._color)}get color(){return this._color}set opacity(e){e!==this._color.a&&(this._color.a=e,this._renderable.setParameter("material_opacity",e)),this._element&&this._element.fire("set:opacity",e)}get opacity(){return this._color.a}set rect(e){let t,s,i,n;e instanceof ou?(t=e.x,s=e.y,i=e.z,n=e.w):(t=e[0],s=e[1],i=e[2],n=e[3]),t===this._rect.x&&s===this._rect.y&&i===this._rect.z&&n===this._rect.w||(this._rect.set(t,s,i,n),this._renderable.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this._renderable.mesh)))}get rect(){return this._rect}_removeMaterialAssetEvents(){if(this._materialAsset){const e=this._system.app.assets;e.off("add:"+this._materialAsset,this._onMaterialAdded,this);const t=e.get(this._materialAsset);t&&(t.off("load",this._onMaterialLoad,this),t.off("change",this._onMaterialChange,this),t.off("remove",this._onMaterialRemove,this))}}set material(e){if(this._material!==e){if(!e){const t=this._element._isScreenSpace();e=this.mask?t?this._system.defaultScreenSpaceImageMaskMaterial:this._system.defaultImageMaskMaterial:t?this._system.defaultScreenSpaceImageMaterial:this._system.defaultImageMaterial}if(this._material=e,this._materialAsset){const t=this._system.app.assets.get(this._materialAsset);t&&t.resource===e||(this._removeMaterialAssetEvents(),this._materialAsset=null)}e&&(this._renderable.setMaterial(e),this._hasUserMaterial()?(this._renderable.deleteParameter("material_opacity"),this._renderable.deleteParameter("material_emissive")):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a)))}}get material(){return this._material}set materialAsset(e){const t=this._system.app.assets;let s=e;if(e instanceof Yx&&(s=e.id),this._materialAsset!==s)if(this._removeMaterialAssetEvents(),this._materialAsset=s,this._materialAsset){const e=t.get(this._materialAsset);e?this._bindMaterialAsset(e):(this._materialAsset=null,this.material=null,this._materialAsset=s,t.on("add:"+this._materialAsset,this._onMaterialAdded,this))}else this._materialAsset=null,this.material=null,this._materialAsset=s}get materialAsset(){return this._materialAsset}set texture(e){if(this._texture!==e){if(this._textureAsset){const t=this._system.app.assets.get(this._textureAsset);t&&t.resource!==e&&(this.textureAsset=null)}if(this._texture=e,e){this._spriteAsset&&(this.spriteAsset=null),this._renderable.setParameter("texture_emissiveMap",this._texture),this._renderable.setParameter("texture_opacityMap",this._texture),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a);const e=this._texture.width/this._texture.height;e!==this._targetAspectRatio&&(this._targetAspectRatio=e,this._element.fitMode!==lS&&this.refreshMesh())}else this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"),this._targetAspectRatio=-1,this._element.fitMode!==lS&&this.refreshMesh()}}get texture(){return this._texture}set textureAsset(e){const t=this._system.app.assets;let s=e;if(e instanceof Yx&&(s=e.id),this._textureAsset!==s){if(this._textureAsset){t.off("add:"+this._textureAsset,this._onTextureAdded,this);const e=t.get(this._textureAsset);e&&(e.off("load",this._onTextureLoad,this),e.off("change",this._onTextureChange,this),e.off("remove",this._onTextureRemove,this))}if(this._textureAsset=s,this._textureAsset){const e=t.get(this._textureAsset);e?this._bindTextureAsset(e):(this.texture=null,t.on("add:"+this._textureAsset,this._onTextureAdded,this))}else this.texture=null}}get textureAsset(){return this._textureAsset}set spriteAsset(e){const t=this._system.app.assets;let s=e;if(e instanceof Yx&&(s=e.id),this._spriteAsset!==s){if(this._spriteAsset){t.off("add:"+this._spriteAsset,this._onSpriteAssetAdded,this);const e=t.get(this._spriteAsset);e&&this._unbindSpriteAsset(e)}if(this._spriteAsset=s,this._spriteAsset){const e=t.get(this._spriteAsset);e?this._bindSpriteAsset(e):(this.sprite=null,t.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this))}else this.sprite=null}this._element&&this._element.fire("set:spriteAsset",s)}get spriteAsset(){return this._spriteAsset}set sprite(e){if(this._sprite!==e){if(this._sprite&&this._unbindSprite(this._sprite),this._spriteAsset){const t=this._system.app.assets.get(this._spriteAsset);t&&t.resource!==e&&(this.spriteAsset=null)}this._sprite=e,this._sprite&&(this._bindSprite(this._sprite),this._textureAsset&&(this.textureAsset=null)),this._sprite&&this._sprite.atlas&&this._sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap")),this._sprite&&(this._spriteFrame=Wd.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()}}get sprite(){return this._sprite}set spriteFrame(e){const t=this._spriteFrame;this._sprite?this._spriteFrame=Wd.clamp(e,0,this._sprite.frameKeys.length-1):this._spriteFrame=e,this._spriteFrame!==t&&this._updateSprite(),this._element&&this._element.fire("set:spriteFrame",e)}get spriteFrame(){return this._spriteFrame}set mesh(e){this._renderable.setMesh(e),this._defaultMesh===e?this._renderable.setAabbFunc(null):this._renderable.setAabbFunc(this._updateAabbFunc)}get mesh(){return this._renderable.mesh}set mask(e){this._mask!==e&&(this._mask=e,this._toggleMask())}get mask(){return this._mask}set pixelsPerUnit(e){this._pixelsPerUnit!==e&&(this._pixelsPerUnit=e,!this._sprite||1!==this._sprite.renderMode&&2!==this._sprite.renderMode||this._updateSprite())}get pixelsPerUnit(){return this._pixelsPerUnit}get aabb(){return this._renderable.meshInstance?this._renderable.meshInstance.aabb:null}}class ES extends od{constructor(e){super(),this._app=e,e.i18n.on("set:locale",this._onSetLocale,this),this._autoLoad=!1,this._disableLocalization=!1,this._defaultAsset=null,this._localizedAsset=null}set defaultAsset(e){const t=e instanceof Yx?e.id:e;this._defaultAsset!==t&&(this._defaultAsset&&this._unbindDefaultAsset(),this._defaultAsset=t,this._defaultAsset&&this._bindDefaultAsset(),this._onSetLocale(this._app.i18n.locale))}get defaultAsset(){return this._defaultAsset}set localizedAsset(e){const t=e instanceof Yx?e.id:e;if(this._localizedAsset!==t&&(this._localizedAsset&&(this._app.assets.off("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this),this._unbindLocalizedAsset(),this._localizedAsset=null),this._localizedAsset=t,this._localizedAsset)){this._app.assets.get(this._localizedAsset)?this._bindLocalizedAsset():this._app.assets.once("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this)}}get localizedAsset(){return this._localizedAsset}set autoLoad(e){this._autoLoad!==e&&(this._autoLoad=e,this._autoLoad&&this._localizedAsset&&(this._unbindLocalizedAsset(),this._bindLocalizedAsset()))}get autoLoad(){return this._autoLoad}set disableLocalization(e){this._disableLocalization!==e&&(this._disableLocalization=e,this._onSetLocale(this._app.i18n.locale))}get disableLocalization(){return this._disableLocalization}_bindDefaultAsset(){const e=this._app.assets.get(this._defaultAsset);e?this._onDefaultAssetAdd(e):this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this)}_unbindDefaultAsset(){if(!this._defaultAsset)return;this._app.assets.off("add:"+this._defaultAsset,this._onDefaultAssetAdd,this);const e=this._app.assets.get(this._defaultAsset);e&&(e.off("add:localized",this._onLocaleAdd,this),e.off("remove:localized",this._onLocaleRemove,this),e.off("remove",this._onDefaultAssetRemove,this))}_onDefaultAssetAdd(e){this._defaultAsset===e.id&&(e.on("add:localized",this._onLocaleAdd,this),e.on("remove:localized",this._onLocaleRemove,this),e.once("remove",this._onDefaultAssetRemove,this))}_onDefaultAssetRemove(e){this._defaultAsset===e.id&&(e.off("add:localized",this._onLocaleAdd,this),e.off("remove:localized",this._onLocaleAdd,this),this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this))}_bindLocalizedAsset(){if(!this._autoLoad)return;const e=this._app.assets.get(this._localizedAsset);e&&(e.on("load",this._onLocalizedAssetLoad,this),e.on("change",this._onLocalizedAssetChange,this),e.on("remove",this._onLocalizedAssetRemove,this),e.resource?this._onLocalizedAssetLoad(e):this._app.assets.load(e))}_unbindLocalizedAsset(){const e=this._app.assets.get(this._localizedAsset);e&&(e.off("load",this._onLocalizedAssetLoad,this),e.off("change",this._onLocalizedAssetChange,this),e.off("remove",this._onLocalizedAssetRemove,this))}_onLocalizedAssetAdd(e){this._localizedAsset===e.id&&this._bindLocalizedAsset()}_onLocalizedAssetLoad(e){this.fire("load",e)}_onLocalizedAssetChange(e,t,s,i){this.fire("change",e,t,s,i)}_onLocalizedAssetRemove(e){this._localizedAsset===e.id&&(this.localizedAsset=this._defaultAsset),this.fire("remove",e)}_onLocaleAdd(e,t){this._app.i18n.locale===e&&this._onSetLocale(e)}_onLocaleRemove(e,t){this._app.i18n.locale===e&&this._onSetLocale(e)}_onSetLocale(e){if(!this._defaultAsset)return void(this.localizedAsset=null);const t=this._app.assets.get(this._defaultAsset);if(!t||this._disableLocalization)return void(this.localizedAsset=this._defaultAsset);const s=t.getLocalizedAssetId(e);this.localizedAsset=s||this._defaultAsset}destroy(){this.defaultAsset=null,this._app.i18n.off("set:locale",this._onSetLocale,this),this.off()}}const PS="msdf",MS=/[A-Z|a-z|0-9|_|-|/]/;class LS{constructor(e){this._symbols=e,this._index=0,this._last=0,this._cur=this._symbols.length>0?this._symbols[0]:null,this._buf=[],this._mode="text",this._error=null}read(){let e=this._read();for(;8===e;)e=this._read();return 0!==e&&1!==e&&(this._last=this._index),e}buf(){return this._buf}last(){return this._last}error(){return this._error}debugPrint(){const e=["EOF","ERROR","TEXT","OPEN_BRACKET","CLOSE_BRACKET","EQUALS","STRING","IDENTIFIER","WHITESPACE"];let t=this.read(),s="";for(;s+=(s.length>0?"\n":"")+e[t]+" '"+this.buf().join("")+"'",0!==t&&1!==t;)t=this.read();return s}_read(){return this._buf=[],this._eof()?0:"text"===this._mode?this._text():this._tag()}_text(){for(;;)switch(this._cur){case null:return this._buf.length>0?2:0;case"[":return this._mode="tag",this._buf.length>0?2:this._tag();case"\\":if(this._next(),"["===this._cur)this._store();else this._output("\\");break;default:this._store()}}_tag(){switch(this._cur){case null:return this._error="unexpected end of input reading tag",1;case"[":return this._store(),3;case"]":return this._store(),this._mode="text",4;case"=":return this._store(),5;case" ":case"\t":case"\n":case"\r":case"\v":case"\f":return this._whitespace();case'"':return this._string();default:return this._isIdentifierSymbol(this._cur)?this._identifier():(this._error="unrecognized character",1)}}_whitespace(){for(this._store();-1!==" \t\n\r\v\f".indexOf(this._cur);)this._store();return 8}_string(){for(this._next();;)switch(this._cur){case null:return this._error="unexpected end of input reading string",1;case'"':return this._next(),6;default:this._store()}}_identifier(){for(this._store();null!==this._cur&&this._isIdentifierSymbol(this._cur);)this._store();return 7}_isIdentifierSymbol(e){return 1===e.length&&null!==e.match(MS)}_eof(){return null===this._cur}_next(){return this._eof()||(this._index++,this._cur=this._index<this._symbols.length?this._symbols[this._index]:null),this._cur}_store(){return this._buf.push(this._cur),this._next()}_output(e){this._buf.push(e)}}class DS{constructor(e){this._scanner=new LS(e),this._error=null}parse(e,t){for(;;){switch(this._scanner.read()){case 0:return!0;case 1:default:return!1;case 2:Array.prototype.push.apply(e,this._scanner.buf());break;case 3:if(!this._parseTag(e,t))return!1}}}error(){return"Error evaluating markup at #"+this._scanner.last().toString()+" ("+(this._scanner.error()||this._error)+")"}_parseTag(e,t){let s=this._scanner.read();if(7!==s)return this._error="expected identifier",!1;const i=this._scanner.buf().join("");if("/"===i[0]){for(let n=t.length-1;n>=0;--n)if(i==="/"+t[n].name&&null===t[n].end)return t[n].end=e.length,s=this._scanner.read(),4===s||(this._error="expected close bracket",!1);return this._error="failed to find matching tag",!1}const n={name:i,value:null,attributes:{},start:e.length,end:null};if(s=this._scanner.read(),5===s){if(s=this._scanner.read(),6!==s)return this._error="expected string",!1;n.value=this._scanner.buf().join(""),s=this._scanner.read()}for(;;){switch(s){case 4:return t.push(n),!0;case 7:{const e=this._scanner.buf().join("");if(s=this._scanner.read(),5!==s)return this._error="expected equals",!1;if(s=this._scanner.read(),6!==s)return this._error="expected string",!1;const t=this._scanner.buf().join("");n.attributes[e]=t;break}default:return this._error="expected close bracket or identifier",!1}s=this._scanner.read()}}}function kS(e,t){for(const s in t){if(!t.hasOwnProperty(s))continue;const i=t[s];i instanceof Object?(e.hasOwnProperty(s)||(e[s]={}),kS(e[s],t[s])):e[s]=i}}function IS(e){if(0===e.length)return null;const t={};for(let s=0;s<e.length;++s){const i=e[s],n={};n[i.name]={value:i.value,attributes:i.attributes},kS(t,n)}return t}function RS(e){const t=new DS(e),s=[],i=[];if(!t.parse(s,i))return console.warn(t.error()),{symbols:e,tags:null};const n=i.find((function(e){return null===e.end}));if(n)return console.warn(`Markup error: found unclosed tag='${n.name}'`),{symbols:e,tags:null};const r=function(e,t){if(0===e.length)return null;const s={};for(let t=0;t<e.length;++t){const i=e[t];s.hasOwnProperty(i.start)?null===s[i.start].open?s[i.start].open=[i]:s[i.start].open.push(i):s[i.start]={open:[i],close:null},s.hasOwnProperty(i.end)?null===s[i.end].close?s[i.end].close=[i]:s[i.end].close.push(i):s[i.end]={open:null,close:[i]}}let i=[];function n(e){i=i.filter((function(t){return void 0===e.find((function(e){return e===t}))}))}function r(e){for(let t=0;t<e.length;++t)i.push(e[t])}const a=Object.keys(s).sort((function(e,t){return e-t})),o=[];for(let e=0;e<a.length;++e){const t=s[a[e]];null!==t.close&&n(t.close),null!==t.open&&r(t.open),o.push({start:a[e],tags:IS(i)})}const l=[];let h=null;for(let e=0;e<o.length;++e){const t=o[e];for(;l.length<t.start;)l.push(h?h.tags:null);h=t}for(;l.length<t;)l.push(null);return l}(i,s.length);return{symbols:s,tags:r}}class OS{static evaluate(e){return RS(e)}}class zS{constructor(){this.count=0,this.quad=0,this.lines={},this.positions=[],this.normals=[],this.uvs=[],this.colors=[],this.indices=[],this.outlines=[],this.shadows=[],this.meshInstance=null}}function FS(e,t){const s=new G_(e);return s.setPositions(t.positions),s.setNormals(t.normals),s.setColors32(t.colors),s.setUvs(0,t.uvs),s.setIndices(t.indices),s.setVertexStream(qu,t.outlines,3,void 0,6,!1),s.setVertexStream(Ku,t.shadows,3,void 0,6,!1),s.update(),s}const VS=/^[\r\n]$/,NS=/^[ \t]$/,BS=/^[ \t\-]|[\u200b]$/,US=/^[a-z0-9]$/i,HS=/^[\u1100-\u11ff]|[\u3000-\u9fff]|[\ua960-\ua97f]|[\uac00-\ud7ff]$/,WS=/^[]$/,GS=["","","","","","","","","","","","",""],jS={width:0,height:0,xadvance:0,xoffset:0,yoffset:0},qS=new jd,KS=new au;class XS{constructor(e){this._element=e,this._system=e.system,this._entity=e.entity,this._text="",this._symbols=[],this._colorPalette=[],this._outlinePalette=[],this._shadowPalette=[],this._symbolColors=null,this._symbolOutlineParams=null,this._symbolShadowParams=null,this._i18nKey=null,this._fontAsset=new ES(this._system.app),this._fontAsset.disableLocalization=!0,this._fontAsset.on("load",this._onFontLoad,this),this._fontAsset.on("change",this._onFontChange,this),this._fontAsset.on("remove",this._onFontRemove,this),this._font=null,this._color=new jd(1,1,1,1),this._colorUniform=new Float32Array(3),this._spacing=1,this._fontSize=32,this._fontMinY=0,this._fontMaxY=0,this._originalFontSize=32,this._maxFontSize=32,this._minFontSize=8,this._autoFitWidth=!1,this._autoFitHeight=!1,this._maxLines=-1,this._lineHeight=32,this._scaledLineHeight=32,this._wrapLines=!1,this._drawOrder=0,this._alignment=new au(.5,.5),this._autoWidth=!0,this._autoHeight=!0,this.width=0,this.height=0,this._node=new Kf,this._model=new ub,this._model.graph=this._node,this._entity.addChild(this._node),this._meshInfo=[],this._material=null,this._aabbDirty=!0,this._aabb=new xu,this._noResize=!1,this._currentMaterialType=null,this._maskedMaterialSrc=null,this._rtlReorder=!1,this._unicodeConverter=!1,this._rtl=!1,this._outlineColor=new jd(0,0,0,1),this._outlineColorUniform=new Float32Array(4),this._outlineThicknessScale=.2,this._outlineThickness=0,this._shadowColor=new jd(0,0,0,1),this._shadowColorUniform=new Float32Array(4),this._shadowOffsetScale=.005,this._shadowOffset=new au(0,0),this._shadowOffsetUniform=new Float32Array(2),this._enableMarkup=!1,this._onScreenChange(this._element.screen),e.on("resize",this._onParentResize,this),e.on("set:screen",this._onScreenChange,this),e.on("screen:set:screenspace",this._onScreenSpaceChange,this),e.on("set:draworder",this._onDrawOrderChange,this),e.on("set:pivot",this._onPivotChange,this),this._system.app.i18n.on("set:locale",this._onLocaleSet,this),this._system.app.i18n.on("data:add",this._onLocalizationData,this),this._system.app.i18n.on("data:remove",this._onLocalizationData,this),this._rangeStart=0,this._rangeEnd=0}destroy(){this._setMaterial(null),this._model&&(this._element.removeModelFromLayers(this._model),this._model.destroy(),this._model=null),this._fontAsset.destroy(),this.font=null,this._element.off("resize",this._onParentResize,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("set:pivot",this._onPivotChange,this),this._system.app.i18n.off("set:locale",this._onLocaleSet,this),this._system.app.i18n.off("data:add",this._onLocalizationData,this),this._system.app.i18n.off("data:remove",this._onLocalizationData,this)}_onParentResize(e,t){this._noResize||this._font&&this._updateText()}_onScreenChange(e){e?this._updateMaterial(e.screen.screenSpace):this._updateMaterial(!1)}_onScreenSpaceChange(e){this._updateMaterial(e)}_onDrawOrderChange(e){if(this._drawOrder=e,this._model)for(let t=0,s=this._model.meshInstances.length;t<s;t++)this._model.meshInstances[t].drawOrder=e}_onPivotChange(e){this._font&&this._updateText()}_onLocaleSet(e){if(this._i18nKey){if(this.fontAsset){const e=this._system.app.assets.get(this.fontAsset);e&&e.resource&&e.resource===this._font||(this.font=null)}this._resetLocalizedText()}}_onLocalizationData(e,t){this._i18nKey&&t[this._i18nKey]&&this._resetLocalizedText()}_resetLocalizedText(){this._setText(this._system.app.i18n.getText(this._i18nKey))}_setText(e){if(this.unicodeConverter){const t=this._system.getUnicodeConverter();t?e=t(e):console.warn("Element created with unicodeConverter option but no unicodeConverter function registered")}this._text!==e&&(this._font&&this._updateText(e),this._text=e)}_updateText(e){let t;if(void 0===e&&(e=this._text),this._symbols=Fd.getSymbols(e.normalize?e.normalize("NFC"):e),0===this._symbols.length&&(this._symbols=[" "]),this._enableMarkup){const e=OS.evaluate(this._symbols);this._symbols=e.symbols,t=e.tags||[]}if(this._rtlReorder){const e=this._system.app.systems.element.getRtlReorder();if(e){const s=e(this._symbols);this._rtl=s.rtl,this._symbols=s.mapping.map((function(e){return this._symbols[e]}),this),t&&(t=s.mapping.map((function(e){return t[e]})))}else console.warn("Element created with rtlReorder option but no rtlReorder function registered")}else this._rtl=!1;const s=(e,t)=>`${e.toString(!0).toLowerCase()}:${t.toFixed(2)}`,i=(e,t)=>`${e.toString(!0).toLowerCase()}:${t.x.toFixed(2)}:${t.y.toFixed(2)}`;if(t){const e={},n={},r={};this._colorPalette=[Math.round(255*this._color.r),Math.round(255*this._color.g),Math.round(255*this._color.b)],this._outlinePalette=[Math.round(255*this._outlineColor.r),Math.round(255*this._outlineColor.g),Math.round(255*this._outlineColor.b),Math.round(255*this._outlineColor.a),Math.round(255*this._outlineThickness)],this._shadowPalette=[Math.round(255*this._shadowColor.r),Math.round(255*this._shadowColor.g),Math.round(255*this._shadowColor.b),Math.round(255*this._shadowColor.a),Math.round(127*this._shadowOffset.x),Math.round(127*this._shadowOffset.y)],this._symbolColors=[],this._symbolOutlineParams=[],this._symbolShadowParams=[],e[this._color.toString(!1).toLowerCase()]=0,n[s(this._outlineColor,this._outlineThickness)]=0,r[i(this._shadowColor,this._shadowOffset)]=0;for(let a=0,o=this._symbols.length;a<o;++a){const o=t[a];let l=0;if(o&&o.color&&o.color.value){const t=o.color.value;if(7===t.length&&"#"===t[0]){const s=t.substring(1).toLowerCase();e.hasOwnProperty(s)?l=e[s]:/^([0-9a-f]{2}){3}$/.test(s)&&(l=this._colorPalette.length/3,e[s]=l,this._colorPalette.push(parseInt(s.substring(0,2),16)),this._colorPalette.push(parseInt(s.substring(2,4),16)),this._colorPalette.push(parseInt(s.substring(4,6),16)))}}this._symbolColors.push(l);let h=0;if(o&&o.outline&&(o.outline.attributes.color||o.outline.attributes.thickness)){let e=o.outline.attributes.color?qS.fromString(o.outline.attributes.color):this._outlineColor,t=Number(o.outline.attributes.thickness);(Number.isNaN(e.r)||Number.isNaN(e.g)||Number.isNaN(e.b)||Number.isNaN(e.a))&&(e=this._outlineColor),Number.isNaN(t)&&(t=this._outlineThickness);const i=s(e,t);n.hasOwnProperty(i)?h=n[i]:(h=this._outlinePalette.length/5,n[i]=h,this._outlinePalette.push(Math.round(255*e.r),Math.round(255*e.g),Math.round(255*e.b),Math.round(255*e.a),Math.round(255*t)))}this._symbolOutlineParams.push(h);let c=0;if(o&&o.shadow&&(o.shadow.attributes.color||o.shadow.attributes.offset||o.shadow.attributes.offsetX||o.shadow.attributes.offsetY)){let e=o.shadow.attributes.color?qS.fromString(o.shadow.attributes.color):this._shadowColor;const t=Number(o.shadow.attributes.offset),s=Number(o.shadow.attributes.offsetX),n=Number(o.shadow.attributes.offsetY);(Number.isNaN(e.r)||Number.isNaN(e.g)||Number.isNaN(e.b)||Number.isNaN(e.a))&&(e=this._shadowColor);const a=KS.set(Number.isNaN(s)?Number.isNaN(t)?this._shadowOffset.x:t:s,Number.isNaN(n)?Number.isNaN(t)?this._shadowOffset.y:t:n),l=i(e,a);r.hasOwnProperty(l)?c=r[l]:(c=this._shadowPalette.length/6,r[l]=c,this._shadowPalette.push(Math.round(255*e.r),Math.round(255*e.g),Math.round(255*e.b),Math.round(255*e.a),Math.round(127*a.x),Math.round(127*a.y)))}this._symbolShadowParams.push(c)}}else this._colorPalette=[],this._symbolColors=null,this._symbolOutlineParams=null,this._symbolShadowParams=null;this._updateMaterialEmissive(),this._updateMaterialOutline(),this._updateMaterialShadow();const n=this._calculateCharsPerTexture();let r=!1;const a=this._element,o=a._isScreenSpace(),l=a._isScreenCulled(),h=function(e){return a.isVisibleForCamera(e)};for(let e=0,t=this._meshInfo.length;e<t;e++){const t=n[e]||0,s=this._meshInfo[e];if(s.count!==t){if(r||(a.removeModelFromLayers(this._model),r=!0),s.count=t,s.positions.length=s.normals.length=3*t*4,s.indices.length=3*t*2,s.uvs.length=2*t*4,s.colors.length=4*t*4,s.outlines.length=4*t*3,s.shadows.length=4*t*3,s.meshInstance&&this._removeMeshInstance(s.meshInstance),0===t){s.meshInstance=null;continue}for(let e=0;e<t;e++)s.indices[3*e*2+0]=4*e,s.indices[3*e*2+1]=4*e+1,s.indices[3*e*2+2]=4*e+3,s.indices[3*e*2+3]=4*e+2,s.indices[3*e*2+4]=4*e+3,s.indices[3*e*2+5]=4*e+1,s.normals[4*e*3+0]=0,s.normals[4*e*3+1]=0,s.normals[4*e*3+2]=-1,s.normals[4*e*3+3]=0,s.normals[4*e*3+4]=0,s.normals[4*e*3+5]=-1,s.normals[4*e*3+6]=0,s.normals[4*e*3+7]=0,s.normals[4*e*3+8]=-1,s.normals[4*e*3+9]=0,s.normals[4*e*3+10]=0,s.normals[4*e*3+11]=-1;const i=FS(this._system.app.graphicsDevice,s),n=new ig(i,this._material,this._node);if(n.name="Text Element: "+this._entity.name,n.castShadow=!1,n.receiveShadow=!1,n.cull=!o,n.screenSpace=o,n.drawOrder=this._drawOrder,l&&(n.cull=!0,n.isVisibleFunc=h),this._setTextureParams(n,this._font.textures[e]),n.setParameter("material_emissive",this._colorUniform),n.setParameter("material_opacity",this._color.a),n.setParameter("font_sdfIntensity",this._font.intensity),n.setParameter("font_pxrange",this._getPxRange(this._font)),n.setParameter("font_textureWidth",this._font.data.info.maps[e].width),n.setParameter("outline_color",this._outlineColorUniform),n.setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness),n.setParameter("shadow_color",this._shadowColorUniform),this._symbolShadowParams)this._shadowOffsetUniform[0]=0,this._shadowOffsetUniform[1]=0;else{const t=-this._font.data.info.maps[e].width/this._font.data.info.maps[e].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=t*this._shadowOffsetScale*this._shadowOffset.y}n.setParameter("shadow_offset",this._shadowOffsetUniform),s.meshInstance=n,this._model.meshInstances.push(n)}}this._element.maskedBy&&this._element._setMaskedBy(this._element.maskedBy),r&&this._element.enabled&&this._entity.enabled&&this._element.addModelToLayers(this._model),this._updateMeshes(),this._rangeStart=0,this._rangeEnd=this._symbols.length,this._updateRenderRange()}_removeMeshInstance(e){e.destroy();const t=this._model.meshInstances.indexOf(e);-1!==t&&this._model.meshInstances.splice(t,1)}_setMaterial(e){if(this._material=e,this._model)for(let t=0,s=this._model.meshInstances.length;t<s;t++){this._model.meshInstances[t].material=e}}_updateMaterial(e){const t=this._element,s=t._isScreenCulled(),i=function(e){return t.isVisibleForCamera(e)},n=this._font&&this._font.type===PS;if(this._material=this._system.getTextElementMaterial(e,n,this._enableMarkup),this._model)for(let t=0,n=this._model.meshInstances.length;t<n;t++){const n=this._model.meshInstances[t];n.cull=!e,n.material=this._material,n.screenSpace=e,s?(n.cull=!0,n.isVisibleFunc=i):n.isVisibleFunc=null}}_updateMaterialEmissive(){this._symbolColors?(this._colorUniform[0]=1,this._colorUniform[1]=1,this._colorUniform[2]=1):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b)}_updateMaterialOutline(){this._symbolOutlineParams?(this._outlineColorUniform[0]=0,this._outlineColorUniform[1]=0,this._outlineColorUniform[2]=0,this._outlineColorUniform[3]=1):(this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a)}_updateMaterialShadow(){this._symbolOutlineParams?(this._shadowColorUniform[0]=0,this._shadowColorUniform[1]=0,this._shadowColorUniform[2]=0,this._shadowColorUniform[3]=0):(this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=this._shadowColor.a)}_isWordBoundary(e){return BS.test(e)}_isValidNextChar(e){return null!==e&&!WS.test(e)}_isNextCJKBoundary(e,t){return HS.test(e)&&(BS.test(t)||US.test(t))}_isNextCJKWholeWord(e){return HS.test(e)}_updateMeshes(){const e=this._font.data,t=this,s=Math.min(this._minFontSize,this._maxFontSize),i=this._maxFontSize,n=this._shouldAutoFit();n&&(this._fontSize=this._maxFontSize);const r=this._symbols.length;let a=0,o=0,l=0,h=0,c=1,d=0,u=0,p=0,m=0,_=0,f=0;const g=Math.abs(this._element.anchor.x-this._element.anchor.z)>=1e-4;let v=this._element.calculatedWidth;(this.autoWidth&&!g||!this._wrapLines)&&(v=Number.POSITIVE_INFINITY);let y,b,x,w,S=0,C=0;function T(e,s,i){t._lineWidths.push(Math.abs(i));const n=p>s?s+1:p,r=p>s?p+1:s,l=e.slice(n,r);if(f){let e=l.length;for(;e--&&f>0;)VS.test(l[e])&&(l.splice(e,1),f--)}t._lineContents.push(l.join("")),a=0,o-=t._scaledLineHeight,c++,m=0,_=0,f=0,d=0,p=s}let A=!0;for(;A;){A=!1,this._scaledLineHeight=n?this._lineHeight*this._fontSize/(this._maxFontSize||1e-4):this._lineHeight,this.width=0,this.height=0,this._lineWidths=[],this._lineContents=[],a=0,o=0,l=0,h=0,c=1,d=0,u=0,p=0,m=0,_=0,f=0;const t=this._fontSize/32;S=this._fontMinY*t,C=this._fontMaxY*t;for(let e=0;e<this._meshInfo.length;e++)this._meshInfo[e].quad=0,this._meshInfo[e].lines={};let g=255,E=255,P=255,M=65535,L=65535,D=0,k=65535,I=65535,R=32639;for(let n=0;n<r;n++){y=this._symbols[n],w=n+1>=r?null:this._symbols[n+1];if(VS.test(y)){f++,(!this._wrapLines||this._maxLines<0||c<this._maxLines)&&(T(this._symbols,n,h),u=n+1,p=n+1);continue}let O,z,F=0,V=0,N=0,B=1;if(b=e.chars[y],!b)if(-1!==GS.indexOf(y))b=jS;else if(e.chars[" "])b=e.chars[" "];else for(const t in e.chars){b=e.chars[t];break}if(b){let e=0;if(_>0){const t=this._font.data.kerning;if(t){const s=t[Fd.getCodePoint(this._symbols[n-1])||0];s&&(e=s[Fd.getCodePoint(this._symbols[n])||0]||0)}}O=b.scale||1,z=(b.width+b.height)/2,B=t*z/O,N=(b.xadvance+e)*t,F=(b.xoffset-e)*t,V=b.yoffset*t}else console.error(`Couldn't substitute missing character: '${y}'`);const U=NS.test(y),H=b&&b.map||0,W=-this._font.data.info.maps[H].width/this._font.data.info.maps[H].height,G=this._meshInfo[H],j=a+this._spacing*N;if(j>v&&_>0&&!U&&(this._maxLines<0||c<this._maxLines)){if(0!==m){const t=Math.max(n-u,0);if(this._meshInfo.length<=1)G.lines[c-1]-=t,G.quad-=t;else{const t=n;for(let s=u;s<t;s++){const t=this._symbols[s],i=e.chars[t],n=this._meshInfo[i&&i.map||0];n.lines[c-1]-=1,n.quad-=1}}n-=t+1,T(this._symbols,u,d);continue}u=n,T(this._symbols,n,h)}x=G.quad,G.lines[c-1]=x;let q=a-F,K=q+B;const X=o-V,Y=X+B;if(this._rtl){const e=B-F-this._spacing*N-F;q-=e,K-=e}let Z;if(G.positions[4*x*3+0]=q,G.positions[4*x*3+1]=X,G.positions[4*x*3+2]=l,G.positions[4*x*3+3]=K,G.positions[4*x*3+4]=X,G.positions[4*x*3+5]=l,G.positions[4*x*3+6]=K,G.positions[4*x*3+7]=Y,G.positions[4*x*3+8]=l,G.positions[4*x*3+9]=q,G.positions[4*x*3+10]=Y,G.positions[4*x*3+11]=l,this.width=Math.max(this.width,j),this._shouldAutoFitWidth()&&this.width>this._element.calculatedWidth&&(Z=Math.floor(this._element.fontSize*this._element.calculatedWidth/(this.width||1e-4)),Z=Wd.clamp(Z,s,i),Z!==this._element.fontSize)){this._fontSize=Z,A=!0;break}if(this.height=Math.max(this.height,C-(o+S)),this._shouldAutoFitHeight()&&this.height>this._element.calculatedHeight&&(Z=Wd.clamp(this._fontSize-1,s,i),Z!==this._element.fontSize)){this._fontSize=Z,A=!0;break}a+=this._spacing*N,U||(h=a),(this._isWordBoundary(y)||this._isValidNextChar(w)&&(this._isNextCJKBoundary(y,w)||this._isNextCJKWholeWord(w)))&&(m++,d=h,u=n+1),_++;const $=this._getUv(y);if(G.uvs[4*x*2+0]=$[0],G.uvs[4*x*2+1]=1-$[1],G.uvs[4*x*2+2]=$[2],G.uvs[4*x*2+3]=1-$[1],G.uvs[4*x*2+4]=$[2],G.uvs[4*x*2+5]=1-$[3],G.uvs[4*x*2+6]=$[0],G.uvs[4*x*2+7]=1-$[3],this._symbolColors){const e=3*this._symbolColors[n];g=this._colorPalette[e],E=this._colorPalette[e+1],P=this._colorPalette[e+2]}if(G.colors[4*x*4+0]=g,G.colors[4*x*4+1]=E,G.colors[4*x*4+2]=P,G.colors[4*x*4+3]=255,G.colors[4*x*4+4]=g,G.colors[4*x*4+5]=E,G.colors[4*x*4+6]=P,G.colors[4*x*4+7]=255,G.colors[4*x*4+8]=g,G.colors[4*x*4+9]=E,G.colors[4*x*4+10]=P,G.colors[4*x*4+11]=255,G.colors[4*x*4+12]=g,G.colors[4*x*4+13]=E,G.colors[4*x*4+14]=P,G.colors[4*x*4+15]=255,this._symbolOutlineParams){const e=5*this._symbolOutlineParams[n];M=this._outlinePalette[e]+256*this._outlinePalette[e+1],L=this._outlinePalette[e+2]+256*this._outlinePalette[e+3],D=this._outlinePalette[e+4]}if(G.outlines[4*x*3+0]=M,G.outlines[4*x*3+1]=L,G.outlines[4*x*3+2]=D,G.outlines[4*x*3+3]=M,G.outlines[4*x*3+4]=L,G.outlines[4*x*3+5]=D,G.outlines[4*x*3+6]=M,G.outlines[4*x*3+7]=L,G.outlines[4*x*3+8]=D,G.outlines[4*x*3+9]=M,G.outlines[4*x*3+10]=L,G.outlines[4*x*3+11]=D,this._symbolShadowParams){const e=6*this._symbolShadowParams[n];k=this._shadowPalette[e]+256*this._shadowPalette[e+1],I=this._shadowPalette[e+2]+256*this._shadowPalette[e+3],R=this._shadowPalette[e+4]+127+256*Math.round(W*this._shadowPalette[e+5]+127)}G.shadows[4*x*3+0]=k,G.shadows[4*x*3+1]=I,G.shadows[4*x*3+2]=R,G.shadows[4*x*3+3]=k,G.shadows[4*x*3+4]=I,G.shadows[4*x*3+5]=R,G.shadows[4*x*3+6]=k,G.shadows[4*x*3+7]=I,G.shadows[4*x*3+8]=R,G.shadows[4*x*3+9]=k,G.shadows[4*x*3+10]=I,G.shadows[4*x*3+11]=R,G.quad++}A||p<r&&T(this._symbols,r,a)}this._noResize=!0,this.autoWidth=this._autoWidth,this.autoHeight=this._autoHeight,this._noResize=!1;const E=this._element.pivot.x,P=this._element.pivot.y,M=this._alignment.x,L=this._alignment.y;for(let e=0;e<this._meshInfo.length;e++){if(0===this._meshInfo[e].count)continue;let t=0;for(const s in this._meshInfo[e].lines){const i=this._meshInfo[e].lines[s],n=this._lineWidths[parseInt(s,10)],r=-E*this._element.calculatedWidth+M*(this._element.calculatedWidth-n)*(this._rtl?-1:1),a=(1-P)*this._element.calculatedHeight-C-(1-L)*(this._element.calculatedHeight-this.height);for(let s=t;s<=i;s++)this._meshInfo[e].positions[4*s*3]+=r,this._meshInfo[e].positions[4*s*3+3]+=r,this._meshInfo[e].positions[4*s*3+6]+=r,this._meshInfo[e].positions[4*s*3+9]+=r,this._meshInfo[e].positions[4*s*3+1]+=a,this._meshInfo[e].positions[4*s*3+4]+=a,this._meshInfo[e].positions[4*s*3+7]+=a,this._meshInfo[e].positions[4*s*3+10]+=a;if(this._rtl)for(let s=t;s<=i;s++){const t=4*s*3;for(let s=0;s<4;++s)this._meshInfo[e].positions[t+3*s]=this._element.calculatedWidth-this._meshInfo[e].positions[t+3*s]+2*r;const i=this._meshInfo[e].positions[t+3],n=this._meshInfo[e].positions[t+6];this._meshInfo[e].positions[t+3]=this._meshInfo[e].positions[t+0],this._meshInfo[e].positions[t+6]=this._meshInfo[e].positions[t+9],this._meshInfo[e].positions[t+0]=i,this._meshInfo[e].positions[t+9]=n}t=i+1}const s=4*this._meshInfo[e].count,i=4*this._meshInfo[e].quad,n=new Xm(this._meshInfo[e].meshInstance.mesh.vertexBuffer);for(let t=0;t<s;t++)t>=i?(n.element[Ou].set(0,0,0),n.element[Hu].set(0,0),n.element[Bu].set(0,0,0,0),n.element[qu].set(0,0,0,0),n.element[Ku].set(0,0,0,0)):(n.element[Ou].set(this._meshInfo[e].positions[3*t+0],this._meshInfo[e].positions[3*t+1],this._meshInfo[e].positions[3*t+2]),n.element[Hu].set(this._meshInfo[e].uvs[2*t+0],this._meshInfo[e].uvs[2*t+1]),n.element[Bu].set(this._meshInfo[e].colors[4*t+0],this._meshInfo[e].colors[4*t+1],this._meshInfo[e].colors[4*t+2],this._meshInfo[e].colors[4*t+3]),n.element[qu].set(this._meshInfo[e].outlines[3*t+0],this._meshInfo[e].outlines[3*t+1],this._meshInfo[e].outlines[3*t+2]),n.element[Ku].set(this._meshInfo[e].shadows[3*t+0],this._meshInfo[e].shadows[3*t+1],this._meshInfo[e].shadows[3*t+2])),n.next();n.end(),this._meshInfo[e].meshInstance.mesh.aabb.compute(this._meshInfo[e].positions),this._meshInfo[e].meshInstance._aabbVer=-1}this._aabbDirty=!0}_onFontRender(){this.font=this._font}_onFontLoad(e){this.font!==e.resource&&(this.font=e.resource)}_onFontChange(e,t,s,i){if("data"===t){this._font.data=s;const e=this._font.data.info.maps.length;for(let t=0;t<e;t++){if(!this._meshInfo[t])continue;const e=this._meshInfo[t].meshInstance;e&&(e.setParameter("font_sdfIntensity",this._font.intensity),e.setParameter("font_pxrange",this._getPxRange(this._font)),e.setParameter("font_textureWidth",this._font.data.info.maps[t].width))}}}_onFontRemove(e){}_setTextureParams(e,t){this._font&&(this._font.type===PS?(e.deleteParameter("texture_emissiveMap"),e.deleteParameter("texture_opacityMap"),e.setParameter("texture_msdfMap",t)):"bitmap"===this._font.type&&(e.deleteParameter("texture_msdfMap"),e.setParameter("texture_emissiveMap",t),e.setParameter("texture_opacityMap",t)))}_getPxRange(e){const t=Object.keys(this._font.data.chars);for(let e=0;e<t.length;e++){const s=this._font.data.chars[t[e]];if(s.range)return(s.scale||1)*s.range}return 2}_getUv(e){const t=this._font.data;if(!t.chars[e]){const e=" ";return t.chars[e]?this._getUv(e):[0,0,0,0]}const s=t.chars[e].map,i=t.info.maps[s].width,n=t.info.maps[s].height,r=t.chars[e].x,a=t.chars[e].y,o=r,l=a,h=r+t.chars[e].width,c=a-t.chars[e].height,d=1-t.chars[e].height/n;return[o/i,d-l/n,h/i,d-c/n]}onEnable(){this._fontAsset.autoLoad=!0,this._model&&this._element.addModelToLayers(this._model)}onDisable(){this._fontAsset.autoLoad=!1,this._model&&this._element.removeModelFromLayers(this._model)}_setStencil(e){if(this._model){const t=this._model.meshInstances;for(let s=0;s<t.length;s++)t[s].stencilFront=e,t[s].stencilBack=e}}_shouldAutoFitWidth(){return this._autoFitWidth&&!this._autoWidth}_shouldAutoFitHeight(){return this._autoFitHeight&&!this._autoHeight}_shouldAutoFit(){return this._autoFitWidth&&!this._autoWidth||this._autoFitHeight&&!this._autoHeight}_calculateCharsPerTexture(e){const t={};void 0===e&&(e=this._symbols.length);for(let s=0,i=e;s<i;s++){const e=this._symbols[s];let i=this._font.data.chars[e];i||(i=this._font.data.chars[" "],i||(i=this._font.data.chars[Object.keys(this._font.data.chars)[0]]));const n=i.map;t[n]?t[n]++:t[n]=1}return t}_updateRenderRange(){const e=0===this._rangeStart?0:this._calculateCharsPerTexture(this._rangeStart),t=0===this._rangeEnd?0:this._calculateCharsPerTexture(this._rangeEnd);for(let s=0,i=this._meshInfo.length;s<i;s++){const i=e[s]||0,n=t[s]||0,r=this._meshInfo[s].meshInstance;if(r){const e=r.mesh;e&&(e.primitive[0].base=3*i*2,e.primitive[0].count=3*(n-i)*2)}}}set text(e){this._i18nKey=null;const t=null!=e&&e.toString()||"";this._setText(t)}get text(){return this._text}set key(e){const t=null!==e?e.toString():null;this._i18nKey!==t&&(this._i18nKey=t,t?(this._fontAsset.disableLocalization=!1,this._resetLocalizedText()):this._fontAsset.disableLocalization=!0)}get key(){return this._i18nKey}set color(e){const t=e.r,s=e.g,i=e.b;if((this._color.r!==t||this._color.g!==s||this._color.b!==i)&&(this._color.r=t,this._color.g=s,this._color.b=i,this._model)){if(this._symbolColors)this._font&&this._updateText();else{this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b;for(let e=0,t=this._model.meshInstances.length;e<t;e++){this._model.meshInstances[e].setParameter("material_emissive",this._colorUniform)}}this._element&&this._element.fire("set:color",this._color)}}get color(){return this._color}set opacity(e){if(this._color.a!==e&&(this._color.a=e,this._model))for(let t=0,s=this._model.meshInstances.length;t<s;t++){this._model.meshInstances[t].setParameter("material_opacity",e)}this._element&&this._element.fire("set:opacity",e)}get opacity(){return this._color.a}set lineHeight(e){const t=this._lineHeight;this._lineHeight=e,this._scaledLineHeight=e,t!==e&&this._font&&this._updateText()}get lineHeight(){return this._lineHeight}set wrapLines(e){const t=this._wrapLines;this._wrapLines=e,t!==e&&this._font&&this._updateText()}get wrapLines(){return this._wrapLines}get lines(){return this._lineContents}set spacing(e){const t=this._spacing;this._spacing=e,t!==e&&this._font&&this._updateText()}get spacing(){return this._spacing}set fontSize(e){const t=this._fontSize;this._fontSize=e,this._originalFontSize=e,t!==e&&this._font&&this._updateText()}get fontSize(){return this._fontSize}set fontAsset(e){this._fontAsset.defaultAsset=e}get fontAsset(){return this._fontAsset.localizedAsset}set font(e){let t;if(this._font&&(t=this._font.type,this._font.off&&this._font.off("render",this._onFontRender,this)),this._font=e,this._fontMinY=0,this._fontMaxY=0,!e)return;const s=this._font.data;for(const e in s.chars){const t=s.chars[e];t.bounds&&(this._fontMinY=Math.min(this._fontMinY,t.bounds[1]),this._fontMaxY=Math.max(this._fontMaxY,t.bounds[3]))}if(this._font.on&&this._font.on("render",this._onFontRender,this),this._fontAsset.localizedAsset){this._system.app.assets.get(this._fontAsset.localizedAsset).resource!==this._font&&(this._fontAsset.defaultAsset=null)}if(e.type!==t){const e=this._element._isScreenSpace();this._updateMaterial(e)}for(let e=0,t=this._font.textures.length;e<t;e++)if(this._meshInfo[e]){const t=this._meshInfo[e].meshInstance;t&&(t.setParameter("font_sdfIntensity",this._font.intensity),t.setParameter("font_pxrange",this._getPxRange(this._font)),t.setParameter("font_textureWidth",this._font.data.info.maps[e].width),this._setTextureParams(t,this._font.textures[e]))}else this._meshInfo[e]=new zS;let i=!1;for(let e=this._font.textures.length;e<this._meshInfo.length;e++)this._meshInfo[e].meshInstance&&(i||(this._element.removeModelFromLayers(this._model),i=!0),this._removeMeshInstance(this._meshInfo[e].meshInstance));this._meshInfo.length>this._font.textures.length&&(this._meshInfo.length=this._font.textures.length),this._updateText()}get font(){return this._font}set alignment(e){e instanceof au?this._alignment.set(e.x,e.y):this._alignment.set(e[0],e[1]),this._font&&this._updateText()}get alignment(){return this._alignment}set autoWidth(e){const t=this._autoWidth;if(this._autoWidth=e,e&&Math.abs(this._element.anchor.x-this._element.anchor.z)<1e-4&&(this._element.width=this.width),t!==e){const e=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;e!==this._fontSize&&(this._fontSize=e,this._font&&this._updateText())}}get autoWidth(){return this._autoWidth}set autoHeight(e){const t=this._autoHeight;if(this._autoHeight=e,e&&Math.abs(this._element.anchor.y-this._element.anchor.w)<1e-4&&(this._element.height=this.height),t!==e){const e=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;e!==this._fontSize&&(this._fontSize=e,this._font&&this._updateText())}}get autoHeight(){return this._autoHeight}set rtlReorder(e){this._rtlReorder!==e&&(this._rtlReorder=e,this._font&&this._updateText())}get rtlReorder(){return this._rtlReorder}set unicodeConverter(e){this._unicodeConverter!==e&&(this._unicodeConverter=e,this._setText(this._text))}get unicodeConverter(){return this._unicodeConverter}get aabb(){if(this._aabbDirty){let e=!1;for(let t=0;t<this._meshInfo.length;t++)this._meshInfo[t].meshInstance&&(e?this._aabb.add(this._meshInfo[t].meshInstance.aabb):(this._aabb.copy(this._meshInfo[t].meshInstance.aabb),e=!0));this._aabbDirty=!1}return this._aabb}set outlineColor(e){const t=e instanceof jd?e.r:e[0],s=e instanceof jd?e.g:e[1],i=e instanceof jd?e.b:e[2],n=e instanceof jd?e.a:e[3];if((this._outlineColor.r!==t||this._outlineColor.g!==s||this._outlineColor.b!==i||this._outlineColor.a!==n)&&(this._outlineColor.r=t,this._outlineColor.g=s,this._outlineColor.b=i,this._outlineColor.a=n,this._model)){if(this._symbolOutlineParams)this._font&&this._updateText();else{this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a;for(let e=0,t=this._model.meshInstances.length;e<t;e++){this._model.meshInstances[e].setParameter("outline_color",this._outlineColorUniform)}}this._element&&this._element.fire("set:outline",this._color)}}get outlineColor(){return this._outlineColor}set outlineThickness(e){const t=this._outlineThickness;if(this._outlineThickness=e,t!==e&&this._font){if(!this._model)return;if(this._symbolOutlineParams)this._font&&this._updateText();else for(let e=0,t=this._model.meshInstances.length;e<t;e++){this._model.meshInstances[e].setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness)}}}get outlineThickness(){return this._outlineThickness}set shadowColor(e){const t=e instanceof jd?e.r:e[0],s=e instanceof jd?e.g:e[1],i=e instanceof jd?e.b:e[2],n=e instanceof jd?e.a:e[3];if((this._shadowColor.r!==t||this._shadowColor.g!==s||this._shadowColor.b!==i||this._shadowColor.a!==n)&&(this._shadowColor.r=t,this._shadowColor.g=s,this._shadowColor.b=i,this._shadowColor.a=n,this._model))if(this._symbolShadowParams)this._font&&this._updateText();else{this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=this._shadowColor.a;for(let e=0,t=this._model.meshInstances.length;e<t;e++){this._model.meshInstances[e].setParameter("shadow_color",this._shadowColorUniform)}}}get shadowColor(){return this._shadowColor}set shadowOffset(e){const t=e instanceof au?e.x:e[0],s=e instanceof au?e.y:e[1];if((this._shadowOffset.x!==t||this._shadowOffset.y!==s)&&(this._shadowOffset.set(t,s),this._font&&this._model))if(this._symbolShadowParams)this._updateText();else for(let e=0,t=this._model.meshInstances.length;e<t;e++){const t=-this._font.data.info.maps[e].width/this._font.data.info.maps[e].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=t*this._shadowOffsetScale*this._shadowOffset.y;this._model.meshInstances[e].setParameter("shadow_offset",this._shadowOffsetUniform)}}get shadowOffset(){return this._shadowOffset}set minFontSize(e){this._minFontSize!==e&&(this._minFontSize=e,this.font&&this._shouldAutoFit()&&this._updateText())}get minFontSize(){return this._minFontSize}set maxFontSize(e){this._maxFontSize!==e&&(this._maxFontSize=e,this.font&&this._shouldAutoFit()&&this._updateText())}get maxFontSize(){return this._maxFontSize}set autoFitWidth(e){this._autoFitWidth!==e&&(this._autoFitWidth=e,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}get autoFitWidth(){return this._autoFitWidth}set autoFitHeight(e){this._autoFitHeight!==e&&(this._autoFitHeight=e,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}get autoFitHeight(){return this._autoFitHeight}set maxLines(e){this._maxLines!==e&&(null===e&&-1===this._maxLines||(this._maxLines=null===e?-1:e,this.font&&this._wrapLines&&this._updateText()))}get maxLines(){return this._maxLines}set enableMarkup(e){if(e=!!e,this._enableMarkup===e)return;this._enableMarkup=e,this.font&&this._updateText();const t=this._element._isScreenSpace();this._updateMaterial(t)}get enableMarkup(){return this._enableMarkup}get symbols(){return this._symbols}get symbolColors(){return null===this._symbolColors?null:this._symbolColors.map((function(e){return this._colorPalette.slice(3*e,3*e+3)}),this)}get symbolOutlineParams(){return null===this._symbolOutlineParams?null:this._symbolOutlineParams.map((function(e){return this._outlinePalette.slice(5*e,5*e+5)}),this)}get symbolShadowParams(){return null===this._symbolShadowParams?null:this._symbolShadowParams.map((function(e){return this._shadowPalette.slice(6*e,6*e+6)}),this)}get rtl(){return this._rtl}set rangeStart(e){(e=Math.max(0,Math.min(e,this._symbols.length)))!==this._rangeStart&&(this._rangeStart=e,this._updateRenderRange())}get rangeStart(){return this._rangeStart}set rangeEnd(e){(e=Math.max(this._rangeStart,Math.min(e,this._symbols.length)))!==this._rangeEnd&&(this._rangeEnd=e,this._updateRenderRange())}get rangeEnd(){return this._rangeEnd}}const YS=new nu,ZS=new pu,$S=new nu,QS=new nu,JS=new pu,eC=new pu,tC=new pu,sC=new pu;class iC extends vw{constructor(e,t){super(e,t),this._beingInitialized=!1,this._anchor=new ou,this._localAnchor=new ou,this._pivot=new au,this._width=this._calculatedWidth=32,this._height=this._calculatedHeight=32,this._margin=new ou(0,0,-32,-32),this._modelTransform=new pu,this._screenToWorld=new pu,this._anchorTransform=new pu,this._anchorDirty=!0,this._parentWorldTransform=new pu,this._screenTransform=new pu,this._screenCorners=[new nu,new nu,new nu,new nu],this._canvasCorners=[new au,new au,new au,new au],this._worldCorners=[new nu,new nu,new nu,new nu],this._cornersDirty=!0,this._canvasCornersDirty=!0,this._worldCornersDirty=!0,this.entity.on("insert",this._onInsert,this),this._patch(),this.screen=null,this._type=oS,this._image=null,this._text=null,this._group=null,this._drawOrder=0,this._fitMode=lS,this._useInput=!1,this._layers=[4],this._addedModels=[],this._batchGroupId=-1,this._offsetReadAt=0,this._maskOffset=.5,this._maskedBy=null}get _absLeft(){return this._localAnchor.x+this._margin.x}get _absRight(){return this._localAnchor.z-this._margin.z}get _absTop(){return this._localAnchor.w-this._margin.w}get _absBottom(){return this._localAnchor.y+this._margin.y}get _hasSplitAnchorsX(){return Math.abs(this._anchor.x-this._anchor.z)>.001}get _hasSplitAnchorsY(){return Math.abs(this._anchor.y-this._anchor.w)>.001}get aabb(){return this._image?this._image.aabb:this._text?this._text.aabb:null}set anchor(e){e instanceof ou?this._anchor.copy(e):this._anchor.set(...e),this.entity._parent||this.screen?this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY):this._calculateLocalAnchors(),this._anchorDirty=!0,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:anchor",this._anchor)}get anchor(){return this._anchor}set batchGroupId(e){if(this._batchGroupId!==e){var t,s;if(this.entity.enabled&&this._batchGroupId>=0)null==(t=this.system.app.batcher)||t.remove(Ef.ELEMENT,this.batchGroupId,this.entity);if(this.entity.enabled&&e>=0)null==(s=this.system.app.batcher)||s.insert(Ef.ELEMENT,e,this.entity);e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&(this._image&&this._image._renderable.model?this.addModelToLayers(this._image._renderable.model):this._text&&this._text._model&&this.addModelToLayers(this._text._model)),this._batchGroupId=e}}get batchGroupId(){return this._batchGroupId}set bottom(e){this._margin.y=e;const t=this.entity.getLocalPosition(),s=this._absTop,i=this._localAnchor.y+e;this._setHeight(s-i),t.y=e+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(t)}get bottom(){return this._margin.y}set calculatedWidth(e){this._setCalculatedWidth(e,!0)}get calculatedWidth(){return this._calculatedWidth}set calculatedHeight(e){this._setCalculatedHeight(e,!0)}get calculatedHeight(){return this._calculatedHeight}get canvasCorners(){if(!this._canvasCornersDirty||!this.screen||!this.screen.screen.screenSpace)return this._canvasCorners;const e=this.system.app.graphicsDevice,t=this.screenCorners,s=e.canvas.clientWidth/e.width,i=e.canvas.clientHeight/e.height;for(let n=0;n<4;n++)this._canvasCorners[n].set(t[n].x*s,(e.height-t[n].y)*i);return this._canvasCornersDirty=!1,this._canvasCorners}set drawOrder(e){let t=0;this.screen&&(t=this.screen.screen.priority),e>16777215&&(e=16777215),this._drawOrder=(t<<24)+e,this.fire("set:draworder",this._drawOrder)}get drawOrder(){return this._drawOrder}set height(e){this._height=e,this._hasSplitAnchorsY||this._setCalculatedHeight(e,!0),this.fire("set:height",this._height)}get height(){return this._height}set layers(e){if(this._addedModels.length)for(let e=0;e<this._layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this._layers[e]);if(t)for(let e=0;e<this._addedModels.length;e++)t.removeMeshInstances(this._addedModels[e].meshInstances)}if(this._layers=e,this.enabled&&this.entity.enabled&&this._addedModels.length)for(let e=0;e<this._layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this._layers[e]);if(t)for(let e=0;e<this._addedModels.length;e++)t.addMeshInstances(this._addedModels[e].meshInstances)}}get layers(){return this._layers}set left(e){this._margin.x=e;const t=this.entity.getLocalPosition(),s=this._absRight,i=this._localAnchor.x+e;this._setWidth(s-i),t.x=e+this._calculatedWidth*this._pivot.x,this.entity.setLocalPosition(t)}get left(){return this._margin.x}set margin(e){this._margin.copy(e),this._calculateSize(!0,!0),this.fire("set:margin",this._margin)}get margin(){return this._margin}get maskedBy(){return this._maskedBy}set pivot(e){const{pivot:t,margin:s}=this,i=t.x,n=t.y;e instanceof au?t.copy(e):t.set(...e);const r=s.x+s.z,a=t.x-i;s.x+=r*a,s.z-=r*a;const o=s.y+s.w,l=t.y-n;s.y+=o*l,s.w-=o*l,this._anchorDirty=!0,this._cornersDirty=!0,this._worldCornersDirty=!0,this._calculateSize(!1,!1),this._flagChildrenAsDirty(),this.fire("set:pivot",t)}get pivot(){return this._pivot}set right(e){this._margin.z=e;const t=this.entity.getLocalPosition(),s=this._absLeft,i=this._localAnchor.z-e;this._setWidth(i-s),t.x=this._localAnchor.z-this._localAnchor.x-e-this._calculatedWidth*(1-this._pivot.x),this.entity.setLocalPosition(t)}get right(){return this._margin.z}get screenCorners(){if(!this._cornersDirty||!this.screen)return this._screenCorners;const e=this.entity.parent&&this.entity.parent.element&&this.entity.parent.element.screenCorners[0];this._screenCorners[0].set(this._absLeft,this._absBottom,0),this._screenCorners[1].set(this._absRight,this._absBottom,0),this._screenCorners[2].set(this._absRight,this._absTop,0),this._screenCorners[3].set(this._absLeft,this._absTop,0);const t=this.screen.screen.screenSpace;for(let s=0;s<4;s++)this._screenTransform.transformPoint(this._screenCorners[s],this._screenCorners[s]),t&&this._screenCorners[s].mulScalar(this.screen.screen.scale),e&&this._screenCorners[s].add(e);return this._cornersDirty=!1,this._canvasCornersDirty=!0,this._worldCornersDirty=!0,this._screenCorners}get textWidth(){return this._text?this._text.width:0}get textHeight(){return this._text?this._text.height:0}set top(e){this._margin.w=e;const t=this.entity.getLocalPosition(),s=this._absBottom,i=this._localAnchor.w-e;this._setHeight(i-s),t.y=this._localAnchor.w-this._localAnchor.y-e-this._calculatedHeight*(1-this._pivot.y),this.entity.setLocalPosition(t)}get top(){return this._margin.w}set type(e){e!==this._type&&(this._type=e,this._image&&(this._image.destroy(),this._image=null),this._text&&(this._text.destroy(),this._text=null),"image"===e?this._image=new AS(this):"text"===e&&(this._text=new XS(this)))}get type(){return this._type}set useInput(e){this._useInput!==e&&(this._useInput=e,this.system.app.elementInput?e?this.enabled&&this.entity.enabled&&this.system.app.elementInput.addElement(this):this.system.app.elementInput.removeElement(this):this._useInput,this.fire("set:useInput",e))}get useInput(){return this._useInput}set fitMode(e){this._fitMode=e,this._calculateSize(!0,!0),this._image&&this._image.refreshMesh()}get fitMode(){return this._fitMode}set width(e){this._width=e,this._hasSplitAnchorsX||this._setCalculatedWidth(e,!0),this.fire("set:width",this._width)}get width(){return this._width}get worldCorners(){if(!this._worldCornersDirty)return this._worldCorners;if(this.screen){const e=this.screenCorners;if(!this.screen.screen.screenSpace){JS.copy(this.screen.screen._screenMatrix),JS.data[13]=-JS.data[13],JS.mul2(this.screen.getWorldTransform(),JS);for(let t=0;t<4;t++)JS.transformPoint(e[t],this._worldCorners[t])}}else{const e=this.entity.getLocalPosition();JS.setTranslate(-e.x,-e.y,-e.z),eC.setTRS(nu.ZERO,this.entity.getLocalRotation(),this.entity.getLocalScale()),tC.setTranslate(e.x,e.y,e.z);const t=this.entity.parent?this.entity.parent:this.entity;sC.copy(t.getWorldTransform()),sC.mul(tC).mul(eC).mul(JS),$S.set(e.x-this.pivot.x*this.calculatedWidth,e.y-this.pivot.y*this.calculatedHeight,e.z),sC.transformPoint($S,this._worldCorners[0]),$S.set(e.x+(1-this.pivot.x)*this.calculatedWidth,e.y-this.pivot.y*this.calculatedHeight,e.z),sC.transformPoint($S,this._worldCorners[1]),$S.set(e.x+(1-this.pivot.x)*this.calculatedWidth,e.y+(1-this.pivot.y)*this.calculatedHeight,e.z),sC.transformPoint($S,this._worldCorners[2]),$S.set(e.x-this.pivot.x*this.calculatedWidth,e.y+(1-this.pivot.y)*this.calculatedHeight,e.z),sC.transformPoint($S,this._worldCorners[3])}return this._worldCornersDirty=!1,this._worldCorners}_patch(){this.entity._sync=this._sync,this.entity.setPosition=this._setPosition,this.entity.setLocalPosition=this._setLocalPosition}_unpatch(){this.entity._sync=hw.prototype._sync,this.entity.setPosition=hw.prototype.setPosition,this.entity.setLocalPosition=hw.prototype.setLocalPosition}_setPosition(e,t,s){this.element.screen?(e instanceof nu?YS.copy(e):YS.set(e,t,s),this.getWorldTransform(),ZS.copy(this.element._screenToWorld).invert(),ZS.transformPoint(YS,this.localPosition),this._dirtyLocal||this._dirtifyLocal()):hw.prototype.setPosition.call(this,e,t,s)}_setLocalPosition(e,t,s){e instanceof nu?this.localPosition.copy(e):this.localPosition.set(e,t,s);const i=this.element,n=this.localPosition,r=i._pivot;i._margin.x=n.x-i._calculatedWidth*r.x,i._margin.z=i._localAnchor.z-i._localAnchor.x-i._calculatedWidth-i._margin.x,i._margin.y=n.y-i._calculatedHeight*r.y,i._margin.w=i._localAnchor.w-i._localAnchor.y-i._calculatedHeight-i._margin.y,this._dirtyLocal||this._dirtifyLocal()}_sync(){const e=this.element,t=e.screen;if(t){if(e._anchorDirty){let s=0,i=0,n=0,r=1;if(this._parent&&this._parent.element)s=this._parent.element.calculatedWidth,i=this._parent.element.calculatedHeight,n=this._parent.element.pivot.x,r=this._parent.element.pivot.y;else{const e=t.screen.resolution;s=e.x/t.screen.scale,i=e.y/t.screen.scale}e._anchorTransform.setTranslate(s*(e.anchor.x-n),-i*(r-e.anchor.y),0),e._anchorDirty=!1,e._calculateLocalAnchors()}e._sizeDirty&&e._calculateSize(!1,!1)}if(this._dirtyLocal){this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale);const t=this.localPosition,s=e._pivot;e._margin.x=t.x-e._calculatedWidth*s.x,e._margin.z=e._localAnchor.z-e._localAnchor.x-e._calculatedWidth-e._margin.x,e._margin.y=t.y-e._calculatedHeight*s.y,e._margin.w=e._localAnchor.w-e._localAnchor.y-e._calculatedHeight-e._margin.y,this._dirtyLocal=!1}if(!t)return this._dirtyWorld&&(e._cornersDirty=!0,e._canvasCornersDirty=!0,e._worldCornersDirty=!0),void hw.prototype._sync.call(this);if(this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this._parent.element?e._screenToWorld.mul2(this._parent.element._modelTransform,e._anchorTransform):e._screenToWorld.copy(e._anchorTransform),e._modelTransform.mul2(e._screenToWorld,this.localTransform),t){e._screenToWorld.mul2(t.screen._screenMatrix,e._screenToWorld),t.screen.screenSpace||e._screenToWorld.mul2(t.worldTransform,e._screenToWorld),this.worldTransform.mul2(e._screenToWorld,this.localTransform);const s=e._parentWorldTransform;s.setIdentity();const i=this._parent;i&&i.element&&i!==t&&(JS.setTRS(nu.ZERO,i.getLocalRotation(),i.getLocalScale()),s.mul2(i.element._parentWorldTransform,JS));const n=$S;n.set(0,0,this.localPosition.z);const r=QS;r.set(e._absLeft+e._pivot.x*e.calculatedWidth,e._absBottom+e._pivot.y*e.calculatedHeight,0),JS.setTranslate(-r.x,-r.y,-r.z),eC.setTRS(n,this.getLocalRotation(),this.getLocalScale()),tC.setTranslate(r.x,r.y,r.z),e._screenTransform.mul2(e._parentWorldTransform,tC).mul(eC).mul(JS),e._cornersDirty=!0,e._canvasCornersDirty=!0,e._worldCornersDirty=!0}else this.worldTransform.copy(e._modelTransform);this._dirtyWorld=!1}}_onInsert(e){const t=this._parseUpToScreen();this.entity._dirtifyWorld(),this._updateScreen(t.screen),this._dirtifyMask()}_dirtifyMask(){let e=this.entity;for(;e;){const t=e.parent;if((null===t||t.screen)&&e.element){this.system._prerender&&this.system._prerender.length||(this.system._prerender=[],this.system.app.once("prerender",this._onPrerender,this));const t=this.system._prerender.indexOf(this.entity);t>=0&&this.system._prerender.splice(t,1);this.system._prerender.indexOf(e)<0&&this.system._prerender.push(e)}e=t}}_onPrerender(){for(let e=0;e<this.system._prerender.length;e++){const t=this.system._prerender[e];if(t.element){const e=1;t.element.syncMask(e)}}this.system._prerender.length=0}_bindScreen(e){e._bindElement(this)}_unbindScreen(e){e._unbindElement(this)}_updateScreen(e){this.screen&&this.screen!==e&&this._unbindScreen(this.screen.screen);const t=this.screen;this.screen=e,this.screen&&this._bindScreen(this.screen.screen),this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("set:screen",this.screen,t),this._anchorDirty=!0;const s=this.entity.children;for(let t=0,i=s.length;t<i;t++)s[t].element&&s[t].element._updateScreen(e);this.screen&&this.screen.screen.syncDrawOrder()}syncMask(e){const t=this._parseUpToScreen();this._updateMask(t.mask,e)}_setMaskedBy(e){const t=this._image||this._text;if(e){const s=e.element._image._maskRef;null==t||t._setStencil(new Wp({ref:s,func:2})),this._maskedBy=e}else null==t||t._setStencil(null),this._maskedBy=null}_updateMask(e,t){if(e){if(this._setMaskedBy(e),this.mask){const s=e.element._image._maskRef,i=new Wp({ref:s,func:2,zpass:3});this._image._setStencil(i),this._image._maskRef=t,t++,e=this.entity}const i=this.entity.children;for(let n=0,r=i.length;n<r;n++){var s;null==(s=i[n].element)||s._updateMask(e,t)}this.mask&&t--}else{if(this._setMaskedBy(null),this.mask){const s=new Wp({ref:t,func:7,zpass:2});this._image._setStencil(s),this._image._maskRef=t,t++,e=this.entity}const s=this.entity.children;for(let n=0,r=s.length;n<r;n++){var i;null==(i=s[n].element)||i._updateMask(e,t)}this.mask&&t--}}_parseUpToScreen(){const e={screen:null,mask:null};let t=this.entity._parent;for(;t&&!t.screen;)t.element&&t.element.mask&&(e.mask||(e.mask=t)),t=t.parent;return t&&t.screen&&(e.screen=t),e}_onScreenResize(e){this._anchorDirty=!0,this._cornersDirty=!0,this._worldCornersDirty=!0,this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("screen:set:resolution",e)}_onScreenSpaceChange(){this.fire("screen:set:screenspace",this.screen.screen.screenSpace)}_onScreenRemove(){this.screen&&(this.screen._destroying?this.screen=null:this._updateScreen(null))}_calculateLocalAnchors(){let e=1e3,t=1e3;const s=this.entity._parent;if(s&&s.element)e=s.element.calculatedWidth,t=s.element.calculatedHeight;else if(this.screen){const s=this.screen.screen.resolution,i=this.screen.screen.scale;e=s.x/i,t=s.y/i}this._localAnchor.set(this._anchor.x*e,this._anchor.y*t,this._anchor.z*e,this._anchor.w*t)}getOffsetPosition(e,t){const s=this.entity.getLocalPosition().clone();return s.x+=e,s.y+=t,this._screenToWorld.transformPoint(s,s),s}onLayersChanged(e,t){this.addModelToLayers(this._image?this._image._renderable.model:this._text._model),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||(this._image?e.addMeshInstances(this._image._renderable.model.meshInstances):this._text&&e.addMeshInstances(this._text._model.meshInstances))}onLayerRemoved(e){this.layers.indexOf(e.id)<0||(this._image?e.removeMeshInstances(this._image._renderable.model.meshInstances):this._text&&e.removeMeshInstances(this._text._model.meshInstances))}onEnable(){var e;(this._image&&this._image.onEnable(),this._text&&this._text.onEnable(),this._group&&this._group.onEnable(),this.useInput&&this.system.app.elementInput&&this.system.app.elementInput.addElement(this),this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this._batchGroupId>=0)&&(null==(e=this.system.app.batcher)||e.insert(Ef.ELEMENT,this.batchGroupId,this.entity));this.fire("enableelement")}onDisable(){var e;(this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this._image&&this._image.onDisable(),this._text&&this._text.onDisable(),this._group&&this._group.onDisable(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this._batchGroupId>=0)&&(null==(e=this.system.app.batcher)||e.remove(Ef.ELEMENT,this.batchGroupId,this.entity));this.fire("disableelement")}onRemove(){this.entity.off("insert",this._onInsert,this),this._unpatch(),this._image&&this._image.destroy(),this._text&&this._text.destroy(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this.screen&&this.screen.screen&&(this._unbindScreen(this.screen.screen),this.screen.screen.syncDrawOrder()),this.off()}_calculateSize(e,t){if(!this.entity._parent&&!this.screen)return;this._calculateLocalAnchors();const s=this._absRight-this._absLeft,i=this._absTop-this._absBottom;e?this._setWidth(s):this._setCalculatedWidth(s,!1),t?this._setHeight(i):this._setCalculatedHeight(i,!1);const n=this.entity.getLocalPosition();n.x=this._margin.x+this._calculatedWidth*this._pivot.x,n.y=this._margin.y+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(n),this._sizeDirty=!1}_setWidth(e){this._width=e,this._setCalculatedWidth(e,!1),this.fire("set:width",this._width)}_setHeight(e){this._height=e,this._setCalculatedHeight(e,!1),this.fire("set:height",this._height)}_setCalculatedWidth(e,t){if(!(Math.abs(e-this._calculatedWidth)<=1e-4)){if(this._calculatedWidth=e,this.entity._dirtifyLocal(),t){const e=this.entity.getLocalPosition(),t=this._pivot;this._margin.x=e.x-this._calculatedWidth*t.x,this._margin.z=this._localAnchor.z-this._localAnchor.x-this._calculatedWidth-this._margin.x}this._flagChildrenAsDirty(),this.fire("set:calculatedWidth",this._calculatedWidth),this.fire("resize",this._calculatedWidth,this._calculatedHeight)}}_setCalculatedHeight(e,t){if(!(Math.abs(e-this._calculatedHeight)<=1e-4)){if(this._calculatedHeight=e,this.entity._dirtifyLocal(),t){const e=this.entity.getLocalPosition(),t=this._pivot;this._margin.y=e.y-this._calculatedHeight*t.y,this._margin.w=this._localAnchor.w-this._localAnchor.y-this._calculatedHeight-this._margin.y}this._flagChildrenAsDirty(),this.fire("set:calculatedHeight",this._calculatedHeight),this.fire("resize",this._calculatedWidth,this._calculatedHeight)}}_flagChildrenAsDirty(){const e=this.entity._children;for(let t=0,s=e.length;t<s;t++)e[t].element&&(e[t].element._anchorDirty=!0,e[t].element._sizeDirty=!0)}addModelToLayers(e){this._addedModels.push(e);for(let t=0;t<this.layers.length;t++){const s=this.system.app.scene.layers.getLayerById(this.layers[t]);s&&s.addMeshInstances(e.meshInstances)}}removeModelFromLayers(e){const t=this._addedModels.indexOf(e);t>=0&&this._addedModels.splice(t,1);for(let t=0;t<this.layers.length;t++){const s=this.system.app.scene.layers.getLayerById(this.layers[t]);s&&s.removeMeshInstances(e.meshInstances)}}getMaskOffset(){const e=this.system.app.frame;this._offsetReadAt!==e&&(this._maskOffset=.5,this._offsetReadAt=e);const t=this._maskOffset;return this._maskOffset-=.001,t}isVisibleForCamera(e){let t,s,i,n;if(this.maskedBy){const e=this.maskedBy.element.screenCorners;t=Math.min(Math.min(e[0].x,e[1].x),Math.min(e[2].x,e[3].x)),s=Math.max(Math.max(e[0].x,e[1].x),Math.max(e[2].x,e[3].x)),n=Math.min(Math.min(e[0].y,e[1].y),Math.min(e[2].y,e[3].y)),i=Math.max(Math.max(e[0].y,e[1].y),Math.max(e[2].y,e[3].y))}else{const r=this.system.app.graphicsDevice.width,a=this.system.app.graphicsDevice.height,o=e._rect.z*r,l=e._rect.w*a;t=e._rect.x*r,s=t+o,i=(1-e._rect.y)*a,n=i-l}const r=this.screenCorners,a=Math.min(Math.min(r[0].x,r[1].x),Math.min(r[2].x,r[3].x)),o=Math.max(Math.max(r[0].x,r[1].x),Math.max(r[2].x,r[3].x)),l=Math.min(Math.min(r[0].y,r[1].y),Math.min(r[2].y,r[3].y)),h=Math.max(Math.max(r[0].y,r[1].y),Math.max(r[2].y,r[3].y));return!(o<t||a>s||l>i||h<n)}_isScreenSpace(){return!(!this.screen||!this.screen.screen)&&this.screen.screen.screenSpace}_isScreenCulled(){return!(!this.screen||!this.screen.screen)&&this.screen.screen.cull}_dirtyBatch(){var e;-1!==this.batchGroupId&&(null==(e=this.system.app.batcher)||e.markGroupDirty(this.batchGroupId))}}function nC(e){Object.defineProperty(iC.prototype,e,{get:function(){return this._text?this._text[e]:this._image?this._image[e]:null},set:function(t){this._text?(this._text[e]!==t&&this._dirtyBatch(),this._text[e]=t):this._image&&(this._image[e]!==t&&this._dirtyBatch(),this._image[e]=t)}})}iC.EVENT_MOUSEDOWN="mousedown",iC.EVENT_MOUSEUP="mouseup",iC.EVENT_MOUSEENTER="mouseenter",iC.EVENT_MOUSELEAVE="mouseleave",iC.EVENT_MOUSEMOVE="mousemove",iC.EVENT_MOUSEWHEEL="mousewheel",iC.EVENT_CLICK="click",iC.EVENT_TOUCHSTART="touchstart",iC.EVENT_TOUCHEND="touchend",iC.EVENT_TOUCHMOVE="touchmove",iC.EVENT_TOUCHCANCEL="touchcancel",nC("fontSize"),nC("minFontSize"),nC("maxFontSize"),nC("maxLines"),nC("autoFitWidth"),nC("autoFitHeight"),nC("color"),nC("font"),nC("fontAsset"),nC("spacing"),nC("lineHeight"),nC("wrapLines"),nC("lines"),nC("alignment"),nC("autoWidth"),nC("autoHeight"),nC("rtlReorder"),nC("unicodeConverter"),nC("text"),nC("key"),nC("texture"),nC("textureAsset"),nC("material"),nC("materialAsset"),nC("sprite"),nC("spriteAsset"),nC("spriteFrame"),nC("pixelsPerUnit"),nC("opacity"),nC("rect"),nC("mask"),nC("outlineColor"),nC("outlineThickness"),nC("shadowColor"),nC("shadowOffset"),nC("enableMarkup"),nC("rangeStart"),nC("rangeEnd");vw._buildAccessors(iC.prototype,["enabled"]);const rC="free",aC="limited",oC="locked",lC=["angularDampingX","angularDampingY","angularDampingZ","angularEquilibriumX","angularEquilibriumY","angularEquilibriumZ","angularLimitsX","angularLimitsY","angularLimitsZ","angularMotionX","angularMotionY","angularMotionZ","angularSpringX","angularSpringY","angularSpringZ","angularStiffnessX","angularStiffnessY","angularStiffnessZ","breakForce","enableCollision","enabled","entityA","entityB","linearDampingX","linearDampingY","linearDampingZ","linearEquilibriumX","linearEquilibriumY","linearEquilibriumZ","linearLimitsX","linearLimitsY","linearLimitsZ","linearMotionX","linearMotionY","linearMotionZ","linearSpringX","linearSpringY","linearSpringZ","linearStiffnessX","linearStiffnessY","linearStiffnessZ"];class hC extends vw{constructor(e,t){super(e,t),this._constraint=null,this._entityA=null,this._entityB=null,this._breakForce=34e37,this._enableCollision=!0,this._linearMotionX=oC,this._linearLimitsX=new au(0,0),this._linearSpringX=!1,this._linearStiffnessX=0,this._linearDampingX=1,this._linearEquilibriumX=0,this._linearMotionY=oC,this._linearLimitsY=new au(0,0),this._linearSpringY=!1,this._linearStiffnessY=0,this._linearDampingY=1,this._linearEquilibriumY=0,this._linearMotionZ=oC,this._linearLimitsZ=new au(0,0),this._linearSpringZ=!1,this._linearStiffnessZ=0,this._linearDampingZ=1,this._linearEquilibriumZ=0,this._angularMotionX=oC,this._angularLimitsX=new au(0,0),this._angularSpringX=!1,this._angularStiffnessX=0,this._angularDampingX=1,this._angularEquilibriumX=0,this._angularMotionY=oC,this._angularLimitsY=new au(0,0),this._angularSpringY=!1,this._angularStiffnessY=0,this._angularDampingY=1,this._angularEquilibriumY=0,this._angularMotionZ=oC,this._angularLimitsZ=new au(0,0),this._angularSpringZ=!1,this._angularEquilibriumZ=0,this._angularDampingZ=1,this._angularStiffnessZ=0,this.on("set_enabled",this._onSetEnabled,this)}set entityA(e){this._destroyConstraint(),this._entityA=e,this._createConstraint()}get entityA(){return this._entityA}set entityB(e){this._destroyConstraint(),this._entityB=e,this._createConstraint()}get entityB(){return this._entityB}set breakForce(e){this._constraint&&this._breakForce!==e&&(this._constraint.setBreakingImpulseThreshold(e),this._breakForce=e)}get breakForce(){return this._breakForce}set enableCollision(e){this._destroyConstraint(),this._enableCollision=e,this._createConstraint()}get enableCollision(){return this._enableCollision}set angularLimitsX(e){this._angularLimitsX.equals(e)||(this._angularLimitsX.copy(e),this._updateAngularLimits())}get angularLimitsX(){return this._angularLimitsX}set angularMotionX(e){this._angularMotionX!==e&&(this._angularMotionX=e,this._updateAngularLimits())}get angularMotionX(){return this._angularMotionX}set angularLimitsY(e){this._angularLimitsY.equals(e)||(this._angularLimitsY.copy(e),this._updateAngularLimits())}get angularLimitsY(){return this._angularLimitsY}set angularMotionY(e){this._angularMotionY!==e&&(this._angularMotionY=e,this._updateAngularLimits())}get angularMotionY(){return this._angularMotionY}set angularLimitsZ(e){this._angularLimitsZ.equals(e)||(this._angularLimitsZ.copy(e),this._updateAngularLimits())}get angularLimitsZ(){return this._angularLimitsZ}set angularMotionZ(e){this._angularMotionZ!==e&&(this._angularMotionZ=e,this._updateAngularLimits())}get angularMotionZ(){return this._angularMotionZ}set linearLimitsX(e){this._linearLimitsX.equals(e)||(this._linearLimitsX.copy(e),this._updateLinearLimits())}get linearLimitsX(){return this._linearLimitsX}set linearMotionX(e){this._linearMotionX!==e&&(this._linearMotionX=e,this._updateLinearLimits())}get linearMotionX(){return this._linearMotionX}set linearLimitsY(e){this._linearLimitsY.equals(e)||(this._linearLimitsY.copy(e),this._updateLinearLimits())}get linearLimitsY(){return this._linearLimitsY}set linearMotionY(e){this._linearMotionY!==e&&(this._linearMotionY=e,this._updateLinearLimits())}get linearMotionY(){return this._linearMotionY}set linearLimitsZ(e){this._linearLimitsZ.equals(e)||(this._linearLimitsZ.copy(e),this._updateLinearLimits())}get linearLimitsZ(){return this._linearLimitsZ}set linearMotionZ(e){this._linearMotionZ!==e&&(this._linearMotionZ=e,this._updateLinearLimits())}get linearMotionZ(){return this._linearMotionZ}_convertTransform(e,t){const s=e.getTranslation(),i=new _u;i.setFromMat4(e);const n=new Ammo.btVector3(s.x,s.y,s.z),r=new Ammo.btQuaternion(i.x,i.y,i.z,i.w);t.setOrigin(n),t.setRotation(r),Ammo.destroy(n),Ammo.destroy(r)}_updateAngularLimits(){const e=this._constraint;if(e){let t,s,i,n,r,a;this._angularMotionX===aC?(t=this._angularLimitsX.x*Wd.DEG_TO_RAD,n=this._angularLimitsX.y*Wd.DEG_TO_RAD):this._angularMotionX===rC?(t=1,n=0):t=n=0,this._angularMotionY===aC?(s=this._angularLimitsY.x*Wd.DEG_TO_RAD,r=this._angularLimitsY.y*Wd.DEG_TO_RAD):this._angularMotionY===rC?(s=1,r=0):s=r=0,this._angularMotionZ===aC?(i=this._angularLimitsZ.x*Wd.DEG_TO_RAD,a=this._angularLimitsZ.y*Wd.DEG_TO_RAD):this._angularMotionZ===rC?(i=1,a=0):i=a=0;const o=new Ammo.btVector3(t,s,i);e.setAngularLowerLimit(o),o.setValue(n,r,a),e.setAngularUpperLimit(o),Ammo.destroy(o)}}_updateLinearLimits(){const e=this._constraint;if(e){let t,s,i,n,r,a;this._linearMotionX===aC?(t=this._linearLimitsX.x,n=this._linearLimitsX.y):this._linearMotionX===rC?(t=1,n=0):t=n=0,this._linearMotionY===aC?(s=this._linearLimitsY.x,r=this._linearLimitsY.y):this._linearMotionY===rC?(s=1,r=0):s=r=0,this._linearMotionZ===aC?(i=this._linearLimitsZ.x,a=this._linearLimitsZ.y):this._linearMotionZ===rC?(i=1,a=0):i=a=0;const o=new Ammo.btVector3(t,s,i);e.setLinearLowerLimit(o),o.setValue(n,r,a),e.setLinearUpperLimit(o),Ammo.destroy(o)}}_createConstraint(){if(this._entityA&&this._entityA.rigidbody){this._destroyConstraint();const e=new pu,t=this._entityA.rigidbody.body;t.activate();const s=this.entity.getWorldTransform(),i=this._entityA.getWorldTransform().clone().invert();e.mul2(i,s);const n=new Ammo.btTransform;if(this._convertTransform(e,n),this._entityB&&this._entityB.rigidbody){const i=this._entityB.rigidbody.body;i.activate();const r=this._entityB.getWorldTransform().clone().invert();e.mul2(r,s);const a=new Ammo.btTransform;this._convertTransform(e,a),this._constraint=new Ammo.btGeneric6DofSpringConstraint(t,i,n,a,!this._enableCollision),Ammo.destroy(a)}else this._constraint=new Ammo.btGeneric6DofSpringConstraint(t,n,!this._enableCollision);Ammo.destroy(n);const r=["X","Y","Z","X","Y","Z"];for(let e=0;e<6;e++){const t=e<3?"_linear":"_angular";this._constraint.enableSpring(e,this[t+"Spring"+r[e]]),this._constraint.setDamping(e,this[t+"Damping"+r[e]]),this._constraint.setEquilibriumPoint(e,this[t+"Equilibrium"+r[e]]),this._constraint.setStiffness(e,this[t+"Stiffness"+r[e]])}this._constraint.setBreakingImpulseThreshold(this._breakForce),this._updateLinearLimits(),this._updateAngularLimits();this.system.app.systems.rigidbody.dynamicsWorld.addConstraint(this._constraint,!this._enableCollision)}}_destroyConstraint(){if(this._constraint){this.system.app.systems.rigidbody.dynamicsWorld.removeConstraint(this._constraint),Ammo.destroy(this._constraint),this._constraint=null}}initFromData(e){for(const t of lC)e.hasOwnProperty(t)&&(e[t]instanceof au?this["_"+t].copy(e[t]):this["_"+t]=e[t]);this._createConstraint()}onEnable(){this._createConstraint()}onDisable(){this._destroyConstraint()}_onSetEnabled(e,t,s){}_onBeforeRemove(){this.fire("remove")}}const cC={Damping:"setDamping",Equilibrium:"setEquilibriumPoint",Spring:"enableSpring",Stiffness:"setStiffness"};["linear","angular"].forEach((e=>{["Damping","Equilibrium","Spring","Stiffness"].forEach((t=>{["X","Y","Z"].forEach((s=>{const i=e+t+s,n="_"+i;let r="linear"===e?0:3;"Y"===s&&(r+=1),"Z"===s&&(r+=2),Object.defineProperty(hC.prototype,i,{get:function(){return this[n]},set:function(e){this[n]!==e&&(this[n]=e,this._constraint[cC[t]](r,e))}})}))}))}));vw._buildAccessors(hC.prototype,["enabled"]);vw._buildAccessors(class extends vw{constructor(e,t){super(e,t),this._minWidth=0,this._minHeight=0,this._maxWidth=null,this._maxHeight=null,this._fitWidthProportion=0,this._fitHeightProportion=0,this._excludeFromLayout=!1}set minWidth(e){e!==this._minWidth&&(this._minWidth=e,this.fire("resize"))}get minWidth(){return this._minWidth}set minHeight(e){e!==this._minHeight&&(this._minHeight=e,this.fire("resize"))}get minHeight(){return this._minHeight}set maxWidth(e){e!==this._maxWidth&&(this._maxWidth=e,this.fire("resize"))}get maxWidth(){return this._maxWidth}set maxHeight(e){e!==this._maxHeight&&(this._maxHeight=e,this.fire("resize"))}get maxHeight(){return this._maxHeight}set fitWidthProportion(e){e!==this._fitWidthProportion&&(this._fitWidthProportion=e,this.fire("resize"))}get fitWidthProportion(){return this._fitWidthProportion}set fitHeightProportion(e){e!==this._fitHeightProportion&&(this._fitHeightProportion=e,this.fire("resize"))}get fitHeightProportion(){return this._fitHeightProportion}set excludeFromLayout(e){e!==this._excludeFromLayout&&(this._excludeFromLayout=e,this.fire("resize"))}get excludeFromLayout(){return this._excludeFromLayout}}.prototype,["enabled"]);const dC={0:{axis:"x",size:"width",calculatedSize:"calculatedWidth",minSize:"minWidth",maxSize:"maxWidth",fitting:"widthFitting",fittingProportion:"fitWidthProportion"},1:{axis:"y",size:"height",calculatedSize:"calculatedHeight",minSize:"minHeight",maxSize:"maxHeight",fitting:"heightFitting",fittingProportion:"fitHeightProportion"}},uC={0:1,1:0},pC={minWidth:0,minHeight:0,maxWidth:Number.POSITIVE_INFINITY,maxHeight:Number.POSITIVE_INFINITY,width:null,height:null,fitWidthProportion:0,fitHeightProportion:0},mC="NONE",_C="APPLY_STRETCHING",fC="APPLY_SHRINKING",gC=new au;function vC(e){let t;const s=dC[e],i=dC[uC[e]];function n(e,t){return-t[s.size]*e.pivot[s.axis]}function r(e,t){return-t[i.size]*e.pivot[i.axis]}function a(e,t){return t[s.size]*(1-e.pivot[s.axis])}function o(e){const t=e.entity.layoutchild;return!t||!t.enabled||!t.excludeFromLayout}function l(e,t,s){switch(e){case 0:return mC;case 1:return t<s?_C:mC;case 2:return t>=s?fC:mC;case 3:return t<s?_C:fC;default:throw new Error(`Unrecognized fitting mode: ${e}`)}}function h(e,s){return f(e,s.size)+(e.length-1)*t.spacing[s.axis]}function c(e,t,s){const i=v(e,s.maxSize),n=g(e,s.fittingProportion),r=x(n,i);let a=gC[s.axis]-t;for(let t=0;t<e.length;++t){const o=i[t],l=u(o,a,n,r),h=e[o][s.size]+l,c=e[o][s.maxSize],d=Math.min(h,c);e[o][s.size]=d;a-=l-Math.max(h-d,0)}}function d(e,t,s){const i=v(e,s.minSize,!0),n=function(e){if(1===e.length)return[1];const t=[],s=e.length;for(let i=0;i<s;++i)t.push((1-e[i])/(s-1));return t}(g(e,s.fittingProportion)),r=x(n,i);let a=t-gC[s.axis];for(let t=0;t<e.length;++t){const o=i[t],l=u(o,a,n,r),h=e[o][s.size]-l,c=e[o][s.minSize],d=Math.max(h,c);e[o][s.size]=d;a-=l-Math.max(d-h,0)}}function u(e,t,s,i){const n=s[e],r=i[e];return Math.abs(n)<1e-5&&Math.abs(r)<1e-5?t:t*n/r}function p(e){const t=[];for(let s=0;s<e.length;++s){const i=e[s],n=Math.max(m(i,"minWidth"),0),r=Math.max(m(i,"minHeight"),0),a=Math.max(m(i,"maxWidth"),n),o=Math.max(m(i,"maxHeight"),r),l=_(m(i,"width"),n,a),h=_(m(i,"height"),r,o),c=m(i,"fitWidthProportion"),d=m(i,"fitHeightProportion");t.push({minWidth:n,minHeight:r,maxWidth:a,maxHeight:o,width:l,height:h,fitWidthProportion:c,fitHeightProportion:d})}return t}function m(e,t){const s=e.entity.layoutchild;return s&&s.enabled&&void 0!==s[t]&&null!==s[t]?s[t]:void 0!==e[t]?e[t]:pC[t]}function _(e,t,s){return Math.min(Math.max(e,t),s)}function f(e,t){return e.reduce((function(e,s){return e+s[t]}),0)}function g(e,t){const s=f(e,t),i=[],n=e.length;if(0===s)for(let e=0;e<n;++e)i.push(1/n);else for(let r=0;r<n;++r)i.push(e[r][t]/s);return i}function v(e,t,s){return e.forEach(y),e.slice().sort((function(e,i){return s?i[t]-e[t]:e[t]-i[t]})).map(b)}function y(e,t){e.index=t}function b(e){return e.index}function x(e,t){const s=[];s[t[e.length-1]]=e[t[e.length-1]];for(let i=e.length-2;i>=0;--i)s[t[i]]=s[t[i+1]]+e[t[i]];return s}return function(e,u){e=e.filter(o),t=u,gC.x=t.containerSize.x-t.padding.x-t.padding.z,gC.y=t.containerSize.y-t.padding.y-t.padding.w,function(e){for(let t=0;t<e.length;++t){const s=e[t],i=s.anchor;0===i.x&&0===i.y&&0===i.z&&0===i.w||(s.anchor=ou.ZERO)}}(e);const m=function(e){const s=0===t.orientation&&t.reverseX||1===t.orientation&&t.reverseY,i=0===t.orientation&&t.reverseY||1===t.orientation&&t.reverseX;if(s)for(let t=0;t<e.length;++t)s&&e[t].reverse();i&&e.reverse();return e}(function(e){if(!t.wrap)return[e];const i=[[]],n=p(e);let r=0;const a=2===t[s.fitting];for(let o=0;o<e.length;++o){i[i.length-1].length>0&&(r+=t.spacing[s.axis]);const l=n[o][s.size];r+=l,!a&&r>gC[s.axis]&&0!==i[i.length-1].length&&(r=l,i.push([])),i[i.length-1].push(e[o]),a&&r>gC[s.axis]&&o!==e.length-1&&(r=0,i.push([]))}return i}(e)),_=function(e,s){const n=[],r=[];for(let t=0;t<e.length;++t){const a=e[t];a.largestElement=null,a.largestSize={width:Number.NEGATIVE_INFINITY,height:Number.NEGATIVE_INFINITY};for(let e=0;e<a.length;++e){const n=s[t][e];n[i.size]>a.largestSize[i.size]&&(a.largestElement=a[e],a.largestSize=n)}n.push(a.largestElement),r.push(a.largestSize)}const a=h(r,i),o=l(t[i.fitting],a,gC[i.axis]);o===_C?c(r,a,i):o===fC&&d(r,a,i);for(let n=0;n<e.length;++n){const r=e[n];for(let a=0;a<r.length;++a){const o=s[n][a],h=o[i.size],c=1===e.length?gC[i.axis]:r.largestSize[i.size],d=l(t[i.fitting],h,c);d===_C?o[i.size]=Math.min(c,o[i.maxSize]):d===fC&&(o[i.size]=Math.max(c,o[i.minSize]))}}return s}(m,function(e){const i=[];for(let n=0;n<e.length;++n){const r=p(e[n]),a=h(r,s),o=l(t[s.fitting],a,gC[s.axis]);o===_C?c(r,a,s):o===fC&&d(r,a,s),i.push(r)}return i}(m)),f=function(e,o){const l={};l[s.axis]=0,l[i.axis]=0,e[s.size]=Number.NEGATIVE_INFINITY;const h=[];for(let c=0;c<e.length;++c){const d=e[c];if(0===d.length){h.push([]);continue}const u=[],p=o[c];for(let e=0;e<d.length;++e){const o=d[e],h=p[e];l[i.axis]-=r(o,h),l[s.axis]-=n(o,h),u[e]={},u[e][s.axis]=l[s.axis],u[e][i.axis]=l[i.axis],l[i.axis]+=r(o,h),l[s.axis]+=a(o,h)+t.spacing[s.axis]}d[s.size]=l[s.axis]-t.spacing[s.axis],d[i.size]=d.largestSize[i.size],e[s.size]=Math.max(e[s.size],d[s.size]),l[s.axis]=0,l[i.axis]+=d[i.size]+t.spacing[i.axis],h.push(u)}return e[i.size]=l[i.axis]-t.spacing[i.axis],h}(m,_);return function(e,n,r){const a=t.alignment[s.axis],o=t.alignment[i.axis],l=t.padding[s.axis],h=t.padding[i.axis];for(let c=0;c<e.length;++c){const d=e[c],u=n[c],p=r[c],m=(gC[s.axis]-d[s.size])*a+l,_=(gC[i.axis]-e[i.size])*o+h;for(let e=0;e<d.length;++e){const n=(d[i.size]-u[e][i.size])*t.alignment[i.axis];p[e][s.axis]+=m,p[e][i.axis]+=_+n}}}(m,_,f),function(e,n,r){for(let a=0;a<e.length;++a){const o=e[a],l=n[a],h=r[a];for(let e=0;e<o.length;++e){const n=o[e];n[s.calculatedSize]=l[e][s.size],n[i.calculatedSize]=l[e][i.size],0===t.orientation?n.entity.setLocalPosition(h[e][s.axis],h[e][i.axis],n.entity.getLocalPosition().z):n.entity.setLocalPosition(h[e][i.axis],h[e][s.axis],n.entity.getLocalPosition().z)}}}(m,_,f),function(e){const s=e.width,i=e.height,n=(gC.x-s)*t.alignment.x+t.padding.x,r=(gC.y-i)*t.alignment.y+t.padding.y;return{bounds:new ou(n,r,s,i)}}(m)}}const yC={};yC[0]=vC(0),yC[1]=vC(1);class bC{calculateLayout(e,t){const s=yC[t.orientation];if(s)return s(e,t);throw new Error("Unrecognized orientation value: "+t.orientation)}}function xC(e){return e.element}function wC(e){return e.enabled&&e.element&&e.element.enabled}vw._buildAccessors(class extends vw{constructor(e,t){super(e,t),this._orientation=0,this._reverseX=!1,this._reverseY=!0,this._alignment=new au(0,1),this._padding=new ou,this._spacing=new au,this._widthFitting=0,this._heightFitting=0,this._wrap=!1,this._layoutCalculator=new bC,this._listenForReflowEvents(this.entity,"on"),this.entity.children.forEach((e=>{this._listenForReflowEvents(e,"on")})),this.entity.on("childinsert",this._onChildInsert,this),this.entity.on("childremove",this._onChildRemove,this),e.app.systems.element.on("add",this._onElementOrLayoutComponentAdd,this),e.app.systems.element.on("beforeremove",this._onElementOrLayoutComponentRemove,this),e.app.systems.layoutchild.on("add",this._onElementOrLayoutComponentAdd,this),e.app.systems.layoutchild.on("beforeremove",this._onElementOrLayoutComponentRemove,this)}set orientation(e){e!==this._orientation&&(this._orientation=e,this._scheduleReflow())}get orientation(){return this._orientation}set reverseX(e){e!==this._reverseX&&(this._reverseX=e,this._scheduleReflow())}get reverseX(){return this._reverseX}set reverseY(e){e!==this._reverseY&&(this._reverseY=e,this._scheduleReflow())}get reverseY(){return this._reverseY}set alignment(e){e.equals(this._alignment)||(this._alignment.copy(e),this._scheduleReflow())}get alignment(){return this._alignment}set padding(e){e.equals(this._padding)||(this._padding.copy(e),this._scheduleReflow())}get padding(){return this._padding}set spacing(e){e.equals(this._spacing)||(this._spacing.copy(e),this._scheduleReflow())}get spacing(){return this._spacing}set widthFitting(e){e!==this._widthFitting&&(this._widthFitting=e,this._scheduleReflow())}get widthFitting(){return this._widthFitting}set heightFitting(e){e!==this._heightFitting&&(this._heightFitting=e,this._scheduleReflow())}get heightFitting(){return this._heightFitting}set wrap(e){e!==this._wrap&&(this._wrap=e,this._scheduleReflow())}get wrap(){return this._wrap}_isSelfOrChild(e){return e===this.entity||-1!==this.entity.children.indexOf(e)}_listenForReflowEvents(e,t){e.element&&(e.element[t]("enableelement",this._scheduleReflow,this),e.element[t]("disableelement",this._scheduleReflow,this),e.element[t]("resize",this._scheduleReflow,this),e.element[t]("set:pivot",this._scheduleReflow,this)),e.layoutchild&&(e.layoutchild[t]("set_enabled",this._scheduleReflow,this),e.layoutchild[t]("resize",this._scheduleReflow,this))}_onElementOrLayoutComponentAdd(e){this._isSelfOrChild(e)&&(this._listenForReflowEvents(e,"on"),this._scheduleReflow())}_onElementOrLayoutComponentRemove(e){this._isSelfOrChild(e)&&(this._listenForReflowEvents(e,"off"),this._scheduleReflow())}_onChildInsert(e){this._listenForReflowEvents(e,"on"),this._scheduleReflow()}_onChildRemove(e){this._listenForReflowEvents(e,"off"),this._scheduleReflow()}_scheduleReflow(){this.enabled&&this.entity&&this.entity.enabled&&!this._isPerformingReflow&&this.system.scheduleReflow(this)}reflow(){const e=xC(this.entity),t=this.entity.children.filter(wC).map(xC);if(!e||0===t.length)return;const s=Math.max(e.calculatedWidth,0),i=Math.max(e.calculatedHeight,0),n={orientation:this._orientation,reverseX:this._reverseX,reverseY:this._reverseY,alignment:this._alignment,padding:this._padding,spacing:this._spacing,widthFitting:this._widthFitting,heightFitting:this._heightFitting,wrap:this._wrap,containerSize:new au(s,i)};this._isPerformingReflow=!0;const r=this._layoutCalculator.calculateLayout(t,n);this._isPerformingReflow=!1,this.fire("reflow",r)}onEnable(){this._scheduleReflow()}onRemove(){this.entity.off("childinsert",this._onChildInsert,this),this.entity.off("childremove",this._onChildRemove,this),this._listenForReflowEvents(this.entity,"off"),this.entity.children.forEach((e=>{this._listenForReflowEvents(e,"off")})),this.system.app.systems.element.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.element.off("beforeremove",this._onElementOrLayoutComponentRemove,this),this.system.app.systems.layoutchild.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.layoutchild.off("beforeremove",this._onElementOrLayoutComponentRemove,this)}}.prototype,["enabled"]);class SC extends vw{constructor(e,t){super(e,t),this._type="asset",this._asset=null,this._model=null,this._mapping={},this._castShadows=!0,this._receiveShadows=!0,this._materialAsset=null,this._material=void 0,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this.isStatic=!1,this._layers=[0],this._batchGroupId=-1,this._customAabb=null,this._area=null,this._materialEvents=null,this._clonedModel=!1,this._material=e.defaultMaterial,t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this)}set meshInstances(e){this._model&&(this._model.meshInstances=e)}get meshInstances(){return this._model?this._model.meshInstances:null}set customAabb(e){if(this._customAabb=e,this._model){const e=this._model.meshInstances;if(e)for(let t=0;t<e.length;t++)e[t].setCustomAabb(this._customAabb)}}get customAabb(){return this._customAabb}set type(e){if(this._type!==e)if(this._area=null,this._type=e,"asset"===e)null!==this._asset?this._bindModelAsset(this._asset):this.model=null;else{const t=Q_(this.system.app.graphicsDevice,e);this._area=t.area;const s=t.mesh,i=new Kf,n=new ub;n.graph=i,n.meshInstances=[new ig(s,this._material,i)],this.model=n,this._asset=null}}get type(){return this._type}set asset(e){const t=this.system.app.assets;let s=e;if(e instanceof Yx&&(s=e.id),this._asset!==s){if(this._asset){t.off("add:"+this._asset,this._onModelAssetAdded,this);const e=t.get(this._asset);e&&this._unbindModelAsset(e)}if(this._asset=s,this._asset){const e=t.get(this._asset);e?this._bindModelAsset(e):(this.model=null,t.on("add:"+this._asset,this._onModelAssetAdded,this))}else this.model=null}}get asset(){return this._asset}set model(e){if(this._model!==e&&(!e||!e._immutable)&&(this._model&&(this._model._immutable=!1,this.removeModelFromLayers(),this._model.getGraph().destroy(),delete this._model._entity,this._clonedModel&&(this._model.destroy(),this._clonedModel=!1)),this._model=e,this._model)){this._model._immutable=!0;const e=this._model.meshInstances;for(let t=0;t<e.length;t++)e[t].castShadow=this._castShadows,e[t].receiveShadow=this._receiveShadows,e[t].setCustomAabb(this._customAabb);this.lightmapped=this._lightmapped,this.entity.addChild(this._model.graph),this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._model._entity=this.entity,this.entity.animation&&this.entity.animation.setModel(this._model),this.entity.anim&&this.entity.anim.rebind(),"asset"===this.type?this.mapping=this._mapping:this._unsetMaterialEvents()}}get model(){return this._model}set lightmapped(e){if(e!==this._lightmapped&&(this._lightmapped=e,this._model)){const t=this._model.meshInstances;for(let s=0;s<t.length;s++)t[s].setLightmapped(e)}}get lightmapped(){return this._lightmapped}set castShadows(e){if(this._castShadows===e)return;const t=this._model;if(t){const s=this.layers,i=this.system.app.scene;if(this._castShadows&&!e)for(let e=0;e<s.length;e++){const s=this.system.app.scene.layers.getLayerById(this.layers[e]);s&&s.removeShadowCasters(t.meshInstances)}const n=t.meshInstances;for(let t=0;t<n.length;t++)n[t].castShadow=e;if(!this._castShadows&&e)for(let e=0;e<s.length;e++){const n=i.layers.getLayerById(s[e]);n&&n.addShadowCasters(t.meshInstances)}}this._castShadows=e}get castShadows(){return this._castShadows}set receiveShadows(e){if(this._receiveShadows!==e&&(this._receiveShadows=e,this._model)){const t=this._model.meshInstances;for(let s=0,i=t.length;s<i;s++)t[s].receiveShadow=e}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(e){this._castShadowsLightmap=e}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(e){this._lightmapSizeMultiplier=e}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set layers(e){const t=this.system.app.scene.layers;if(this.meshInstances)for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.removeMeshInstances(this.meshInstances)}this._layers.length=0;for(let t=0;t<e.length;t++)this._layers[t]=e[t];if(this.enabled&&this.entity.enabled&&this.meshInstances)for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.addMeshInstances(this.meshInstances)}}get layers(){return this._layers}set batchGroupId(e){if(this._batchGroupId!==e){var t,s;if(this.entity.enabled&&this._batchGroupId>=0)null==(t=this.system.app.batcher)||t.remove(Ef.MODEL,this.batchGroupId,this.entity);if(this.entity.enabled&&e>=0)null==(s=this.system.app.batcher)||s.insert(Ef.MODEL,e,this.entity);e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._batchGroupId=e}}get batchGroupId(){return this._batchGroupId}set materialAsset(e){let t=e;e instanceof Yx&&(t=e.id);const s=this.system.app.assets;if(t!==this._materialAsset){if(this._materialAsset){s.off("add:"+this._materialAsset,this._onMaterialAssetAdd,this);const e=s.get(this._materialAsset);e&&this._unbindMaterialAsset(e)}if(this._materialAsset=t,this._materialAsset){const e=s.get(this._materialAsset);e?this._bindMaterialAsset(e):(this._setMaterial(this.system.defaultMaterial),s.on("add:"+this._materialAsset,this._onMaterialAssetAdd,this))}else this._setMaterial(this.system.defaultMaterial)}}get materialAsset(){return this._materialAsset}set material(e){this._material!==e&&(this.materialAsset=null,this._setMaterial(e))}get material(){return this._material}set mapping(e){if("asset"!==this._type)return;if(this._unsetMaterialEvents(),e||(e={}),this._mapping=e,!this._model)return;const t=this._model.meshInstances,s=this.asset?this.system.app.assets.get(this.asset):null,i=s?s.data.mapping:null;let n=null;for(let s=0,r=t.length;s<r;s++)if(void 0!==e[s])e[s]?(n=this.system.app.assets.get(e[s]),this._loadAndSetMeshInstanceMaterial(n,t[s],s)):t[s].material=this.system.defaultMaterial;else if(i)if(i[s]&&(i[s].material||i[s].path)){if(void 0!==i[s].material)n=this.system.app.assets.get(i[s].material);else if(void 0!==i[s].path){const e=this._getMaterialAssetUrl(i[s].path);e&&(n=this.system.app.assets.getByUrl(e))}this._loadAndSetMeshInstanceMaterial(n,t[s],s)}else t[s].material=this.system.defaultMaterial}get mapping(){return this._mapping}addModelToLayers(){const e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.addMeshInstances(this.meshInstances)}}removeModelFromLayers(){const e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.removeMeshInstances(this.meshInstances)}}onRemoveChild(){this._model&&this.removeModelFromLayers()}onInsertChild(){this._model&&this.enabled&&this.entity.enabled&&this.addModelToLayers()}onRemove(){this.asset=null,this.model=null,this.materialAsset=null,this._unsetMaterialEvents(),this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(e,t){this.addModelToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||e.addMeshInstances(this.meshInstances)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||e.removeMeshInstances(this.meshInstances)}_setMaterialEvent(e,t,s,i){const n=t+":"+s;this.system.app.assets.on(n,i,this),this._materialEvents||(this._materialEvents=[]),this._materialEvents[e]||(this._materialEvents[e]={}),this._materialEvents[e][n]={id:s,handler:i}}_unsetMaterialEvents(){const e=this.system.app.assets,t=this._materialEvents;if(t){for(let s=0,i=t.length;s<i;s++){if(!t[s])continue;const i=t[s];for(const t in i)e.off(t,i[t].handler,this)}this._materialEvents=null}}_getAssetByIdOrPath(e){let t=null;if(isNaN(parseInt(e,10))){if(this.asset){const s=this._getMaterialAssetUrl(e);s&&(t=this.system.app.assets.getByUrl(s))}}else t=this.system.app.assets.get(e);return t}_getMaterialAssetUrl(e){if(!this.asset)return null;const t=this.system.app.assets.get(this.asset);return t?t.getAbsoluteUrl(e):null}_loadAndSetMeshInstanceMaterial(e,t,s){const i=this.system.app.assets;e&&(e.resource?(t.material=e.resource,this._setMaterialEvent(s,"remove",e.id,(function(){t.material=this.system.defaultMaterial}))):(this._setMaterialEvent(s,"load",e.id,(function(i){t.material=i.resource,this._setMaterialEvent(s,"remove",e.id,(function(){t.material=this.system.defaultMaterial}))})),this.enabled&&this.entity.enabled&&i.load(e)))}onEnable(){const e=this.system.app,t=e.scene;t.on("set:layers",this.onLayersChanged,this),t.layers&&(t.layers.on("add",this.onLayerAdded,this),t.layers.on("remove",this.onLayerRemoved,this));const s="asset"===this._type;let i;if(this._model?this.addModelToLayers():s&&this._asset&&(i=e.assets.get(this._asset),i&&i.resource!==this._model&&this._bindModelAsset(i)),this._materialAsset&&(i=e.assets.get(this._materialAsset),i&&i.resource!==this._material&&this._bindMaterialAsset(i)),s&&this._mapping)for(const t in this._mapping)this._mapping[t]&&(i=this._getAssetByIdOrPath(this._mapping[t]),i&&!i.resource&&e.assets.load(i));var n;this._batchGroupId>=0&&(null==(n=e.batcher)||n.insert(Ef.MODEL,this.batchGroupId,this.entity))}onDisable(){const e=this.system.app,t=e.scene;var s;(t.off("set:layers",this.onLayersChanged,this),t.layers&&(t.layers.off("add",this.onLayerAdded,this),t.layers.off("remove",this.onLayerRemoved,this)),this._batchGroupId>=0)&&(null==(s=e.batcher)||s.remove(Ef.MODEL,this.batchGroupId,this.entity));this._model&&this.removeModelFromLayers()}hide(){if(this._model){const e=this._model.meshInstances;for(let t=0,s=e.length;t<s;t++)e[t].visible=!1}}show(){if(this._model){const e=this._model.meshInstances;for(let t=0,s=e.length;t<s;t++)e[t].visible=!0}}_bindMaterialAsset(e){if(e.on("load",this._onMaterialAssetLoad,this),e.on("unload",this._onMaterialAssetUnload,this),e.on("remove",this._onMaterialAssetRemove,this),e.on("change",this._onMaterialAssetChange,this),e.resource)this._onMaterialAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindMaterialAsset(e){e.off("load",this._onMaterialAssetLoad,this),e.off("unload",this._onMaterialAssetUnload,this),e.off("remove",this._onMaterialAssetRemove,this),e.off("change",this._onMaterialAssetChange,this)}_onMaterialAssetAdd(e){this.system.app.assets.off("add:"+e.id,this._onMaterialAssetAdd,this),this._materialAsset===e.id&&this._bindMaterialAsset(e)}_onMaterialAssetLoad(e){this._setMaterial(e.resource)}_onMaterialAssetUnload(e){this._setMaterial(this.system.defaultMaterial)}_onMaterialAssetRemove(e){this._onMaterialAssetUnload(e)}_onMaterialAssetChange(e){}_bindModelAsset(e){if(this._unbindModelAsset(e),e.on("load",this._onModelAssetLoad,this),e.on("unload",this._onModelAssetUnload,this),e.on("change",this._onModelAssetChange,this),e.on("remove",this._onModelAssetRemove,this),e.resource)this._onModelAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindModelAsset(e){e.off("load",this._onModelAssetLoad,this),e.off("unload",this._onModelAssetUnload,this),e.off("change",this._onModelAssetChange,this),e.off("remove",this._onModelAssetRemove,this)}_onModelAssetAdded(e){this.system.app.assets.off("add:"+e.id,this._onModelAssetAdded,this),e.id===this._asset&&this._bindModelAsset(e)}_onModelAssetLoad(e){this.model=e.resource.clone(),this._clonedModel=!0}_onModelAssetUnload(e){this.model=null}_onModelAssetChange(e,t,s,i){"data"===t&&(this.mapping=this._mapping)}_onModelAssetRemove(e){this.model=null}_setMaterial(e){if(this._material===e)return;this._material=e;const t=this._model;if(t&&"asset"!==this._type){const s=t.meshInstances;for(let t=0,i=s.length;t<i;t++)s[t].material=e}}}vw._buildAccessors(SC.prototype,["enabled"]);const CC=["emitterExtents","emitterRadius","emitterExtentsInner","emitterRadiusInner","loop","initialVelocity","animSpeed","normalMap","particleNormal"],TC=["numParticles","lifetime","rate","rate2","startAngle","startAngle2","lighting","halfLambert","intensity","wrap","wrapBounds","depthWrite","noFog","sort","stretch","alignToMotion","preWarm","emitterShape","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animLoop","colorMap","localSpace","screenSpace","orientation"],AC=["scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","velocityGraph","velocityGraph2","localVelocityGraph","localVelocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2"],EC=["colorMapAsset","normalMapAsset","meshAsset","renderAsset"];let PC;vw._buildAccessors(class extends vw{constructor(e,t){super(e,t),this._requestedDepth=!1,this._drawOrder=0,this.on("set_colorMapAsset",this.onSetColorMapAsset,this),this.on("set_normalMapAsset",this.onSetNormalMapAsset,this),this.on("set_meshAsset",this.onSetMeshAsset,this),this.on("set_mesh",this.onSetMesh,this),this.on("set_renderAsset",this.onSetRenderAsset,this),this.on("set_loop",this.onSetLoop,this),this.on("set_blendType",this.onSetBlendType,this),this.on("set_depthSoftening",this.onSetDepthSoftening,this),this.on("set_layers",this.onSetLayers,this),CC.forEach((e=>{this.on(`set_${e}`,this.onSetSimpleProperty,this)})),TC.forEach((e=>{this.on(`set_${e}`,this.onSetComplexProperty,this)})),AC.forEach((e=>{this.on(`set_${e}`,this.onSetGraphProperty,this)}))}set drawOrder(e){this._drawOrder=e,this.emitter&&(this.emitter.drawOrder=e)}get drawOrder(){return this._drawOrder}addMeshInstanceToLayers(){if(this.emitter)for(let e=0;e<this.layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&(t.addMeshInstances([this.emitter.meshInstance]),this.emitter._layer=t)}}removeMeshInstanceFromLayers(){if(this.emitter)for(let e=0;e<this.layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&t.removeMeshInstances([this.emitter.meshInstance])}}onSetLayers(e,t,s){if(this.emitter){for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);s&&s.removeMeshInstances([this.emitter.meshInstance])}if(this.enabled&&this.entity.enabled)for(let e=0;e<s.length;e++){const t=this.system.app.scene.layers.getLayerById(s[e]);t&&t.addMeshInstances([this.emitter.meshInstance])}}}onLayersChanged(e,t){this.addMeshInstanceToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){if(!this.emitter)return;this.layers.indexOf(e.id)<0||e.addMeshInstances([this.emitter.meshInstance])}onLayerRemoved(e){if(!this.emitter)return;this.layers.indexOf(e.id)<0||e.removeMeshInstances([this.emitter.meshInstance])}_bindColorMapAsset(e){if(e.on("load",this._onColorMapAssetLoad,this),e.on("unload",this._onColorMapAssetUnload,this),e.on("remove",this._onColorMapAssetRemove,this),e.on("change",this._onColorMapAssetChange,this),e.resource)this._onColorMapAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindColorMapAsset(e){e.off("load",this._onColorMapAssetLoad,this),e.off("unload",this._onColorMapAssetUnload,this),e.off("remove",this._onColorMapAssetRemove,this),e.off("change",this._onColorMapAssetChange,this)}_onColorMapAssetLoad(e){this.colorMap=e.resource}_onColorMapAssetUnload(e){this.colorMap=null}_onColorMapAssetRemove(e){this._onColorMapAssetUnload(e)}_onColorMapAssetChange(e){}onSetColorMapAsset(e,t,s){const i=this.system.app.assets;if(t){const e=i.get(t);e&&this._unbindColorMapAsset(e)}if(s){s instanceof Yx&&(this.data.colorMapAsset=s.id,s=s.id);const e=i.get(s);e?this._bindColorMapAsset(e):i.once("add:"+s,(e=>{this._bindColorMapAsset(e)}))}else this.colorMap=null}_bindNormalMapAsset(e){if(e.on("load",this._onNormalMapAssetLoad,this),e.on("unload",this._onNormalMapAssetUnload,this),e.on("remove",this._onNormalMapAssetRemove,this),e.on("change",this._onNormalMapAssetChange,this),e.resource)this._onNormalMapAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindNormalMapAsset(e){e.off("load",this._onNormalMapAssetLoad,this),e.off("unload",this._onNormalMapAssetUnload,this),e.off("remove",this._onNormalMapAssetRemove,this),e.off("change",this._onNormalMapAssetChange,this)}_onNormalMapAssetLoad(e){this.normalMap=e.resource}_onNormalMapAssetUnload(e){this.normalMap=null}_onNormalMapAssetRemove(e){this._onNormalMapAssetUnload(e)}_onNormalMapAssetChange(e){}onSetNormalMapAsset(e,t,s){const i=this.system.app.assets;if(t){const e=i.get(t);e&&this._unbindNormalMapAsset(e)}if(s){s instanceof Yx&&(this.data.normalMapAsset=s.id,s=s.id);const e=i.get(s);e?this._bindNormalMapAsset(e):i.once("add:"+s,(e=>{this._bindNormalMapAsset(e)}))}else this.normalMap=null}_bindMeshAsset(e){if(e.on("load",this._onMeshAssetLoad,this),e.on("unload",this._onMeshAssetUnload,this),e.on("remove",this._onMeshAssetRemove,this),e.on("change",this._onMeshAssetChange,this),e.resource)this._onMeshAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindMeshAsset(e){e.off("load",this._onMeshAssetLoad,this),e.off("unload",this._onMeshAssetUnload,this),e.off("remove",this._onMeshAssetRemove,this),e.off("change",this._onMeshAssetChange,this)}_onMeshAssetLoad(e){this._onMeshChanged(e.resource)}_onMeshAssetUnload(e){this.mesh=null}_onMeshAssetRemove(e){this._onMeshAssetUnload(e)}_onMeshAssetChange(e){}onSetMeshAsset(e,t,s){const i=this.system.app.assets;if(t){const e=i.get(t);e&&this._unbindMeshAsset(e)}if(s){s instanceof Yx&&(this.data.meshAsset=s.id,s=s.id);const e=i.get(s);e&&this._bindMeshAsset(e)}else this._onMeshChanged(null)}onSetMesh(e,t,s){!s||s instanceof Yx||"number"==typeof s?this.meshAsset=s:this._onMeshChanged(s)}_onMeshChanged(e){!e||e instanceof G_||(e=e.meshInstances[0]?e.meshInstances[0].mesh:null),this.data.mesh=e,this.emitter&&(this.emitter.mesh=e,this.emitter.resetMaterial(),this.rebuild())}onSetRenderAsset(e,t,s){const i=this.system.app.assets;if(t){const e=i.get(t);e&&this._unbindRenderAsset(e)}if(s){s instanceof Yx&&(this.data.renderAsset=s.id,s=s.id);const e=i.get(s);e&&this._bindRenderAsset(e)}else this._onRenderChanged(null)}_bindRenderAsset(e){if(e.on("load",this._onRenderAssetLoad,this),e.on("unload",this._onRenderAssetUnload,this),e.on("remove",this._onRenderAssetRemove,this),e.resource)this._onRenderAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindRenderAsset(e){e.off("load",this._onRenderAssetLoad,this),e.off("unload",this._onRenderAssetUnload,this),e.off("remove",this._onRenderAssetRemove,this),e.resource&&e.resource.off("set:meshes",this._onRenderSetMeshes,this)}_onRenderAssetLoad(e){this._onRenderChanged(e.resource)}_onRenderAssetUnload(e){this._onRenderChanged(null)}_onRenderAssetRemove(e){this._onRenderAssetUnload(e)}_onRenderChanged(e){e?(e.off("set:meshes",this._onRenderSetMeshes,this),e.on("set:meshes",this._onRenderSetMeshes,this),e.meshes&&this._onRenderSetMeshes(e.meshes)):this._onMeshChanged(null)}_onRenderSetMeshes(e){this._onMeshChanged(e&&e[0])}onSetLoop(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.resetTime())}onSetBlendType(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.material.blendType=s,this.emitter.resetMaterial(),this.rebuild())}_requestDepth(){this._requestedDepth||(PC||(PC=this.system.app.scene.layers.getLayerById(1)),PC&&(PC.incrementCounter(),this._requestedDepth=!0))}_releaseDepth(){this._requestedDepth&&PC&&(PC.decrementCounter(),this._requestedDepth=!1)}onSetDepthSoftening(e,t,s){t!==s&&(s?(this.enabled&&this.entity.enabled&&this._requestDepth(),this.emitter&&(this.emitter[e]=s)):(this.enabled&&this.entity.enabled&&this._releaseDepth(),this.emitter&&(this.emitter[e]=s)),this.emitter&&(this.reset(),this.emitter.resetMaterial(),this.rebuild()))}onSetSimpleProperty(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.resetMaterial())}onSetComplexProperty(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.resetMaterial(),this.rebuild(),this.reset())}onSetGraphProperty(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.rebuildGraphs(),this.emitter.resetMaterial())}onEnable(){const e=this.data;for(let t=0,s=EC.length;t<s;t++){let s=e[EC[t]];if(s){if(!(s instanceof Yx)){if(!(parseInt(s,10)>=0))continue;s=this.system.app.assets.get(s)}s&&!s.resource&&this.system.app.assets.load(s)}}if(!this.system.app.graphicsDevice.disableParticleSystem){if(!this.emitter){let t=e.mesh;t instanceof G_||(t=null),this.emitter=new ox(this.system.app.graphicsDevice,{numParticles:e.numParticles,emitterExtents:e.emitterExtents,emitterExtentsInner:e.emitterExtentsInner,emitterRadius:e.emitterRadius,emitterRadiusInner:e.emitterRadiusInner,emitterShape:e.emitterShape,initialVelocity:e.initialVelocity,wrap:e.wrap,localSpace:e.localSpace,screenSpace:e.screenSpace,wrapBounds:e.wrapBounds,lifetime:e.lifetime,rate:e.rate,rate2:e.rate2,orientation:e.orientation,particleNormal:e.particleNormal,animTilesX:e.animTilesX,animTilesY:e.animTilesY,animStartFrame:e.animStartFrame,animNumFrames:e.animNumFrames,animNumAnimations:e.animNumAnimations,animIndex:e.animIndex,randomizeAnimIndex:e.randomizeAnimIndex,animSpeed:e.animSpeed,animLoop:e.animLoop,startAngle:e.startAngle,startAngle2:e.startAngle2,scaleGraph:e.scaleGraph,scaleGraph2:e.scaleGraph2,colorGraph:e.colorGraph,colorGraph2:e.colorGraph2,alphaGraph:e.alphaGraph,alphaGraph2:e.alphaGraph2,localVelocityGraph:e.localVelocityGraph,localVelocityGraph2:e.localVelocityGraph2,velocityGraph:e.velocityGraph,velocityGraph2:e.velocityGraph2,rotationSpeedGraph:e.rotationSpeedGraph,rotationSpeedGraph2:e.rotationSpeedGraph2,radialSpeedGraph:e.radialSpeedGraph,radialSpeedGraph2:e.radialSpeedGraph2,colorMap:e.colorMap,normalMap:e.normalMap,loop:e.loop,preWarm:e.preWarm,sort:e.sort,stretch:e.stretch,alignToMotion:e.alignToMotion,lighting:e.lighting,halfLambert:e.halfLambert,intensity:e.intensity,depthSoftening:e.depthSoftening,scene:this.system.app.scene,mesh:t,depthWrite:e.depthWrite,noFog:e.noFog,node:this.entity,blendType:e.blendType}),this.emitter.meshInstance.node=this.entity,this.emitter.drawOrder=this.drawOrder,e.autoPlay||(this.pause(),this.emitter.meshInstance.visible=!1)}this.emitter.colorMap&&this.addMeshInstanceToLayers(),this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&e.depthSoftening&&this._requestDepth()}}onDisable(){this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.emitter&&(this.removeMeshInstanceFromLayers(),this.data.depthSoftening&&this._releaseDepth(),this.emitter.camera=null)}onBeforeRemove(){this.enabled&&(this.enabled=!1),this.emitter&&(this.emitter.destroy(),this.emitter=null);for(let e=0;e<EC.length;e++){const t=EC[e];this.data[t]&&(this[t]=null)}this.off()}reset(){this.emitter&&this.emitter.reset()}stop(){this.emitter&&(this.emitter.loop=!1,this.emitter.resetTime(),this.emitter.addTime(0,!0))}pause(){this.data.paused=!0}unpause(){this.data.paused=!1}play(){this.data.paused=!1,this.emitter&&(this.emitter.meshInstance.visible=!0,this.emitter.loop=this.data.loop,this.emitter.resetTime())}isPlaying(){return!this.data.paused&&(!(!this.emitter||!this.emitter.loop)||Date.now()<=this.emitter.endTime)}rebuild(){const e=this.enabled;this.enabled=!1,this.emitter&&(this.emitter.rebuild(),this.emitter.meshInstance.node=this.entity),this.enabled=e}}.prototype,["enabled","autoPlay","numParticles","lifetime","rate","rate2","startAngle","startAngle2","loop","preWarm","lighting","halfLambert","intensity","depthWrite","noFog","depthSoftening","sort","blendType","stretch","alignToMotion","emitterShape","emitterExtents","emitterExtentsInner","emitterRadius","emitterRadiusInner","initialVelocity","wrap","wrapBounds","localSpace","screenSpace","colorMapAsset","normalMapAsset","mesh","meshAsset","renderAsset","orientation","particleNormal","localVelocityGraph","localVelocityGraph2","velocityGraph","velocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2","scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","colorMap","normalMap","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animSpeed","animLoop","layers"]);class MC extends B_{constructor(e,t){super(),this.skin=e,this.skinInstance=t}}class LC{static createCachedSkinInstance(e,t,s){let i=LC.getCachedSkinInstance(e,t);return i||(i=new Mf(e),i.resolve(t,s),LC.addCachedSkinInstance(e,t,i)),i}static getCachedSkinInstance(e,t){let s=null;const i=LC._skinInstanceCache.get(t);if(i){const t=i.find((t=>t.skin===e));t&&(t.incRefCount(),s=t.skinInstance)}return s}static addCachedSkinInstance(e,t,s){let i=LC._skinInstanceCache.get(t);i||(i=[],LC._skinInstanceCache.set(t,i));let n=i.find((t=>t.skin===e));n||(n=new MC(e,s),i.push(n)),n.incRefCount()}static removeCachedSkinInstance(e){if(e){const t=e.rootBone;if(t){const s=LC._skinInstanceCache.get(t);if(s){const i=s.findIndex((t=>t.skinInstance===e));if(i>=0){const n=s[i];n.decRefCount(),0===n.refCount&&(s.splice(i,1),s.length||LC._skinInstanceCache.delete(t),e&&(e.destroy(),n.skinInstance=null))}}}}}}LC._skinInstanceCache=new Map;class DC{constructor(e,t,s,i,n){this.propertyName=e,this.parent=t,this._scope=n,this._registry=s,this.id=null,this.url=null,this.asset=null,this._onAssetLoad=i.load,this._onAssetAdd=i.add,this._onAssetRemove=i.remove,this._onAssetUnload=i.unload}set id(e){if(this.url)throw Error("Can't set id and url");this._unbind(),this._id=e,this.asset=this._registry.get(this._id),this._bind()}get id(){return this._id}set url(e){if(this.id)throw Error("Can't set id and url");this._unbind(),this._url=e,this.asset=this._registry.getByUrl(this._url),this._bind()}get url(){return this._url}_bind(){this.id&&(this._onAssetLoad&&this._registry.on("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.once("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.on("remove:"+this.id,this._onRemove,this),this._onAssetUnload&&this._registry.on("unload:"+this.id,this._onUnload,this)),this.url&&(this._onAssetLoad&&this._registry.on("load:url:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.once("add:url:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.on("remove:url:"+this.url,this._onRemove,this))}_unbind(){this.id&&(this._onAssetLoad&&this._registry.off("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.id,this._onRemove,this),this._onAssetUnload&&this._registry.off("unload:"+this.id,this._onUnload,this)),this.url&&(this._onAssetLoad&&this._registry.off("load:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.url,this._onRemove,this))}_onLoad(e){this._onAssetLoad.call(this._scope,this.propertyName,this.parent,e)}_onAdd(e){this.asset=e,this._onAssetAdd.call(this._scope,this.propertyName,this.parent,e)}_onRemove(e){this._onAssetRemove.call(this._scope,this.propertyName,this.parent,e),this.asset=null}_onUnload(e){this._onAssetUnload.call(this._scope,this.propertyName,this.parent,e)}}class kC extends vw{constructor(e,t){super(e,t),this._type="asset",this._castShadows=!0,this._receiveShadows=!0,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this.isStatic=!1,this._batchGroupId=-1,this._layers=[0],this._renderStyle=0,this._meshInstances=[],this._customAabb=null,this._area=null,this._assetReference=void 0,this._materialReferences=[],this._material=void 0,this._rootBone=void 0,this._rootBone=new aS(this,"rootBone"),this._rootBone.on("set:entity",this._onSetRootBone,this),this._assetReference=new DC("asset",this,e.app.assets,{add:this._onRenderAssetAdded,load:this._onRenderAssetLoad,remove:this._onRenderAssetRemove,unload:this._onRenderAssetUnload},this),this._material=e.defaultMaterial,t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this)}set renderStyle(e){this._renderStyle!==e&&(this._renderStyle=e,ig._prepareRenderStyleForArray(this._meshInstances,e))}get renderStyle(){return this._renderStyle}set customAabb(e){this._customAabb=e;const t=this._meshInstances;if(t)for(let e=0;e<t.length;e++)t[e].setCustomAabb(this._customAabb)}get customAabb(){return this._customAabb}set type(e){if(this._type!==e&&(this._area=null,this._type=e,this.destroyMeshInstances(),"asset"!==e)){let t=this._material;t&&t!==this.system.defaultMaterial||(t=this._materialReferences[0]&&this._materialReferences[0].asset&&this._materialReferences[0].asset.resource);const s=Q_(this.system.app.graphicsDevice,e);this._area=s.area,this.meshInstances=[new ig(s.mesh,t||this.system.defaultMaterial,this.entity)]}}get type(){return this._type}set meshInstances(e){if(this.destroyMeshInstances(),this._meshInstances=e,this._meshInstances){const e=this._meshInstances;for(let t=0;t<e.length;t++)e[t].node||(e[t].node=this.entity),e[t].castShadow=this._castShadows,e[t].receiveShadow=this._receiveShadows,e[t].renderStyle=this._renderStyle,e[t].setLightmapped(this._lightmapped),e[t].setCustomAabb(this._customAabb);this.enabled&&this.entity.enabled&&this.addToLayers()}}get meshInstances(){return this._meshInstances}set lightmapped(e){if(e!==this._lightmapped){this._lightmapped=e;const t=this._meshInstances;if(t)for(let s=0;s<t.length;s++)t[s].setLightmapped(e)}}get lightmapped(){return this._lightmapped}set castShadows(e){if(this._castShadows!==e){const t=this._meshInstances;if(t){const s=this.layers,i=this.system.app.scene;if(this._castShadows&&!e)for(let e=0;e<s.length;e++){const s=i.layers.getLayerById(this.layers[e]);s&&s.removeShadowCasters(t)}for(let s=0;s<t.length;s++)t[s].castShadow=e;if(!this._castShadows&&e)for(let e=0;e<s.length;e++){const n=i.layers.getLayerById(s[e]);n&&n.addShadowCasters(t)}}this._castShadows=e}}get castShadows(){return this._castShadows}set receiveShadows(e){if(this._receiveShadows!==e){this._receiveShadows=e;const t=this._meshInstances;if(t)for(let s=0;s<t.length;s++)t[s].receiveShadow=e}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(e){this._castShadowsLightmap=e}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(e){this._lightmapSizeMultiplier=e}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set layers(e){const t=this.system.app.scene.layers;let s;if(this._meshInstances)for(let e=0;e<this._layers.length;e++)s=t.getLayerById(this._layers[e]),s&&s.removeMeshInstances(this._meshInstances);this._layers.length=0;for(let t=0;t<e.length;t++)this._layers[t]=e[t];if(this.enabled&&this.entity.enabled&&this._meshInstances)for(let e=0;e<this._layers.length;e++)s=t.getLayerById(this._layers[e]),s&&s.addMeshInstances(this._meshInstances)}get layers(){return this._layers}set batchGroupId(e){if(this._batchGroupId!==e){var t,s;if(this.entity.enabled&&this._batchGroupId>=0)null==(t=this.system.app.batcher)||t.remove(Ef.RENDER,this.batchGroupId,this.entity);if(this.entity.enabled&&e>=0)null==(s=this.system.app.batcher)||s.insert(Ef.RENDER,e,this.entity);e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addToLayers(),this._batchGroupId=e}}get batchGroupId(){return this._batchGroupId}set material(e){if(this._material!==e&&(this._material=e,this._meshInstances&&"asset"!==this._type))for(let t=0;t<this._meshInstances.length;t++)this._meshInstances[t].material=e}get material(){return this._material}set materialAssets(e=[]){if(this._materialReferences.length>e.length){for(let t=e.length;t<this._materialReferences.length;t++)this._materialReferences[t].id=null;this._materialReferences.length=e.length}for(let t=0;t<e.length;t++)if(this._materialReferences[t]||this._materialReferences.push(new DC(t,this,this.system.app.assets,{add:this._onMaterialAdded,load:this._onMaterialLoad,remove:this._onMaterialRemove,unload:this._onMaterialUnload},this)),e[t]){const s=e[t]instanceof Yx?e[t].id:e[t];this._materialReferences[t].id!==s&&(this._materialReferences[t].id=s),this._materialReferences[t].asset&&this._onMaterialAdded(t,this,this._materialReferences[t].asset)}else this._materialReferences[t].id=null,this._meshInstances[t]&&(this._meshInstances[t].material=this.system.defaultMaterial)}get materialAssets(){return this._materialReferences.map((function(e){return e.id}))}set asset(e){const t=e instanceof Yx?e.id:e;this._assetReference.id!==t&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onRenderAssetRemove(),this._assetReference.id=t,this._assetReference.asset&&this._onRenderAssetAdded())}get asset(){return this._assetReference.id}assignAsset(e){const t=e instanceof Yx?e.id:e;this._assetReference.id=t}_onSetRootBone(e){e&&this._onRootBoneChanged()}_onRootBoneChanged(){this._clearSkinInstances(),this.enabled&&this.entity.enabled&&this._cloneSkinInstances()}destroyMeshInstances(){const e=this._meshInstances;if(e){this.removeFromLayers(),this._clearSkinInstances();for(let t=0;t<e.length;t++)e[t].destroy();this._meshInstances.length=0}}addToLayers(){const e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.addMeshInstances(this._meshInstances)}}removeFromLayers(){if(this._meshInstances&&this._meshInstances.length){const e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.removeMeshInstances(this._meshInstances)}}}onRemoveChild(){this.removeFromLayers()}onInsertChild(){this._meshInstances&&this.enabled&&this.entity.enabled&&this.addToLayers()}onRemove(){this.destroyMeshInstances(),this.asset=null,this.materialAsset=null,this._assetReference.id=null;for(let e=0;e<this._materialReferences.length;e++)this._materialReferences[e].id=null;this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(e,t){this.addToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||e.addMeshInstances(this._meshInstances)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||e.removeMeshInstances(this._meshInstances)}onEnable(){const e=this.system.app,t=e.scene;this._rootBone.onParentComponentEnable(),this._cloneSkinInstances(),t.on("set:layers",this.onLayersChanged,this),t.layers&&(t.layers.on("add",this.onLayerAdded,this),t.layers.on("remove",this.onLayerRemoved,this));const s="asset"===this._type;this._meshInstances&&this._meshInstances.length?this.addToLayers():s&&this.asset&&this._onRenderAssetAdded();for(let e=0;e<this._materialReferences.length;e++)this._materialReferences[e].asset&&this.system.app.assets.load(this._materialReferences[e].asset);var i;this._batchGroupId>=0&&(null==(i=e.batcher)||i.insert(Ef.RENDER,this.batchGroupId,this.entity))}onDisable(){const e=this.system.app,t=e.scene;var s;(t.off("set:layers",this.onLayersChanged,this),t.layers&&(t.layers.off("add",this.onLayerAdded,this),t.layers.off("remove",this.onLayerRemoved,this)),this._batchGroupId>=0)&&(null==(s=e.batcher)||s.remove(Ef.RENDER,this.batchGroupId,this.entity));this.removeFromLayers()}hide(){if(this._meshInstances)for(let e=0;e<this._meshInstances.length;e++)this._meshInstances[e].visible=!1}show(){if(this._meshInstances)for(let e=0;e<this._meshInstances.length;e++)this._meshInstances[e].visible=!0}_onRenderAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onRenderAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))}_onRenderAssetLoad(){if(this.destroyMeshInstances(),this._assetReference.asset){const e=this._assetReference.asset.resource;e.off("set:meshes",this._onSetMeshes,this),e.on("set:meshes",this._onSetMeshes,this),e.meshes&&this._onSetMeshes(e.meshes)}}_onSetMeshes(e){this._cloneMeshes(e)}_clearSkinInstances(){for(let e=0;e<this._meshInstances.length;e++){const t=this._meshInstances[e];LC.removeCachedSkinInstance(t.skinInstance),t.skinInstance=null}}_cloneSkinInstances(){if(this._meshInstances.length&&this._rootBone.entity instanceof Kf)for(let e=0;e<this._meshInstances.length;e++){const t=this._meshInstances[e],s=t.mesh;s.skin&&!t.skinInstance&&(t.skinInstance=LC.createCachedSkinInstance(s.skin,this._rootBone.entity,this.entity))}}_cloneMeshes(e){if(e&&e.length){const t=[];for(let s=0;s<e.length;s++){const i=e[s],n=this._materialReferences[s]&&this._materialReferences[s].asset&&this._materialReferences[s].asset.resource,r=new ig(i,n||this.system.defaultMaterial,this.entity);t.push(r),i.morph&&(r.morphInstance=new db(i.morph))}this.meshInstances=t,this._cloneSkinInstances()}}_onRenderAssetUnload(){"asset"===this._type&&this.destroyMeshInstances()}_onRenderAssetRemove(){this._assetReference.asset&&this._assetReference.asset.resource&&this._assetReference.asset.resource.off("set:meshes",this._onSetMeshes,this),this._onRenderAssetUnload()}_onMaterialAdded(e,t,s){s.resource?this._onMaterialLoad(e,t,s):this.enabled&&this.entity.enabled&&this.system.app.assets.load(s)}_updateMainMaterial(e,t){0===e&&(this.material=t)}_onMaterialLoad(e,t,s){this._meshInstances[e]&&(this._meshInstances[e].material=s.resource),this._updateMainMaterial(e,s.resource)}_onMaterialRemove(e,t,s){this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial),this._updateMainMaterial(e,this.system.defaultMaterial)}_onMaterialUnload(e,t,s){this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial),this._updateMainMaterial(e,this.system.defaultMaterial)}resolveDuplicatedEntityReferenceProperties(e,t){e.rootBone&&t[e.rootBone]&&(this.rootBone=t[e.rootBone]),this._clearSkinInstances()}}vw._buildAccessors(kC.prototype,[{name:"rootBone",type:"entity"},"enabled"]);class IC{constructor(e,t){this._pool=[],this._count=0,this._constructor=e,this._resize(t)}_resize(e){if(e>this._pool.length)for(let t=this._pool.length;t<e;t++)this._pool[t]=new this._constructor}allocate(){return this._count>=this._pool.length&&this._resize(2*this._pool.length),this._pool[this._count++]}freeAll(){this._count=0}}let RC,OC,zC,FC;const VC=new _u,NC=new _u,BC=new nu;class UC extends vw{constructor(e,t){super(e,t),this._angularDamping=0,this._angularFactor=new nu(1,1,1),this._angularVelocity=new nu,this._body=null,this._friction=.5,this._group=2,this._linearDamping=0,this._linearFactor=new nu(1,1,1),this._linearVelocity=new nu,this._mask=65533,this._mass=1,this._restitution=0,this._rollingFriction=0,this._simulationEnabled=!1,this._type=xS}static onLibraryLoaded(){"undefined"!=typeof Ammo&&(RC=new Ammo.btTransform,OC=new Ammo.btVector3,zC=new Ammo.btVector3,FC=new Ammo.btQuaternion)}set angularDamping(e){this._angularDamping!==e&&(this._angularDamping=e,this._body&&this._body.setDamping(this._linearDamping,e))}get angularDamping(){return this._angularDamping}set angularFactor(e){this._angularFactor.equals(e)||(this._angularFactor.copy(e),this._body&&this._type===wS&&(OC.setValue(e.x,e.y,e.z),this._body.setAngularFactor(OC)))}get angularFactor(){return this._angularFactor}set angularVelocity(e){this._body&&this._type===wS&&(this._body.activate(),OC.setValue(e.x,e.y,e.z),this._body.setAngularVelocity(OC),this._angularVelocity.copy(e))}get angularVelocity(){if(this._body&&this._type===wS){const e=this._body.getAngularVelocity();this._angularVelocity.set(e.x(),e.y(),e.z())}return this._angularVelocity}set body(e){this._body!==e&&(this._body=e,e&&this._simulationEnabled&&e.activate())}get body(){return this._body}set friction(e){this._friction!==e&&(this._friction=e,this._body&&this._body.setFriction(e))}get friction(){return this._friction}set group(e){this._group!==e&&(this._group=e,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}get group(){return this._group}set linearDamping(e){this._linearDamping!==e&&(this._linearDamping=e,this._body&&this._body.setDamping(e,this._angularDamping))}get linearDamping(){return this._linearDamping}set linearFactor(e){this._linearFactor.equals(e)||(this._linearFactor.copy(e),this._body&&this._type===wS&&(OC.setValue(e.x,e.y,e.z),this._body.setLinearFactor(OC)))}get linearFactor(){return this._linearFactor}set linearVelocity(e){this._body&&this._type===wS&&(this._body.activate(),OC.setValue(e.x,e.y,e.z),this._body.setLinearVelocity(OC),this._linearVelocity.copy(e))}get linearVelocity(){if(this._body&&this._type===wS){const e=this._body.getLinearVelocity();this._linearVelocity.set(e.x(),e.y(),e.z())}return this._linearVelocity}set mask(e){this._mask!==e&&(this._mask=e,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}get mask(){return this._mask}set mass(e){if(this._mass!==e&&(this._mass=e,this._body&&this._type===wS)){const t=this.enabled&&this.entity.enabled;t&&this.disableSimulation(),this._body.getCollisionShape().calculateLocalInertia(e,OC),this._body.setMassProps(e,OC),this._body.updateInertiaTensor(),t&&this.enableSimulation()}}get mass(){return this._mass}set restitution(e){this._restitution!==e&&(this._restitution=e,this._body&&this._body.setRestitution(e))}get restitution(){return this._restitution}set rollingFriction(e){this._rollingFriction!==e&&(this._rollingFriction=e,this._body&&this._body.setRollingFriction(e))}get rollingFriction(){return this._rollingFriction}set type(e){if(this._type!==e){switch(this._type=e,this.disableSimulation(),e){case wS:this._group=1,this._mask=65535;break;case SS:this._group=4,this._mask=65535;break;default:this._group=2,this._mask=65533}this.createBody()}}get type(){return this._type}createBody(){const e=this.entity;let t;if(e.collision&&(t=e.collision.shape,e.trigger&&(e.trigger.destroy(),delete e.trigger)),t){this._body&&(this.system.removeBody(this._body),this.system.destroyBody(this._body),this._body=null);const s=this._type===wS?this._mass:0;this._getEntityTransform(RC);const i=this.system.createBody(s,t,RC);if(i.setRestitution(this._restitution),i.setFriction(this._friction),i.setRollingFriction(this._rollingFriction),i.setDamping(this._linearDamping,this._angularDamping),this._type===wS){const e=this._linearFactor;OC.setValue(e.x,e.y,e.z),i.setLinearFactor(OC);const t=this._angularFactor;OC.setValue(t.x,t.y,t.z),i.setAngularFactor(OC)}else this._type===SS&&(i.setCollisionFlags(2|i.getCollisionFlags()),i.setActivationState(4));i.entity=e,this.body=i,this.enabled&&e.enabled&&this.enableSimulation()}}isActive(){return!!this._body&&this._body.isActive()}activate(){this._body&&this._body.activate()}enableSimulation(){const e=this.entity;if(e.collision&&e.collision.enabled&&!this._simulationEnabled){const t=this._body;if(t){switch(this.system.addBody(t,this._group,this._mask),this._type){case wS:this.system._dynamic.push(this),t.forceActivationState(1),this.syncEntityToBody();break;case SS:this.system._kinematic.push(this),t.forceActivationState(4);break;case xS:t.forceActivationState(1),this.syncEntityToBody()}"compound"===e.collision.type&&this.system._compounds.push(e.collision),t.activate(),this._simulationEnabled=!0}}}disableSimulation(){const e=this._body;if(e&&this._simulationEnabled){const t=this.system;let s=t._compounds.indexOf(this.entity.collision);s>-1&&t._compounds.splice(s,1),s=t._dynamic.indexOf(this),s>-1&&t._dynamic.splice(s,1),s=t._kinematic.indexOf(this),s>-1&&t._kinematic.splice(s,1),t.removeBody(e),e.forceActivationState(5),this._simulationEnabled=!1}}applyForce(e,t,s,i,n,r){const a=this._body;a&&(a.activate(),e instanceof nu?OC.setValue(e.x,e.y,e.z):OC.setValue(e,t,s),t instanceof nu?zC.setValue(t.x,t.y,t.z):void 0!==i?zC.setValue(i,n,r):zC.setValue(0,0,0),a.applyForce(OC,zC))}applyTorque(e,t,s){const i=this._body;i&&(i.activate(),e instanceof nu?OC.setValue(e.x,e.y,e.z):OC.setValue(e,t,s),i.applyTorque(OC))}applyImpulse(e,t,s,i,n,r){const a=this._body;a&&(a.activate(),e instanceof nu?OC.setValue(e.x,e.y,e.z):OC.setValue(e,t,s),t instanceof nu?zC.setValue(t.x,t.y,t.z):void 0!==i?zC.setValue(i,n,r):zC.setValue(0,0,0),a.applyImpulse(OC,zC))}applyTorqueImpulse(e,t,s){const i=this._body;i&&(i.activate(),e instanceof nu?OC.setValue(e.x,e.y,e.z):OC.setValue(e,t,s),i.applyTorqueImpulse(OC))}isStatic(){return this._type===xS}isStaticOrKinematic(){return this._type===xS||this._type===SS}isKinematic(){return this._type===SS}_getEntityTransform(e){const t=this.entity,s=t.collision;if(s){const e=s.getShapePosition(),t=s.getShapeRotation();OC.setValue(e.x,e.y,e.z),FC.setValue(t.x,t.y,t.z,t.w)}else{const e=t.getPosition(),s=t.getRotation();OC.setValue(e.x,e.y,e.z),FC.setValue(s.x,s.y,s.z,s.w)}e.setOrigin(OC),e.setRotation(FC)}syncEntityToBody(){const e=this._body;if(e){if(this._getEntityTransform(RC),e.setWorldTransform(RC),this._type===SS){const t=e.getMotionState();t&&t.setWorldTransform(RC)}e.activate()}}_updateDynamic(){const e=this._body;if(e.isActive()){const t=e.getMotionState();if(t){const e=this.entity;t.getWorldTransform(RC);const s=RC.getOrigin(),i=RC.getRotation(),n=e.collision;if(n&&n._hasOffset){const t=n.data.linearOffset,r=n.data.angularOffset,a=NC.copy(r).invert(),o=VC.set(i.x(),i.y(),i.z(),i.w()).mul(a);o.transformVector(t,BC),e.setPosition(s.x()-BC.x,s.y()-BC.y,s.z()-BC.z),e.setRotation(o)}else e.setPosition(s.x(),s.y(),s.z()),e.setRotation(i.x(),i.y(),i.z(),i.w())}}}_updateKinematic(){const e=this._body.getMotionState();e&&(this._getEntityTransform(RC),e.setWorldTransform(RC))}teleport(e,t,s,i,n,r){e instanceof nu?this.entity.setPosition(e):this.entity.setPosition(e,t,s),t instanceof _u?this.entity.setRotation(t):t instanceof nu?this.entity.setEulerAngles(t):void 0!==i&&this.entity.setEulerAngles(i,n,r),this.syncEntityToBody()}onEnable(){this._body||this.createBody(),this.enableSimulation()}onDisable(){this.disableSimulation()}}UC.EVENT_CONTACT="contact",UC.EVENT_COLLISIONSTART="collisionstart",UC.EVENT_COLLISIONEND="collisionend",UC.EVENT_TRIGGERENTER="triggerenter",UC.EVENT_TRIGGERLEAVE="triggerleave";class HC{constructor(){this.enabled=!0}}let WC,GC;class jC{constructor(e,t,s,i){this.entity=e,this.point=t,this.normal=s,this.hitFraction=i}}class qC{constructor(e,t,s){0===arguments.length?(this.a=null,this.b=null,this.impulse=0,this.localPointA=new nu,this.localPointB=new nu,this.pointA=new nu,this.pointB=new nu,this.normal=new nu):(this.a=e,this.b=t,this.impulse=s.impulse,this.localPointA=s.localPoint,this.localPointB=s.localPointOther,this.pointA=s.point,this.pointB=s.pointOther,this.normal=s.normal)}}class KC{constructor(e=new nu,t=new nu,s=new nu,i=new nu,n=new nu,r=0){this.localPoint=e,this.localPointOther=t,this.point=s,this.pointOther=i,this.normal=n,this.impulse=r}}class XC{constructor(e,t){this.other=e,this.contacts=t}}const YC=["enabled"];class ZC extends yw{constructor(e){super(e),this.maxSubSteps=10,this.fixedTimeStep=1/60,this.gravity=new nu(0,-9.81,0),this._gravityFloat32=new Float32Array(3),this._dynamic=[],this._kinematic=[],this._triggers=[],this._compounds=[],this.id="rigidbody",this._stats=e.stats.frame,this.ComponentType=UC,this.DataType=HC,this.contactPointPool=null,this.contactResultPool=null,this.singleContactResultPool=null,this.schema=YC,this.collisions={},this.frameCollisions={},this.on("beforeremove",this.onBeforeRemove,this)}onLibraryLoaded(){if("undefined"!=typeof Ammo){if(this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration),this.overlappingPairCache=new Ammo.btDbvtBroadphase,this.solver=new Ammo.btSequentialImpulseConstraintSolver,this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration),this.dynamicsWorld.setInternalTickCallback){const e=Ammo.addFunction(this._checkForCollisions.bind(this),"vif");this.dynamicsWorld.setInternalTickCallback(e)}WC=new Ammo.btVector3,GC=new Ammo.btVector3,UC.onLibraryLoaded(),this.contactPointPool=new IC(KC,1),this.contactResultPool=new IC(XC,1),this.singleContactResultPool=new IC(qC,1),this.app.systems.on("update",this.onUpdate,this)}else this.app.systems.off("update",this.onUpdate,this)}initializeComponentData(e,t,s){const i=["mass","linearDamping","angularDamping","linearFactor","angularFactor","friction","rollingFriction","restitution","type","group","mask"];for(const s of i)if(t.hasOwnProperty(s)){const i=t[s];Array.isArray(i)?e[s]=new nu(i[0],i[1],i[2]):e[s]=i}super.initializeComponentData(e,t,["enabled"])}cloneComponent(e,t){const s=e.rigidbody,i={enabled:s.enabled,mass:s.mass,linearDamping:s.linearDamping,angularDamping:s.angularDamping,linearFactor:[s.linearFactor.x,s.linearFactor.y,s.linearFactor.z],angularFactor:[s.angularFactor.x,s.angularFactor.y,s.angularFactor.z],friction:s.friction,rollingFriction:s.rollingFriction,restitution:s.restitution,type:s.type,group:s.group,mask:s.mask};return this.addComponent(t,i)}onBeforeRemove(e,t){t.enabled&&(t.enabled=!1),t.body&&(this.destroyBody(t.body),t.body=null)}addBody(e,t,s){void 0!==t&&void 0!==s?this.dynamicsWorld.addRigidBody(e,t,s):this.dynamicsWorld.addRigidBody(e)}removeBody(e){this.dynamicsWorld.removeRigidBody(e)}createBody(e,t,s){const i=new Ammo.btVector3(0,0,0);0!==e&&t.calculateLocalInertia(e,i);const n=new Ammo.btDefaultMotionState(s),r=new Ammo.btRigidBodyConstructionInfo(e,n,t,i),a=new Ammo.btRigidBody(r);return Ammo.destroy(r),Ammo.destroy(i),a}destroyBody(e){const t=e.getMotionState();t&&Ammo.destroy(t),Ammo.destroy(e)}raycastFirst(e,t,s={}){if(s.filterTags||s.filterCallback)return s.sort=!0,this.raycastAll(e,t,s)[0]||null;let i=null;WC.setValue(e.x,e.y,e.z),GC.setValue(t.x,t.y,t.z);const n=new Ammo.ClosestRayResultCallback(WC,GC);if("number"==typeof s.filterCollisionGroup&&n.set_m_collisionFilterGroup(s.filterCollisionGroup),"number"==typeof s.filterCollisionMask&&n.set_m_collisionFilterMask(s.filterCollisionMask),this.dynamicsWorld.rayTest(WC,GC,n),n.hasHit()){const e=n.get_m_collisionObject(),t=Ammo.castObject(e,Ammo.btRigidBody);if(t){const e=n.get_m_hitPointWorld(),s=n.get_m_hitNormalWorld();i=new jC(t.entity,new nu(e.x(),e.y(),e.z()),new nu(s.x(),s.y(),s.z()),n.get_m_closestHitFraction())}}return Ammo.destroy(n),i}raycastAll(e,t,s={}){const i=[];WC.setValue(e.x,e.y,e.z),GC.setValue(t.x,t.y,t.z);const n=new Ammo.AllHitsRayResultCallback(WC,GC);if("number"==typeof s.filterCollisionGroup&&n.set_m_collisionFilterGroup(s.filterCollisionGroup),"number"==typeof s.filterCollisionMask&&n.set_m_collisionFilterMask(s.filterCollisionMask),this.dynamicsWorld.rayTest(WC,GC,n),n.hasHit()){const e=n.get_m_collisionObjects(),t=n.get_m_hitPointWorld(),r=n.get_m_hitNormalWorld(),a=n.get_m_hitFractions(),o=e.size();for(let n=0;n<o;n++){const o=Ammo.castObject(e.at(n),Ammo.btRigidBody);if(o&&o.entity){if(s.filterTags&&!o.entity.tags.has(...s.filterTags)||s.filterCallback&&!s.filterCallback(o.entity))continue;const e=t.at(n),l=r.at(n),h=new jC(o.entity,new nu(e.x(),e.y(),e.z()),new nu(l.x(),l.y(),l.z()),a.at(n));i.push(h)}}s.sort&&i.sort(((e,t)=>e.hitFraction-t.hitFraction))}return Ammo.destroy(n),i}_storeCollision(e,t){let s=!1;const i=e.getGuid();return this.collisions[i]=this.collisions[i]||{others:[],entity:e},this.collisions[i].others.indexOf(t)<0&&(this.collisions[i].others.push(t),s=!0),this.frameCollisions[i]=this.frameCollisions[i]||{others:[],entity:e},this.frameCollisions[i].others.push(t),s}_createContactPointFromAmmo(e){const t=e.get_m_localPointA(),s=e.get_m_localPointB(),i=e.getPositionWorldOnA(),n=e.getPositionWorldOnB(),r=e.get_m_normalWorldOnB(),a=this.contactPointPool.allocate();return a.localPoint.set(t.x(),t.y(),t.z()),a.localPointOther.set(s.x(),s.y(),s.z()),a.point.set(i.x(),i.y(),i.z()),a.pointOther.set(n.x(),n.y(),n.z()),a.normal.set(r.x(),r.y(),r.z()),a.impulse=e.getAppliedImpulse(),a}_createReverseContactPointFromAmmo(e){const t=e.get_m_localPointA(),s=e.get_m_localPointB(),i=e.getPositionWorldOnA(),n=e.getPositionWorldOnB(),r=e.get_m_normalWorldOnB(),a=this.contactPointPool.allocate();return a.localPointOther.set(t.x(),t.y(),t.z()),a.localPoint.set(s.x(),s.y(),s.z()),a.pointOther.set(i.x(),i.y(),i.z()),a.point.set(n.x(),n.y(),n.z()),a.normal.set(r.x(),r.y(),r.z()),a.impulse=e.getAppliedImpulse(),a}_createSingleContactResult(e,t,s){const i=this.singleContactResultPool.allocate();return i.a=e,i.b=t,i.localPointA=s.localPoint,i.localPointB=s.localPointOther,i.pointA=s.point,i.pointB=s.pointOther,i.normal=s.normal,i.impulse=s.impulse,i}_createContactResult(e,t){const s=this.contactResultPool.allocate();return s.other=e,s.contacts=t,s}_cleanOldCollisions(){for(const e in this.collisions)if(this.collisions.hasOwnProperty(e)){const t=this.frameCollisions[e],s=this.collisions[e],i=s.entity,n=i.collision,r=i.rigidbody,a=s.others;let o=a.length;for(;o--;){const e=a[o];(!t||t.others.indexOf(e)<0)&&(a.splice(o,1),i.trigger?(n&&n.fire("triggerleave",e),e.rigidbody&&e.rigidbody.fire("triggerleave",i)):e.trigger||(r&&r.fire("collisionend",e),n&&n.fire("collisionend",e)))}0===a.length&&delete this.collisions[e]}}_hasContactEvent(e){const t=e.collision;if(t&&(t.hasEvent("collisionstart")||t.hasEvent("collisionend")||t.hasEvent("contact")))return!0;const s=e.rigidbody;return s&&(s.hasEvent("collisionstart")||s.hasEvent("collisionend")||s.hasEvent("contact"))}_checkForCollisions(e,t){const s=Ammo.wrapPointer(e,Ammo.btDynamicsWorld).getDispatcher(),i=s.getNumManifolds();this.frameCollisions={};for(let e=0;e<i;e++){const t=s.getManifoldByIndexInternal(e),i=t.getBody0(),n=t.getBody1(),r=Ammo.castObject(i,Ammo.btRigidBody),a=Ammo.castObject(n,Ammo.btRigidBody),o=r.entity,l=a.entity;if(!o||!l)continue;const h=r.getCollisionFlags(),c=a.getCollisionFlags(),d=t.getNumContacts(),u=[],p=[];let m;if(d>0)if(4&h||4&c){const e=o.collision&&(o.collision.hasEvent("triggerenter")||o.collision.hasEvent("triggerleave")),t=l.collision&&(l.collision.hasEvent("triggerenter")||l.collision.hasEvent("triggerleave")),s=o.rigidbody&&(o.rigidbody.hasEvent("triggerenter")||o.rigidbody.hasEvent("triggerleave")),i=l.rigidbody&&(l.rigidbody.hasEvent("triggerenter")||l.rigidbody.hasEvent("triggerleave"));e&&(m=this._storeCollision(o,l),!m||4&c||o.collision.fire("triggerenter",l)),t&&(m=this._storeCollision(l,o),!m||4&h||l.collision.fire("triggerenter",o)),s&&(m||(m=this._storeCollision(l,o)),m&&o.rigidbody.fire("triggerenter",l)),i&&(m||(m=this._storeCollision(o,l)),m&&l.rigidbody.fire("triggerenter",o))}else{const e=this._hasContactEvent(o),s=this._hasContactEvent(l),i=this.hasEvent("contact");if(i||e||s){for(let n=0;n<d;n++){const r=t.getContactPoint(n),a=this._createContactPointFromAmmo(r);if(e||s){u.push(a);const e=this._createReverseContactPointFromAmmo(r);p.push(e)}if(i){const e=this._createSingleContactResult(o,l,a);this.fire("contact",e)}}if(e){const e=this._createContactResult(l,u);m=this._storeCollision(o,l),o.collision&&(o.collision.fire("contact",e),m&&o.collision.fire("collisionstart",e)),o.rigidbody&&(o.rigidbody.fire("contact",e),m&&o.rigidbody.fire("collisionstart",e))}if(s){const e=this._createContactResult(o,p);m=this._storeCollision(l,o),l.collision&&(l.collision.fire("contact",e),m&&l.collision.fire("collisionstart",e)),l.rigidbody&&(l.rigidbody.fire("contact",e),m&&l.rigidbody.fire("collisionstart",e))}}}}this._cleanOldCollisions(),this.contactPointPool.freeAll(),this.contactResultPool.freeAll(),this.singleContactResultPool.freeAll()}onUpdate(e){let t,s;this._gravityFloat32[0]=this.gravity.x,this._gravityFloat32[1]=this.gravity.y,this._gravityFloat32[2]=this.gravity.z;const i=this.dynamicsWorld.getGravity();i.x()===this._gravityFloat32[0]&&i.y()===this._gravityFloat32[1]&&i.z()===this._gravityFloat32[2]||(i.setValue(this.gravity.x,this.gravity.y,this.gravity.z),this.dynamicsWorld.setGravity(i));const n=this._triggers;for(t=0,s=n.length;t<s;t++)n[t].updateTransform();const r=this._compounds;for(t=0,s=r.length;t<s;t++)r[t]._updateCompound();const a=this._kinematic;for(t=0,s=a.length;t<s;t++)a[t]._updateKinematic();this.dynamicsWorld.stepSimulation(e,this.maxSubSteps,this.fixedTimeStep);const o=this._dynamic;for(t=0,s=o.length;t<s;t++)o[t]._updateDynamic();this.dynamicsWorld.setInternalTickCallback||this._checkForCollisions(Ammo.getPointer(this.dynamicsWorld),e)}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this),"undefined"!=typeof Ammo&&(Ammo.destroy(this.dynamicsWorld),Ammo.destroy(this.solver),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.dispatcher),Ammo.destroy(this.collisionConfiguration),this.dynamicsWorld=null,this.solver=null,this.overlappingPairCache=null,this.dispatcher=null,this.collisionConfiguration=null)}}ZC.EVENT_CONTACT="contact",vw._buildAccessors(UC.prototype,YC);const $C="none",QC=new pu;vw._buildAccessors(class extends vw{constructor(e,t){super(e,t),this._resolution=new au(640,320),this._referenceResolution=new au(640,320),this._scaleMode=$C,this.scale=1,this._scaleBlend=.5,this._priority=0,this._screenSpace=!1,this.cull=this._screenSpace,this._screenMatrix=new pu,this._elements=new Set,e.app.graphicsDevice.on("resizecanvas",this._onResize,this)}syncDrawOrder(){this.system.queueDrawOrderSync(this.entity.getGuid(),this._processDrawOrderSync,this)}_recurseDrawOrderSync(e,t){if(!(e instanceof hw))return t;if(e.element){const i=e.element.drawOrder;var s;if(e.element.drawOrder=t++,e.element._batchGroupId>=0&&i!==e.element.drawOrder)null==(s=this.system.app.batcher)||s.markGroupDirty(e.element._batchGroupId)}e.particlesystem&&(e.particlesystem.drawOrder=t++);const i=e.children;for(let e=0;e<i.length;e++)t=this._recurseDrawOrderSync(i[e],t);return t}_processDrawOrderSync(){this._recurseDrawOrderSync(this.entity,1),this.fire("syncdraworder")}_calcProjectionMatrix(){const e=this._resolution.x/this.scale,t=this._resolution.y/this.scale,s=e,i=-t;this._screenMatrix.setOrtho(0,s,i,0,1,-1),this._screenSpace||(QC.setScale(.5*e,.5*t,1),this._screenMatrix.mul2(QC,this._screenMatrix))}_updateScale(){this.scale=this._calcScale(this._resolution,this.referenceResolution)}_calcScale(e,t){const s=Math.log2((e.x||1)/t.x),i=Math.log2((e.y||1)/t.y);return Math.pow(2,s*(1-this._scaleBlend)+i*this._scaleBlend)}_onResize(e,t){this._screenSpace&&(this._resolution.set(e,t),this.resolution=this._resolution)}_bindElement(e){this._elements.add(e)}_unbindElement(e){this._elements.delete(e)}onRemove(){this.system.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.fire("remove"),this._elements.forEach((e=>e._onScreenRemove())),this._elements.clear(),this.off()}set resolution(e){this._screenSpace?this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height):this._resolution.set(e.x,e.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:resolution",this._resolution),this._elements.forEach((e=>e._onScreenResize(this._resolution)))}get resolution(){return this._resolution}set referenceResolution(e){this._referenceResolution.set(e.x,e.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:referenceresolution",this._resolution),this._elements.forEach((e=>e._onScreenResize(this._resolution)))}get referenceResolution(){return this._scaleMode===$C?this._resolution:this._referenceResolution}set screenSpace(e){this._screenSpace=e,this._screenSpace&&this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height),this.resolution=this._resolution,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:screenspace",this._screenSpace),this._elements.forEach((e=>e._onScreenSpaceChange()))}get screenSpace(){return this._screenSpace}set scaleMode(e){e!==$C&&"blend"!==e&&(e=$C),this._screenSpace||e===$C||(e=$C),this._scaleMode=e,this.resolution=this._resolution,this.fire("set:scalemode",this._scaleMode)}get scaleMode(){return this._scaleMode}set scaleBlend(e){this._scaleBlend=e,this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:scaleblend",this._scaleBlend),this._elements.forEach((e=>e._onScreenResize(this._resolution)))}get scaleBlend(){return this._scaleBlend}set priority(e){e>255&&(e=255),this._priority!==e&&(this._priority=e,this.syncDrawOrder())}get priority(){return this._priority}}.prototype,["enabled"]);vw._buildAccessors(class extends vw{constructor(e,t){super(e,t),this.on("set_scripts",this.onSetScripts,this)}send(e,t){const s=Array.prototype.slice.call(arguments,2),i=this.entity.script.instances;let n;if(i&&i[e]&&(n=i[e].instance[t],n))return n.apply(i[e].instance,s)}onEnable(){this.data.areScriptsLoaded&&!this.system.preloading&&(this.data.initialized?this.system._enableScriptComponent(this):this.system._initializeScriptComponent(this),this.data.postInitialized||this.system._postInitializeScriptComponent(this))}onDisable(){this.system._disableScriptComponent(this)}onSetScripts(e,t,s){if(!this.system._inTools||this.runInTools){if(this._updateScriptAttributes(t,s))return;this.enabled&&this.system._disableScriptComponent(this),this.system._destroyScriptComponent(this),this.data.areScriptsLoaded=!1;const e=s.map((function(e){return e.url}));if(this._loadFromCache(e))return;this._loadScripts(e)}}_updateScriptAttributes(e,t){let s=!0;if(e.length!==t.length)s=!1;else for(let i=0,n=t.length;i<n;i++)if(e[i].url!==t[i].url){s=!1;break}if(s)for(const e in this.instances)this.instances.hasOwnProperty(e)&&this.system._updateAccessors(this.entity,this.instances[e]);return s}_loadFromCache(e){const t=[],s=this.system.app._scriptPrefix||"",i=/^http(s)?:\/\//i;for(let n=0,r=e.length;n<r;n++){let r=e[n];i.test(r)||(r=cd.join(s,r));const a=this.system.app.loader.getFromCache(r,"script");if(!a)return!1;t.push(a)}for(let s=0,i=t.length;s<i;s++){const i=t[s];if(!0!==i&&(i&&this.entity.script&&!this.entity.script.instances[i._pcScriptName])){const t=new i(this.entity);this.system._preRegisterInstance(this.entity,e[s],i._pcScriptName,t)}}return this.data&&(this.data.areScriptsLoaded=!0),this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)),!0}_loadScripts(e){let t=e.length;const s=this.system.app._scriptPrefix||"";e.forEach((e=>{let i=null,n=null;e.toLowerCase().startsWith("http://")||e.toLowerCase().startsWith("https://")?(n=e,i=e):(n=e,i=cd.join(s,e)),this.system.app.loader.load(i,"script",((e,s)=>{if(t--,e)console.error(e);else if(s&&this.entity.script&&!this.entity.script.instances[s._pcScriptName]){const e=new s(this.entity);this.system._preRegisterInstance(this.entity,n,s._pcScriptName,e)}0===t&&(this.data.areScriptsLoaded=!0,this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)))}))}))}}.prototype,["enabled","scripts","instances","runInTools"]);const JC=new au,eT=new nu,tT=new Au,sT=new class{constructor(e=nu.UP,t=0){this.normal=new nu,this.distance=void 0,this.normal.copy(e),this.distance=t}setFromPointNormal(e,t){return this.normal.copy(t),this.distance=-this.normal.dot(e),this}intersectsLine(e,t,s){const i=this.distance,n=this.normal.dot(e)+i,r=n/(n-(this.normal.dot(t)+i)),a=r>=0&&r<=1;return a&&s&&s.lerp(e,t,r),a}intersectsRay(e,t){const s=this.normal.dot(e.direction);if(0===s)return!1;const i=-(this.normal.dot(e.origin)+this.distance)/s;return i>=0&&t&&t.copy(e.direction).mulScalar(i).add(e.origin),i>=0}copy(e){return this.normal.copy(e.normal),this.distance=e.distance,this}clone(){return(new(0,this.constructor)).copy(this)}},iT=new nu,nT=new nu,rT=new _u,aT={x:"y",y:"x"};class oT extends od{constructor(e,t){if(super(),!(e&&e instanceof iC))throw new Error("Element was null or not an ElementComponent");if(t&&"x"!==t&&"y"!==t)throw new Error("Unrecognized axis: "+t);this._element=e,this._app=e.system.app,this._axis=t||null,this._enabled=!0,this._dragScale=new nu,this._dragStartMousePosition=new nu,this._dragStartHandlePosition=new nu,this._deltaMousePosition=new nu,this._deltaHandlePosition=new nu,this._isDragging=!1,this._toggleLifecycleListeners("on")}_toggleLifecycleListeners(e){this._element[e]("mousedown",this._onMouseDownOrTouchStart,this),this._element[e]("touchstart",this._onMouseDownOrTouchStart,this),this._element[e]("selectstart",this._onMouseDownOrTouchStart,this)}_toggleDragListeners(e){const t="on"===e;this._hasDragListeners&&t||(this._app.mouse&&(this._element[e]("mousemove",this._onMove,this),this._element[e]("mouseup",this._onMouseUpOrTouchEnd,this)),Sd.touch&&(this._element[e]("touchmove",this._onMove,this),this._element[e]("touchend",this._onMouseUpOrTouchEnd,this),this._element[e]("touchcancel",this._onMouseUpOrTouchEnd,this)),this._element[e]("selectmove",this._onMove,this),this._element[e]("selectend",this._onMouseUpOrTouchEnd,this),this._hasDragListeners=t)}_onMouseDownOrTouchStart(e){if(this._element&&!this._isDragging&&this.enabled){this._dragCamera=e.camera,this._calculateDragScale();const t=this._screenToLocal(e);t&&(this._toggleDragListeners("on"),this._isDragging=!0,this._dragStartMousePosition.copy(t),this._dragStartHandlePosition.copy(this._element.entity.getLocalPosition()),this.fire("drag:start"))}}_onMouseUpOrTouchEnd(){this._isDragging&&(this._isDragging=!1,this._toggleDragListeners("off"),this.fire("drag:end"))}_screenToLocal(e){return e.inputSource?tT.set(e.inputSource.getOrigin(),e.inputSource.getDirection()):(this._determineInputPosition(e),this._chooseRayOriginAndDirection()),iT.copy(this._element.entity.forward).mulScalar(-1),sT.setFromPointNormal(this._element.entity.getPosition(),iT),sT.intersectsRay(tT,nT)?(rT.copy(this._element.entity.getRotation()).invert().transformVector(nT,nT),nT.mul(this._dragScale),nT):null}_determineInputPosition(e){const t=this._app.graphicsDevice.maxPixelRatio;void 0!==e.x&&void 0!==e.y?(JC.x=e.x*t,JC.y=e.y*t):e.changedTouches?(JC.x=e.changedTouches[0].x*t,JC.y=e.changedTouches[0].y*t):console.warn("Could not determine position from input event")}_chooseRayOriginAndDirection(){this._element.screen&&this._element.screen.screen.screenSpace?(tT.origin.set(JC.x,-JC.y,0),tT.direction.copy(nu.FORWARD)):(eT.copy(this._dragCamera.screenToWorld(JC.x,JC.y,1)),tT.origin.copy(this._dragCamera.entity.getPosition()),tT.direction.copy(eT).sub(tT.origin).normalize())}_calculateDragScale(){let e=this._element.entity.parent;const t=this._element.screen&&this._element.screen.screen,s=t&&t.screenSpace,i=s?t.scale:1,n=this._dragScale;for(n.set(i,i,i);e&&(n.mul(e.getLocalScale()),e=e.parent,!s||!e.screen););n.x=1/n.x,n.y=1/n.y,n.z=0}_onMove(e){const{_element:t,_deltaMousePosition:s,_deltaHandlePosition:i,_axis:n}=this;if(t&&this._isDragging&&this.enabled&&t.enabled&&t.entity.enabled){const r=this._screenToLocal(e);if(r){if(s.sub2(r,this._dragStartMousePosition),i.add2(this._dragStartHandlePosition,s),n){const e=t.entity.getLocalPosition(),s=aT[n];i[s]=e[s]}t.entity.setLocalPosition(i),this.fire("drag:move",i)}}}destroy(){this._toggleLifecycleListeners("off"),this._toggleDragListeners("off")}set enabled(e){this._enabled=e}get enabled(){return this._enabled}get isDragging(){return this._isDragging}}oT.EVENT_DRAGSTART="drag:start",oT.EVENT_DRAGEND="drag:end",oT.EVENT_DRAGMOVE="drag:move";const lT=new au;class hT extends vw{constructor(e,t){super(e,t),this._viewportReference=new aS(this,"viewportEntity",{"element#gain":this._onViewportElementGain,"element#resize":this._onSetContentOrViewportSize}),this._contentReference=new aS(this,"contentEntity",{"element#gain":this._onContentElementGain,"element#lose":this._onContentElementLose,"element#resize":this._onSetContentOrViewportSize}),this._scrollbarUpdateFlags={},this._scrollbarReferences={},this._scrollbarReferences[0]=new aS(this,"horizontalScrollbarEntity",{"scrollbar#set:value":this._onSetHorizontalScrollbarValue,"scrollbar#gain":this._onHorizontalScrollbarGain}),this._scrollbarReferences[1]=new aS(this,"verticalScrollbarEntity",{"scrollbar#set:value":this._onSetVerticalScrollbarValue,"scrollbar#gain":this._onVerticalScrollbarGain}),this._prevContentSizes={},this._prevContentSizes[0]=null,this._prevContentSizes[1]=null,this._scroll=new au,this._velocity=new nu,this._dragStartPosition=new nu,this._disabledContentInput=!1,this._disabledContentInputEntities=[],this._toggleLifecycleListeners("on",e),this._toggleElementListeners("on")}_toggleLifecycleListeners(e,t){this[e]("set_horizontal",this._onSetHorizontalScrollingEnabled,this),this[e]("set_vertical",this._onSetVerticalScrollingEnabled,this),t.app.systems.element[e]("add",this._onElementComponentAdd,this),t.app.systems.element[e]("beforeremove",this._onElementComponentRemove,this)}_toggleElementListeners(e){if(this.entity.element){if("on"===e&&this._hasElementListeners)return;this.entity.element[e]("resize",this._onSetContentOrViewportSize,this),this.entity.element[e](Qm,this._onMouseWheel,this),this._hasElementListeners="on"===e}}_onElementComponentAdd(e){this.entity===e&&this._toggleElementListeners("on")}_onElementComponentRemove(e){this.entity===e&&this._toggleElementListeners("off")}_onViewportElementGain(){this._syncAll()}_onContentElementGain(){this._destroyDragHelper(),this._contentDragHelper=new oT(this._contentReference.entity.element),this._contentDragHelper.on("drag:start",this._onContentDragStart,this),this._contentDragHelper.on("drag:end",this._onContentDragEnd,this),this._contentDragHelper.on("drag:move",this._onContentDragMove,this),this._prevContentSizes[0]=null,this._prevContentSizes[1]=null,this._syncAll()}_onContentElementLose(){this._destroyDragHelper()}_onContentDragStart(){this._contentReference.entity&&this.enabled&&this.entity.enabled&&this._dragStartPosition.copy(this._contentReference.entity.getLocalPosition())}_onContentDragEnd(){this._prevContentDragPosition=null,this._enableContentInput()}_onContentDragMove(e){if(this._contentReference.entity&&this.enabled&&this.entity.enabled&&(this._wasDragged=!0,this._setScrollFromContentPosition(e),this._setVelocityFromContentPositionDelta(e),!this._disabledContentInput)){const t=e.x-this._dragStartPosition.x,s=e.y-this._dragStartPosition.y;(Math.abs(t)>this.dragThreshold||Math.abs(s)>this.dragThreshold)&&this._disableContentInput()}}_onSetContentOrViewportSize(){this._syncAll()}_onSetHorizontalScrollbarValue(e){!this._scrollbarUpdateFlags[0]&&this.enabled&&this.entity.enabled&&this._onSetScroll(e,null)}_onSetVerticalScrollbarValue(e){!this._scrollbarUpdateFlags[1]&&this.enabled&&this.entity.enabled&&this._onSetScroll(null,e)}_onSetHorizontalScrollingEnabled(){this._syncScrollbarEnabledState(0)}_onSetVerticalScrollingEnabled(){this._syncScrollbarEnabledState(1)}_onHorizontalScrollbarGain(){this._syncScrollbarEnabledState(0),this._syncScrollbarPosition(0)}_onVerticalScrollbarGain(){this._syncScrollbarEnabledState(1),this._syncScrollbarPosition(1)}_onSetScroll(e,t,s){!1!==s&&this._velocity.set(0,0,0);const i=this._updateAxis(e,"x",0),n=this._updateAxis(t,"y",1);(i||n)&&this.fire("set:scroll",this._scroll)}_updateAxis(e,t,s){const i=null!==e&&Math.abs(e-this._scroll[t])>1e-5;return(i||this._isDragging()||0===e)&&(this._scroll[t]=this._determineNewScrollValue(e,t,s),this._syncContentPosition(s),this._syncScrollbarPosition(s)),i}_determineNewScrollValue(e,t,s){if(!this._getScrollingEnabled(s))return this._scroll[t];switch(this.scrollMode){case 0:return Wd.clamp(e,0,this._getMaxScrollValue(s));case 1:return this._setVelocityFromOvershoot(e,t,s),e;case 2:return e;default:return console.warn("Unhandled scroll mode:"+this.scrollMode),e}}_syncAll(){this._syncContentPosition(0),this._syncContentPosition(1),this._syncScrollbarPosition(0),this._syncScrollbarPosition(1),this._syncScrollbarEnabledState(0),this._syncScrollbarEnabledState(1)}_syncContentPosition(e){const t=this._getAxis(e),s=this._getSign(e),i=this._contentReference.entity;if(i){const n=this._prevContentSizes[e],r=this._getContentSize(e);if(null!==n&&Math.abs(n-r)>1e-4){const s=this._getMaxOffset(e,n),i=this._getMaxOffset(e,r);this._scroll[t]=0===i?1:Wd.clamp(this._scroll[t]*s/i,0,1)}const a=this._scroll[t]*this._getMaxOffset(e),o=i.getLocalPosition();o[t]=a*s,i.setLocalPosition(o),this._prevContentSizes[e]=r}}_syncScrollbarPosition(e){const t=this._getAxis(e),s=this._scrollbarReferences[e].entity;s&&s.scrollbar&&(this._scrollbarUpdateFlags[e]=!0,s.scrollbar.value=this._scroll[t],s.scrollbar.handleSize=this._getScrollbarHandleSize(t,e),this._scrollbarUpdateFlags[e]=!1)}_syncScrollbarEnabledState(e){const t=this._scrollbarReferences[e].entity;if(t){const s=this._getScrollingEnabled(e),i=this._getScrollbarVisibility(e);switch(i){case 0:return void(t.enabled=s);case 1:return void(t.enabled=s&&this._contentIsLargerThanViewport(e));default:console.warn("Unhandled scrollbar visibility:"+i),t.enabled=s}}}_contentIsLargerThanViewport(e){return this._getContentSize(e)>this._getViewportSize(e)}_contentPositionToScrollValue(e){const t=this._getMaxOffset(0),s=this._getMaxOffset(1);return lT.x=0===t?0:e.x/t,lT.y=0===s?0:e.y/-s,lT}_getMaxOffset(e,t){t=void 0===t?this._getContentSize(e):t;const s=this._getViewportSize(e);return t<s?-this._getViewportSize(e):s-t}_getMaxScrollValue(e){return this._contentIsLargerThanViewport(e)?1:0}_getScrollbarHandleSize(e,t){const s=this._getViewportSize(t),i=this._getContentSize(t);if(Math.abs(i)<.001)return 1;const n=Math.min(s/i,1),r=this._toOvershoot(this._scroll[e],t);return 0===r?n:n/(1+Math.abs(r))}_getViewportSize(e){return this._getSize(e,this._viewportReference)}_getContentSize(e){return this._getSize(e,this._contentReference)}_getSize(e,t){return t.entity&&t.entity.element?t.entity.element[this._getCalculatedDimension(e)]:0}_getScrollingEnabled(e){return 0===e?this.horizontal:1===e?this.vertical:void 0}_getScrollbarVisibility(e){return 0===e?this.horizontalScrollbarVisibility:1===e?this.verticalScrollbarVisibility:void 0}_getSign(e){return 0===e?1:-1}_getAxis(e){return 0===e?"x":"y"}_getCalculatedDimension(e){return 0===e?"calculatedWidth":"calculatedHeight"}_destroyDragHelper(){this._contentDragHelper&&this._contentDragHelper.destroy()}onUpdate(){this._contentReference.entity&&(this._updateVelocity(),this._syncScrollbarEnabledState(0),this._syncScrollbarEnabledState(1))}_updateVelocity(){if(!this._isDragging()){if(1===this.scrollMode&&(this._hasOvershoot("x",0)&&this._setVelocityFromOvershoot(this.scroll.x,"x",0),this._hasOvershoot("y",1)&&this._setVelocityFromOvershoot(this.scroll.y,"y",1)),Math.abs(this._velocity.x)>1e-4||Math.abs(this._velocity.y)>1e-4){const e=this._contentReference.entity.getLocalPosition();e.x+=this._velocity.x,e.y+=this._velocity.y,this._contentReference.entity.setLocalPosition(e),this._setScrollFromContentPosition(e)}this._velocity.x*=1-this.friction,this._velocity.y*=1-this.friction}}_hasOvershoot(e,t){return Math.abs(this._toOvershoot(this.scroll[e],t))>.001}_toOvershoot(e,t){const s=this._getMaxScrollValue(t);return e<0?e:e>s?e-s:0}_setVelocityFromOvershoot(e,t,s){const i=this._toOvershoot(e,s)*this._getMaxOffset(s)*this._getSign(s);Math.abs(i)>0&&(this._velocity[t]=-i/(50*this.bounceAmount+1))}_setVelocityFromContentPositionDelta(e){this._prevContentDragPosition?(this._velocity.sub2(e,this._prevContentDragPosition),this._prevContentDragPosition.copy(e)):(this._velocity.set(0,0,0),this._prevContentDragPosition=e.clone())}_setScrollFromContentPosition(e){let t=this._contentPositionToScrollValue(e);this._isDragging()&&(t=this._applyScrollValueTension(t)),this._onSetScroll(t.x,t.y,!1)}_applyScrollValueTension(e){let t=this._getMaxScrollValue(0),s=this._toOvershoot(e.x,0);return s>0?e.x=t+1*Math.log10(1+s):s<0&&(e.x=-1*Math.log10(1-s)),t=this._getMaxScrollValue(1),s=this._toOvershoot(e.y,1),s>0?e.y=t+1*Math.log10(1+s):s<0&&(e.y=-1*Math.log10(1-s)),e}_isDragging(){return this._contentDragHelper&&this._contentDragHelper.isDragging}_setScrollbarComponentsEnabled(e){this._scrollbarReferences[0].hasComponent("scrollbar")&&(this._scrollbarReferences[0].entity.scrollbar.enabled=e),this._scrollbarReferences[1].hasComponent("scrollbar")&&(this._scrollbarReferences[1].entity.scrollbar.enabled=e)}_setContentDraggingEnabled(e){this._contentDragHelper&&(this._contentDragHelper.enabled=e)}_onMouseWheel(e){if(this.useMouseWheel){const t=e.event,s=t.deltaX/this._contentReference.entity.element.calculatedWidth*this.mouseWheelSensitivity.x,i=t.deltaY/this._contentReference.entity.element.calculatedHeight*this.mouseWheelSensitivity.y,n=Wd.clamp(this._scroll.x+s,0,this._getMaxScrollValue(0)),r=Wd.clamp(this._scroll.y+i,0,this._getMaxScrollValue(1));this.scroll=new au(n,r)}}_enableContentInput(){for(;this._disabledContentInputEntities.length;){const e=this._disabledContentInputEntities.pop();e.element&&(e.element.useInput=!0)}this._disabledContentInput=!1}_disableContentInput(){const e=t=>{t.element&&t.element.useInput&&(this._disabledContentInputEntities.push(t),t.element.useInput=!1);const s=t.children;for(let t=0,i=s.length;t<i;t++)e(s[t])},t=this._contentReference.entity;if(t){const s=t.children;for(let t=0,i=s.length;t<i;t++)e(s[t])}this._disabledContentInput=!0}onEnable(){this._viewportReference.onParentComponentEnable(),this._contentReference.onParentComponentEnable(),this._scrollbarReferences[0].onParentComponentEnable(),this._scrollbarReferences[1].onParentComponentEnable(),this._setScrollbarComponentsEnabled(!0),this._setContentDraggingEnabled(!0),this._syncAll()}onDisable(){this._setScrollbarComponentsEnabled(!1),this._setContentDraggingEnabled(!1)}onRemove(){this._toggleLifecycleListeners("off",this.system),this._toggleElementListeners("off"),this._destroyDragHelper()}set scroll(e){this._onSetScroll(e.x,e.y)}get scroll(){return this._scroll}}hT.EVENT_SETSCROLL="set:scroll";vw._buildAccessors(hT.prototype,[{name:"enabled",type:"boolean"},{name:"horizontal",type:"boolean"},{name:"vertical",type:"boolean"},{name:"scrollMode",type:"number"},{name:"bounceAmount",type:"number"},{name:"friction",type:"number"},{name:"dragThreshold",type:"number"},{name:"useMouseWheel",type:"boolean"},{name:"mouseWheelSensitivity",type:"vec2"},{name:"horizontalScrollbarVisibility",type:"number"},{name:"verticalScrollbarVisibility",type:"number"},{name:"viewportEntity",type:"entity"},{name:"contentEntity",type:"entity"},{name:"horizontalScrollbarEntity",type:"entity"},{name:"verticalScrollbarEntity",type:"entity"}]);class cT extends vw{constructor(e,t){super(e,t),this._handleReference=new aS(this,"handleEntity",{"element#gain":this._onHandleElementGain,"element#lose":this._onHandleElementLose,"element#set:anchor":this._onSetHandleAlignment,"element#set:margin":this._onSetHandleAlignment,"element#set:pivot":this._onSetHandleAlignment}),this._toggleLifecycleListeners("on")}_toggleLifecycleListeners(e){this[e]("set_value",this._onSetValue,this),this[e]("set_handleSize",this._onSetHandleSize,this),this[e]("set_orientation",this._onSetOrientation,this)}_onHandleElementGain(){this._destroyDragHelper(),this._handleDragHelper=new oT(this._handleReference.entity.element,this._getAxis()),this._handleDragHelper.on("drag:move",this._onHandleDrag,this),this._updateHandlePositionAndSize()}_onHandleElementLose(){this._destroyDragHelper()}_onHandleDrag(e){this._handleReference.entity&&this.enabled&&this.entity.enabled&&(this.value=this._handlePositionToScrollValue(e[this._getAxis()]))}_onSetValue(e,t,s){Math.abs(s-t)>1e-5&&(this.data.value=Wd.clamp(s,0,1),this._updateHandlePositionAndSize(),this.fire("set:value",this.data.value))}_onSetHandleSize(e,t,s){Math.abs(s-t)>1e-5&&(this.data.handleSize=Wd.clamp(s,0,1),this._updateHandlePositionAndSize())}_onSetHandleAlignment(){this._updateHandlePositionAndSize()}_onSetOrientation(e,t,s){s!==t&&this._handleReference.hasComponent("element")&&(this._handleReference.entity.element[this._getOppositeDimension()]=0)}_updateHandlePositionAndSize(){const e=this._handleReference.entity,t=e&&e.element;if(e){const t=e.getLocalPosition();t[this._getAxis()]=this._getHandlePosition(),this._handleReference.entity.setLocalPosition(t)}t&&(t[this._getDimension()]=this._getHandleLength())}_handlePositionToScrollValue(e){return e*this._getSign()/this._getUsableTrackLength()}_scrollValueToHandlePosition(e){return e*this._getSign()*this._getUsableTrackLength()}_getUsableTrackLength(){return Math.max(this._getTrackLength()-this._getHandleLength(),.001)}_getTrackLength(){return this.entity.element?0===this.orientation?this.entity.element.calculatedWidth:this.entity.element.calculatedHeight:0}_getHandleLength(){return this._getTrackLength()*this.handleSize}_getHandlePosition(){return this._scrollValueToHandlePosition(this.value)}_getSign(){return 0===this.orientation?1:-1}_getAxis(){return 0===this.orientation?"x":"y"}_getDimension(){return 0===this.orientation?"width":"height"}_getOppositeDimension(){return 0===this.orientation?"height":"width"}_destroyDragHelper(){this._handleDragHelper&&this._handleDragHelper.destroy()}_setHandleDraggingEnabled(e){this._handleDragHelper&&(this._handleDragHelper.enabled=e)}onEnable(){this._handleReference.onParentComponentEnable(),this._setHandleDraggingEnabled(!0)}onDisable(){this._setHandleDraggingEnabled(!1)}onRemove(){this._destroyDragHelper(),this._toggleLifecycleListeners("off")}}cT.EVENT_SETVALUE="set:value";vw._buildAccessors(cT.prototype,[{name:"enabled",type:"boolean"},{name:"orientation",type:"number"},{name:"value",type:"number"},{name:"handleSize",type:"number"},{name:"handleEntity",type:"entity"}]);const dT={volume:0,pitch:0,loop:!1,startTime:0,duration:0,position:new nu,maxDistance:0,refDistance:0,rollOffFactor:0,distanceModel:0,onPlay:null,onPause:null,onResume:null,onStop:null,onEnd:null};class uT extends od{constructor(e,t="Untitled",s={}){super(),this.name=void 0,this.instances=[],this._component=e,this._assets=e.system.app.assets,this._manager=e.system.manager,this.name=t,this._volume=void 0!==s.volume?Wd.clamp(Number(s.volume)||0,0,1):1,this._pitch=void 0!==s.pitch?Math.max(.01,Number(s.pitch)||0):1,this._loop=!(void 0===s.loop||!s.loop),this._duration=s.duration>0?s.duration:null,this._startTime=Math.max(0,Number(s.startTime)||0),this._overlap=!!s.overlap,this._autoPlay=!!s.autoPlay,this._firstNode=null,this._lastNode=null,this._asset=s.asset,this._asset instanceof Yx&&(this._asset=this._asset.id),this._onInstancePlayHandler=this._onInstancePlay.bind(this),this._onInstancePauseHandler=this._onInstancePause.bind(this),this._onInstanceResumeHandler=this._onInstanceResume.bind(this),this._onInstanceStopHandler=this._onInstanceStop.bind(this),this._onInstanceEndHandler=this._onInstanceEnd.bind(this)}play(){if(this.overlap||this.stop(),!this.isLoaded&&!this._hasAsset())return;const e=this._createInstance();if(this.instances.push(e),this.isLoaded)e.play();else{const t=function(t){const s=e._playWhenLoaded;e.sound=t,s&&e.play()};this.off("load",t),this.once("load",t),this.load()}return e}pause(){let e=!1;const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].pause()&&(e=!0);return e}resume(){let e=!1;const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].resume()&&(e=!0);return e}stop(){let e=!1;const t=this.instances;let s=t.length;for(;s--;)t[s].stop(),e=!0;return t.length=0,e}load(){if(!this._hasAsset())return;const e=this._assets.get(this._asset);return e?(e.off("remove",this._onAssetRemoved,this),e.on("remove",this._onAssetRemoved,this),e.resource?void this.fire("load",e.resource):(e.off("load",this._onAssetLoad,this),e.once("load",this._onAssetLoad,this),void this._assets.load(e))):(this._assets.off("add:"+this._asset,this._onAssetAdd,this),void this._assets.once("add:"+this._asset,this._onAssetAdd,this))}setExternalNodes(e,t){if(e){if(t||(t=e),this._firstNode=e,this._lastNode=t,!this._overlap){const s=this.instances;for(let i=0,n=s.length;i<n;i++)s[i].setExternalNodes(e,t)}}else console.error("The firstNode must have a valid AudioNode")}clearExternalNodes(){if(this._firstNode=null,this._lastNode=null,!this._overlap){const e=this.instances;for(let t=0,s=e.length;t<s;t++)e[t].clearExternalNodes()}}getExternalNodes(){return[this._firstNode,this._lastNode]}_hasAsset(){return null!=this._asset}_createInstance(){let e=null;const t=this._component;let s=null;if(this._hasAsset()){const e=this._assets.get(this._asset);e&&(s=e.resource)}const i=dT;return i.volume=this._volume*t.volume,i.pitch=this._pitch*t.pitch,i.loop=this._loop,i.startTime=this._startTime,i.duration=this._duration,i.onPlay=this._onInstancePlayHandler,i.onPause=this._onInstancePauseHandler,i.onResume=this._onInstanceResumeHandler,i.onStop=this._onInstanceStopHandler,i.onEnd=this._onInstanceEndHandler,t.positional?(i.position.copy(t.entity.getPosition()),i.maxDistance=t.maxDistance,i.refDistance=t.refDistance,i.rollOffFactor=t.rollOffFactor,i.distanceModel=t.distanceModel,e=new L_(this._manager,s,i)):e=new M_(this._manager,s,i),this._firstNode&&e.setExternalNodes(this._firstNode,this._lastNode),e}_onInstancePlay(e){this.fire("play",e),this._component.fire("play",this,e)}_onInstancePause(e){this.fire("pause",e),this._component.fire("pause",this,e)}_onInstanceResume(e){this.fire("resume",e),this._component.fire("resume",this,e)}_onInstanceStop(e){const t=this.instances.indexOf(e);-1!==t&&this.instances.splice(t,1),this.fire("stop",e),this._component.fire("stop",this,e)}_onInstanceEnd(e){const t=this.instances.indexOf(e);-1!==t&&this.instances.splice(t,1),this.fire("end",e),this._component.fire("end",this,e)}_onAssetAdd(e){this.load()}_onAssetLoad(e){this.load()}_onAssetRemoved(e){e.off("remove",this._onAssetRemoved,this),this._assets.off("add:"+e.id,this._onAssetAdd,this),this.stop()}updatePosition(e){const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].position=e}set asset(e){const t=this._asset;if(t){this._assets.off("add:"+t,this._onAssetAdd,this);const e=this._assets.get(t);e&&e.off("remove",this._onAssetRemoved,this)}this._asset=e,this._asset instanceof Yx&&(this._asset=this._asset.id),this._hasAsset()&&this._component.enabled&&this._component.entity.enabled&&this.load()}get asset(){return this._asset}set autoPlay(e){this._autoPlay=!!e}get autoPlay(){return this._autoPlay}set duration(e){if(this._duration=Math.max(0,Number(e)||0)||null,!this._overlap){const e=this.instances;for(let t=0,s=e.length;t<s;t++)e[t].duration=this._duration}}get duration(){let e=0;if(this._hasAsset()){const t=this._assets.get(this._asset);e=null!=t&&t.resource?t.resource.duration:0}return null!=this._duration?this._duration%(e||1):e}get isLoaded(){if(this._hasAsset()){const e=this._assets.get(this._asset);if(e)return!!e.resource}return!1}get isPaused(){const e=this.instances,t=e.length;if(0===t)return!1;for(let s=0;s<t;s++)if(!e[s].isPaused)return!1;return!0}get isPlaying(){const e=this.instances;for(let t=0,s=e.length;t<s;t++)if(e[t].isPlaying)return!0;return!1}get isStopped(){const e=this.instances;for(let t=0,s=e.length;t<s;t++)if(!e[t].isStopped)return!1;return!0}set loop(e){this._loop=!!e;const t=this.instances;for(let e=0,s=t.length;e<s;e++)t[e].loop=this._loop}get loop(){return this._loop}set overlap(e){this._overlap=!!e}get overlap(){return this._overlap}set pitch(e){if(this._pitch=Math.max(Number(e)||0,.01),!this._overlap){const e=this.instances;for(let t=0,s=e.length;t<s;t++)e[t].pitch=this.pitch*this._component.pitch}}get pitch(){return this._pitch}set startTime(e){if(this._startTime=Math.max(0,Number(e)||0),!this._overlap){const e=this.instances;for(let t=0,s=e.length;t<s;t++)e[t].startTime=this._startTime}}get startTime(){return this._startTime}set volume(e){if(this._volume=Wd.clamp(Number(e)||0,0,1),!this._overlap){const e=this.instances;for(let t=0,s=e.length;t<s;t++)e[t].volume=this._volume*this._component.volume}}get volume(){return this._volume}}uT.EVENT_PLAY="play",uT.EVENT_PAUSE="pause",uT.EVENT_RESUME="resume",uT.EVENT_STOP="stop",uT.EVENT_LOAD="load";class pT extends vw{constructor(e,t){super(e,t),this._volume=1,this._pitch=1,this._positional=!0,this._refDistance=1,this._maxDistance=1e4,this._rollOffFactor=1,this._distanceModel=Eu,this._slots={},this._playingBeforeDisable={}}_updateSoundInstances(e,t,s){const i=this._slots;for(const n in i){const r=i[n];if(!r.overlap){const i=r.instances;for(let n=0,a=i.length;n<a;n++)i[n][e]=s?r[e]*t:t}}}set distanceModel(e){this._distanceModel=e,this._updateSoundInstances("distanceModel",e,!1)}get distanceModel(){return this._distanceModel}set maxDistance(e){this._maxDistance=e,this._updateSoundInstances("maxDistance",e,!1)}get maxDistance(){return this._maxDistance}set refDistance(e){this._refDistance=e,this._updateSoundInstances("refDistance",e,!1)}get refDistance(){return this._refDistance}set rollOffFactor(e){this._rollOffFactor=e,this._updateSoundInstances("rollOffFactor",e,!1)}get rollOffFactor(){return this._rollOffFactor}set pitch(e){this._pitch=e,this._updateSoundInstances("pitch",e,!0)}get pitch(){return this._pitch}set volume(e){this._volume=e,this._updateSoundInstances("volume",e,!0)}get volume(){return this._volume}set positional(e){this._positional=e;const t=this._slots;for(const e in t){const s=t[e];if(!s.overlap){const e=s.instances;for(let t=e.length-1;t>=0;t--){const i=e[t].isPlaying||e[t].isSuspended,n=e[t].currentTime;i&&e[t].stop();const r=s._createInstance();i&&(r.play(),r.currentTime=n),e.push(r)}}}}get positional(){return this._positional}set slots(e){const t=this._slots;if(t)for(const e in t)t[e].stop();const s={};for(const t in e)e[t]instanceof uT?s[e[t].name]=e[t]:e[t].name&&(s[e[t].name]=new uT(this,e[t].name,e[t]));this._slots=s,this.enabled&&this.entity.enabled&&this.onEnable()}get slots(){return this._slots}onEnable(){if(this.system._inTools)return;const e=this._slots,t=this._playingBeforeDisable;for(const s in e){const i=e[s];i.autoPlay&&i.isStopped?i.play():t[s]?i.resume():i.isLoaded||i.load()}}onDisable(){const e=this._slots,t={};for(const s in e)e[s].overlap||e[s].isPlaying&&(e[s].pause(),t[s]=!0);this._playingBeforeDisable=t}onRemove(){this.off()}addSlot(e,t){const s=this._slots;if(s[e])return null;const i=new uT(this,e,t);return s[e]=i,i.autoPlay&&this.enabled&&this.entity.enabled&&i.play(),i}removeSlot(e){const t=this._slots;t[e]&&(t[e].stop(),delete t[e])}slot(e){return this._slots[e]}_getSlotProperty(e,t){if(!this.enabled||!this.entity.enabled)return;const s=this._slots[e];return s?s[t]:void 0}isPlaying(e){return this._getSlotProperty(e,"isPlaying")||!1}isLoaded(e){return this._getSlotProperty(e,"isLoaded")||!1}isPaused(e){return this._getSlotProperty(e,"isPaused")||!1}isStopped(e){return this._getSlotProperty(e,"isStopped")||!1}play(e){if(!this.enabled||!this.entity.enabled)return null;const t=this._slots[e];return t?t.play():null}pause(e){const t=this._slots;if(e){const s=t[e];if(!s)return;s.pause()}else for(const e in t)t[e].pause()}resume(e){const t=this._slots;if(e){const s=t[e];if(!s)return;s.isPaused&&s.resume()}else for(const e in t)t[e].resume()}stop(e){const t=this._slots;if(e){const s=t[e];if(!s)return;s.stop()}else for(const e in t)t[e].stop()}}pT.EVENT_PLAY="play",pT.EVENT_PAUSE="pause",pT.EVENT_RESUME="resume",pT.EVENT_STOP="stop",pT.EVENT_END="end";vw._buildAccessors(pT.prototype,["enabled"]);const mT="simple",_T="animated";class fT extends od{constructor(e,t){super(),this._component=e,this._frame=0,this._sprite=null,this._spriteAsset=null,this.spriteAsset=t.spriteAsset,this.name=t.name,this.fps=t.fps||0,this.loop=t.loop||!1,this._playing=!1,this._paused=!1,this._time=0}get duration(){if(this._sprite){const e=this.fps||Number.MIN_VALUE;return this._sprite.frameKeys.length/Math.abs(e)}return 0}set frame(e){this._setFrame(e);const t=this.fps||Number.MIN_VALUE;this._setTime(this._frame/t)}get frame(){return this._frame}get isPaused(){return this._paused}get isPlaying(){return this._playing}set sprite(e){if(this._sprite&&(this._sprite.off("set:meshes",this._onSpriteMeshesChange,this),this._sprite.off("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.off("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.off("set:texture",this._onSpriteMeshesChange,this)),this._sprite=e,this._sprite&&(this._sprite.on("set:meshes",this._onSpriteMeshesChange,this),this._sprite.on("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.on("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.on("set:texture",this._onSpriteMeshesChange,this)),this._component.currentClip===this){let t;e&&e.atlas?(e.atlas.texture&&(t=this._component._meshInstance,t&&(t.setParameter("texture_emissiveMap",e.atlas.texture),t.setParameter("texture_opacityMap",e.atlas.texture)),this._component.enabled&&this._component.entity.enabled&&this._component._showModel()),this.time&&this.fps?this.time=this.time:this.frame=this.frame):(t=this._component._meshInstance,t&&(t.deleteParameter("texture_emissiveMap"),t.deleteParameter("texture_opacityMap")),this._component._hideModel())}}get sprite(){return this._sprite}set spriteAsset(e){const t=this._component.system.app.assets;let s=e;if(e instanceof Yx&&(s=e.id),this._spriteAsset!==s){if(this._spriteAsset){const e=t.get(this._spriteAsset);e&&this._unbindSpriteAsset(e)}if(this._spriteAsset=s,this._spriteAsset){const e=t.get(this._spriteAsset);e?this._bindSpriteAsset(e):(this.sprite=null,t.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this))}else this.sprite=null}}get spriteAsset(){return this._spriteAsset}set time(e){this._setTime(e),this._sprite?this.frame=Math.min(this._sprite.frameKeys.length-1,Math.floor(this._time*Math.abs(this.fps))):this.frame=0}get time(){return this._time}_onSpriteAssetAdded(e){this._component.system.app.assets.off("add:"+e.id,this._onSpriteAssetAdded,this),this._spriteAsset===e.id&&this._bindSpriteAsset(e)}_bindSpriteAsset(e){e.on("load",this._onSpriteAssetLoad,this),e.on("remove",this._onSpriteAssetRemove,this),e.resource?this._onSpriteAssetLoad(e):this._component.system.app.assets.load(e)}_unbindSpriteAsset(e){e&&(e.off("load",this._onSpriteAssetLoad,this),e.off("remove",this._onSpriteAssetRemove,this),e.resource&&!e.resource.atlas&&this._component.system.app.assets.off("load:"+e.data.textureAtlasAsset,this._onTextureAtlasLoad,this))}_onSpriteAssetLoad(e){if(e.resource)if(e.resource.atlas)this.sprite=e.resource;else{const t=e.data.textureAtlasAsset,s=this._component.system.app.assets;s.off("load:"+t,this._onTextureAtlasLoad,this),s.once("load:"+t,this._onTextureAtlasLoad,this)}else this.sprite=null}_onTextureAtlasLoad(e){const t=this._spriteAsset;t instanceof Yx?this._onSpriteAssetLoad(t):this._onSpriteAssetLoad(this._component.system.app.assets.get(t))}_onSpriteAssetRemove(e){this.sprite=null}_onSpriteMeshesChange(){this._component.currentClip===this&&this._component._showFrame(this.frame)}_onSpritePpuChanged(){this._component.currentClip===this&&0!==this.sprite.renderMode&&this._component._showFrame(this.frame)}_update(e){if(0===this.fps)return;if(!this._playing||this._paused||!this._sprite)return;const t=this.fps<0?-1:1,s=this._time+e*this._component.speed*t,i=this.duration,n=s>i||s<0;this._setTime(s);let r=this.frame;r=this._sprite?Math.floor(this._sprite.frameKeys.length*this._time/i):0,r!==this._frame&&this._setFrame(r),n&&(this.loop?(this.fire("loop"),this._component.fire("loop",this)):(this._playing=!1,this._paused=!1,this.fire("end"),this._component.fire("end",this)))}_setTime(e){this._time=e;const t=this.duration;this._time<0?this.loop?this._time=this._time%t+t:this._time=0:this._time>t&&(this.loop?this._time%=t:this._time=t)}_setFrame(e){this._sprite?this._frame=Wd.clamp(e,0,this._sprite.frameKeys.length-1):this._frame=e,this._component.currentClip===this&&this._component._showFrame(this._frame)}_destroy(){if(this._spriteAsset){const e=this._component.system.app.assets;this._unbindSpriteAsset(e.get(this._spriteAsset))}this._sprite&&(this.sprite=null),this._spriteAsset&&(this.spriteAsset=null)}play(){this._playing||(this._playing=!0,this._paused=!1,this.frame=0,this.fire("play"),this._component.fire("play",this))}pause(){this._playing&&!this._paused&&(this._paused=!0,this.fire("pause"),this._component.fire("pause",this))}resume(){this._paused&&(this._paused=!1,this.fire("resume"),this._component.fire("resume",this))}stop(){this._playing&&(this._playing=!1,this._paused=!1,this._time=0,this.frame=0,this.fire("stop"),this._component.fire("stop",this))}}fT.EVENT_PLAY="play",fT.EVENT_PAUSE="pause",fT.EVENT_RESUME="resume",fT.EVENT_STOP="stop",fT.EVENT_END="end",fT.EVENT_LOOP="loop";const gT="texture_emissiveMap",vT="texture_opacityMap",yT="material_emissive",bT="material_opacity";class xT extends vw{constructor(e,t){super(e,t),this._type=mT,this._material=e.defaultMaterial,this._color=new jd(1,1,1,1),this._colorUniform=new Float32Array(3),this._speed=1,this._flipX=!1,this._flipY=!1,this._width=1,this._height=1,this._drawOrder=0,this._layers=[0],this._outerScale=new au(1,1),this._outerScaleUniform=new Float32Array(2),this._innerOffset=new ou,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new ou,this._atlasRectUniform=new Float32Array(4),this._batchGroupId=-1,this._batchGroup=null,this._node=new Kf,this._model=new ub,this._model.graph=this._node,this._meshInstance=null,t.addChild(this._model.graph),this._model._entity=t,this._updateAabbFunc=this._updateAabb.bind(this),this._addedModel=!1,this._autoPlayClip=null,this._clips={},this._defaultClip=new fT(this,{name:this.entity.name,fps:0,loop:!1,spriteAsset:null}),this._currentClip=this._defaultClip}set type(e){this._type!==e&&(this._type=e,this._type===mT?(this.stop(),this._currentClip=this._defaultClip,this.enabled&&this.entity.enabled&&(this._currentClip.frame=this.frame,this._currentClip.sprite?this._showModel():this._hideModel())):this._type===_T&&(this.stop(),this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.isPlaying&&this.enabled&&this.entity.enabled?this._showModel():this._hideModel()))}get type(){return this._type}set frame(e){this._currentClip.frame=e}get frame(){return this._currentClip.frame}set spriteAsset(e){this._defaultClip.spriteAsset=e}get spriteAsset(){return this._defaultClip._spriteAsset}set sprite(e){this._currentClip.sprite=e}get sprite(){return this._currentClip.sprite}set material(e){this._material=e,this._meshInstance&&(this._meshInstance.material=e)}get material(){return this._material}set color(e){this._color.r=e.r,this._color.g=e.g,this._color.b=e.b,this._meshInstance&&(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter(yT,this._colorUniform))}get color(){return this._color}set opacity(e){this._color.a=e,this._meshInstance&&this._meshInstance.setParameter(bT,e)}get opacity(){return this._color.a}set clips(e){if(e){for(const t in this._clips){let s=!1;for(const i in e)if(e[i].name===t){s=!0,this._clips[t].fps=e[i].fps,this._clips[t].loop=e[i].loop,e[i].hasOwnProperty("sprite")?this._clips[t].sprite=e[i].sprite:e[i].hasOwnProperty("spriteAsset")&&(this._clips[t].spriteAsset=e[i].spriteAsset);break}s||this.removeClip(t)}for(const t in e)this._clips[e[t].name]||this.addClip(e[t]);this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.sprite||this._hideModel()}else for(const e in this._clips)this.removeClip(e)}get clips(){return this._clips}get currentClip(){return this._currentClip}set speed(e){this._speed=e}get speed(){return this._speed}set flipX(e){this._flipX!==e&&(this._flipX=e,this._updateTransform())}get flipX(){return this._flipX}set flipY(e){this._flipY!==e&&(this._flipY=e,this._updateTransform())}get flipY(){return this._flipY}set width(e){e!==this._width&&(this._width=e,this._outerScale.x=this._width,!this.sprite||2!==this.sprite.renderMode&&1!==this.sprite.renderMode||this._updateTransform())}get width(){return this._width}set height(e){e!==this._height&&(this._height=e,this._outerScale.y=this.height,!this.sprite||2!==this.sprite.renderMode&&1!==this.sprite.renderMode||this._updateTransform())}get height(){return this._height}set batchGroupId(e){if(this._batchGroupId===e)return;const t=this._batchGroupId;var s,i;(this._batchGroupId=e,this.entity.enabled&&t>=0)&&(null==(s=this.system.app.batcher)||s.remove(Ef.SPRITE,t,this.entity));this.entity.enabled&&e>=0?null==(i=this.system.app.batcher)||i.insert(Ef.SPRITE,e,this.entity):t>=0&&this._currentClip&&this._currentClip.sprite&&this.enabled&&this.entity.enabled&&this._showModel()}get batchGroupId(){return this._batchGroupId}set autoPlayClip(e){this._autoPlayClip=e instanceof fT?e.name:e,this._tryAutoPlay()}get autoPlayClip(){return this._autoPlayClip}set drawOrder(e){this._drawOrder=e,this._meshInstance&&(this._meshInstance.drawOrder=e)}get drawOrder(){return this._drawOrder}set layers(e){this._addedModel&&this._hideModel(),this._layers=e,this._meshInstance&&this.enabled&&this.entity.enabled&&this._showModel()}get layers(){return this._layers}get aabb(){return this._meshInstance?this._meshInstance.aabb:null}onEnable(){const e=this.system.app,t=e.scene;var s;(t.on("set:layers",this._onLayersChanged,this),t.layers&&(t.layers.on("add",this._onLayerAdded,this),t.layers.on("remove",this._onLayerRemoved,this)),this._showModel(),this._autoPlayClip&&this._tryAutoPlay(),this._batchGroupId>=0)&&(null==(s=e.batcher)||s.insert(Ef.SPRITE,this._batchGroupId,this.entity))}onDisable(){const e=this.system.app,t=e.scene;var s;(t.off("set:layers",this._onLayersChanged,this),t.layers&&(t.layers.off("add",this._onLayerAdded,this),t.layers.off("remove",this._onLayerRemoved,this)),this.stop(),this._hideModel(),this._batchGroupId>=0)&&(null==(s=e.batcher)||s.remove(Ef.SPRITE,this._batchGroupId,this.entity))}onDestroy(){var e;this._currentClip=null,this._defaultClip&&(this._defaultClip._destroy(),this._defaultClip=null);for(const e in this._clips)this._clips[e]._destroy();this._clips=null,this._hideModel(),this._model=null,null==(e=this._node)||e.remove(),this._node=null,this._meshInstance&&(this._meshInstance.material=null,this._meshInstance.mesh=null,this._meshInstance=null)}_showModel(){if(this._addedModel)return;if(!this._meshInstance)return;const e=[this._meshInstance];for(let t=0,s=this._layers.length;t<s;t++){const s=this.system.app.scene.layers.getLayerById(this._layers[t]);s&&s.addMeshInstances(e)}this._addedModel=!0}_hideModel(){if(!this._addedModel||!this._meshInstance)return;const e=[this._meshInstance];for(let t=0,s=this._layers.length;t<s;t++){const s=this.system.app.scene.layers.getLayerById(this._layers[t]);s&&s.removeMeshInstances(e)}this._addedModel=!1}_showFrame(e){if(!this.sprite)return;const t=this.sprite.meshes[e];if(!t)return void(this._meshInstance&&(this._meshInstance.mesh=null,this._meshInstance.visible=!1));let s;if(s=1===this.sprite.renderMode?this.system.default9SlicedMaterialSlicedMode:2===this.sprite.renderMode?this.system.default9SlicedMaterialTiledMode:this.system.defaultMaterial,this._meshInstance||(this._meshInstance=new ig(t,this._material,this._node),this._meshInstance.castShadow=!1,this._meshInstance.receiveShadow=!1,this._meshInstance.drawOrder=this._drawOrder,this._model.meshInstances.push(this._meshInstance),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter(yT,this._colorUniform),this._meshInstance.setParameter(bT,this._color.a),this.enabled&&this.entity.enabled&&this._showModel()),this._meshInstance.material!==s&&(this._meshInstance.material=s),this._meshInstance.mesh!==t&&(this._meshInstance.mesh=t,this._meshInstance.visible=!0,this._meshInstance._aabbVer=-1),this.sprite.atlas&&this.sprite.atlas.texture?(this._meshInstance.setParameter(gT,this.sprite.atlas.texture),this._meshInstance.setParameter(vT,this.sprite.atlas.texture)):(this._meshInstance.deleteParameter(gT),this._meshInstance.deleteParameter(vT)),!this.sprite.atlas||1!==this.sprite.renderMode&&2!==this.sprite.renderMode)this._meshInstance._updateAabbFunc=null;else{this._meshInstance._updateAabbFunc=this._updateAabbFunc;const t=this.sprite.atlas.frames[this.sprite.frameKeys[e]];if(t){const e=2/t.rect.z,s=2/t.rect.w;this._innerOffset.set(t.border.x*e,t.border.y*s,t.border.z*e,t.border.w*s);const i=this.sprite.atlas.texture;this._atlasRect.set(t.rect.x/i.width,t.rect.y/i.height,t.rect.z/i.width,t.rect.w/i.height)}else this._innerOffset.set(0,0,0,0);this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._meshInstance.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._meshInstance.setParameter("atlasRect",this._atlasRectUniform)}this._updateTransform()}_updateTransform(){let e=this.flipX?-1:1,t=this.flipY?-1:1,s=0,i=0;if(this.sprite&&(1===this.sprite.renderMode||2===this.sprite.renderMode)){let n=1,r=1;if(this.sprite.atlas){const e=this.sprite.atlas.frames[this.sprite.frameKeys[this.frame]];e&&(n=e.rect.z,r=e.rect.w,s=(.5-e.pivot.x)*this._width,i=(.5-e.pivot.y)*this._height)}const a=n/this.sprite.pixelsPerUnit,o=r/this.sprite.pixelsPerUnit;this._outerScale.set(Math.max(this._width,this._innerOffset.x*a),Math.max(this._height,this._innerOffset.y*o)),e*=a,t*=o,this._outerScale.x/=a,this._outerScale.y/=o,e*=Wd.clamp(this._width/(this._innerOffset.x*a),1e-4,1),t*=Wd.clamp(this._height/(this._innerOffset.y*o),1e-4,1),this._meshInstance&&(this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._meshInstance.setParameter("outerScale",this._outerScaleUniform))}this._node.setLocalScale(e,t,1),this._node.setLocalPosition(s,i,0)}_updateAabb(e){return e.center.set(0,0,0),e.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001),e.setFromTransformedAabb(e,this._node.getWorldTransform()),e}_tryAutoPlay(){if(!this._autoPlayClip)return;if(this.type!==_T)return;const e=this._clips[this._autoPlayClip];!e||e.isPlaying||this._currentClip&&this._currentClip.isPlaying||this.enabled&&this.entity.enabled&&this.play(e.name)}_onLayersChanged(e,t){e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this),this.enabled&&this.entity.enabled&&this._showModel()}_onLayerAdded(e){this.layers.indexOf(e.id)<0||this._addedModel&&this.enabled&&this.entity.enabled&&this._meshInstance&&e.addMeshInstances([this._meshInstance])}_onLayerRemoved(e){if(!this._meshInstance)return;this.layers.indexOf(e.id)<0||e.removeMeshInstances([this._meshInstance])}removeModelFromLayers(){for(let e=0;e<this.layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&t.removeMeshInstances([this._meshInstance])}}addClip(e){const t=new fT(this,{name:e.name,fps:e.fps,loop:e.loop,spriteAsset:e.spriteAsset});return this._clips[e.name]=t,t.name&&t.name===this._autoPlayClip&&this._tryAutoPlay(),t}removeClip(e){delete this._clips[e]}clip(e){return this._clips[e]}play(e){const t=this._clips[e],s=this._currentClip;return s&&s!==t&&(s._playing=!1),this._currentClip=t,this._currentClip&&(this._currentClip=t,this._currentClip.play()),t}pause(){this._currentClip!==this._defaultClip&&this._currentClip.isPlaying&&this._currentClip.pause()}resume(){this._currentClip!==this._defaultClip&&this._currentClip.isPaused&&this._currentClip.resume()}stop(){this._currentClip!==this._defaultClip&&this._currentClip.stop()}}xT.EVENT_PLAY="play",xT.EVENT_PAUSE="pause",xT.EVENT_RESUME="resume",xT.EVENT_STOP="stop",xT.EVENT_END="end",xT.EVENT_LOOP="loop";vw._buildAccessors(xT.prototype,["enabled"]);class wT extends vw{constructor(e,t){super(e,t),this._oldState=!0,this._size=new nu,this.on("set_enabled",this._onSetEnabled,this)}set size(e){e instanceof nu?this._size.copy(e):e instanceof Array&&e.length>=3&&this.size.set(e[0],e[1],e[2])}get size(){return this._size}onEnable(){this._checkState()}onDisable(){this._checkState()}_onSetEnabled(e,t,s){this._checkState()}_checkState(){const e=this.enabled&&this.entity.enabled;e!==this._oldState&&(this._oldState=e,this.fire("enable"),this.fire("state",this.enabled))}_onBeforeRemove(){this.fire("remove")}}wT.EVENT_ENABLE="enable",wT.EVENT_DISABLE="disable",wT.EVENT_STATE="state",wT.EVENT_REMOVE="remove";vw._buildAccessors(wT.prototype,["enabled"]);class ST{constructor(e,t){this.effect=e,this.inputTarget=t,this.outputTarget=null,this.name=e.constructor.name}}class CT{constructor(e,t){this.app=e,this.camera=t,this.destinationRenderTarget=null,this.effects=[],this.enabled=!1,this.depthTarget=null,t.on("set:rect",this.onCameraRectChanged,this)}_allocateColorBuffer(e,t){var s,i;const n=this.camera.rect,r=this.destinationRenderTarget,a=this.app.graphicsDevice,o=Math.floor(n.z*(null!=(s=null==r?void 0:r.width)?s:a.width)),l=Math.floor(n.w*(null!=(i=null==r?void 0:r.height)?i:a.height));return new bm(a,{name:t,format:e,width:o,height:l,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1})}_createOffscreenTarget(e,t){const s=this.app.graphicsDevice,i=t&&s.getRenderableHdrFormat([Lu,Du],!0)||7,n=this.camera.entity.name+"-posteffect-"+this.effects.length,r=this._allocateColorBuffer(i,n);return new qp({colorBuffer:r,depth:e,stencil:e&&this.app.graphicsDevice.supportsStencil,samples:e?s.samples:1})}_resizeOffscreenTarget(e){const t=e.colorBuffer.format,s=e.colorBuffer.name;e.destroyFrameBuffers(),e.destroyTextureBuffers(),e._colorBuffer=this._allocateColorBuffer(t,s),e._colorBuffers=[e._colorBuffer]}_destroyOffscreenTarget(e){e.destroyTextureBuffers(),e.destroy()}addEffect(e){const t=this.effects,s=0===t.length,i=this._createOffscreenTarget(s,e.hdr),n=new ST(e,i);t.push(n),this._sourceTarget=n.inputTarget,t.length>1&&(t[t.length-2].outputTarget=n.inputTarget),this._newPostEffect=e,e.needsDepthBuffer&&this._requestDepthMap(),this.enable(),this._newPostEffect=void 0}removeEffect(e){let t=-1;for(let s=0,i=this.effects.length;s<i;s++)if(this.effects[s].effect===e){t=s;break}t>=0&&(t>0?this.effects[t-1].outputTarget=t+1<this.effects.length?this.effects[t+1].inputTarget:null:this.effects.length>1&&(this.effects[1].inputTarget._depth||(this._destroyOffscreenTarget(this.effects[1].inputTarget),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr),this._sourceTarget=this.effects[1].inputTarget),this.camera.renderTarget=this.effects[1].inputTarget),this._destroyOffscreenTarget(this.effects[t].inputTarget),this.effects.splice(t,1)),this.enabled&&e.needsDepthBuffer&&this._releaseDepthMap(),0===this.effects.length&&this.disable()}_requestDepthMaps(){for(let e=0,t=this.effects.length;e<t;e++){const t=this.effects[e].effect;this._newPostEffect!==t&&(t.needsDepthBuffer&&this._requestDepthMap())}}_releaseDepthMaps(){for(let e=0,t=this.effects.length;e<t;e++){this.effects[e].effect.needsDepthBuffer&&this._releaseDepthMap()}}_requestDepthMap(){const e=this.app.scene.layers.getLayerById(1);e&&(e.incrementCounter(),this.camera.requestSceneDepthMap(!0))}_releaseDepthMap(){const e=this.app.scene.layers.getLayerById(1);e&&(e.decrementCounter(),this.camera.requestSceneDepthMap(!1))}destroy(){for(let e=0,t=this.effects.length;e<t;e++)this.effects[e].inputTarget.destroy();this.effects.length=0,this.disable()}enable(){!this.enabled&&this.effects.length&&(this.enabled=!0,this._requestDepthMaps(),this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this),this.destinationRenderTarget=this.camera.renderTarget,this.camera.renderTarget=this.effects[0].inputTarget,this.camera.onPostprocessing=()=>{if(this.enabled){let e=null;const t=this.effects.length;if(t)for(let s=0;s<t;s++){const i=this.effects[s];let n=i.outputTarget;s===t-1&&(e=this.camera.rect,this.destinationRenderTarget&&(n=this.destinationRenderTarget)),i.effect.render(i.inputTarget,n,e)}}})}disable(){this.enabled&&(this.enabled=!1,this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this),this._releaseDepthMaps(),this._destroyOffscreenTarget(this._sourceTarget),this.camera.renderTarget=null,this.camera.onPostprocessing=null)}_onCanvasResized(e,t){var s,i;const n=this.camera.rect,r=this.destinationRenderTarget;e=null!=(s=null==r?void 0:r.width)?s:e,t=null!=(i=null==r?void 0:r.height)?i:t,this.camera.camera.aspectRatio=e*n.z/(t*n.w),this.resizeRenderTargets()}resizeRenderTargets(){var e,t;const s=this.app.graphicsDevice,i=this.destinationRenderTarget,n=null!=(e=null==i?void 0:i.width)?e:s.width,r=null!=(t=null==i?void 0:i.height)?t:s.height,a=this.camera.rect,o=Math.floor(a.z*n),l=Math.floor(a.w*r),h=this.effects;for(let e=0,t=h.length;e<t;e++){const t=h[e];t.inputTarget.width===o&&t.inputTarget.height===l||this._resizeOffscreenTarget(t.inputTarget)}}onCameraRectChanged(e,t,s){this.enabled&&this.resizeRenderTargets()}}class TT extends vw{constructor(e,t){super(e,t),this.onPostprocessing=null,this.onPreRender=null,this.onPostRender=null,this._renderSceneDepthMap=0,this._renderSceneColorMap=0,this._sceneDepthMapRequested=!1,this._sceneColorMapRequested=!1,this._priority=0,this._disablePostEffectsLayer=4,this._camera=new vg,this._camera.node=t,this._postEffects=new CT(e.app,this)}setShaderPass(e){const t=yf.get(this.system.app.graphicsDevice),s=e?t.allocate(e,{isForward:!0}):null;return this._camera.shaderPassInfo=s,s.index}getShaderPass(){var e;return null==(e=this._camera.shaderPassInfo)?void 0:e.name}set renderPasses(e){this._camera.renderPasses=e}get renderPasses(){return this._camera.renderPasses}set aperture(e){this._camera.aperture=e}get aperture(){return this._camera.aperture}set aspectRatio(e){this._camera.aspectRatio=e}get aspectRatio(){return this._camera.aspectRatio}set aspectRatioMode(e){this._camera.aspectRatioMode=e}get aspectRatioMode(){return this._camera.aspectRatioMode}set calculateProjection(e){this._camera.calculateProjection=e}get calculateProjection(){return this._camera.calculateProjection}set calculateTransform(e){this._camera.calculateTransform=e}get calculateTransform(){return this._camera.calculateTransform}get camera(){return this._camera}set clearColor(e){this._camera.clearColor=e}get clearColor(){return this._camera.clearColor}set clearColorBuffer(e){this._camera.clearColorBuffer=e,this.dirtyLayerCompositionCameras()}get clearColorBuffer(){return this._camera.clearColorBuffer}set clearDepthBuffer(e){this._camera.clearDepthBuffer=e,this.dirtyLayerCompositionCameras()}get clearDepthBuffer(){return this._camera.clearDepthBuffer}set clearStencilBuffer(e){this._camera.clearStencilBuffer=e,this.dirtyLayerCompositionCameras()}get clearStencilBuffer(){return this._camera.clearStencilBuffer}set cullFaces(e){this._camera.cullFaces=e}get cullFaces(){return this._camera.cullFaces}set disablePostEffectsLayer(e){this._disablePostEffectsLayer=e,this.dirtyLayerCompositionCameras()}get disablePostEffectsLayer(){return this._disablePostEffectsLayer}set farClip(e){this._camera.farClip=e}get farClip(){return this._camera.farClip}set flipFaces(e){this._camera.flipFaces=e}get flipFaces(){return this._camera.flipFaces}set fov(e){this._camera.fov=e}get fov(){return this._camera.fov}get frustum(){return this._camera.frustum}set frustumCulling(e){this._camera.frustumCulling=e}get frustumCulling(){return this._camera.frustumCulling}set horizontalFov(e){this._camera.horizontalFov=e}get horizontalFov(){return this._camera.horizontalFov}set layers(e){const t=this._camera.layers;for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);s&&s.removeCamera(this)}if(this._camera.layers=e,this.enabled&&this.entity.enabled)for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.addCamera(this)}}get layers(){return this._camera.layers}get layersSet(){return this._camera.layersSet}set jitter(e){this._camera.jitter=e}get jitter(){return this._camera.jitter}set nearClip(e){this._camera.nearClip=e}get nearClip(){return this._camera.nearClip}set orthoHeight(e){this._camera.orthoHeight=e}get orthoHeight(){return this._camera.orthoHeight}get postEffects(){return this._postEffects}get postEffectsEnabled(){return this._postEffects.enabled}set priority(e){this._priority=e,this.dirtyLayerCompositionCameras()}get priority(){return this._priority}set projection(e){this._camera.projection=e}get projection(){return this._camera.projection}get projectionMatrix(){return this._camera.projectionMatrix}set rect(e){this._camera.rect=e,this.fire("set:rect",this._camera.rect)}get rect(){return this._camera.rect}set renderSceneColorMap(e){e&&!this._sceneColorMapRequested?(this.requestSceneColorMap(!0),this._sceneColorMapRequested=!0):this._sceneColorMapRequested&&(this.requestSceneColorMap(!1),this._sceneColorMapRequested=!1)}get renderSceneColorMap(){return this._renderSceneColorMap>0}set renderSceneDepthMap(e){e&&!this._sceneDepthMapRequested?(this.requestSceneDepthMap(!0),this._sceneDepthMapRequested=!0):this._sceneDepthMapRequested&&(this.requestSceneDepthMap(!1),this._sceneDepthMapRequested=!1)}get renderSceneDepthMap(){return this._renderSceneDepthMap>0}set renderTarget(e){this._camera.renderTarget=e,this.dirtyLayerCompositionCameras()}get renderTarget(){return this._camera.renderTarget}set scissorRect(e){this._camera.scissorRect=e}get scissorRect(){return this._camera.scissorRect}set sensitivity(e){this._camera.sensitivity=e}get sensitivity(){return this._camera.sensitivity}set shutter(e){this._camera.shutter=e}get shutter(){return this._camera.shutter}get viewMatrix(){return this._camera.viewMatrix}_enableDepthLayer(e){if(this.layers.find((e=>1===e))){const t=this.system.app.scene.layers.getLayerById(1);e?null==t||t.incrementCounter():null==t||t.decrementCounter()}else if(e)return!1;return!0}requestSceneColorMap(e){this._renderSceneColorMap+=e?1:-1,this._enableDepthLayer(e),this.camera._enableRenderPassColorGrab(this.system.app.graphicsDevice,this.renderSceneColorMap)}requestSceneDepthMap(e){this._renderSceneDepthMap+=e?1:-1,this._enableDepthLayer(e),this.camera._enableRenderPassDepthGrab(this.system.app.graphicsDevice,this.system.app.renderer,this.renderSceneDepthMap)}dirtyLayerCompositionCameras(){this.system.app.scene.layers._dirty=!0}screenToWorld(e,t,s,i){const n=this.system.app.graphicsDevice,r=n.clientRect.width,a=n.clientRect.height;return this._camera.screenToWorld(e,t,s,r,a,i)}worldToScreen(e,t){const s=this.system.app.graphicsDevice,i=s.clientRect.width,n=s.clientRect.height;return this._camera.worldToScreen(e,i,n,t)}onAppPrerender(){this._camera._viewMatDirty=!0,this._camera._viewProjMatDirty=!0}addCameraToLayers(){const e=this.layers;for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.addCamera(this)}}removeCameraFromLayers(){const e=this.layers;for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.removeCamera(this)}}onLayersChanged(e,t){this.addCameraToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||e.addCamera(this)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||e.removeCamera(this)}onEnable(){const e=this.system,t=e.app.scene,s=t.layers;e.addCamera(this),t.on("set:layers",this.onLayersChanged,this),s&&(s.on("add",this.onLayerAdded,this),s.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addCameraToLayers(),this.postEffects.enable()}onDisable(){const e=this.system,t=e.app.scene,s=t.layers;this.postEffects.disable(),this.removeCameraFromLayers(),t.off("set:layers",this.onLayersChanged,this),s&&(s.off("add",this.onLayerAdded,this),s.off("remove",this.onLayerRemoved,this)),e.removeCamera(this)}onRemove(){this.onDisable(),this.off(),this.camera.destroy()}calculateAspectRatio(e){const t=this.system.app.graphicsDevice,s=e?e.width:t.width,i=e?e.height:t.height;return s*this.rect.z/(i*this.rect.w)}frameUpdate(e){0===this.aspectRatioMode&&(this.aspectRatio=this.calculateAspectRatio(e))}startXr(e,t,s){this.system.app.xr.start(this,e,t,s)}endXr(e){this._camera.xr?this._camera.xr.end(e):e&&e(new Error("Camera is not in XR"))}copy(e){this.aperture=e.aperture,this.aspectRatio=e.aspectRatio,this.aspectRatioMode=e.aspectRatioMode,this.calculateProjection=e.calculateProjection,this.calculateTransform=e.calculateTransform,this.clearColor=e.clearColor,this.clearColorBuffer=e.clearColorBuffer,this.clearDepthBuffer=e.clearDepthBuffer,this.clearStencilBuffer=e.clearStencilBuffer,this.cullFaces=e.cullFaces,this.disablePostEffectsLayer=e.disablePostEffectsLayer,this.farClip=e.farClip,this.flipFaces=e.flipFaces,this.fov=e.fov,this.frustumCulling=e.frustumCulling,this.horizontalFov=e.horizontalFov,this.layers=e.layers,this.nearClip=e.nearClip,this.orthoHeight=e.orthoHeight,this.priority=e.priority,this.projection=e.projection,this.rect=e.rect,this.renderTarget=e.renderTarget,this.scissorRect=e.scissorRect,this.sensitivity=e.sensitivity,this.shutter=e.shutter}}vw._buildAccessors(TT.prototype,["enabled"]),new jd(1,1,1);const AT=["x","y","z","w"],ET=[void 0,void 0,au,nu,ou];function PT(e,t,s,i){switch(t.type){case"boolean":return!!s;case"number":if("number"==typeof s)return s;if("string"==typeof s){const e=parseInt(s,10);return isNaN(e)?null:e}return"boolean"==typeof s?0+s:null;case"json":{const i={};if(Array.isArray(t.schema)){s&&"object"==typeof s||(s={});for(let n=0;n<t.schema.length;n++){const r=t.schema[n];if(r.name)if(r.array){i[r.name]=[];const t=Array.isArray(s[r.name])?s[r.name]:[];for(let s=0;s<t.length;s++)i[r.name].push(PT(e,r,t[s]))}else{const t=s.hasOwnProperty(r.name)?s[r.name]:r.default;i[r.name]=PT(e,r,t)}}}return i}case"asset":return s instanceof Yx?s:"number"==typeof s?e.assets.get(s)||null:"string"==typeof s&&e.assets.get(parseInt(s,10))||null;case"entity":return s instanceof Kf?s:"string"==typeof s?e.getEntityFromIndex(s):null;case"rgb":case"rgba":if(s instanceof jd)return i instanceof jd?(i.copy(s),i):s.clone();if(s instanceof Array&&s.length>=3&&s.length<=4){for(let e=0;e<s.length;e++)if("number"!=typeof s[e])return null;return i||(i=new jd),i.r=s[0],i.g=s[1],i.b=s[2],i.a=3===s.length?1:s[3],i}return"string"==typeof s&&/#([0-9abcdef]{2}){3,4}/i.test(s)?(i||(i=new jd),i.fromString(s),i):null;case"vec2":case"vec3":case"vec4":{const e=parseInt(t.type.slice(3),10),n=ET[e];if(s instanceof n)return i instanceof n?(i.copy(s),i):s.clone();if(s instanceof Array&&s.length===e){for(let e=0;e<s.length;e++)if("number"!=typeof s[e])return null;i||(i=new n);for(let t=0;t<e;t++)i[AT[t]]=s[t];return i}return null}case"curve":if(s){let e;if(s instanceof Kd||s instanceof Xd)e=s.clone();else{e=new(s.keys[0]instanceof Array?Xd:Kd)(s.keys),e.type=s.type}return e}}return s}class MT{constructor(e){this.scriptType=e,this.index={}}add(e,t){this.index[e]||MT.reservedNames.has(e)||(this.index[e]=t,Object.defineProperty(this.scriptType.prototype,e,{get:function(){return this.__attributes[e]},set:function(s){const i="attr",n="attr:"+e,r=this.__attributes[e];let a=r;if(r&&"json"!==t.type&&"entity"!==t.type&&r.clone&&(this.hasEvent(i)||this.hasEvent(n))&&(a=r.clone()),t.array){if(this.__attributes[e]=[],s)for(let i=0,n=s.length;i<n;i++)this.__attributes[e].push(PT(this.app,t,s[i],r?r[i]:null))}else this.__attributes[e]=PT(this.app,t,s,r);this.fire(i,e,this.__attributes[e],a),this.fire(n,this.__attributes[e],a)}}))}remove(e){return!!this.index[e]&&(delete this.index[e],delete this.scriptType.prototype[e],!0)}has(e){return!!this.index[e]}get(e){return this.index[e]||null}}MT.reservedNames=new Set(["app","entity","enabled","_enabled","_enabledOld","_destroyed","__attributes","__attributesRaw","__scriptType","__executionOrder","_callbacks","_callbackActive","has","get","on","off","fire","once","hasEvent"]);const LT="initialize",DT="postInitialize";class kT extends vw{constructor(e,t){super(e,t),this._scripts=[],this._updateList=new Vd({sortBy:"__executionOrder"}),this._postUpdateList=new Vd({sortBy:"__executionOrder"}),this._scriptsIndex={},this._destroyedScripts=[],this._destroyed=!1,this._scriptsData=null,this._oldState=!0,this._enabled=!0,this._beingEnabled=!1,this._isLoopingThroughScripts=!1,this._executionOrder=-1,this.on("set_enabled",this._onSetEnabled,this)}set scripts(e){this._scriptsData=e;for(const t in e){if(!e.hasOwnProperty(t))continue;const s=this._scriptsIndex[t];if(s){if("boolean"==typeof e[t].enabled&&(s.enabled=!!e[t].enabled),"object"==typeof e[t].attributes)for(const i in e[t].attributes)if(!MT.reservedNames.has(i)){if(!s.__attributes.hasOwnProperty(i)){const e=this.system.app.scripts.get(t);e&&e.attributes.add(i,{})}s[i]=e[t].attributes[i]}}else console.log(this.order)}}get scripts(){return this._scripts}set enabled(e){const t=this._enabled;this._enabled=e,this.fire("set","enabled",t,e)}get enabled(){return this._enabled}onEnable(){this._beingEnabled=!0,this._checkState(),this.entity._beingEnabled||this.onPostStateChange(),this._beingEnabled=!1}onDisable(){this._checkState()}onPostStateChange(){const e=this._beginLooping();for(let e=0,t=this.scripts.length;e<t;e++){const t=this.scripts[e];t._initialized&&!t._postInitialized&&t.enabled&&(t._postInitialized=!0,t.postInitialize&&this._scriptMethod(t,DT))}this._endLooping(e)}_beginLooping(){const e=this._isLoopingThroughScripts;return this._isLoopingThroughScripts=!0,e}_endLooping(e){this._isLoopingThroughScripts=e,this._isLoopingThroughScripts||this._removeDestroyedScripts()}_onSetEnabled(e,t,s){this._beingEnabled=!0,this._checkState(),this._beingEnabled=!1}_checkState(){const e=this.enabled&&this.entity.enabled;if(e===this._oldState)return;this._oldState=e,this.fire(e?"enable":"disable"),this.fire("state",e),e?this.system._addComponentToEnabled(this):this.system._removeComponentFromEnabled(this);const t=this._beginLooping();for(let e=0,t=this.scripts.length;e<t;e++){const t=this.scripts[e];t.enabled=t._enabled}this._endLooping(t)}_onBeforeRemove(){this.fire("remove");const e=this._beginLooping();for(let e=0;e<this.scripts.length;e++){const t=this.scripts[e];t&&this.destroy(t.__scriptType.__name)}this._endLooping(e)}_removeDestroyedScripts(){const e=this._destroyedScripts.length;if(e){for(let t=0;t<e;t++){const e=this._destroyedScripts[t];this._removeScriptInstance(e)}this._destroyedScripts.length=0,this._resetExecutionOrder(0,this._scripts.length)}}_onInitializeAttributes(){for(let e=0,t=this.scripts.length;e<t;e++)this.scripts[e].__initializeAttributes()}_scriptMethod(e,t,s){e[t](s)}_onInitialize(){const e=this._scripts,t=this._beginLooping();for(let t=0,s=e.length;t<s;t++){const s=e[t];!s._initialized&&s.enabled&&(s._initialized=!0,s.initialize&&this._scriptMethod(s,LT))}this._endLooping(t)}_onPostInitialize(){this.onPostStateChange()}_onUpdate(e){const t=this._updateList;if(!t.length)return;const s=this._beginLooping();for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){const s=t.items[t.loopIndex];s.enabled&&this._scriptMethod(s,"update",e)}this._endLooping(s)}_onPostUpdate(e){const t=this._postUpdateList;if(!t.length)return;const s=this._beginLooping();for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){const s=t.items[t.loopIndex];s.enabled&&this._scriptMethod(s,"postUpdate",e)}this._endLooping(s)}_insertScriptInstance(e,t,s){-1===t?(this._scripts.push(e),e.__executionOrder=s,e.update&&this._updateList.append(e),e.postUpdate&&this._postUpdateList.append(e)):(this._scripts.splice(t,0,e),e.__executionOrder=t,this._resetExecutionOrder(t+1,s+1),e.update&&this._updateList.insert(e),e.postUpdate&&this._postUpdateList.insert(e))}_removeScriptInstance(e){const t=this._scripts.indexOf(e);return-1===t||(this._scripts.splice(t,1),e.update&&this._updateList.remove(e),e.postUpdate&&this._postUpdateList.remove(e)),t}_resetExecutionOrder(e,t){for(let s=e;s<t;s++)this._scripts[s].__executionOrder=s}_resolveEntityScriptAttribute(e,t,s,i,n,r){if(e.array){const e=s.length;if(!e)return;const a=s.slice();for(let t=0;t<e;t++){const e=a[t]instanceof hw?a[t].getGuid():a[t];r[e]&&(a[t]=i?r[e].getGuid():r[e])}n[t]=a}else{if(s instanceof hw)s=s.getGuid();else if("string"!=typeof s)return;r[s]&&(n[t]=r[s])}}has(e){if("string"==typeof e)return!!this._scriptsIndex[e];if(!e)return!1;const t=e,s=t.__name,i=this._scriptsIndex[s];return(i&&i.instance)instanceof t}get(e){if("string"==typeof e){const t=this._scriptsIndex[e];return t?t.instance:null}if(!e)return null;const t=e,s=t.__name,i=this._scriptsIndex[s],n=i&&i.instance;return n instanceof t?n:null}create(e,t={}){const s=this;let i=e,n=e;if("string"==typeof i?i=this.system.app.scripts.get(i):i&&(n=i.__name),i){if(!this._scriptsIndex[n]||!this._scriptsIndex[n].instance){const e=new i({app:this.system.app,entity:this.entity,enabled:!t.hasOwnProperty("enabled")||t.enabled,attributes:t.attributes}),r=this._scripts.length;let a=-1;return"number"==typeof t.ind&&-1!==t.ind&&r>t.ind&&(a=t.ind),this._insertScriptInstance(e,a,r),this._scriptsIndex[n]={instance:e,onSwap:function(){s.swap(n)}},this[n]=e,t.preloading||e.__initializeAttributes(),this.fire("create",n,e),this.fire("create:"+n,e),this.system.app.scripts.on("swap:"+n,this._scriptsIndex[n].onSwap),t.preloading||(e.enabled&&!e._initialized&&(e._initialized=!0,e.initialize&&this._scriptMethod(e,LT)),e.enabled&&!e._postInitialized&&(e._postInitialized=!0,e.postInitialize&&this._scriptMethod(e,DT))),e}}else this._scriptsIndex[n]={awaiting:!0,ind:this._scripts.length};return null}destroy(e){let t=e,s=e;"string"==typeof s?s=this.system.app.scripts.get(s):s&&(t=s.__name);const i=this._scriptsIndex[t];if(delete this._scriptsIndex[t],!i)return!1;const n=i.instance;if(n&&!n._destroyed)if(n.enabled=!1,n._destroyed=!0,this._isLoopingThroughScripts)this._destroyedScripts.push(n);else{const e=this._removeScriptInstance(n);e>=0&&this._resetExecutionOrder(e,this._scripts.length)}return this.system.app.scripts.off("swap:"+t,i.onSwap),delete this[t],this.fire("destroy",t,n||null),this.fire("destroy:"+t,n||null),n&&n.fire("destroy"),!0}swap(e){let t=e,s=e;"string"==typeof s?s=this.system.app.scripts.get(s):s&&(t=s.__name);const i=this._scriptsIndex[t];if(!i||!i.instance)return!1;const n=i.instance,r=this._scripts.indexOf(n),a=new s({app:this.system.app,entity:this.entity,enabled:n.enabled,attributes:n.__attributes});return!!a.swap&&(a.__initializeAttributes(),this._scripts[r]=a,this._scriptsIndex[t].instance=a,this[t]=a,a.__executionOrder=r,n.update&&this._updateList.remove(n),n.postUpdate&&this._postUpdateList.remove(n),a.update&&this._updateList.insert(a),a.postUpdate&&this._postUpdateList.insert(a),this._scriptMethod(a,"swap",n),this.fire("swap",t,a),this.fire("swap:"+t,a),!0)}resolveDuplicatedEntityReferenceProperties(e,t){const s=this.entity.script;for(const i in e._scriptsIndex){const n=this.system.app.scripts.get(i);if(!n)continue;const r=e._scriptsIndex[i];if(!r||!r.instance)continue;const a=s[i].__attributesRaw,o=s[i].__attributes;if(!a&&!o)continue;const l=!!a,h=r.instance.__attributes;for(const e in h){if(!h[e])continue;const s=n.attributes.get(e);if(s)if("entity"===s.type)this._resolveEntityScriptAttribute(s,e,h[e],l,a||o,t);else if("json"===s.type&&Array.isArray(s.schema)){const i=h[e],n=a?a[e]:o[e];for(let e=0;e<s.schema.length;e++){const r=s.schema[e];if("entity"===r.type)if(s.array)for(let e=0;e<i.length;e++)this._resolveEntityScriptAttribute(r,r.name,i[e][r.name],l,n[e],t);else this._resolveEntityScriptAttribute(r,r.name,i[r.name],l,n,t)}}}}}move(e,t){const s=this._scripts.length;if(t>=s||t<0)return!1;let i=e,n=e;"string"!=typeof n?n=e.__name:i=null;const r=this._scriptsIndex[n];if(!r||!r.instance)return!1;const a=r.instance;if(i&&!(a instanceof i))return!1;const o=this._scripts.indexOf(a);return-1!==o&&o!==t&&(this._scripts.splice(t,0,this._scripts.splice(o,1)[0]),this._resetExecutionOrder(0,s),this._updateList.sort(),this._postUpdateList.sort(),this.fire("move",n,a,t,o),this.fire("move:"+n,a,t,o),!0)}}kT.EVENT_CREATE="create",kT.EVENT_DESTROY="destroy",kT.EVENT_ENABLE="enable",kT.EVENT_DISABLE="disable",kT.EVENT_REMOVE="remove",kT.EVENT_STATE="state",kT.EVENT_MOVE="move",kT.EVENT_ERROR="error";vw._buildAccessors(class extends vw{constructor(e,t){super(e,t),this._layers=[0],this._instance=null,this._customAabb=null,this._assetReference=void 0,this._materialOptions=null,this._assetReference=new DC("asset",this,e.app.assets,{add:this._onGSplatAssetAdded,load:this._onGSplatAssetLoad,remove:this._onGSplatAssetRemove,unload:this._onGSplatAssetUnload},this),t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this)}set customAabb(e){var t;this._customAabb=e,null==(t=this._instance)||t.meshInstance.setCustomAabb(this._customAabb)}get customAabb(){return this._customAabb}set instance(e){if(this.destroyInstance(),this._instance=e,this._instance){const e=this._instance.meshInstance;e.node||(e.node=this.entity),e.setCustomAabb(this._customAabb),this._materialOptions&&this._instance.createMaterial(this._materialOptions),this.enabled&&this.entity.enabled&&this.addToLayers()}}get instance(){return this._instance}set materialOptions(e){this._materialOptions=Object.assign({},e),this._instance&&this._instance.createMaterial(this._materialOptions)}get materialOptions(){return this._materialOptions}get material(){var e;return null==(e=this._instance)?void 0:e.material}set layers(e){this.removeFromLayers(),this._layers.length=0;for(let t=0;t<e.length;t++)this._layers[t]=e[t];this.enabled&&this.entity.enabled&&this.addToLayers()}get layers(){return this._layers}set asset(e){const t=e instanceof Yx?e.id:e;this._assetReference.id!==t&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onGSplatAssetRemove(),this._assetReference.id=t,this._assetReference.asset&&this._onGSplatAssetAdded())}get asset(){return this._assetReference.id}assignAsset(e){const t=e instanceof Yx?e.id:e;this._assetReference.id=t}destroyInstance(){var e;this._instance&&(this.removeFromLayers(),null==(e=this._instance)||e.destroy(),this._instance=null)}addToLayers(){var e;const t=null==(e=this.instance)?void 0:e.meshInstance;if(t){const e=this.system.app.scene.layers;for(let i=0;i<this._layers.length;i++){var s;null==(s=e.getLayerById(this._layers[i]))||s.addMeshInstances([t])}}}removeFromLayers(){var e;const t=null==(e=this.instance)?void 0:e.meshInstance;if(t){const e=this.system.app.scene.layers;for(let i=0;i<this._layers.length;i++){var s;null==(s=e.getLayerById(this._layers[i]))||s.removeMeshInstances([t])}}}onRemoveChild(){this.removeFromLayers()}onInsertChild(){this._instance&&this.enabled&&this.entity.enabled&&this.addToLayers()}onRemove(){this.destroyInstance(),this.asset=null,this._assetReference.id=null,this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(e,t){this.addToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||this._instance&&e.addMeshInstances(this._instance.meshInstance)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||this._instance&&e.removeMeshInstances(this._instance.meshInstance)}onEnable(){const e=this.system.app.scene;e.on("set:layers",this.onLayersChanged,this),e.layers&&(e.layers.on("add",this.onLayerAdded,this),e.layers.on("remove",this.onLayerRemoved,this)),this._instance?this.addToLayers():this.asset&&this._onGSplatAssetAdded()}onDisable(){const e=this.system.app.scene;e.off("set:layers",this.onLayersChanged,this),e.layers&&(e.layers.off("add",this.onLayerAdded,this),e.layers.off("remove",this.onLayerRemoved,this)),this.removeFromLayers()}hide(){this._instance&&(this._instance.meshInstance.visible=!1)}show(){this._instance&&(this._instance.meshInstance.visible=!0)}_onGSplatAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onGSplatAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))}_onGSplatAssetLoad(){this.destroyInstance();const e=this._assetReference.asset;e&&(this.instance=e.resource.createInstance())}_onGSplatAssetUnload(){this.destroyInstance()}_onGSplatAssetRemove(){this._onGSplatAssetUnload()}}.prototype,["enabled"]);(class extends od{constructor(){super(),this._meshes=null}set meshes(e){this.decRefMeshes(),this._meshes=e,this.incRefMeshes(),this.fire("set:meshes",e)}get meshes(){return this._meshes}destroy(){this.meshes=null}decRefMeshes(){if(this._meshes){const e=this._meshes.length;for(let t=0;t<e;t++){const e=this._meshes[t];e&&(e.decRefCount(),e.refCount<1&&(e.destroy(),this._meshes[t]=null))}}}incRefMeshes(){if(this._meshes){const e=this._meshes.length;for(let t=0;t<e;t++)this._meshes[t]&&this._meshes[t].incRefCount()}}}).EVENT_SETMESHES="set:meshes",new pu,new nu,function(){if("undefined"==typeof window)return!1;const e=window.navigator.userAgent,t=e.indexOf("MSIE ");if(t>0)return parseInt(e.substring(t+5,e.indexOf(".",t)),10);if(e.indexOf("Trident/")>0){const t=e.indexOf("rv:");return parseInt(e.substring(t+3,e.indexOf(".",t)),10)}}();const IT=new RegExp("^\\s*function(?:\\s|\\s*\\/\\*.*\\*\\/\\s*)+([^\\(\\s\\/]*)\\s*");class RT extends od{constructor(e){super(),this.app=void 0,this.entity=void 0,this._enabled=void 0,this._enabledOld=void 0,this._initialized=void 0,this._postInitialized=void 0,this.__destroyed=void 0,this.__attributes=void 0,this.__attributesRaw=void 0,this.__scriptType=void 0,this.__executionOrder=void 0,this.initScriptType(e)}set enabled(e){this._enabled=!!e,this.enabled!==this._enabledOld&&(this._enabledOld=this.enabled,this.fire(this.enabled?"enable":"disable"),this.fire("state",this.enabled),!this._initialized&&this.enabled&&(this._initialized=!0,this.__initializeAttributes(!0),this.initialize&&this.entity.script._scriptMethod(this,LT)),this._initialized&&!this._postInitialized&&this.enabled&&!this.entity.script._beingEnabled&&(this._postInitialized=!0,this.postInitialize&&this.entity.script._scriptMethod(this,DT)))}get enabled(){return this._enabled&&!this._destroyed&&this.entity.script.enabled&&this.entity.enabled}initScriptType(e){const t=this.constructor;this.app=e.app,this.entity=e.entity,this._enabled="boolean"!=typeof e.enabled||e.enabled,this._enabledOld=this.enabled,this.__destroyed=!1,this.__attributes={},this.__attributesRaw=e.attributes||{},this.__scriptType=t,this.__executionOrder=-1}static __getScriptName(e){if("function"!=typeof e)return;if("name"in Function.prototype)return e.name;if(e===Function||e===Function.prototype.constructor)return"Function";const t=(""+e).match(IT);return t?t[1]:void 0}static get scriptName(){return this.__name}static get attributes(){return this.hasOwnProperty("__attributes")||(this.__attributes=new MT(this)),this.__attributes}__initializeAttributes(e){if(e||this.__attributesRaw){for(const e in this.__scriptType.attributes.index)this.__attributesRaw&&this.__attributesRaw.hasOwnProperty(e)?this[e]=this.__attributesRaw[e]:this.__attributes.hasOwnProperty(e)||(this.__scriptType.attributes.index[e].hasOwnProperty("default")?this[e]=this.__scriptType.attributes.index[e].default:this[e]=null);this.__attributesRaw=null}}static extend(e){for(const t in e)e.hasOwnProperty(t)&&(this.prototype[t]=e[t])}}RT.EVENT_ENABLE="enable",RT.EVENT_DISABLE="disable",RT.EVENT_STATE="state",RT.EVENT_DESTROY="destroy",RT.EVENT_ATTR="attr",RT.EVENT_ERROR="error",RT.__name=null;const OT={};MT.reservedNames.forEach(((e,t,s)=>{OT[e]=1}));const zT="immersive-ar",FT="luminance-alpha";class VT extends od{constructor(e){super(),this._manager=void 0,this._views=void 0,this._available=!1,this._evtDepthResize=null,this._uvMatrix=pu.IDENTITY.clone(),this._manager=e,this._views=e.views,this._views.supportedDepth&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}_onSessionStart(){var e;this._views.availableDepth&&(this._evtDepthResize=null==(e=this._views.list[0])?void 0:e.on("depth:resize",this._onDepthResize,this))}_onSessionEnd(){this._evtDepthResize&&(this._evtDepthResize.off(),this._evtDepthResize=null),this._available&&(this._available=!1,this.fire("unavailable"))}_onDepthResize(e,t){this.fire("resize",e,t)}getDepth(e,t){var s,i;return null!=(s=null==(i=this._views.list[0])?void 0:i.getDepth(e,t))?s:null}update(){this._manager.session&&this.supported&&this._views.availableDepth&&this._views.list.length&&!this._available&&(this._available=!0,this.fire("available"))}get supported(){return this._views.supportedDepth}get available(){return this._views.availableDepth}get usage(){return this._views.depthUsage}get dataFormat(){return this._views.depthFormat}get width(){var e,t;return null!=(e=null==(t=this._views.list[0])||null==(t=t.textureDepth)?void 0:t.width)?e:0}get height(){var e,t;return null!=(e=null==(t=this._views.list[0])||null==(t=t.textureDepth)?void 0:t.height)?e:0}get texture(){var e;return null==(e=this._views.list[0])?void 0:e.textureDepth}get uvMatrix(){var e,t;return null!=(e=null==(t=this._views.list[0])?void 0:t.depthUvMatrix)?e:this._uvMatrix}get rawValueToMeters(){var e,t;return null!=(e=null==(t=this._views.list[0])?void 0:t.depthValueToMeters)?e:0}}VT.EVENT_AVAILABLE="available",VT.EVENT_UNAVAILABLE="unavailable",VT.EVENT_RESIZE="resize";class NT{constructor(e){this._manager=void 0,this._supported=Sd.browser&&!!window.XRDOMOverlayState,this._root=null,this._manager=e}get supported(){return this._supported}get available(){return this._supported&&this._manager.active&&null!==this._manager._session.domOverlayState}get state(){return this._supported&&this._manager.active&&this._manager._session.domOverlayState?this._manager._session.domOverlayState.type:null}set root(e){this._supported&&!this._manager.active&&(this._root=e)}get root(){return this._root}}const BT=[],UT=[];class HT extends od{constructor(e,t,s,i=null){super(),this.manager=void 0,this._xrHitTestSource=void 0,this._transient=void 0,this._inputSource=void 0,this.manager=e,this._xrHitTestSource=t,this._transient=s,this._inputSource=i}remove(){if(!this._xrHitTestSource)return;const e=this.manager.hitTest.sources,t=e.indexOf(this);-1!==t&&e.splice(t,1),this.onStop()}onStop(){this._xrHitTestSource.cancel(),this._xrHitTestSource=null,this.fire("remove"),this.manager.hitTest.fire("remove",this)}update(e){if(this._transient){const t=e.getHitTestResultsForTransientInput(this._xrHitTestSource);for(let e=0;e<t.length;e++){const s=t[e];if(!s.results.length)continue;let i;s.inputSource&&(i=this.manager.input._getByInputSource(s.inputSource)),this.updateHitResults(s.results,i)}}else{const t=e.getHitTestResults(this._xrHitTestSource);if(!t.length)return;this.updateHitResults(t)}}updateHitResults(e,t){var s,i,n;if(this._inputSource&&this._inputSource!==t)return;const r=null!=(s=BT.pop())?s:new nu;t?r.copy(t.getOrigin()):r.copy(this.manager.camera.getPosition());let a=1/0,o=null;const l=null!=(i=BT.pop())?i:new nu,h=null!=(n=UT.pop())?n:new _u;for(let t=0;t<e.length;t++){const s=e[t].getPose(this.manager._referenceSpace),i=r.distance(s.transform.position);i>=a||(a=i,o=e[t],l.copy(s.transform.position),h.copy(s.transform.orientation))}this.fire("result",l,h,t||this._inputSource,o),this.manager.hitTest.fire("result",this,l,h,t||this._inputSource,o),BT.push(r),BT.push(l),UT.push(h)}}HT.EVENT_REMOVE="remove",HT.EVENT_RESULT="result";class WT extends od{constructor(e){super(),this.manager=void 0,this._supported=Sd.browser&&!(!window.XRSession||!window.XRSession.prototype.requestHitTestSource),this._available=!1,this.sources=[],this.manager=e,this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this))}_onSessionStart(){const e=-1!==this.manager.session.enabledFeatures.indexOf("hit-test");e&&(this._available=e,this.fire("available"))}_onSessionEnd(){if(this._available){this._available=!1;for(let e=0;e<this.sources.length;e++)this.sources[e].onStop();this.sources=[],this.fire("unavailable")}}start(e={}){if(!this._supported)return void(null==e.callback||e.callback(new Error("XR HitTest is not supported"),null));if(!this._available)return void(null==e.callback||e.callback(new Error("XR HitTest is not available"),null));let t;e.profile||e.spaceType||(e.spaceType="viewer");const s=e.offsetRay;if(s){const e=new DOMPoint(s.origin.x,s.origin.y,s.origin.z,1),i=new DOMPoint(s.direction.x,s.direction.y,s.direction.z,0);t=new XRRay(e,i)}const i=e.callback;e.spaceType?this.manager.session.requestReferenceSpace(e.spaceType).then((s=>{if(!this.manager.session){const e=new Error("XR Session is not started (2)");return i&&i(e),void this.fire("error",e)}this.manager.session.requestHitTestSource({space:s,entityTypes:e.entityTypes||void 0,offsetRay:t}).then((t=>{this._onHitTestSource(t,!1,e.inputSource,i)})).catch((e=>{i&&i(e),this.fire("error",e)}))})).catch((e=>{i&&i(e),this.fire("error",e)})):this.manager.session.requestHitTestSourceForTransientInput({profile:e.profile,entityTypes:e.entityTypes||void 0,offsetRay:t}).then((t=>{this._onHitTestSource(t,!0,e.inputSource,i)})).catch((e=>{i&&i(e),this.fire("error",e)}))}_onHitTestSource(e,t,s,i){if(!this.manager.session){e.cancel();const t=new Error("XR Session is not started (3)");return i&&i(t),void this.fire("error",t)}const n=new HT(this.manager,e,t,null!=s?s:null);this.sources.push(n),i&&i(null,n),this.fire("add",n)}update(e){for(let t=0;t<this.sources.length;t++)this.sources[t].update(e)}get supported(){return this._supported}get available(){return this._available}}WT.EVENT_AVAILABLE="available",WT.EVENT_UNAVAILABLE="unavailable",WT.EVENT_ADD="add",WT.EVENT_REMOVE="remove",WT.EVENT_RESULT="result",WT.EVENT_ERROR="error";class GT extends od{constructor(e,t){super(),this._image=void 0,this._width=void 0,this._bitmap=null,this._measuredWidth=0,this._trackable=!1,this._tracking=!1,this._emulated=!1,this._pose=null,this._position=new nu,this._rotation=new _u,this._image=e,this._width=t}get image(){return this._image}set width(e){this._width=e}get width(){return this._width}get trackable(){return this._trackable}get tracking(){return this._tracking}get emulated(){return this._emulated}prepare(){return this._bitmap?{image:this._bitmap,widthInMeters:this._width}:createImageBitmap(this._image).then((e=>(this._bitmap=e,{image:this._bitmap,widthInMeters:this._width})))}destroy(){this._image=null,this._pose=null,this._bitmap&&(this._bitmap.close(),this._bitmap=null)}getPosition(){return this._pose&&this._position.copy(this._pose.transform.position),this._position}getRotation(){return this._pose&&this._rotation.copy(this._pose.transform.orientation),this._rotation}}GT.EVENT_TRACKED="tracked",GT.EVENT_UNTRACKED="untracked";class jT extends od{constructor(e){super(),this._manager=void 0,this._supported=Sd.browser&&!!window.XRImageTrackingResult,this._available=!1,this._images=[],this._manager=e,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}add(e,t){if(!this._supported||this._manager.active)return null;const s=new GT(e,t);return this._images.push(s),s}remove(e){if(this._manager.active)return;const t=this._images.indexOf(e);-1!==t&&(e.destroy(),this._images.splice(t,1))}_onSessionStart(){this._manager.session.getTrackedImageScores().then((e=>{this._available=!0;for(let t=0;t<e.length;t++)this._images[t]._trackable="trackable"===e[t]})).catch((e=>{this._available=!1,this.fire("error",e)}))}_onSessionEnd(){this._available=!1;for(let e=0;e<this._images.length;e++){const t=this._images[e];t._pose=null,t._measuredWidth=0,t._tracking&&(t._tracking=!1,t.fire("untracked"))}}prepareImages(e){this._images.length?Promise.all(this._images.map((function(e){return e.prepare()}))).then((function(t){e(null,t)})).catch((function(t){e(t,null)})):e(null,null)}update(e){if(!this._available)return;const t=e.getImageTrackingResults(),s={};for(let i=0;i<t.length;i++){s[t[i].index]=t[i];const n=this._images[t[i].index];n._emulated="emulated"===t[i].trackingState,n._measuredWidth=t[i].measuredWidthInMeters,n._pose=e.getPose(t[i].imageSpace,this._manager._referenceSpace)}for(let e=0;e<this._images.length;e++)this._images[e]._tracking&&!s[e]?(this._images[e]._tracking=!1,this._images[e].fire("untracked")):!this._images[e]._tracking&&s[e]&&(this._images[e]._tracking=!0,this._images[e].fire("tracked"))}get supported(){return this._supported}get available(){return this._available}get images(){return this._images}}jT.EVENT_ERROR="error";class qT{constructor(e,t){this._index=void 0,this._hand=void 0,this._joints=[],this._tip=null,this._index=e,this._hand=t,this._hand._fingers.push(this)}get index(){return this._index}get hand(){return this._hand}get joints(){return this._joints}get tip(){return this._tip}}const KT=Sd.browser&&window.XRHand?["thumb-tip","index-finger-tip","middle-finger-tip","ring-finger-tip","pinky-finger-tip"]:[],XT={};for(let e=0;e<KT.length;e++)XT[KT[e]]=!0;class YT{constructor(e,t,s,i=null){this._index=void 0,this._id=void 0,this._hand=void 0,this._finger=void 0,this._wrist=void 0,this._tip=void 0,this._radius=null,this._localTransform=new pu,this._worldTransform=new pu,this._localPosition=new nu,this._localRotation=new _u,this._position=new nu,this._rotation=new _u,this._dirtyLocal=!0,this._index=e,this._id=t,this._hand=s,this._finger=i,this._wrist="wrist"===t,this._tip=this._finger&&!!XT[t]}update(e){this._dirtyLocal=!0,this._radius=e.radius,this._localPosition.copy(e.transform.position),this._localRotation.copy(e.transform.orientation)}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,nu.ONE));const e=this._hand._manager.camera.parent;e?this._worldTransform.mul2(e.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}getPosition(){return this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position}getRotation(){return this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation}get index(){return this._index}get hand(){return this._hand}get finger(){return this._finger}get wrist(){return this._wrist}get tip(){return this._tip}get radius(){return this._radius||.005}}let ZT=[];const $T=new nu,QT=new nu,JT=new nu;Sd.browser&&window.XRHand&&(ZT=[["thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip"],["index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip"],["middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip"],["ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip"],["pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]]);class eA extends od{constructor(e){super(),this._manager=void 0,this._inputSource=void 0,this._tracking=!1,this._fingers=[],this._joints=[],this._jointsById={},this._tips=[],this._wrist=null;const t=e._xrInputSource.hand;if(this._manager=e._manager,this._inputSource=e,t.get("wrist")){const e=new YT(0,"wrist",this,null);this._wrist=e,this._joints.push(e),this._jointsById.wrist=e}for(let e=0;e<ZT.length;e++){const s=new qT(e,this);for(let i=0;i<ZT[e].length;i++){const n=ZT[e][i];if(!t.get(n))continue;const r=new YT(i,n,this,s);this._joints.push(r),this._jointsById[n]=r,r.tip&&(this._tips.push(r),s._tip=r),s._joints.push(r)}}}update(e){const t=this._inputSource._xrInputSource;for(let s=0;s<this._joints.length;s++){const i=this._joints[s],n=t.hand.get(i._id);if(n){let t;if("hidden"!==e.session.visibilityState&&(t=e.getJointPose(n,this._manager._referenceSpace)),t)i.update(t),i.wrist&&!this._tracking&&(this._tracking=!0,this.fire("tracking"));else if(i.wrist){this._tracking&&(this._tracking=!1,this.fire("trackinglost"));break}}}const s=this._jointsById["thumb-metacarpal"],i=this._jointsById["thumb-tip"],n=this._jointsById["index-finger-phalanx-proximal"],r=this._jointsById["index-finger-tip"],a=this._jointsById["ring-finger-phalanx-proximal"],o=this._jointsById["pinky-finger-phalanx-proximal"];if(s&&i&&n&&r&&a&&o){this._inputSource._dirtyRay=!0,this._inputSource._rayLocal.origin.lerp(i._localPosition,r._localPosition,.5);let e=s,t=o;if("left"===this._inputSource.handedness){const s=e;e=t,t=s}$T.sub2(e._localPosition,this._wrist._localPosition),QT.sub2(t._localPosition,this._wrist._localPosition),JT.cross($T,QT).normalize(),$T.lerp(n._localPosition,a._localPosition,.5),$T.sub(this._wrist._localPosition).normalize(),this._inputSource._rayLocal.direction.lerp(JT,$T,.5).normalize()}this._fingerIsClosed(1)&&this._fingerIsClosed(2)&&this._fingerIsClosed(3)&&this._fingerIsClosed(4)?this._inputSource._squeezing||(this._inputSource._squeezing=!0,this._inputSource.fire("squeezestart"),this._manager.input.fire("squeezestart",this._inputSource)):this._inputSource._squeezing&&(this._inputSource._squeezing=!1,this._inputSource.fire("squeeze"),this._manager.input.fire("squeeze",this._inputSource),this._inputSource.fire("squeezeend"),this._manager.input.fire("squeezeend",this._inputSource))}_fingerIsClosed(e){const t=this._fingers[e];return $T.sub2(t.joints[0]._localPosition,t.joints[1]._localPosition).normalize(),QT.sub2(t.joints[2]._localPosition,t.joints[3]._localPosition).normalize(),$T.dot(QT)<-.8}getJointById(e){return this._jointsById[e]||null}get fingers(){return this._fingers}get joints(){return this._joints}get tips(){return this._tips}get wrist(){return this._wrist}get tracking(){return this._tracking}}eA.EVENT_TRACKING="tracking",eA.EVENT_TRACKINGLOST="trackinglost";const tA=new nu,sA=new _u;let iA=0;class nA extends od{constructor(e,t){super(),this._id=void 0,this._manager=void 0,this._xrInputSource=void 0,this._ray=new Au,this._rayLocal=new Au,this._grip=!1,this._hand=null,this._velocitiesAvailable=!1,this._velocitiesTimestamp=Bd(),this._localTransform=null,this._worldTransform=null,this._position=new nu,this._rotation=new _u,this._localPosition=null,this._localPositionLast=null,this._localRotation=null,this._linearVelocity=null,this._dirtyLocal=!0,this._dirtyRay=!1,this._selecting=!1,this._squeezing=!1,this._elementInput=!0,this._elementEntity=null,this._hitTestSources=[],this._id=++iA,this._manager=e,this._xrInputSource=t,t.hand&&(this._hand=new eA(this))}get id(){return this._id}get inputSource(){return this._xrInputSource}get targetRayMode(){return this._xrInputSource.targetRayMode}get handedness(){return this._xrInputSource.handedness}get profiles(){return this._xrInputSource.profiles}get grip(){return this._grip}get hand(){return this._hand}get gamepad(){return this._xrInputSource.gamepad||null}get selecting(){return this._selecting}get squeezing(){return this._squeezing}set elementInput(e){this._elementInput!==e&&(this._elementInput=e,this._elementInput||(this._elementEntity=null))}get elementInput(){return this._elementInput}get elementEntity(){return this._elementEntity}get hitTestSources(){return this._hitTestSources}update(e){if(this._hand)this._hand.update(e);else{const t=this._xrInputSource.gripSpace;if(t){const s=e.getPose(t,this._manager._referenceSpace);if(s){this._grip||(this._grip=!0,this._localTransform=new pu,this._worldTransform=new pu,this._localPositionLast=new nu,this._localPosition=new nu,this._localRotation=new _u,this._linearVelocity=new nu);const e=Bd(),t=(e-this._velocitiesTimestamp)/1e3;this._velocitiesTimestamp=e,this._dirtyLocal=!0,this._localPositionLast.copy(this._localPosition),this._localPosition.copy(s.transform.position),this._localRotation.copy(s.transform.orientation),this._velocitiesAvailable=!0,this._manager.input.velocitiesSupported&&s.linearVelocity?this._linearVelocity.copy(s.linearVelocity):t>0&&(tA.sub2(this._localPosition,this._localPositionLast).divScalar(t),this._linearVelocity.lerp(this._linearVelocity,tA,.15))}else this._velocitiesAvailable=!1}const s=e.getPose(this._xrInputSource.targetRaySpace,this._manager._referenceSpace);s&&(this._dirtyRay=!0,this._rayLocal.origin.copy(s.transform.position),this._rayLocal.direction.set(0,0,-1),sA.copy(s.transform.orientation),sA.transformVector(this._rayLocal.direction,this._rayLocal.direction))}}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,nu.ONE));const e=this._manager.camera.parent;e?this._worldTransform.mul2(e.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}_updateRayTransforms(){const e=this._dirtyRay;this._dirtyRay=!1;if(this._manager.camera.parent){const e=this._manager.camera.parent.getWorldTransform();e.getTranslation(this._position),this._rotation.setFromMat4(e),this._rotation.transformVector(this._rayLocal.origin,this._ray.origin),this._ray.origin.add(this._position),this._rotation.transformVector(this._rayLocal.direction,this._ray.direction)}else e&&(this._ray.origin.copy(this._rayLocal.origin),this._ray.direction.copy(this._rayLocal.direction))}getPosition(){return this._position?(this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position):null}getLocalPosition(){return this._localPosition}getRotation(){return this._rotation?(this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation):null}getLocalRotation(){return this._localRotation}getLinearVelocity(){return this._velocitiesAvailable?this._linearVelocity:null}getOrigin(){return this._updateRayTransforms(),this._ray.origin}getDirection(){return this._updateRayTransforms(),this._ray.direction}hitTestStart(e={}){e.inputSource=this,e.profile=this._xrInputSource.profiles[0];const t=e.callback;e.callback=(e,s)=>{s&&this.onHitTestSourceAdd(s),t&&t(e,s)},this._manager.hitTest.start(e)}onHitTestSourceAdd(e){this._hitTestSources.push(e),this.fire("hittest:add",e),e.on("result",((t,s,i,n)=>{i===this&&this.fire("hittest:result",e,t,s,n)})),e.once("remove",(()=>{this.onHitTestSourceRemove(e),this.fire("hittest:remove",e)}))}onHitTestSourceRemove(e){const t=this._hitTestSources.indexOf(e);-1!==t&&this._hitTestSources.splice(t,1)}}nA.EVENT_REMOVE="remove",nA.EVENT_SELECT="select",nA.EVENT_SELECTSTART="selectstart",nA.EVENT_SELECTEND="selectend",nA.EVENT_SQUEEZE="squeeze",nA.EVENT_SQUEEZESTART="squeezestart",nA.EVENT_SQUEEZEEND="squeezeend",nA.EVENT_HITTESTADD="hittest:add",nA.EVENT_HITTESTREMOVE="hittest:remove",nA.EVENT_HITTESTRESULT="hittest:result";class rA extends od{constructor(e){var t;super(),this.manager=void 0,this._inputSources=[],this._onInputSourcesChangeEvt=void 0,this.velocitiesSupported=!1,this.manager=e,this.velocitiesSupported=!(!Sd.browser||null==(t=window.XRPose)||null==(t=t.prototype)||!t.hasOwnProperty("linearVelocity")),this._onInputSourcesChangeEvt=e=>{this._onInputSourcesChange(e)},this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this)}_onSessionStart(){const e=this.manager.session;e.addEventListener("inputsourceschange",this._onInputSourcesChangeEvt),e.addEventListener("select",(e=>{const t=this._getByInputSource(e.inputSource);t.update(e.frame),t.fire("select",e),this.fire("select",t,e)})),e.addEventListener("selectstart",(e=>{const t=this._getByInputSource(e.inputSource);t.update(e.frame),t._selecting=!0,t.fire("selectstart",e),this.fire("selectstart",t,e)})),e.addEventListener("selectend",(e=>{const t=this._getByInputSource(e.inputSource);t.update(e.frame),t._selecting=!1,t.fire("selectend",e),this.fire("selectend",t,e)})),e.addEventListener("squeeze",(e=>{const t=this._getByInputSource(e.inputSource);t.update(e.frame),t.fire("squeeze",e),this.fire("squeeze",t,e)})),e.addEventListener("squeezestart",(e=>{const t=this._getByInputSource(e.inputSource);t.update(e.frame),t._squeezing=!0,t.fire("squeezestart",e),this.fire("squeezestart",t,e)})),e.addEventListener("squeezeend",(e=>{const t=this._getByInputSource(e.inputSource);t.update(e.frame),t._squeezing=!1,t.fire("squeezeend",e),this.fire("squeezeend",t,e)}));const t=e.inputSources;for(let e=0;e<t.length;e++)this._addInputSource(t[e])}_onSessionEnd(){let e=this._inputSources.length;for(;e--;){const t=this._inputSources[e];this._inputSources.splice(e,1),t.fire("remove"),this.fire("remove",t)}this.manager.session.removeEventListener("inputsourceschange",this._onInputSourcesChangeEvt)}_onInputSourcesChange(e){for(let t=0;t<e.removed.length;t++)this._removeInputSource(e.removed[t]);for(let t=0;t<e.added.length;t++)this._addInputSource(e.added[t])}_getByInputSource(e){for(let t=0;t<this._inputSources.length;t++)if(this._inputSources[t].inputSource===e)return this._inputSources[t];return null}_addInputSource(e){if(this._getByInputSource(e))return;const t=new nA(this.manager,e);this._inputSources.push(t),this.fire("add",t)}_removeInputSource(e){for(let t=0;t<this._inputSources.length;t++){if(this._inputSources[t].inputSource!==e)continue;const s=this._inputSources[t];this._inputSources.splice(t,1);let i=s.hitTestSources.length;for(;i--;)s.hitTestSources[i].remove();return s.fire("remove"),void this.fire("remove",s)}}update(e){for(let t=0;t<this._inputSources.length;t++)this._inputSources[t].update(e)}get inputSources(){return this._inputSources}}rA.EVENT_ADD="add",rA.EVENT_REMOVE="remove",rA.EVENT_SELECT="select",rA.EVENT_SELECTSTART="selectstart",rA.EVENT_SELECTEND="selectend",rA.EVENT_SQUEEZE="squeeze",rA.EVENT_SQUEEZESTART="squeezestart",rA.EVENT_SQUEEZEEND="squeezeend";const aA=new nu,oA=new nu,lA=new pu,hA=new pu;class cA extends od{constructor(e){super(),this._manager=void 0,this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null,this._intensity=0,this._rotation=new _u,this._color=new jd,this._sphericalHarmonics=new Float32Array(27),this._manager=e,this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this)}_onSessionStart(){!!this._manager.session.requestLightProbe&&(this._supported=!0)}_onSessionEnd(){this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null}start(){let e;this._manager.session||(e=new Error("XR session is not running")),e||this._manager.type===zT||(e=new Error("XR session type is not AR")),e||this._supported||(e=new Error("light-estimation is not supported")),(!e&&this._lightProbe||this._lightProbeRequested)&&(e=new Error("light estimation is already requested")),e?this.fire("error",e):(this._lightProbeRequested=!0,this._manager.session.requestLightProbe().then((e=>{const t=this._lightProbeRequested;this._lightProbeRequested=!1,this._manager.active?t&&(this._lightProbe=e):this.fire("error",new Error("XR session is not active"))})).catch((e=>{this._lightProbeRequested=!1,this.fire("error",e)})))}end(){this._lightProbeRequested=!1,this._lightProbe=null,this._available=!1}update(e){if(!this._lightProbe)return;const t=e.getLightEstimate(this._lightProbe);if(!t)return;this._available||(this._available=!0,this.fire("available"));const s=t.primaryLightIntensity;this._intensity=Math.max(1,Math.max(s.x,Math.max(s.y,s.z))),aA.copy(s).mulScalar(1/this._intensity),this._color.set(aA.x,aA.y,aA.z),aA.set(0,0,0),oA.copy(t.primaryLightDirection),lA.setLookAt(oA,aA,nu.UP),hA.setFromAxisAngle(nu.RIGHT,90),lA.mul(hA),this._rotation.setFromMat4(lA),this._sphericalHarmonics.set(t.sphericalHarmonicsCoefficients)}get supported(){return this._supported}get available(){return this._available}get intensity(){return this._available?this._intensity:null}get color(){return this._available?this._color:null}get rotation(){return this._available?this._rotation:null}get sphericalHarmonics(){return this._available?this._sphericalHarmonics:null}}cA.EVENT_AVAILABLE="available",cA.EVENT_ERROR="error";let dA=0;class uA extends od{constructor(e,t){super(),this._id=void 0,this._planeDetection=void 0,this._xrPlane=void 0,this._lastChangedTime=void 0,this._orientation=void 0,this._position=new nu,this._rotation=new _u,this._id=++dA,this._planeDetection=e,this._xrPlane=t,this._lastChangedTime=t.lastChangedTime,this._orientation=t.orientation}destroy(){this._xrPlane&&(this._xrPlane=null,this.fire("remove"))}update(e){const t=this._planeDetection._manager,s=e.getPose(this._xrPlane.planeSpace,t._referenceSpace);s&&(this._position.copy(s.transform.position),this._rotation.copy(s.transform.orientation)),this._lastChangedTime!==this._xrPlane.lastChangedTime&&(this._lastChangedTime=this._xrPlane.lastChangedTime,this.fire("change"))}getPosition(){return this._position}getRotation(){return this._rotation}get id(){return this._id}get orientation(){return this._orientation}get points(){return this._xrPlane.polygon}get label(){return this._xrPlane.semanticLabel||""}}uA.EVENT_REMOVE="remove",uA.EVENT_CHANGE="change";class pA extends od{constructor(e){super(),this._manager=void 0,this._supported=Sd.browser&&!!window.XRPlane,this._available=!1,this._planesIndex=new Map,this._planes=[],this._manager=e,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}_onSessionStart(){this._supported&&-1!==this._manager.session.enabledFeatures.indexOf("plane-detection")&&(this._available=!0,this.fire("available"))}_onSessionEnd(){for(let e=0;e<this._planes.length;e++)this._planes[e].destroy(),this.fire("remove",this._planes[e]);this._planesIndex.clear(),this._planes.length=0,this._available&&(this._available=!1,this.fire("unavailable"))}update(e){if(!this._supported||!this._available)return;const t=e.detectedPlanes;for(const[e,s]of this._planesIndex)t.has(e)||(this._planesIndex.delete(e),this._planes.splice(this._planes.indexOf(s),1),s.destroy(),this.fire("remove",s));for(const s of t){let t=this._planesIndex.get(s);t?t.update(e):(t=new uA(this,s),this._planesIndex.set(s,t),this._planes.push(t),t.update(e),this.fire("add",t))}}get supported(){return this._supported}get available(){return this._available}get planes(){return this._planes}}pA.EVENT_AVAILABLE="available",pA.EVENT_UNAVAILABLE="unavailable",pA.EVENT_ADD="add",pA.EVENT_REMOVE="remove";class mA extends od{constructor(e,t,s=null){super(),this._position=new nu,this._rotation=new _u,this._uuid=null,this._uuidRequests=null,this._anchors=e,this._xrAnchor=t,this._uuid=s}destroy(){if(!this._xrAnchor)return;const e=this._xrAnchor;this._xrAnchor.delete(),this._xrAnchor=null,this.fire("destroy",e,this)}update(e){if(!this._xrAnchor)return;const t=e.getPose(this._xrAnchor.anchorSpace,this._anchors.manager._referenceSpace);if(t){if(this._position.equals(t.transform.position)&&this._rotation.equals(t.transform.orientation))return;this._position.copy(t.transform.position),this._rotation.copy(t.transform.orientation),this.fire("change")}}getPosition(){return this._position}getRotation(){return this._rotation}persist(e){this._anchors.persistence?this._uuid?null==e||e(null,this._uuid):this._uuidRequests?e&&this._uuidRequests.push(e):(this._uuidRequests=[],this._xrAnchor.requestPersistentHandle().then((t=>{this._uuid=t,this._anchors._indexByUuid.set(this._uuid,this),null==e||e(null,t);for(let e=0;e<this._uuidRequests.length;e++)this._uuidRequests[e](null,t);this._uuidRequests=null,this.fire("persist",t)})).catch((t=>{null==e||e(t,null);for(let e=0;e<this._uuidRequests.length;e++)this._uuidRequests[e](t);this._uuidRequests=null}))):null==e||e(new Error("Persistent Anchors are not supported"),null)}forget(e){this._uuid?this._anchors.forget(this._uuid,(t=>{this._uuid=null,null==e||e(t),this.fire("forget")})):null==e||e(new Error("Anchor is not persistent"))}get uuid(){return this._uuid}get persistent(){return!!this._uuid}}mA.EVENT_DESTROY="destroy",mA.EVENT_CHANGE="change",mA.EVENT_PERSIST="persist",mA.EVENT_FORGET="forget";class _A extends od{constructor(e){var t;super(),this.manager=void 0,this._supported=Sd.browser&&!!window.XRAnchor,this._available=!1,this._persistence=Sd.browser&&!(null==(t=window)||null==(t=t.XRSession)||!t.prototype.restorePersistentAnchor),this._creationQueue=[],this._index=new Map,this._indexByUuid=new Map,this._list=[],this._callbacksAnchors=new Map,this.manager=e,this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this))}_onSessionStart(){const e=-1!==this.manager.session.enabledFeatures.indexOf("anchors");e&&(this._available=e,this.fire("available"))}_onSessionEnd(){if(!this._available)return;this._available=!1;for(let e=0;e<this._creationQueue.length;e++)this._creationQueue[e].callback&&this._creationQueue[e].callback(new Error("session ended"),null);this._creationQueue.length=0,this._index.clear(),this._indexByUuid.clear();let e=this._list.length;for(;e--;)this._list[e].destroy();this._list.length=0,this.fire("unavailable")}_createAnchor(e,t=null){const s=new mA(this,e,t);return this._index.set(e,s),t&&this._indexByUuid.set(t,s),this._list.push(s),s.once("destroy",this._onAnchorDestroy,this),s}_onAnchorDestroy(e,t){this._index.delete(e),t.uuid&&this._indexByUuid.delete(t.uuid);const s=this._list.indexOf(t);-1!==s&&this._list.splice(s,1),this.fire("destroy",t)}create(e,t,s){if(this._available)if(window.XRHitTestResult&&e instanceof XRHitTestResult){const i=e;if(s=t,!this._supported)return void(null==s||s(new Error("Anchors API is not supported"),null));if(!i.createAnchor)return void(null==s||s(new Error("Creating Anchor from Hit Test is not supported"),null));i.createAnchor().then((e=>{const t=this._createAnchor(e);null==s||s(null,t),this.fire("add",t)})).catch((e=>{null==s||s(e,null),this.fire("error",e)}))}else this._creationQueue.push({transform:new XRRigidTransform(e,t),callback:s});else null==s||s(new Error("Anchors API is not available"),null)}restore(e,t){this._available?this._persistence?this.manager.active?this.manager.session.restorePersistentAnchor(e).then((s=>{const i=this._createAnchor(s,e);null==t||t(null,i),this.fire("add",i)})).catch((e=>{null==t||t(e,null),this.fire("error",e)})):null==t||t(new Error("WebXR session is not active"),null):null==t||t(new Error("Anchor Persistence is not supported"),null):null==t||t(new Error("Anchors API is not available"),null)}forget(e,t){this._available?this._persistence?this.manager.active?this.manager.session.deletePersistentAnchor(e).then((()=>{null==t||t(null)})).catch((e=>{null==t||t(e),this.fire("error",e)})):null==t||t(new Error("WebXR session is not active")):null==t||t(new Error("Anchor Persistence is not supported")):null==t||t(new Error("Anchors API is not available"))}update(e){if(this._available){if(this._creationQueue.length){for(let t=0;t<this._creationQueue.length;t++){const s=this._creationQueue[t];e.createAnchor(s.transform,this.manager._referenceSpace).then((e=>{s.callback&&this._callbacksAnchors.set(e,s.callback)})).catch((e=>{s.callback&&s.callback(e,null),this.fire("error",e)}))}this._creationQueue.length=0}for(const[t,s]of this._index)e.trackedAnchors.has(t)||(this._index.delete(t),s.destroy());for(let t=0;t<this._list.length;t++)this._list[t].update(e);for(const t of e.trackedAnchors){if(this._index.has(t))continue;try{t.anchorSpace}catch(e){continue}const s=this._createAnchor(t);s.update(e);const i=this._callbacksAnchors.get(t);i&&(this._callbacksAnchors.delete(t),i(null,s)),this.fire("add",s)}}}get supported(){return this._supported}get available(){return this._available}get persistence(){return this._persistence}get uuids(){return this._available&&this._persistence&&this.manager.active?this.manager.session.persistentAnchors:null}get list(){return this._list}}_A.EVENT_AVAILABLE="available",_A.EVENT_UNAVAILABLE="unavailable",_A.EVENT_ERROR="error",_A.EVENT_ADD="add",_A.EVENT_DESTROY="destroy";class fA extends od{constructor(e,t){super(),this._meshDetection=void 0,this._xrMesh=void 0,this._lastChanged=0,this._position=new nu,this._rotation=new _u,this._meshDetection=e,this._xrMesh=t,this._lastChanged=this._xrMesh.lastChangedTime}get xrMesh(){return this._xrMesh}get label(){return this._xrMesh.semanticLabel||""}get vertices(){return this._xrMesh.vertices}get indices(){return this._xrMesh.indices}destroy(){this._xrMesh&&(this._xrMesh=null,this.fire("remove"))}update(e){const t=this._meshDetection._manager,s=e.getPose(this._xrMesh.meshSpace,t._referenceSpace);s&&(this._position.copy(s.transform.position),this._rotation.copy(s.transform.orientation)),this._lastChanged!==this._xrMesh.lastChangedTime&&(this._lastChanged=this._xrMesh.lastChangedTime,this.fire("change"))}getPosition(){return this._position}getRotation(){return this._rotation}}fA.EVENT_REMOVE="remove",fA.EVENT_CHANGE="change";class gA extends od{constructor(e){super(),this._manager=void 0,this._supported=Sd.browser&&!!window.XRMesh,this._available=!1,this._index=new Map,this._list=[],this._manager=e,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}update(e){if(this._supported&&this._available){for(const t of e.detectedMeshes){let s=this._index.get(t);s?s.update(e):(s=new fA(this,t),this._index.set(t,s),this._list.push(s),s.update(e),this.fire("add",s))}for(const t of this._index.values())e.detectedMeshes.has(t.xrMesh)||this._removeMesh(t)}}_removeMesh(e){this._index.delete(e.xrMesh),this._list.splice(this._list.indexOf(e),1),e.destroy(),this.fire("remove",e)}_onSessionStart(){const e=-1!==this._manager.session.enabledFeatures.indexOf("mesh-detection");e&&(this._available=e,this.fire("available"))}_onSessionEnd(){if(this._available){this._available=!1;for(const e of this._index.values())this._removeMesh(e);this.fire("unavailable")}}get supported(){return this._supported}get available(){return this._available}get meshes(){return this._list}}gA.EVENT_AVAILABLE="available",gA.EVENT_UNAVAILABLE="unavailable",gA.EVENT_ADD="add",gA.EVENT_REMOVE="remove";class vA extends od{constructor(e,t,s){super(),this._manager=void 0,this._xrView=void 0,this._positionData=new Float32Array(3),this._viewport=new ou,this._projMat=new pu,this._projViewOffMat=new pu,this._viewMat=new pu,this._viewOffMat=new pu,this._viewMat3=new ru,this._viewInvMat=new pu,this._viewInvOffMat=new pu,this._xrCamera=null,this._textureColor=null,this._textureDepth=null,this._depthInfo=null,this._emptyDepthBuffer=new Uint8Array(32),this._depthMatrix=new pu,this._manager=e,this._xrView=t;const i=this._manager.app.graphicsDevice;if(this._manager.views.supportedColor&&(this._xrCamera=this._xrView.camera,this._manager.views.availableColor&&this._xrCamera&&(this._textureColor=new bm(i,{format:6,mipmaps:!1,addressU:1,addressV:1,minFilter:1,magFilter:1,width:this._xrCamera.width,height:this._xrCamera.height,name:`XrView-${this._xrView.eye}-Color`}))),this._manager.views.supportedDepth&&this._manager.views.availableDepth){this._textureDepth=new bm(i,{format:this._manager.views.depthPixelFormat,arrayLength:1===s?0:s,mipmaps:!1,addressU:1,addressV:1,minFilter:1,magFilter:1,width:4,height:4,name:`XrView-${this._xrView.eye}-Depth`});for(let e=0;e<this._textureDepth._levels.length;e++)this._textureDepth._levels[e]=this._emptyDepthBuffer}(this._textureColor||this._textureDepth)&&i.on("devicelost",this._onDeviceLost,this)}get textureColor(){return this._textureColor}get textureDepth(){return this._textureDepth}get depthUvMatrix(){return this._depthMatrix}get depthValueToMeters(){var e;return(null==(e=this._depthInfo)?void 0:e.rawValueToMeters)||0}get eye(){return this._xrView.eye}get viewport(){return this._viewport}get projMat(){return this._projMat}get projViewOffMat(){return this._projViewOffMat}get viewOffMat(){return this._viewOffMat}get viewInvOffMat(){return this._viewInvOffMat}get viewMat3(){return this._viewMat3}get positionData(){return this._positionData}update(e,t){this._xrView=t,this._manager.views.availableColor&&(this._xrCamera=this._xrView.camera);const s=e.session.renderState.baseLayer.getViewport(this._xrView);this._viewport.x=s.x,this._viewport.y=s.y,this._viewport.z=s.width,this._viewport.w=s.height,this._projMat.set(this._xrView.projectionMatrix),this._viewMat.set(this._xrView.transform.inverse.matrix),this._viewInvMat.set(this._xrView.transform.matrix),this._updateTextureColor(),this._updateDepth(e)}_updateTextureColor(){if(!this._manager.views.availableColor||!this._xrCamera||!this._textureColor)return;const e=this._manager.webglBinding;if(!e)return;const t=e.getCameraImage(this._xrCamera);if(!t)return;const s=this._manager.app.graphicsDevice,i=s.gl;if(this._frameBufferSource){var n,r;const e=s.isWebGL2?i.COLOR_ATTACHMENT0:null!=(n=null==(r=s.extDrawBuffers)?void 0:r.COLOR_ATTACHMENT0_WEBGL)?n:i.COLOR_ATTACHMENT0,a=this._xrCamera.width,o=this._xrCamera.height;s.setFramebuffer(this._frameBufferSource),i.framebufferTexture2D(i.FRAMEBUFFER,e,i.TEXTURE_2D,t,0),s.setFramebuffer(this._frameBuffer),i.framebufferTexture2D(i.FRAMEBUFFER,e,i.TEXTURE_2D,this._textureColor.impl._glTexture,0),i.bindFramebuffer(i.READ_FRAMEBUFFER,this._frameBufferSource),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,this._frameBuffer),i.blitFramebuffer(0,o,a,0,0,0,a,o,i.COLOR_BUFFER_BIT,i.NEAREST)}else this._frameBufferSource=i.createFramebuffer(),this._frameBuffer=i.createFramebuffer()}_updateDepth(e){var t,s;if(!this._manager.views.availableDepth||!this._textureDepth)return;const i=this._manager.views.depthGpuOptimized,n=i?this._manager.webglBinding:e;if(!n)return void(this._depthInfo=null);const r=n.getDepthInformation(this._xrView);if(!r)return void(this._depthInfo=null);let a=!this._depthInfo!=!r;this._depthInfo=r;const o=(null==(t=this._depthInfo)?void 0:t.width)||4,l=(null==(s=this._depthInfo)?void 0:s.height)||4;let h=!1;this._textureDepth.width===o&&this._textureDepth.height===l||(this._textureDepth._width=o,this._textureDepth._height=l,a=!0,h=!0),a&&(this._depthInfo?this._depthMatrix.data.set(this._depthInfo.normDepthBufferFromNormView.matrix):this._depthMatrix.setIdentity()),this._depthInfo?i?this._depthInfo.texture&&(this._textureDepth.impl._glTexture=this._depthInfo.texture):(this._textureDepth._levels[0]=new Uint8Array(this._depthInfo.data),this._textureDepth.upload()):(this._textureDepth._levels[0]=this._emptyDepthBuffer,this._textureDepth.upload()),h&&this.fire("depth:resize",o,l)}updateTransforms(e){e?(this._viewInvOffMat.mul2(e,this._viewInvMat),this.viewOffMat.copy(this._viewInvOffMat).invert()):(this._viewInvOffMat.copy(this._viewInvMat),this.viewOffMat.copy(this._viewMat)),this._viewMat3.setFromMat4(this._viewOffMat),this._projViewOffMat.mul2(this._projMat,this._viewOffMat),this._positionData[0]=this._viewInvOffMat.data[12],this._positionData[1]=this._viewInvOffMat.data[13],this._positionData[2]=this._viewInvOffMat.data[14]}_onDeviceLost(){this._frameBufferSource=null,this._frameBuffer=null,this._depthInfo=null}getDepth(e,t){var s,i;return this._manager.views.depthGpuOptimized?null:null!=(s=null==(i=this._depthInfo)?void 0:i.getDepthInMeters(e,t))?s:null}destroy(){if(this._depthInfo=null,this._textureColor&&(this._textureColor.destroy(),this._textureColor=null),this._textureDepth&&(this._textureDepth.destroy(),this._textureDepth=null),this._frameBufferSource){const e=this._manager.app.graphicsDevice.gl;e.deleteFramebuffer(this._frameBufferSource),this._frameBufferSource=null,e.deleteFramebuffer(this._frameBuffer),this._frameBuffer=null}}}vA.EVENT_DEPTHRESIZE="depth:resize";class yA extends od{constructor(e){super(),this._manager=void 0,this._index=new Map,this._indexTmp=new Map,this._list=[],this._supportedColor=Sd.browser&&!!window.XRCamera&&!!window.XRWebGLBinding,this._supportedDepth=Sd.browser&&!!window.XRDepthInformation,this._availableColor=!1,this._availableDepth=!1,this._depthUsage="",this._depthFormat="",this._depthFormats={[FT]:2,float32:ku},this._manager=e,this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this)}get list(){return this._list}get supportedColor(){return this._supportedColor}get supportedDepth(){return this._supportedDepth}get availableColor(){return this._availableColor}get availableDepth(){return this._availableDepth}get depthUsage(){return this._depthUsage}get depthGpuOptimized(){return"gpu-optimized"===this._depthUsage}get depthFormat(){return this._depthFormat}get depthPixelFormat(){var e;return null!=(e=this._depthFormats[this._depthFormat])?e:null}update(e,t){for(let e=0;e<t.length;e++)this._indexTmp.set(t[e].eye,t[e]);for(const[s,i]of this._indexTmp){let n=this._index.get(s);n?n.update(e,i):(n=new vA(this._manager,i,t.length),this._index.set(s,n),this._list.push(n),n.update(e,i),this.fire("add",n))}for(const[e,t]of this._index){if(this._indexTmp.has(e))continue;t.destroy(),this._index.delete(e);const s=this._list.indexOf(t);-1!==s&&this._list.splice(s,1),this.fire("remove",t)}this._indexTmp.clear()}get(e){return this._index.get(e)||null}_onSessionStart(){if(this._manager.type===zT&&(this._availableColor=-1!==this._manager.session.enabledFeatures.indexOf("camera-access"),this._availableDepth=-1!==this._manager.session.enabledFeatures.indexOf("depth-sensing"),this._availableDepth)){const e=this._manager.session;this._depthUsage=e.depthUsage,this._depthFormat=e.depthDataFormat}}_onSessionEnd(){for(const e of this._index.values())e.destroy();this._index.clear(),this._availableColor=!1,this._availableDepth=!1,this._depthUsage="",this._depthFormat="",this._list.length=0}}yA.EVENT_ADD="add",yA.EVENT_REMOVE="remove";class bA extends od{constructor(e){super(),this.app=void 0,this._supported=Sd.browser&&!!navigator.xr,this._available={},this._type=null,this._spaceType=null,this._session=null,this._baseLayer=null,this.webglBinding=null,this._referenceSpace=null,this.depthSensing=void 0,this.domOverlay=void 0,this.hitTest=void 0,this.imageTracking=void 0,this.planeDetection=void 0,this.meshDetection=void 0,this.input=void 0,this.lightEstimation=void 0,this.views=void 0,this.anchors=void 0,this._camera=null,this._localPosition=new nu,this._localRotation=new _u,this._depthNear=.1,this._depthFar=1e3,this._supportedFrameRates=null,this._width=0,this._height=0,this._framebufferScaleFactor=1,this.app=e,this._available.inline=!1,this._available["immersive-vr"]=!1,this._available[zT]=!1,this.views=new yA(this),this.depthSensing=new VT(this),this.domOverlay=new NT(this),this.hitTest=new WT(this),this.imageTracking=new jT(this),this.planeDetection=new pA(this),this.meshDetection=new gA(this),this.input=new rA(this),this.lightEstimation=new cA(this),this.anchors=new _A(this),this.views=new yA(this),this._supported&&(navigator.xr.addEventListener("devicechange",(()=>{this._deviceAvailabilityCheck()})),this._deviceAvailabilityCheck(),this.app.graphicsDevice.on("devicelost",this._onDeviceLost,this),this.app.graphicsDevice.on("devicerestored",this._onDeviceRestored,this))}destroy(){}start(e,t,s,i){var n,r,a;let o=i;if("object"==typeof i&&(o=i.callback),!this._available[t])return void(o&&o(new Error("XR is not available")));if(this._session)return void(o&&o(new Error("XR session is already started")));this._camera=e,this._camera.camera.xr=this,this._type=t,this._spaceType=s,this._framebufferScaleFactor=null!=(n=null==i?void 0:i.framebufferScaleFactor)?n:1,this._setClipPlanes(e.nearClip,e.farClip);const l={requiredFeatures:[s],optionalFeatures:[]},h=(null==(r=this.app.graphicsDevice)?void 0:r.isWebGL1)||(null==(a=this.app.graphicsDevice)?void 0:a.isWebGL2);if(t===zT){if(l.optionalFeatures.push("light-estimation"),l.optionalFeatures.push("hit-test"),i&&(i.imageTracking&&this.imageTracking.supported&&l.optionalFeatures.push("image-tracking"),i.planeDetection&&l.optionalFeatures.push("plane-detection"),i.meshDetection&&l.optionalFeatures.push("mesh-detection")),this.domOverlay.supported&&this.domOverlay.root&&(l.optionalFeatures.push("dom-overlay"),l.domOverlay={root:this.domOverlay.root}),i&&i.anchors&&this.anchors.supported&&l.optionalFeatures.push("anchors"),i&&i.depthSensing&&this.depthSensing.supported){l.optionalFeatures.push("depth-sensing");const e=["cpu-optimized"],t=[FT];if(i.depthSensing.usagePreference){const t=e.indexOf(i.depthSensing.usagePreference);-1!==t&&e.splice(t,1),e.unshift(i.depthSensing.usagePreference)}if(i.depthSensing.dataFormatPreference){const e=t.indexOf(i.depthSensing.dataFormatPreference);-1!==e&&t.splice(e,1),t.unshift(i.depthSensing.dataFormatPreference)}l.depthSensing={usagePreference:e,dataFormatPreference:t}}h&&i&&i.cameraColor&&this.views.supportedColor&&l.optionalFeatures.push("camera-access")}l.optionalFeatures.push("hand-tracking"),i&&i.optionalFeatures&&(l.optionalFeatures=l.optionalFeatures.concat(i.optionalFeatures)),this.imageTracking.supported&&this.imageTracking.images.length?this.imageTracking.prepareImages(((e,i)=>{if(e)return o&&o(e),void this.fire("error",e);null!==i&&(l.trackedImages=i),this._onStartOptionsReady(t,s,l,o)})):this._onStartOptionsReady(t,s,l,o)}_onStartOptionsReady(e,t,s,i){navigator.xr.requestSession(e,s).then((e=>{this._onSessionStart(e,t,i)})).catch((e=>{this._camera.camera.xr=null,this._camera=null,this._type=null,this._spaceType=null,i&&i(e),this.fire("error",e)}))}end(e){this._session?(this.webglBinding=null,e&&this.once("end",e),this._session.end()):e&&e(new Error("XR Session is not initialized"))}isAvailable(e){return this._available[e]}_deviceAvailabilityCheck(){for(const e in this._available)this._sessionSupportCheck(e)}initiateRoomCapture(e){this._session?this._session.initiateRoomCapture?this._session.initiateRoomCapture().then((()=>{e&&e(null)})).catch((t=>{e&&e(t)})):e(new Error("Session does not support manual room capture")):e(new Error("Session is not active"))}updateTargetFrameRate(e,t){var s;null!=(s=this._session)&&s.updateTargetFrameRate?this._session.updateTargetFrameRate(e).then((()=>{null==t||t()})).catch((e=>{null==t||t(e)})):null==t||t(new Error("unable to update frameRate"))}_sessionSupportCheck(e){navigator.xr.isSessionSupported(e).then((t=>{this._available[e]!==t&&(this._available[e]=t,this.fire("available",e,t),this.fire("available:"+e,t))})).catch((e=>{this.fire("error",e)}))}_onSessionStart(e,t,s){let i=!1;this._session=e;const n=()=>{this.fire("visibility:change",e.visibilityState)},r=()=>{this._setClipPlanes(this._camera.nearClip,this._camera.farClip)},a=()=>{this._camera&&(this._camera.off("set_nearClip",r),this._camera.off("set_farClip",r),this._camera.camera.xr=null,this._camera=null),e.removeEventListener("end",a),e.removeEventListener("visibilitychange",n),i||this.fire("end"),this._session=null,this._referenceSpace=null,this._width=0,this._height=0,this._type=null,this._spaceType=null,this.app.systems&&this.app.tick()};e.addEventListener("end",a),e.addEventListener("visibilitychange",n),this._camera.on("set_nearClip",r),this._camera.on("set_farClip",r),this._createBaseLayer(),this.session.supportedFrameRates?this._supportedFrameRates=Array.from(this.session.supportedFrameRates):this._supportedFrameRates=null,this._session.addEventListener("frameratechange",(()=>{var e;this.fire("frameratechange",null==(e=this._session)?void 0:e.frameRate)})),e.requestReferenceSpace(t).then((e=>{this._referenceSpace=e,this.app.tick(),s&&s(null),this.fire("start")})).catch((t=>{i=!0,e.end(),s&&s(t),this.fire("error",t)}))}_setClipPlanes(e,t){this._depthNear===e&&this._depthFar===t||(this._depthNear=e,this._depthFar=t,this._session&&this._session.updateRenderState({depthNear:this._depthNear,depthFar:this._depthFar}))}_createBaseLayer(){const e=this.app.graphicsDevice,t=e.maxPixelRatio/window.devicePixelRatio*this._framebufferScaleFactor;this._baseLayer=new XRWebGLLayer(this._session,e.gl,{alpha:!0,depth:!0,stencil:!0,framebufferScaleFactor:t,antialias:!1});const s=e.deviceType;if((s===hp||s===cp)&&window.XRWebGLBinding)try{this.webglBinding=new XRWebGLBinding(this._session,e.gl)}catch(e){this.fire("error",e)}this._session.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar})}_onDeviceLost(){this._session&&(this.webglBinding&&(this.webglBinding=null),this._baseLayer=null,this._session.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar}))}_onDeviceRestored(){this._session&&setTimeout((()=>{this.app.graphicsDevice.gl.makeXRCompatible().then((()=>{this._createBaseLayer()})).catch((e=>{this.fire("error",e)}))}),0)}update(e){if(!this._session)return!1;const t=e.session.renderState.baseLayer.framebufferWidth,s=e.session.renderState.baseLayer.framebufferHeight;this._width===t&&this._height===s||(this._width=t,this._height=s,this.app.graphicsDevice.setResolution(t,s));const i=e.getViewerPose(this._referenceSpace);if(!i)return!1;const n=this.views.list.length;this.views.update(e,i.views);const r=i.transform.position,a=i.transform.orientation;if(this._localPosition.set(r.x,r.y,r.z),this._localRotation.set(a.x,a.y,a.z,a.w),0===n&&this.views.list.length>0){const e=new pu,t=this.views.list[0];e.copy(t.projMat);const s=e.data,i=2*Math.atan(1/s[5])*180/Math.PI,n=s[5]/s[0],r=s[14]/(s[10]+1),a=s[14]/(s[10]-1),o=!1;this._camera.camera.setXrProperties({aspectRatio:n,farClip:r,fov:i,horizontalFov:o,nearClip:a})}return this._camera.camera._node.setLocalPosition(this._localPosition),this._camera.camera._node.setLocalRotation(this._localRotation),this.input.update(e),this._type===zT&&(this.hitTest.supported&&this.hitTest.update(e),this.lightEstimation.supported&&this.lightEstimation.update(e),this.imageTracking.supported&&this.imageTracking.update(e),this.anchors.supported&&this.anchors.update(e),this.planeDetection.supported&&this.planeDetection.update(e),this.depthSensing.supported&&this.depthSensing.update(),this.meshDetection.supported&&this.meshDetection.update(e)),this.fire("update",e),!0}get supported(){return this._supported}get active(){return!!this._session}get type(){return this._type}get spaceType(){return this._spaceType}get session(){return this._session}get frameRate(){var e,t;return null!=(e=null==(t=this._session)?void 0:t.frameRate)?e:null}get supportedFrameRates(){return this._supportedFrameRates}get framebufferScaleFactor(){return this._framebufferScaleFactor}set fixedFoveation(e){var t,s;null!==(null!=(t=null==(s=this._baseLayer)?void 0:s.fixedFoveation)?t:null)&&(this.app.graphicsDevice.samples,this._baseLayer.fixedFoveation=e)}get fixedFoveation(){var e,t;return null!=(e=null==(t=this._baseLayer)?void 0:t.fixedFoveation)?e:null}get camera(){return this._camera?this._camera.entity:null}get visibilityState(){return this._session?this._session.visibilityState:null}}bA.EVENT_AVAILABLE="available",bA.EVENT_START="start",bA.EVENT_END="end",bA.EVENT_UPDATE="update",bA.EVENT_ERROR="error",new nu,new nu;const xA=new Au,wA=new Au,SA=new Au;xA.end=new nu,wA.end=new nu,SA.end=new nu,new nu,new nu,new nu,new nu,new nu,new nu,new nu,new nu,new nu,new nu,new nu,new nu,new nu,new nu,new nu,new nu,new nu,new nu,new nu,new nu,new ou;Fd.endsWith=function(e,t){return e.endsWith(t)},Fd.startsWith=function(e,t){return e.startsWith(t)},Object.defineProperty(jd.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.r,this._data[1]=this.g,this._data[2]=this.b,this._data[3]=this.a,this._data}}),Object.defineProperty(jd.prototype,"data3",{get:function(){return this._data3||(this._data3=new Float32Array(3)),this._data3[0]=this.r,this._data3[1]=this.g,this._data3[2]=this.b,this._data3}}),Wd.INV_LOG2=Math.LOG2E,Wd.intToBytes=Wd.intToBytes32,Wd.bytesToInt=Wd.bytesToInt32,Object.defineProperty(au.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(2)),this._data[0]=this.x,this._data[1]=this.y,this._data}}),au.prototype.scale=au.prototype.mulScalar,Object.defineProperty(nu.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(3)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data}}),nu.prototype.scale=nu.prototype.mulScalar,Object.defineProperty(ou.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data[3]=this.w,this._data}}),ou.prototype.scale=ou.prototype.mulScalar,Cu.prototype.intersectRay=Cu.prototype.intersectsRay,Tu.prototype.update=function(e,t){const s=new pu;s.mul2(e,t),this.setFromMat4(s)},new ou,Object.defineProperty(tf,"transformSkinnedVS",{get:function(){return"#define SKIN\n"+tf.transformVS}});Object.keys({"ambientPrefilteredCube.frag":"ambientEnv.frag","ambientPrefilteredCubeLod.frag":"ambientEnv.frag","dpAtlasQuad.frag":null,"genParaboloid.frag":null,"prefilterCubemap.frag":null,"reflectionDpAtlas.frag":"reflectionEnv.frag","reflectionPrefilteredCube.frag":"reflectionEnv.frag","reflectionPrefilteredCubeLod.frag":"reflectionEnv.frag"}).forEach((e=>{Object.defineProperty(tf,e,{get:function(){return null},set:function(){}})})),Object.defineProperties(qp.prototype,{_glFrameBuffer:{get:function(){return this.impl._glFrameBuffer},set:function(e){}}}),Object.defineProperty(Bp,"defaultInstancingFormat",{get:function(){return null}}),Object.defineProperties(bm.prototype,{rgbm:{get:function(){return this.type===tp},set:function(e){this.type=e?tp:ep}},swizzleGGGR:{get:function(){return this.type===ip},set:function(e){this.type=e?ip:ep}},_glTexture:{get:function(){return this.impl._glTexture}},autoMipmap:{get:function(){return this._mipmaps},set:function(e){this._mipmaps=e}}}),Object.defineProperty(Gp.prototype,"webgl2",{get:function(){return this.isWebGL2}}),Gp.prototype.getProgramLibrary=function(){return nf(this)},Gp.prototype.setProgramLibrary=function(e){rf(this,e)},Gp.prototype.removeShaderFromCache=function(e){nf(this).removeFromCache(e)},Sp.DEFAULT=Object.freeze(new Sp);const CA=new Sp,TA=new Ep;function AA(e,t){Object.defineProperty(Pv.prototype,t,{get:function(){return this[e]},set:function(t){this[e]=t}})}function EA(e,t){"pass"!==e&&Object.defineProperty(mv.prototype,e,{get:function(){return this.litOptions[t||e]},set:function(s){this.litOptions[t||e]=s}})}Gp.prototype.setBlendFunction=function(e,t){const s=this.blendState;CA.copy(s),CA.setColorBlend(s.colorOp,e,t),CA.setAlphaBlend(s.alphaOp,e,t),this.setBlendState(CA)},Gp.prototype.setBlendFunctionSeparate=function(e,t,s,i){const n=this.blendState;CA.copy(n),CA.setColorBlend(n.colorOp,e,t),CA.setAlphaBlend(n.alphaOp,s,i),this.setBlendState(CA)},Gp.prototype.setBlendEquation=function(e){const t=this.blendState;CA.copy(t),CA.setColorBlend(e,t.colorSrcFactor,t.colorDstFactor),CA.setAlphaBlend(e,t.alphaSrcFactor,t.alphaDstFactor),this.setBlendState(CA)},Gp.prototype.setBlendEquationSeparate=function(e,t){const s=this.blendState;CA.copy(s),CA.setColorBlend(e,s.colorSrcFactor,s.colorDstFactor),CA.setAlphaBlend(t,s.alphaSrcFactor,s.alphaDstFactor),this.setBlendState(CA)},Gp.prototype.setColorWrite=function(e,t,s,i){const n=this.blendState;CA.copy(n),CA.setColorWrite(e,t,s,i),this.setBlendState(CA)},Gp.prototype.getBlending=function(){return this.blendState.blend},Gp.prototype.setBlending=function(e){CA.copy(this.blendState),CA.blend=e,this.setBlendState(CA)},Gp.prototype.setDepthWrite=function(e){TA.copy(this.depthState),TA.write=e,this.setDepthState(TA)},Gp.prototype.setDepthFunc=function(e){TA.copy(this.depthState),TA.func=e,this.setDepthState(TA)},Gp.prototype.setDepthTest=function(e){TA.copy(this.depthState),TA.test=e,this.setDepthState(TA)},Gp.prototype.getCullMode=function(){return this.cullMode},Object.defineProperty(vx.prototype,"defaultMaterial",{get:function(){return wf(Ax().graphicsDevice)}}),Object.defineProperty(lb.prototype,"_meshInstances",{get:function(){return null}}),Object.defineProperty(vx.prototype,"drawCalls",{get:function(){return null}}),["128","64","32","16","8","4"].forEach(((e,t)=>{Object.defineProperty(vx.prototype,`skyboxPrefiltered${e}`,{get:function(){return this._prefilteredCubemaps[t]},set:function(e){this._prefilteredCubemaps[t]=e,this.updateShaders=!0}})})),Object.defineProperty(vx.prototype,"models",{get:function(){return this._models||(this._models=[]),this._models}}),Object.defineProperty(rb.prototype,"renderTarget",{set:function(e){this._renderTarget=e,this._dirtyComposition=!0},get:function(){return this._renderTarget}}),vx.prototype.addModel=function(e){if(this.containsModel(e))return;const t=this.layers.getLayerById(0);t&&(t.addMeshInstances(e.meshInstances),this.models.push(e))},vx.prototype.addShadowCaster=function(e){const t=this.layers.getLayerById(0);t&&t.addShadowCasters(e.meshInstances)},vx.prototype.removeModel=function(e){const t=this.models.indexOf(e);if(-1!==t){const s=this.layers.getLayerById(0);if(!s)return;s.removeMeshInstances(e.meshInstances),this.models.splice(t,1)}},vx.prototype.removeShadowCasters=function(e){const t=this.layers.getLayerById(0);t&&t.removeShadowCasters(e.meshInstances)},vx.prototype.containsModel=function(e){return this.models.indexOf(e)>=0},vx.prototype.getModels=function(e){return this.models},Jy.prototype.renderComposition=function(e){Ax().renderComposition(e)},ig.prototype.syncAabb=function(){},class extends B_{constructor(e,t,{preferHighPrecision:s=!1}={}){super(),this._aabb=void 0,this.preferHighPrecision=void 0,this.device=t,this.preferHighPrecision=s,this._targets=e.slice();const i=this.device;if(i.supportsMorphTargetTexturesCore){const e=i.extTextureHalfFloat&&i.textureHalfFloatRenderable?Lu:void 0,t=i.extTextureFloat&&i.textureFloatRenderable?Du:void 0;this._renderTextureFormat=this.preferHighPrecision?null!=t?t:e:null!=e?e:t;const s=i.extTextureHalfFloat&&i.textureHalfFloatUpdatable?Lu:void 0,n=i.extTextureFloat?13:void 0;this._textureFormat=this.preferHighPrecision?null!=n?n:s:null!=s?s:n,void 0!==this._renderTextureFormat&&void 0!==this._textureFormat&&(this._useTextureMorph=!0)}this._init(),this._updateMorphFlags()}get aabb(){if(!this._aabb){const e=new nu,t=new nu;for(let s=0;s<this._targets.length;s++){const i=this._targets[s].aabb;e.min(i.getMin()),t.max(i.getMax())}this._aabb=new xu,this._aabb.setMinMax(e,t)}return this._aabb}get morphPositions(){return this._morphPositions}get morphNormals(){return this._morphNormals}get maxActiveTargets(){return this._useTextureMorph?this._targets.length:this._morphPositions&&this._morphNormals?4:8}get useTextureMorph(){return this._useTextureMorph}_init(){if(this._useTextureMorph&&(this._useTextureMorph=this._initTextureBased()),!this._useTextureMorph)for(let e=0;e<this._targets.length;e++)this._targets[e]._initVertexBuffers(this.device);for(let e=0;e<this._targets.length;e++)this._targets[e]._postInit()}_findSparseSet(e,t,s,i){let n=1;const r=e[0].length;for(let a=0;a<r;a+=3){let r=!1;for(let t=0;t<e.length;t++){const s=e[t];if(0!==s[a]||0!==s[a+1]||0!==s[a+2]){r=!0;break}}r?(t.push(n+i),s.push(a/3),n++):t.push(0+i)}return n}_initTextureBased(){const e=this.device.isWebGPU,t=e?0:.2,s=[],i=[];for(let e=0;e<this._targets.length;e++){const t=this._targets[e];t.options.deltaPositions&&(s.push(t.options.deltaPositions),i.push({target:t,name:"texturePositions"})),t.options.deltaNormals&&(s.push(t.options.deltaNormals),i.push({target:t,name:"textureNormals"}))}const n=[],r=[],a=this._findSparseSet(s,n,r,t),o=Math.min(this.device.maxTextureSize,4096);let l=Math.ceil(Math.sqrt(a));l=Math.min(l,o);const h=Math.ceil(a/l);if(h>o)return!1;this.morphTextureWidth=l,this.morphTextureHeight=h;let c=!1,d=3;const u=Qd.float2Half;this._textureFormat===Lu&&(c=!0,d=4);const p=[];for(let e=0;e<s.length;e++)p.push(this._createTexture("MorphTarget",this._textureFormat));for(let e=0;e<s.length;e++){const t=s[e],n=p[e],a=n.lock();if(c)for(let e=0;e<r.length;e++){const s=3*r[e],i=e*d+d;a[i]=u(t[s]),a[i+1]=u(t[s+1]),a[i+2]=u(t[s+2])}else for(let e=0;e<r.length;e++){const s=3*r[e],i=e*d+d;a[i]=t[s],a[i+1]=t[s+1],a[i+2]=t[s+2]}n.unlock();i[e].target._setTexture(i[e].name,n)}const m=[{semantic:Ju,components:1,type:e?5:6}];return this.vertexBufferIds=new Rp(this.device,new Bp(this.device,m,n.length),n.length,0,e?new Uint32Array(n):new Float32Array(n)),!0}destroy(){var e;null==(e=this.vertexBufferIds)||e.destroy(),this.vertexBufferIds=null;for(let e=0;e<this._targets.length;e++)this._targets[e].destroy();this._targets.length=0}get targets(){return this._targets}_updateMorphFlags(){this._morphPositions=!1,this._morphNormals=!1;for(let e=0;e<this._targets.length;e++){const t=this._targets[e];t.morphPositions&&(this._morphPositions=!0),t.morphNormals&&(this._morphNormals=!0)}}_createTexture(e,t){return new bm(this.device,{width:this.morphTextureWidth,height:this.morphTextureHeight,format:t,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1,name:e})}}.prototype.getTarget=function(e){return this.targets[e]},Kf.prototype._dirtify=function(e){e?this._dirtifyLocal():this._dirtifyWorld()},Kf.prototype.addLabel=function(e){this._labels[e]=!0},Kf.prototype.getLabels=function(){return Object.keys(this._labels)},Kf.prototype.hasLabel=function(e){return!!this._labels[e]},Kf.prototype.removeLabel=function(e){delete this._labels[e]},Kf.prototype.findByLabel=function(e,t=[]){this.hasLabel(e)&&t.push(this);for(let s=0;s<this._children.length;++s)t=this._children[s].findByLabel(e,t);return t},Kf.prototype.getChildren=function(){return this.children},Kf.prototype.getName=function(){return this.name},Kf.prototype.getPath=function(){return this.path},Kf.prototype.getRoot=function(){return this.root},Kf.prototype.getParent=function(){return this.parent},Kf.prototype.setName=function(e){this.name=e},Tf.prototype.getName=function(){return this.name},Tf.prototype.setName=function(e){this.name=e},Tf.prototype.getShader=function(){return this.shader},Tf.prototype.setShader=function(e){this.shader=e},Object.defineProperty(Tf.prototype,"blend",{set:function(e){this.blendState.blend=e},get:function(){return this.blendState.blend}}),Object.defineProperty(Tf.prototype,"blendSrc",{set:function(e){const t=this.blendState;CA.copy(t),CA.setColorBlend(t.colorOp,e,t.colorDstFactor),CA.setAlphaBlend(t.alphaOp,e,t.alphaDstFactor),this.blendState=CA},get:function(){return this.blendState.colorSrcFactor}}),Object.defineProperty(Tf.prototype,"blendDst",{set:function(e){const t=this.blendState;CA.copy(t),CA.setColorBlend(t.colorOp,t.colorSrcFactor,e),CA.setAlphaBlend(t.alphaOp,t.alphaSrcFactor,e),this.blendState=CA},get:function(){return this.blendState.colorDstFactor}}),Object.defineProperty(Pv.prototype,"shininess",{get:function(){return 100*this.gloss},set:function(e){this.gloss=.01*e}}),AA("diffuseTint","diffuseMapTint"),AA("specularTint","specularMapTint"),AA("emissiveTint","emissiveMapTint"),AA("aoVertexColor","aoMapVertexColor"),AA("diffuseVertexColor","diffuseMapVertexColor"),AA("specularVertexColor","specularMapVertexColor"),AA("emissiveVertexColor","emissiveMapVertexColor"),AA("metalnessVertexColor","metalnessMapVertexColor"),AA("glossVertexColor","glossMapVertexColor"),AA("opacityVertexColor","opacityMapVertexColor"),AA("lightVertexColor","lightMapVertexColor"),AA("sheenGloss","sheenGlossiess"),AA("clearCoatGloss","clearCostGlossiness"),EA("refraction","useRefraction");const PA=new yg,MA=Object.getOwnPropertyNames(PA);for(const e in MA)EA(MA[e]);bx.prototype.getAnimation=function(){return this.animation},bx.prototype.getCurrentTime=function(){return this.currentTime},bx.prototype.getLooping=function(){return this.looping},bx.prototype.getNumNodes=function(){return this.numNodes},bx.prototype.setAnimation=function(e){this.animation=e},bx.prototype.setCurrentTime=function(e){this.currentTime=e},bx.prototype.setLooping=function(e){this.looping=e},E_.prototype.getListener=function(){return this.listener},E_.prototype.getVolume=function(){return this.volume},E_.prototype.setVolume=function(e){this.volume=e},$x.prototype.getAssetById=function(e){return this.get(e)},Object.defineProperty(nA.prototype,"ray",{get:function(){return this._rayLocal}}),Object.defineProperty(nA.prototype,"position",{get:function(){return this._localPosition}}),Object.defineProperty(nA.prototype,"rotation",{get:function(){return this._localRotation}}),Object.defineProperty(r_.prototype,"wheel",{get:function(){return-2*this.wheelDelta}}),_w.prototype.isFullscreen=function(){return!!document.fullscreenElement},_w.prototype.enableFullscreen=function(e,t,s){e=e||this.graphicsDevice.canvas;const i=function e(){t(),document.removeEventListener("fullscreenchange",e)},n=function e(){s(),document.removeEventListener("fullscreenerror",e)};t&&document.addEventListener("fullscreenchange",i,!1),s&&document.addEventListener("fullscreenerror",n,!1),e.requestFullscreen?e.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT):s()},_w.prototype.disableFullscreen=function(e){const t=function t(){e(),document.removeEventListener("fullscreenchange",t)};e&&document.addEventListener("fullscreenchange",t,!1),document.exitFullscreen()},_w.prototype.getSceneUrl=function(e){const t=this.scenes.find(e);return t?t.url:null},_w.prototype.loadScene=function(e,t){this.scenes.loadScene(e,t)},_w.prototype.loadSceneHierarchy=function(e,t){this.scenes.loadSceneHierarchy(e,t)},_w.prototype.loadSceneSettings=function(e,t){this.scenes.loadSceneSettings(e,t)},_w.prototype.renderMeshInstance=function(e,t){const s=null!=t&&t.layer?t.layer:this.scene.defaultDrawLayer;this.scene.immediate.drawMesh(null,null,null,e,s)},_w.prototype.renderMesh=function(e,t,s,i){const n=null!=i&&i.layer?i.layer:this.scene.defaultDrawLayer;this.scene.immediate.drawMesh(t,s,e,null,n)},_w.prototype._addLines=function(e,t,s){const i=s&&s.layer?s.layer:this.scene.layers.getLayerById(3),n=!s||void 0===s.depthTest||s.depthTest;this.scene.immediate.getBatch(i,n).addLines(e,t)},_w.prototype.renderLine=function(e,t,s){let i,n=s;const r=arguments[3],a=arguments[4];r instanceof jd?(n=r,i="number"==typeof a?1===a?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}:a):"number"==typeof r?(n=s,i=1===r?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}):r&&(i=r),this._addLines([e,t],[s,n],i)},_w.prototype.renderLines=function(e,t,s){s?"number"==typeof s&&(s=1===s?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}):s={layer:this.scene.layers.getLayerById(3),depthTest:!0};!t.length||e.length===t.length?e.length%2==0?this._addLines(e,t,s):console.error("renderLines: array length is not divisible by 2"):console.error("renderLines: position/color arrays have different lengths")},_w.prototype.enableVr=function(){},Object.defineProperty(TT.prototype,"node",{get:function(){return this.entity}}),SC.prototype.setVisible=function(e){this.enabled=e},Object.defineProperty(SC.prototype,"aabb",{get:function(){return null},set:function(e){}}),Object.defineProperty(kC.prototype,"aabb",{get:function(){return null},set:function(e){}}),Object.defineProperty(UC.prototype,"bodyType",{get:function(){return this.type},set:function(e){this.type=e}}),UC.prototype.syncBodyToEntity=function(){this._updateDynamic()},ZC.prototype.setGravity=function(){1===arguments.length?this.gravity.copy(arguments[0]):this.gravity.set(arguments[0],arguments[1],arguments[2])};const LA={[hp]:"WebGL 1",[cp]:"WebGL 2",[dp]:"WebGPU",[up]:"Null"},DA=n.exports.Component;class kA extends DA{state={fallbackOrder:null,disabledOptions:null,activeDevice:this.preferredGraphicsDevice};constructor(e){super(e),this._handleUpdateDevice=this._handleUpdateDevice.bind(this)}_handleUpdateDevice(e){const{deviceType:t}=e.detail;this.onSetActiveGraphicsDevice(t)}componentDidMount(){window.addEventListener("updateActiveDevice",this._handleUpdateDevice)}componentWillUnmount(){window.removeEventListener("updateActiveDevice",this._handleUpdateDevice)}mergeState(e){this.setState((t=>({...t,...e})))}set preferredGraphicsDevice(e){localStorage.setItem("preferredGraphicsDevice",e),window.preferredGraphicsDevice=e}get preferredGraphicsDevice(){return window.preferredGraphicsDevice}setDisabledOptions(e="webgpu",t){if(e!==cp&&e!==dp||t!==hp)if(e===hp&&t===cp){const e=[hp,cp,dp],s={[hp]:"WebGL 1 (not supported)"};this.mergeState({fallbackOrder:e,disabledOptions:s,activeDevice:t})}else if(e===dp&&t!==dp){const e=[dp,cp,hp],s={[dp]:"WebGPU (not supported)"};this.mergeState({fallbackOrder:e,disabledOptions:s,activeDevice:t})}else{const e=null;this.mergeState({disabledOptions:e,activeDevice:t})}else{const e=[dp,cp,hp],s={[dp]:"WebGPU (not supported)",[cp]:"WebGL 2 (not supported)"};this.mergeState({fallbackOrder:e,disabledOptions:s,activeDevice:t})}}updateMiniStats(e){const t=e===up,s=document.getElementById("showMiniStatsButton")?.ui.class.contains("selected");t&&s&&document.getElementById("showMiniStatsButton")?.ui.class.remove("selected")}onSetActiveGraphicsDevice(e){this.preferredGraphicsDevice||(this.preferredGraphicsDevice=e),this.setDisabledOptions(this.preferredGraphicsDevice,e),this.updateMiniStats(e)}onSetPreferredGraphicsDevice(e){this.mergeState({disabledOptions:null,activeDevice:e}),this.preferredGraphicsDevice=e,this.updateMiniStats(e),this.props.onSelect(e)}render(){const{fallbackOrder:e,disabledOptions:t,activeDevice:s}=this.state;return g(Xn,{id:"deviceTypeSelectInput",options:[{t:LA[hp],v:hp},{t:LA[cp],v:cp},{t:LA[dp],v:dp},{t:LA[up],v:up}],value:s,fallbackOrder:e,disabledOptions:t,onSelect:this.onSetPreferredGraphicsDevice.bind(this),prefix:"Active Device: "})}}const IA=n.exports.Component;class RA extends IA{constructor(e){super(e),this.state={hasError:!1}}static getDerivedStateFromError(){return{hasError:!0}}componentDidCatch(e,t){console.warn(e,t)}resetState(){console.log("reset error"),this.setState({hasError:!1})}render(){return this.state.hasError?v(g("pre",null,"Something went wrong."),g("button",{onClick:this.resetState.bind(this)},"retry")):this.props.children}}const OA=()=>window.top.innerWidth<601?"portrait":"landscape",zA=n.exports.Component;const FA=function(e){var t="withRouter("+(e.displayName||e.name)+")",s=function(t){var s=t.wrappedComponentRef,i=pe(t,["wrappedComponentRef"]);return d.createElement(ke.Consumer,null,(function(t){return t||F(!1),d.createElement(e,D({},i,t,{ref:s}))}))};return s.displayName=t,s.WrappedComponent=e,Ae(s,e)}(class extends zA{state={orientation:OA(),collapsed:window.top.innerWidth<601,exampleLoaded:!1,controls:()=>{},showDeviceSelector:!0,show:"code",files:{"example.mjs":"// loading"},observer:null,description:""};constructor(e){super(e),this._onLayoutChange=this._onLayoutChange.bind(this),this._handleRequestedFiles=this._handleRequestedFiles.bind(this),this._handleExampleLoading=this._handleExampleLoading.bind(this),this._handleExampleLoad=this._handleExampleLoad.bind(this),this._handleUpdateFiles=this._handleUpdateFiles.bind(this)}async _buildControls(e){const t=new Blob([e],{type:"text/javascript"});let s;this._controlsUrl&&URL.revokeObjectURL(this._controlsUrl),this._controlsUrl=URL.createObjectURL(t);try{s=(await import(this._controlsUrl)).controls}catch(e){s=()=>g("pre",null,e.message)}return s}_handleRequestedFiles(e){const{files:t}=e.detail;this.mergeState({files:t})}_onLayoutChange(){this.mergeState({orientation:OA()})}_handleExampleLoading(e){const{showDeviceSelector:t}=e.detail;this.mergeState({exampleLoaded:!1,controls:null,showDeviceSelector:t})}async _handleExampleLoad(e){const{files:t,observer:s,description:i}=e.detail,n=t["controls.mjs"];if(n){const e=await this._buildControls(n);this.mergeState({exampleLoaded:!0,controls:e,observer:s,files:t,description:i})}else this.mergeState({exampleLoaded:!0,controls:null,observer:null,files:t,description:i})}async _handleUpdateFiles(e){const{files:t,observer:s}=e.detail,i=t["controls.mjs"]??"";t["controls.mjs"]||this.mergeState({exampleLoaded:!0,controls:null,observer:null});const n=await this._buildControls(i);this.mergeState({exampleLoaded:!0,controls:n,observer:s})}mergeState(e){this.setState((t=>({...t,...e})))}componentDidMount(){const e=document.getElementById("controlPanel");if(!e)return;const t=e.querySelector(".pcui-panel-header");t&&(t.onclick=()=>this.toggleCollapse(),window.addEventListener("resize",this._onLayoutChange),window.addEventListener("requestedFiles",this._handleRequestedFiles),window.addEventListener("orientationchange",this._onLayoutChange),window.addEventListener("exampleLoading",this._handleExampleLoading),window.addEventListener("exampleLoad",this._handleExampleLoad),window.addEventListener("updateFiles",this._handleUpdateFiles),Ja.fire("requestFiles"))}componentWillUnmount(){window.removeEventListener("resize",this._onLayoutChange),window.removeEventListener("requestedFiles",this._handleRequestedFiles),window.removeEventListener("orientationchange",this._onLayoutChange),window.removeEventListener("exampleLoading",this._handleExampleLoading),window.removeEventListener("exampleLoad",this._handleExampleLoad),window.removeEventListener("updateFiles",this._handleUpdateFiles)}get path(){return`/${this.props.match.params.category}/${this.props.match.params.example}`}get iframePath(){const e=this.props.match.params.category,t=this.props.match.params.example;return`${Za}/${e}_${t}.html`}renderDeviceSelector(){const{showDeviceSelector:e}=this.state;return e?g(kA,{onSelect:()=>Ja.reload()}):null}renderControls(){const{exampleLoaded:e,controls:t,observer:s}=this.state;if(e&&t&&s&&Ja.ready)return g(RA,null,g(t,{observer:s,PCUI:td,ReactPCUI:Yr,React:d,jsx:g,fragment:v}))}renderDescription(){const{exampleLoaded:e,description:t,orientation:s}=this.state;if(e&&Ja.ready)return g(ti,{id:"descriptionPanel",class:"portrait"===s?"mobile":null},g("span",{dangerouslySetInnerHTML:{__html:t}}))}get collapsed(){const e=document.getElementById("controlPanel");if(!e)return!1;return e.classList.contains("pcui-collapsed")}toggleCollapse(){this.mergeState({collapsed:!this.collapsed})}renderPortrait(){const{collapsed:e,controls:t,show:s,files:i,description:n}=this.state;return v(g(Fn,{id:"controlPanel",class:["mobile"],resizable:"top",headerText:"CODE & CONTROLS",collapsible:!0,collapsed:e},this.renderDeviceSelector(),g(ti,{id:"controls-wrapper",class:t?"has-controls":null},g(ti,{id:"controlPanel-tabs",class:"tabs-container"},g(Ps,{text:"CODE",id:"codeButton",class:"code"===s?"selected":null,onClick:()=>this.mergeState({show:"code"})}),g(Ps,{text:"PARAMETERS",class:"parameters"===s?"selected":null,id:"paramButton",onClick:()=>this.mergeState({show:"parameters"})}),n?g(Ps,{text:"DESCRIPTION",class:"description"===s?"selected":null,id:"descButton",onClick:()=>this.mergeState({show:"description"})}):null),"parameters"===s&&g(ti,{id:"controlPanel-controls"},this.renderControls()),"code"===s&&g(qa,{options:{readOnly:!0,theme:"vs-dark"},defaultLanguage:"javascript",value:i["example.mjs"]}))),this.renderDescription())}renderLandscape(){const{collapsed:e}=this.state;return v(g(Fn,{id:"controlPanel",class:["landscape"],resizable:"top",headerText:"CONTROLS",collapsible:!0,collapsed:e},this.renderDeviceSelector(),this.renderControls()),this.renderDescription())}render(){const{iframePath:e}=this,{orientation:t,exampleLoaded:s}=this.state;return g(ti,{id:"canvas-container"},!s&&g(lr,{size:50}),g("iframe",{id:"exampleIframe",key:e,src:e}),"portrait"===t?this.renderPortrait():this.renderLandscape())}}),VA=n.exports.Component;class NA extends VA{mouseTimeout=null;constructor(e){super(e),this._handleKeyDown=this._handleKeyDown.bind(this),this._handleExampleLoad=this._handleExampleLoad.bind(this)}clickFullscreenListener=null;toggleFullscreen(){const e=document.querySelector("iframe")?.contentDocument;if(!e)return;this.clickFullscreenListener&&e.removeEventListener("mousemove",this.clickFullscreenListener),document.querySelector("#canvas-container")?.classList.toggle("fullscreen");const t=document.querySelector("#appInner");t?.classList.toggle("fullscreen"),e.getElementById("appInner")?.classList.toggle("fullscreen"),t?.classList.contains("fullscreen")&&(this.clickFullscreenListener=()=>{t?.classList.add("active"),this.mouseTimeout&&window.clearTimeout(this.mouseTimeout),this.mouseTimeout=setTimeout((()=>{t.classList.remove("active")}),2e3)},e.addEventListener("mousemove",this.clickFullscreenListener))}componentDidMount(){const e=document.querySelector("iframe");e?e.contentDocument?.addEventListener("keydown",this._handleKeyDown):console.warn("Menu#useEffect> iframe undefined"),document.addEventListener("keydown",this._handleKeyDown),window.addEventListener("exampleLoad",this._handleExampleLoad)}componentWillUnmount(){const e=document.querySelector("iframe");e&&e.contentDocument?.removeEventListener("keydown",this._handleKeyDown),document.removeEventListener("keydown",this._handleKeyDown),window.removeEventListener("exampleLoad",this._handleExampleLoad)}_handleKeyDown(e){const t=document.querySelector("#canvas-container");t&&"Escape"===e.key&&t.classList.contains("fullscreen")&&this.toggleFullscreen()}_handleExampleLoad(){const e=document.getElementById("showMiniStatsButton");if(!e)return;const t=e.classList.contains("selected");this.props.setShowMiniStats(t)}render(){return g(ti,{id:"menu"},g(ti,{id:"menu-buttons"},g("img",{id:"playcanvas-icon",src:Qa,onClick:()=>{window.open("https://github.com/playcanvas/engine")}}),g(Ps,{icon:"E256",text:"",onClick:()=>{const e=new URL(location.href),t=`${e.origin}/share/${e.hash.slice(2).replace(/\//g,"_")}`,s=encodeURI(`Check out this @playcanvas engine example! ${t}`);window.open(`https://twitter.com/intent/tweet?text=${s}`)}}),g(Ps,{icon:"E149",id:"showMiniStatsButton",class:"selected",text:"",onClick:()=>{document.getElementById("showMiniStatsButton")?.classList.toggle("selected");const e=document.getElementById("showMiniStatsButton")?.classList.contains("selected");this.props.setShowMiniStats(!!e)}}),g(Ps,{icon:"E127",text:"",id:"fullscreen-button",onClick:this.toggleFullscreen.bind(this)})))}}const BA=[{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/clustered-omni-shadows",categoryKebab:"graphics",exampleNameKebab:"clustered-omni-shadows"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/lights-baked",categoryKebab:"graphics",exampleNameKebab:"lights-baked"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/lights-baked-a-o",categoryKebab:"graphics",exampleNameKebab:"lights-baked-a-o"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/particles-anim-index",categoryKebab:"graphics",exampleNameKebab:"particles-anim-index"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/particles-random-sprites",categoryKebab:"graphics",exampleNameKebab:"particles-random-sprites"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/user-interface/particle-system",categoryKebab:"user-interface",exampleNameKebab:"particle-system"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/xr/ar-anchors-persistence",categoryKebab:"xr",exampleNameKebab:"ar-anchors-persistence"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/xr/ar-basic",categoryKebab:"xr",exampleNameKebab:"ar-basic"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/xr/ar-camera-color",categoryKebab:"xr",exampleNameKebab:"ar-camera-color"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/xr/ar-camera-depth",categoryKebab:"xr",exampleNameKebab:"ar-camera-depth"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/xr/ar-depth-sensing-placer",categoryKebab:"xr",exampleNameKebab:"ar-depth-sensing-placer"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/xr/ar-hit-test",categoryKebab:"xr",exampleNameKebab:"ar-hit-test"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/xr/ar-hit-test-anchors",categoryKebab:"xr",exampleNameKebab:"ar-hit-test-anchors"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/xr/ar-mesh-detection",categoryKebab:"xr",exampleNameKebab:"ar-mesh-detection"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/xr/ar-plane-detection",categoryKebab:"xr",exampleNameKebab:"ar-plane-detection"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/xr/vr-basic",categoryKebab:"xr",exampleNameKebab:"vr-basic"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/xr/vr-controllers",categoryKebab:"xr",exampleNameKebab:"vr-controllers"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/xr/vr-hands",categoryKebab:"xr",exampleNameKebab:"vr-hands"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/xr/vr-movement",categoryKebab:"xr",exampleNameKebab:"vr-movement"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/xr/xr-picking",categoryKebab:"xr",exampleNameKebab:"xr-picking"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/animation/blend-trees-2d-cartesian",categoryKebab:"animation",exampleNameKebab:"blend-trees-2d-cartesian"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/animation/component-properties",categoryKebab:"animation",exampleNameKebab:"component-properties"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/animation/blend-trees-2d-directional",categoryKebab:"animation",exampleNameKebab:"blend-trees-2d-directional"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/animation/events",categoryKebab:"animation",exampleNameKebab:"events"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/animation/blend-trees-1d",categoryKebab:"animation",exampleNameKebab:"blend-trees-1d"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/animation/layer-masks",categoryKebab:"animation",exampleNameKebab:"layer-masks"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/animation/locomotion",categoryKebab:"animation",exampleNameKebab:"locomotion"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/camera/first-person",categoryKebab:"camera",exampleNameKebab:"first-person"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/camera/fly",categoryKebab:"camera",exampleNameKebab:"fly"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/animation/tween",categoryKebab:"animation",exampleNameKebab:"tween"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/camera/orbit",categoryKebab:"camera",exampleNameKebab:"orbit"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/area-picker",categoryKebab:"graphics",exampleNameKebab:"area-picker"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/area-lights",categoryKebab:"graphics",exampleNameKebab:"area-lights"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/asset-viewer",categoryKebab:"graphics",exampleNameKebab:"asset-viewer"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/batching-dynamic",categoryKebab:"graphics",exampleNameKebab:"batching-dynamic"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/clustered-area-lights",categoryKebab:"graphics",exampleNameKebab:"clustered-area-lights"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/clustered-spot-shadows",categoryKebab:"graphics",exampleNameKebab:"clustered-spot-shadows"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/clustered-lighting",categoryKebab:"graphics",exampleNameKebab:"clustered-lighting"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/dithered-transparency",categoryKebab:"graphics",exampleNameKebab:"dithered-transparency"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/contact-hardening-shadows",categoryKebab:"graphics",exampleNameKebab:"contact-hardening-shadows"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/grab-pass",categoryKebab:"graphics",exampleNameKebab:"grab-pass"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/hardware-instancing",categoryKebab:"graphics",exampleNameKebab:"hardware-instancing"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/integer-textures",categoryKebab:"graphics",exampleNameKebab:"integer-textures"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/hierarchy",categoryKebab:"graphics",exampleNameKebab:"hierarchy"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/layers",categoryKebab:"graphics",exampleNameKebab:"layers"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/light-physical-units",categoryKebab:"graphics",exampleNameKebab:"light-physical-units"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/lights",categoryKebab:"graphics",exampleNameKebab:"lights"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/lines",categoryKebab:"graphics",exampleNameKebab:"lines"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/material-basic",categoryKebab:"graphics",exampleNameKebab:"material-basic"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/material-clear-coat",categoryKebab:"graphics",exampleNameKebab:"material-clear-coat"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/ground-fog",categoryKebab:"graphics",exampleNameKebab:"ground-fog"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/material-anisotropic",categoryKebab:"graphics",exampleNameKebab:"material-anisotropic"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/material-physical",categoryKebab:"graphics",exampleNameKebab:"material-physical"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/material-translucent-specular",categoryKebab:"graphics",exampleNameKebab:"material-translucent-specular"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/mesh-decals",categoryKebab:"graphics",exampleNameKebab:"mesh-decals"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/mesh-generation",categoryKebab:"graphics",exampleNameKebab:"mesh-generation"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/mesh-deformation",categoryKebab:"graphics",exampleNameKebab:"mesh-deformation"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/mesh-morph",categoryKebab:"graphics",exampleNameKebab:"mesh-morph"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/mesh-morph-many",categoryKebab:"graphics",exampleNameKebab:"mesh-morph-many"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/model-outline",categoryKebab:"graphics",exampleNameKebab:"model-outline"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/model-asset",categoryKebab:"graphics",exampleNameKebab:"model-asset"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/model-textured-box",categoryKebab:"graphics",exampleNameKebab:"model-textured-box"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/multi-render-targets",categoryKebab:"graphics",exampleNameKebab:"multi-render-targets"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/multi-view",categoryKebab:"graphics",exampleNameKebab:"multi-view"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/paint-mesh",categoryKebab:"graphics",exampleNameKebab:"paint-mesh"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/painter",categoryKebab:"graphics",exampleNameKebab:"painter"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/point-cloud",categoryKebab:"graphics",exampleNameKebab:"point-cloud"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/particles-spark",categoryKebab:"graphics",exampleNameKebab:"particles-spark"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/particles-snow",categoryKebab:"graphics",exampleNameKebab:"particles-snow"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/point-cloud-simulation",categoryKebab:"graphics",exampleNameKebab:"point-cloud-simulation"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/post-effects",categoryKebab:"graphics",exampleNameKebab:"post-effects"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/portal",categoryKebab:"graphics",exampleNameKebab:"portal"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/reflection-box",categoryKebab:"graphics",exampleNameKebab:"reflection-box"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/post-processing",categoryKebab:"graphics",exampleNameKebab:"post-processing"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/reflection-planar",categoryKebab:"graphics",exampleNameKebab:"reflection-planar"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/render-pass",categoryKebab:"graphics",exampleNameKebab:"render-pass"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/render-asset",categoryKebab:"graphics",exampleNameKebab:"render-asset"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/render-to-texture",categoryKebab:"graphics",exampleNameKebab:"render-to-texture"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/reflection-cubemap",categoryKebab:"graphics",exampleNameKebab:"reflection-cubemap"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/shader-burn",categoryKebab:"graphics",exampleNameKebab:"shader-burn"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/shader-toon",categoryKebab:"graphics",exampleNameKebab:"shader-toon"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/shader-compile",categoryKebab:"graphics",exampleNameKebab:"shader-compile"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/shader-wobble",categoryKebab:"graphics",exampleNameKebab:"shader-wobble"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/shadow-cascades",categoryKebab:"graphics",exampleNameKebab:"shadow-cascades"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/shapes",categoryKebab:"graphics",exampleNameKebab:"shapes"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/sky",categoryKebab:"graphics",exampleNameKebab:"sky"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/texture-array",categoryKebab:"graphics",exampleNameKebab:"texture-array"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/texture-basis",categoryKebab:"graphics",exampleNameKebab:"texture-basis"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/transform-feedback",categoryKebab:"graphics",exampleNameKebab:"transform-feedback"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/taa",categoryKebab:"graphics",exampleNameKebab:"taa"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/input/gamepad",categoryKebab:"input",exampleNameKebab:"gamepad"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/graphics/video-texture",categoryKebab:"graphics",exampleNameKebab:"video-texture"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/input/keyboard",categoryKebab:"input",exampleNameKebab:"keyboard"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/input/mouse",categoryKebab:"input",exampleNameKebab:"mouse"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/loaders/bundle",categoryKebab:"loaders",exampleNameKebab:"bundle"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/loaders/draco-glb",categoryKebab:"loaders",exampleNameKebab:"draco-glb"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/loaders/gsplat-many",categoryKebab:"loaders",exampleNameKebab:"gsplat-many"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/loaders/glb",categoryKebab:"loaders",exampleNameKebab:"glb"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/loaders/gsplat",categoryKebab:"loaders",exampleNameKebab:"gsplat"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/loaders/loaders-gl",categoryKebab:"loaders",exampleNameKebab:"loaders-gl"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/loaders/usdz-export",categoryKebab:"loaders",exampleNameKebab:"usdz-export"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/misc/multi-app",categoryKebab:"misc",exampleNameKebab:"multi-app"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/loaders/gltf-export",categoryKebab:"loaders",exampleNameKebab:"gltf-export"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/misc/hello-world",categoryKebab:"misc",exampleNameKebab:"hello-world"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/misc/gizmos",categoryKebab:"misc",exampleNameKebab:"gizmos"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/loaders/obj",categoryKebab:"loaders",exampleNameKebab:"obj"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/misc/mini-stats",categoryKebab:"misc",exampleNameKebab:"mini-stats"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/misc/spineboy",categoryKebab:"misc",exampleNameKebab:"spineboy"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/physics/compound-collision",categoryKebab:"physics",exampleNameKebab:"compound-collision"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/physics/falling-shapes",categoryKebab:"physics",exampleNameKebab:"falling-shapes"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/user-interface/button-basic",categoryKebab:"user-interface",exampleNameKebab:"button-basic"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/physics/raycast",categoryKebab:"physics",exampleNameKebab:"raycast"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/physics/offset-collision",categoryKebab:"physics",exampleNameKebab:"offset-collision"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/user-interface/custom-shader",categoryKebab:"user-interface",exampleNameKebab:"custom-shader"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/physics/vehicle",categoryKebab:"physics",exampleNameKebab:"vehicle"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/user-interface/button-sprite",categoryKebab:"user-interface",exampleNameKebab:"button-sprite"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/user-interface/layout-group",categoryKebab:"user-interface",exampleNameKebab:"layout-group"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/sound/positional",categoryKebab:"sound",exampleNameKebab:"positional"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/user-interface/text",categoryKebab:"user-interface",exampleNameKebab:"text"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/user-interface/text-typewriter",categoryKebab:"user-interface",exampleNameKebab:"text-typewriter"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/user-interface/scroll-view",categoryKebab:"user-interface",exampleNameKebab:"scroll-view"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/user-interface/text-auto-font-size",categoryKebab:"user-interface",exampleNameKebab:"text-auto-font-size"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/user-interface/world-to-screen",categoryKebab:"user-interface",exampleNameKebab:"world-to-screen"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/user-interface/world-ui",categoryKebab:"user-interface",exampleNameKebab:"world-ui"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/user-interface/text-emojis",categoryKebab:"user-interface",exampleNameKebab:"text-emojis"},{path:"/Users/mvaligursky/Snapchat/Dev/engine/examples/src/examples/user-interface/text-localization",categoryKebab:"user-interface",exampleNameKebab:"text-localization"}],UA=n.exports.Component;function HA(){const e={};for(let t=0;t<BA.length;t++){const{categoryKebab:s,exampleNameKebab:i}=BA[t];e[s]||(e[s]={examples:{}}),e[s].examples[i]=i}return e}class WA extends UA{state={defaultCategories:HA(),filteredCategories:null,hash:location.hash,observer:new nt({largeThumbnails:!1}),collapsed:"true"===localStorage.getItem("sideBarCollapsed")||window.top.innerWidth<601,orientation:OA()};constructor(e){super(e),this._onLayoutChange=this._onLayoutChange.bind(this),this._onClickExample=this._onClickExample.bind(this)}componentDidMount(){const e=document.getElementById("sideBar");if(!e)return;const t=e.querySelector(".pcui-panel-header");t&&(t.onclick=()=>this.toggleCollapse(),this.setupControlPanelToggleButton(),window.addEventListener("resize",this._onLayoutChange),window.addEventListener("orientationchange",this._onLayoutChange))}componentWillUnmount(){window.removeEventListener("resize",this._onLayoutChange),window.removeEventListener("orientationchange",this._onLayoutChange)}setupControlPanelToggleButton(){const e=document.getElementById("sideBar");if(e&&(window.addEventListener("hashchange",(()=>{this.mergeState({hash:location.hash})})),this.state.observer.on("largeThumbnails:set",(()=>{let t=Number.MAX_VALUE;const s=document.querySelectorAll(".nav-item");for(let i=0;i<s.length;i++){const n=s[i],r=Math.abs(120-n.getBoundingClientRect().top);if(r<t){t=r,e.classList.toggle("small-thumbnails"),n.scrollIntoView();break}}})),e.classList.add("visible"),!window._scrolledToExample)){const e=location.hash.split("/");document.getElementById(`link-${e[1]}-${e[2]}`)?.scrollIntoView(),window._scrolledToExample=!0}}mergeState(e){this.setState((t=>({...t,...e})))}toggleCollapse(){const{collapsed:e}=this.state;localStorage.setItem("sideBarCollapsed",`${!e}`),this.mergeState({collapsed:!e})}_onLayoutChange(){this.mergeState({orientation:OA()})}onChangeFilter(e){const{defaultCategories:t}=this.state,s=(e=e.replace(/\s/g,".*"))&&e.length>0?new RegExp(e,"i"):null;if(!s)return void this.mergeState({filteredCategories:t});const i={};Object.keys(t).forEach((e=>{if(-1!==e.search(s))return i[e]=t[e],null;Object.keys(t[e].examples).forEach((n=>{const r=t[e].examples[n];-1!==r.search(s)&&(i[e]?i[e].examples[n]=r:i[e]={name:t[e].name,examples:{[n]:r}})}))})),this.mergeState({filteredCategories:i})}_onClickExample(e,t){t===Ja.path?Ja.fire("hotReload"):Ja.fire("destroy")}renderContents(){const e=this.state.filteredCategories||this.state.defaultCategories;if(0===Object.keys(e).length)return g(mn,{text:"No results"});const{hash:t}=this.state;return Object.keys(e).sort(((e,t)=>e>t?1:-1)).map((s=>g(Fn,{key:s,class:"categoryPanel",headerText:s.split("-").join(" ").toUpperCase(),collapsible:!0,collapsed:!1},g("ul",{className:"category-nav"},Object.keys(e[s].examples).sort(((e,t)=>e>t?1:-1)).map((e=>{const i=`/${s}/${e}`,n=new RegExp(`${i}$`).test(t);return g(Qe,{key:e,to:i,onClick:e=>this._onClickExample(e,i)},g("div",{className:`nav-item ${n?"selected":null}`,id:`link-${s}-${e}`},g("img",{className:"small-thumbnail",loading:"lazy",src:$a+`${s}_${e}_small.webp`}),g("img",{className:"large-thumbnail",loading:"lazy",src:$a+`${s}_${e}_large.webp`}),g("div",{className:"nav-item-text"},e.split("-").join(" ").toUpperCase())))}))))))}render(){const{observer:e,collapsed:t,orientation:s}=this.state,i={headerText:"EXAMPLES",collapsible:!0,collapsed:!1,id:"sideBar",class:["small-thumbnails",t?"collapsed":null]};return"portrait"===s&&(i.class=["small-thumbnails"],i.collapsed=t),g(Fn,i,g(br,{class:"filter-input",keyChange:!0,placeholder:"Filter...",onChange:this.onChangeFilter.bind(this)}),g(bn,{text:"Large thumbnails:"},g(As,{type:"toggle",binding:new dt,link:{observer:e,path:"largeThumbnails"}})),g(ti,{id:"sideBar-contents"},this.renderContents()))}}const GA=n.exports.Component;class jA extends GA{state={orientation:OA()};constructor(e){super(e),this._onLayoutChange=this._onLayoutChange.bind(this)}_onLayoutChange(){this.setState({...this.state,orientation:OA()})}componentDidMount(){window.addEventListener("resize",this._onLayoutChange),window.addEventListener("orientationchange",this._onLayoutChange)}componentWillUnmount(){window.removeEventListener("resize",this._onLayoutChange),window.removeEventListener("orientationchange",this._onLayoutChange)}updateShowMiniStats=e=>{Ja.fire("stats",{state:e})};render(){const{orientation:e}=this.state;return g("div",{id:"appInner"},g(qe,null,g(je,null,g(Ge,{exact:!0,path:"/"},g(Ne,{to:"/misc/hello-world"})),g(Ge,{path:"/:category/:example"},g(WA,null),g(ti,{id:"main-view-wrapper"},g(NA,{setShowMiniStats:this.updateShowMiniStats.bind(this)}),g(ti,{id:"main-view"},g(RA,null,"landscape"===e&&g(_o),g(FA,null))))))))}}!function(e){if(!e||"undefined"==typeof window)return;const t=document.createElement("style");t.setAttribute("type","text/css"),t.innerHTML=e,document.head.appendChild(t)}('@charset "UTF-8";\n@font-face {\n  font-family: pc-icon;\n  src: url("data:application/font-woff;charset=utf-7;base64,d09GRgABAAAAAFe8ABAAAAAAkpQAAgAGAAAAAAAAAAAAAAAAAAAAAAAAAABGRlRNAABXoAAAABwAAAAcmOY/h0dERUYAAFeAAAAAHgAAAB4AJwFKT1MvMgAAAeQAAABIAAAAYGMzR5FjbWFwAAAD9AAAAvUAAATMmjjXC2N2dCAAAAjQAAAAAgAAAAIAAAAAZnBnbQAABuwAAAGxAAACZQ+0L6dnYXNwAABXeAAAAAgAAAAI//8AA2dseWYAAAtgAABFbQAAcSyy4jYsaGVhZAAAAWwAAAA2AAAANhwPlXBoaGVhAAABpAAAAB0AAAAkBLECjWhtdHgAAAIsAAABxgAABOC8sUYpbG9jYQAACNQAAAKKAAACirC/lY5tYXhwAAABxAAAAB4AAAAgAm0BNW5hbWUAAFDQAAAB5gAAA7qBUhuJcG9zdAAAUrgAAAS/AAAMqrdz1d5wcmVwAAAIoAAAAC4AAAAusPIrFAABAAAAAgGJz34Mwl8PPPUACwJYAAAAANthcGQAAAAA3zfh6v/Y/4gCfgK8AAAACAACAAAAAAAAeJxjYGRgYIr4rwcmb/y/xVTHABRBBow6AJPwBkEAAAB4nGNgZGBgdGE0ZBBkAAEmBkYgFgOKMUAAAA82AKYAAHicY2BhCmecwMDKwMHYxpjBwMCgC6UvMRgxbAHSQCk4YGRAAqHe4X4MBxgUnlgyRfzXY2BgigDqgaph1AHyGBgUGBgBJjYLZXicjZS9SwMxGMZjKOIkUkSqaJHSFiki5RCppYiWIuIHai1ygzqUIg4iUhwcpDiIg6OTiP4H4ixFxNHB0cHZwcFBHBwUxPjk8pwNB0rv+PXN5d6P5HnTa3kX5roTQroe/aAkXfUBWwRroAx6wCCocm4ZZEHG+HvkwBjj8qAAjsEOfdNgA7SBJEgxvkybo+80c0xx3AsmWSP+B4fg1rI1ULeszrcO9kkywHiAYP6gv57b5dpsQtDuE1ZSq22wZzRT39SxnYRJh4V+joBOyy9N7X2fjKmvvhrx6tUgzsAVWGGPFqhjwcqfZL4VvtNjF1Sot02NepQYG9TliPvUum+Be+ZEL9ULrMPcIeqja89yD0ucO+WZqDIW9dQT8w9g/EY9h6mFjhlhnjg11ZodSHP+Bmj7pDnPUdaNMTZqzUet960mTj2a9XtrmWXfwqaHniZ51vTr+nSRnn+I0Maou96HPtsp2fg/6D0WadPUz2Uvjhk3xHXH2NsmUM+sN9wEvt8DOAHX5MJa1184FnX294bxl9Kc7UWsR8GOgm5qos/jPDgHc9L9/SYJ6RjrXWMiISY4liIuNmGz3tMqqIgZ/DqiiDvxA7ZVzBQAAHiczZNXdJRVFIW//ScEhjoBEhjqhBIy1KEzoQ3FEgUcu7FgRFRiwYhYYo1SNNhiJ4piL7H3BlgBFQWsoCBy7/3tHRW74yU8+qgPnLXuPfe8nLX23t8Fcth5uiB2PFf5SY1zbk6D77uTpgl5xE3MJEzKlJlyU2mqTa2ptxEbswmbsmW23Fbaaltr613ExVzCpVyZK3eVrtrVuvowEhaExWEqm/X74ibfxE3SpE3GVJgqU2PqLDZq4zZp0zZjK2yVrbF1Dhd1cZd0aZdxFa7K1bi6kDAaFoXJbDbr+O+1Q+VkDuBYzmQRS3iQF3ibkO1qpk7qr3HKaIbmaqEWq0HLtFZbtS3IDQqDkqA0mBJMD2YFc/yO3EZ/mtKMCM1pQUta0Zo2RMmnLe1oTwGFdKAjMTrR2TvblW50J04RPehJL3pTTB9KSNCXfvRnAAMZRJLBDGEowxjOCEYyihSljGYMYxnHeJ/LBCYyyWvYzae0B3tSxl7szRSmMo19yLAv+7G/V3ggB3Ewh1DOoRzG4RzBdI6kgqOYwdHM5BjvwXHMopLjOYETOYnZnEwVpzCHU5nLaZzOGd6las7ibM7hXM7jfGq4gAuZx3wWsJCLuJha7+MlXMplXM4V1HElV3E113At13E9i6nnBm70Tt/EzSzlFm7lNm7nDu7kLu7mHu6lgfu4nwd8Fg/xMI/wKI/xOE/wJE/xNM/wLM+xjOWs4Hmf1ou8xMu8wkpWsZpXeY3XWcMbvMla1rGet3ye7/Au7/E+G9jIB3zIJjbzEVv4mK0YLM4n/gmf8hmf8wVf8hVf8w3f8h3f8wPb+JGf+Jnt/MKv/Mbv/MGf/MXfZIWkQDnKVRPlqamnJqLmaqGWaqXWaqOo8tVW7dReBSpUB3VUzHPVWV3U1cPXTd0VV5F6qKd6qbeK1UclSqiv+nn2BmigBimpwRqioRqm4RqhkRqllEo1WmM01tM5XmlN0ERN8tvyduLciHXgr+DfrOf8D19mV65/AG767ecAAAB4nF1Ru05bQRDdDQ8DgcTYIDnaFLOZkALvhTZIIK4uwsh2YzlC2o1c5GJcwAdQIFGD9msGaChTpE2DkAskPoFPiJSZNYmiNDs7s3POmTNLypGqd2m956lzFkjhboNmm34npNpFgAfS9Y1GRtrBIy02M3rlun2/j8FmNOVOGkB5z1vKQ0bTTqAW7bl/Mj+D4T7/yzwHg5Zmmp5aZyE9hMB8M25p8DWjWXf9QV+xOlwNBoYU01Tc9cdUyv+W5lxtGbY2M5p3cCEiP5gGaGqtjUDTnzqkej6OYgly+WysDSamrD/JRHBhMl3VVC0zvnZwn+wsOtikSnPgAQ6wVZ6Ch+OjCYX0LYkyS0OEg9gqMULEJIdCTjl3sj8pUD6ShDFvktLOuGGtgXHkNTCozdMcvsxmU9tbhzB+EUfw3S/Gkg4+sqE2RoTYjlgKYAKRkFFVvqHGcy+LAbnU/jMQJWB5+u1fJwKtOzYRL2VtnWOMFYKe3zbf+WXF3apc50Whu3dVNVTplOZDL2ff4xFPj4XhoLHgzed9f6NA7Q2LGw2aA8GQ3o3e/9FadcRV3gsf2W81s7EWAAAAuAH/hbABjQBLsAhQWLEBAY5ZsUYGK1ghsBBZS7AUUlghsIBZHbAGK1xYWbAUKwAAAAAAAAAAACgAKAAoACgATABgAJwAsgDIAPABJgHSAe4CAgIQAiwCQAJuAogCqgLcAvwDLgNYA2QDfgOQA9wD6gQ4BHYEuATKBNwE+AUkBUIFagWgBboF5AYGBh4GQgZkBoIGrgbcBwYHPgdKB1gHZAdwB4IHlAemB7gHyAfaB+oH+ggcCDwIXAh8CJAIpAi4CMwI9AkeCUYJbgmOCa4JzgnuCgQKFgo+ClwKtgryC4oMHgyODLQM1g0aDTANlA3kDggONA5UDrIPIA9oD+AQUBBoEJAQzhEKETgRWhGsEdoR8hOiE8QUKhRAFHQUphS2FMYU4BT8FRgVOBVQFXoWHBZWFnwWqBbcFvYXDBciFz4XWBdyF4wXnBe0F8wX5hgUGEAYbBiYGKgYuhjKGNoY+Bk+GWYZnBpCGxwbPhtsG4ocEhwyHIIcohy8HTYdih2yHdQeCh4uHlAejh9mH4YfqB/MH/QgCCBWIIAgmiCmILog3CEKIT4hWiFuIaAhyiH2IiIigiLKIuIjOCNyI5YjrCPoI/4kFiQ+JHQlIiVAJVQlYiWGJagltiXMJeQmBiYaJjwmaiaGJqwmxCbWJwAnNidiJ64n9CgUKEooaiiKKKwoyCjsKQYpIClMKXgpyioUKjYqVip6KpYqyCsEKzIraCuQK7Yr5iwILDIsTiyYLMIs1Cz2LSItTi2ELawt3C36LiAuOC5YLmoufC6WLqIuti7ELtou9i8WLz4vWC96L5IvtC/IL+Qv8DACMBwwKDA8MIQw2DEUMTIxXjGMMfQyVDJqMoAyrjLqMzAzUjN+M6wz0jQCNBo0TDRyNKg0xjT0NQo1ODVINWo1xjX2NlI3XDeGN7g33DgUOEI4cjiWAAB4nKW9DXhUR3Ygek919+0ftfr39r2tVtPqP3W3Wk2r1b9CiEYIIcuNLGtkjUbWYJmRZSzLslbRMITlI4TBLCEehsHEn0II8SqEITzCer2O149lCXF4PIcQwnr5CB8fy+MR4o/w8fH5Oc4sj3XM7XeqbrfUAjyZ3XfV969u1alTp06dOqfqVInTcHjAL8hpTsXxnJ4zcmaOs/qsPvBJKrsKrFq7Sgu/kI1wRD5x/Pzx47Dv+J7jx8npR53k7aJ8hStyRZmAzB6LCIrzFi+RNrjHSRxXH3CktOFUJuAI5xx4y0kYkJG0cH5z38zMwNaNG7cOzMz0bd648UzFM/2GcAY4NeHhI8SJw3QZKRdOOcIXOk91fN15qrOr41TnQzw5UnxY/IKMwEXOzoUxJuaWzmVTyTrQhkMBP78EUvWClg/4myAnialkdgVQNNaPd3Q988oLK11Rd3Oma6wLBrpWv/r8anfMFW9d80rnhvHOdVv5HzzbmRBbxOCra3j1q6u76LP/lTXqrVspybj+4tfwED7mDJhrqXwZn/Xh0aPHHkDvutE9e0dPDMlHGXm5keLXRK3EBYUEGUriEw+OHT1a5KAXRk6M7t0zCsNYC6PFrxDuZc7CCZwT46dDrBSZNJZKxAdNJoUQUg54uOnY5ulMOJSdkiemT06BbmDTJvyFstnQprmNeNC8VZyL85B2OMBVcQ7Oh/CSomSCgD8UzoM9mU1TIgliLik6BKRSCLOB2Mu/6/H87ssjs3h9KbN2bSa1dm3Kt3SpzxuLwYHxge++/vp3X3hd/rQwXsDfhZhX+cZZuVjxBonBDU7LVWN9uDg/F+GWckmuhctzq7lurpcb5NZxo9wEx9mSosD7Q+kcr+W1yyEUDoUdYV6byuaymlDYA5IoafA1nUvhNSOlwwFHTpRSobAmlAmIEn3OSFlkLUwR4LUaUYoDwkiJmBA/5DBUYl9McPbK7OyV2S/9zipV97hB7fSPLg9kbUQHpoYMqdYQm3zOruo1ePSqka2G/mle3aOyymcMvSr7gEo7MGNY96FV1aPm5UuNGWJS28HLG5x+r9+pNnR3pBqzYFeb4MYszWRC32w2O/lm/VBPTSrCG1qygsrO8xFPKBKKBKO9vaFIb29NJuY/3RiIe3t9S3t7I6Fefyzt8iyzqxx8jFgszfrhYX0z7+qxLyMx3sHqcKZ4B76COWyhBs5E25U2E7D6NMgHWjzhq3PDo7BdPv/gwaftw8OwfioUWh8KUb7jTPA1HMe65+odAWRQyjjIOiNjhw6NHTpOL4fGMN4gdxzhmzAnzu5z+AbhkDwGpjHMm3CtxTskCJ/hN5QMGmRbzNuBZKdMmCFBWYR7l7vHx7snXHDvM3qf6GbpWjCdn6XTKuk0Dl+G+Gl8eRu4aOzubk7DDaC8UMPnGKsKc7BTuWHP5BBPyaHyqXzagD1lt6asKVXKPnBkcq5Lvh6BadkreoPeVtErwn6PKRQyeeQ2eLdbfgi68klxGCheRth3Gex5qFoESyF5Q/KNKOz30+T+mDwJ7zJatxWvETfDpxo5GjGnpHakaONGjkPRSNzy2xOwff3b8pX2KPgjo3B8okO+fD8i34AgbXNqLo8yyY0yiUcYAldL805pJW04hyIMryoqziStJpAL56Rc/mKhq6X7Ar127bvQ1d3SBetYUDdwLHD7pUJHtlueVAK7u7OdBSxbf/E64eAWp6NY2n1UpgQcWkkRRTlHP8S2br3fvn3r1i+w9XePTxR25DexW+s3rH46ircQx7NI8yXIHdj2wyEqYiQPUEyTuWyaClAtL0giTDYv721pme59IZPSx3ZGv8qG8MhmGoLBhg3+lmV/MN2S2pfbFZ0LhSfDIXZR6NCJtMzCBaQqpaWA0gcLrKI8hDTN5DQ5yUxyhG+Jt7bJBXAGP4PJkPzl2bZzrg0RGG1JtMrd8HFIfvdqqP1c21lPZAPy6n5OgM/gMJaAy1k1+yEvwN5PMXwjF4TPsQ4pr2MBkMyUuBJs2Na6rfy7UfFM5XIr50Ye3YNcyK0EGrm1Zes3LfLFy61bv2mVLzA6JZBOEbiGvUszpRMlDq/FxhSiWYTC2KayNKcsZS6RVitKJoc6mc1Qwe0Q4LbOmGhPGEMj9VXp9oRJ3d2tr0q2py3ekRD9UK1Fjh5oaxtoe99nx3d9VVeXvgofpCUjdeZ0e9Ko6+6u0ifak4JrpHVFY7StLdpIcR9HOjxAOmCbraedyQN5BvYiLTjsw3WcQHrhKGt7SquqwVr2cfVcA8rjZiWFBnm53JmUz0CmMoQ+U7nhw5P0PjpFuh7dh9tyR6u3xdPm3t8qz+3He4v8SSvwd6C9VYD9SfkyxEdalePd4aE2dgyUAijeIaRnFN7novjiAex1tJRUAUorFOHY/yAtkw7BRPA9h/1RnmTScK4pt32dJ+Ryhvxju5LR9tDmYDTo7jc2JBrg/cDkypffMQlBZyjkDAlV74wtf93fmYjZAjXNdeE6F+92hD3Lwx6kRhTbTBxuIlW8XAxrl/VA2aRqISfK8hI2AwUBqjAoyJH47LXZ2WvvWloNbq+7Lbm6KVoXiDjdTqfN4qqx2pzQTb/Pyrc9FovBaKoVwq76pmTS7zGizPiJtcZlsTlpd459IYc8t5/yHGANpCQqE08mYFA+DvvbFH1hFOv2IbZNHZX1VNxmkDcf7t6968JF4cCB+2fPYllaineJBy6V6piTAtYU+KjmlvG9v2kTisib4KenE+7It8AruzZT2BqUb1Q2XcInyhmOknRCie5jHQTgszZAGUDDuou2kzvgeHbHSfnD07MnszsgcnJHFsST6Z070xh0ev/J7S0t22lb31j8Btvf5DzPcXYEigIvoC3dN77zzv9d/sHkO++804snxYnnCpyROOGDCn6VFKxSyHuaCm6k90JvAbJysrdwU367t7ALRnvxOEEvx+mFQ42xv3gfdcf3FsGr5eq4QBnqYoiPP/ePdq/vHpV7Km/QOsaOo6PsOLaeHZhDN2cgNuRnVbmXoRgrZzdckLPKCesZeicofrS8BiL88vIu3Au9XVje7MK1osQnlBLTenUXL6Ke90UFTAbx8TLe2Ssf29e6t22ffHQvjOzbd34vOy7s24cpu4oPianUZ1Oeov0u/vkw3cOxng1yywYdXJMjkJfPHjlC+1cuATK8jXERf/DNqxi+JUCZFlmRKqqy/HnrwEAruAda5c/B3QrxWCwej38WZweVscHiFZLGPreK9mUgosJOe6NcNmmGsFbKwd2enuevP9/T03/FuaklOjoHB/qv9NPX/p73N2LAe4tgmBfDYCrSXSU2Xq7fLKWmEL9oa1ucv7Q4rSqHUh5FPsr1Siw6sqGWlij7hSqgyQ9bqPatfKK6xAJcKoEXQSZU90bVW1J6qQX8/vLUW2+deuv0aLRlY6wStvMt+sFKw5+ALT0dNu2SnoA8detJqMspGR6DWfd0mJr5nlUrVVBEgQ3OebJks09moyl/QhIxObeLm8a+vIv25fW+HHwmf3xk+iqGf8JlYRa203CwhmH2Kmq3Hx/hHk9j92l3QeEIdD2WJmeVPrmaxS80/jZuCK5CC5W39Yg6Wp/RzekTJ9IXN2aPH88qME8hHx+E3SwOVdMkCLGvN1hMJc42bhLh9LA4ORqpBOfat8ChWYUh/gScfozzAOPwVCenypoDPBcvXjs8c+LEzEb8voFLEIPyHahOhyI5j9+vwW4WgcHYzolwDU7ROKi30Ka2nX78gsZj39E2vYbyj+bBLPAUbGDwP8UYSKFQ8SpJoO5YxdmYRThv+9lzYarbQ2zywIHJqQO/98Pdu/fuhVsHJt/8vQNTkwfkXTMzhT6O6UWLYNSXAaCNqpFytM8iicWprleCfDy9ppwYMVFpJRQiAYhWJoiWgcEWhsJj6XPlxIhFfVhLxV1ocYobi7LH9O3FL4kIn7JxD8U+kXJElKNwVf54/YgFrh4/ePCJeFT/R/za2VeMg9EL60e4J+LZER7i0V6OAZ/K0afBoxoA0pzmi59pLCX7x9qiyHFBVMcVbTyZC6LOQq3nXCBH0j3lViaPsUb2l1cmZsrtrudl1iznjj8JjysDQz2fMC1IFNACh9kn0sLn5Ubev5AF94S8QJi2MkDEVF3SrbQpbXA+PRwqp4dnS0G/DMd5YIhpebwAjfs/fyJpbJ4ICzmUeTQJt9FmpjYStW6QR7QKq0qp8Mzzb4zTZG9MHTiEKM0i1PE3nu85MPXGvz/OPZFeDClDSyUYuYz2zIGeMoTO41FM9nwJwiFGoMfS1yv5lkGEAxLcoVkrMDCJv2cexNPyhwXcKQytIwd3FOQphBPHYbaMfQkBQHp+gukvMZuoooWS5MHJqYO//+bkwfNv/v7BqUlkTOA2cxG4BfuotR4s8QP8+uzrr8++Hnmd3qiO5y7OkTYionzTK9ZxzlqvsWpUUi6syoQd9YiTGyxgkb+8hoftGly5dq0dsnNz8oU5uLRly7ZH9+TNDx9ulrcp/OMuHkd4trK+QWUmWCVrvVVrhdhXX331SP4aQl9/8/aePfIHEEWDew+7Ylotw6WVCIiLCfs/LxdCjT6DhWamnxlFZ5iqzajEKv2VRumzHAFUKZhZg8EZM7VH8S0H+y1Dg5YN73bmhbbgOHwcbBXyXbZx+XaPqbfX0uPfZRsPwtfjtsGd4xss3f5OuOpJJj357ZGg29uzMf9hj9cdjHjyh2PuGP4GRzz5TaOjm/Ke9OjVfN4TLXRHSjraIcTZxnRvK2KNljdQAtaDZNWGrdi3OqScSkLcUOGnV9IqfyV/iSQ1yV/dvXsPDn7w4YcffLBr1+7dAwODMMMIOwfHd8tf7d4NJu/ExKWJCVD3vtfb+56QHE0mRymdDZwaafV90oi1RscAE1wbaq0D3HpuDK1IpZdnnby2UopXPGM4tXiZdUY/VagFi56/LTmmlfCELoNBkvD8A3uV2eEwV9lhq2CstturjUI+Hd3b0DzSueZledxg0NXqdTp9LfHr9fpanV6vq5WfFQwmcXGaQ3snuomgrzUIgqFWL/2G0WYzmgRHden+14l+W2eno69pzcsvL0Uw82BLTzcNgr2Kxq+ys/uzbneby4X00hf/R/EYGSOWEr2WcjluFfcc9yL3yq9CLU1FXxQWGXUYoeafvo1M85Chs0yoJwst735xZfvwcPvKF0ckCYthtVI6CUgGnSBQOlHaiiaDsJDkfAka4fRLaKQlesvmx8r+VytfZGAHBMForDhvVKMhXGUXDMrdvkbr0Vsseo9WYG2QFA+SF4kR268VebkB298qbq1id2jTbESEWfiUDv+TLDNPizt77qUa9zSkRnav7y/XoJv4KhhjMTPZTAsFhistLQ+bv2Pr6BC+09Q58vJzyCt6fZVLbzCwJ+Qawy1aTLNdMJXunYZarSBoaw0WNu76Cdq011HC2Gh/BIvbgarM15+3xg83LZvs7ZkcP7xlAPzL1kmtbdLwsp7JN+V/5/Hk3W6Ur9PFs3AX7lNtRe0PrYBsLg8rwUMkcQkIsOXQlFpnGwoEzImXbcb8VC8fsbX+blPcvmqutbaO71V0rq2Iz034BWfhmlBaZlcAG6/gEQCd28ghzehLIEOH7kJhzCTlwC+5bA6jpmDa3RJpqHG73ZGG34oEVthivKpqRSAS96Z7E053/FBNw8lQixuvGGlkRXOTWWVfN6LjeVuseYXH0xxotVQHgnEX4jHCmdC+PqmM7a4EKnOl3OEotF6fiw8P3rghn4tO9q2PU5yLcvESaUG7tIrrRApW6HkaRN0EkrgcktmVRNLybLxlJWRDTSQnifiABgdK6FAj4K38NQUnHDU1DsHtli9N8cRoIgZxu9GmUnV0u4nN6OJDRKVSdxRigq2gMwm61l7etNHI9xnM+ip9IQp7XYJjyRKHvfYWAcnk5FWq7u5dRF1tdx2utqrVHX0xQSxoxGp1vttoHDarDCZ+mOncruJdUkB9M4eUp7oIbd3pXJgOnGpLrZ2Nn+ZCmRCyPjJJiBVURJ6hrUArZQlZ0hjx1DUSXYunrdWb0MU8SxoblwTFOA8tDTUBVaOnroGE3NEWXYtja7Qt1lhnrXInE65qqycWa4u63Q5HdIWqXRWt9eC32ig+rog67B46tmUqnkH8vmZjrTZFo+XpoJpIh7CoHe0jhUfnSNtP/ZLkl4ZDA8fgaAdpOyHaLKJosR2Kr7/AxmwX4GixVSPX21FH1eKpZnVHqw5oV2oibV5ZDT9j4OSdx/ojO+BrmgEN/eY6ghQRtPzFhfXxA7SvtxXPkm54yOAaSxo3QqXDrj7S/egCyT76nBD58kBop7wuT7KuRzK+fslSU1ljQ12mGx6U8Krl0lwrt3IBjiZFDdRGcKRyAUeYTbKlspRlcnSOyDEvWrB+6IxXI2RSdbA4601ui2C3JsWPnAmXMy0Kvppae9pjxL5EMNl0gnVJzZ/bnM5OhmB7CcGDdo9jaqqzc6qr6/lknRgVTbxgMjuMOqfodh9VkNdxFsS9q4S7nUnK1dyzXG8F9ojoCgg4BOSmXCqZKZeEGkL0xOdvLUuoojBd84VpMdhCos3IT7hDAurOh1vS6RZUZbwujyXtNhqoyLToBJPH5d1tcblMiwp1yhAqdNt4k9/smBKdgihOZWsWlc2jKxeOny+bGvUMkfNwjXR8mZZL0tI5E189NU8DyhhUjhWFFkxbqqIcKyU+U9ShcN91Q76O2O8RsyL+Ct5Bj/OY1+Xyi16DVxyJi52I45fG24/kM7HYVDw+JIpDUx0dUz14CMNTVMeqxKcOeeS7i7FhZAxXtFakIBWemXScZNLlEIdAm6w//LQvIqulxfiO+11LzILWSslq4wVrrcs/4xTjglMw2c2Gqjqb4PFEjENOMWZ32i1Ws7G6zibmbaKxXJxdTq/LYEJmshhcdassfpNVzWuMRovFbraaeZ3BaFsUJlowaHG7UOhPdbsurm9xmSuY61sKhFxXMdi90ILCQolQIm0nC+WNMu4y8D2Ck5UIFa7qJXYpH7Ssq5NqfF6XVHcXmxBW4d5gtdVabbWXCzpkCPYULLzxyeKITq/XWVNXV8daU9aPxBCwr3Gi3OhFuUHLV1kq0osIdX+hIJQvQcf6F5AehVJbK4+DliSYND82i/0i4/VBGJBPQEL+7AQ8oE2Hsf/ReHw6Hp+hQ5NMrp4lnSW5FVmABdjqWDOk3VduBWgdLGD+PWdi0GA6IlKmcOoN8G5INEsSe/wYHs5nJ89F7GaLqFOrt3nfj0geSatSXwwxe6Eybzvn5oIV+Vf0pOGSrS1SbQStGUcp7w5/oilQ15TYGkz7A8n6LZcutVXkW+TiXn887q9raqsJ+NOh0Lno7ph/Iy1zovg5CcJN1H/tdH6gvsQDpZxYL2B3+JCSOQfsy61dm8usXfs3rQOt+Dsvvw/9YzcKkz09k4XRhmXLGqJtbfInnbcK2VOMnrHiN8QCF8uzBFij4XpJw2aH2QyxRY6a4IJN3gz75N3gkW+DRw2hjvG+oZ50eiyR4FAbsxQvky6ie2x838P50QqMcnEuyWXLc87K2LfEJFDAkSu9axw5jaNy4mvhLMnQh23O1v7WPW0Drc42+doO+RK+O1tFem2Lk2x88XHwcP/ZynfkVgv2o12oq1G+tdB+tLJF0vHDOmBDhIsFyfFWd1+fe5pdO0pM/W6rs7/f2cquXGlu/XPiRRrqSj1pjiGvRfyJV3a+13o9e7vghsJ7p0/v3bsXZTQdB0jDJazP/wF61DZDkGAeGA6lOinHpumsJq8NhakbRRNoRSmbk+h7gD5RNwr6md2p60guFPbzAYybRjUWFUwUIjSeKOEb/RpggASMm85mqHMHRkBwcWgCCgW/ZZJiikXC1Kl0KIOpBCmFVgOGY2gym6I5oCabSWUzAcyWdyQlrYkgSEQrkMmmMCoV4XihWnBKEiQTUEURtUU/zcYDEsOXzix6oA6oawivDYh2vGQzqKMlc5JghqwUxkiiI5uS0lgAzAYRQ5wp3AydnczmsOT+0JkbBw/eOAi6l3aq1GqTjqg0UEWqagxqtZrnTfYlNh0v6ER80woqXmevVlvURgOoQW0w1OvVgloNosbvJNVVoHfzoAMgYNbrCI2h0hMjAT2x8QRhoiw08GqzSm1Tq+lnUa0zsGguNSEYA/90RI0nT//oB6LGm1qFYTxR63jEoVrlt5gSfL5vsBXDCKbHCDwmsWtApzJXqQwqBKAjLpWmTm8glq4EURtJFUI2qW3k3SChgEwWC0YhVSo15qohpNqhNuoMPGjg0u+9OXXw4BSaN2+9hDiYjEbiMINJo1YbMApPMGXQFhMxG0FjU3n0qhoEDU6LyqIyBIlG0BiDpEaro4jpdCo9T4tHC6PDG6iNPM+QAxWGGXk1qdLoKFXwm4sWEf94HaYALLUOCUbwgTDaEMIA8GojkpcYkX7EpMZsCEmmERBoqXGgFkio1qjxG/RVSHadze+kgFVmu0o0dME2SliNisdYWK95m8pIi69WY5+FkLBwCFOn/weLTqc2CDpCZVrxm+J1MgL3sGWiPoSdsh7qUa2xK1Mm2MGqIYmdzMdJYyGEyrbXKYWI5dGXR6/Lp/ClBoU/prNV6C3Ub4pqiJUyI7hYAZzXXiSmPuW+VVGRyurVRei+77yJUkYt56lqm3Qb0eC1m+1o77pq/iju7DJV+6Kl3tziskvtQrV0DIPLXfe/RQU3Iph47JhNBufw8JSpohMXTNiJG01GVMIIyr47KJ/d2IPplDJYfeGMxCRdBEyfX3eRrPwgevMm2lXFL9CWHIdPsMwlfwCqzdIhfEXLzZVU3Tywvo7YQom1mT0je3YP7cusbQyQlY3Ndba1TfkhUFetimWeHZibG3g2E24364RYe6gh9b0VTE/CfIpfYz4naD71/3/y+ZJlMzk3N/l4NsAdKn4AZ0DGOuTqWScd2wf+rllUVT5kNuTJ4h04DOdL31P4feO90a1wW/Yocn0d0o3AZezVTHRsFXssK/XlYZMye07fv9+5adPHIuxJyELiSMfYWDudBRtEmHI5DRoNVqxtq0pJA7bTp+9/sXHjKbickDcm4L58V0mGuPRxBhQe+9lMfS5lpbOkYWtKojPO4+5t3be7tnpEuQChAfkT0eUSoX1gcpLi2M3xRIAD2PNYqL8lndmnEz4pSVsv+XJj7t7Jzunprqlet7zLAnkb/8Htwr59hdsf7B5T/Mk6OR32/2+zMWSu3hfO+SQNJoSH8pizFxK98oQROi26ozduBEdGGC8p7aKazqBqAsw0oh6RAasPkvOuIyLp6lvddCLRMYisdbdpdWc80dHRnkx0diaSGHKsM7F0dUc80UnpbMS2dpq0M72KjmI7UHOIciluBbeGe557kUM8YSlUQ7IM3B5WaeyqehX1imIDLhqRZhwO0YylcqCWBrIwDQbNR1NCRAwJYc8napXo9BEi8jcoxXj5a6+92uxw3/cDHzWAzhN1UgEomPTyPxpN5iqdqfoPbRYMsVp15w02t94Kab2DNziqq+Q/15tFowmO2Gzaar2g4ckWwaRSa3V2FcpU496RDSYLbzDwFrnlCPj3yuehZYd8+6jLaHG70mqt3uBQ8foqvRBwGy1OlwsDRCOvM9rr3S6X26PB79Uarc7pVC1xganKaBlyG0R7tcGG3BZicwtfzs8FOJiPEaept+IPwlbJbs1ZNQ5s98jB2tIdYvLXKKx5+e7ly8HL8o2t37C/9kk4Nzkpt0HroLxrADbLuwdgy+lQMjSE59bSHVtNrPgpicAXmKeR+cdiG/E50Hpe7A8Zg+3yBfjw3NAobJMvPHjw6SwM9coP9nR2wuh0MDgaDCpt7QR8Q+jInovpQkuAKgtmiBM6cJYWS/PdV09sUVUJPwiHrOnXBdNR5qlFTP/6u7qQa+XRVNrxzH9YGVii++5/pj5OAxzzBzmM/C2U/W1zFaOa0rz2LFWEnvRJaPXUiP4TvrjPH/OfqKuRfH6xpu6G0+9jj06/3yn6MchH7z5FVsS4dhKHzWwugctVKJR7J5OHDiUvs+uNycShQ4lJdsU2P8Tp4BuUgQba8qilQOdIfPCNvO6Dgwc/gCO6o4M7dwweYbJqjBPgS5h7PO6X8sZje/cegz3Cof5tW/sPMlwK3CDKhFHmM4mSDavE55DqUTBkUkRIyuNwICnfm3hvwxFdFxi7jK7uge7H0lUtpAujDCqnujitLqWJnzvHfXua+oo08u2ZgUWJfmmahLwBDibkyanPFqUBblvxJFwnPJvLD9gdKRV45k7PnT4Co/fl9/B7e1EmTjhDpZhd0uakcA615vad0f37oztPtLeDbero8PDRKePcnIL3QPErlLdnmA/v/Kw8CltYP37o0IYJ+Rfw4dcff3xOTre3s/g2LoF2/e4n63fbpuyJE9m77Ko4FmxW3AsWz5+6vsXfhA0oPelw8tW+fbue9Nio7ekrzDw51+uis5klwJIoBAWltWiZBaWFu08F431Kjk/CzZWBIuY26pqOkMMO6p8Wnn4KAO98VnC3EuMn4NrLQBFrNaOEmMyxoanc9FNhwIGn4Qvc29w0XEZdD/nC7pC0jvq3Dx+Gbri3fmTd+tP4fYbbBffQNqP+fXSYy04/Da8/BRfn5uRTZR+WKbgEdxlvZcK5DCrUhw/LJ6fKMKa4PXAH+3T8nkvlpJRqioHYMzcHrO++WLwHR1Fnot4bmfRyyLCVDiWn7BysE9PduaXx+GiHDiIJZ9+K+mz//fv9St7dqGMkYSNayRxQw46e8+6XYXrzo7EmUfkU8ECKjm+jbpknGULqrOYGr6kmXLe0YTnJ/6t6U9xtawpYjKgi6zP+zFoLv/L7q6e7wmCz+/Raa9isdbdGLLwqF3MsSXuN9TmdmnhCMRJPD7yaori0Fe8RG+pDNbRFsFUJFUO0ynhUOACxHbo1GepBlox1rHr5lZ/+9JXXflN9+/jS3NDmwVBn/ief/nTHuM1L5xruFb8gG+E9hFdPKfdtEDWBBWf4s5v49kS6pyed9eZXfnd427bhl3/IX4QPO1o68Hcw3Pz8xPPetpZtH23bNCI6Ozs7052dbEw3WXxEQshfee4Zrpcb4Ia5V7g3sPZL/jRaHjsRNJQxv2w4pMXGEUfTlJeYykB7GmoU++n8h+RR5xxCmM0qqdJhv0MrplCrSAfCfB2EtA4R7dJQAFPRbzx+y6UDPIYmw/QuJCG24d0frLXYUitdBqOQqO2qdfirUUFfkTIRvcNrMDlVGt5oMwAx2uoE29qXfyeFVhJQ24uoVSoLWotqtJTUaLpiKB9B85FQc1UHn+/f8J23nCpzl8umybRHXOFanVenM6FtVRt2RtszGhNGM9pEAlod7yYas1bLx80q51vf2bBfPoRGF8IzqNHkwnrnWR5qaqJhrlo1Nc3QlFKzca4h5AMO+T2JVHyVm+beZd4OqFIJ1OCnAwY8nc+ifxnlnqaTWviXJzls1/RPm003AVsDomhjzPBHeSfQJSEpajux2DyyAFPAHHyuZJ0hV0hpM+HpjCP9WwISW38iSkoqZaYOvuZtmmo0frXgcARdzmRuKSpdWDQ0IdFi5A1Oky1W7QkYcvUNPsGgbsdyokVqEpaEs06TFy1fJDYa57UOMR4S6qpVep36UEsIQkvcIbJBcAt2s0nYiqa4p3WpJEZqfWjvGqBa4zR4WyXUAyw8vhrhEG8ZSy3jeZVGAyZdlYaorDoTQdvU3eJMBC1mvdpgRMWO0h7tfJ2BiNSURwNXo0I7WMdGC2iImtaMmqd8cCfidodC7tpaOtGBFuGrehVaxUaMZ9QJKr26oDETPZiIgVdVo/Vt1vTQ/kldvE8GYA/aDyX/Lx+d1cTW5kP+r3fkyEA6KK8PptNBmAum5UPHO+nzl/RCbs2UfVbvkja4NT+OR71gsY9rpusCwjkN9nla6gUh5aQ903PTU4fxMjcNHxyemiPvvRefngbv0PjIyPjQ2LrxoaHxdWMf+9ev93vWraPyP4RIZpGnyn65KXtAE7ZLdl/Od+PosaPyg4G5gQvymQFoh8vy9RP7wbVfvrNf8UfuQbyMaB94UI7EuBbUmzYo1qkPDcUmks4l61RUrKwk2ZRoViXT/rKvuF/gqSpJFT0khoZamcrc4AoIsHD2mM6xmy+VrAjLwoyvQb4V9ap1RmQdE8/X+rweXo21q9EY1XssXsMO3uB95LJa3BaYtpmc1iqTrYXYTEYbcZoE8KbRDkfT3QoXzS0+7zKzQWfD9iboDEajQScQlcam6/Yq9oC3zWbaYbJY8PKZyVagY/QFNd9O7+282l59Gz9XW+lnG+rdLcVviAtuLvh2o0ZYr2HT32FUYeozxCXLQOSbn3zyCVqzsnwqFP340CcfuQ7eDJ1EXnmh+A/IkA9QaqaRjtjMsEVhsxQ8qhRrp1p/iFpEoXCc0NHDJGuSdLSPh83eOO83LUXzyyQ4TKDW2Koa6u2pSNIi1YtOj0qytPqF5XrNs842v0qlrdIbtGo4HFY11lul+D0xJFm0hqqgtZ2IDoCANzD8asTjJ85aVZIQrcFotUrMD+kOaUNdT4XanLk8cox9e86R0UqZMGl7dIt45YMDAydOnBh0Ee9YIplMjI4m1o8l0rQtHCx+BGeJTtHVFK3AkamGTPjg/v1o5V2DyLtENzDYP3js+MDx44PMTtAVr5N+2I42Qg/3fdprsElitg6HToyzh0ya0imZ02bZLDjtUcoT/vhK5/aXQ5LO/ifpDD+be5AUk5gNeiIZ4b34YMJo8gRW9bR2tYGoEapsdsMSuzE+lFy6Y+kJjUqvRdOSV+tQNltMRKe28CY17QIs/DWj02Y2G42CwQTbNx9oabK6kqjYCiqzWqfyemKr3pnwej8w6HjeQgUgpueN9Gai43cGE1FbzGab02ikQJR2NVO8C5+jzaj4F9ej1d1a9nufnyVUZgixzdNAZZqQfrFrwyqfKhcIp3IBKWWGJgjUwQkRD+dWoV3otVicTjzf9TtbZw/4YWbYeEz9gfqOcY5PptVx3Qgcdzq78Bd3OuN+l8tPn8VElzwejaK9eX5PMr63zWiMFFxsjAPbvw3tTDW1MesXcvbN5wx3T5+KwoVpy2X1dV6+bTnHt+fVrbqNrmQSrshbP2htPdFjscWHvUznase6dsJO5gVIJVtKK60EFET0D77iXVdPC7266Z0W+YwFOg3yKRvsv+je19W1PhKJDPcne+kY4+3iVTKN9gP1JK+jIy90MVsuHAj7JLrqSysFwiuBTgCpUIL6pE/29LUNth3tB9ced8uMe3qm5UTbUO/9kbYOcA2M7+2N4de+ve7szLR3quVEy/DZw/KdddnOXk7xh7+MOuJ5tnqN0wTC2oA1FU5JiHdKhe0dVVKSPNPd/cn+ienpqU2Te3vlvX0Tk/GeHnh7cmZmUj5/587EBPJ4pHiTJGCi7C1IvV0RhsOXCae0gRQ+ksSjh4mZfhi/urF/5sP+mT5wy2dhXaL//pfKygZV8cviJbIBfsGZsKU0IP2YUleyp1MOTTKbCyjTbnFQRoJy9JryZQjn+0n/9OHD0/0/8W2QDzV/z3U4ls/HDru+1/z8D2f6UC8C2+bnXvqjX5s+/NJzl4eaGvJDbQ1NM719M9dRe0pQXwhSPE8GiZtr517jfsL9DtVKtA4hoEUFzuHXhlFhCKCaRmczUFlO0+kQNAIzoZUQprMGWMepbB3kUJlAiSak8K5FM5HpKMjYWlTwtCgqJIeWqhoYMSWl6EKycCYXFswgmahfDYIPhXPhFSRHZ12kHAUo0lR8yaAjPQYDGQh6ggSv6QhRBwd4J09HwTU2lb+f6Az9fuINDoQIiSWCA9oaQlRAFbygZTgEOlDp1wX9fvWwvjo4NBQkWlBpybDa7w+u01eHhodJUlTpSVa0iC1alZjNiqAlLSJvELO8Tkz/zGO3eyTwJ2KEhAbCtYT4+w060u9H+EStc6pptpF0cAA/u/FqMAwGNSLqHLykH+gMriNaFegxl1B1CQsaoCUUk2o9YoH9l9iCONGMVdoW1GV4ZxYVVzGpUiVFHZ8lQlyiOCi2TRrbSBaOsTWymrCVahDYRjL1yK9Z+YsvB8Cz6+B7n8i3d92LD/VC1LUunv0o3fbx+miPYuMmkO+jzHZjK1Hqw1rqh1lxJdFvZPmb8vlw27aB7dvvbNvWj9ft2/EZcXCjLpvHtkPnnalqmlUcfgXqyYRa64m2mEVXXR1rXdYUjd69E402wfmYxSIaYrHo5uidO3iJMVyyxXPEizZi2fes5FKIaFDu17Lp0lQGYq/+7GevBnxDw/s8dLL0Ltzdt+G1dwztk4XNG/Z9HIuNxmIKbXo4EzEhvPk1ZVYsjunA7Lu3bpuOHQP11avKOAUdHEsTC7a11L+43tFDnrLg8T5vSXemrb6xoCWLd1WhYFNnO7Om0JjaYdPST5pu+W8GV+aH8teW1OC70dDdrTPhQ23tWJTHqPrqQoFodZpkZ7LOOpZftZS226XYf7g4QjoJ96utm3KNDMKmR1cXrnBkHR6XR/D4jD4pde7E8nbAN09bv+Uk0UdXlRPeGxm5hOlGRigtd3It8AD1BWUN6k6YaYFLdzA8j7BccOOJ9dYbNn70Ef7YZSOVixgvQVrKa4wboGKNsZWtMU7IoxPw3sRB+ZO2BLRPwsWJvHwG1DH5NHQqujPLi/R+27ppTcW66fxHmz7slc/EYFa+43f6I8F2p98JX/lNsZjJL5vgTB9dulw+sVRLKE1IkrOgBlxeG5ybXxxcv3hx8KbU2u+tWbmyc+ilVa2G5MGkfLcztHRp48rlzZFI7L1Ix6qPV3Z2Lvvj9vcSp2NLtzXG47HfWBpTeI0a7XniUdaWN8Bja8vzj24Tz73emZneTcRzh942lfwgESvU1zyK/yFNxzwH2mh8eRCyGJv2HWpmA6SJ6Vdbhx261d+b77t1q78n3zt3s6cv3wvbWVAvxFngntt93W29cqcS2NvX1tOPefgxjzHS8S+scY51ZDu7ZDV0Rr6CozH53O3O255NcTjf0dIpE/gmJg8/jBUw0B/fRP3sWfm8v8wHT0N98NzEG5XT8OuKD96BA4XgJuKluioNvfig5IN34eRQ9G3m20fp1kJcCz4JlHZP80loeXQHWm8Fz8sP0Dg62+rq73dNsytxfW68KMd3VbokaFk9tiJciq8Nsc9wbdyqUs2UfPMyjzvn5b5lPhONfjozl1Qc2lof3UHbwoBYHHSZrRZLXDgixkQhIdg8Yo017jIaqLe3RWcz14qefdSTMd7j3yzvJK6gHIfLe2ymavvYWD4/1t6elJYIIcHI2112o050q02uWYUu/CK6zPuwVdLmV/RhW0S29xFL/HW6e93iAbfT6RHcBrcwGBXyJSK+H4mMRaN9gtA31tY21oWHrX9snr/L+FTisSiDEhTqD+Nh7cj7y/1hWG0EWBWkmB9M+RlPTS6swnJJTzmxGVLjpy+bLaTTYrbA7j3ZrPyLTZvmstmedJoGlR+ItzW6cPyi0C3frHhX1n/fQN36Lt2tpX5h5VkurLgwSaV5WFEoO9ZqpSx84mtu9vkT5HRtR3NzR+1pkvDTEK/zE0JOe3fgt2RzwMhvcCY6E84NvNGfTHU00weTeoMT8+Qxz0ES+6V70lzbNbxt27rd27btXrdt2/CubdtuVzzTb1S+s7XTF+b3pAG6J80nhYvdIBQuFrLd+GDBC/N7voa6yDb4/H9uX5rCTHdv3+RIhyfuzSzvneqFTb3d08Nd3oQn0dEzWZiZ6endrRsfKKRdbc7Iv3pOx09399Ln4GSPevduThlTvY39/KWKfWl8yDq/OHnypPwVTPdNHTo0eWZU3lEaC76N/RWLC76FfWkwJo1+B6Zh8szkoUNTUFqv04N2jAnu/Yt70xDTW6f+zdbljdG2LXJ+68UtYHzpxz9+accOunnBjg+248HgFWXOSNax/Ul+5b1pxv/Y5zv6+mtH8fra8u98Z/my73xnWTCRCAaaEnB8Zt1LP/zhS+tm5GN9G/vwd6MpQL/5EyhFqf8xnUfWsr7AhfmFuRi28xy3guvgnuGe4wbRDh/l3ljYm6Ze2ZuGKeylzWk0obD4v7Q1Df5Spa1pUI9ne9Ogfm+C//3ez39+7+egq6+t0vRtJFWq2vrJzmCbwQjJaJ63GA3yEYdqwOSvVo2/bRraojb0q+zye6YBlWMdVK3batpwzq7qr1LJH8TyGjNRm1V+W219sL5WZVD1da9obENjnZjhwc9pNj8ypq1WtZNPG0cHfZma2nSrk3fW1njjkUi8sXFwMBIfHDQ/s7Ths+b6pjA+DQ4ubRhsWFowelfU8DUqfVAbTBvHxoxpNDAGXW3aoF5Vw/hiBG00uh7g8f1pFB2V8NfGJuGYfIyuYrqeHBuDXVui0clIhPFgofg18tSZJ3Smsenjx6ePH6GX49MYr4M7gnkI5T1qOuCc3AbCNJOXruIdlH86tl6HExdU0QrO+c+3//APb/8h2Po3/eiFgU2bXHMz03Nz0zPQuqmf7pv0wo8Ww7E/CYfKpzKUnsnJA1NvzgOJTvY89+bUgUlaHifC6GBr2livjToksT26gsKH+bKWv2mVtaR0Hw6MgV3VFnmXi8QeXRmCrYqOQ+N2srh6ZURKWQtPOimw4+8Wkls/xQSH3u1ObvmUxhfnYZdGsCrXrpMOmupOId3dnSwUkt2FJKaV7+FLDwalC4U0txiGdsF/Ukkrz3yFSb7q7l6gk4F5pXLlmfJKap++dfjwrcML1D5M36FlgdaqRTBqnw5FLLXDx6BF2ST84zBH22gwxy3Gr7qiNbNVKiVY22e701s/JQYGRIdE3Prp4+Uqp9NU0LGUuh1JyKiG1xKMjd2Jbvz10OtjOFQtwJKQngqMg1+VEg50dZXWl5Tjz8dWYpbiPU6zmqfTTGJ7dzxGsfvvh3Y/Tq8bezYo9g8b+1TaTl2lV2g9mxOkamY6pEpmGRU88J9KLWBgk3qmpefApv6O1x07hvODrvVEh01hDpvE0I9eMLn3rt+5u3+TPNWTnzkwMRFr4Rbjz8b652uG5QQ0l0w6DGIZ+4FNQXA2r3rhR375bpnOCLwjAU6/PLVpYFWzfDdIbSF/8S5Jw0MsgwXhBriltC+R6LSmNpzV8viUztFlZ+FsWFsxb00nOcPUcy4HsZ62dH1TPJhuG6uvz4ZCcD4YxNt670s+r9f3ktdXs/LZ53Npf6KpHh5G0oItG/xoYCC9cv9KsvJn+XR//2GMNkLjjvxHTCkIzEaLYXnjbP8pM9YXG7+yo9QPYA9AR4PogJE4v3KI+qs6MMSHMag37P2GFaYe23jXjq5xS48xH4mvalq6atXSpr83rWjoGrcRYnt9TWRlNRwyrmh85nULxsQEu9a1t69rf7+hvbrH9vozGK3HnA8z3R81QBKC+xX7s6B1qKEjq9aAtR75MnsVXNeuXZPvXoX71A7EXlp+l5qEtLvWc8ilqLdd+F/dU6VrvIB/crryBqPj7PhgAzs+VG6IaxTrM4p0m8eV7TuGUr/8hyKTbmEl74St5dNJuM6+jv6O/qelZ7IWy5kqnVHCybP9d/o/78NkMtexAEbeSffoKd4jXrjMVjhr6ZgetgJmGFHj8euThrlkaNB9SPDsjtq2uBKht+cMJ9OhpHuLLbrbIxxyDYXYWBKd277IcDAoViEwWxBudqPRt/F+533/5gT0dae7ZBlfQonNTG70YzoDXGU6EWrICx5umrLnmw/i6cLaVObZZ8FaSJ/OdsPJm89mUs88k8p2n0kXns1kqTxJcJ0kBreZRw61qtJ5VY7quUOx17ZJloaO8TVXrtxe8+Ky7/dlvDD20UePpQGPGpkRTbZwDtRrxjsaLNK212JXrsA28Gb6vr/sxTXjNA3hhqj/IQkitkuUelIQZssQS2qhtmTRgywPQ18hmXo29sqazrHoQ9EruiA/nOx+JmWzrfnBaOdwf29bWy+TFQpcgTPOQ17QM8OlLBZBVmAOUvAP5xjk9q41r7yypqsr9eyzqa6B3tbWXraPBwfXsIw5jkvl0jmEmckqPuxU+FBdLxPKsZkUanyU3MfZZLAkYN7UkXwbNj5iVJlUNVbBoKoiIdVz9hpSY++JoP5mEHVenVGvoX7all4dIcyjmeiI0WgSpWp1taphzahbp6t9ZXWjCl8lwaKzqHW8gfp1g5b0sj3OOLgA59lOXWzVP1Z8mK37V/7KiKYXEOUVPOtAhE/VaqP3mteo5nW8Uec2Cjq1gUQK9lpEsRAiJoNgctsMXUaDhXehAV2tN6p1apPO5JSq1CYSb3+llmLXEQN7tcNp0lcbeSo/qAITrxh7K8mPhdGy2D6Yka9CVDlpsyLcli1bzm3ZcnbLFo7JILrZT+RJGAsyKH4JYpcuXZKvXML0n0IrCgd5HFrlT/EB5amH7Sf3ZeVepYpkkLS5sIY2Ti3JPrpLnJvlG/svHDwI+2ZnYwcPRIizc/b8gYO6/ftbDh7E1H6E0zoPh8HQg08DdLwBU8sxWCcfgX3yYRjBtPIIjKTlI5h/Z/EcEYiTYW8vrd+ne3ixndMCDupqja9U+3WwbWRyRJATE99ETlz5pgO2d0ROfPr2oD89Dtcf3SNiPi+KEx1yK3zqcrk+ensgmB7nnpJH4NvzsC9sc6d9PKfj/nTSn8Rf2p9+Sn4ym4inH/HHLeTrms+39peUje4H91h+x44qubS3O53j7TQXp9N5li7XeQrsX1ImqcI35/E83u+Id+DvKRk9oOEdnLLn4OK8FMmRoqOrCuY0K5qTAn1ivwJ+4kSbAjPSXgbKPQGP7pe2GJ5S09pyTSO0EyeOjKf9g2+XwOHv3fF0cODtJ2HVLsCqL7muait1dgWifBZBZtML1VkCTCE/VOovSevySfj2p8Cn+nwF3ONHK6Bdx9r6JTjOlzewMEhbUer3O2Od+Fso9vlynagegzkP0ZfKBOjwQSVGSvp2Sn1N8Q7XTyZhks3HUK5pKnlCst08tE2w2Lf2qc/50fiePXHYyG6fMf8Ws0mYoAtZHfgwTt9o6M31sT17Y6Ojsb17YuuVSOXI83dlXgZxcs/jVOmZuQifvSzDK+wqlnN7WibKvNU5EoSPqO5f1uk/vbh//8X9bfvpjekFC3EqbC57heavpHi49o031qJ5qqQEN3vpWfsGw70SRu3ToZRtrsXQIt3pdHf6cZgjaRr8GNyap8O1MzH1GNTpeMeu+ONQ5Sss+HF8674N7sJ+ZIuh7+3siHXQH3LhE3lcxS+l753cE7SRnp4Xta0W5/Hx9euPg77R/iS8b8N9frQj4FgMN7Z+fX5k5Amsz4/k6YdF/KB4rCyMlin7ycU27N+/4bV33lmNtNwdUwDt36EQ9jFeepqdq2ADfka+zk4qduEjBmSiRDR6ZXjQecoQg1W1UMp6LNh5BcaGMolKfs1P5WPpCUrcqKCAe77Y2FaucGOwEwTaVrgS5qBj7AmCwo/AHeC64DREyvuwIT10rOhdJc6icE5z3XAQQsq+QxV72k1VsE33Ii6haWZhlrvK9lylG7PNXr8+247hJ7hWOAZZBquiJGBkhWgtoY/6NZY9AqfLY0MJeAinZR0armyf2fK3irEhjCF3wnZ5exs+6Npge3meeiFu1UJsaofNp+i9Xk4jX7l+/cl01QvpNKwHm08JwV2dsemPysn7dnfGpz96Ir19Ib1UZhuk4jyUTxbIGCuDerfEOXHGPN9aDjpKMg+nb74cc8hB345DxczhfNpb7SMj7SPz6enLSDuj9aclGIvH1iK0Mg7s7sDytsKDPaWCEy45n2dZ46zspyOyAR58Vior/WGG39CSxuebSQlGtFy/82NrUZqjfICW8QZtIJXxnrbfNot/vVysG6USKXsPDsC7EKe8RWeBT10foLUO3EGuF85Agvmjs3qGfax6IVGuV+DOcH1wCNMqbWG+LiFWUYf3F9UdbQtz2BZusfzoqNb1WxR/4N5Ha/o45EttYR5z6GFI3yphrOaE4llSKK3rFx/fM+Jf3rGAbsFQqNgBQD7GtiTQ63ssnljFIsa8rVrKf/veA6Vli1iK7zAf5M+4Ri7FLX9sbkq7ILMpEtTyytINozHYDFJWiwgG/A7BV7rDH0eamyMNzcHVna7mBvpsNfa87lQT+NnPDIaNvab/nstlIZXN5t7Dz8lkJC31vSg10qeGZvXYT9wSbyDko4+0Jov10Cj5WSabzdCTzZkUkUmG4E+5MGJKdwFSVGgqdHyOheeUsnOIsqkzrQJqZfmo1uvL5TJvZuX/JzeVbWnJ5nJTR97EEPlUDqzZw5PZySweeMOvmTffzNAYeCB9lnFGUgfn5vdqs+bolmUS4B1+d/cfHzgg/8XuKKz8vvzZxArIt8l/BCt75L9QfBVqinfIamJ9bM9hxKaeuf5ZqRrIZlDrKbKZH8zehO5DXbcnZrtvAn/oNsQPPfP3hw79vfynExOzszdvYnB5nPcfyBpiYeNQKFEVXvMpXoRWxW/Qp/AgMtXLa9Y8C5auZ/Dokr98ds1euk8d7JS/6FqDRxfYutghf6Ho/euKf0F4OIV2b5pr5wooaZTdqZXtnxQff+TE5VBaMco2BEKuVLa8mt8utWIAZ8FH5gN/MuB2BxLdzcHafGOTNu4JJJMBT1zbtCriDiQzwZqaoBMarTV0Z2mnXGTvKyHp8yzVva/B2IlEYEmTRhXLu4PNwUAy6F7aqY95/EnYWuN3Ov33WTqbteY3Sw9YnueRYHr4T0irJqzLFdhUQ2HmdbswwKE4u1PfDuJnvvbpPDDveja+EJr3PaAbDcBfeRvCw71+n8lqNfm8DdGBaKNnic1qtb49ujTqqkkObmhcKrlcztgLosUiWnM52OKxWrx1/nAk1hgN+5dgVJu7rhETNsh/WVMTa8ikBpM1rmgsmWpsdF23GKsslirjx2+/rfTXf1Aswn9FuWhg+xI7fHSve5/jD2qh5pVX5H8A+LMG04vDZmW913OchtQSM/Wy5bhaWAlmIuWeW/+j/+OtpcJ/XEPM8nN//vyQvf5vV9A9OIu7sT0t+KAz7c/B9kb3Oeg+nlDa5ovOTpEheTX4//Wj+2iyXPmt3/ot6P8tNXwuuzcmEiQrr4fe733v9/H31VcK3y/AtpZ2YGdSjkNGWAImQIZZAWK2tHuH3ZfxUauYDD06hvn8wdgzqq71a9Twj8+MPfPM2Bjbz/tVItD8/s8m32q+rrGxjl/t+2FHU1NHk2xLEB4RmGO8W86XjjvT/evofzFAkqHG4lO2c6dukyJbA80EnAdSYR+bc/dRVCgGfiL4KR7+R/f9MOuKGLTLImcjLbyhocYOGld9vUv+59pgcPNEdzd8gZf/t1ay2iMtLRG7Vap9vz5djz+mM1TSt+xbTZdGWxkipdI+uoAEvbgJ2ic3syzxLQ+aF16Q/5n5Zzy1jhZ2flq8z3gFxHzFluNlwP3zO48v4Kbs84e1vlxlbSR0sj5APTpQhCxXVlQHqJfA3J49c3i+9trExGuvbdv2H/Ckz5tphondd3ebHt03mYhg2n13cd3T8d/S/5JQMDYDXTRNfYQWcJ3Y8Nd/veHnYJb/sYzoyiPrfg6fP7pP/58EMrWb7RtZzdbZcsp+kVKOKa5aeybsCOPpQ/seYl9++cUXl9b9VfCv+y6eHvR3wsHTxPbr8v+1eTMEXv9efL15NDIu/8nN+p/Ydi+5fPk7N2l7qedsJITymekm9XqoBoQK9UVsdgBycfv27TbAAhV//GM6c6/hVnE8keC/YUo6CsdsSTuqDGxNo0OTCqtybBgnWNLPV722Qf7ei61t8uHXUq/RB6j6blvbd9vA9Dd/88orr0xMrHpNvjY29vrrY200nHuMb9h+ZsC8n8r7mVGrT0uJB3+aqw9l6q2bfGtn4RYl5o+DS5Ava5fIf/bT6IunH2+H1cyb0lWCF1oEjwbRKiLVj/4Jtjb5fE1e++t1q3fB148uEacMUMQc/olU/xr4apx1dc4a+b/8tHH4NBzCz8kaGR7Hm/WT81y6qLZlL5yQB8o1nZZL85ak+DYZhJvKyAInClpg/yIHsqqsKOXyEKYb4sE/vZIscsk9Y0mA5vOrfzsxUg/BwGjwMtwc20O/vPLTZoCkfFsIpocCG4IB/18re8H+W2KBa2z1qWAiftSo7MQSbh/5wUh75EGzkFxaV7c0iboL4jFZ3A3XsQxm6ommCCrewYT/Ekg7rCwgY6WkgyvmV7a9YubfOPCG5vX9E2q8w2vehgav0ZiILFsWSRiN8r9rXr26WQs9+M5RIlUhfV5iNpRmKaCkuyJfgdjHf/Inf8wp/2/mLPHAUeb5Nv8fGnhadhORROLZe37v3vNXXogYq/ueC1RXg5O+7/3bFzqrqwPP9VUbK+WfA3WkDO3r7NSxRFmjkyv5mFAn2qeG1pdtaQ+U9sF9BLpa/4poXcpYU2vpS7YPLxt/IgR+u2H58gY8X9s6NLR1CAq1NcZUXXSFv1YH8WXD7cm+XU+EdCzvX46/5BBNovDpQYa34kchsHWRkjZMjQCm2Pgy9hTVj6nfvwPuTk//mvzbcHfniDwGNfX0mt/ZMtKy9demp+FvQy/hIV/53+SvRzBM0Wlewnr9Z4Qf4uJclkoVuzL5yDp1xfWq7HlV3rmTqTyh0oJZW/le0m7OGqvrYrF8zFYo2PAWq6s2fq+mDp+8NT1inSjWHRS9ougdo48iFDTx9qVLvUscqzvEJd6lS9vjmuf/Gx+txUdvbVR7fTeNK8kveiXJK8KfSfS13KY+Jo1wBvWW3+T+DPt/Zd6mOU9+xYmbRGnixhcozfjkSeppKVMiW/nnUFYPlv6EALtiiMAvAd6hCdAkqMkpSxGb2EpO5iNU2gsp+a2TR0lRet1GCF1D+EtmjwyG0uyR/NaaanxQaYBUEbvRrEUFbglpNdnxo2qJqlplQ0A6FQDGUOlthNfo1HqNCjP4L10sDl+lsvjVoEIgREfoKrJq4sf4xGZe5qFb7Fh5p07Lo2ECUBigiwZVal5LtxeqrjY7nWa1SbW0MOHR6Za80d2kMqnNTtGqs/G8tkqF4HVkYDldaID5qzWoK+v1VRZrFTGoPJmCg+8KqMxq0aHjVQa65hMTaLWgIVgyzBDwleiHhoiOoglVWqKz0UWKRIXJeb7GrDarIl28o5DyYvIqq9nIG9UaLC1doQpMJxjjPPDfofCYLzhTb3yZ8jxxmHa0GDabhH1UyijnWBIPKNDrbyTXJv89nknGZ2tRblixfZg4J/VprWdzFHQNVtIDbEKTrTFZQrfcV4a/rXJrIjGQSLyQTNSvCOR6P+h3+p235GMwtLb5hWb8rV0bzAefz60dHsjnFRm/oHPYmPWGWaAa5ENtIJCBMASIu+3RsfdG4dY/QdMK+Xca4c2/DL1HhtpkL3HL//UvWQiV58niKfgFvE9XOgO2Vzc4JMVvkrbZTMUOh+lSq4aPHda/+zuro6a+PlWv3GswBF/qodm4Q6VT7TDSlxq16i1jMB00vqVSs7gco3d/USZheGXRfh/Kf03S0tk7+t9iVHjSrWDo/4/pDy5bFnypBun+9dezY2Nj588nZ2e/H1i2LPASvEqrIZmUDydn8e/bYCs7eausKSvVvO0lLTxHN9w1loGPfE0hz84CzyDLv0+rdxlWLoI/n0yOsXpF/QZpvhL+rjSnXrFzHurcbNWc6IAk3VU5v+77f/Po7tCqO+0vfji0auXg9/KrhuSrHe0vvtjO/X8VDjc2AAAAeJx9ks9K3FAUxr/EUWeqDFVLV0IvtltDMpDgMCCFgYIIIkXrtjFNJsH8GTJx4mzadTdddtcH8B36EH2EvkA3fYJ+SU5TdaQJ9+aXe875zj3nXgDPtT40NM8LvBbW0EMhrGMdX4RXsIsfwh1saVvCqxhon4XXuP5TuIsnele4h6e6LbyBbT0W3kRf/0ZlrdPj32GdpWIN23gvrKOPj8IrOMBX4Q728Et4FR+0l8Jr2NO+C3fxTPst3IPSd4Q38Ep/I7yJXf0TxsgwxQI5IkwQsgMKtxwDmLCYVeGSVoVTxHBJY84p5pxnMIBxNl3k0SQs1K0amNaBulyo09hdjN107s7o8DfuCB4zpYxCZT/yspT4Fj6zXtc+OX/9yXXsEgbUNvk6GOEcx7jACWlZa/+hwsAwTWd0fnxxMmrT7LeyywLqoUAbpdqod/TI6RvVMere5kKuFaI2p82qbQa/Joa0J1S9YnzlFfB7w9Eo2BwOZ5t+DpP4+SzKUtUUEGYF9zBXlmEaljkcJe6VnxWBf+PTwTYc2x46j5Wz1I//NOHuSeLfmQFndVVJbaj646Jkgpj1B3UNOAuzxGWD3NKLoyDgSlm/Bm9So+3duyVeLYeyLI0p83jN3fCy5PHNtAF3LlLl/AeSi6f1AAB4nG3Te/zecxnH8d/r2mbMZsOM2QGzYdj2+13X5z7tYFZb5ZgK5VihpINISyiHTuQQ5ayodCCnjg5FiQ5OETqfqBxSUamIDtYDr/3n+8f9/ue+X/f3j+s5FEPPPauuHsqhF3hY/uzHUAyNIhjFaMawBmNZk7UYx9qMZwLrMJFJrMt6rM9kNmAKG7IRU9mYaUxnBjPZhE3ZjFlszmzmsAVbshVz2Zpt2JZ5zGcBw4yQFI0OXXr0GbCQRSxmCduxlO1Zxot4MctZwUt4KS9jB3ZkJ3ZmF3bl5ezGK3glr2J39mBPXs1r2Iu92Yd92Y/9eS2v4/UcwIEcxBt4IwfzJg7hzbyFt/I2DuXtHMbhvIMjeCcreRdH8m6O4miO4T28l2M5juM5gffxfj7AB/kQJ3ISH+ZkTuFUTuMjnM4ZfJSPcSZncTbncC7ncT4X8HE+wYVcxCf5FJ/mYj7DZ/kcn+cSLuULXMblXMGVXMUX+RJf5it8la9xNddwLdfxdb7B9dzAN/kWN/JtbuJmvsN3+R7f5xZu5TZu5w5+wJ3cxQ+5m3u4lx/xY37CT/kZP+cX/JJf8Wt+w33cz2/5Hb/nAR7kIR7mDzzCH/kTf+ZRHuMv/JW/8Th/5x/8kyd4kn/xFE/zb/7Df/kfz7AqhoKIGBWjY0ysEWNjzVgrxsXaMT4mxDoxMSbFurFerB+TY4OYEhvGRjE1No5pMT1mxMzYJDaNzWJWbB6zY05sEVvGVjE3to5tYtuYF/NjQQzHSGRUtOhEN3rRj0EsjEWxOJbEdrE0to9lY1ceesiKkZERN91ym9txu27P7buD5zeHXXtpL+2lvbSX9tJe2kt7Za/slb2yV/bKXtkre2Wv7DV7zV6z1+w1e81es9fsNXvNXsdex17HXsdex17HXsdex17HXsde117XXtde117XXtde117XXtde117PXs9ez17PXs9ez17PXs9ez17PXt9e317fXt9e317fXt9e317fXt/ewN7A3sDewN7A3sDewN7A3sDe4PleDg+7I2665Ta343bdntt37Y3Y00fqI/WR+kh9pD5SH6mP1EfqI/WR+kh9pD5SH6mP1EfqI/WR+kh9pD5SH6mP1EfqI/WR+kh9pD5SH6mP1EfqI/WR+kh9pD5SH6mP1EfqI/WR+kh9pD5SH6mP1EfqI/WR+kh9pD5SH6mP1EfqI/WR+kh9pD5SH6mP1EfqI/WR+kh9pD5SH6mP1EfqI/WR+kh9pD5SH6mP1EfqI/WR+kh9pD5SH6mP1Efpo/RR+ih9lD5KH6WP0kfpo/RR+ih9lD5KH6WP0kfpo/RR+ih9lD5KH6WP0kfpo/RR+ih9lD5KH6WP0kfpo/RR+ih9lD5KH6WP0kfpo/RR+ih9lD5KH6WP0kfpo/RR+ih9lD5KH6WP0kfpo/RR+ih9lD5KH6WP0kfpo/RR+ih9lD5KH6WP0kfpo/RR+ih9lD5KH6WP0kfpo/RR+ih9lD5KH6WP0kfpo/RR+ih9lD5KF6WL0kXponRRumi6aLpoumi6aLpoumi6aLpoumi6aLpoumi6aLpoumi6aN57896b996895arv+f/etfNu27edfOum3fdvOtWq3/n+3rXrQb/B6/IS40AAAAAAf//AAIAAQAAAAwAAAAWAAAAAgABAAEBQwABAAQAAAACAAAAAAAAAAEAAAAA3kztOAAAAADbYXBkAAAAAN834eo=") format("woff");\n  font-weight: normal;\n  font-style: normal;\n}\n.font-icon, .pcui-menu-item-content > .pcui-label[data-icon]::before, .pcui-menu-item-has-children > .pcui-menu-item-content > .pcui-label::after, .pcui-treeview-item:not(.pcui-treeview-item-empty) > .pcui-treeview-item-contents::before, .pcui-treeview-item-icon::after, .pcui-select-input-create-new > .pcui-label:last-child::before, .pcui-container.pcui-select-input-list .pcui-label.pcui-selected::after, .pcui-label.pcui-select-input-disabled-value::after, .pcui-label.pcui-select-input-icon::after, .pcui-infobox[data-icon]:not(.pcui-hidden)::before, .pcui-panel.pcui-collapsible > .pcui-panel-header::before, .picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .picker-gradient-footer > .pcui-panel-content > .delete-curve-button::after, .picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .picker-gradient-footer > .pcui-panel-content > .paste-curve-button::after, .picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .picker-gradient-footer > .pcui-panel-content > .copy-curve-button::after, .picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .picker-gradient-footer > .pcui-panel-content > .pcui-button, .pcui-button[data-icon]::before, .pcui-boolean-input.pcui-boolean-input-ticked::after {\n  font-family: pc-icon;\n}\n\n.font-thin {\n  font-weight: 100;\n  font-style: normal;\n}\n\n.font-light {\n  font-weight: 200;\n  font-style: normal;\n}\n\n.font-regular, .pcui-element {\n  font-weight: normal;\n  font-style: normal;\n}\n\n.font-bold {\n  font-weight: bold;\n  font-style: normal;\n}\n\n.fixed-font, .pcui-select-input-tag > .pcui-label, .pcui-container.pcui-select-input-list .pcui-label, .pcui-select-input-value, .pcui-label.pcui-multiple-values::before, .pcui-text-area-input > textarea, .pcui-input-element.pcui-multiple-values::before, .pcui-input-element > input {\n  font-family: inconsolatamedium, Monaco, Menlo, "Ubuntu Mono", Consolas, source-code-pro, monospace;\n  font-weight: normal;\n  font-size: 12px;\n}\n\n.pcui-no-select, .pcui-treeview, .pcui-overlay-inner, .picker-color > .pcui-overlay-content > .pick-opacity, .picker-color > .pcui-overlay-content > .pick-hue, .picker-color > .pcui-overlay-content > .pick-rect, .pcui-color-input, .pcui-canvas, .pcui-button, .pcui-label.pcui-selectable:hover, .pcui-slider {\n  -webkit-touch-callout: none;\n  -webkit-user-select: none;\n          user-select: none;\n}\n\n.pcui-flex, .pcui-gridview-radio-container, .pcui-gridview-item, .pcui-gridview-vertical, .pcui-gridview, .pcui-label-group, .pcui-select-input-container-value, .pcui-select-input, .pcui-overlay, .pcui-panel-header > .pcui-panel-sortable-icon, .pcui-vector-input {\n  flex-direction: column;\n}\n.pcui-flex:not(.pcui-hidden), .pcui-gridview-radio-container:not(.pcui-hidden), .pcui-gridview-item:not(.pcui-hidden), .pcui-gridview-vertical:not(.pcui-hidden), .pcui-gridview:not(.pcui-hidden), .pcui-label-group:not(.pcui-hidden), .pcui-select-input-container-value:not(.pcui-hidden), .pcui-select-input:not(.pcui-hidden), .pcui-overlay:not(.pcui-hidden), .pcui-panel-header > .pcui-panel-sortable-icon:not(.pcui-hidden), .pcui-vector-input:not(.pcui-hidden) {\n  display: flex;\n}\n\n.pcui-grid {\n  display: grid;\n}\n\n.pcui-scrollable {\n  overflow: auto;\n}\n\n@-webkit-keyframes pcui-flash-animation {\n  from {\n    outline-color: #f60;\n  }\n  to {\n    outline-color: rgba(255, 102, 0, 0);\n  }\n}\n\n@keyframes pcui-flash-animation {\n  from {\n    outline-color: #f60;\n  }\n  to {\n    outline-color: rgba(255, 102, 0, 0);\n  }\n}\n.pcui-element {\n  border: 0 solid #232e30;\n}\n.pcui-element.flash {\n  outline: 1px solid #f60;\n  -webkit-animation: pcui-flash-animation 200ms ease-in-out forwards;\n          animation: pcui-flash-animation 200ms ease-in-out forwards;\n}\n.pcui-element:focus {\n  outline: none;\n}\n.pcui-element::-moz-focus-inner {\n  border: 0;\n}\n\n.pcui-element.pcui-hidden {\n  display: none;\n}\n\n.pcui-input-element {\n  display: inline-block;\n  border: 1px solid #293538;\n  border-radius: 2px;\n  box-sizing: border-box;\n  margin: 6px;\n  min-height: 24px;\n  height: 24px;\n  background-color: #2c393c;\n  vertical-align: top;\n  transition: color 100ms, background-color 100ms, box-shadow 100ms;\n  position: relative;\n  color: #b1b8ba;\n}\n.pcui-input-element > input {\n  height: 100%;\n  width: calc(100% - 16px);\n  padding: 0 6px;\n  line-height: 1;\n  color: inherit;\n  background: transparent;\n  border: none;\n  outline: none;\n  box-shadow: none;\n}\n.pcui-input-element::before {\n  color: inherit;\n}\n\n.pcui-input-element.pcui-multiple-values::before {\n  position: absolute;\n  padding: 0 8px;\n  content: "...";\n  white-space: nowrap;\n  top: 5px;\n  font-size: 12px;\n}\n\n.pcui-input-element:not(.pcui-disabled, .pcui-readonly):hover {\n  background-color: #293538;\n  color: #fff;\n}\n.pcui-input-element:not(.pcui-disabled, .pcui-readonly):not(.pcui-error):hover {\n  box-shadow: 0 0 2px 1px rgba(255, 102, 0, 0.3);\n}\n.pcui-input-element:not(.pcui-disabled, .pcui-readonly).pcui-focus {\n  background-color: #20292b;\n  box-shadow: 0 0 0 1px rgba(255, 102, 0, 0.3);\n}\n\n.pcui-input-element.pcui-focus::after, .pcui-input-element.pcui-focus::before, .pcui-input-element:hover::after, .pcui-input-element:hover::before {\n  display: none;\n}\n\n.pcui-input-element.pcui-readonly {\n  background-color: rgba(44, 57, 60, 0.7);\n  border-color: transparent;\n}\n\n.pcui-input-element.pcui-disabled {\n  color: #5b7073;\n}\n\n.pcui-input-element.pcui-error {\n  color: #b1b8ba;\n  box-shadow: 0 0 0 1px #d34141;\n}\n\n.pcui-input-element[placeholder] {\n  position: relative;\n}\n.pcui-input-element[placeholder]::after {\n  content: attr(placeholder);\n  background-color: #2c393c;\n  position: absolute;\n  top: 0;\n  right: 0;\n  padding: 0 8px;\n  line-height: 22px;\n  font-size: 10px;\n  font-weight: 600;\n  white-space: nowrap;\n  color: #829193;\n  pointer-events: none;\n}\n\n.pcui-text-area-input {\n  min-height: 48px;\n  height: auto;\n}\n.pcui-text-area-input > textarea {\n  resize: none;\n  height: 100%;\n  width: calc(100% - 16px);\n  padding: 0 8px;\n  line-height: 22px;\n  color: inherit;\n  background: transparent;\n  border: none;\n  outline: none;\n  box-shadow: none;\n  min-height: 44px;\n  min-width: 172px;\n}\n\n.pcui-text-area-input.pcui-text-area-input-resizable-none > textarea {\n  resize: none;\n}\n\n.pcui-text-area-input.pcui-text-area-input-resizable-both > textarea {\n  resize: both;\n}\n\n.pcui-text-area-input.pcui-text-area-input-resizable-horizontal > textarea {\n  resize: horizontal;\n}\n\n.pcui-text-area-input.pcui-text-area-input-resizable-vertical > textarea {\n  resize: vertical;\n}\n\n.pcui-numeric-input-slider-control {\n  display: none;\n  position: absolute;\n  width: 10px;\n  height: 10px;\n  right: 3px;\n  border: 2px solid #20292b;\n  background-color: #293538;\n  border-radius: 100px;\n  z-index: 9999;\n  -webkit-transform: translateY(-50%);\n          transform: translateY(-50%);\n  top: 50%;\n  cursor: ew-resize;\n}\n\n.pcui-numeric-input-slider-control::after {\n  content: "\\e408";\n  font-size: 15px;\n  font-family: pc-icon;\n  position: absolute;\n  left: -5px;\n  top: -5px;\n  -webkit-transform: rotateZ(90deg);\n          transform: rotateZ(90deg);\n}\n\n.pcui-numeric-input-slider-control:hover {\n  opacity: 0.5;\n  color: #b1b8ba;\n}\n\n.pcui-numeric-input-slider-control-active {\n  opacity: 1 !important;\n  color: #7f7 !important;\n}\n\n.pcui-numeric-input-slider-control-hidden {\n  display: none !important;\n}\n\n.pcui-numeric-input:hover .pcui-numeric-input-slider-control {\n  display: block;\n}\n\n.pcui-numeric-input.pcui-disabled:hover .pcui-numeric-input-slider-control {\n  display: none;\n}\n\n.pcui-numeric-input.pcui-disabled .pcui-numeric-input-slider-control,\n.pcui-numeric-input.pcui-readonly .pcui-numeric-input-slider-control {\n  display: none;\n}\n\n.pcui-slider {\n  display: inline-flex;\n  height: 24px;\n  margin: 6px;\n  align-items: center;\n}\n.pcui-slider > .pcui-numeric-input {\n  flex: 1;\n  margin-left: 0;\n}\n\n.pcui-slider-container {\n  flex: 3;\n}\n\n.pcui-slider-bar {\n  position: relative;\n  width: calc(100% - 18px);\n  height: 4px;\n  margin: 9px 8px;\n  background-color: #2c393c;\n  border: 1px solid #293538;\n}\n\n.pcui-slider-handle {\n  position: absolute;\n  top: -7px;\n  left: 0;\n  margin-left: -9px;\n  width: 8px;\n  height: 16px;\n  background-color: #5b7073;\n  border: 1px solid #293538;\n  transition: left 100ms ease;\n}\n.pcui-slider-handle:hover, .pcui-slider-handle:focus {\n  outline: none;\n}\n\n.pcui-slider-active {\n  cursor: ew-resize;\n}\n.pcui-slider-active .pcui-slider-bar {\n  border-color: #20292b;\n  background-color: #20292b;\n}\n.pcui-slider-active .pcui-slider-handle {\n  border-color: #20292b;\n  background-color: #fff;\n  transition: none;\n}\n\n.pcui-slider:not(.pcui-disabled, .pcui-readonly):hover {\n  cursor: pointer;\n}\n.pcui-slider:not(.pcui-disabled, .pcui-readonly) .pcui-slider-handle:focus, .pcui-slider:not(.pcui-disabled, .pcui-readonly) .pcui-slider-handle:hover {\n  cursor: ew-resize;\n  outline: none;\n  border-color: #20292b;\n  background-color: #fff;\n}\n\n.pcui-slider.pcui-readonly .pcui-numeric-input {\n  flex: 1;\n}\n.pcui-slider.pcui-readonly .pcui-slider-bar {\n  display: none;\n}\n\n.pcui-slider.pcui-multiple-values .pcui-slider-handle {\n  display: none;\n}\n\n.pcui-vector-input {\n  flex-direction: row;\n  align-items: center;\n}\n.pcui-vector-input > .pcui-numeric-input {\n  flex: 1;\n  margin: 6px 3px;\n}\n.pcui-vector-input > .pcui-numeric-input:first-child {\n  margin-left: 0;\n}\n.pcui-vector-input > .pcui-numeric-input:last-child {\n  margin-right: 0;\n}\n\n.pcui-boolean-input {\n  display: inline-block;\n  position: relative;\n  box-sizing: border-box;\n  background-color: #2c393c;\n  color: #fff;\n  width: 14px;\n  height: 14px;\n  line-height: 1;\n  overflow: hidden;\n  margin: 6px;\n  transition: opacity 100ms, background-color 100ms, box-shadow 100ms;\n}\n.pcui-boolean-input:focus {\n  outline: none;\n}\n\n.pcui-boolean-input.pcui-boolean-input-ticked {\n  background-color: #b1b8ba;\n}\n.pcui-boolean-input.pcui-boolean-input-ticked::after {\n  content: "\\e372";\n  color: #20292b;\n  background-color: inherit;\n  font-size: 19px;\n  display: block;\n  margin-top: -2px;\n  margin-left: -2px;\n}\n\n.pcui-boolean-input:not(.pcui-disabled, .pcui-readonly):hover, .pcui-boolean-input:not(.pcui-disabled, .pcui-readonly):focus {\n  cursor: pointer;\n  background-color: #293538;\n  box-shadow: 0 0 2px 1px rgba(255, 102, 0, 0.3);\n}\n.pcui-boolean-input:not(.pcui-disabled, .pcui-readonly).pcui-boolean-input-ticked:hover, .pcui-boolean-input:not(.pcui-disabled, .pcui-readonly).pcui-boolean-input-ticked:focus {\n  background-color: #b1b8ba;\n}\n\n.pcui-boolean-input.pcui-disabled {\n  opacity: 0.4;\n}\n\n.pcui-boolean-input.pcui-multiple-values::after {\n  position: absolute;\n  font-size: 17px;\n  font-weight: bold;\n  color: #b1b8ba;\n  left: 4px;\n  top: -3px;\n  content: "-";\n}\n\n.pcui-boolean-input-toggle {\n  display: inline-block;\n  position: relative;\n  width: 30px;\n  height: 16px;\n  border-radius: 8px;\n  flex-shrink: 0;\n  border: 1px solid #293538;\n  box-sizing: border-box;\n  background-color: #364346;\n  color: #fff;\n  line-height: 1;\n  overflow: hidden;\n  margin: 6px;\n  transition: opacity 100ms, background-color 100ms, box-shadow 100ms;\n}\n.pcui-boolean-input-toggle:focus {\n  outline: none;\n}\n.pcui-boolean-input-toggle::after {\n  content: "";\n  position: absolute;\n  top: 1px;\n  left: 1px;\n  width: 12px;\n  height: 12px;\n  border-radius: 6px;\n  background-color: #5b7073;\n  transition: left 100ms ease, background-color 100ms ease;\n}\n\n.pcui-boolean-input-toggle.pcui-boolean-input-ticked {\n  border-color: #293538;\n}\n.pcui-boolean-input-toggle.pcui-boolean-input-ticked::after {\n  left: 15px;\n  background-color: #69b875;\n}\n\n.pcui-boolean-input-toggle:not(.pcui-disabled, .pcui-readonly):hover, .pcui-boolean-input-toggle:not(.pcui-disabled, .pcui-readonly):focus {\n  cursor: pointer;\n  border-color: #20292b;\n  background-color: #20292b;\n  box-shadow: 0 0 2px 1px rgba(255, 102, 0, 0.3);\n}\n.pcui-boolean-input-toggle:not(.pcui-disabled, .pcui-readonly):hover::after, .pcui-boolean-input-toggle:not(.pcui-disabled, .pcui-readonly):focus::after {\n  background-color: #d34141;\n}\n.pcui-boolean-input-toggle:not(.pcui-disabled, .pcui-readonly).pcui-boolean-input-ticked:hover, .pcui-boolean-input-toggle:not(.pcui-disabled, .pcui-readonly).pcui-boolean-input-ticked:focus {\n  border-color: #20292b;\n  background-color: #20292b;\n}\n.pcui-boolean-input-toggle:not(.pcui-disabled, .pcui-readonly).pcui-boolean-input-ticked::after {\n  background-color: #7f7;\n}\n\n.pcui-boolean-input-toggle.pcui-readonly {\n  opacity: 0.7;\n}\n\n.pcui-boolean-input-toggle.pcui-disabled {\n  opacity: 0.4;\n}\n\n.pcui-boolean-input-toggle.pcui-multiple-values::after {\n  left: 8px;\n  background-color: rgba(155, 161, 163, 0.25);\n}\n\n.pcui-label {\n  display: inline-block;\n  box-sizing: border-box;\n  margin: 6px;\n  vertical-align: middle;\n  transition: opacity 100ms;\n  color: #b1b8ba;\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  -webkit-user-select: none;\n          user-select: none;\n}\n\n.pcui-label.pcui-default-mousedown {\n  -webkit-user-select: initial;\n          user-select: initial;\n}\n\n.pcui-label.pcui-multiple-values {\n  position: relative;\n  color: transparent;\n}\n.pcui-label.pcui-multiple-values::before {\n  content: "...";\n  color: #b1b8ba;\n  white-space: nowrap;\n  font-size: 12px;\n}\n\n.pcui-label.pcui-error {\n  color: #d34141;\n}\n\n.pcui-label.pcui-selectable:hover {\n  color: #f60;\n  text-decoration: underline;\n}\n\n.pcui-label[placeholder] {\n  position: relative;\n}\n.pcui-label[placeholder]::after {\n  content: attr(placeholder);\n  position: absolute;\n  top: 0;\n  right: 0;\n  padding: 0 8px;\n  color: #999;\n  pointer-events: none;\n}\n\n.pcui-button {\n  display: inline-block;\n  border: 1px solid #20292b;\n  border-radius: 2px;\n  box-sizing: border-box;\n  background-color: #2c393c;\n  color: #b1b8ba;\n  padding: 0 8px;\n  margin: 6px;\n  height: 28px;\n  line-height: 28px;\n  max-height: 100%;\n  vertical-align: middle;\n  font-size: 12px;\n  font-weight: 600;\n  text-align: center;\n  white-space: nowrap;\n  cursor: pointer;\n  transition: color 100ms, opacity 100ms, box-shadow 100ms;\n  overflow: hidden;\n  text-overflow: ellipsis;\n}\n\n.pcui-button[data-icon]::before {\n  content: attr(data-icon);\n  font-weight: 100;\n  font-size: inherit;\n  margin-right: 6px;\n  vertical-align: middle;\n}\n.pcui-button[data-icon]:empty::before {\n  margin-right: 0;\n}\n\n.pcui-button:not(.pcui-disabled, .pcui-readonly):hover, .pcui-button:not(.pcui-disabled, .pcui-readonly):focus {\n  color: #fff;\n  background-color: #2c393c;\n  box-shadow: 0 0 2px 1px rgba(255, 102, 0, 0.3);\n}\n.pcui-button:not(.pcui-disabled, .pcui-readonly):active {\n  background-color: #20292b;\n  box-shadow: none;\n}\n\n.pcui-button.pcui-readonly {\n  opacity: 0.7;\n  cursor: default;\n}\n\n.pcui-button.pcui-disabled {\n  opacity: 0.4;\n  cursor: default;\n}\n\n.pcui-button.pcui-small {\n  height: 24px;\n  line-height: 24px;\n  font-size: 10px;\n}\n\n.pcui-code {\n  background: #20292b;\n  overflow: auto;\n}\n.pcui-code .pcui-code-inner {\n  color: #f60;\n  font-family: inconsolatamedium, Monaco, Menlo, "Ubuntu Mono", Consolas, source-code-pro, monospace;\n  font-weight: normal;\n  font-size: 10px;\n  white-space: pre;\n}\n\n.pcui-container {\n  position: relative;\n  min-width: 0;\n  min-height: 0;\n}\n\n.pcui-container.pcui-resizable > .pcui-resizable-handle {\n  position: absolute;\n  z-index: 1;\n  opacity: 0;\n  background-color: transparent;\n  touch-action: none;\n}\n.pcui-container.pcui-resizable > .pcui-resizable-handle:hover {\n  opacity: 1;\n}\n.pcui-container.pcui-resizable.pcui-resizable-resizing > .pcui-resizable-handle {\n  opacity: 1;\n}\n.pcui-container.pcui-resizable.pcui-resizable-left > .pcui-resizable-handle, .pcui-container.pcui-resizable.pcui-resizable-right > .pcui-resizable-handle {\n  top: 0;\n  bottom: 0;\n  width: 1px;\n  height: auto;\n  cursor: ew-resize;\n}\n.pcui-container.pcui-resizable.pcui-resizable-left > .pcui-resizable-handle {\n  left: 0;\n  border-left: 3px solid #20292b;\n}\n.pcui-container.pcui-resizable.pcui-resizable-right > .pcui-resizable-handle {\n  right: 0;\n  border-right: 3px solid #20292b;\n}\n.pcui-container.pcui-resizable.pcui-resizable-top > .pcui-resizable-handle, .pcui-container.pcui-resizable.pcui-resizable-bottom > .pcui-resizable-handle {\n  left: 0;\n  right: 0;\n  width: auto;\n  height: 1px;\n  cursor: ns-resize;\n}\n.pcui-container.pcui-resizable.pcui-resizable-top > .pcui-resizable-handle {\n  top: 0;\n  border-top: 3px solid #20292b;\n}\n.pcui-container.pcui-resizable.pcui-resizable-bottom > .pcui-resizable-handle {\n  bottom: 0;\n  border-bottom: 3px solid #20292b;\n}\n\n.pcui-container-dragged {\n  outline: 2px solid #fff;\n  box-sizing: border-box;\n  opacity: 0.7;\n  z-index: 1;\n}\n\n.pcui-container-dragged-child {\n  outline: 1px dotted #f60;\n  box-sizing: border-box;\n}\n\n.pcui-color-input {\n  position: relative;\n  display: inline-block;\n  box-sizing: border-box;\n  width: 44px;\n  height: 24px;\n  margin: 6px;\n  vertical-align: top;\n  cursor: pointer;\n  transition: opacity 100ms;\n}\n.pcui-color-input > .pcui-overlay-clickable {\n  position: fixed;\n}\n.pcui-color-input > div {\n  position: absolute;\n  inset: 0;\n}\n.pcui-color-input::after {\n  content: "";\n  position: absolute;\n  bottom: 0;\n  right: 0;\n  width: 0;\n  height: 0;\n  background-color: transparent;\n  border-bottom: 16px solid #293538;\n  border-left: 16px solid transparent;\n}\n\n.picker-color.c-1 > .pcui-overlay-content > .pick-opacity {\n  display: block;\n}\n.picker-color.c-1 > .pcui-overlay-content > .fields > .field-r {\n  display: block;\n}\n.picker-color.c-2 > .pcui-overlay-content > .fields > .field-hex {\n  display: block;\n}\n.picker-color.c-3 > .pcui-overlay-content {\n  width: 298px;\n}\n.picker-color.c-3 > .pcui-overlay-content > .pick-rect {\n  display: block;\n}\n.picker-color.c-3 > .pcui-overlay-content > .pick-hue {\n  display: block;\n}\n.picker-color.c-3 > .pcui-overlay-content > .pick-opacity {\n  display: none;\n}\n.picker-color.c-3 > .pcui-overlay-content > .fields > .field-g,\n.picker-color.c-3 > .pcui-overlay-content > .fields > .field-b {\n  display: block;\n}\n.picker-color.c-4 > .pcui-overlay-content {\n  width: 320px;\n}\n.picker-color.c-4 > .pcui-overlay-content > .pick-opacity {\n  display: block;\n}\n.picker-color.c-4 > .pcui-overlay-content > .fields > .field-a {\n  display: block;\n}\n.picker-color > .pcui-overlay-content {\n  border: 1px solid #000;\n  width: 320px;\n  height: 162px;\n  white-space: nowrap;\n  transition: none;\n}\n.picker-color > .pcui-overlay-content > .pick-rect {\n  position: relative;\n  display: none;\n  float: left;\n  width: 146px;\n  height: 146px;\n  border: 1px solid #000;\n  box-sizing: border-box;\n  margin: 8px 0 8px 8px;\n  background-color: #f00;\n  touch-action: none;\n  cursor: crosshair;\n}\n.picker-color > .pcui-overlay-content > .pick-rect > .white {\n  position: absolute;\n  width: 144px;\n  height: 144px;\n  top: 0;\n  left: 0;\n  background: linear-gradient(to right, rgb(255, 255, 255) 0%, rgba(255, 255, 255, 0.01) 100%);\n}\n.picker-color > .pcui-overlay-content > .pick-rect > .black {\n  position: absolute;\n  width: 144px;\n  height: 144px;\n  top: 0;\n  left: 0;\n  background: linear-gradient(to bottom, rgba(0, 0, 0, 0.01) 0%, rgb(0, 0, 0) 100%);\n}\n.picker-color > .pcui-overlay-content > .pick-rect > .handle {\n  position: absolute;\n  top: 0;\n  left: 0;\n  width: 12px;\n  height: 12px;\n  margin: -7px 0 0 -7px;\n  border: 1px solid #000;\n  outline: 1px solid #fff;\n}\n.picker-color > .pcui-overlay-content > .pick-hue {\n  position: relative;\n  display: none;\n  float: left;\n  width: 14px;\n  height: 146px;\n  margin: 8px 0 8px 8px;\n  border: 1px solid #000;\n  box-sizing: border-box;\n  touch-action: none;\n  cursor: crosshair;\n  background: #000;\n  background: linear-gradient(to bottom, rgb(255, 0, 0) 0%, rgb(255, 255, 0) 16.67%, rgb(0, 255, 0) 33.33%, rgb(0, 255, 255) 50%, rgb(0, 0, 255) 66.67%, rgb(255, 0, 255) 83.33%, rgb(255, 0, 0) 100%);\n}\n.picker-color > .pcui-overlay-content > .pick-hue > .handle {\n  position: absolute;\n  top: 0;\n  left: -3px;\n  width: 16px;\n  height: 4px;\n  margin: -3px 0 0;\n  border: 1px solid #000;\n  outline: 1px solid #fff;\n}\n.picker-color > .pcui-overlay-content > .pick-opacity {\n  position: relative;\n  display: none;\n  float: left;\n  width: 12px;\n  height: 144px;\n  margin: 8px 0 8px 8px;\n  border: 1px solid #000;\n  touch-action: none;\n  cursor: crosshair;\n  background: #000;\n  background: linear-gradient(to bottom, #fff 0%, #000 100%);\n}\n.picker-color > .pcui-overlay-content > .pick-opacity > .handle {\n  position: absolute;\n  top: 0;\n  left: -3px;\n  width: 16px;\n  height: 4px;\n  margin: -3px 0 0;\n  border: 1px solid #000;\n  outline: 1px solid #fff;\n}\n.picker-color > .pcui-overlay-content > .fields {\n  float: left;\n  width: 106px;\n  height: 154px;\n  margin: 0 0 0 8px;\n  padding: 4px;\n}\n.picker-color > .pcui-overlay-content > .fields > .field {\n  display: none;\n  width: 100px;\n}\n\n.pcui-color-input.pcui-multiple-values > div {\n  display: none;\n}\n\n.pcui-color-input.pcui-readonly {\n  cursor: default;\n}\n.pcui-color-input.pcui-readonly::after {\n  display: none;\n}\n\n.pcui-color-input.pcui-disabled {\n  opacity: 0.4;\n  cursor: default;\n}\n\n.pcui-color-input:not(.pcui-disabled, .pcui-readonly):hover, .pcui-color-input:not(.pcui-disabled, .pcui-readonly):focus {\n  box-shadow: 0 0 2px 1px rgba(255, 102, 0, 0.3);\n}\n.pcui-color-input:not(.pcui-disabled, .pcui-readonly):hover::after, .pcui-color-input:not(.pcui-disabled, .pcui-readonly):focus::after {\n  border-bottom-color: #20292b;\n}\n.pcui-color-input:not(.pcui-disabled, .pcui-readonly):active {\n  box-shadow: 0 0 0 1px rgba(255, 102, 0, 0.3);\n}\n\n.pcui-gradient {\n  display: inline-block;\n  flex: 1;\n  height: 24px;\n  box-sizing: border-box;\n  margin: 6px;\n  transition: opacity 100ms, box-shadow 100ms;\n  border: 1px solid #293538;\n  background-color: #2c393c;\n}\n.pcui-gradient > .pcui-canvas {\n  width: 100%;\n  height: 100%;\n  background-color: transparent;\n}\n\n.pcui-gradient.pcui-disabled,\n.pcui-gradient.pcui-multiple-values {\n  opacity: 0.4;\n}\n\n.pcui-gradient:not(.pcui-disabled, .pcui-readonly, .pcui-multiple-values):hover, .pcui-gradient:not(.pcui-disabled, .pcui-readonly, .pcui-multiple-values):focus {\n  cursor: pointer;\n  box-shadow: 0 0 2px 1px rgba(255, 102, 0, 0.3);\n}\n.pcui-gradient:not(.pcui-disabled, .pcui-readonly, .pcui-multiple-values):active {\n  box-shadow: 0 0 0 1px rgba(255, 102, 0, 0.3);\n}\n\n.picker-gradient > .pcui-overlay-content {\n  width: 343px;\n  height: 262px;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel {\n  height: 100%;\n  font-size: 11px;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .show-selected-position {\n  position: absolute;\n  width: 18px;\n  min-height: 17px !important;\n  height: 17px !important;\n  top: 14px;\n  margin-top: 0;\n  margin-bottom: 0;\n  display: flex;\n  align-items: center;\n  text-align: center;\n  color: #9ba1a3;\n  background-color: #2c393c;\n  border-radius: 2px;\n  justify-content: center;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .show-selected-position > .show-selected-position-input {\n  width: inherit;\n  text-align: center;\n  justify-content: center;\n  font-style: normal;\n  font-weight: 400;\n  font-size: 12px;\n  line-height: 22px;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .anchor-crosshair {\n  position: absolute;\n  top: 41.5px;\n  pointer-events: none;\n  background: none;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .anchor-crosshair > .crosshair-bar {\n  background: #293538;\n  width: 1px;\n  height: 29px;\n  position: absolute;\n  top: -34px;\n  left: 8px;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .anchor-crosshair > .show-crosshair-position {\n  font-style: normal;\n  font-weight: 400;\n  font-size: 12px;\n  font-family: inconsolatamedium, Monaco, Menlo, "Ubuntu Mono", Consolas, source-code-pro, monospace;\n  line-height: 22px;\n  position: absolute;\n  width: 18px;\n  min-height: 17px !important;\n  height: 17px !important;\n  top: 14px;\n  margin-top: 0;\n  margin-bottom: 0;\n  display: flex;\n  align-items: center;\n  text-align: center;\n  color: #9ba1a3;\n  background-color: #2c393c;\n  border-radius: 2px;\n  justify-content: center;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .picker-gradient-gradient {\n  width: 321px;\n  height: 28px;\n  display: block;\n  padding: 8px 10px 0 11px;\n  background-color: #2c393c;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .picker-gradient-gradient .crosshair-active {\n  cursor: none;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .picker-gradient-anchors {\n  width: 320px;\n  height: 28px;\n  display: block;\n  padding: 0 10px 0 11px;\n  background-color: #2c393c;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .picker-gradient-footer {\n  padding: 5px;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .picker-gradient-footer > .pcui-panel-header {\n  display: none;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .picker-gradient-footer > .pcui-panel-content {\n  display: flex;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .picker-gradient-footer > .pcui-panel-content > .pcui-label {\n  align-self: center;\n  font-family: inherit;\n  font-style: normal;\n  font-weight: 600;\n  font-size: 12px;\n  line-height: 19px;\n  align-content: center;\n  height: 20px;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .picker-gradient-footer > .pcui-panel-content > .pcui-select-input {\n  align-self: center;\n  width: 162px;\n  height: 22px;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .picker-gradient-footer > .pcui-panel-content > .pcui-numeric-input {\n  align-self: center;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .picker-gradient-footer > .pcui-panel-content > .pcui-button {\n  width: 22px;\n  height: 22px;\n  vertical-align: bottom;\n  margin: 0;\n  margin-right: 8px;\n  margin-top: 6px;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .picker-gradient-footer > .pcui-panel-content > .copy-curve-button {\n  border-color: #2c393c;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .picker-gradient-footer > .pcui-panel-content > .copy-curve-button::after {\n  content: "\\e351";\n  position: absolute;\n  top: 4px;\n  left: 218px;\n  font-size: 15px;\n  text-align: center;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .picker-gradient-footer > .pcui-panel-content > .paste-curve-button {\n  border-color: #2c393c;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .picker-gradient-footer > .pcui-panel-content > .paste-curve-button::after {\n  content: "\\e348";\n  position: absolute;\n  top: 4px;\n  left: 248px;\n  font-size: 15px;\n  text-align: center;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .picker-gradient-footer > .pcui-panel-content > .delete-curve-button {\n  border-color: #2c393c;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .picker-gradient-footer > .pcui-panel-content > .delete-curve-button::after {\n  content: "\\e125";\n  position: absolute;\n  top: 4px;\n  left: 278px;\n  font-size: 15px;\n  text-align: center;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .color-panel {\n  height: 156px;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .color-panel > .pcui-panel-header {\n  display: none;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .color-panel > .pcui-panel-content > .color-rect {\n  margin: 5px 10px 10px;\n  width: 140px;\n  height: 140px;\n  cursor: crosshair;\n  position: relative;\n  float: left;\n  border-width: 1px;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .color-panel > .pcui-panel-content > .color-handle {\n  position: absolute;\n  width: 14px;\n  height: 14px;\n  border: 1px solid #000;\n  outline: 1px solid #fff;\n  pointer-events: none;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .color-panel > .pcui-panel-content > .hue-rect,\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .color-panel > .pcui-panel-content > .alpha-rect {\n  margin: 5px 10px 10px 0;\n  width: 20px;\n  height: 140px;\n  cursor: crosshair;\n  border-width: 1px;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .color-panel > .pcui-panel-content > .hue-handle,\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .color-panel > .pcui-panel-content > .alpha-handle {\n  position: absolute;\n  width: 20px;\n  height: 4px;\n  border: 1px solid rgb(92, 82, 79);\n  outline: 1px solid #fff;\n  pointer-events: none;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .color-panel > .pcui-panel-content > .fields {\n  display: inline-block;\n  margin: 3px 0 0;\n  width: 112px;\n  height: 145px;\n  vertical-align: top;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .color-panel > .pcui-panel-content > .fields > .pcui-numeric-input {\n  margin: 2px 0;\n  width: 108px;\n}\n.picker-gradient > .pcui-overlay-content > .picker-gradient-panel > .color-panel > .pcui-panel-content > .fields > .pcui-text-input {\n  margin: 2px 0;\n  min-height: 22px;\n  min-width: 111px;\n}\n\n.pcui-panel {\n  background-color: #364346;\n}\n\n.pcui-panel-header {\n  background-color: #293538;\n  color: #fff;\n  font-size: 12px;\n  white-space: nowrap;\n  padding-left: 10px;\n  flex-shrink: 0;\n  align-items: center;\n}\n\n.pcui-panel-header-title {\n  overflow: hidden;\n  text-overflow: ellipsis;\n  flex: 1;\n  color: inherit;\n  font-size: inherit;\n  white-space: inherit;\n  margin: 0 auto 0 0;\n}\n\n.pcui-panel-content {\n  flex: 1;\n}\n\n.pcui-panel.pcui-collapsible {\n  transition: height 100ms, width 100ms;\n}\n.pcui-panel.pcui-collapsible > .pcui-panel-header {\n  cursor: pointer;\n}\n.pcui-panel.pcui-collapsible > .pcui-panel-header::before {\n  content: "\\e179";\n  font-size: 14px;\n  margin-right: 10px;\n  text-align: center;\n  color: #f60;\n}\n.pcui-panel.pcui-collapsible > .pcui-panel-header:hover {\n  color: #fff;\n}\n.pcui-panel.pcui-collapsible > .pcui-panel-header:hover::before {\n  color: #fff;\n}\n.pcui-panel.pcui-collapsible.pcui-panel-normal > .pcui-panel-header::before {\n  content: "\\e183";\n  font-weight: 200;\n}\n.pcui-panel.pcui-collapsible > .pcui-panel-content {\n  transition: visibility 100ms;\n}\n.pcui-panel.pcui-collapsible.pcui-collapsed {\n  overflow: hidden;\n}\n.pcui-panel.pcui-collapsible.pcui-collapsed > .pcui-panel-content {\n  visibility: hidden;\n}\n.pcui-panel.pcui-collapsible.pcui-collapsed > .pcui-panel-header::before {\n  content: "\\e180";\n}\n.pcui-panel.pcui-collapsible.pcui-collapsed.pcui-panel-normal > .pcui-panel-header::before {\n  content: "\\e184";\n}\n.pcui-panel.pcui-collapsible.pcui-collapsed.pcui-panel-horizontal > .pcui-panel-header {\n  width: 2048px;\n  -webkit-transform: rotate(90deg);\n          transform: rotate(90deg);\n  -webkit-transform-origin: 0% 100%;\n          transform-origin: 0% 100%;\n}\n.pcui-panel.pcui-collapsible.pcui-collapsed.pcui-panel-horizontal > .pcui-panel-header::before {\n  content: "\\e177";\n}\n.pcui-panel.pcui-collapsible.pcui-collapsed.pcui-panel-horizontal.pcui-panel-normal > .pcui-panel-header::before {\n  content: "\\e181";\n}\n.pcui-panel.pcui-collapsible.pcui-collapsed.pcui-panel-horizontal > .pcui-panel-content {\n  transition: none;\n}\n\n.pcui-panel.pcui-resizable.pcui-collapsible.pcui-collapsed > .pcui-resizable-handle {\n  display: none;\n}\n.pcui-panel.pcui-resizable.pcui-resizable-resizing {\n  transition: none;\n}\n.pcui-panel.pcui-resizable.pcui-resizable-resizing > .pcui-panel-content {\n  transition: none;\n}\n\n.pcui-panel-header > .pcui-panel-sortable-icon {\n  color: #5b7073;\n  transition: color 100ms;\n  flex-direction: row;\n  align-items: center;\n  margin: 0 10px 0 0;\n  height: 100%;\n}\n.pcui-panel-header > .pcui-panel-sortable-icon::before {\n  content: " ";\n  border-left: 1px solid #364346;\n  margin-right: 10px;\n  height: calc(100% - 14px);\n  flex-shrink: 0;\n}\n.pcui-panel-header > .pcui-panel-sortable-icon::after {\n  content: ".. .. ..";\n  white-space: normal;\n  width: 12px;\n  line-height: 5px;\n  overflow: hidden;\n  height: 24px;\n  font-size: 22px;\n  letter-spacing: 1px;\n  flex-shrink: 0;\n}\n\n.pcui-panel:not(.pcui-disabled, .pcui-readonly) > .pcui-panel-header > .pcui-panel-sortable-icon:hover {\n  color: #fff;\n  cursor: move;\n}\n\n.pcui-panel:not(.pcui-collapsible) > .pcui-panel-header > .pcui-panel-sortable-icon::before {\n  display: none;\n}\n\n.pcui-panel-remove {\n  align-self: flex-end;\n  order: 100;\n}\n.pcui-panel-remove::before {\n  line-height: 30px;\n}\n\n.pcui-panel.pcui-readonly .pcui-panel-remove {\n  display: none;\n}\n\n.pcui-panel-header > .pcui-button {\n  flex-shrink: 0;\n  margin: 1px;\n  background-color: transparent;\n  border: 0;\n}\n\n.pcui-panel.pcui-disabled > .pcui-panel-header {\n  background-color: #303d40;\n  color: #999;\n}\n\n.pcui-subpanel {\n  box-sizing: border-box;\n  margin: 6px;\n  border: 1px solid #293538;\n  border-radius: 2px;\n  background-color: #2c393c;\n  color: #b1b8ba;\n  font-size: 12px;\n}\n.pcui-subpanel .pcui-button {\n  background-color: #364346;\n  border-color: #293538;\n}\n.pcui-subpanel .pcui-button:not(.pcui-disabled, .pcui-readonly):hover, .pcui-subpanel .pcui-button:not(.pcui-disabled, .pcui-readonly):focus {\n  background-color: #364346;\n}\n.pcui-subpanel .pcui-button:not(.pcui-disabled, .pcui-readonly):active {\n  background-color: #2c393c;\n}\n\n.pcui-overlay {\n  width: auto;\n  height: auto;\n  inset: 0;\n  z-index: 101;\n  transition: opacity 100ms, visibility 100ms;\n  justify-content: center;\n  align-items: center;\n  position: absolute;\n}\n\n.pcui-overlay-inner {\n  position: absolute;\n  width: auto;\n  height: auto;\n  inset: 0;\n  background-color: rgba(32, 41, 43, 0.7);\n}\n\n.pcui-overlay-clickable > .pcui-overlay-inner {\n  cursor: pointer;\n}\n\n.pcui-overlay-transparent > .pcui-overlay-inner {\n  background-color: transparent;\n}\n\n.pcui-overlay-content {\n  background-color: #364346;\n  transition: width 100ms, height 100ms, margin-left 100ms, margin-top 100ms;\n  box-shadow: 7px 7px 7px rgba(0, 0, 0, 0.15);\n}\n\n.pcui-divider {\n  height: 1px;\n  background-color: #2c393c;\n  margin: 6px 0;\n}\n\n.pcui-infobox {\n  box-sizing: border-box;\n  margin: 6px;\n  padding: 12px;\n  border: 1px solid #293538;\n  border-radius: 2px;\n  background-color: #2c393c;\n  color: #b1b8ba;\n  font-size: 12px;\n}\n.pcui-infobox :first-child {\n  color: #fff;\n  margin-bottom: 2px;\n}\n.pcui-infobox[data-icon]:not(.pcui-hidden) {\n  display: grid;\n  grid: auto-flow/min-content 1fr;\n}\n.pcui-infobox[data-icon]:not(.pcui-hidden)::before {\n  content: attr(data-icon);\n  font-weight: 100;\n  font-size: 16px;\n  margin-right: 12px;\n  vertical-align: middle;\n  grid-column: 1;\n  grid-row: 1/3;\n}\n\n.pcui-select-input {\n  box-sizing: border-box;\n  margin: 6px;\n  border-radius: 2px;\n  min-width: 0;\n}\n\n.pcui-select-input-container-value {\n  background-color: #2c393c;\n  transition: box-shadow 100ms, opacity 100ms;\n}\n\n.pcui-select-input-shadow {\n  position: absolute;\n  width: 100%;\n  height: 100%;\n  transition: box-shadow 100ms;\n  border-radius: 2px;\n  pointer-events: none;\n  z-index: 1;\n}\n\n.pcui-select-input-value {\n  margin: 0;\n  padding: 0 24px 0 8px;\n  height: 24px;\n  line-height: 24px;\n  font-size: 12px;\n  transition: background-color 100ms, color 100ms;\n}\n.pcui-select-input-value:not(.pcui-hidden) {\n  display: block;\n}\n\n.pcui-label.pcui-select-input-value {\n  margin: 0;\n}\n\n.pcui-select-input-textinput {\n  margin: 0;\n}\n\n.pcui-select-input-textinput:not(.pcui-disabled, .pcui-readonly, .pcui-error).pcui-focus, .pcui-select-input-textinput:not(.pcui-disabled, .pcui-readonly, .pcui-error):hover {\n  box-shadow: none;\n}\n\n.pcui-label.pcui-select-input-icon {\n  position: absolute;\n  right: 6px;\n  color: #5b7073;\n  pointer-events: none;\n  transition: color 100ms;\n  margin: 0;\n  height: 24px;\n  line-height: 24px;\n}\n.pcui-label.pcui-select-input-icon::after {\n  content: "\\e159";\n  vertical-align: middle;\n}\n\n.pcui-select-input-has-disabled-value .pcui-container.pcui-select-input-list .pcui-label.pcui-selected::after {\n  font-family: inherit;\n  content: "fallback";\n  color: #fff;\n  font-size: 10px;\n  position: absolute;\n  right: 6px;\n}\n\n.pcui-label.pcui-select-input-disabled-value::after {\n  content: "\\e133" !important;\n  position: absolute;\n  right: 6px;\n}\n\n.pcui-select-input.pcui-open .pcui-select-input-shadow {\n  box-shadow: 0 0 2px 1px rgba(255, 102, 0, 0.3);\n}\n.pcui-select-input.pcui-open .pcui-select-input-value {\n  color: #fff;\n  background-color: #20292b;\n}\n.pcui-select-input.pcui-open .pcui-select-input-icon::after {\n  color: #fff;\n  content: "\\e157";\n}\n\n.pcui-container.pcui-select-input-list {\n  position: absolute;\n  z-index: 1;\n  top: 100%;\n  width: 100%;\n  max-height: 200px;\n  overflow-y: auto;\n  background-color: #293538;\n}\n.pcui-container.pcui-select-input-list .pcui-label {\n  font-size: 12px;\n  height: 22px;\n  line-height: 22px;\n  padding: 0 24px 0 6px;\n  margin: 0;\n  transition: background-color 100ms, color 100ms;\n}\n.pcui-container.pcui-select-input-list .pcui-label:not(.pcui-hidden) {\n  display: block;\n}\n.pcui-container.pcui-select-input-list .pcui-label.pcui-selected {\n  color: #fff;\n}\n.pcui-container.pcui-select-input-list .pcui-label.pcui-selected::after {\n  content: "\\e133";\n  color: #5b7073;\n  position: absolute;\n  right: 6px;\n}\n\n.pcui-select-input-fit-height .pcui-select-input-list {\n  top: initial;\n  bottom: 100%;\n}\n.pcui-select-input-fit-height .pcui-select-input-shadow {\n  top: initial;\n  bottom: 0;\n}\n\n.pcui-select-input-tags:not(.pcui-select-input-tags-empty) {\n  margin-top: 1px;\n  flex-wrap: wrap;\n}\n\n.pcui-select-input-tag {\n  background-color: #293538;\n  align-items: center;\n  border-radius: 2px;\n  border: 1px solid #232e30;\n  margin-right: 2px;\n  margin-top: 2px;\n  min-width: 0;\n  height: 18px;\n}\n.pcui-select-input-tag > * {\n  margin: 0;\n  background-color: transparent;\n  border: 0;\n}\n.pcui-select-input-tag > .pcui-label {\n  padding: 0 5px 0 8px;\n}\n.pcui-select-input-tag > .pcui-button {\n  padding: 0 5px;\n  height: 18px;\n  line-height: 18px;\n  flex-shrink: 0;\n}\n.pcui-select-input-tag > .pcui-button:not(.pcui-disabled, .pcui-readonly):hover {\n  box-shadow: none;\n  color: #d34141;\n}\n\n.pcui-select-input-tag-not-everywhere > .pcui-label {\n  opacity: 0.5;\n}\n.pcui-select-input-tag-not-everywhere > .pcui-label::before {\n  content: "*";\n  margin-right: 5px;\n}\n\n.pcui-select-input:not(.pcui-disabled, .pcui-readonly) .pcui-select-input-container-value:hover .pcui-select-input-shadow {\n  box-shadow: 0 0 2px 1px rgba(255, 102, 0, 0.3);\n}\n.pcui-select-input:not(.pcui-disabled, .pcui-readonly) .pcui-select-input-container-value:hover .pcui-select-input-icon {\n  color: #9ba1a3;\n}\n.pcui-select-input:not(.pcui-disabled, .pcui-readonly).pcui-focus .pcui-select-input-shadow {\n  box-shadow: 0 0 2px 1px rgba(255, 102, 0, 0.3);\n}\n.pcui-select-input:not(.pcui-disabled, .pcui-readonly).pcui-focus .pcui-select-input-icon {\n  color: #9ba1a3;\n}\n.pcui-select-input:not(.pcui-disabled, .pcui-readonly) .pcui-select-input-value:hover {\n  color: #fff;\n  background-color: #20292b;\n  cursor: pointer;\n}\n.pcui-select-input:not(.pcui-disabled, .pcui-readonly) .pcui-select-input-list > *:hover,\n.pcui-select-input:not(.pcui-disabled, .pcui-readonly) .pcui-select-input-list > .pcui-select-input-label-highlighted {\n  background-color: #20292b;\n  color: #fff;\n  cursor: pointer;\n}\n\n.pcui-select-input-create-new > .pcui-label {\n  padding-right: 6px;\n}\n.pcui-select-input-create-new > .pcui-label:last-child {\n  flex-shrink: 0;\n  margin-left: auto;\n}\n.pcui-select-input-create-new > .pcui-label:last-child::before {\n  content: "\\e120";\n  margin-right: 6px;\n}\n\n.pcui-select-input.pcui-disabled {\n  opacity: 0.4;\n}\n\n.pcui-select-input .pcui-label.pcui-disabled {\n  opacity: 0.4;\n}\n\n.pcui-select-input.pcui-readonly .pcui-select-input-icon {\n  display: none;\n}\n.pcui-select-input.pcui-readonly.pcui-select-input-multi .pcui-select-input-container-value {\n  display: none;\n}\n.pcui-select-input.pcui-readonly.pcui-select-input-multi .pcui-select-input-tag > .pcui-button {\n  display: none;\n}\n.pcui-select-input.pcui-readonly.pcui-select-input-allow-input:not(.pcui-select-input-multi) {\n  opacity: 0.7;\n}\n.pcui-select-input.pcui-readonly.pcui-select-input-allow-input:not(.pcui-select-input-multi) .pcui-select-input-textinput::after {\n  display: none;\n}\n\n@-webkit-keyframes animation-spin {\n  from {\n    -webkit-transform: rotate(0deg);\n            transform: rotate(0deg);\n  }\n  to {\n    -webkit-transform: rotate(360deg);\n            transform: rotate(360deg);\n  }\n}\n\n@keyframes animation-spin {\n  from {\n    -webkit-transform: rotate(0deg);\n            transform: rotate(0deg);\n  }\n  to {\n    -webkit-transform: rotate(360deg);\n            transform: rotate(360deg);\n  }\n}\n.pcui-spinner {\n  display: inline-block;\n  margin: 6px;\n  vertical-align: middle;\n}\n.pcui-spinner > path {\n  -webkit-animation-name: animation-spin;\n          animation-name: animation-spin;\n  -webkit-animation-duration: 750ms;\n          animation-duration: 750ms;\n  -webkit-animation-iteration-count: infinite;\n          animation-iteration-count: infinite;\n  -webkit-animation-timing-function: linear;\n          animation-timing-function: linear;\n  -webkit-transform-origin: center;\n          transform-origin: center;\n}\n.pcui-spinner.pcui-error > path {\n  -webkit-animation: none;\n          animation: none;\n  fill: #ff2020;\n}\n.pcui-spinner.pcui-error > path.pcui-spinner-highlight {\n  fill: #ff7777;\n}\n\n.pcui-progress {\n  height: 4px;\n  background-color: #20292b;\n  transition: opacity 100ms;\n  width: 100%;\n}\n.pcui-progress .pcui-progress-inner {\n  width: 0%;\n  height: inherit;\n  background: #f60;\n  background: linear-gradient(135deg, #ff6600 0%, #ff6600 25%, #a84300 26%, #a84300 50%, #ff6600 51%, #ff6600 75%, #a84300 76%, #a84300 100%);\n  background-position: 0 0;\n  background-size: 24px 24px;\n  background-repeat: repeat;\n  -webkit-animation: pcui-progress-background 1000ms linear infinite;\n          animation: pcui-progress-background 1000ms linear infinite;\n}\n\n.pcui-progress.pcui-error .pcui-progress-inner {\n  background: #f60;\n  background: linear-gradient(135deg, #ff7777 0%, #ff7777 25%, #ff2020 26%, #ff2020 50%, #ff7777 51%, #ff7777 75%, #ff2020 76%, #ff2020 100%);\n  background-position: 0 0;\n  background-size: 24px 24px;\n  background-repeat: repeat;\n  -webkit-animation: none;\n          animation: none;\n}\n\n@-webkit-keyframes pcui-progress-background {\n  from {\n    background-position: 0 0;\n  }\n  to {\n    background-position: 24px 0;\n  }\n}\n\n@keyframes pcui-progress-background {\n  from {\n    background-position: 0 0;\n  }\n  to {\n    background-position: 24px 0;\n  }\n}\n.pcui-treeview {\n  min-width: -webkit-max-content;\n  min-width: max-content;\n}\n\n.pcui-treeview-item {\n  position: relative;\n  padding-left: 24px;\n}\n.pcui-treeview-item::before {\n  content: "";\n  position: absolute;\n  background-color: #313e41;\n  width: 2px;\n  left: 14px;\n  top: -12px;\n  bottom: 12px;\n}\n.pcui-treeview-item:last-child::before {\n  height: 25px;\n  bottom: auto;\n}\n\n.pcui-treeview-item.pcui-disabled > .pcui-treeview-item-contents > .pcui-treeview-item-text {\n  opacity: 0.4;\n}\n\n.pcui-treeview-item-contents {\n  position: relative;\n  color: #b1b8ba;\n  margin-left: 3px;\n  border: 1px solid transparent;\n  align-items: center;\n  height: 24px;\n  box-sizing: border-box;\n}\n.pcui-treeview-item-contents:hover {\n  cursor: pointer;\n  color: #fff;\n  background-color: #2c393c;\n}\n.pcui-treeview-item-contents:hover > .pcui-treeview-item-icon {\n  color: #fff;\n}\n\n.pcui-treeview-item-icon {\n  color: #5b7073;\n  margin: 0 2px 0 0;\n  flex-shrink: 0;\n}\n.pcui-treeview-item-icon::before {\n  content: "";\n  position: absolute;\n  background-color: #313e41;\n  left: -12px;\n  top: 10px;\n  width: 24px;\n  height: 2px;\n}\n.pcui-treeview-item-icon::after {\n  content: attr(data-icon);\n  display: inline-block;\n  vertical-align: sub;\n  width: 22px;\n  height: 22px;\n  position: relative;\n  z-index: 1;\n  text-align: center;\n}\n\n.pcui-treeview-item-text {\n  margin: 0;\n  flex-shrink: 0;\n  position: relative;\n  z-index: 1;\n  transition: opacity 100ms;\n  padding-right: 8px;\n  color: inherit;\n}\n\n.pcui-treeview-item-contents.pcui-treeview-item-selected {\n  background-color: #20292b;\n  color: #fff;\n}\n.pcui-treeview-item-contents.pcui-treeview-item-selected > .pcui-treeview-item-icon {\n  color: #fff;\n}\n\n.pcui-treeview-item:not(.pcui-treeview-item-empty) > .pcui-treeview-item-contents::before {\n  content: "\\e120";\n  position: absolute;\n  font-size: 10px;\n  font-weight: bold;\n  text-align: center;\n  color: #b1b8ba;\n  background-color: #2c393c;\n  top: 0;\n  left: -24px;\n  width: 16px;\n  height: 16px;\n  line-height: 16px;\n  margin: 3px;\n  cursor: pointer;\n  z-index: 1;\n}\n.pcui-treeview-item:not(.pcui-treeview-item-empty).pcui-treeview-item-open > .pcui-treeview-item-contents::before {\n  content: "\\e121";\n}\n\n.pcui-treeview > .pcui-treeview-item {\n  padding-left: 0;\n}\n.pcui-treeview > .pcui-treeview-item::before {\n  content: none;\n}\n.pcui-treeview > .pcui-treeview-item > .pcui-treeview-item-contents {\n  margin-left: 0;\n}\n.pcui-treeview > .pcui-treeview-item > .pcui-treeview-item-contents > .pcui-treeview-item-icon::before {\n  content: none;\n}\n.pcui-treeview > .pcui-treeview-item > .pcui-treeview-item-contents > .pcui-treeview-item-icon::after {\n  margin-left: 0;\n}\n.pcui-treeview > .pcui-treeview-item > .pcui-treeview-item {\n  padding-left: 21px;\n}\n.pcui-treeview > .pcui-treeview-item > .pcui-treeview-item::before {\n  left: 11px;\n}\n\n.pcui-treeview:not(.pcui-treeview-filtering) > .pcui-treeview-item .pcui-treeview-item:not(.pcui-treeview-item-open, .pcui-treeview-item-empty) > .pcui-treeview-item {\n  display: none;\n}\n\n.pcui-treeview-item-dragged > .pcui-treeview-item-contents {\n  background-color: rgba(44, 57, 60, 0.5);\n  color: #fff;\n}\n\n.pcui-treeview-drag-handle {\n  position: fixed;\n  width: 32px;\n  height: 20px;\n  top: 0;\n  bottom: 0;\n  z-index: 4;\n  margin-top: -1px;\n  margin-left: -1px;\n}\n.pcui-treeview-drag-handle.before {\n  border-top: 4px solid #f60;\n  padding-right: 8px;\n  height: 24px;\n}\n.pcui-treeview-drag-handle.inside {\n  border: 4px solid #f60;\n}\n.pcui-treeview-drag-handle.after {\n  border-bottom: 4px solid #f60;\n  padding-right: 8px;\n  height: 24px;\n}\n\n.pcui-treeview-item-contents::after {\n  content: " ";\n  display: block;\n  clear: both;\n}\n\n.pcui-treeview-item.pcui-treeview-item-rename > .pcui-treeview-item-contents > .pcui-treeview-item-text {\n  display: none;\n}\n.pcui-treeview-item.pcui-treeview-item-rename > .pcui-treeview-item-contents > .pcui-text-input {\n  margin: 0;\n  flex-grow: 1;\n  box-shadow: none !important;\n  border: 0;\n  background-color: transparent;\n}\n.pcui-treeview-item.pcui-treeview-item-rename > .pcui-treeview-item-contents > .pcui-text-input > input {\n  font-family: inherit;\n  font-size: 14px;\n  padding: 0;\n}\n\n.pcui-treeview.pcui-treeview-filtering .pcui-treeview-item {\n  padding-left: 0;\n}\n.pcui-treeview.pcui-treeview-filtering .pcui-treeview-item::before {\n  display: none;\n}\n.pcui-treeview.pcui-treeview-filtering .pcui-treeview-item:not(.pcui-treeview-filtering-result) > .pcui-treeview-item-contents {\n  display: none;\n}\n.pcui-treeview.pcui-treeview-filtering .pcui-treeview-item-contents {\n  margin-left: 0;\n}\n\n.pcui-treeview-filtering-result .pcui-treeview-item-contents::before,\n.pcui-treeview-filtering-result .pcui-treeview-item-icon::before {\n  display: none;\n}\n\n.pcui-label-group {\n  align-items: center;\n  flex-flow: row nowrap;\n  margin: 6px;\n}\n.pcui-label-group > .pcui-label:first-child {\n  width: 100px;\n  flex-shrink: 0;\n  margin: 0;\n}\n.pcui-label-group > .pcui-element:not(:first-child) {\n  margin: 0 0 0 6px;\n}\n.pcui-label-group > .pcui-element:nth-child(2):not(.pcui-not-flexible) {\n  flex: 1;\n}\n.pcui-label-group > .pcui-vector-input > .pcui-numeric-input {\n  margin-top: 0;\n  margin-bottom: 0;\n}\n\n.pcui-label-group-align-top > .pcui-label:first-child {\n  align-self: flex-start;\n  margin-top: 4px;\n}\n\n.pcui-label-group.pcui-disabled > .pcui-label:first-child {\n  opacity: 0.4;\n}\n\n.pcui-gridview {\n  flex-flow: row wrap;\n  align-content: flex-start;\n}\n\n.pcui-gridview-vertical {\n  flex-direction: column;\n  align-content: flex-start;\n}\n\n.pcui-gridview-item {\n  box-sizing: border-box;\n  justify-content: center;\n  align-items: center;\n  flex-shrink: 0;\n  width: 104px;\n}\n.pcui-gridview-item:not(.pcui-disabled) {\n  cursor: pointer;\n}\n.pcui-gridview-item:not(.pcui-disabled):not(.pcui-gridview-item-selected, .pcui-gridview-radiobtn, .pcui-gridview-radiobtn-selected):hover {\n  background-color: #293538;\n}\n\n.pcui-gridview-item-selected {\n  background-color: #20292b;\n}\n\n.pcui-gridview-item-text {\n  max-width: 100px;\n  font-size: 12px;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  margin: 0;\n  padding: 0 2px;\n}\n\n.pcui-gridview-radio-container {\n  box-sizing: border-box;\n  flex-direction: row;\n  justify-content: center;\n  align-items: center;\n  flex-shrink: 0;\n  width: 104px;\n}\n.pcui-gridview-radio-container :not(.pcui-disabled) {\n  cursor: pointer;\n}\n\n.pcui-menu {\n  position: absolute;\n  z-index: 401;\n  inset: 0;\n  width: auto;\n  height: auto;\n}\n\n.pcui-menu-items {\n  position: fixed;\n  top: 0;\n  left: 0;\n}\n\n.pcui-menu-item {\n  position: relative;\n  background-color: #20292b;\n  width: auto;\n}\n\n.pcui-menu-item-children {\n  box-shadow: 0 0 8px rgba(0, 0, 0, 0.6);\n  position: absolute;\n  z-index: 1;\n  left: 100%;\n  top: 0;\n  opacity: 0;\n  transition: opacity 100ms, visibility 100ms;\n  visibility: hidden;\n}\n\n.pcui-menu-item:hover > .pcui-menu-item-children {\n  opacity: 1;\n  visibility: visible;\n}\n\n.pcui-menu-item-has-children > .pcui-menu-item-content > .pcui-label {\n  padding-right: 32px;\n}\n.pcui-menu-item-has-children > .pcui-menu-item-content > .pcui-label::after {\n  content: "\\e160";\n  position: absolute;\n  right: 6px;\n}\n\n.pcui-menu-item-content {\n  min-width: 158px;\n  color: #9ba1a3;\n  border-bottom: 1px solid #263134;\n  cursor: pointer;\n}\n.pcui-menu-item-content:hover {\n  color: #fff;\n  background-color: #5b7073;\n}\n.pcui-menu-item-content > .pcui-label {\n  transition: none;\n}\n\n.pcui-menu-item:last-child > .pcui-menu-item-content {\n  border-bottom: none;\n}\n\n.pcui-menu-item-content > .pcui-label {\n  color: inherit;\n}\n.pcui-menu-item-content > .pcui-label[data-icon]::before {\n  content: attr(data-icon);\n  font-weight: 100;\n  font-size: inherit;\n  margin-right: 6px;\n  vertical-align: middle;\n}\n\n.pcui-menu-item.pcui-disabled .pcui-menu-item-content {\n  cursor: default;\n}\n.pcui-menu-item.pcui-disabled .pcui-menu-item-content:hover {\n  color: #9ba1a3;\n  background-color: transparent;\n}\n.pcui-menu-item.pcui-disabled .pcui-menu-item-content > .pcui-label {\n  cursor: default;\n  opacity: 0.4;\n}\n\n.pcui-radio-button {\n  display: inline-block;\n  position: relative;\n  background-color: #293538;\n  color: #fff;\n  width: 17px;\n  height: 17px;\n  border-radius: 50%;\n  overflow: hidden;\n  margin: 6px;\n  transition: opacity 100ms, background-color 100ms, box-shadow 100ms;\n}\n.pcui-radio-button::before {\n  content: "";\n  position: absolute;\n  display: block;\n  left: 50%;\n  top: 50%;\n  width: 16px;\n  min-width: 16px;\n  height: 16px;\n  -webkit-transform: translate(-50%, -50%);\n          transform: translate(-50%, -50%);\n  border-radius: 50%;\n  background-color: #293538;\n}\n.pcui-radio-button::after {\n  position: absolute;\n  left: 50%;\n  top: 50%;\n  width: 11px;\n  min-width: 11px;\n  height: 11px;\n  -webkit-transform: translate(-50%, -50%);\n          transform: translate(-50%, -50%);\n  border-radius: 50%;\n  background-color: white;\n}\n\n.pcui-radio-button-selected::before {\n  width: 16px;\n  min-width: 16px;\n  height: 16px;\n  box-sizing: border-box;\n  border: 1px solid white;\n}\n.pcui-radio-button-selected::after {\n  content: "";\n  display: block;\n}\n\n.pcui-radio-button.pcui-readonly {\n  opacity: 0.7;\n}\n\n.pcui-radio-button.pcui-disabled {\n  opacity: 0.4;\n}\n\n.pcui-radio-button:not(.pcui-disabled, .pcui-readonly):hover {\n  cursor: pointer;\n}\n.pcui-radio-button:not(.pcui-disabled, .pcui-readonly):hover::before {\n  background-color: #20292b;\n}\n\n.pcui-array-input {\n  margin: 6px;\n  min-width: 0;\n}\n.pcui-array-input > .pcui-numeric-input {\n  margin: 0 0 6px 0;\n}\n\n.pcui-array-input.pcui-array-empty > .pcui-numeric-input {\n  margin: 0;\n}\n\n.pcui-array-input-item > * {\n  margin-top: 1px;\n  margin-bottom: 1px;\n}\n.pcui-array-input-item > *:first-child:not(.pcui-not-flexible, .pcui-panel-header) {\n  flex: 1;\n}\n.pcui-array-input-item > .pcui-button {\n  margin-left: -3px;\n  margin-right: 0;\n  background-color: transparent;\n  border: 0;\n}\n\n.pcui-array-input-item-asset > .pcui-button {\n  margin-top: 36px;\n}\n\n.pcui-array-input.pcui-readonly .pcui-array-input-item-delete {\n  display: none;\n}'),function(){const e=document.getElementById("app");if(!e)return;c(e).render(g(jA,null))}()}));
