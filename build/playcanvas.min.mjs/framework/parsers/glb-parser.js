import"../../core/tracing.js";import{path as e}from"../../core/path.js";import{WasmModule as n}from"../../core/wasm-module.js";import{Color as t}from"../../core/math/color.js";import{Mat4 as s}from"../../core/math/mat4.js";import{math as r}from"../../core/math/math.js";import{Vec2 as o}from"../../core/math/vec2.js";import{Vec3 as a}from"../../core/math/vec3.js";import{BoundingBox as i}from"../../core/shape/bounding-box.js";import{CHUNKAPI_1_58 as c,CULLFACE_NONE as l,CULLFACE_BACK as u,INDEXFORMAT_UINT32 as f,INDEXFORMAT_UINT16 as p,BUFFER_STATIC as h,PRIMITIVE_TRIANGLES as m,PRIMITIVE_TRIFAN as d,PRIMITIVE_TRISTRIP as y,PRIMITIVE_LINESTRIP as g,PRIMITIVE_LINELOOP as w,PRIMITIVE_LINES as O,PRIMITIVE_POINTS as x,SEMANTIC_NORMAL as P,INDEXFORMAT_UINT8 as b,TYPE_FLOAT32 as T,FILTER_LINEAR_MIPMAP_LINEAR as M,FILTER_NEAREST_MIPMAP_LINEAR as C,FILTER_LINEAR_MIPMAP_NEAREST as _,FILTER_NEAREST_MIPMAP_NEAREST as v,FILTER_LINEAR as A,FILTER_NEAREST as R,ADDRESS_REPEAT as E,ADDRESS_MIRRORED_REPEAT as F,ADDRESS_CLAMP_TO_EDGE as G,TYPE_UINT32 as k,TYPE_INT32 as U,TYPE_UINT16 as D,TYPE_INT16 as V,TYPE_UINT8 as I,TYPE_INT8 as S,SEMANTIC_POSITION as j,SEMANTIC_TANGENT as L,SEMANTIC_COLOR as H,SEMANTIC_BLENDINDICES as N,SEMANTIC_BLENDWEIGHT as K,SEMANTIC_TEXCOORD0 as z,SEMANTIC_TEXCOORD1 as B,SEMANTIC_TEXCOORD2 as $,SEMANTIC_TEXCOORD3 as X,SEMANTIC_TEXCOORD4 as W,SEMANTIC_TEXCOORD5 as Y,SEMANTIC_TEXCOORD6 as q,SEMANTIC_TEXCOORD7 as J,typedArrayTypesByteSize as Q,typedArrayTypes as Z}from"../../platform/graphics/constants.js";import{IndexBuffer as ee}from"../../platform/graphics/index-buffer.js";import{Texture as ne}from"../../platform/graphics/texture.js";import{VertexBuffer as te}from"../../platform/graphics/vertex-buffer.js";import{VertexFormat as se}from"../../platform/graphics/vertex-format.js";import{http as re}from"../../platform/net/http.js";import{SPECOCC_AO as oe,BLEND_NONE as ae,BLEND_NORMAL as ie,PROJECTION_ORTHOGRAPHIC as ce,PROJECTION_PERSPECTIVE as le,ASPECT_AUTO as ue,LIGHTFALLOFF_INVERSESQUARED as fe,ASPECT_MANUAL as pe}from"../../scene/constants.js";import{GraphNode as he}from"../../scene/graph-node.js";import{Light as me,lightTypes as de}from"../../scene/light.js";import{Mesh as ye}from"../../scene/mesh.js";import{Morph as ge}from"../../scene/morph.js";import{MorphTarget as we}from"../../scene/morph-target.js";import{calculateNormals as Oe}from"../../scene/procedural.js";import{Render as xe}from"../../scene/render.js";import{Skin as Pe}from"../../scene/skin.js";import{StandardMaterial as be}from"../../scene/materials/standard-material.js";import{Entity as Te}from"../entity.js";import{INTERPOLATION_LINEAR as Me,INTERPOLATION_CUBIC as Ce,INTERPOLATION_STEP as _e}from"../anim/constants.js";import{AnimCurve as ve}from"../anim/evaluator/anim-curve.js";import{AnimData as Ae}from"../anim/evaluator/anim-data.js";import{AnimTrack as Re}from"../anim/evaluator/anim-track.js";import{Asset as Ee}from"../asset/asset.js";import{GlbContainerResource as Fe}from"./glb-container-resource.js";let Ge=null;const ke=()=>"undefined"!=typeof window&&window.DracoDecoderModule;class Ue{constructor(e){this.gltf=e,this.nodes=null,this.scenes=null,this.animations=null,this.textures=null,this.materials=null,this.variants=null,this.meshVariants=null,this.meshDefaultMaterials=null,this.renders=null,this.skins=null,this.lights=null,this.cameras=null}destroy(){this.renders&&this.renders.forEach((e=>{e.meshes=null}))}}const De=function(e){return/^data:.*,.*$/i.test(e)},Ve=function(e){switch(e){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":default:return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}},Ie=function(e){switch(e){case 5120:return S;case 5121:return I;case 5122:return V;case 5123:return D;case 5124:return U;case 5125:return k;case 5126:return T;default:return 0}},Se=function(e){switch(e){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:return 0}},je={POSITION:j,NORMAL:P,TANGENT:L,COLOR_0:H,JOINTS_0:N,WEIGHTS_0:K,TEXCOORD_0:z,TEXCOORD_1:B,TEXCOORD_2:$,TEXCOORD_3:X,TEXCOORD_4:W,TEXCOORD_5:Y,TEXCOORD_6:q,TEXCOORD_7:J},Le=function(e,n,t){const s=(e=>{switch(e){case S:return e=>Math.max(e/127,-1);case I:return e=>e/255;case V:return e=>Math.max(e/32767,-1);case D:return e=>e/65535;default:return e=>e}})(t),r=n.length;for(let t=0;t<r;++t)e[t]=s(n[t]);return e},He=function e(n,t,s=!1){const r=Ve(n.type),o=function(e){switch(e){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:return null}}(n.componentType);if(!o)return null;const a=t[n.bufferView];let i;if(n.sparse){const s=n.sparse,a={count:s.count,type:"SCALAR"},c=e(Object.assign(a,s.indices),t,!0),l={count:s.count,type:n.scalar,componentType:n.componentType},u=e(Object.assign(l,s.values),t,!0);if(n.hasOwnProperty("bufferView")){i=e({bufferView:n.bufferView,byteOffset:n.byteOffset,componentType:n.componentType,count:n.count,type:n.type},t,!0).slice()}else i=new o(n.count*r);for(let e=0;e<s.count;++e){const n=c[e];for(let t=0;t<r;++t)i[n*r+t]=u[e*r+t]}}else if(s&&a.hasOwnProperty("byteStride")){const e=r*o.BYTES_PER_ELEMENT,t=new ArrayBuffer(n.count*e),s=new Uint8Array(t);let c=0;for(let t=0;t<n.count;++t){let r=(n.byteOffset||0)+t*a.byteStride;for(let n=0;n<e;++n)s[c++]=a[r++]}i=new o(t)}else i=new o(a.buffer,a.byteOffset+(n.byteOffset||0),n.count*r);return i},Ne=function(e,n){const t=He(e,n,!0);if(t instanceof Float32Array||!e.normalized)return t;const s=new Float32Array(t.length);return Le(s,t,Ie(e.componentType)),s},Ke=function(e){let n=e.min,t=e.max;if(!n||!t)return null;if(e.normalized){const s=Ie(e.componentType);n=Le([],n,s),t=Le([],t,s)}return new i(new a(.5*(t[0]+n[0]),.5*(t[1]+n[1]),.5*(t[2]+n[2])),new a(.5*(t[0]-n[0]),.5*(t[1]-n[1]),.5*(t[2]-n[2])))},ze=function(e,n){const t=e[j];if(!t||3!==t.components)return;let s;if(t.size!==t.stride){const e=t.stride/Q[t.type],n=new Z[t.type](t.buffer,t.offset,t.count*e);s=new Z[t.type](3*t.count);for(let r=0;r<t.count;++r)s[3*r+0]=n[r*e+0],s[3*r+1]=n[r*e+1],s[3*r+2]=n[r*e+2]}else s=new Z[t.type](t.buffer,t.offset,3*t.count);const r=t.count;n||(n=function(e){const n=new Uint16Array(e);for(let t=0;t<e;t++)n[t]=t;return n}(r));const o=Oe(s,n),a=new Float32Array(o.length);a.set(o),e[P]={buffer:a.buffer,size:12,offset:0,stride:12,count:r,components:3,type:T}},Be=function(e){const n=new Ee(e.name+"_clone",e.type,e.file,e.data,e.options);return n.loaded=!0,n.resource=function(e){const n=new ne(e.device,e);return n._levels=function(e){const n=[];for(let t=0;t<e._levels.length;++t){let s=[];if(e.cubemap)for(let n=0;n<6;++n)s.push(e._levels[t][n]);else s=e._levels[t];n.push(s)}return n}(e),n}(e.resource),e.registry.add(n),n},$e=function(e,n,t){const s=n[j];if(!s)return null;const r=s.count,o=[];for(const e in n)n.hasOwnProperty(e)&&o.push({semantic:e,components:n[e].components,type:n[e].type,normalize:!!n[e].normalize});const a=[j,P,L,H,N,K,z,B];let i,c,l,u,f,p;o.sort((function(e,n){const t=a.indexOf(e.semantic),s=a.indexOf(n.semantic);return t<s?-1:s<t?1:0}));const m=new se(e,o);let d=!0;for(i=0;i<m.elements.length;++i)if(f=m.elements[i],u=n[f.name],p=u.offset-s.offset,u.buffer!==s.buffer||u.stride!==f.stride||u.size!==f.size||p!==f.offset){d=!1;break}const y=new te(e,m,r,h),g=y.lock(),w=new Uint32Array(g);let O;if(d)O=new Uint32Array(s.buffer,s.offset,r*y.format.size/4),w.set(O);else{let e,t;for(i=0;i<y.format.elements.length;++i){f=y.format.elements[i],e=f.stride/4,u=n[f.name],t=u.stride/4,O=new Uint32Array(u.buffer,u.offset,(u.count-1)*t+(u.size+3)/4);let s=0,o=f.offset/4;const a=Math.floor((u.size+3)/4);for(c=0;c<r;++c){for(l=0;l<a;++l)w[o+l]=O[s+l];s+=t,o+=e}}}return t&&function(e){let n,t;const s=[],r=[],o=[];for(n=0;n<e.format.elements.length;++n){const t=e.format.elements[n];if(t.name===z||t.name===B)switch(t.dataType){case T:s.push({offset:t.offset/4+1,stride:t.stride/4});break;case D:r.push({offset:t.offset/2+1,stride:t.stride/2});break;case I:o.push({offset:t.offset+1,stride:t.stride})}}const a=function(s,r,o){const a=new r(e.storage);for(n=0;n<s.length;++n){let r=s[n].offset;const i=s[n].stride;for(t=0;t<e.numVertices;++t)a[r]=o-a[r],r+=i}};s.length>0&&a(s,Float32Array,1),r.length>0&&a(r,Uint16Array,65535),o.length>0&&a(o,Uint8Array,255)}(y),y.unlock(),y},Xe=new s,We=new a,Ye=function(e,n,t,s,r,o,a,i,c,l){const u=[];return n.primitives.forEach((function(M){let C,_,v,A=null,R=!0;if(M.hasOwnProperty("extensions")){const n=M.extensions;if(n.hasOwnProperty("KHR_draco_mesh_compression")){const t=Ge||ke();if(t){const a=n.KHR_draco_mesh_compression;if(a.hasOwnProperty("attributes")){const n=s[a.bufferView],i=new t.DecoderBuffer;i.Init(n,n.length);const c=new t.Decoder,l=c.GetEncodedGeometryType(i);let u,f;switch(l){case t.POINT_CLOUD:C=x,u=new t.PointCloud,f=c.DecodeBufferToPointCloud(i,u);break;case t.TRIANGULAR_MESH:C=m,u=new t.Mesh,f=c.DecodeBufferToMesh(i,u);case t.INVALID_GEOMETRY_TYPE:}if(!f||!f.ok()||0===u.ptr)return void r("Failed to decode draco compressed asset: "+(f?f.error_msg():"Mesh asset - invalid draco compressed geometry type: "+l));const p=u.num_faces();if(l===t.TRIANGULAR_MESH){const e=u.num_points()>65535;v=3*p;const n=v*(e?4:2),s=t._malloc(n);e?(c.GetTrianglesUInt32Array(u,n,s),A=new Uint32Array(t.HEAPU32.buffer,s,v).slice()):(c.GetTrianglesUInt16Array(u,n,s),A=new Uint16Array(t.HEAPU16.buffer,s,v).slice()),t._free(s)}_=function(e,n,t,s,r,o,a){const i=n.num_points(),c=function(e,t){const o=s.GetAttributeByUniqueId(n,e),a=i*o.num_components();let c,l,u,f;switch(o.data_type()){case r.DT_UINT8:f=I,u=1,c=r._malloc(a*u),s.GetAttributeDataArrayForAllPoints(n,o,r.DT_UINT8,a*u,c),l=new Uint8Array(r.HEAPU8.buffer,c,a).slice();break;case r.DT_UINT16:f=D,u=2,c=r._malloc(a*u),s.GetAttributeDataArrayForAllPoints(n,o,r.DT_UINT16,a*u,c),l=new Uint16Array(r.HEAPU16.buffer,c,a).slice();break;case r.DT_FLOAT32:default:f=T,u=4,c=r._malloc(a*u),s.GetAttributeDataArrayForAllPoints(n,o,r.DT_FLOAT32,a*u,c),l=new Float32Array(r.HEAPF32.buffer,c,a).slice()}return r._free(c),{values:l,numComponents:o.num_components(),componentSizeInBytes:u,storageType:f,normalized:t===H&&f===I||o.normalized()}},l={},u=t.attributes;for(const e in u)if(u.hasOwnProperty(e)&&je.hasOwnProperty(e)){const n=je[e],t=c(u[e],n),s=t.numComponents*t.componentSizeInBytes;l[n]={values:t.values,buffer:t.values.buffer,size:s,offset:0,stride:s,count:i,components:t.numComponents,type:t.storageType,normalize:t.normalized}}return l.hasOwnProperty(P)||ze(l,o),$e(e,l,a)}(e,u,a,c,t,A,o),t.destroy(u),t.destroy(c),t.destroy(i),R=!1}}}}_||(A=M.hasOwnProperty("indices")?He(t[M.indices],s,!0):null,_=function(e,n,t,s,r,o,a){const i={},c=[];for(const e in n)n.hasOwnProperty(e)&&je.hasOwnProperty(e)&&(i[e]=n[e],c.push(e+":"+n[e]));c.sort();const l=c.join();let u=a[l];if(!u){const c={};for(const e in i){const t=s[n[e]],o=He(t,r),a=r[t.bufferView],i=je[e],l=Ve(t.type)*Se(t.componentType),u=a.hasOwnProperty("byteStride")?a.byteStride:l;c[i]={buffer:o.buffer,size:l,offset:o.byteOffset,stride:u,count:t.count,components:Ve(t.type),type:Ie(t.componentType),normalize:t.normalized}}c.hasOwnProperty(P)||ze(c,t),u=$e(e,c,o),a[l]=u}return u}(e,M.attributes,A,t,s,o,a),C=function(e){if(!e.hasOwnProperty("mode"))return m;switch(e.mode){case 0:return x;case 1:return O;case 2:return w;case 3:return g;case 4:default:return m;case 5:return y;case 6:return d}}(M));let E=null;if(_){if(E=new ye(e),E.vertexBuffer=_,E.primitive[0].type=C,E.primitive[0].base=0,E.primitive[0].indexed=null!==A,null!==A){let n;n=A instanceof Uint8Array?b:A instanceof Uint16Array?p:f,n!==f||e.extUintElement||(n=p,A=new Uint16Array(A));const t=new ee(e,n,A.length,h,A);E.indexBuffer[0]=t,E.primitive[0].count=A.length}else E.primitive[0].count=_.numVertices;if(M.hasOwnProperty("extensions")&&M.extensions.hasOwnProperty("KHR_materials_variants")){const e=M.extensions.KHR_materials_variants,n={};e.mappings.forEach((e=>{e.variants.forEach((t=>{n[t]=e.material}))})),i[E.id]=n}c[E.id]=M.material;let r=t[M.attributes.POSITION];if(E.aabb=Ke(r),R&&M.hasOwnProperty("targets")){const o=[];M.targets.forEach((function(e,a){const i={};e.hasOwnProperty("POSITION")&&(r=t[e.POSITION],i.deltaPositions=Ne(r,s),i.deltaPositionsType=T,i.aabb=Ke(r)),e.hasOwnProperty("NORMAL")&&(r=t[e.NORMAL],i.deltaNormals=Ne(r,s),i.deltaNormalsType=T),n.hasOwnProperty("extras")&&n.extras.hasOwnProperty("targetNames")?i.name=n.extras.targetNames[a]:i.name=a.toString(10),n.hasOwnProperty("weights")&&(i.defaultWeight=n.weights[a]),i.preserveData=l.morphPreserveData,o.push(new we(i))})),E.morph=new ge(o,e)}}u.push(E)})),u},qe=function(e,n,t){var s;let a;const i=e.texCoord;if(i)for(a=0;a<t.length;++a)n[t[a]+"MapUv"]=i;const c=[0,0],l=[1,1],u=null==(s=e.extensions)?void 0:s.KHR_texture_transform;if(u){const e=u.offset||c,s=u.scale||l,i=u.rotation?-u.rotation*r.RAD_TO_DEG:0,f=new o(s[0],s[1]),p=new o(e[0],1-s[1]-e[1]);for(a=0;a<t.length;++a)n[`${t[a]}MapTiling`]=f,n[`${t[a]}MapOffset`]=p,n[`${t[a]}MapRotation`]=i}},Je=function(e,n,t){let s,r;if(e.hasOwnProperty("diffuseFactor")?(s=e.diffuseFactor,n.diffuse.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2)),n.opacity=s[3]):(n.diffuse.set(1,1,1),n.opacity=1),e.hasOwnProperty("diffuseTexture")){const s=e.diffuseTexture;r=t[s.index],n.diffuseMap=r,n.diffuseMapChannel="rgb",n.opacityMap=r,n.opacityMapChannel="a",qe(s,n,["diffuse","opacity"])}if(n.useMetalness=!1,e.hasOwnProperty("specularFactor")?(s=e.specularFactor,n.specular.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))):n.specular.set(1,1,1),e.hasOwnProperty("glossinessFactor")?n.shininess=100*e.glossinessFactor:n.shininess=100,e.hasOwnProperty("specularGlossinessTexture")){const s=e.specularGlossinessTexture;n.specularEncoding="srgb",n.specularMap=n.glossMap=t[s.index],n.specularMapChannel="rgb",n.glossMapChannel="a",qe(s,n,["gloss","metalness"])}},Qe=function(e,n,t){if(e.hasOwnProperty("clearcoatFactor")?n.clearCoat=.25*e.clearcoatFactor:n.clearCoat=0,e.hasOwnProperty("clearcoatTexture")){const s=e.clearcoatTexture;n.clearCoatMap=t[s.index],n.clearCoatMapChannel="r",qe(s,n,["clearCoat"])}if(e.hasOwnProperty("clearcoatRoughnessFactor")?n.clearCoatGlossiness=e.clearcoatRoughnessFactor:n.clearCoatGlossiness=0,e.hasOwnProperty("clearcoatRoughnessTexture")){const s=e.clearcoatRoughnessTexture;n.clearCoatGlossMap=t[s.index],n.clearCoatGlossMapChannel="g",qe(s,n,["clearCoatGloss"])}if(e.hasOwnProperty("clearcoatNormalTexture")){const s=e.clearcoatNormalTexture;n.clearCoatNormalMap=t[s.index],qe(s,n,["clearCoatNormal"]),s.hasOwnProperty("scale")&&(n.clearCoatBumpiness=s.scale)}n.chunks.clearCoatGlossPS="\n        #ifdef MAPFLOAT\n        uniform float material_clearCoatGlossiness;\n        #endif\n        \n        void getClearCoatGlossiness() {\n            ccGlossiness = 1.0;\n        \n        #ifdef MAPFLOAT\n            ccGlossiness *= material_clearCoatGlossiness;\n        #endif\n        \n        #ifdef MAPTEXTURE\n            ccGlossiness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n        #endif\n        \n        #ifdef MAPVERTEX\n            ccGlossiness *= saturate(vVertexColor.$VC);\n        #endif\n        \n            ccGlossiness = 1.0 - ccGlossiness;\n        \n            ccGlossiness += 0.0000001;\n        }\n        "},Ze=function(e,n,t){n.useLighting=!1,n.emissive.copy(n.diffuse),n.emissiveTint=n.diffuseTint,n.emissiveMap=n.diffuseMap,n.emissiveMapUv=n.diffuseMapUv,n.emissiveMapTiling.copy(n.diffuseMapTiling),n.emissiveMapOffset.copy(n.diffuseMapOffset),n.emissiveMapRotation=n.diffuseMapRotation,n.emissiveMapChannel=n.diffuseMapChannel,n.emissiveVertexColor=n.diffuseVertexColor,n.emissiveVertexColorChannel=n.diffuseVertexColorChannel,n.diffuse.set(0,0,0),n.diffuseTint=!1,n.diffuseMap=null,n.diffuseVertexColor=!1},en=function(e,n,t){if(n.useMetalnessSpecularColor=!0,e.hasOwnProperty("specularColorTexture")&&(n.specularEncoding="srgb",n.specularMap=t[e.specularColorTexture.index],n.specularMapChannel="rgb",qe(e.specularColorTexture,n,["specular"])),e.hasOwnProperty("specularColorFactor")){const t=e.specularColorFactor;n.specular.set(Math.pow(t[0],1/2.2),Math.pow(t[1],1/2.2),Math.pow(t[2],1/2.2))}else n.specular.set(1,1,1);e.hasOwnProperty("specularFactor")?n.specularityFactor=e.specularFactor:n.specularityFactor=1,e.hasOwnProperty("specularTexture")&&(n.specularityFactorMapChannel="a",n.specularityFactorMap=t[e.specularTexture.index],qe(e.specularTexture,n,["specularityFactor"]))},nn=function(e,n,t){e.hasOwnProperty("ior")&&(n.refractionIndex=1/e.ior)},tn=function(e,n,t){n.blendType=ie,n.useDynamicRefraction=!0,e.hasOwnProperty("transmissionFactor")&&(n.refraction=e.transmissionFactor),e.hasOwnProperty("transmissionTexture")&&(n.refractionMapChannel="r",n.refractionMap=t[e.transmissionTexture.index],qe(e.transmissionTexture,n,["refraction"]))},sn=function(e,n,t){if(n.useSheen=!0,e.hasOwnProperty("sheenColorFactor")){const t=e.sheenColorFactor;n.sheen.set(Math.pow(t[0],1/2.2),Math.pow(t[1],1/2.2),Math.pow(t[2],1/2.2))}else n.sheen.set(1,1,1);e.hasOwnProperty("sheenColorTexture")&&(n.sheenMap=t[e.sheenColorTexture.index],n.sheenEncoding="srgb",qe(e.sheenColorTexture,n,["sheen"])),e.hasOwnProperty("sheenRoughnessFactor")?n.sheenGlossiness=e.sheenRoughnessFactor:n.sheenGlossiness=0,e.hasOwnProperty("sheenRoughnessTexture")&&(n.sheenGlossinessMap=t[e.sheenRoughnessTexture.index],n.sheenGlossinessMapChannel="a",qe(e.sheenRoughnessTexture,n,["sheenGlossiness"]));n.chunks.sheenGlossPS="\n    #ifdef MAPFLOAT\n    uniform float material_sheenGlossiness;\n    #endif\n\n    #ifdef MAPTEXTURE\n    uniform sampler2D texture_sheenGlossinessMap;\n    #endif\n\n    void getSheenGlossiness() {\n        float sheenGlossiness = 1.0;\n\n        #ifdef MAPFLOAT\n        sheenGlossiness *= material_sheenGlossiness;\n        #endif\n\n        #ifdef MAPTEXTURE\n        sheenGlossiness *= texture2DBias(texture_sheenGlossinessMap, $UV, textureBias).$CH;\n        #endif\n\n        #ifdef MAPVERTEX\n        sheenGlossiness *= saturate(vVertexColor.$VC);\n        #endif\n\n        sheenGlossiness = 1.0 - sheenGlossiness;\n        sheenGlossiness += 0.0000001;\n        sGlossiness = sheenGlossiness;\n    }\n    "},rn=function(e,n,t){if(n.blendType=ie,n.useDynamicRefraction=!0,e.hasOwnProperty("thicknessFactor")&&(n.thickness=e.thicknessFactor),e.hasOwnProperty("thicknessTexture")&&(n.thicknessMap=t[e.thicknessTexture.index],qe(e.thicknessTexture,n,["thickness"])),e.hasOwnProperty("attenuationDistance")&&(n.attenuationDistance=e.attenuationDistance),e.hasOwnProperty("attenuationColor")){const t=e.attenuationColor;n.attenuation.set(Math.pow(t[0],1/2.2),Math.pow(t[1],1/2.2),Math.pow(t[2],1/2.2))}},on=function(e,n,t){e.hasOwnProperty("emissiveStrength")&&(n.emissiveIntensity=e.emissiveStrength)},an=function(e,n,t){n.useIridescence=!0,e.hasOwnProperty("iridescenceFactor")&&(n.iridescence=e.iridescenceFactor),e.hasOwnProperty("iridescenceTexture")&&(n.iridescenceMapChannel="r",n.iridescenceMap=t[e.iridescenceTexture.index],qe(e.iridescenceTexture,n,["iridescence"])),e.hasOwnProperty("iridescenceIor")&&(n.iridescenceRefractionIndex=e.iridescenceIor),e.hasOwnProperty("iridescenceThicknessMinimum")&&(n.iridescenceThicknessMin=e.iridescenceThicknessMinimum),e.hasOwnProperty("iridescenceThicknessMaximum")&&(n.iridescenceThicknessMax=e.iridescenceThicknessMaximum),e.hasOwnProperty("iridescenceThicknessTexture")&&(n.iridescenceThicknessMapChannel="g",n.iridescenceThicknessMap=t[e.iridescenceThicknessTexture.index],qe(e.iridescenceThicknessTexture,n,["iridescenceThickness"]))},cn=function(e,n,t){const s=new be;let r,o;if(s.occludeSpecular=oe,s.diffuseTint=!0,s.diffuseVertexColor=!0,s.specularTint=!0,s.specularVertexColor=!0,s.chunks.APIVersion=c,e.hasOwnProperty("name")&&(s.name=e.name),e.hasOwnProperty("pbrMetallicRoughness")){const t=e.pbrMetallicRoughness;if(t.hasOwnProperty("baseColorFactor")?(r=t.baseColorFactor,s.diffuse.set(Math.pow(r[0],1/2.2),Math.pow(r[1],1/2.2),Math.pow(r[2],1/2.2)),s.opacity=r[3]):(s.diffuse.set(1,1,1),s.opacity=1),t.hasOwnProperty("baseColorTexture")){const e=t.baseColorTexture;o=n[e.index],s.diffuseMap=o,s.diffuseMapChannel="rgb",s.opacityMap=o,s.opacityMapChannel="a",qe(e,s,["diffuse","opacity"])}if(s.useMetalness=!0,s.specular.set(1,1,1),t.hasOwnProperty("metallicFactor")?s.metalness=t.metallicFactor:s.metalness=1,t.hasOwnProperty("roughnessFactor")?s.shininess=100*t.roughnessFactor:s.shininess=100,t.hasOwnProperty("metallicRoughnessTexture")){const e=t.metallicRoughnessTexture;s.metalnessMap=s.glossMap=n[e.index],s.metalnessMapChannel="b",s.glossMapChannel="g",qe(e,s,["gloss","metalness"])}s.chunks.glossPS="\n        #ifdef MAPFLOAT\n        uniform float material_shininess;\n        #endif\n        \n        void getGlossiness() {\n            dGlossiness = 1.0;\n        \n        #ifdef MAPFLOAT\n            dGlossiness *= material_shininess;\n        #endif\n        \n        #ifdef MAPTEXTURE\n            dGlossiness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n        #endif\n        \n        #ifdef MAPVERTEX\n            dGlossiness *= saturate(vVertexColor.$VC);\n        #endif\n        \n            dGlossiness = 1.0 - dGlossiness;\n        \n            dGlossiness += 0.0000001;\n        }\n        "}if(e.hasOwnProperty("normalTexture")){const t=e.normalTexture;s.normalMap=n[t.index],qe(t,s,["normal"]),t.hasOwnProperty("scale")&&(s.bumpiness=t.scale)}if(e.hasOwnProperty("occlusionTexture")){const t=e.occlusionTexture;s.aoMap=n[t.index],s.aoMapChannel="r",qe(t,s,["ao"])}if(e.hasOwnProperty("emissiveFactor")?(r=e.emissiveFactor,s.emissive.set(Math.pow(r[0],1/2.2),Math.pow(r[1],1/2.2),Math.pow(r[2],1/2.2)),s.emissiveTint=!0):(s.emissive.set(0,0,0),s.emissiveTint=!1),e.hasOwnProperty("emissiveTexture")){const t=e.emissiveTexture;s.emissiveMap=n[t.index],qe(t,s,["emissive"])}if(e.hasOwnProperty("alphaMode"))switch(e.alphaMode){case"MASK":s.blendType=ae,e.hasOwnProperty("alphaCutoff")?s.alphaTest=e.alphaCutoff:s.alphaTest=.5;break;case"BLEND":s.blendType=ie,s.depthWrite=!1;break;default:s.blendType=ae}else s.blendType=ae;e.hasOwnProperty("doubleSided")?(s.twoSidedLighting=e.doubleSided,s.cull=e.doubleSided?l:u):(s.twoSidedLighting=!1,s.cull=u);const a={KHR_materials_clearcoat:Qe,KHR_materials_emissive_strength:on,KHR_materials_ior:nn,KHR_materials_iridescence:an,KHR_materials_pbrSpecularGlossiness:Je,KHR_materials_sheen:sn,KHR_materials_specular:en,KHR_materials_transmission:tn,KHR_materials_unlit:Ze,KHR_materials_volume:rn};if(e.hasOwnProperty("extensions"))for(const t in e.extensions){const r=a[t];void 0!==r&&r(e.extensions[t],s,n)}return s.update(),s},ln=function(e,n){const t=new he;if(e.hasOwnProperty("name")&&e.name.length>0?t.name=e.name:t.name="node_"+n,e.hasOwnProperty("matrix")&&(Xe.data.set(e.matrix),Xe.getTranslation(We),t.setLocalPosition(We),Xe.getEulerAngles(We),t.setLocalEulerAngles(We),Xe.getScale(We),t.setLocalScale(We)),e.hasOwnProperty("rotation")){const n=e.rotation;t.setLocalRotation(n[0],n[1],n[2],n[3])}if(e.hasOwnProperty("translation")){const n=e.translation;t.setLocalPosition(n[0],n[1],n[2])}if(e.hasOwnProperty("scale")){const n=e.scale;t.setLocalScale(n[0],n[1],n[2])}return t},un=function(e,n){const t="orthographic"===e.type?ce:le,s=t===ce?e.orthographic:e.perspective,o={enabled:!1,projection:t,nearClip:s.znear,aspectRatioMode:ue};s.zfar&&(o.farClip=s.zfar),t===ce?(o.orthoHeight=.5*s.ymag,s.ymag&&(o.aspectRatioMode=pe,o.aspectRatio=s.xmag/s.ymag)):(o.fov=s.yfov*r.RAD_TO_DEG,s.aspectRatio&&(o.aspectRatioMode=pe,o.aspectRatio=s.aspectRatio));const a=new Te(e.name);return a.addComponent("camera",o),a},fn=function(e,n){const s={enabled:!1,type:"point"===e.type?"omni":e.type,color:e.hasOwnProperty("color")?new t(e.color):t.WHITE,range:e.hasOwnProperty("range")?e.range:9999,falloffMode:fe,intensity:e.hasOwnProperty("intensity")?r.clamp(e.intensity,0,2):1};e.hasOwnProperty("spot")&&(s.innerConeAngle=e.spot.hasOwnProperty("innerConeAngle")?e.spot.innerConeAngle*r.RAD_TO_DEG:0,s.outerConeAngle=e.spot.hasOwnProperty("outerConeAngle")?e.spot.outerConeAngle*r.RAD_TO_DEG:Math.PI/4),e.hasOwnProperty("intensity")&&(s.luminance=e.intensity*me.getLightUnitConversion(de[s.type],s.outerConeAngle,s.innerConeAngle));const o=new Te(n.name);return o.rotateLocal(90,0,0),o.addComponent("light",s),o},pn=function(e,n,t,r){if(!n.hasOwnProperty("skins")||0===n.skins.length)return[];const o=new Map;return n.skins.map((function(a){return function(e,n,t,r,o,a){let i,c,l;const u=n.joints,f=u.length,p=[];if(n.hasOwnProperty("inverseBindMatrices")){const e=n.inverseBindMatrices,o=He(t[e],r,!0),a=[];for(i=0;i<f;i++){for(c=0;c<16;c++)a[c]=o[16*i+c];l=new s,l.set(a),p.push(l)}}else for(i=0;i<f;i++)l=new s,p.push(l);const h=[];for(i=0;i<f;i++)h[i]=o[u[i]].name;const m=h.join("#");let d=a.get(m);return d||(d=new Pe(e,p,h),a.set(m,d)),d}(e,a,n.accessors,r,t,o)}))},hn=function(e,n,t,s){if(!e.hasOwnProperty("animations")||0===e.animations.length)return[];const r=s&&s.animation&&s.animation.preprocess,o=s&&s.animation&&s.animation.postprocess;return e.animations.map((function(s,a){r&&r(s);const i=function(e,n,t,s,r,o){const a=function(e){return new Ae(Ve(e.type),Ne(e,s))},i={STEP:_e,LINEAR:Me,CUBICSPLINE:Ce},c={},l={},u={};let f,p=1;for(f=0;f<e.samplers.length;++f){const n=e.samplers[f];c.hasOwnProperty(n.input)||(c[n.input]=a(t[n.input])),l.hasOwnProperty(n.output)||(l[n.output]=a(t[n.output]));const s=n.hasOwnProperty("interpolation")&&i.hasOwnProperty(n.interpolation)?i[n.interpolation]:Me,r={paths:[],input:n.input,output:n.output,interpolation:s};u[f]=r}const h=[],m={translation:"localPosition",rotation:"localRotation",scale:"localScale"},d=e=>{const n=[];for(;e;)n.unshift(e.name),e=e.parent;return n},y=(e,n)=>{if(!o)return n;for(let t=0;t<o.length;t++){const s=o[t];if(s.name===e&&s.hasOwnProperty("extras")&&s.extras.hasOwnProperty("targetNames")&&s.extras.targetNames[n])return`name.${s.extras.targetNames[n]}`}return n},g=(e,n,t)=>{if(!l[e.output])return;const s=l[e.output].data.length/c[e.input].data.length,r=l[e.output].data.length/s;for(let o=0;o<s;o++){const a=new Float32Array(r);for(let n=0;n<r;n++)a[n]=l[e.output].data[n*s+o];const i=new Ae(1,a);l[-p]=i;const c={paths:[{entityPath:t,component:"graph",propertyPath:[`weight.${y(n.name,o)}`]}],input:e.input,output:-p,interpolation:e.interpolation};p++,u[`morphCurve-${f}-${o}`]=c}};for(f=0;f<e.channels.length;++f){const n=e.channels[f],t=n.target,s=u[n.sampler],o=r[t.node],a=d(o);t.path.startsWith("weights")?(g(s,o,a),u[n.sampler].morphCurve=!0):s.paths.push({entityPath:a,component:"graph",propertyPath:[m[t.path]]})}const w=[],O=[],x=[];for(const e in c)w.push(c[e]),c[e]=w.length-1;for(const e in l)O.push(l[e]),l[e]=O.length-1;for(const e in u){const n=u[e];n.morphCurve||(x.push(new ve(n.paths,c[n.input],l[n.output],n.interpolation)),n.paths.length>0&&"localRotation"===n.paths[0].propertyPath[0]&&n.interpolation!==Ce&&h.push(x[x.length-1].output))}h.sort();let P,b=null;for(f=0;f<h.length;++f){const e=h[f];if(0===f||e!==b){if(P=O[e],4===P.components){const e=P.data,n=e.length-4;for(let t=0;t<n;t+=4)e[t+0]*e[t+4]+e[t+1]*e[t+5]+e[t+2]*e[t+6]+e[t+3]*e[t+7]<0&&(e[t+4]*=-1,e[t+5]*=-1,e[t+6]*=-1,e[t+7]*=-1)}b=e}}let T=0;for(f=0;f<w.length;f++)P=w[f]._data,T=Math.max(T,0===P.length?0:P[P.length-1]);return new Re(e.hasOwnProperty("name")?e.name:"animation_"+n,T,w,O,x)}(s,a,e.accessors,t,n,e.meshes);return o&&o(s,i),i}))},mn=function(e,n,t,s,r,o){const a=r&&r.global&&r.global.preprocess,i=r&&r.global&&r.global.postprocess;a&&a(n);const c=n.asset&&"PlayCanvas"===n.asset.generator,l=function(e,n){if(!e.hasOwnProperty("nodes")||0===e.nodes.length)return[];const t=n&&n.node&&n.node.preprocess,s=n&&n.node&&n.node.process||ln,r=n&&n.node&&n.node.postprocess,o=e.nodes.map((function(e,n){t&&t(e);const o=s(e,n);return r&&r(e,o),o}));for(let n=0;n<e.nodes.length;++n){const t=e.nodes[n];if(t.hasOwnProperty("children")){const e=o[n],s={};for(let n=0;n<t.children.length;++n){const r=o[t.children[n]];r.parent||(s.hasOwnProperty(r.name)?r.name+=s[r.name]++:s[r.name]=1,e.addChild(r))}}}return o}(n,r),u=function(e,n){var t;const s=[],r=e.scenes.length;if(1===r&&1===(null==(t=e.scenes[0].nodes)?void 0:t.length)){const t=e.scenes[0].nodes[0];s.push(n[t])}else for(let t=0;t<r;t++){const r=e.scenes[t];if(r.nodes){const e=new he(r.name);for(let t=0;t<r.nodes.length;t++){const s=n[r.nodes[t]];e.addChild(s)}s.push(e)}}return s}(n,l),f=function(e,n,t){let s=null;if(e.hasOwnProperty("nodes")&&e.hasOwnProperty("extensions")&&e.extensions.hasOwnProperty("KHR_lights_punctual")&&e.extensions.KHR_lights_punctual.hasOwnProperty("lights")){const r=e.extensions.KHR_lights_punctual.lights;if(r.length){const o=t&&t.light&&t.light.preprocess,a=t&&t.light&&t.light.process||fn,i=t&&t.light&&t.light.postprocess;e.nodes.forEach((function(e,t){if(e.hasOwnProperty("extensions")&&e.extensions.hasOwnProperty("KHR_lights_punctual")&&e.extensions.KHR_lights_punctual.hasOwnProperty("light")){const c=e.extensions.KHR_lights_punctual.light,l=r[c];if(l){o&&o(l);const r=a(l,n[t]);i&&i(l,r),r&&(s||(s=new Map),s.set(e,r))}}}))}}return s}(n,l,r),p=function(e,n,t){let s=null;if(e.hasOwnProperty("nodes")&&e.hasOwnProperty("cameras")&&e.cameras.length>0){const r=t&&t.camera&&t.camera.preprocess,o=t&&t.camera&&t.camera.process||un,a=t&&t.camera&&t.camera.postprocess;e.nodes.forEach((function(t,i){if(t.hasOwnProperty("camera")){const c=e.cameras[t.camera];if(c){r&&r(c);const e=o(c,n[i]);a&&a(c,e),e&&(s||(s=new Map),s.set(t,e))}}}))}return s}(n,l,r),h=hn(n,l,t,r),m=function(e,n,t,s){if(!e.hasOwnProperty("materials")||0===e.materials.length)return[];const r=t&&t.material&&t.material.preprocess,o=t&&t.material&&t.material.process||cn,a=t&&t.material&&t.material.postprocess;return e.materials.map((function(e){r&&r(e);const t=o(e,n,s);return a&&a(e,t),t}))}(n,s.map((function(e){return e.resource})),r,c),d=function(e){if(!e.hasOwnProperty("extensions")||!e.extensions.hasOwnProperty("KHR_materials_variants"))return null;const n=e.extensions.KHR_materials_variants.variants,t={};for(let e=0;e<n.length;e++)t[n[e].name]=e;return t}(n),y={},g={},w=function(e,n,t,s,r,o,a,i){if(!n.hasOwnProperty("meshes")||0===n.meshes.length||!n.hasOwnProperty("accessors")||0===n.accessors.length||!n.hasOwnProperty("bufferViews")||0===n.bufferViews.length)return[];const c={};return n.meshes.map((function(l){return Ye(e,l,n.accessors,t,s,r,c,o,a,i)}))}(e,n,t,o,c,y,g,r),O=pn(e,n,l,t),x=[];for(let e=0;e<w.length;e++)x[e]=new xe,x[e].meshes=w[e];!function(e,n,t){e.nodes.forEach((e=>{e.hasOwnProperty("mesh")&&e.hasOwnProperty("skin")&&n[e.mesh].meshes.forEach((n=>{n.skin=t[e.skin]}))}))}(n,x,O);const P=new Ue(n);P.nodes=l,P.scenes=u,P.animations=h,P.textures=s,P.materials=m,P.variants=d,P.meshVariants=y,P.meshDefaultMaterials=g,P.renders=x,P.skins=O,P.lights=f,P.cameras=p,i&&i(n,P),o(null,P)};let dn=0;const yn=function(n,t,s,r,o,a,i){const c=a&&a.image&&a.image.preprocess,l=a&&a.image&&a.image.processAsync||function(e,n){n(null,null)},u=a&&a.image&&a.image.postprocess,f=function(e){u&&u(n,e),i(null,e)},p={"image/png":"png","image/jpeg":"jpg","image/basis":"basis","image/ktx":"ktx","image/ktx2":"ktx2","image/vnd-ms.dds":"dds"},h=function(e,t,s,r){const a=(n.name||"gltf-texture")+"-"+dn++,c={url:e||a};if(t&&(c.contents=t.slice(0).buffer),s){const e=p[s];e&&(c.filename=c.url+"."+e)}const l=new Ee(a,"texture",c,null,r);l.on("load",f),l.on("error",i),o.add(l),o.load(l)};c&&c(n),l(n,(function(o,a){var c;o?i(o):a?f(a):n.hasOwnProperty("uri")?De(n.uri)?h(n.uri,null,(c=n.uri).substring(c.indexOf(":")+1,c.indexOf(";")),null):h(e.join(r,n.uri),null,null,{crossOrigin:"anonymous"}):n.hasOwnProperty("bufferView")&&n.hasOwnProperty("mimeType")?h(null,s[n.bufferView],n.mimeType,null):i("Invalid image found in gltf (neither uri or bufferView found). index="+t)}))},gn=function(e,n,t,s,r,o){if(!e.hasOwnProperty("images")||0===e.images.length||!e.hasOwnProperty("textures")||0===e.textures.length)return void o(null,[]);const a=r&&r.texture&&r.texture.preprocess,i=r&&r.texture&&r.texture.processAsync||function(e,n,t){t(null,null)},c=r&&r.texture&&r.texture.postprocess,l=[],u=[];let f=e.textures.length;const p=function(n,t){if(u[t]||(u[t]=[]),u[t].push(n),0==--f){const n=[];u.forEach((function(t,s){t.forEach((function(t,r){const o=0===r?l[s]:Be(l[s]);!function(e,n){const t=function(e,n){switch(e){case 9728:return R;case 9729:return A;case 9984:return v;case 9985:return _;case 9986:return C;case 9987:return M;default:return n}},s=function(e,n){switch(e){case 33071:return G;case 33648:return F;case 10497:return E;default:return n}};e&&(n=n||{},e.minFilter=t(n.minFilter,M),e.magFilter=t(n.magFilter,A),e.addressU=s(n.wrapS,E),e.addressV=s(n.wrapT,E))}(o.resource,(e.samplers||[])[e.textures[t].sampler]),n[t]=o,c&&c(e.textures[t],o)}))})),o(null,n)}};for(let c=0;c<e.textures.length;++c){const u=e.textures[c];a&&a(u),i(u,e.images,function(a,i,c,u){if(c)o(c);else{var f,h;if(null==u)void 0===(u=null==i||null==(f=i.extensions)||null==(h=f.KHR_texture_basisu)?void 0:h.source)&&(u=i.source);if(l[u])p(a,u);else{const i=e.images[u];yn(i,a,n,t,s,r,(function(e,n){e?o(e):(l[u]=n,p(a,u))}))}}}.bind(null,c,u))}},wn=function(e,t){const s=JSON.parse(function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);let n="";for(let t=0;t<e.length;t++)n+=String.fromCharCode(e[t]);return decodeURIComponent(escape(n))}(e));if(s.asset&&s.asset.version&&parseFloat(s.asset.version)<2)return void t(`Invalid gltf version. Expected version 2.0 or above but found version '${s.asset.version}'.`);const r=(null==s?void 0:s.extensionsRequired)||[];Ge||ke()||-1===r.indexOf("KHR_draco_mesh_compression")?t(null,s):n.getInstance("DracoDecoderModule",(e=>{Ge=e,t(null,s)}))},On=function(e,n,t){e&&e.toLowerCase().endsWith(".glb")||(()=>{const e=new Uint8Array(n);return 103===e[0]&&108===e[1]&&84===e[2]&&70===e[3]})()?function(e,n){const t=e instanceof ArrayBuffer?new DataView(e):new DataView(e.buffer,e.byteOffset,e.byteLength),s=t.getUint32(0,!0),r=t.getUint32(4,!0),o=t.getUint32(8,!0);if(1179937895!==s)return void n("Invalid magic number found in glb header. Expected 0x46546C67, found 0x"+s.toString(16));if(2!==r)return void n("Invalid version number found in glb header. Expected 2, found "+r);if(o<=0||o>t.byteLength)return void n("Invalid length found in glb header. Found "+o);const a=[];let i=12;for(;i<o;){const e=t.getUint32(i,!0);if(i+e+8>t.byteLength)throw new Error("Invalid chunk length found in glb. Found "+e);const n=t.getUint32(i+4,!0),s=new Uint8Array(t.buffer,t.byteOffset+i+8,e);a.push({length:e,type:n,data:s}),i+=e+8}1===a.length||2===a.length?1313821514===a[0].type?a.length>1&&5130562!==a[1].type?n("Invalid chunk type found in glb file. Expected 0x004E4942, found 0x"+a[1].type.toString(16)):n(null,{gltfChunk:a[0].data,binaryChunk:2===a.length?a[1].data:null}):n("Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x"+a[0].type.toString(16)):n("Invalid number of chunks found in glb file.")}(n,t):t(null,{gltfChunk:n,binaryChunk:null})},xn=function(e,n,t,s){const r=[],o=t&&t.bufferView&&t.bufferView.preprocess,a=t&&t.bufferView&&t.bufferView.processAsync||function(e,n,t){t(null,null)},i=t&&t.bufferView&&t.bufferView.postprocess;let c=e.bufferViews?e.bufferViews.length:0;if(!c)return void s(null,null);const l=function(n,t){const o=e.bufferViews[n];o.hasOwnProperty("byteStride")&&(t.byteStride=o.byteStride),r[n]=t,i&&i(o,t),0==--c&&s(null,r)};for(let t=0;t<e.bufferViews.length;++t){const r=e.bufferViews[t];o&&o(r),a(r,n,function(e,t,r,o){if(r)s(r);else if(o)l(e,o);else{const s=n[t.buffer],r=new Uint8Array(s.buffer,s.byteOffset+(t.byteOffset||0),t.byteLength);l(e,r)}}.bind(null,t,r))}};class Pn{static parseAsync(n,t,s,r,o,a,i){On(n,s,(function(n,s){n?i(n):wn(s.gltfChunk,(function(n,c){n?i(n):function(n,t,s,r,o){const a=[];if(!n.buffers||0===n.buffers.length)return void o(null,a);const i=r&&r.buffer&&r.buffer.preprocess,c=r&&r.buffer&&r.buffer.processAsync||function(e,n){n(null,null)},l=r&&r.buffer&&r.buffer.postprocess;let u=n.buffers.length;const f=function(e,t){a[e]=t,l&&l(n.buffers[e],t),0==--u&&o(null,a)};for(let r=0;r<n.buffers.length;++r){const a=n.buffers[r];i&&i(a),c(a,function(n,r,a,i){if(a)o(a);else if(i)f(n,new Uint8Array(i));else if(r.hasOwnProperty("uri"))if(De(r.uri)){const e=atob(r.uri.split(",")[1]),t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);f(n,t)}else re.get(e.join(s,r.uri),{cache:!0,responseType:"arraybuffer",retry:!1},function(e,n,t){n?o(n):f(e,new Uint8Array(t))}.bind(null,n));else f(n,t)}.bind(null,r,a))}}(c,s.binaryChunk,t,a,(function(e,n){e?i(e):xn(c,n,a,(function(e,n){e?i(e):gn(c,n,t,o,a,(function(e,t){e?i(e):mn(r,c,n,t,a,i)}))}))}))}))}))}static parse(e,n,t,s){let r=null;return s=s||{},On(e,n,(function(e,n){e?console.error(e):wn(n.gltfChunk,(function(e,o){e?console.error(e):xn(o,[n.binaryChunk],s,(function(e,n){e?console.error(e):mn(t,o,n,[],s,(function(e,n){e?console.error(e):r=n}))}))}))})),r}constructor(e,n,t){this._device=e,this._assets=n,this._defaultMaterial=cn({name:"defaultGlbMaterial"},[]),this.maxRetries=t}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}load(n,t,s){Ee.fetchArrayBuffer(n.load,((r,o)=>{r?t(r):Pn.parseAsync(this._getUrlWithoutParams(n.original),e.extractPath(n.load),o,this._device,s.registry,s.options,((e,n)=>{e?t(e):t(null,new Fe(n,s,this._assets,this._defaultMaterial))}))}),s,this.maxRetries)}open(e,n,t){return n}patch(e,n){}}export{Pn as GlbParser};
