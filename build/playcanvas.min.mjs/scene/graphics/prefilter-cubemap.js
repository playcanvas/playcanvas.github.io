import"../../core/debug.js";import{Vec3 as e}from"../../core/math/vec3.js";import{PIXELFORMAT_RGBA8 as t,TEXTURETYPE_DEFAULT as r,TEXTURETYPE_RGBM as l}from"../../platform/graphics/constants.js";import{createShaderFromCode as o}from"../shader-lib/utils.js";import{drawQuadWithShader as s}from"./quad-render-utils.js";import{shaderChunks as n}from"../shader-lib/chunks/chunks.js";import{RenderTarget as a}from"../../platform/graphics/render-target.js";import{Texture as f}from"../../platform/graphics/texture.js";import{BlendState as i}from"../../platform/graphics/blend-state.js";function m(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}function c(e,t,r){let l=2*(e+.5)/r-1,o=2*(t+.5)/r-1;l*=1-1/r,o*=1-1/r;const s=1/r,n=l-s,a=o-s,f=l+s,i=o+s;let c=m(n,a)-m(n,i)-m(f,a)+m(f,i);return 0===e&&0===t||e===r-1&&0===t||0===e&&t===r-1||e===r-1&&t===r-1?c/=3:0!==e&&0!==t&&e!==r-1&&t!==r-1||(c*=.5),c}function p(m,p,u){if(p.format!==t)return null;if(!p._levels[0]||!p._levels[0][0])return null;const h=p.width;if(!p._levels[0][0].length){if(!(p._levels[0][0]instanceof HTMLImageElement))return null;{const e=o(m,n.fullscreenQuadVS,n.fullscreenQuadPS,"fsQuadSimple"),t=m.scope.resolve("source");for(let l=0;l<6;l++){const o=p._levels[0][l],n=new f(m,{name:"prefiltered-cube",cubemap:!1,type:r,format:p.format,width:h,height:h,mipmaps:!1});n._levels[0]=o,n.upload();const c=new f(m,{name:"prefiltered-cube",cubemap:!1,type:r,format:p.format,width:h,height:h,mipmaps:!1}),u=new a({colorBuffer:c,depth:!1});t.setValue(n),m.setBlendState(i.NOBLEND),s(m,u,e);const d=m.gl;d.bindFramebuffer(d.FRAMEBUFFER,u.impl._glFrameBuffer);const g=new Uint8Array(h*h*4);d.readPixels(0,0,n.width,n.height,d.RGBA,d.UNSIGNED_BYTE,g),p._levels[0][l]=g}}}const d=[];for(let t=0;t<h;t++)for(let r=0;r<h;r++){const l=r/(h-1)*2-1,o=t/(h-1)*2-1;d[t*h+r]=new e(l,o,1).normalize()}const g=new Float32Array(27);let v=0;for(let e=0;e<6;e++)for(let t=0;t<h;t++)for(let r=0;r<h;r++){const o=t*h+r,s=c(r,t,h),n=4*s/17,a=8*s/17,f=15*s/17,i=5*s/68,m=15*s/68,w=d[o];let y,_,b;0===e?(y=w.z,_=-w.y,b=-w.x):1===e?(y=-w.z,_=-w.y,b=w.x):2===e?(y=w.x,_=w.z,b=w.y):3===e?(y=w.x,_=-w.z,b=-w.y):4===e?(y=w.x,_=-w.y,b=w.z):5===e&&(y=-w.x,_=-w.y,b=-w.z),u||(y=-y);const j=p._levels[0][e][4*o+3]/255;for(let t=0;t<3;t++){let r=p._levels[0][e][4*o+t]/255;p.type===l?(r*=8*j,r*=r):r=Math.pow(r,2.2),g[0+t]+=r*n,g[3+t]+=r*a*y,g[6+t]+=r*a*_,g[9+t]+=r*a*b,g[12+t]+=r*f*y*b,g[15+t]+=r*f*b*_,g[18+t]+=r*f*_*y,g[21+t]+=r*i*(3*b*b-1),g[24+t]+=r*m*(y*y-_*_),v+=s}}for(let e=0;e<g.length;e++)g[e]*=4*Math.PI/v;return g}export{p as shFromCubemap};
