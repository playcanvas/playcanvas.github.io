/**
 * @license
 * PlayCanvas Engine v1.57.1 revision 256dd83c2 (DEBUG PROFILER)
 * Copyright 2011-2022 PlayCanvas Ltd. All rights reserved.
 */
import { createShaderFromCode } from '../../graphics/program-lib/utils.js';
import { shaderChunks } from '../../graphics/program-lib/chunks/chunks.js';
import { shaderChunksLightmapper } from '../../graphics/program-lib/chunks/chunks-lightmapper.js';

const DENOISE_FILTER_SIZE = 15;

class LightmapFilters {
  constructor(device) {
    this.device = device;
    this.shaderDilate = createShaderFromCode(device, shaderChunks.fullscreenQuadVS, shaderChunksLightmapper.dilatePS, 'lmDilate');
    this.constantTexSource = device.scope.resolve('source');
    this.constantPixelOffset = device.scope.resolve('pixelOffset');
    this.pixelOffset = new Float32Array(2);
    this.shaderDenoise = null;
    this.sigmas = null;
    this.constantSigmas = null;
    this.kernel = null;
  }

  setSourceTexture(texture) {
    this.constantTexSource.setValue(texture);
  }

  prepare(textureWidth, textureHeight) {
    this.pixelOffset[0] = 1 / textureWidth;
    this.pixelOffset[1] = 1 / textureHeight;
    this.constantPixelOffset.setValue(this.pixelOffset);
  }

  prepareDenoise(filterRange, filterSmoothness) {
    if (!this.shaderDenoise) {
      this.shaderDenoise = createShaderFromCode(this.device, shaderChunks.fullscreenQuadVS, shaderChunksLightmapper.bilateralDeNoisePS, 'lmBilateralDeNoise');
      this.sigmas = new Float32Array(2);
      this.constantSigmas = this.device.scope.resolve('sigmas');
      this.constantKernel = this.device.scope.resolve('kernel[0]');
      this.bZnorm = this.device.scope.resolve('bZnorm');
    }

    this.sigmas[0] = filterRange;
    this.sigmas[1] = filterSmoothness;
    this.constantSigmas.setValue(this.sigmas);
    this.evaluateDenoiseUniforms(filterRange, filterSmoothness);
  }

  evaluateDenoiseUniforms(filterRange, filterSmoothness) {
    function normpdf(x, sigma) {
      return 0.39894 * Math.exp(-0.5 * x * x / (sigma * sigma)) / sigma;
    }

    this.kernel = this.kernel || new Float32Array(DENOISE_FILTER_SIZE);
    const kernel = this.kernel;
    const kSize = Math.floor((DENOISE_FILTER_SIZE - 1) / 2);

    for (let j = 0; j <= kSize; ++j) {
      const value = normpdf(j, filterRange);
      kernel[kSize + j] = value;
      kernel[kSize - j] = value;
    }

    this.constantKernel.setValue(this.kernel);
    const bZnorm = 1 / normpdf(0.0, filterSmoothness);
    this.bZnorm.setValue(bZnorm);
  }

}

export { LightmapFilters };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlnaHRtYXAtZmlsdGVycy5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL3NjZW5lL2xpZ2h0bWFwcGVyL2xpZ2h0bWFwLWZpbHRlcnMuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY3JlYXRlU2hhZGVyRnJvbUNvZGUgfSBmcm9tICcuLi8uLi9ncmFwaGljcy9wcm9ncmFtLWxpYi91dGlscy5qcyc7XG5pbXBvcnQgeyBzaGFkZXJDaHVua3MgfSBmcm9tICcuLi8uLi9ncmFwaGljcy9wcm9ncmFtLWxpYi9jaHVua3MvY2h1bmtzLmpzJztcbmltcG9ydCB7IHNoYWRlckNodW5rc0xpZ2h0bWFwcGVyIH0gZnJvbSAnLi4vLi4vZ3JhcGhpY3MvcHJvZ3JhbS1saWIvY2h1bmtzL2NodW5rcy1saWdodG1hcHBlci5qcyc7XG5cbi8vIHNpemUgb2YgdGhlIGtlcm5lbCAtIG5lZWRzIHRvIG1hdGNoIHRoZSBjb25zdGFudCBpbiB0aGUgc2hhZGVyXG5jb25zdCBERU5PSVNFX0ZJTFRFUl9TSVpFID0gMTU7XG5cbi8vIGhlbHBlciBjbGFzcyB1c2VkIGJ5IGxpZ2h0bWFwcGVyLCB3cmFwcGluZyBmdW5jdGlvbmFsaXR5IG9mIGRpbGF0ZSBhbmQgZGVub2lzZSBzaGFkZXJzXG5jbGFzcyBMaWdodG1hcEZpbHRlcnMge1xuICAgIGNvbnN0cnVjdG9yKGRldmljZSkge1xuICAgICAgICB0aGlzLmRldmljZSA9IGRldmljZTtcbiAgICAgICAgdGhpcy5zaGFkZXJEaWxhdGUgPSBjcmVhdGVTaGFkZXJGcm9tQ29kZShkZXZpY2UsIHNoYWRlckNodW5rcy5mdWxsc2NyZWVuUXVhZFZTLCBzaGFkZXJDaHVua3NMaWdodG1hcHBlci5kaWxhdGVQUywgJ2xtRGlsYXRlJyk7XG5cbiAgICAgICAgdGhpcy5jb25zdGFudFRleFNvdXJjZSA9IGRldmljZS5zY29wZS5yZXNvbHZlKCdzb3VyY2UnKTtcblxuICAgICAgICB0aGlzLmNvbnN0YW50UGl4ZWxPZmZzZXQgPSBkZXZpY2Uuc2NvcGUucmVzb2x2ZSgncGl4ZWxPZmZzZXQnKTtcbiAgICAgICAgdGhpcy5waXhlbE9mZnNldCA9IG5ldyBGbG9hdDMyQXJyYXkoMik7XG5cbiAgICAgICAgLy8gZGVub2lzZSBpcyBvcHRpb25hbCBhbmQgZ2V0cyBjcmVhdGVkIG9ubHkgd2hlbiBuZWVkZWRcbiAgICAgICAgdGhpcy5zaGFkZXJEZW5vaXNlID0gbnVsbDtcbiAgICAgICAgdGhpcy5zaWdtYXMgPSBudWxsO1xuICAgICAgICB0aGlzLmNvbnN0YW50U2lnbWFzID0gbnVsbDtcbiAgICAgICAgdGhpcy5rZXJuZWwgPSBudWxsO1xuICAgIH1cblxuICAgIHNldFNvdXJjZVRleHR1cmUodGV4dHVyZSkge1xuICAgICAgICB0aGlzLmNvbnN0YW50VGV4U291cmNlLnNldFZhbHVlKHRleHR1cmUpO1xuICAgIH1cblxuICAgIHByZXBhcmUodGV4dHVyZVdpZHRoLCB0ZXh0dXJlSGVpZ2h0KSB7XG5cbiAgICAgICAgLy8gaW52ZXJzZSB0ZXh0dXJlIHNpemVcbiAgICAgICAgdGhpcy5waXhlbE9mZnNldFswXSA9IDEgLyB0ZXh0dXJlV2lkdGg7XG4gICAgICAgIHRoaXMucGl4ZWxPZmZzZXRbMV0gPSAxIC8gdGV4dHVyZUhlaWdodDtcbiAgICAgICAgdGhpcy5jb25zdGFudFBpeGVsT2Zmc2V0LnNldFZhbHVlKHRoaXMucGl4ZWxPZmZzZXQpO1xuICAgIH1cblxuICAgIHByZXBhcmVEZW5vaXNlKGZpbHRlclJhbmdlLCBmaWx0ZXJTbW9vdGhuZXNzKSB7XG5cbiAgICAgICAgaWYgKCF0aGlzLnNoYWRlckRlbm9pc2UpIHtcbiAgICAgICAgICAgIHRoaXMuc2hhZGVyRGVub2lzZSA9IGNyZWF0ZVNoYWRlckZyb21Db2RlKHRoaXMuZGV2aWNlLCBzaGFkZXJDaHVua3MuZnVsbHNjcmVlblF1YWRWUywgc2hhZGVyQ2h1bmtzTGlnaHRtYXBwZXIuYmlsYXRlcmFsRGVOb2lzZVBTLCAnbG1CaWxhdGVyYWxEZU5vaXNlJyk7XG4gICAgICAgICAgICB0aGlzLnNpZ21hcyA9IG5ldyBGbG9hdDMyQXJyYXkoMik7XG4gICAgICAgICAgICB0aGlzLmNvbnN0YW50U2lnbWFzID0gdGhpcy5kZXZpY2Uuc2NvcGUucmVzb2x2ZSgnc2lnbWFzJyk7XG4gICAgICAgICAgICB0aGlzLmNvbnN0YW50S2VybmVsID0gdGhpcy5kZXZpY2Uuc2NvcGUucmVzb2x2ZSgna2VybmVsWzBdJyk7XG4gICAgICAgICAgICB0aGlzLmJabm9ybSA9IHRoaXMuZGV2aWNlLnNjb3BlLnJlc29sdmUoJ2Jabm9ybScpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zaWdtYXNbMF0gPSBmaWx0ZXJSYW5nZTtcbiAgICAgICAgdGhpcy5zaWdtYXNbMV0gPSBmaWx0ZXJTbW9vdGhuZXNzO1xuICAgICAgICB0aGlzLmNvbnN0YW50U2lnbWFzLnNldFZhbHVlKHRoaXMuc2lnbWFzKTtcblxuICAgICAgICB0aGlzLmV2YWx1YXRlRGVub2lzZVVuaWZvcm1zKGZpbHRlclJhbmdlLCBmaWx0ZXJTbW9vdGhuZXNzKTtcbiAgICB9XG5cbiAgICBldmFsdWF0ZURlbm9pc2VVbmlmb3JtcyhmaWx0ZXJSYW5nZSwgZmlsdGVyU21vb3RobmVzcykge1xuXG4gICAgICAgIGZ1bmN0aW9uIG5vcm1wZGYoeCwgc2lnbWEpIHtcbiAgICAgICAgICAgIHJldHVybiAwLjM5ODk0ICogTWF0aC5leHAoLTAuNSAqIHggKiB4IC8gKHNpZ21hICogc2lnbWEpKSAvIHNpZ21hO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8ga2VybmVsXG4gICAgICAgIHRoaXMua2VybmVsID0gdGhpcy5rZXJuZWwgfHwgbmV3IEZsb2F0MzJBcnJheShERU5PSVNFX0ZJTFRFUl9TSVpFKTtcbiAgICAgICAgY29uc3Qga2VybmVsID0gdGhpcy5rZXJuZWw7XG4gICAgICAgIGNvbnN0IGtTaXplID0gTWF0aC5mbG9vcigoREVOT0lTRV9GSUxURVJfU0laRSAtIDEpIC8gMik7XG4gICAgICAgIGZvciAobGV0IGogPSAwOyBqIDw9IGtTaXplOyArK2opIHtcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gbm9ybXBkZihqLCBmaWx0ZXJSYW5nZSk7XG4gICAgICAgICAgICBrZXJuZWxba1NpemUgKyBqXSA9IHZhbHVlO1xuICAgICAgICAgICAga2VybmVsW2tTaXplIC0gal0gPSB2YWx1ZTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmNvbnN0YW50S2VybmVsLnNldFZhbHVlKHRoaXMua2VybmVsKTtcblxuICAgICAgICBjb25zdCBiWm5vcm0gPSAxIC8gbm9ybXBkZigwLjAsIGZpbHRlclNtb290aG5lc3MpO1xuICAgICAgICB0aGlzLmJabm9ybS5zZXRWYWx1ZShiWm5vcm0pO1xuICAgIH1cbn1cblxuZXhwb3J0IHsgTGlnaHRtYXBGaWx0ZXJzIH07XG4iXSwibmFtZXMiOlsiREVOT0lTRV9GSUxURVJfU0laRSIsIkxpZ2h0bWFwRmlsdGVycyIsImNvbnN0cnVjdG9yIiwiZGV2aWNlIiwic2hhZGVyRGlsYXRlIiwiY3JlYXRlU2hhZGVyRnJvbUNvZGUiLCJzaGFkZXJDaHVua3MiLCJmdWxsc2NyZWVuUXVhZFZTIiwic2hhZGVyQ2h1bmtzTGlnaHRtYXBwZXIiLCJkaWxhdGVQUyIsImNvbnN0YW50VGV4U291cmNlIiwic2NvcGUiLCJyZXNvbHZlIiwiY29uc3RhbnRQaXhlbE9mZnNldCIsInBpeGVsT2Zmc2V0IiwiRmxvYXQzMkFycmF5Iiwic2hhZGVyRGVub2lzZSIsInNpZ21hcyIsImNvbnN0YW50U2lnbWFzIiwia2VybmVsIiwic2V0U291cmNlVGV4dHVyZSIsInRleHR1cmUiLCJzZXRWYWx1ZSIsInByZXBhcmUiLCJ0ZXh0dXJlV2lkdGgiLCJ0ZXh0dXJlSGVpZ2h0IiwicHJlcGFyZURlbm9pc2UiLCJmaWx0ZXJSYW5nZSIsImZpbHRlclNtb290aG5lc3MiLCJiaWxhdGVyYWxEZU5vaXNlUFMiLCJjb25zdGFudEtlcm5lbCIsImJabm9ybSIsImV2YWx1YXRlRGVub2lzZVVuaWZvcm1zIiwibm9ybXBkZiIsIngi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
