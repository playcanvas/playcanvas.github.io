import { math } from '../../../core/math/math.js';
import { AnimBlendTree } from './anim-blend-tree.js';

/**
 * An AnimBlendTree that calculates its weights using a 1D algorithm based on the thesis
 * http://runevision.com/thesis/rune_skovbo_johansen_thesis.pdf Chapter 6.
 *
 * @ignore
 */
class AnimBlendTree1D extends AnimBlendTree {
  /**
   * Create a new BlendTree1D instance.
   *
   * @param {AnimState} state - The AnimState that this AnimBlendTree belongs to.
   * @param {AnimBlendTree|null} parent - The parent of the AnimBlendTree. If not null, the
   * AnimNode is stored as part of a {@link AnimBlendTree} hierarchy.
   * @param {string} name - The name of the BlendTree. Used when assigning a {@link AnimTrack} to
   * its children.
   * @param {number|Vec2} point - The coordinate/vector thats used to determine the weight of this
   * node when it's part of a {@link AnimBlendTree}.
   * @param {string[]} parameters - The anim component parameters which are used to calculate the
   * current weights of the blend trees children.
   * @param {object[]} children - The child nodes that this blend tree should create. Can either
   * be of type {@link AnimNode} or {@link BlendTree}.
   * @param {boolean} syncAnimations - If true, the speed of each blended animation will be
   * synchronized.
   * @param {Function} createTree - Used to create child blend trees of varying types.
   * @param {Function} findParameter - Used at runtime to get the current parameter values.
   */
  constructor(state, parent, name, point, parameters, children, syncAnimations, createTree, findParameter) {
    children.sort((a, b) => a.point - b.point);
    super(state, parent, name, point, parameters, children, syncAnimations, createTree, findParameter);
  }
  calculateWeights() {
    if (this.updateParameterValues()) return;
    let weightedDurationSum = 0.0;
    this._children[0].weight = 0.0;
    for (let i = 0; i < this._children.length; i++) {
      const c1 = this._children[i];
      if (i !== this._children.length - 1) {
        const c2 = this._children[i + 1];
        if (c1.point === c2.point) {
          c1.weight = 0.5;
          c2.weight = 0.5;
        } else if (math.between(this._parameterValues[0], c1.point, c2.point, true)) {
          const child2Distance = Math.abs(c1.point - c2.point);
          const parameterDistance = Math.abs(c1.point - this._parameterValues[0]);
          const weight = (child2Distance - parameterDistance) / child2Distance;
          c1.weight = weight;
          c2.weight = 1.0 - weight;
        } else {
          c2.weight = 0.0;
        }
      }
      if (this._syncAnimations) {
        weightedDurationSum += c1.animTrack.duration / c1.absoluteSpeed * c1.weight;
      }
    }
    if (this._syncAnimations) {
      for (let i = 0; i < this._children.length; i++) {
        const child = this._children[i];
        child.weightedSpeed = child.animTrack.duration / child.absoluteSpeed / weightedDurationSum;
      }
    }
  }
}

export { AnimBlendTree1D };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5pbS1ibGVuZC10cmVlLTFkLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvZnJhbWV3b3JrL2FuaW0vY29udHJvbGxlci9hbmltLWJsZW5kLXRyZWUtMWQuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgbWF0aCB9IGZyb20gJy4uLy4uLy4uL2NvcmUvbWF0aC9tYXRoLmpzJztcblxuaW1wb3J0IHsgQW5pbUJsZW5kVHJlZSB9IGZyb20gJy4vYW5pbS1ibGVuZC10cmVlLmpzJztcblxuLyoqXG4gKiBBbiBBbmltQmxlbmRUcmVlIHRoYXQgY2FsY3VsYXRlcyBpdHMgd2VpZ2h0cyB1c2luZyBhIDFEIGFsZ29yaXRobSBiYXNlZCBvbiB0aGUgdGhlc2lzXG4gKiBodHRwOi8vcnVuZXZpc2lvbi5jb20vdGhlc2lzL3J1bmVfc2tvdmJvX2pvaGFuc2VuX3RoZXNpcy5wZGYgQ2hhcHRlciA2LlxuICpcbiAqIEBpZ25vcmVcbiAqL1xuY2xhc3MgQW5pbUJsZW5kVHJlZTFEIGV4dGVuZHMgQW5pbUJsZW5kVHJlZSB7XG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgbmV3IEJsZW5kVHJlZTFEIGluc3RhbmNlLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtBbmltU3RhdGV9IHN0YXRlIC0gVGhlIEFuaW1TdGF0ZSB0aGF0IHRoaXMgQW5pbUJsZW5kVHJlZSBiZWxvbmdzIHRvLlxuICAgICAqIEBwYXJhbSB7QW5pbUJsZW5kVHJlZXxudWxsfSBwYXJlbnQgLSBUaGUgcGFyZW50IG9mIHRoZSBBbmltQmxlbmRUcmVlLiBJZiBub3QgbnVsbCwgdGhlXG4gICAgICogQW5pbU5vZGUgaXMgc3RvcmVkIGFzIHBhcnQgb2YgYSB7QGxpbmsgQW5pbUJsZW5kVHJlZX0gaGllcmFyY2h5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIEJsZW5kVHJlZS4gVXNlZCB3aGVuIGFzc2lnbmluZyBhIHtAbGluayBBbmltVHJhY2t9IHRvXG4gICAgICogaXRzIGNoaWxkcmVuLlxuICAgICAqIEBwYXJhbSB7bnVtYmVyfFZlYzJ9IHBvaW50IC0gVGhlIGNvb3JkaW5hdGUvdmVjdG9yIHRoYXRzIHVzZWQgdG8gZGV0ZXJtaW5lIHRoZSB3ZWlnaHQgb2YgdGhpc1xuICAgICAqIG5vZGUgd2hlbiBpdCdzIHBhcnQgb2YgYSB7QGxpbmsgQW5pbUJsZW5kVHJlZX0uXG4gICAgICogQHBhcmFtIHtzdHJpbmdbXX0gcGFyYW1ldGVycyAtIFRoZSBhbmltIGNvbXBvbmVudCBwYXJhbWV0ZXJzIHdoaWNoIGFyZSB1c2VkIHRvIGNhbGN1bGF0ZSB0aGVcbiAgICAgKiBjdXJyZW50IHdlaWdodHMgb2YgdGhlIGJsZW5kIHRyZWVzIGNoaWxkcmVuLlxuICAgICAqIEBwYXJhbSB7b2JqZWN0W119IGNoaWxkcmVuIC0gVGhlIGNoaWxkIG5vZGVzIHRoYXQgdGhpcyBibGVuZCB0cmVlIHNob3VsZCBjcmVhdGUuIENhbiBlaXRoZXJcbiAgICAgKiBiZSBvZiB0eXBlIHtAbGluayBBbmltTm9kZX0gb3Ige0BsaW5rIEJsZW5kVHJlZX0uXG4gICAgICogQHBhcmFtIHtib29sZWFufSBzeW5jQW5pbWF0aW9ucyAtIElmIHRydWUsIHRoZSBzcGVlZCBvZiBlYWNoIGJsZW5kZWQgYW5pbWF0aW9uIHdpbGwgYmVcbiAgICAgKiBzeW5jaHJvbml6ZWQuXG4gICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY3JlYXRlVHJlZSAtIFVzZWQgdG8gY3JlYXRlIGNoaWxkIGJsZW5kIHRyZWVzIG9mIHZhcnlpbmcgdHlwZXMuXG4gICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZmluZFBhcmFtZXRlciAtIFVzZWQgYXQgcnVudGltZSB0byBnZXQgdGhlIGN1cnJlbnQgcGFyYW1ldGVyIHZhbHVlcy5cbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihzdGF0ZSwgcGFyZW50LCBuYW1lLCBwb2ludCwgcGFyYW1ldGVycywgY2hpbGRyZW4sIHN5bmNBbmltYXRpb25zLCBjcmVhdGVUcmVlLCBmaW5kUGFyYW1ldGVyKSB7XG4gICAgICAgIGNoaWxkcmVuLnNvcnQoKGEsIGIpID0+IGEucG9pbnQgLSBiLnBvaW50KTtcbiAgICAgICAgc3VwZXIoc3RhdGUsIHBhcmVudCwgbmFtZSwgcG9pbnQsIHBhcmFtZXRlcnMsIGNoaWxkcmVuLCBzeW5jQW5pbWF0aW9ucywgY3JlYXRlVHJlZSwgZmluZFBhcmFtZXRlcik7XG4gICAgfVxuXG4gICAgY2FsY3VsYXRlV2VpZ2h0cygpIHtcbiAgICAgICAgaWYgKHRoaXMudXBkYXRlUGFyYW1ldGVyVmFsdWVzKCkpIHJldHVybjtcbiAgICAgICAgbGV0IHdlaWdodGVkRHVyYXRpb25TdW0gPSAwLjA7XG4gICAgICAgIHRoaXMuX2NoaWxkcmVuWzBdLndlaWdodCA9IDAuMDtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLl9jaGlsZHJlbi5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgY29uc3QgYzEgPSB0aGlzLl9jaGlsZHJlbltpXTtcbiAgICAgICAgICAgIGlmIChpICE9PSB0aGlzLl9jaGlsZHJlbi5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgYzIgPSB0aGlzLl9jaGlsZHJlbltpICsgMV07XG4gICAgICAgICAgICAgICAgaWYgKGMxLnBvaW50ID09PSBjMi5wb2ludCkge1xuICAgICAgICAgICAgICAgICAgICBjMS53ZWlnaHQgPSAwLjU7XG4gICAgICAgICAgICAgICAgICAgIGMyLndlaWdodCA9IDAuNTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG1hdGguYmV0d2Vlbih0aGlzLl9wYXJhbWV0ZXJWYWx1ZXNbMF0sIGMxLnBvaW50LCBjMi5wb2ludCwgdHJ1ZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hpbGQyRGlzdGFuY2UgPSBNYXRoLmFicyhjMS5wb2ludCAtIGMyLnBvaW50KTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFyYW1ldGVyRGlzdGFuY2UgPSBNYXRoLmFicyhjMS5wb2ludCAtIHRoaXMuX3BhcmFtZXRlclZhbHVlc1swXSk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHdlaWdodCA9IChjaGlsZDJEaXN0YW5jZSAtIHBhcmFtZXRlckRpc3RhbmNlKSAvIGNoaWxkMkRpc3RhbmNlO1xuICAgICAgICAgICAgICAgICAgICBjMS53ZWlnaHQgPSB3ZWlnaHQ7XG4gICAgICAgICAgICAgICAgICAgIGMyLndlaWdodCA9ICgxLjAgLSB3ZWlnaHQpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGMyLndlaWdodCA9IDAuMDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodGhpcy5fc3luY0FuaW1hdGlvbnMpIHtcbiAgICAgICAgICAgICAgICB3ZWlnaHRlZER1cmF0aW9uU3VtICs9IGMxLmFuaW1UcmFjay5kdXJhdGlvbiAvIGMxLmFic29sdXRlU3BlZWQgKiBjMS53ZWlnaHQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuX3N5bmNBbmltYXRpb25zKSB7XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX2NoaWxkcmVuLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY2hpbGQgPSB0aGlzLl9jaGlsZHJlbltpXTtcbiAgICAgICAgICAgICAgICBjaGlsZC53ZWlnaHRlZFNwZWVkID0gY2hpbGQuYW5pbVRyYWNrLmR1cmF0aW9uIC8gY2hpbGQuYWJzb2x1dGVTcGVlZCAvIHdlaWdodGVkRHVyYXRpb25TdW07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59XG5leHBvcnQgeyBBbmltQmxlbmRUcmVlMUQgfTtcbiJdLCJuYW1lcyI6WyJBbmltQmxlbmRUcmVlMUQiLCJBbmltQmxlbmRUcmVlIiwiY29uc3RydWN0b3IiLCJzdGF0ZSIsInBhcmVudCIsIm5hbWUiLCJwb2ludCIsInBhcmFtZXRlcnMiLCJjaGlsZHJlbiIsInN5bmNBbmltYXRpb25zIiwiY3JlYXRlVHJlZSIsImZpbmRQYXJhbWV0ZXIiLCJzb3J0IiwiYSIsImIiLCJjYWxjdWxhdGVXZWlnaHRzIiwidXBkYXRlUGFyYW1ldGVyVmFsdWVzIiwid2VpZ2h0ZWREdXJhdGlvblN1bSIsIl9jaGlsZHJlbiIsIndlaWdodCIsImkiLCJsZW5ndGgiLCJjMSIsImMyIiwibWF0aCIsImJldHdlZW4iLCJfcGFyYW1ldGVyVmFsdWVzIiwiY2hpbGQyRGlzdGFuY2UiLCJNYXRoIiwiYWJzIiwicGFyYW1ldGVyRGlzdGFuY2UiLCJfc3luY0FuaW1hdGlvbnMiLCJhbmltVHJhY2siLCJkdXJhdGlvbiIsImFic29sdXRlU3BlZWQiLCJjaGlsZCIsIndlaWdodGVkU3BlZWQiXSwibWFwcGluZ3MiOiI7OztBQUlBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1BQU1BLGVBQWUsU0FBU0MsYUFBYSxDQUFDO0FBQ3hDO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLFdBQVdBLENBQUNDLEtBQUssRUFBRUMsTUFBTSxFQUFFQyxJQUFJLEVBQUVDLEtBQUssRUFBRUMsVUFBVSxFQUFFQyxRQUFRLEVBQUVDLGNBQWMsRUFBRUMsVUFBVSxFQUFFQyxhQUFhLEVBQUU7QUFDckdILElBQUFBLFFBQVEsQ0FBQ0ksSUFBSSxDQUFDLENBQUNDLENBQUMsRUFBRUMsQ0FBQyxLQUFLRCxDQUFDLENBQUNQLEtBQUssR0FBR1EsQ0FBQyxDQUFDUixLQUFLLENBQUMsQ0FBQTtBQUMxQyxJQUFBLEtBQUssQ0FBQ0gsS0FBSyxFQUFFQyxNQUFNLEVBQUVDLElBQUksRUFBRUMsS0FBSyxFQUFFQyxVQUFVLEVBQUVDLFFBQVEsRUFBRUMsY0FBYyxFQUFFQyxVQUFVLEVBQUVDLGFBQWEsQ0FBQyxDQUFBO0FBQ3RHLEdB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
