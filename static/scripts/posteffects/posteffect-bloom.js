var SAMPLE_COUNT=15;function computeGaussian(e,t){return 1/Math.sqrt(2*Math.PI*t)*Math.exp(-e*e/(2*t*t))}function calculateBlurValues(e,t,o,s,r){e[0]=computeGaussian(0,r),t[0]=0,t[1]=0;var i,l,a=e[0];for(i=0,l=Math.floor(SAMPLE_COUNT/2);i<l;i++){var u=computeGaussian(i+1,r);e[2*i]=u,e[2*i+1]=u,a+=2*u;var f=2*i+1.5;t[4*i]=o*f,t[4*i+1]=s*f,t[4*i+2]=-o*f,t[4*i+3]=-s*f}for(i=0,l=e.length;i<l;i++)e[i]/=a}function BloomEffect(e){pc.PostEffect.call(this,e);var t={aPosition:pc.SEMANTIC_POSITION},o=["attribute vec2 aPosition;","","varying vec2 vUv0;","","void main(void)","{","    gl_Position = vec4(aPosition, 0.0, 1.0);","    vUv0 = (aPosition + 1.0) * 0.5;","}"].join("\n"),s=["precision "+e.precision+" float;","","varying vec2 vUv0;","","uniform sampler2D uBaseTexture;","uniform float uBloomThreshold;","","void main(void)","{","    vec4 color = texture2D(uBaseTexture, vUv0);","","    gl_FragColor = clamp((color - uBloomThreshold) / (1.0 - uBloomThreshold), 0.0, 1.0);","}"].join("\n"),r=["precision "+e.precision+" float;","","#define SAMPLE_COUNT "+SAMPLE_COUNT,"","varying vec2 vUv0;","","uniform sampler2D uBloomTexture;","uniform vec2 uBlurOffsets[SAMPLE_COUNT];","uniform float uBlurWeights[SAMPLE_COUNT];","","void main(void)","{","    vec4 color = vec4(0.0);","    for (int i = 0; i < SAMPLE_COUNT; i++)","    {","        color += texture2D(uBloomTexture, vUv0 + uBlurOffsets[i]) * uBlurWeights[i];","    }","","    gl_FragColor = color;","}"].join("\n"),i=["precision "+e.precision+" float;","","varying vec2 vUv0;","","uniform float uBloomEffectIntensity;","uniform sampler2D uBaseTexture;","uniform sampler2D uBloomTexture;","","void main(void)","{","    vec4 bloom = texture2D(uBloomTexture, vUv0) * uBloomEffectIntensity;","    vec4 base = texture2D(uBaseTexture, vUv0);","","    base *= (1.0 - clamp(bloom, 0.0, 1.0));","","    gl_FragColor = base + bloom;","}"].join("\n");this.extractShader=new pc.Shader(e,{attributes:t,vshader:o,fshader:s}),this.blurShader=new pc.Shader(e,{attributes:t,vshader:o,fshader:r}),this.combineShader=new pc.Shader(e,{attributes:t,vshader:o,fshader:i});var l=e.width,a=e.height;this.targets=[];for(var u=0;u<2;u++){var f=new pc.Texture(e,{format:pc.PIXELFORMAT_R8_G8_B8_A8,width:l>>1,height:a>>1,mipmaps:!1});f.minFilter=pc.FILTER_LINEAR,f.magFilter=pc.FILTER_LINEAR,f.addressU=pc.ADDRESS_CLAMP_TO_EDGE,f.addressV=pc.ADDRESS_CLAMP_TO_EDGE,f.name="pe-bloom";var h=new pc.RenderTarget({colorBuffer:f,depth:!1});this.targets.push(h)}this.bloomThreshold=.25,this.blurAmount=4,this.bloomIntensity=1.25,this.sampleWeights=new Float32Array(SAMPLE_COUNT),this.sampleOffsets=new Float32Array(2*SAMPLE_COUNT)}BloomEffect.prototype=Object.create(pc.PostEffect.prototype),BloomEffect.prototype.constructor=BloomEffect,Object.assign(BloomEffect.prototype,{render:function(e,t,o){var s=this.device,r=s.scope;r.resolve("uBloomThreshold").setValue(this.bloomThreshold),r.resolve("uBaseTexture").setValue(e.colorBuffer),pc.drawFullscreenQuad(s,this.targets[0],this.vertexBuffer,this.extractShader),calculateBlurValues(this.sampleWeights,this.sampleOffsets,1/this.targets[1].width,0,this.blurAmount),r.resolve("uBlurWeights[0]").setValue(this.sampleWeights),r.resolve("uBlurOffsets[0]").setValue(this.sampleOffsets),r.resolve("uBloomTexture").setValue(this.targets[0].colorBuffer),pc.drawFullscreenQuad(s,this.targets[1],this.vertexBuffer,this.blurShader),calculateBlurValues(this.sampleWeights,this.sampleOffsets,0,1/this.targets[0].height,this.blurAmount),r.resolve("uBlurWeights[0]").setValue(this.sampleWeights),r.resolve("uBlurOffsets[0]").setValue(this.sampleOffsets),r.resolve("uBloomTexture").setValue(this.targets[1].colorBuffer),pc.drawFullscreenQuad(s,this.targets[0],this.vertexBuffer,this.blurShader),r.resolve("uBloomEffectIntensity").setValue(this.bloomIntensity),r.resolve("uBloomTexture").setValue(this.targets[0].colorBuffer),r.resolve("uBaseTexture").setValue(e.colorBuffer),pc.drawFullscreenQuad(s,t,this.vertexBuffer,this.combineShader,o)}});var Bloom=pc.createScript("bloom");Bloom.attributes.add("bloomIntensity",{type:"number",default:1,min:0,title:"Intensity"}),Bloom.attributes.add("bloomThreshold",{type:"number",default:.25,min:0,max:1,title:"Threshold"}),Bloom.attributes.add("blurAmount",{type:"number",default:4,min:1,title:"Blur amount"}),Bloom.prototype.initialize=function(){this.effect=new BloomEffect(this.app.graphicsDevice),this.effect.bloomThreshold=this.bloomThreshold,this.effect.blurAmount=this.blurAmount,this.effect.bloomIntensity=this.bloomIntensity;var e=this.entity.camera.postEffects;e.addEffect(this.effect),this.on("attr",(function(e,t){this.effect[e]=t}),this),this.on("state",(function(t){t?e.addEffect(this.effect):e.removeEffect(this.effect)})),this.on("destroy",(function(){e.removeEffect(this.effect)}))};