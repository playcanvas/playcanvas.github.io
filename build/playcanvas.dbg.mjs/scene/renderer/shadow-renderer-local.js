/**
 * @license
 * PlayCanvas Engine v1.62.0 revision 818511d2b (DEBUG PROFILER)
 * Copyright 2011-2023 PlayCanvas Ltd. All rights reserved.
 */
import { DebugHelper } from '../../core/debug.js';
import { math } from '../../core/math/math.js';
import { ShadowMap } from './shadow-map.js';
import { LIGHTTYPE_SPOT, LIGHTTYPE_OMNI } from '../constants.js';
import { RenderPass } from '../../platform/graphics/render-pass.js';

/**
 * @ignore
 */
class ShadowRendererLocal {
  // temporary list to collect lights to render shadows for

  /** @type {import('./renderer.js').Renderer} */

  /** @type {import('./shadow-renderer.js').ShadowRenderer} */

  /** @type {import('../../platform/graphics/graphics-device.js').GraphicsDevice} */

  constructor(renderer, shadowRenderer) {
    this.shadowLights = [];
    this.renderer = void 0;
    this.shadowRenderer = void 0;
    this.device = void 0;
    this.renderer = renderer;
    this.shadowRenderer = shadowRenderer;
    this.device = renderer.device;
  }

  // cull local shadow map
  cull(light, drawCalls) {
    const isClustered = this.renderer.scene.clusteredLightingEnabled;

    // force light visibility if function was manually called
    light.visibleThisFrame = true;

    // allocate shadow map unless in clustered lighting mode
    if (!isClustered) {
      if (!light._shadowMap) {
        light._shadowMap = ShadowMap.create(this.device, light);
      }
    }
    const type = light._type;
    const faceCount = type === LIGHTTYPE_SPOT ? 1 : 6;
    for (let face = 0; face < faceCount; face++) {
      // render data are shared between cameras for local lights, so pass null for camera
      const lightRenderData = light.getRenderData(null, face);
      const shadowCam = lightRenderData.shadowCamera;
      shadowCam.nearClip = light.attenuationEnd / 1000;
      shadowCam.farClip = light.attenuationEnd;
      const shadowCamNode = shadowCam._node;
      const lightNode = light._node;
      shadowCamNode.setPosition(lightNode.getPosition());
      if (type === LIGHTTYPE_SPOT) {
        shadowCam.fov = light._outerConeAngle * 2;

        // Camera looks down the negative Z, and spot light points down the negative Y
        shadowCamNode.setRotation(lightNode.getRotation());
        shadowCamNode.rotateLocal(-90, 0, 0);
      } else if (type === LIGHTTYPE_OMNI) {
        // when rendering omni shadows to an atlas, use larger fov by few pixels to allow shadow filtering to stay on a single face
        if (isClustered) {
          const tileSize = this.shadowRenderer.lightTextureAtlas.shadowAtlasResolution * light.atlasViewport.z / 3; // using 3x3 for cubemap
          const texelSize = 2 / tileSize;
          const filterSize = texelSize * this.shadowRenderer.lightTextureAtlas.shadowEdgePixels;
          shadowCam.fov = Math.atan(1 + filterSize) * math.RAD_TO_DEG * 2;
        } else {
          shadowCam.fov = 90;
        }
      }

      // cull shadow casters
      this.renderer.updateCameraFrustum(shadowCam);
      this.shadowRenderer.cullShadowCasters(drawCalls, lightRenderData.visibleCasters, shadowCam);
    }
  }
  prepareLights(shadowLights, lights) {
    let shadowCamera;
    for (let i = 0; i < lights.length; i++) {
      const light = lights[i];
      if (this.shadowRenderer.needsShadowRendering(light) && light.atlasViewportAllocated) {
        shadowLights.push(light);
        for (let face = 0; face < light.numShadowFaces; face++) {
          shadowCamera = this.shadowRenderer.prepareFace(light, null, face);
        }
      }
    }
    return shadowCamera;
  }

  /**
   * Prepare render pass for rendering of shadows for local clustered lights. This is done inside
   * a single render pass, as all shadows are part of a single render target atlas.
   */
  prepareClusteredRenderPass(renderPass, lightsSpot, lightsOmni) {
    // prepare render targets / shadow cameras for rendering
    const shadowLights = this.shadowLights;
    const shadowCamSpot = this.prepareLights(shadowLights, lightsSpot);
    const shadowCamOmni = this.prepareLights(shadowLights, lightsOmni);
    const shadowCamera = shadowCamSpot != null ? shadowCamSpot : shadowCamOmni;

    // if any shadows need to be rendered
    const count = shadowLights.length;
    if (count) {
      // setup render pass using any of the cameras, they all have the same pass related properties
      // Note that the render pass is set up to not clear the render target, as individual shadow maps clear it
      this.shadowRenderer.setupRenderPass(renderPass, shadowCamera, false);

      // render shadows inside the pass
      renderPass.execute = () => {
        for (let i = 0; i < count; i++) {
          const light = shadowLights[i];
          for (let face = 0; face < light.numShadowFaces; face++) {
            this.shadowRenderer.renderFace(light, null, face, true);
          }
        }
        shadowLights.length = 0;
      };
    }
  }
  setupNonClusteredFaceRenderPass(frameGraph, light, face) {
    const shadowCamera = this.shadowRenderer.prepareFace(light, null, face);
    const renderPass = new RenderPass(this.device, () => {
      this.shadowRenderer.renderFace(light, null, face, false);
    });

    // clear the render target as well, as it contains a single shadow map
    this.shadowRenderer.setupRenderPass(renderPass, shadowCamera, true);
    DebugHelper.setName(renderPass, `SpotShadow-${light._node.name}`);
    frameGraph.addRenderPass(renderPass);
  }

  /**
   * Prepare render passes for rendering of shadows for local non-clustered lights. Each shadow face
   * is a separate render pass as it renders to a separate render target.
   */
  buildNonClusteredRenderPasses(frameGraph, lightsSpot, lightsOmni) {
    // spot lights
    for (let i = 0; i < lightsSpot.length; i++) {
      const light = lightsSpot[i];
      if (this.shadowRenderer.needsShadowRendering(light)) {
        this.setupNonClusteredFaceRenderPass(frameGraph, light, 0);
      }
    }

    // omni lights
    for (let i = 0; i < lightsOmni.length; i++) {
      const light = lightsOmni[i];
      if (this.shadowRenderer.needsShadowRendering(light)) {
        // create render pass per face
        const faceCount = light.numShadowFaces;
        for (let face = 0; face < faceCount; face++) {
          this.setupNonClusteredFaceRenderPass(frameGraph, light, face);
        }
      }
    }
  }
}

export { ShadowRendererLocal };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hhZG93LXJlbmRlcmVyLWxvY2FsLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvc2NlbmUvcmVuZGVyZXIvc2hhZG93LXJlbmRlcmVyLWxvY2FsLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERlYnVnSGVscGVyIH0gZnJvbSAnLi4vLi4vY29yZS9kZWJ1Zy5qcyc7XG5pbXBvcnQgeyBtYXRoIH0gZnJvbSAnLi4vLi4vY29yZS9tYXRoL21hdGguanMnO1xuXG5pbXBvcnQgeyBTaGFkb3dNYXAgfSBmcm9tICcuL3NoYWRvdy1tYXAuanMnO1xuaW1wb3J0IHtcbiAgICBMSUdIVFRZUEVfT01OSSwgTElHSFRUWVBFX1NQT1Rcbn0gZnJvbSAnLi4vY29uc3RhbnRzLmpzJztcblxuaW1wb3J0IHsgUmVuZGVyUGFzcyB9IGZyb20gJy4uLy4uL3BsYXRmb3JtL2dyYXBoaWNzL3JlbmRlci1wYXNzLmpzJztcblxuLyoqXG4gKiBAaWdub3JlXG4gKi9cbmNsYXNzIFNoYWRvd1JlbmRlcmVyTG9jYWwge1xuICAgIC8vIHRlbXBvcmFyeSBsaXN0IHRvIGNvbGxlY3QgbGlnaHRzIHRvIHJlbmRlciBzaGFkb3dzIGZvclxuICAgIHNoYWRvd0xpZ2h0cyA9IFtdO1xuXG4gICAgLyoqIEB0eXBlIHtpbXBvcnQoJy4vcmVuZGVyZXIuanMnKS5SZW5kZXJlcn0gKi9cbiAgICByZW5kZXJlcjtcblxuICAgIC8qKiBAdHlwZSB7aW1wb3J0KCcuL3NoYWRvdy1yZW5kZXJlci5qcycpLlNoYWRvd1JlbmRlcmVyfSAqL1xuICAgIHNoYWRvd1JlbmRlcmVyO1xuXG4gICAgLyoqIEB0eXBlIHtpbXBvcnQoJy4uLy4uL3BsYXRmb3JtL2dyYXBoaWNzL2dyYXBoaWNzLWRldmljZS5qcycpLkdyYXBoaWNzRGV2aWNlfSAqL1xuICAgIGRldmljZTtcblxuICAgIGNvbnN0cnVjdG9yKHJlbmRlcmVyLCBzaGFkb3dSZW5kZXJlcikge1xuICAgICAgICB0aGlzLnJlbmRlcmVyID0gcmVuZGVyZXI7XG4gICAgICAgIHRoaXMuc2hhZG93UmVuZGVyZXIgPSBzaGFkb3dSZW5kZXJlcjtcbiAgICAgICAgdGhpcy5kZXZpY2UgPSByZW5kZXJlci5kZXZpY2U7XG4gICAgfVxuXG4gICAgLy8gY3VsbCBsb2NhbCBzaGFkb3cgbWFwXG4gICAgY3VsbChsaWdodCwgZHJhd0NhbGxzKSB7XG5cbiAgICAgICAgY29uc3QgaXNDbHVzdGVyZWQgPSB0aGlzLnJlbmRlcmVyLnNjZW5lLmNsdXN0ZXJlZExpZ2h0aW5nRW5hYmxlZDtcblxuICAgICAgICAvLyBmb3JjZSBsaWdodCB2aXNpYmlsaXR5IGlmIGZ1bmN0aW9uIHdhcyBtYW51YWxseSBjYWxsZWRcbiAgICAgICAgbGlnaHQudmlzaWJsZVRoaXNGcmFtZSA9IHRydWU7XG5cbiAgICAgICAgLy8gYWxsb2NhdGUgc2hhZG93IG1hcCB1bmxlc3MgaW4gY2x1c3RlcmVkIGxpZ2h0aW5nIG1vZGVcbiAgICAgICAgaWYgKCFpc0NsdXN0ZXJlZCkge1xuICAgICAgICAgICAgaWYgKCFsaWdodC5fc2hhZG93TWFwKSB7XG4gICAgICAgICAgICAgICAgbGlnaHQuX3NoYWRvd01hcCA9IFNoYWRvd01hcC5jcmVhdGUodGhpcy5kZXZpY2UsIGxpZ2h0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHR5cGUgPSBsaWdodC5fdHlwZTtcbiAgICAgICAgY29uc3QgZmFjZUNvdW50ID0gdHlwZSA9PT0gTElHSFRUWVBFX1NQT1QgPyAxIDogNjtcblxuICAgICAgICBmb3IgKGxldCBmYWNlID0gMDsgZmFjZSA8IGZhY2VDb3VudDsgZmFjZSsrKSB7XG5cbiAgICAgICAgICAgIC8vIHJlbmRlciBkYXRhIGFyZSBzaGFyZWQgYmV0d2VlbiBjYW1lcmFzIGZvciBsb2NhbCBsaWdodHMsIHNvIHBhc3MgbnVsbCBmb3IgY2FtZXJhXG4gICAgICAgICAgICBjb25zdCBsaWdodFJlbmRlckRhdGEgPSBsaWdodC5nZXRSZW5kZXJEYXRhKG51bGwsIGZhY2UpO1xuICAgICAgICAgICAgY29uc3Qgc2hhZG93Q2FtID0gbGlnaHRSZW5kZXJEYXRhLnNoYWRvd0NhbWVyYTtcblxuICAgICAgICAgICAgc2hhZG93Q2FtLm5lYXJDbGlwID0gbGlnaHQuYXR0ZW51YXRpb25FbmQgLyAxMDAwO1xuICAgICAgICAgICAgc2hhZG93Q2FtLmZhckNsaXAgPSBsaWdodC5hdHRlbnVhdGlvbkVuZDtcblxuICAgICAgICAgICAgY29uc3Qgc2hhZG93Q2FtTm9kZSA9IHNoYWRvd0NhbS5fbm9kZTtcbiAgICAgICAgICAgIGNvbnN0IGxpZ2h0Tm9kZSA9IGxpZ2h0Ll9ub2RlO1xuICAgICAgICAgICAgc2hhZG93Q2FtTm9kZS5zZXRQb3NpdGlvbihsaWdodE5vZGUuZ2V0UG9zaXRpb24oKSk7XG5cbiAgICAgICAgICAgIGlmICh0eXBlID09PSBMSUdIVFRZUEVfU1BPVCkge1xuICAgICAgICAgICAgICAgIHNoYWRvd0NhbS5mb3YgPSBsaWdodC5fb3V0ZXJDb25lQW5nbGUgKiAyO1xuXG4gICAgICAgICAgICAgICAgLy8gQ2FtZXJhIGxvb2tzIGRvd24gdGhlIG5lZ2F0aXZlIFosIGFuZCBzcG90IGxpZ2h0IHBvaW50cyBkb3duIHRoZSBuZWdhdGl2ZSBZXG4gICAgICAgICAgICAgICAgc2hhZG93Q2FtTm9kZS5zZXRSb3RhdGlvbihsaWdodE5vZGUuZ2V0Um90YXRpb24oKSk7XG4gICAgICAgICAgICAgICAgc2hhZG93Q2FtTm9kZS5yb3RhdGVMb2NhbCgtOTAsIDAsIDApO1xuXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09IExJR0hUVFlQRV9PTU5JKSB7XG5cbiAgICAgICAgICAgICAgICAvLyB3aGVuIHJlbmRlcmluZyBvbW5pIHNoYWRvd3MgdG8gYW4gYXRsYXMsIHVzZSBsYXJnZXIgZm92IGJ5IGZldyBwaXhlbHMgdG8gYWxsb3cgc2hhZG93IGZpbHRlcmluZyB0byBzdGF5IG9uIGEgc2luZ2xlIGZhY2VcbiAgICAgICAgICAgICAgICBpZiAoaXNDbHVzdGVyZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGlsZVNpemUgPSB0aGlzLnNoYWRvd1JlbmRlcmVyLmxpZ2h0VGV4dHVyZUF0bGFzLnNoYWRvd0F0bGFzUmVzb2x1dGlvbiAqIGxpZ2h0LmF0bGFzVmlld3BvcnQueiAvIDM7ICAgIC8vIHVzaW5nIDN4MyBmb3IgY3ViZW1hcFxuICAgICAgICAgICAgICAgICAgICBjb25zdCB0ZXhlbFNpemUgPSAyIC8gdGlsZVNpemU7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbHRlclNpemUgPSB0ZXhlbFNpemUgKiB0aGlzLnNoYWRvd1JlbmRlcmVyLmxpZ2h0VGV4dHVyZUF0bGFzLnNoYWRvd0VkZ2VQaXhlbHM7XG4gICAgICAgICAgICAgICAgICAgIHNoYWRvd0NhbS5mb3YgPSBNYXRoLmF0YW4oMSArIGZpbHRlclNpemUpICogbWF0aC5SQURfVE9fREVHICogMjtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBzaGFkb3dDYW0uZm92ID0gOTA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBjdWxsIHNoYWRvdyBjYXN0ZXJzXG4gICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnVwZGF0ZUNhbWVyYUZydXN0dW0oc2hhZG93Q2FtKTtcbiAgICAgICAgICAgIHRoaXMuc2hhZG93UmVuZGVyZXIuY3VsbFNoYWRvd0Nhc3RlcnMoZHJhd0NhbGxzLCBsaWdodFJlbmRlckRhdGEudmlzaWJsZUNhc3RlcnMsIHNoYWRvd0NhbSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcmVwYXJlTGlnaHRzKHNoYWRvd0xpZ2h0cywgbGlnaHRzKSB7XG5cbiAgICAgICAgbGV0IHNoYWRvd0NhbWVyYTtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsaWdodHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGNvbnN0IGxpZ2h0ID0gbGlnaHRzW2ldO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5zaGFkb3dSZW5kZXJlci5uZWVkc1NoYWRvd1JlbmRlcmluZyhsaWdodCkgJiYgbGlnaHQuYXRsYXNWaWV3cG9ydEFsbG9jYXRlZCkge1xuXG4gICAgICAgICAgICAgICAgc2hhZG93TGlnaHRzLnB1c2gobGlnaHQpO1xuXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgZmFjZSA9IDA7IGZhY2UgPCBsaWdodC5udW1TaGFkb3dGYWNlczsgZmFjZSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHNoYWRvd0NhbWVyYSA9IHRoaXMuc2hhZG93UmVuZGVyZXIucHJlcGFyZUZhY2UobGlnaHQsIG51bGwsIGZhY2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBzaGFkb3dDYW1lcmE7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUHJlcGFyZSByZW5kZXIgcGFzcyBmb3IgcmVuZGVyaW5nIG9mIHNoYWRvd3MgZm9yIGxvY2FsIGNsdXN0ZXJlZCBsaWdodHMuIFRoaXMgaXMgZG9uZSBpbnNpZGVcbiAgICAgKiBhIHNpbmdsZSByZW5kZXIgcGFzcywgYXMgYWxsIHNoYWRvd3MgYXJlIHBhcnQgb2YgYSBzaW5nbGUgcmVuZGVyIHRhcmdldCBhdGxhcy5cbiAgICAgKi9cbiAgICBwcmVwYXJlQ2x1c3RlcmVkUmVuZGVyUGFzcyhyZW5kZXJQYXNzLCBsaWdodHNTcG90LCBsaWdodHNPbW5pKSB7XG5cbiAgICAgICAgLy8gcHJlcGFyZSByZW5kZXIgdGFyZ2V0cyAvIHNoYWRvdyBjYW1lcmFzIGZvciByZW5kZXJpbmdcbiAgICAgICAgY29uc3Qgc2hhZG93TGlnaHRzID0gdGhpcy5zaGFkb3dMaWdodHM7XG4gICAgICAgIGNvbnN0IHNoYWRvd0NhbVNwb3QgPSB0aGlzLnByZXBhcmVMaWdodHMoc2hhZG93TGlnaHRzLCBsaWdodHNTcG90KTtcbiAgICAgICAgY29uc3Qgc2hhZG93Q2FtT21uaSA9IHRoaXMucHJlcGFyZUxpZ2h0cyhzaGFkb3dMaWdodHMsIGxpZ2h0c09tbmkpO1xuICAgICAgICBjb25zdCBzaGFkb3dDYW1lcmEgPSBzaGFkb3dDYW1TcG90ID8/IHNoYWRvd0NhbU9tbmk7XG5cbiAgICAgICAgLy8gaWYgYW55IHNoYWRvd3MgbmVlZCB0byBiZSByZW5kZXJlZFxuICAgICAgICBjb25zdCBjb3VudCA9IHNoYWRvd0xpZ2h0cy5sZW5ndGg7XG4gICAgICAgIGlmIChjb3VudCkge1xuXG4gICAgICAgICAgICAvLyBzZXR1cCByZW5kZXIgcGFzcyB1c2luZyBhbnkgb2YgdGhlIGNhbWVyYXMsIHRoZXkgYWxsIGhhdmUgdGhlIHNhbWUgcGFzcyByZWxhdGVkIHByb3BlcnRpZXNcbiAgICAgICAgICAgIC8vIE5vdGUgdGhhdCB0aGUgcmVuZGVyIHBhc3MgaXMgc2V0IHVwIHRvIG5vdCBjbGVhciB0aGUgcmVuZGVyIHRhcmdldCwgYXMgaW5kaXZpZHVhbCBzaGFkb3cgbWFwcyBjbGVhciBpdFxuICAgICAgICAgICAgdGhpcy5zaGFkb3dSZW5kZXJlci5zZXR1cFJlbmRlclBhc3MocmVuZGVyUGFzcywgc2hhZG93Q2FtZXJhLCBmYWxzZSk7XG5cbiAgICAgICAgICAgIC8vIHJlbmRlciBzaGFkb3dzIGluc2lkZSB0aGUgcGFzc1xuICAgICAgICAgICAgcmVuZGVyUGFzcy5leGVjdXRlID0gKCkgPT4ge1xuXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGxpZ2h0ID0gc2hhZG93TGlnaHRzW2ldO1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBmYWNlID0gMDsgZmFjZSA8IGxpZ2h0Lm51bVNoYWRvd0ZhY2VzOyBmYWNlKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hhZG93UmVuZGVyZXIucmVuZGVyRmFjZShsaWdodCwgbnVsbCwgZmFjZSwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBzaGFkb3dMaWdodHMubGVuZ3RoID0gMDtcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzZXR1cE5vbkNsdXN0ZXJlZEZhY2VSZW5kZXJQYXNzKGZyYW1lR3JhcGgsIGxpZ2h0LCBmYWNlKSB7XG5cbiAgICAgICAgY29uc3Qgc2hhZG93Q2FtZXJhID0gdGhpcy5zaGFkb3dSZW5kZXJlci5wcmVwYXJlRmFjZShsaWdodCwgbnVsbCwgZmFjZSk7XG4gICAgICAgIGNvbnN0IHJlbmRlclBhc3MgPSBuZXcgUmVuZGVyUGFzcyh0aGlzLmRldmljZSwgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5zaGFkb3dSZW5kZXJlci5yZW5kZXJGYWNlKGxpZ2h0LCBudWxsLCBmYWNlLCBmYWxzZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIGNsZWFyIHRoZSByZW5kZXIgdGFyZ2V0IGFzIHdlbGwsIGFzIGl0IGNvbnRhaW5zIGEgc2luZ2xlIHNoYWRvdyBtYXBcbiAgICAgICAgdGhpcy5zaGFkb3dSZW5kZXJlci5zZXR1cFJlbmRlclBhc3MocmVuZGVyUGFzcywgc2hhZG93Q2FtZXJhLCB0cnVlKTtcbiAgICAgICAgRGVidWdIZWxwZXIuc2V0TmFtZShyZW5kZXJQYXNzLCBgU3BvdFNoYWRvdy0ke2xpZ2h0Ll9ub2RlLm5hbWV9YCk7XG5cbiAgICAgICAgZnJhbWVHcmFwaC5hZGRSZW5kZXJQYXNzKHJlbmRlclBhc3MpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFByZXBhcmUgcmVuZGVyIHBhc3NlcyBmb3IgcmVuZGVyaW5nIG9mIHNoYWRvd3MgZm9yIGxvY2FsIG5vbi1jbHVzdGVyZWQgbGlnaHRzLiBFYWNoIHNoYWRvdyBmYWNlXG4gICAgICogaXMgYSBzZXBhcmF0ZSByZW5kZXIgcGFzcyBhcyBpdCByZW5kZXJzIHRvIGEgc2VwYXJhdGUgcmVuZGVyIHRhcmdldC5cbiAgICAgKi9cbiAgICBidWlsZE5vbkNsdXN0ZXJlZFJlbmRlclBhc3NlcyhmcmFtZUdyYXBoLCBsaWdodHNTcG90LCBsaWdodHNPbW5pKSB7XG5cbiAgICAgICAgLy8gc3BvdCBsaWdodHNcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsaWdodHNTcG90Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBjb25zdCBsaWdodCA9IGxpZ2h0c1Nwb3RbaV07XG5cbiAgICAgICAgICAgIGlmICh0aGlzLnNoYWRvd1JlbmRlcmVyLm5lZWRzU2hhZG93UmVuZGVyaW5nKGxpZ2h0KSkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0dXBOb25DbHVzdGVyZWRGYWNlUmVuZGVyUGFzcyhmcmFtZUdyYXBoLCBsaWdodCwgMCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBvbW5pIGxpZ2h0c1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxpZ2h0c09tbmkubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGNvbnN0IGxpZ2h0ID0gbGlnaHRzT21uaVtpXTtcblxuICAgICAgICAgICAgaWYgKHRoaXMuc2hhZG93UmVuZGVyZXIubmVlZHNTaGFkb3dSZW5kZXJpbmcobGlnaHQpKSB7XG5cbiAgICAgICAgICAgICAgICAvLyBjcmVhdGUgcmVuZGVyIHBhc3MgcGVyIGZhY2VcbiAgICAgICAgICAgICAgICBjb25zdCBmYWNlQ291bnQgPSBsaWdodC5udW1TaGFkb3dGYWNlcztcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBmYWNlID0gMDsgZmFjZSA8IGZhY2VDb3VudDsgZmFjZSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0dXBOb25DbHVzdGVyZWRGYWNlUmVuZGVyUGFzcyhmcmFtZUdyYXBoLCBsaWdodCwgZmFjZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuXG5leHBvcnQgeyBTaGFkb3dSZW5kZXJlckxvY2FsIH07XG4iXSwibmFtZXMiOlsiU2hhZG93UmVuZGVyZXJMb2NhbCIsImNvbnN0cnVjdG9yIiwicmVuZGVyZXIiLCJzaGFkb3dSZW5kZXJlciIsInNoYWRvd0xpZ2h0cyIsImRldmljZSIsImN1bGwiLCJsaWdodCIsImRyYXdDYWxscyIsImlzQ2x1c3RlcmVkIiwic2NlbmUiLCJjbHVzdGVyZWRMaWdodGluZ0VuYWJsZWQiLCJ2aXNpYmxlVGhpc0ZyYW1lIiwiX3NoYWRvd01hcCIsIlNoYWRvd01hcCIsImNyZWF0ZSIsInR5cGUiLCJfdHlwZSIsImZhY2VDb3VudCIsIkxJR0hUVFlQRV9TUE9UIiwiZmFjZSIsImxpZ2h0UmVuZGVyRGF0YSIsImdldFJlbmRlckRhdGEiLCJzaGFkb3dDYW0iLCJzaGFkb3dDYW1lcmEiLCJuZWFyQ2xpcCIsImF0dGVudWF0aW9uRW5kIiwiZmFyQ2xpcCIsInNoYWRvd0NhbU5vZGUiLCJfbm9kZSIsImxpZ2h0Tm9kZSIsInNldFBvc2l0aW9uIiwiZ2V0UG9zaXRpb24iLCJmb3YiLCJfb3V0ZXJDb25lQW5nbGUiLCJzZXRSb3RhdGlvbiIsImdldFJvdGF0aW9uIiwicm90YXRlTG9jYWwiLCJMSUdIVFRZUEVfT01OSSIsInRpbGVTaXplIiwibGlnaHRUZXh0dXJlQXRsYXMiLCJzaGFkb3dBdGxhc1Jlc29sdXRpb24iLCJhdGxhc1ZpZXdwb3J0IiwieiIsInRleGVsU2l6ZSIsImZpbHRlclNpemUiLCJzaGFkb3dFZGdlUGl4ZWxzIiwiTWF0aCIsImF0YW4iLCJtYXRoIiwiUkFEX1RPX0RFRyIsInVwZGF0ZUNhbWVyYUZydXN0dW0iLCJjdWxsU2hhZG93Q2FzdGVycyIsInZpc2libGVDYXN0ZXJzIiwicHJlcGFyZUxpZ2h0cyIsImxpZ2h0cyIsImkiLCJsZW5ndGgiLCJuZWVkc1NoYWRvd1JlbmRlcmluZyIsImF0bGFzVmlld3BvcnRBbGxvY2F0ZWQiLCJwdXNoIiwibnVtU2hhZG93RmFjZXMiLCJwcmVwYXJlRmFjZSIsInByZXBhcmVDbHVzdGVyZWRSZW5kZXJQYXNzIiwicmVuZGVyUGFzcyIsImxpZ2h0c1Nwb3QiLCJsaWdodHNPbW5pIiwic2hhZG93Q2FtU3BvdCIsInNoYWRvd0NhbU9tbmkiLCJjb3VudCIsInNldHVwUmVuZGVyUGFzcyIsImV4ZWN1dGUiLCJyZW5kZXJGYWNlIiwic2V0dXBOb25DbHVzdGVyZWRGYWNlUmVuZGVyUGFzcyIsImZyYW1lR3JhcGgiLCJSZW5kZXJQYXNzIiwiRGVidWdIZWxwZXIiLCJzZXROYW1lIiwibmFtZSIsImFkZFJlbmRlclBhc3MiLCJidWlsZE5vbkNsdXN0ZXJlZFJlbmRlclBhc3NlcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFVQTtBQUNBO0FBQ0E7QUFDQSxNQUFNQSxtQkFBbUIsQ0FBQztBQUN0Qjs7QUFHQTs7QUFHQTs7QUFHQTs7QUFHQUMsRUFBQUEsV0FBVyxDQUFDQyxRQUFRLEVBQUVDLGNBQWMsRUFBRTtJQUFBLElBWHRDQyxDQUFBQSxZQUFZLEdBQUcsRUFBRSxDQUFBO0FBQUEsSUFBQSxJQUFBLENBR2pCRixRQUFRLEdBQUEsS0FBQSxDQUFBLENBQUE7QUFBQSxJQUFBLElBQUEsQ0FHUkMsY0FBYyxHQUFBLEtBQUEsQ0FBQSxDQUFBO0FBQUEsSUFBQSxJQUFBLENBR2RFLE1BQU0sR0FBQSxLQUFBLENBQUEsQ0FBQTtJQUdGLElBQUksQ0FBQ0gsUUFBUSxHQUFHQSxRQUFRLENBQUE7SUFDeEIsSUFBSSxDQUFDQyxjQUFjLEdBQUdBLGNBQWMsQ0FBQTtBQUNwQyxJQUFBLElBQUksQ0FBQ0UsTUFBTSxHQUFHSCxRQUFRLENBQUNHLE1BQU0sQ0FBQTtBQUNqQyxHQUFBOztBQUVBO0FBQ0FDLEVBQUFBLElBQUksQ0FBQ0MsS0FBSyxFQUFFQyxTQUFTLEVBQUU7SUFFbkIsTUFBTUMsV0FBVyxHQUFHLElBQUksQ0FBQ1AsUUFBUSxDQUFDUSxLQUFLLENBQUNDLHdCQUF3QixDQUFBOztBQUVoRTtJQUNBSixLQUFLLENBQUNLLGdCQUFnQixHQUFHLElBQUksQ0FBQTs7QUFFN0I7SUFDQSxJQUFJLENBQUNILFdB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
