import"../core/tracing.js";import{EventHandler as t}from"../core/event-handler.js";import{Color as e}from"../core/math/color.js";import{Vec3 as s}from"../core/math/vec3.js";import{Quat as i}from"../core/math/quat.js";import{math as a}from"../core/math/math.js";import{Mat3 as n}from"../core/math/mat3.js";import{Mat4 as r}from"../core/math/mat4.js";import{GraphicsDeviceAccess as h}from"../platform/graphics/graphics-device-access.js";import{ADDRESS_REPEAT as o,ADDRESS_CLAMP_TO_EDGE as l,FILTER_LINEAR as m,PIXELFORMAT_RGBA8 as g}from"../platform/graphics/constants.js";import{BAKE_COLORDIR as p,FOG_NONE as u,GAMMA_SRGB as y,LAYERID_IMMEDIATE as _}from"./constants.js";import{Sky as b}from"./sky.js";import{LightingParams as d}from"./lighting/lighting-params.js";import{Immediate as c}from"./immediate/immediate.js";import{EnvLighting as k}from"./graphics/env-lighting.js";class x extends t{constructor(t){super(),this.ambientBake=!1,this.ambientBakeOcclusionBrightness=0,this.ambientBakeOcclusionContrast=0,this.ambientLight=new e(0,0,0),this.ambientLuminance=0,this.exposure=1,this.fogColor=new e(0,0,0),this.fogDensity=0,this.fogEnd=1e3,this.fogStart=1,this.lightmapSizeMultiplier=1,this.lightmapMaxResolution=2048,this.lightmapMode=p,this.lightmapFilterEnabled=!1,this.lightmapHDR=!1,this.root=null,this.sky=null,this.physicalUnits=!1,this.device=t||h.get(),this._gravity=new s(0,-9.8,0),this._layers=null,this._fog=u,this._gammaCorrection=y,this._toneMapping=0,this._skyboxCubeMap=null,this._prefilteredCubemaps=[null,null,null,null,null,null],this._envAtlas=null,this._internalEnvAtlas=null,this._skyboxIntensity=1,this._skyboxLuminance=0,this._skyboxMip=0,this._skyboxRotation=new i,this._skyboxRotationMat3=new n,this._skyboxRotationMat4=new r,this._ambientBakeNumSamples=1,this._ambientBakeSpherePart=.4,this._lightmapFilterRange=10,this._lightmapFilterSmoothness=.2,this._clusteredLightingEnabled=!0,this._lightingParams=new d(this.device.supportsAreaLights,this.device.maxTextureSize,(()=>{this._layers._dirtyLights=!0})),this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,lastStaticPrepareFullTime:0,lastStaticPrepareSearchTime:0,lastStaticPrepareWriteTime:0,lastStaticPrepareTriAabbTime:0,lastStaticPrepareCombineTime:0,updateShadersTime:0},this.updateShaders=!0,this._shaderVersion=0,this._statsUpdated=!1,this.immediate=new c(this.device)}get defaultDrawLayer(){return this.layers.getLayerById(_)}set ambientBakeNumSamples(t){this._ambientBakeNumSamples=a.clamp(Math.floor(t),1,255)}get ambientBakeNumSamples(){return this._ambientBakeNumSamples}set ambientBakeSpherePart(t){this._ambientBakeSpherePart=a.clamp(t,.001,1)}get ambientBakeSpherePart(){return this._ambientBakeSpherePart}set clusteredLightingEnabled(t){this._clusteredLightingEnabled||!t?this._clusteredLightingEnabled=t:console.error("Turning on disabled clustered lighting is not currently supported")}get clusteredLightingEnabled(){return this._clusteredLightingEnabled}set drawCalls(t){}get drawCalls(){let t=this.layers._meshInstances;return t.length||(this.layers._update(this.device,this.clusteredLightingEnabled),t=this.layers._meshInstances),t}set envAtlas(t){t!==this._envAtlas&&(this._envAtlas=t,t&&(t.addressU=o,t.addressV=l,t.minFilter=m,t.magFilter=m,t.mipmaps=!1),this.updateShaders=!0)}get envAtlas(){return this._envAtlas}set fog(t){t!==this._fog&&(this._fog=t,this.updateShaders=!0)}get fog(){return this._fog}set gammaCorrection(t){t!==this._gammaCorrection&&(this._gammaCorrection=t,this.updateShaders=!0)}get gammaCorrection(){return this._gammaCorrection}set layers(t){const e=this._layers;this._layers=t,this.fire("set:layers",e,t)}get layers(){return this._layers}get lighting(){return this._lightingParams}set lightmapFilterRange(t){this._lightmapFilterRange=Math.max(t,.001)}get lightmapFilterRange(){return this._lightmapFilterRange}set lightmapFilterSmoothness(t){this._lightmapFilterSmoothness=Math.max(t,.001)}get lightmapFilterSmoothness(){return this._lightmapFilterSmoothness}set prefilteredCubemaps(t){const e=this._prefilteredCubemaps;t=t||[];let s=!1,i=!0;for(let a=0;a<6;++a){const n=t[a]||null;e[a]!==n&&(e[a]=n,s=!0),i=i&&!!e[a]}s&&(this._resetSky(),i?(this._internalEnvAtlas=k.generatePrefilteredAtlas(e,{target:this._internalEnvAtlas}),this._envAtlas||(this.envAtlas=this._internalEnvAtlas)):this._internalEnvAtlas&&(this._envAtlas===this._internalEnvAtlas&&(this.envAtlas=null),this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null))}get prefilteredCubemaps(){return this._prefilteredCubemaps}set skybox(t){t!==this._skyboxCubeMap&&(this._skyboxCubeMap=t,this._resetSky())}get skybox(){return this._skyboxCubeMap}set skyboxIntensity(t){t!==this._skyboxIntensity&&(this._skyboxIntensity=t,this._resetSky())}get skyboxIntensity(){return this._skyboxIntensity}set skyboxLuminance(t){t!==this._skyboxLuminance&&(this._skyboxLuminance=t,this._resetSky())}get skyboxLuminance(){return this._skyboxLuminance}set skyboxMip(t){t!==this._skyboxMip&&(this._skyboxMip=t,this._resetSky())}get skyboxMip(){return this._skyboxMip}set skyboxRotation(t){this._skyboxRotation.equals(t)||(this._skyboxRotation.copy(t),t.equals(i.IDENTITY)?this._skyboxRotationMat3.setIdentity():(this._skyboxRotationMat4.setTRS(s.ZERO,t,s.ONE),this._skyboxRotationMat4.invertTo3x3(this._skyboxRotationMat3)),this._resetSky())}get skyboxRotation(){return this._skyboxRotation}set toneMapping(t){t!==this._toneMapping&&(this._toneMapping=t,this.updateShaders=!0)}get toneMapping(){return this._toneMapping}destroy(){this._resetSky(),this.root=null,this.off()}drawLine(t,s,i=e.WHITE,a=!0,n=this.defaultDrawLayer){this.immediate.getBatch(n,a).addLines([t,s],[i,i])}drawLines(t,e,s=!0,i=this.defaultDrawLayer){this.immediate.getBatch(i,s).addLines(t,e)}drawLineArrays(t,e,s=!0,i=this.defaultDrawLayer){this.immediate.getBatch(i,s).addLinesArrays(t,e)}applySettings(t){var e,s,a;const n=t.physics,r=t.render;this._gravity.set(n.gravity[0],n.gravity[1],n.gravity[2]),this.ambientLight.set(r.global_ambient[0],r.global_ambient[1],r.global_ambient[2]),this.ambientLuminance=r.ambientLuminance,this._fog=r.fog,this.fogColor.set(r.fog_color[0],r.fog_color[1],r.fog_color[2]),this.fogStart=r.fog_start,this.fogEnd=r.fog_end,this.fogDensity=r.fog_density,this._gammaCorrection=r.gamma_correction,this._toneMapping=r.tonemapping,this.lightmapSizeMultiplier=r.lightmapSizeMultiplier,this.lightmapMaxResolution=r.lightmapMaxResolution,this.lightmapMode=r.lightmapMode,this.exposure=r.exposure,this._skyboxIntensity=null!=(e=r.skyboxIntensity)?e:1,this._skyboxLuminance=null!=(s=r.skyboxLuminance)?s:2e4,this._skyboxMip=null!=(a=r.skyboxMip)?a:0,r.skyboxRotation&&(this.skyboxRotation=(new i).setFromEulerAngles(r.skyboxRotation[0],r.skyboxRotation[1],r.skyboxRotation[2])),this.clusteredLightingEnabled=r.clusteredLightingEnabled,this.lighting.applySettings(r),["lightmapFilterEnabled","lightmapFilterRange","lightmapFilterSmoothness","ambientBake","ambientBakeNumSamples","ambientBakeSpherePart","ambientBakeOcclusionBrightness","ambientBakeOcclusionContrast"].forEach((t=>{r.hasOwnProperty(t)&&(this[t]=r[t])})),this._resetSky()}_getSkyboxTex(){const t=this._prefilteredCubemaps;if(this._skyboxMip){return t[[0,1,3,4,5,6][this._skyboxMip]]||this._envAtlas||t[0]||this._skyboxCubeMap}return this._skyboxCubeMap||t[0]||this._envAtlas}_updateSky(t){if(!this.sky){const e=this._getSkyboxTex();e&&(this.sky=new b(t,this,e),this.fire("set:skybox",e))}}_resetSky(){var t;null==(t=this.sky)||t.destroy(),this.sky=null,this.updateShaders=!0}setSkybox(t){t?(this.skybox=t[0]||null,this.prefilteredCubemaps=t.slice(1)):(this.skybox=null,this.prefilteredCubemaps=[null,null,null,null,null,null])}get lightmapPixelFormat(){return this.lightmapHDR&&this.device.getHdrFormat(!1,!0,!1,!0)||g}}export{x as Scene};
