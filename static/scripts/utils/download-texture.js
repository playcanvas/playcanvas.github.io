function constructPngUrl(e,t,r){var n=function(e,t,r){for(var n="\0",a=r*t*4,i=0;i<t;i++)n+=String.fromCharCode(e[a],e[a+1],e[a+2],e[a+3]),a+=4;return n},a=function(e){return String.fromCharCode(e>>>24,e>>>16&255,e>>>8&255,255&e)},i=function(e,t){return a(t.length)+e+t+a(function(e){for(var t=-1,r=0;r<e.length;r++)for(var n=256|e.charCodeAt(r);1!==n;n>>>=1)t=t>>>1^(1&(t^n)?3988292384:0);return~t}(e+t))},o="Â‰PNG\r\n\n"+i("IHDR",a(t)+a(r)+"\b\0\0\0")+i("IDAT",function(e){var t="x",r=0;do{var n=e.slice(r,r+65535),i=n.length;t+=String.fromCharCode(((r+=n.length)===e.length)<<0,255&i,i>>>8,255&~i,~i>>>8&255),t+=n}while(r<e.length);return t+a(function(e){for(var t=1,r=0,n=0;n<e.length;n++)r=(r+(t=(t+e.charCodeAt(n))%65521))%65521;return r<<16|t}(e))}(function(e,t,r){for(var a="",i=0;i<r;i++)a+=n(e,t,i);return a}(e,t,r)))+i("IEND","");return"data:image/png;base64,"+btoa(o)}var constructPngUrlOld=function(e,t,r){var n=document.createElement("canvas");return n.width=t,n.height=r,n.getContext("2d").putImageData(new ImageData(e,t,r),0,0),n.toDataURL("image/png")};function download(e,t){var r=document.createElement("a");if(r.download=t,r.href=e,document.createEvent){var n=document.createEvent("MouseEvents");n.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),r.dispatchEvent(n)}else r.fireEvent&&r.fireEvent("onclick")}function readPixels(e,t){var r=new pc.RenderTarget({colorBuffer:e,depth:!1,face:t}),n=new Uint8ClampedArray(e.width*e.height*4),a=e.device;return a.setFramebuffer(r._glFrameBuffer),a.initRenderTarget(r),a.gl.readPixels(0,0,e.width,e.height,a.gl.RGBA,a.gl.UNSIGNED_BYTE,n),n}function flipY(e,t,r){var n,a,i=new Uint8ClampedArray(4*t);for(a=0;a<r/2;++a){for(n=0;n<4*t;++n)i[n]=e[n+a*t*4];for(e.copyWithin(a*t*4,(r-a-1)*t*4,(r-a)*t*4),n=0;n<4*t;++n)e[n+(r-a-1)*t*4]=i[n]}}function downloadTexture(e,t,r,n){var a,i,o,d,c,f,l,u;if(e.cubemap&&void 0===r)for(a=6*e.width,i=e.height,o=new Uint8ClampedArray(a*i*4),d=0;d<6;++d){var h=readPixels(e,[1,4,0,5,2,3][d]);for(c=0;c<e.height;++c)for(l=c*e.width*4,u=c*a*4+d*e.width*4,f=0;f<e.width;++f)o[u++]=h[l++],o[u++]=h[l++],o[u++]=h[l++],o[u++]=h[l++]}else a=e.width,i=e.height,o=readPixels(e,r);n&&flipY(o,a,i),download(constructPngUrl(o,a,i),t)}