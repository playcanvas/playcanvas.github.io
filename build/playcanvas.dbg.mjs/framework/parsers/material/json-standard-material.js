import { extends as _extends } from '../../../_virtual/_rollupPluginBabelHelpers.js';
import { Color } from '../../../core/math/color.js';
import { Vec2 } from '../../../core/math/vec2.js';
import { Vec3 } from '../../../core/math/vec3.js';
import { Texture } from '../../../platform/graphics/texture.js';
import { BoundingBox } from '../../../core/shape/bounding-box.js';
import { SPECULAR_BLINN, SPECULAR_PHONG } from '../../../scene/constants.js';
import { StandardMaterial } from '../../../scene/materials/standard-material.js';
import { StandardMaterialValidator } from '../../../scene/materials/standard-material-validator.js';
import { standardMaterialParameterTypes } from '../../../scene/materials/standard-material-parameters.js';

/**
 * Convert incoming JSON data into a {@link StandardMaterial}.
 *
 * @ignore
 */
class JsonStandardMaterialParser {
  constructor() {
    this._validator = null;
  }
  parse(input) {
    const migrated = this.migrate(input);
    const validated = this._validate(migrated);
    const material = new StandardMaterial();
    this.initialize(material, validated);
    return material;
  }

  /**
   * Initialize material properties from the material data block e.g. Loading from server.
   *
   * @param {StandardMaterial} material - The material to be initialized.
   * @param {object} data - The data block that is used to initialize.
   */
  initialize(material, data) {
    // usual flow is that data is validated in resource loader
    // but if not, validate here.
    if (!data.validated) {
      data = this._validate(data);
    }
    if (data.chunks) {
      material.chunks = _extends({}, data.chunks);
    }

    // initialize material values from the input data
    for (const key in data) {
      const type = standardMaterialParameterTypes[key];
      const value = data[key];
      if (type === 'vec2') {
        material[key] = new Vec2(value[0], value[1]);
      } else if (type === 'rgb') {
        material[key] = new Color(value[0], value[1], value[2]);
      } else if (type === 'texture') {
        if (value instanceof Texture) {
          material[key] = value;
        } else if (!(material[key] instanceof Texture && typeof value === 'number' && value > 0)) {
          material[key] = null;
        }
        // OTHERWISE: material already has a texture assigned, but data contains a valid asset id (which means the asset isn't yet loaded)
        // leave current texture (probably a placeholder) until the asset is loaded
      } else if (type === 'cubemap') {
        if (value instanceof Texture) {
          material[key] = value;
        } else if (!(material[key] instanceof Texture && typeof value === 'number' && value > 0)) {
          material[key] = null;
        }

        // clearing the cubemap must also clear the prefiltered data
        if (key === 'cubeMap' && !value) {
          material.prefilteredCubemaps = null;
        }

        // OTHERWISE: material already has a texture assigned, but data contains a valid asset id (which means the asset isn't yet loaded)
        // leave current texture (probably a placeholder) until the asset is loaded
      } else if (type === 'boundingbox') {
        const center = new Vec3(value.center[0], value.center[1], value.center[2]);
        const halfExtents = new Vec3(value.halfExtents[0], value.halfExtents[1], value.halfExtents[2]);
        material[key] = new BoundingBox(center, halfExtents);
      } else {
        // number, boolean and enum types don't require type creation
        material[key] = data[key];
      }
    }
    material.update();
  }

  // convert any properties that are out of date
  // or from old versions into current version
  migrate(data) {
    // replace old shader property with new shadingModel property
    if (data.shadingModel === undefined) {
      if (data.shader === 'blinn') {
        data.shadingModel = SPECULAR_BLINN;
      } else {
        data.shadingModel = SPECULAR_PHONG;
      }
    }
    if (data.shader) delete data.shader;

    // make JS style
    if (data.mapping_format) {
      data.mappingFormat = data.mapping_format;
      delete data.mapping_format;
    }
    let i;
    // list of properties that have been renamed in StandardMaterial
    // but may still exists in data in old format
    const RENAMED_PROPERTIES = [['bumpMapFactor', 'bumpiness'], ['aoUvSet', 'aoMapUv'], ['aoMapVertexColor', 'aoVertexColor'], ['diffuseMapVertexColor', 'diffuseVertexColor'], ['emissiveMapVertexColor', 'emissiveVertexColor'], ['specularMapVertexColor', 'specularVertexColor'], ['metalnessMapVertexColor', 'metalnessVertexColor'], ['opacityMapVertexColor', 'opacityVertexColor'], ['glossMapVertexColor', 'glossVertexColor'], ['lightMapVertexColor', 'lightVertexColor'], ['diffuseMapTint', 'diffuseTint'], ['specularMapTint', 'specularTint'], ['emissiveMapTint', 'emissiveTint'], ['metalnessMapTint', 'metalnessTint'], ['clearCoatGlossiness', 'clearCoatGloss']];

    // if an old property name exists without a new one,
    // move property into new name and delete old one.
    for (i = 0; i < RENAMED_PROPERTIES.length; i++) {
      const _old = RENAMED_PROPERTIES[i][0];
      const _new = RENAMED_PROPERTIES[i][1];
      if (data[_old] !== undefined) {
        if (data[_new] === undefined) {
          data[_new] = data[_old];
        }
        delete data[_old];
      }
    }

    // Properties that may exist in input data, but are now ignored
    const DEPRECATED_PROPERTIES = ['fresnelFactor', 'shadowSampleType'];
    for (i = 0; i < DEPRECATED_PROPERTIES.length; i++) {
      const name = DEPRECATED_PROPERTIES[i];
      if (data.hasOwnProperty(name)) {
        delete data[name];
      }
    }
    return data;
  }

  // check for invalid properties
  _validate(data) {
    if (!data.validated) {
      if (!this._validator) {
        this._validator = new StandardMaterialValidator();
      }
      this._validator.validate(data);
    }
    return data;
  }
}

export { JsonStandardMaterialParser };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoianNvbi1zdGFuZGFyZC1tYXRlcmlhbC5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2ZyYW1ld29yay9wYXJzZXJzL21hdGVyaWFsL2pzb24tc3RhbmRhcmQtbWF0ZXJpYWwuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29sb3IgfSBmcm9tICcuLi8uLi8uLi9jb3JlL21hdGgvY29sb3IuanMnO1xuaW1wb3J0IHsgVmVjMiB9IGZyb20gJy4uLy4uLy4uL2NvcmUvbWF0aC92ZWMyLmpzJztcbmltcG9ydCB7IFZlYzMgfSBmcm9tICcuLi8uLi8uLi9jb3JlL21hdGgvdmVjMy5qcyc7XG5cbmltcG9ydCB7IFRleHR1cmUgfSBmcm9tICcuLi8uLi8uLi9wbGF0Zm9ybS9ncmFwaGljcy90ZXh0dXJlLmpzJztcblxuaW1wb3J0IHsgQm91bmRpbmdCb3ggfSBmcm9tICcuLi8uLi8uLi9jb3JlL3NoYXBlL2JvdW5kaW5nLWJveC5qcyc7XG5cbmltcG9ydCB7IFNQRUNVTEFSX0JMSU5OLCBTUEVDVUxBUl9QSE9ORyB9IGZyb20gJy4uLy4uLy4uL3NjZW5lL2NvbnN0YW50cy5qcyc7XG5cbmltcG9ydCB7IFN0YW5kYXJkTWF0ZXJpYWwgfSBmcm9tICcuLi8uLi8uLi9zY2VuZS9tYXRlcmlhbHMvc3RhbmRhcmQtbWF0ZXJpYWwuanMnO1xuaW1wb3J0IHsgU3RhbmRhcmRNYXRlcmlhbFZhbGlkYXRvciB9IGZyb20gJy4uLy4uLy4uL3NjZW5lL21hdGVyaWFscy9zdGFuZGFyZC1tYXRlcmlhbC12YWxpZGF0b3IuanMnO1xuaW1wb3J0IHsgc3RhbmRhcmRNYXRlcmlhbFBhcmFtZXRlclR5cGVzIH0gZnJvbSAnLi4vLi4vLi4vc2NlbmUvbWF0ZXJpYWxzL3N0YW5kYXJkLW1hdGVyaWFsLXBhcmFtZXRlcnMuanMnO1xuXG4vKipcbiAqIENvbnZlcnQgaW5jb21pbmcgSlNPTiBkYXRhIGludG8gYSB7QGxpbmsgU3RhbmRhcmRNYXRlcmlhbH0uXG4gKlxuICogQGlnbm9yZVxuICovXG5jbGFzcyBKc29uU3RhbmRhcmRNYXRlcmlhbFBhcnNlciB7XG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHRoaXMuX3ZhbGlkYXRvciA9IG51bGw7XG4gICAgfVxuXG4gICAgcGFyc2UoaW5wdXQpIHtcbiAgICAgICAgY29uc3QgbWlncmF0ZWQgPSB0aGlzLm1pZ3JhdGUoaW5wdXQpO1xuICAgICAgICBjb25zdCB2YWxpZGF0ZWQgPSB0aGlzLl92YWxpZGF0ZShtaWdyYXRlZCk7XG5cbiAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgU3RhbmRhcmRNYXRlcmlhbCgpO1xuICAgICAgICB0aGlzLmluaXRpYWxpemUobWF0ZXJpYWwsIHZhbGlkYXRlZCk7XG5cbiAgICAgICAgcmV0dXJuIG1hdGVyaWFsO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEluaXRpYWxpemUgbWF0ZXJpYWwgcHJvcGVydGllcyBmcm9tIHRoZSBtYXRlcmlhbCBkYXRhIGJsb2NrIGUuZy4gTG9hZGluZyBmcm9tIHNlcnZlci5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7U3RhbmRhcmRNYXRlcmlhbH0gbWF0ZXJpYWwgLSBUaGUgbWF0ZXJpYWwgdG8gYmUgaW5pdGlhbGl6ZWQuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgLSBUaGUgZGF0YSBibG9jayB0aGF0IGlzIHVzZWQgdG8gaW5pdGlhbGl6ZS5cbiAgICAgKi9cbiAgICBpbml0aWFsaXplKG1hdGVyaWFsLCBkYXRhKSB7XG4gICAgICAgIC8vIHVzdWFsIGZsb3cgaXMgdGhhdCBkYXRhIGlzIHZhbGlkYXRlZCBpbiByZXNvdXJjZSBsb2FkZXJcbiAgICAgICAgLy8gYnV0IGlmIG5vdCwgdmFsaWRhdGUgaGVyZS5cbiAgICAgICAgaWYgKCFkYXRhLnZhbGlkYXRlZCkge1xuICAgICAgICAgICAgZGF0YSA9IHRoaXMuX3ZhbGlkYXRlKGRhdGEpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGRhdGEuY2h1bmtzKSB7XG4gICAgICAgICAgICBtYXRlcmlhbC5jaHVua3MgPSB7IC4uLmRhdGEuY2h1bmtzIH07XG4gICAgICAgIH1cblxuICAgICAgICAvLyBpbml0aWFsaXplIG1hdGVyaWFsIHZhbHVlcyBmcm9tIHRoZSBpbnB1dCBkYXRhXG4gICAgICAgIGZvciAoY29uc3Qga2V5IGluIGRhdGEpIHtcbiAgICAgICAgICAgIGNvbnN0IHR5cGUgPSBzdGFuZGFyZE1hdGVyaWFsUGFyYW1ldGVyVHlwZXNba2V5XTtcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gZGF0YVtrZXldO1xuXG4gICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3ZlYzInKSB7XG4gICAgICAgICAgICAgICAgbWF0ZXJpYWxba2V5XSA9IG5ldyBWZWMyKHZhbHVlWzBdLCB2YWx1ZVsxXSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdyZ2InKSB7XG4gICAgICAgICAgICAgICAgbWF0ZXJpYWxba2V5XSA9IG5ldyBDb2xvcih2YWx1ZVswXSwgdmFsdWVbMV0sIHZhbHVlWzJdKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3RleHR1cmUnKSB7XG4gICAgICAgICAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgVGV4dHVyZSkge1xuICAgICAgICAgICAgICAgICAgICBtYXRlcmlhbFtrZXldID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICghKG1hdGVyaWFsW2tleV0gaW5zdGFuY2VvZiBUZXh0dXJlICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicgJiYgdmFsdWUgPiAwKSkge1xuICAgICAgICAgICAgICAgICAgICBtYXRlcmlhbFtrZXldID0gbnVsbDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gT1RIRVJXSVNFOiBtYXRlcmlhbCBhbHJlYWR5IGhhcyBhIHRleHR1cmUgYXNzaWduZWQsIGJ1dCBkYXRhIGNvbnRhaW5zIGEgdmFsaWQgYXNzZXQgaWQgKHdoaWNoIG1lYW5zIHRoZSBhc3NldCBpc24ndCB5ZXQgbG9hZGVkKVxuICAgICAgICAgICAgICAgIC8vIGxlYXZlIGN1cnJlbnQgdGV4dHVyZSAocHJvYmFibHkgYSBwbGFjZWhvbGRlcikgdW50aWwgdGhlIGFzc2V0IGlzIGxvYWRlZFxuICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnY3ViZW1hcCcpIHtcbiAgICAgICAgICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBUZXh0dXJlKSB7XG4gICAgICAgICAgICAgICAgICAgIG1hdGVyaWFsW2tleV0gPSB2YWx1ZTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCEobWF0ZXJpYWxba2V5XSBpbnN0YW5jZW9mIFRleHR1cmUgJiYgdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJyAmJiB2YWx1ZSA+IDApKSB7XG4gICAgICAgICAgICAgICAgICAgIG1hdGVyaWFsW2tleV0gPSBudWxsO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vIGNsZWFyaW5nIHRoZSBjdWJlbWFwIG11c3QgYWxzbyBjbGVhciB0aGUgcHJlZmlsdGVyZWQgZGF0YVxuICAgICAgICAgICAgICAgIGlmIChrZXkgPT09ICdjdWJlTWFwJyAmJiAhdmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgbWF0ZXJpYWwucHJlZmlsdGVyZWRDdWJlbWFwcyA9IG51bGw7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgLy8gT1RIRVJXSVNFOiBtYXRlcmlhbCBhbHJlYWR5IGhhcyBhIHRleHR1cmUgYXNzaWduZWQsIGJ1dCBkYXRhIGNvbnRhaW5zIGEgdmFsaWQgYXNzZXQgaWQgKHdoaWNoIG1lYW5zIHRoZSBhc3NldCBpc24ndCB5ZXQgbG9hZGVkKVxuICAgICAgICAgICAgICAgIC8vIGxlYXZlIGN1cnJlbnQgdGV4dHVyZSAocHJvYmFibHkgYSBwbGFjZWhvbGRlcikgdW50aWwgdGhlIGFzc2V0IGlzIGxvYWRlZFxuICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnYm91bmRpbmdib3gnKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY2VudGVyID0gbmV3IFZlYzModmFsdWUuY2VudGVyWzBdLCB2YWx1ZS5jZW50ZXJbMV0sIHZhbHVlLmNlbnRlclsyXSk7XG4gICAgICAgICAgICAgICAgY29uc3QgaGFsZkV4dGVudHMgPSBuZXcgVmVjMyh2YWx1ZS5oYWxmRXh0ZW50c1swXSwgdmFsdWUuaGFsZkV4dGVudHNbMV0sIHZhbHVlLmhhbGZFeHRlbnRzWzJdKTtcbiAgICAgICAgICAgICAgICBtYXRlcmlhbFtrZXldID0gbmV3IEJvdW5kaW5nQm94KGNlbnRlciwgaGFsZkV4dGVudHMpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBudW1iZXIsIGJvb2xlYW4gYW5kIGVudW0gdHlwZXMgZG9uJ3QgcmVxdWlyZSB0eXBlIGNyZWF0aW9uXG4gICAgICAgICAgICAgICAgbWF0ZXJpYWxba2V5XSA9IGRhdGFba2V5XTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIG1hdGVyaWFsLnVwZGF0ZSgpO1xuICAgIH1cblxuICAgIC8vIGNvbnZlcnQgYW55IHByb3BlcnRpZXMgdGhhdCBhcmUgb3V0IG9mIGRhdGVcbiAgICAvLyBvciBmcm9tIG9sZCB2ZXJzaW9ucyBpbnRvIGN1cnJlbnQgdmVyc2lvblxuICAgIG1pZ3JhdGUoZGF0YSkge1xuICAgICAgICAvLyByZXBsYWNlIG9sZCBzaGFkZXIgcHJvcGVydHkgd2l0aCBuZXcgc2hhZGluZ01vZGVsIHByb3BlcnR5XG4gICAgICAgIGlmIChkYXRhLnNoYWRpbmdNb2RlbCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBpZiAoZGF0YS5zaGFkZXIgPT09ICdibGlubicpIHtcbiAgICAgICAgICAgICAgICBkYXRhLnNoYWRpbmdNb2RlbCA9IFNQRUNVTEFSX0JMSU5OO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBkYXRhLnNoYWRpbmdNb2RlbCA9IFNQRUNVTEFSX1BIT05HO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChkYXRhLnNoYWRlcikgZGVsZXRlIGRhdGEuc2hhZGVyO1xuXG4gICAgICAgIC8vIG1ha2UgSlMgc3R5bGVcbiAgICAgICAgaWYgKGRhdGEubWFwcGluZ19mb3JtYXQpIHtcbiAgICAgICAgICAgIGRhdGEubWFwcGluZ0Zvcm1hdCA9IGRhdGEubWFwcGluZ19mb3JtYXQ7XG4gICAgICAgICAgICBkZWxldGUgZGF0YS5tYXBwaW5nX2Zvcm1hdDtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBpO1xuICAgICAgICAvLyBsaXN0IG9mIHByb3BlcnRpZXMgdGhhdCBoYXZlIGJlZW4gcmVuYW1lZCBpbiBTdGFuZGFyZE1hdGVyaWFsXG4gICAgICAgIC8vIGJ1dCBtYXkgc3RpbGwgZXhpc3RzIGluIGRhdGEgaW4gb2xkIGZvcm1hdFxuICAgICAgICBjb25zdCBSRU5BTUVEX1BST1BFUlRJRVMgPSBbXG4gICAgICAgICAgICBbJ2J1bXBNYXBGYWN0b3InLCAnYnVtcGluZXNzJ10sXG5cbiAgICAgICAgICAgIFsnYW9VdlNldCcsICdhb01hcFV2J10sXG5cbiAgICAgICAgICAgIFsnYW9NYXBWZXJ0ZXhDb2xvcicsICdhb1ZlcnRleENvbG9yJ10sXG4gICAgICAgICAgICBbJ2RpZmZ1c2VNYXBWZXJ0ZXhDb2xvcicsICdkaWZmdXNlVmVydGV4Q29sb3InXSxcbiAgICAgICAgICAgIFsnZW1pc3NpdmVNYXBWZXJ0ZXhDb2xvcicsICdlbWlzc2l2ZVZlcnRleENvbG9yJ10sXG4gICAgICAgICAgICBbJ3NwZWN1bGFyTWFwVmVydGV4Q29sb3InLCAnc3BlY3VsYXJWZXJ0ZXhDb2xvciddLFxuICAgICAgICAgICAgWydtZXRhbG5lc3NNYXBWZXJ0ZXhDb2xvcicsICdtZXRhbG5lc3NWZXJ0ZXhDb2xvciddLFxuICAgICAgICAgICAgWydvcGFjaXR5TWFwVmVydGV4Q29sb3InLCAnb3BhY2l0eVZlcnRleENvbG9yJ10sXG4gICAgICAgICAgICBbJ2dsb3NzTWFwVmVydGV4Q29sb3InLCAnZ2xvc3NWZXJ0ZXhDb2xvciddLFxuICAgICAgICAgICAgWydsaWdodE1hcFZlcnRleENvbG9yJywgJ2xpZ2h0VmVydGV4Q29sb3InXSxcblxuICAgICAgICAgICAgWydkaWZmdXNlTWFwVGludCcsICdkaWZmdXNlVGludCddLFxuICAgICAgICAgICAgWydzcGVjdWxhck1hcFRpbnQnLCAnc3BlY3VsYXJUaW50J10sXG4gICAgICAgICAgICBbJ2VtaXNzaXZlTWFwVGludCcsICdlbWlzc2l2ZVRpbnQnXSxcbiAgICAgICAgICAgIFsnbWV0YWxuZXNzTWFwVGludCcsICdtZXRhbG5lc3NUaW50J10sXG5cbiAgICAgICAgICAgIFsnY2xlYXJDb2F0R2xvc3NpbmVzcycsICdjbGVhckNvYXRHbG9zcyddXG4gICAgICAgIF07XG5cbiAgICAgICAgLy8gaWYgYW4gb2xkIHByb3BlcnR5IG5hbWUgZXhpc3RzIHdpdGhvdXQgYSBuZXcgb25lLFxuICAgICAgICAvLyBtb3ZlIHByb3BlcnR5IGludG8gbmV3IG5hbWUgYW5kIGRlbGV0ZSBvbGQgb25lLlxuICAgICAgICBmb3IgKGkgPSAwOyBpIDwgUkVOQU1FRF9QUk9QRVJUSUVTLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBjb25zdCBfb2xkID0gUkVOQU1FRF9QUk9QRVJUSUVTW2ldWzBdO1xuICAgICAgICAgICAgY29uc3QgX25ldyA9IFJFTkFNRURfUFJPUEVSVElFU1tpXVsxXTtcblxuICAgICAgICAgICAgaWYgKGRhdGFbX29sZF0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIGlmIChkYXRhW19uZXddID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgZGF0YVtfbmV3XSA9IGRhdGFbX29sZF07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGRlbGV0ZSBkYXRhW19vbGRdO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gUHJvcGVydGllcyB0aGF0IG1heSBleGlzdCBpbiBpbnB1dCBkYXRhLCBidXQgYXJlIG5vdyBpZ25vcmVkXG4gICAgICAgIGNvbnN0IERFUFJFQ0FURURfUFJPUEVSVElFUyA9IFtcbiAgICAgICAgICAgICdmcmVzbmVsRmFjdG9yJyxcbiAgICAgICAgICAgICdzaGFkb3dTYW1wbGVUeXBlJ1xuICAgICAgICBdO1xuXG4gICAgICAgIGZvciAoaSA9IDA7IGkgPCBERVBSRUNBVEVEX1BST1BFUlRJRVMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBERVBSRUNBVEVEX1BST1BFUlRJRVNbaV07XG4gICAgICAgICAgICBpZiAoZGF0YS5oYXNPd25Qcm9wZXJ0eShuYW1lKSkge1xuICAgICAgICAgICAgICAgIGRlbGV0ZSBkYXRhW25hbWVdO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfVxuXG4gICAgLy8gY2hlY2sgZm9yIGludmFsaWQgcHJvcGVydGllc1xuICAgIF92YWxpZGF0ZShkYXRhKSB7XG4gICAgICAgIGlmICghZGF0YS52YWxpZGF0ZWQpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5fdmFsaWRhdG9yKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fdmFsaWRhdG9yID0gbmV3IFN0YW5kYXJkTWF0ZXJpYWxWYWxpZGF0b3IoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuX3ZhbGlkYXRvci52YWxpZGF0ZShkYXRhKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZGF0YTtcbiAgICB9XG59XG5cbmV4cG9ydCB7IEpzb25TdGFuZGFyZE1hdGVyaWFsUGFyc2VyIH07XG4iXSwibmFtZXMiOlsiSnNvblN0YW5kYXJkTWF0ZXJpYWxQYXJzZXIiLCJjb25zdHJ1Y3RvciIsIl92YWxpZGF0b3IiLCJwYXJzZSIsImlucHV0IiwibWlncmF0ZWQiLCJtaWdyYXRlIiwidmFsaWRhdGVkIiwiX3ZhbGlkYXRlIiwibWF0ZXJpYWwiLCJTdGFuZGFyZE1hdGVyaWFsIiwiaW5pdGlhbGl6ZSIsImRhdGEiLCJjaHVua3MiLCJfZXh0ZW5kcyIsImtleSIsInR5cGUiLCJzdGFuZGFyZE1hdGVyaWFsUGFyYW1ldGVyVHlwZXMiLCJ2YWx1ZSIsIlZlYzIiLCJDb2xvciIsIlRleHR1cmUiLCJwcmVmaWx0ZXJlZEN1YmVtYXBzIiwiY2VudGVyIiwiVmVjMyIsImhhbGZFeHRlbnRzIiwiQm91bmRpbmdCb3giLCJ1cGRhdGUiLCJzaGFkaW5nTW9kZWwiLCJ1bmRlZmluZWQiLCJzaGFkZXIiLCJTUEVDVUxBUl9CTElOTiIsIlNQRUNVTEFSX1BIT05HIiwibWFwcGluZ19mb3JtYXQiLCJtYXBwaW5nRm9ybWF0IiwiaSIsIlJFTkFNRURfUFJPUEVSVElFUyIsImxlbmd0aCIsIl9vbGQiLCJfbmV3IiwiREVQUkVDQVRFRF9QUk9QRVJUSUVTIiwibmFtZSIsImhhc093blByb3BlcnR5IiwiU3RhbmRhcmRNYXRlcmlhbFZhbGlkYXRvciIsInZhbGlkYXRlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQUFNQSwwQkFBMEIsQ0FBQztBQUM3QkMsRUFBQUEsV0FBV0EsR0FBRztJQUNWLElBQUksQ0FBQ0MsVUFBVSxHQUFHLElBQUksQ0FBQTtBQUMxQixHQUFBO0VBRUFDLEtBQUtBLENBQUNDLEtBQUssRUFBRTtBQUNULElBQUEsTUFBTUMsUUFBUSxHQUFHLElBQUksQ0FBQ0MsT0FBTyxDQUFDRixLQUFLLENBQUMsQ0FBQTtBQUNwQyxJQUFBLE1BQU1HLFNBQVMsR0FBRyxJQUFJLENBQUNDLFNBQVMsQ0FBQ0gsUUFBUSxDQUFDLENBQUE7QUFFMUMsSUFBQSxNQUFNSSxRQUFRLEdBQUcsSUFBSUMsZ0JBQWdCLEVBQUUsQ0FBQTtBQUN2QyxJQUFBLElBQUksQ0FBQ0MsVUFBVSxDQUFDRixRQUFRLEVBQUVGLFNBQVMsQ0FB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
