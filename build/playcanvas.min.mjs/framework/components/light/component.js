import{math as t}from"../../../core/math/math.js";import{Color as s}from"../../../core/math/color.js";import{Vec4 as e}from"../../../core/math/vec4.js";import{LIGHTSHAPE_PUNCTUAL as i,LIGHTFALLOFF_LINEAR as o,SHADOW_PCF3 as h,BLUR_GAUSSIAN as n,SHADOWUPDATE_REALTIME as a,MASK_AFFECT_DYNAMIC as l,MASK_AFFECT_LIGHTMAPPED as c,MASK_BAKE as d,LAYERID_WORLD as r}from"../../../scene/constants.js";import{Asset as f}from"../../asset/asset.js";import{Component as k}from"../component.js";const m=[],g=[];class u extends k{constructor(t,s){super(t,s),this._cookieAsset=null,this._cookieAssetId=null,this._cookieAssetAdd=!1,this._cookieMatrix=null}addLightToLayers(){for(let t=0;t<this.layers.length;t++){const s=this.system.app.scene.layers.getLayerById(this.layers[t]);s&&s.addLight(this)}}removeLightFromLayers(){for(let t=0;t<this.layers.length;t++){const s=this.system.app.scene.layers.getLayerById(this.layers[t]);s&&s.removeLight(this)}}onLayersChanged(t,s){this.enabled&&this.entity.enabled&&this.addLightToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),s.on("add",this.onLayerAdded,this),s.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)>=0&&this.enabled&&this.entity.enabled&&t.addLight(this)}onLayerRemoved(t){this.layers.indexOf(t.id)>=0&&t.removeLight(this)}refreshProperties(){for(let t=0;t<m.length;t++){const s=m[t];this[s]=this[s]}this.enabled&&this.entity.enabled&&this.onEnable()}onCookieAssetSet(){let t=!1;"cubemap"!==this._cookieAsset.type||this._cookieAsset.loadFaces||(this._cookieAsset.loadFaces=!0,t=!0),this._cookieAsset.resource&&!t||this.system.app.assets.load(this._cookieAsset),this._cookieAsset.resource&&this.onCookieAssetLoad()}onCookieAssetAdd(t){this._cookieAssetId===t.id&&(this._cookieAsset=t,this.light.enabled&&this.onCookieAssetSet(),this._cookieAsset.on("load",this.onCookieAssetLoad,this),this._cookieAsset.on("remove",this.onCookieAssetRemove,this))}onCookieAssetLoad(){this._cookieAsset&&this._cookieAsset.resource&&(this.cookie=this._cookieAsset.resource)}onCookieAssetRemove(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off("add:"+this._cookieAssetId,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)}onEnable(){this.light.enabled=!0,this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addLightToLayers(),this._cookieAsset&&!this.cookie&&this.onCookieAssetSet()}onDisable(){this.light.enabled=!1,this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.removeLightFromLayers()}onRemove(){this.onDisable(),this.light.destroy(),this.cookieAsset=null}set shadowUpdateOverrides(t){this.light.shadowUpdateOverrides=t}get shadowUpdateOverrides(){return this.light.shadowUpdateOverrides}}function y(t,s,e,i){const o=u.prototype;m.push(t),g.push(s),Object.defineProperty(o,t,{get:function(){return this.data[t]},set:function(s){const o=this.data,h=o[t];(i||h!==s)&&(o[t]=s,e&&e.call(this,s,h))},configurable:!0})}y("enabled",!0,(function(t,s){this.onSetEnabled(null,s,t)})),y("light",null),y("type","directional",(function(t,s){this.system.changeType(this,s,t),this.refreshProperties()})),y("color",new s(1,1,1),(function(t,s){this.light.setColor(t)}),!0),y("intensity",1,(function(t,s){this.light.intensity=t})),y("luminance",0,(function(t,s){this.light.luminance=t})),y("shape",i,(function(t,s){this.light.shape=t})),y("castShadows",!1,(function(t,s){this.light.castShadows=t})),y("shadowDistance",40,(function(t,s){this.light.shadowDistance=t})),y("shadowIntensity",1,(function(t,s){this.light.shadowIntensity=t})),y("shadowResolution",1024,(function(t,s){this.light.shadowResolution=t})),y("shadowBias",.05,(function(s,e){this.light.shadowBias=-.01*t.clamp(s,0,1)})),y("numCascades",1,(function(s,e){this.light.numCascades=t.clamp(Math.floor(s),1,4)})),y("bakeNumSamples",1,(function(s,e){this.light.bakeNumSamples=t.clamp(Math.floor(s),1,255)})),y("bakeArea",0,(function(s,e){this.light.bakeArea=t.clamp(s,0,180)})),y("cascadeDistribution",.5,(function(s,e){this.light.cascadeDistribution=t.clamp(s,0,1)})),y("normalOffsetBias",0,(function(s,e){this.light.normalOffsetBias=t.clamp(s,0,1)})),y("range",10,(function(t,s){this.light.attenuationEnd=t})),y("innerConeAngle",40,(function(t,s){this.light.innerConeAngle=t})),y("outerConeAngle",45,(function(t,s){this.light.outerConeAngle=t})),y("falloffMode",o,(function(t,s){this.light.falloffMode=t})),y("shadowType",h,(function(t,s){this.light.shadowType=t})),y("vsmBlurSize",11,(function(t,s){this.light.vsmBlurSize=t})),y("vsmBlurMode",n,(function(t,s){this.light.vsmBlurMode=t})),y("vsmBias",.0025,(function(s,e){this.light.vsmBias=t.clamp(s,0,1)})),y("cookieAsset",null,(function(t,s){if(!this._cookieAssetId||!(t instanceof f&&t.id===this._cookieAssetId||t===this._cookieAssetId))if(this.onCookieAssetRemove(),this._cookieAssetId=null,t instanceof f)this.data.cookieAsset=t.id,this._cookieAssetId=t.id,this.onCookieAssetAdd(t);else if("number"==typeof t){this._cookieAssetId=t;const s=this.system.app.assets.get(t);s?this.onCookieAssetAdd(s):(this._cookieAssetAdd=!0,this.system.app.assets.on("add:"+this._cookieAssetId,this.onCookieAssetAdd,this))}})),y("cookie",null,(function(t,s){this.light.cookie=t})),y("cookieIntensity",1,(function(s,e){this.light.cookieIntensity=t.clamp(s,0,1)})),y("cookieFalloff",!0,(function(t,s){this.light.cookieFalloff=t})),y("cookieChannel","rgb",(function(t,s){this.light.cookieChannel=t})),y("cookieAngle",0,(function(s,i){if(0!==s||null!==this.cookieScale){this._cookieMatrix||(this._cookieMatrix=new e);let i=1,o=1;this.cookieScale&&(i=this.cookieScale.x,o=this.cookieScale.y);const h=Math.cos(s*t.DEG_TO_RAD),n=Math.sin(s*t.DEG_TO_RAD);this._cookieMatrix.set(h/i,-n/i,n/o,h/o),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null})),y("cookieScale",null,(function(s,i){if(null!==s||0!==this.cookieAngle){this._cookieMatrix||(this._cookieMatrix=new e);const i=s.x,o=s.y,h=Math.cos(this.cookieAngle*t.DEG_TO_RAD),n=Math.sin(this.cookieAngle*t.DEG_TO_RAD);this._cookieMatrix.set(h/i,-n/i,n/o,h/o),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null}),!0),y("cookieOffset",null,(function(t,s){this.light.cookieOffset=t}),!0),y("shadowUpdateMode",a,(function(t,s){this.light.shadowUpdateMode=t}),!0),y("mask",1,(function(t,s){this.light.mask=t})),y("affectDynamic",!0,(function(t,s){t?this.light.mask|=l:this.light.mask&=~l,this.light.layersDirty()})),y("affectLightmapped",!1,(function(t,s){t?(this.light.mask|=c,this.bake&&(this.light.mask&=~d)):(this.light.mask&=~c,this.bake&&(this.light.mask|=d))})),y("bake",!1,(function(t,s){t?(this.light.mask|=d,this.affectLightmapped&&(this.light.mask&=~c)):(this.light.mask&=~d,this.affectLightmapped&&(this.light.mask|=c)),this.light.layersDirty()})),y("bakeDir",!0,(function(t,s){this.light.bakeDir=t})),y("isStatic",!1,(function(t,s){this.light.isStatic=t})),y("layers",[r],(function(t,s){for(let t=0;t<s.length;t++){const e=this.system.app.scene.layers.getLayerById(s[t]);e&&e.removeLight(this)}for(let s=0;s<t.length;s++){const e=this.system.app.scene.layers.getLayerById(t[s]);e&&this.enabled&&this.entity.enabled&&e.addLight(this)}}));export{u as LightComponent,m as _lightProps,g as _lightPropsDefault};
