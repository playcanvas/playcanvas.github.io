import{path as e}from"../../core/path.js";import{Quat as n}from"../../core/math/quat.js";import{Vec3 as t}from"../../core/math/vec3.js";import{Http as o,http as s}from"../../platform/net/http.js";import{Animation as a,Node as r,Key as i}from"../../scene/animation/animation.js";import{AnimEvents as l}from"../anim/evaluator/anim-events.js";import{GlbParser as m}from"../parsers/glb-parser.js";class p{constructor(e){this.handlerType="animation",this.maxRetries=0}load(n,t,a){"string"==typeof n&&(n={load:n,original:n});const r={retry:this.maxRetries>0,maxRetries:this.maxRetries};(n.load.startsWith("blob:")||n.load.startsWith("data:"))&&(".glb"===e.getExtension(n.original).toLowerCase()?r.responseType=o.ResponseType.ARRAY_BUFFER:r.responseType=o.ResponseType.JSON),s.get(n.load,r,((o,s)=>{o?t(`Error loading animation resource: ${n.original} [${o}]`):".glb"===e.getExtension(n.original).toLowerCase()?m.parse("filename.glb",s,null,null,((e,n)=>{if(e)t(e);else{var o;const e=n.animations;if(null!=a&&null!=(o=a.data)&&o.events)for(let n=0;n<e.length;n++)e[n].events=new l(Object.values(a.data.events));n.destroy(),t(null,e)}})):t(null,this["_parseAnimationV"+s.animation.version](s))}))}open(e,n,t){return n}patch(e,n){}_parseAnimationV3(e){const o=e.animation,s=new a;s.name=o.name,s.duration=o.duration;for(let e=0;e<o.nodes.length;e++){const a=new r,l=o.nodes[e];a._name=l.name;for(let e=0;e<l.keys.length;e++){const o=l.keys[e],s=o.time,r=o.pos,m=o.rot,p=o.scale,d=new t(r[0],r[1],r[2]),u=(new n).setFromEulerAngles(m[0],m[1],m[2]),c=new t(p[0],p[1],p[2]),f=new i(s,d,u,c);a._keys.push(f)}s.addNode(a)}return s}_parseAnimationV4(e){const o=e.animation,s=new a;s.name=o.name,s.duration=o.duration;for(let e=0;e<o.nodes.length;e++){const a=new r,l=o.nodes[e];a._name=l.name;const m=l.defaults.p,p=l.defaults.r,d=l.defaults.s;for(let e=0;e<l.keys.length;e++){const o=l.keys[e],s=o.t,r=m||o.p,u=p||o.r,c=d||o.s,f=new t(r[0],r[1],r[2]),g=(new n).setFromEulerAngles(u[0],u[1],u[2]),h=new t(c[0],c[1],c[2]),w=new i(s,f,g,h);a._keys.push(w)}s.addNode(a)}return s}}export{p as AnimationHandler};
